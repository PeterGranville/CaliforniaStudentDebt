---
title: "What the Data Tell Us About Student Debt and Race in California"
author: "Peter Granville"
date: 'April 2023'
output:
  html_document:
    toc: true
    toc_depth: 2
    theme: cosmo

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(pwr)
library(dplyr)
library(knitr)
library(shiny)
library(scales)
library(plotly)
library(stringr)
library(ggplot2)
library(reshape2)
library(data.table)
library(kableExtra)
```

```{r preferredPalettes}
stateCols <- c(
  "#0093ff", # dodgerblue
  "#faaa00", # darkgoldenrod2
  "#008e00", # forestgreen
  "#ff7932", # sienna1
  "#4a3d90", # darkslateblue
  "#9FC2BA"  # mysticalgreen
)

stateCols2 <- c(
  "#4db3ff", 
  "#ffc956", 
  "#00c500", 
  "#ffa16f", 
  "#7769bf", 
  "#7CE0F9"
)

flagCols <- c(
  "#b71234", 
  "#008543", 
  "#584527", 
  "#de849c", 
  "#5A5A5A",
  "#CABD80"
)

flagCols2 <- c(
  "#ed486a", 
  "#00d069", 
  "#8d6f3f", 
  "#de849c", 
  "#838383", 
  "#CAECCF"
)
```

## Introduction

Leveraging an array of data sources on student loans, repayment, and financial well-being, this report examines how student debt puts outsized and lasting financial burdens on Black and Latino families in California. Though California lawmakers rightly draw on national research on student debt and race, state-specific insights can be gleaned from national data sets. TCF's state-level analyses here can help guide state policy that accounts for the distinct patterns of borrowing in California. 

I draw from the best available sources of California-specific data on student debt to explain in depth what we know (and still do not know) about student debt in California. In my analysis I rely primarily on four sources:

* The Federal Student Aid (FSA) Data Center
* The National Postsecondary Student Aid Study (NPSAS)
* The Survey of Household Economics and Decisionmaking (SHED)
* The College Scorecard

To lesser extents, I also use data from the Integrated Postsecondary Education Data System (IPEDS) and the American Community Survey (ACS). I also include a short analysis focusing on the relationship between education attainment and income, using data from the ACS.

This report is not a static PDF: you can toggle between different versions of charts and hover over graphs to reveal the exact statistics. The code used to produce this document and its charts and tables can be found at [this GitHub repository](https://github.com/PeterGranville/CaliforniaStudentDebt). All data sets used in this report are publicly available, courtesy of the U.S. Department of Education, the U.S. Federal Reserve, and the U.S. Census Bureau. 

Consider each of the following when interpreting the data presented in this report: 

* Whether an average contains zero values or not. For example, in a measure of the average loan taken out by students, are students with no loans counted? If yes, the average will be lower than if those students were not counted. This will be noted in the "Data Source and Notes" tab of any figure containing an average. 
* Whether a measure of California student debt includes borrowers who may have left California after separating from their college, and whether a measure of borrowers includes those who enroll in a California institution but who do not permanently reside in California. This will be noted in the "Data Source and Notes" tab of a figure where this question is relevant. 
* Whether statistics on the U.S. overall, used as comparison points for California's statistics, include California or not. When you see "Rest of U.S.," California is not included. However, the section drawing from NPSAS data will compare California with the U.S. overall, including California. 
* Whether Parent PLUS loans are included or not in measures of undergraduate student loan borrowing. In the sections that draw from the Federal Student Aid Data Center and the College Scorecard, which are definitive reports from the National Student Loan Data System, we are able to break out Parent PLUS from other undergraduate loans. In the sections that draw from NPSAS and SHED, separating out parent borrowing can lead to subsamples that are too small to use, and in those sections I use measures of total student loans which include parent loans. 

Much of the data for this research comes from surveys, which enables us to disaggregate results by race and/or gender, revealing how these factors are associated with greater or lesser borrowing and other long-term outcomes. However, in many cases, the survey sample will not be large enough to provide a reliable estimate for a certain group. In the tables and graphs in this report, I have included all groups for which there is a sufficient sample. If you see that a group is not listed, I excluded it because the sample was not sufficient to produce a result for that group. 

If you have any questions, please email me (Peter Granville) at [granville@tcf.org](granville@tcf.org).

## Federal Student Aid Data Center

#### About the data

The FSA Data Center is a repository of data and statistics on federal student aid, including spreadsheets on student loans reported directly from the National Student Loan Data System. For this analysis I draw from two files from the FSA Data Center: 

* Quarterly reports on the federal student loan portfolio by borrower location, [available here](https://studentaid.gov/data-center/student/portfolio). 
* Quarterly reports on Direct Loan disbursements and borrowers at the level of the institution, disaggregated by loan program, [available here](https://studentaid.gov/data-center/student/title-iv). 

For "per capita" measures of student debt and borrowing in Table 1, the population for comparison is the estimated total of all California adults aged 18 to 50. I estimate these population totals using American Community Survey data reflecting calendar year 2021, [available here](https://www.census.gov/programs-surveys/acs/microdata/access.html). 

#### Findings

```{r statenames}

######################################################
### We start with some basic setup. First we make  ###
### a dataframe that relates two-digit state codes ###
### to state names. This will be useful while      ###
### working with PUMS data.                        ###
######################################################

statenames <- data.frame("ST"=c(
  01,     # .Alabama/AL
  02,     # .Alaska/AK
  04,     # .Arizona/AZ
  05,     # .Arkansas/AR
  06,     # .California/CA
  08,     # .Colorado/CO
  09,     # .Connecticut/CT
  10,     # .Delaware/DE
  11,     # .District of Columbia/DC
  12,     # .Florida/FL
  13,     # .Georgia/GA
  15,     # .Hawaii/HI
  16,     # .Idaho/ID
  17,     # .Illinois/IL
  18,     # .Indiana/IN
  19,     # .Iowa/IA
  20,     # .Kansas/KS
  21,     # .Kentucky/KY
  22,     # .Louisiana/LA
  23,     # .Maine/ME
  24,     # .Maryland/MD
  25,     # .Massachusetts/MA
  26,     # .Michigan/MI
  27,     # .Minnesota/MN
  28,     # .Mississippi/MS
  29,     # .Missouri/MO
  30,     # .Montana/MT
  31,     # .Nebraska/NE
  32,     # .Nevada/NV
  33,     # .New Hampshire/NH
  34,     # .New Jersey/NJ
  35,     # .New Mexico/NM
  36,     # .New York/NY
  37,     # .North Carolina/NC
  38,     # .North Dakota/ND
  39,     # .Ohio/OH
  40,     # .Oklahoma/OK
  41,     # .Oregon/OR
  42,     # .Pennsylvania/PA
  44,     # .Rhode Island/RI
  45,     # .South Carolina/SC
  46,     # .South Dakota/SD
  47,     # .Tennessee/TN
  48,     # .Texas/TX
  49,     # .Utah/UT
  50,     # .Vermont/VT
  51,     # .Virginia/VA
  53,     # .Washington/WA
  54,     # .West Virginia/WV
  55,     # .Wisconsin/WI
  56,     # .Wyoming/WY
  72     # .Puerto Rico/PR
), "State"=c(
  "Alabama",
  "Alaska",
  "Arizona",
  "Arkansas",
  "California",
  "Colorado",
  "Connecticut",
  "Delaware",
  "District of Columbia",
  "Florida",
  "Georgia",
  "Hawaii",
  "Idaho",
  "Illinois",
  "Indiana",
  "Iowa",
  "Kansas",
  "Kentucky",
  "Louisiana",
  "Maine",
  "Maryland",
  "Massachusetts",
  "Michigan",
  "Minnesota",
  "Mississippi",
  "Missouri",
  "Montana",
  "Nebraska",
  "Nevada",
  "New Hampshire",
  "New Jersey",
  "New Mexico",
  "New York",
  "North Carolina",
  "North Dakota",
  "Ohio",
  "Oklahoma",
  "Oregon",
  "Pennsylvania",
  "Rhode Island",
  "South Carolina",
  "South Dakota",
  "Tennessee",
  "Texas",
  "Utah",
  "Vermont",
  "Virginia",
  "Washington",
  "West Virginia",
  "Wisconsin",
  "Wyoming",
  "Puerto Rico"))
statenames2 <- data.frame("State Abbreviation"=c(
  "AL",     # Alabama/AL
  "AK",     # Alaska/AK
  "AZ",     # Arizona/AZ
  "AR",     # Arkansas/AR
  "CA",     # California/CA
  "CO",     # Colorado/CO
  "CT",     # Connecticut/CT
  "DE",     # Delaware/DE
  "DC",     # District of Columbia/DC
  "FL",     # Florida/FL
  "GA",     # Georgia/GA
  "HI",     # Hawaii/HI
  "ID",     # Idaho/ID
  "IL",     # Illinois/IL
  "IN",     # Indiana/IN
  "IA",     # Iowa/IA
  "KS",     # Kansas/KS
  "KY",     # Kentucky/KY
  "LA",     # Louisiana/LA
  "ME",     # Maine/ME
  "MD",     # Maryland/MD
  "MA",     # Massachusetts/MA
  "MI",     # Michigan/MI
  "MN",     # Minnesota/MN
  "MS",     # Mississippi/MS
  "MO",     # Missouri/MO
  "MT",     # Montana/MT
  "NE",     # Nebraska/NE
  "NV",     # Nevada/NV
  "NH",     # New Hampshire/NH
  "NJ",     # New Jersey/NJ
  "NM",     # New Mexico/NM
  "NY",     # New York/NY
  "NC",     # North Carolina/NC
  "ND",     # North Dakota/ND
  "OH",     # Ohio/OH
  "OK",     # Oklahoma/OK
  "OR",     # Oregon/OR
  "PA",     # Pennsylvania/PA
  "RI",     # Rhode Island/RI
  "SC",     # South Carolina/SC
  "SD",     # South Dakota/SD
  "TN",     # Tennessee/TN
  "TX",     # Texas/TX
  "UT",     # Utah/UT
  "VT",     # Vermont/VT
  "VA",     # Virginia/VA
  "WA",     # Washington/WA
  "WV",     # West Virginia/WV
  "WI",     # Wisconsin/WI
  "WY",     # Wyoming/WY
  "PR"     # Puerto Rico/PR
), "State"=c(
  "Alabama",
  "Alaska",
  "Arizona",
  "Arkansas",
  "California",
  "Colorado",
  "Connecticut",
  "Delaware",
  "District of Columbia",
  "Florida",
  "Georgia",
  "Hawaii",
  "Idaho",
  "Illinois",
  "Indiana",
  "Iowa",
  "Kansas",
  "Kentucky",
  "Louisiana",
  "Maine",
  "Maryland",
  "Massachusetts",
  "Michigan",
  "Minnesota",
  "Mississippi",
  "Missouri",
  "Montana",
  "Nebraska",
  "Nevada",
  "New Hampshire",
  "New Jersey",
  "New Mexico",
  "New York",
  "North Carolina",
  "North Dakota",
  "Ohio",
  "Oklahoma",
  "Oregon",
  "Pennsylvania",
  "Rhode Island",
  "South Carolina",
  "South Dakota",
  "Tennessee",
  "Texas",
  "Utah",
  "Vermont",
  "Virginia",
  "Washington",
  "West Virginia",
  "Wisconsin",
  "Wyoming",
  "Puerto Rico"))
```

```{r pums}
######################################################
### Here we load in person-level data from every   ###
### state, merging the two datasets that contain   ###
### the sample. This is useful for later.          ###
######################################################

pusa <- fread("psam_pusa_2021.csv", header=TRUE, select=c("SERIALNO", "ST", "AGEP", "PWGTP"))
pusb <- fread("psam_pusb_2021.csv", header=TRUE, select=c("SERIALNO", "ST", "AGEP", "PWGTP"))
pusm <- rbind(pusa, pusb)
rm("pusa", "pusb")
```

Table 1 below shows how California compares to other states in its federal student loan debt per capita, its number of borrowers per capita, and its average federal student loan balance. California ranks well in the firs two measures due to a smaller percentage of its population holding debt than in other states. However, California's borrowers exceed other states' borrowers in their average balance. Californians who hold federal student loan debt averaged roughly $37,000 in June 2022. 

### {.tabset}
```{r interstateComp}

######################################################
### Because we will present these results in two   ###
### tables, we first create the tables.            ###
######################################################
 
interstateComp <- data.frame(
  "X1" = c(NA), 
  "X2" = c(NA), 
  "X3" = c(NA), 
  "X4" = c(NA)
)
names(interstateComp) <- c("Measure", "50-state median", "California value", "California rank")

scaleCali <- data.frame(
  "X1" = c(NA), 
  "X2" = c(NA), 
  "X3" = c(NA), 
  "X4" = c(NA)
)
names(scaleCali) <- c("Measure", "U.S. total", "California value", "California share")

######################################################
### Next we load in the FSA data on student loan   ###
### portfolio by state.                            ###
######################################################

portfolio <- fread("Portfolio-by-Location.csv", header=TRUE, skip=5, nrow=54)

######################################################
### Now we convert the units of the data.          ###
######################################################

portfolio$`Balance (in billions)` <- portfolio$`Balance (in billions)` * 1000000000
portfolio$`Borrowers (in thousands)` <- portfolio$`Borrowers (in thousands)` * 1000
names(portfolio) <- c("State", "Balance", "Borrowers")

######################################################
### We derive a per-borrower "average balance"     ###
### measure for every state.                       ###
######################################################

portfolio$`Average balance` <- portfolio$Balance / portfolio$Borrowers

######################################################
### We also remove non-state entries in the list.  ###
### Before doing so we save the total borrowers    ###
### and total debt for later.                      ###
######################################################

totalDebt <- sum(portfolio$Balance)
totalBorrowers <- sum(portfolio$Borrowers)
portfolio <- portfolio %>% filter(State %in% c("Other", "Not Reported", "Puerto Rico")==FALSE)
portfolio <- left_join(x=portfolio, y=statenames2, by="State")

######################################################
### Now we want to consider the portfolio on a     ###
### per-capita basis.                              ###
######################################################

######################################################
### Most debt is held by those 18 to 50, so we     ###
### divide total debt by state by the aggregated   ###
### total of people aged 18 to 50 in the state.    ###
######################################################

pusm <- pusm %>% filter(AGEP >= 18 & AGEP <= 50)
population18to50 <- aggregate(data=pusm, PWGTP ~ ST, FUN=sum)
population18to50 <- left_join(x=population18to50, y=statenames, by="ST")
population18to50 <- population18to50 %>% select(State,  PWGTP)
names(population18to50) <- c("State", "Number of adults aged 18-50")
portfolio <- left_join(x=portfolio, y=population18to50, by="State")

portfolio$`Debt per adult aged 18-50` <- portfolio$Balance / portfolio$`Number of adults aged 18-50`
portfolio$`Borrowers per 1000 adults` <- (portfolio$Borrowers / portfolio$`Number of adults aged 18-50`) * 1000

######################################################
### Now we can rank California alongside other     ###
### states according to these key measures.        ###
######################################################

######################################################
### First we create the rank variables.            ###
######################################################

portfolio$`Rank: Balance` <- rank(portfolio$Balance, ties.method="average")
portfolio$`Rank: Borrowers` <- rank(portfolio$Borrowers, ties.method="average")
portfolio$`Rank: Debt per adult aged 18-50` <- rank(portfolio$`Debt per adult aged 18-50`, ties.method="average")
portfolio$`Rank: Borrowers per 1000 adults` <- rank(portfolio$`Borrowers per 1000 adults`, ties.method="average")
portfolio$`Rank: Average balance` <- rank(portfolio$`Average balance`, ties.method="average")

######################################################
### Here we add the results into the table.        ###
######################################################

interstateComp <- interstateComp %>% add_row(
  `Measure` = "Federal student loan debt per adult (18-50)", 
  `50-state median` = dollar(median(portfolio$`Debt per adult aged 18-50`, na.rm=TRUE), accuracy=1), 
  `California value` = dollar(portfolio$`Debt per adult aged 18-50`[portfolio$State=="California"], accuracy=1), 
  `California rank` = (portfolio$`Rank: Debt per adult aged 18-50`[portfolio$State=="California"])
)

interstateComp <- interstateComp %>% add_row(
  `Measure` = "Federal student loan borrowers per 1000 adults", 
  `50-state median` = as.character(round(median(portfolio$`Borrowers per 1000 adults`, na.rm=TRUE), digits=3)), 
  `California value` = as.character(round(portfolio$`Borrowers per 1000 adults`[portfolio$State=="California"], digits=3)), 
  `California rank` = (portfolio$`Rank: Borrowers per 1000 adults`[portfolio$State=="California"])
)

interstateComp <- interstateComp %>% add_row(
  `Measure` = "Average federal student loan balance",
  `50-state median` = dollar(median(portfolio$`Average balance`, na.rm=TRUE), accuracy=1),
  `California value` = dollar(portfolio$`Average balance`[portfolio$State=="California"], accuracy=1),
  `California rank` = (portfolio$`Rank: Average balance`[portfolio$State=="California"])
)

scaleCali <- scaleCali %>% add_row(
  `Measure` = "Total outstanding federal student loan debt",
  `U.S. total` = dollar(sum(portfolio$`Balance`, na.rm=TRUE), accuracy=1000000),
  `California value` = dollar(portfolio$`Balance`[portfolio$State=="California"], accuracy=1000000), 
  `California share` = percent((portfolio$`Balance`[portfolio$State=="California"] / sum(portfolio$`Balance`, na.rm=TRUE)), accuracy=0.1)
)

scaleCali <- scaleCali %>% add_row(
  `Measure` = "Total federal student loan borrowers",
  `U.S. total` = comma(round(sum(portfolio$`Borrowers`, na.rm=TRUE), digits=-3)),
  `California value` = comma(round(portfolio$`Borrowers`[portfolio$State=="California"], digits=-3)),
  `California share` = percent((portfolio$`Borrowers`[portfolio$State=="California"] / sum(portfolio$`Borrowers`, na.rm=TRUE)), accuracy=0.1)
)

######################################################
### Finally, let's remove the placeholder row.     ###
######################################################

interstateComp <- interstateComp %>% filter(is.na(Measure)==FALSE)
scaleCali <- scaleCali %>% filter(is.na(Measure)==FALSE)
```
#### Table 1
```{r kable1, results='asis'}
kable(interstateComp, caption="California's rank on average debt measures") %>% kable_paper("hover", full_width = F)
```
#### Table 1: State Ranks
##### States ranked by number of federal student loan borrowers per 1,000 adults aged 18-50
```{r rankschart1}
ranksChart1 <- portfolio %>% select(`State`, `State.Abbreviation`, `Borrowers`, `Number of adults aged 18-50`, `Borrowers per 1000 adults`, `Rank: Borrowers per 1000 adults`) %>% arrange(`Borrowers per 1000 adults`)

ranksChart1$California <- rep(NA, nrow(ranksChart1))
ranksChart1$California[ranksChart1$State=="California"] <- "Yes"
ranksChart1$California[ranksChart1$State != "California"] <- "No"

ranksChart1$`For Tooltip` <- paste(
  "State: ", ranksChart1$State, '\n',
  "Borrowers: ", comma(ranksChart1$Borrowers), '\n',
  "Number of adults aged 18-50: ", comma(round(ranksChart1$`Number of adults aged 18-50`, -3)), '\n',
  "Borrowers per 1000 adults: ", round(ranksChart1$`Borrowers per 1000 adults`, 1), '\n',
  "Rank of borrowers per 1000 adults: ", round(ranksChart1$`Rank: Borrowers per 1000 adults`, 0),
  sep=""
)
ranksChart1$State.Abbreviation <- factor(ranksChart1$State.Abbreviation, levels = ranksChart1$State.Abbreviation[order(ranksChart1$`Borrowers per 1000 adults`)])

R1 <- ggplot(data=ranksChart1, mapping=aes(x=`State.Abbreviation`, y=`Borrowers per 1000 adults`, fill=California, text=`For Tooltip`)) + geom_bar(stat="identity") + labs(x="State", y="Student loan borrowers per 1000 adults") + scale_fill_manual(values = rev(flagCols2[4:5])) + theme(legend.position='none', text=element_text(family="Optima"), axis.text = element_text(size = 7)) 

ggplotly(R1, width=900, height=300, tooltip="text")
```

##### States ranked by borrowers' average federal student loan balance
```{r rankschart2}
ranksChart2 <- portfolio %>% select(`State`, `State.Abbreviation`, `Balance`,  `Borrowers`, `Average balance`, `Rank: Average balance`) %>% arrange(`Average balance`)

ranksChart2$California <- rep(NA, nrow(ranksChart2))
ranksChart2$California[ranksChart2$State=="California"] <- "Yes"
ranksChart2$California[ranksChart2$State != "California"] <- "No"

ranksChart2$`For Tooltip` <- paste(
  "State: ", ranksChart2$State, '\n',
  "Borrowers: ", comma(ranksChart2$Borrowers), '\n',
  "Balance: ", dollar(round(ranksChart2$Balance, -3)), '\n',
  "Borrowers: ", comma(round(ranksChart2$Borrowers, -3)), '\n',
  "Average balance: ", dollar(ranksChart2$`Average balance`, accuracy=1), '\n',
  "Rank of average balance: ", round(ranksChart2$`Rank: Average balance`, 0), '\n',
  sep=""
)
ranksChart2$State.Abbreviation <- factor(ranksChart2$State.Abbreviation, levels = ranksChart2$State.Abbreviation[order(ranksChart2$`Average balance`)])

R2 <- ggplot(data=ranksChart2, mapping=aes(x=`State.Abbreviation`, y=`Average balance`, fill=California, text=`For Tooltip`)) + geom_bar(stat="identity") + labs(x="State", y="Average balance") + scale_fill_manual(values = rev(flagCols2[4:5])) + theme(legend.position='none', text=element_text(family="Optima"), axis.text = element_text(size = 7)) + scale_y_continuous(labels=scales::dollar_format(accuracy=1))

ggplotly(R2, width=900, height=300, tooltip="text")
```
#### Data Source and Notes

**Data source:** Federal Student Aid Data Center, spreadsheet on federal student loan portfolio by borrower location, [available here](https://studentaid.gov/data-center/student/portfolio), accessed December 2022. 

**Timeframe reflected:** Figures in this table reflect the federal student loan portfolio as of June 30, 2022. 

**Notes:** In the "California rank" column, a rank of 1 would indicate the lowest debt, borrowers, or average balance. The universe of borrowers is all those with an outstanding balance. 

***

### {-}


Table 2 below shows the size of California's outstanding federal student loan debt. California has the most outstanding federal student loan debt ($142 billion) and borrowers (3.8 million) of any state, amounting to around 9 percent of the nationwide federal student loan portfolio. Given that California has a slightly higher average federal student loan balance than most states (see Table 1 above), California has a slightly greater share of nationwide debt than its share of nationwide borrowers. 

#### {.tabset}
##### Table 2
```{r kable2, results='asis'}
kable(scaleCali, caption="Size of California borrowers' outstanding debt") %>% kable_paper("hover", full_width = F)
```
##### Data Source and Notes

**Data source:** Federal Student Aid Data Center, spreadsheet on federal student loan portfolio by borrower location, [available here](https://studentaid.gov/data-center/student/portfolio), accessed December 2022. 

**Timeframe reflected:** Figures in this table reflect the federal student loan portfolio as of June 30, 2022. 

**Notes:** Dollar values in the "Total outstanding federal student loan debt" row are rounded to the nearest $100 million. Values in the "Total federal student loan borrowers" row are rounded to the nearest thousand. 

***

#### {-}

For California's borrowers to have the most debt likely comes as no surprise given that California has the nation's largest populace. But it also means that California's lawmakers can do more to change the course of the nation's student debt crisis than virtually any other state's leaders. 

Table 3 below draws from the FSA Data Center's quarterly data on disbursements. To minimize any impact from the COVID-19 pandemic on our results, we examine data from the last fully pre-pandemic award year, 2018-19. 

```{r loanPrep1, warning=FALSE}

######################################################
### First we load in student loan disbursement     ###
### data from 2018-19.                             ###
######################################################

loans1819 <- fread("dl-dashboard-ay2018-2019-q4-california.csv", header=TRUE, skip=6)
names(loans1819) <- c(
  "OPEID",
  "School",
  "State",
  "Zip Code",
  "School Type",

  "SUBSIDIZED: Recipients", 
  "SUBSIDIZED: # of Loans Originated", 
  "SUBSIDIZED: $ of Loans Originated", 
  "SUBSIDIZED: # of Disbursements", 
  "SUBSIDIZED: $ of Disbursements", 
   
  "UNSUBSIDIZED - UNDERGRADUATE: Recipients", 
  "UNSUBSIDIZED - UNDERGRADUATE: # of Loans Originated", 
  "UNSUBSIDIZED - UNDERGRADUATE: $ of Loans Originated", 
  "UNSUBSIDIZED - UNDERGRADUATE: # of Disbursements", 
  "UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements", 

  "UNSUBSIDIZED - GRADUATE: Recipients", 
  "UNSUBSIDIZED - GRADUATE: # of Loans Originated", 
  "UNSUBSIDIZED - GRADUATE: $ of Loans Originated", 
  "UNSUBSIDIZED - GRADUATE: # of Disbursements", 
  "UNSUBSIDIZED - GRADUATE: $ of Disbursements", 

  "PARENT PLUS: Recipients", 
  "PARENT PLUS: # of Loans Originated", 
  "PARENT PLUS: $ of Loans Originated", 
  "PARENT PLUS: # of Disbursements", 
  "PARENT PLUS: $ of Disbursements", 

  "GRAD PLUS: Recipients", 
  "GRAD PLUS: # of Loans Originated", 
  "GRAD PLUS: $ of Loans Originated", 
  "GRAD PLUS: # of Disbursements", 
  "GRAD PLUS: $ of Disbursements"
)

######################################################
### Here we must format the OPEIDs, bringing them  ###
### to eight digits.                               ###
######################################################

loans1819$OPEID <- as.character(loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==1, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==2, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==3, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==4, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==5, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==6, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==7, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)

######################################################
### We only need each school's total disbursements ###
### and its total recipients, so we select only    ###
### those variables.                               ###
######################################################

loans1819 <- loans1819 %>% select(
  `OPEID`,
  `School`,
  `State`,
  `Zip Code`,
  `School Type`,

  `SUBSIDIZED: Recipients`, 
  `SUBSIDIZED: $ of Disbursements`, 
   
  `UNSUBSIDIZED - UNDERGRADUATE: Recipients`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`, 

  `UNSUBSIDIZED - GRADUATE: Recipients`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 

  `PARENT PLUS: Recipients`, 
  `PARENT PLUS: $ of Disbursements`, 

  `GRAD PLUS: Recipients`, 
  `GRAD PLUS: $ of Disbursements`
)

######################################################
### Here we make sure that the data are stored     ###
### numerically.                                   ###
######################################################

loans1819$`SUBSIDIZED: Recipients` <- as.numeric(loans1819$`SUBSIDIZED: Recipients`)
loans1819$`SUBSIDIZED: $ of Disbursements` <- as.numeric(loans1819$`SUBSIDIZED: $ of Disbursements`)
   
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients` <- as.numeric(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`)
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` <- as.numeric(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`)

loans1819$`UNSUBSIDIZED - GRADUATE: Recipients` <- as.numeric(loans1819$`UNSUBSIDIZED - GRADUATE: Recipients`)
loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` <- as.numeric(loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`)

loans1819$`PARENT PLUS: Recipients` <- as.numeric(loans1819$`PARENT PLUS: Recipients`)
loans1819$`PARENT PLUS: $ of Disbursements` <- as.numeric(loans1819$`PARENT PLUS: $ of Disbursements`)

loans1819$`GRAD PLUS: Recipients` <- as.numeric(loans1819$`GRAD PLUS: Recipients`)
loans1819$`GRAD PLUS: $ of Disbursements` <- as.numeric(loans1819$`GRAD PLUS: $ of Disbursements`)

######################################################
### We also want to make sure any NA values are    ###
### stored as zeroes.                              ###
######################################################

loans1819$`SUBSIDIZED: Recipients`[is.na(loans1819$`SUBSIDIZED: Recipients`)] <- 0
loans1819$`SUBSIDIZED: $ of Disbursements`[is.na(loans1819$`SUBSIDIZED: $ of Disbursements`)] <- 0
   
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`[is.na(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`)] <- 0
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`[is.na(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`)] <- 0

loans1819$`UNSUBSIDIZED - GRADUATE: Recipients`[is.na(loans1819$`UNSUBSIDIZED - GRADUATE: Recipients`)] <- 0
loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`[is.na(loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`)] <- 0

loans1819$`PARENT PLUS: Recipients`[is.na(loans1819$`PARENT PLUS: Recipients`)] <- 0
loans1819$`PARENT PLUS: $ of Disbursements`[is.na(loans1819$`PARENT PLUS: $ of Disbursements`)] <- 0

loans1819$`GRAD PLUS: Recipients`[is.na(loans1819$`GRAD PLUS: Recipients`)] <- 0
loans1819$`GRAD PLUS: $ of Disbursements`[is.na(loans1819$`GRAD PLUS: $ of Disbursements`)] <- 0

######################################################
### Here we create a variable for total loan       ###
### disbursements at a college.                    ###
######################################################

loans1819$`Total $ of Disbursements` <- loans1819$`SUBSIDIZED: $ of Disbursements` + loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` + loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` + loans1819$`PARENT PLUS: $ of Disbursements` + loans1819$`GRAD PLUS: $ of Disbursements`

```

```{r loanPrograms}

######################################################
### Using the loan data we had imported earlier,   ###
### we aggregate totals by state.                  ###
######################################################

table3.1 <- loans1819
table3.2 <- loans1819
table3.1$State[table3.1$State != "CA"] <- "Rest of U.S."

table3.1 <- aggregate(data=table3.1, cbind(  
  `SUBSIDIZED: $ of Disbursements`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `PARENT PLUS: $ of Disbursements`, 
  `GRAD PLUS: $ of Disbursements`, 
  `Total $ of Disbursements`) ~ State, FUN=sum)

table3.2 <- aggregate(data=table3.2, cbind(  
  `SUBSIDIZED: $ of Disbursements`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `PARENT PLUS: $ of Disbursements`, 
  `GRAD PLUS: $ of Disbursements`, 
  `Total $ of Disbursements`) ~ State, FUN=sum)
table3.2 <- table3.2 %>% add_row(
  State = "Nationwide",
  "SUBSIDIZED: $ of Disbursements" = sum(table3.2$`SUBSIDIZED: $ of Disbursements`), 
  "UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements" = sum(table3.2$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`), 
  "UNSUBSIDIZED - GRADUATE: $ of Disbursements" = sum(table3.2$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`), 
  "PARENT PLUS: $ of Disbursements" = sum(table3.2$`PARENT PLUS: $ of Disbursements`), 
  "GRAD PLUS: $ of Disbursements" = sum(table3.2$`GRAD PLUS: $ of Disbursements`), 
  "Total $ of Disbursements" = sum(table3.2$`Total $ of Disbursements`)
)

######################################################
### Now we derive each loan program's share of     ###
### total borrowing in every state.                ###
######################################################

table3.1$`SUBSIDIZED share of total` <- table3.1$`SUBSIDIZED: $ of Disbursements` / table3.1$`Total $ of Disbursements`
table3.1$`UNSUBSIDIZED - UNDERGRADUATE share of total` <- table3.1$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` / table3.1$`Total $ of Disbursements`
table3.1$`UNSUBSIDIZED - GRADUATE share of total` <- table3.1$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` / table3.1$`Total $ of Disbursements`
table3.1$`PARENT PLUS share of total` <- table3.1$`PARENT PLUS: $ of Disbursements` / table3.1$`Total $ of Disbursements`
table3.1$`GRAD PLUS share of total` <- table3.1$`GRAD PLUS: $ of Disbursements` / table3.1$`Total $ of Disbursements`

table3.2$`SUBSIDIZED share of total` <- table3.2$`SUBSIDIZED: $ of Disbursements` / table3.2$`Total $ of Disbursements`
table3.2$`UNSUBSIDIZED - UNDERGRADUATE share of total` <- table3.2$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` / table3.2$`Total $ of Disbursements`
table3.2$`UNSUBSIDIZED - GRADUATE share of total` <- table3.2$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` / table3.2$`Total $ of Disbursements`
table3.2$`PARENT PLUS share of total` <- table3.2$`PARENT PLUS: $ of Disbursements` / table3.2$`Total $ of Disbursements`
table3.2$`GRAD PLUS share of total` <- table3.2$`GRAD PLUS: $ of Disbursements` / table3.2$`Total $ of Disbursements`

######################################################
### We can now compare how California stacks up    ###
### versus the rest of the nation.                 ###
######################################################

table3.1 <- table3.1 %>% filter(State %in% c("CA", "Rest of U.S.")) %>% select(State, `SUBSIDIZED share of total`, `UNSUBSIDIZED - UNDERGRADUATE share of total`, `UNSUBSIDIZED - GRADUATE share of total`, `PARENT PLUS share of total`, `GRAD PLUS share of total`)
names(table3.1) <- c("State", "Subsidized", "Unsubsidized undergraduate", "Unsubsidized graduate", "Parent PLUS loans", "Grad PLUS")
table3.1$`Subsidized` <- percent(table3.1$`Subsidized`, accuracy=0.1)
table3.1$`Unsubsidized undergraduate` <- percent(table3.1$`Unsubsidized undergraduate`, accuracy=0.1)
table3.1$`Unsubsidized graduate` <- percent(table3.1$`Unsubsidized graduate`, accuracy=0.1)
table3.1$`Parent PLUS loans` <- percent(table3.1$`Parent PLUS loans`, accuracy=0.1)
table3.1$`Grad PLUS` <- percent(table3.1$`Grad PLUS`, accuracy=0.1)

table3.2 <- table3.2 %>% filter(State != "") %>% select(State, `SUBSIDIZED share of total`, `UNSUBSIDIZED - UNDERGRADUATE share of total`, `UNSUBSIDIZED - GRADUATE share of total`, `PARENT PLUS share of total`, `GRAD PLUS share of total`)
names(table3.2) <- c("State", "Subsidized", "Unsubsidized undergraduate", "Unsubsidized graduate", "Parent PLUS loans", "Grad PLUS")
table3.2$`Subsidized` <- percent(table3.2$`Subsidized`, accuracy=0.1)
table3.2$`Unsubsidized undergraduate` <- percent(table3.2$`Unsubsidized undergraduate`, accuracy=0.1)
table3.2$`Unsubsidized graduate` <- percent(table3.2$`Unsubsidized graduate`, accuracy=0.1)
table3.2$`Parent PLUS loans` <- percent(table3.2$`Parent PLUS loans`, accuracy=0.1)
table3.2$`Grad PLUS` <- percent(table3.2$`Grad PLUS`, accuracy=0.1)
```

#### {.tabset}
##### Table 3
```{r kable3.1}
kable(table3.1, caption="Share of loan dollars disbursed in 2018-19 by loan type, California vs. Rest of U.S.") %>% kable_paper("hover", full_width = F)
```
##### Table 3: All states
```{r kable3.2}
kable(table3.2, caption="Share of loan dollars disbursed in 2018-19 by loan type") %>% kable_paper("hover", full_width = F)
```

##### Data Source and Notes

**Data source:** Federal Student Aid Data Center, spreadsheet on Direct Loan volume for Q4 2018-19, "Award year summary" tab, [available here](https://studentaid.gov/data-center/student/title-iv), accessed October 2022. 

**Timeframe reflected:** Figures in this table reflect the 2018-19 award year. 

**Notes:** Here I use the data on loan disbursements, not loan originations.

***

#### {-}

Comparing California to the rest of the U.S., we find that: 

* California's federal student loan dollars are less concentrated in the Subsidized loan program and the Unsubsidized undergraduate loan program. 
* California's federal student loan dollars are slightly more concentrated in the Unsubsidized graduate loan program and slightly less concentrated in the Parent PLUS loan program. 
* California's federal student loan dollars are *much* more concentrated in the Grad PLUS loan program, at 19.4% versus 11.0% across the rest of the country.

A major public policy emphasis for state lawmakers, in California as anywhere, is the affordability of undergraduate programs. One sign of California's success in that respect is the lower amount of undergraduate borrowing compared to the rest of the country. (Of course, even small loan balances can strain a borrower's financial life.) The significantly greater use of Grad PLUS, however, is a cause for concern. 

Figure 1 below shows that the average Grad PLUS and Parent PLUS loans in California are higher than in the rest of the U.S. 

#### {.tabset}
```{r sectorLoans}

#######################################################
### Now we load in data from the College Scorecard. ###
#######################################################

scorecard1 <- fread("Most-Recent-Cohorts-Institution.csv", header=TRUE, select=c(
  "OPEID",   # 8-digit OPE ID for institution
  "CONTROL", # Control of institution
  "CCBASIC"  # Carnegie Classification -- basic
))

######################################################
### I now add this variable for later.             ###
######################################################

scorecard1$`Two-year` <- ifelse(scorecard1$CCBASIC %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14), 1, 0)
scorecard1$`Four-year` <- ifelse(scorecard1$CCBASIC %in% c(15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32), 1, 0)

######################################################
### Here I want to format the control variable.    ###
######################################################

scorecard1$Control <- rep(NA, nrow(scorecard1))
scorecard1$Control[scorecard1$CONTROL==1] <- "Public"
scorecard1$Control[scorecard1$CONTROL==2] <- "Non-profit"
scorecard1$Control[scorecard1$CONTROL==3] <- "For-profit"

######################################################
### It's important first to remove the rows that   ###
### have repeated OPEIDs.                          ###
######################################################

scorecard1 <- scorecard1 %>% filter(duplicated(OPEID)==FALSE)

######################################################
### Here we must format the OPEIDs, bringing them  ###
### to eight digits.                               ###
######################################################

scorecard1$OPEID <- as.character(scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==1, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==2, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==3, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==4, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==5, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==6, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==7, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)

######################################################
### Now we merge the two datasets by OPEID.        ###
######################################################

loans1819$State[loans1819$State != "CA"] <- "Rest of U.S."

loans1819 <- left_join(x=loans1819, y=scorecard1, by="OPEID")
forTable4 <- loans1819 %>% filter(`Four-year`==1)

table4 <- aggregate(data=forTable4, cbind(
  `SUBSIDIZED: $ of Disbursements`, 
  `SUBSIDIZED: Recipients`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`,
  `UNSUBSIDIZED - UNDERGRADUATE: Recipients`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: Recipients`, 
  `PARENT PLUS: $ of Disbursements`, 
  `PARENT PLUS: Recipients`, 
  `GRAD PLUS: $ of Disbursements`,
  `GRAD PLUS: Recipients`
) ~ State + Control, FUN=sum)
table4.1 <- aggregate(data=forTable4, cbind(
  `SUBSIDIZED: $ of Disbursements`, 
  `SUBSIDIZED: Recipients`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`,
  `UNSUBSIDIZED - UNDERGRADUATE: Recipients`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: Recipients`, 
  `PARENT PLUS: $ of Disbursements`, 
  `PARENT PLUS: Recipients`, 
  `GRAD PLUS: $ of Disbursements`,
  `GRAD PLUS: Recipients`
) ~ State, FUN=sum)
table4.1$Control <- rep("All controls", nrow(table4.1))
table4 <- rbind(table4.1, table4)

table4 <- table4 %>% filter(State %in% c("CA", "Rest of U.S."))

table4$`Subsidized` <- table4$`SUBSIDIZED: $ of Disbursements` / table4$`SUBSIDIZED: Recipients`
table4$`Unsub. UG` <- table4$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` / table4$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`
table4$`Unsub. Grad.` <- table4$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` / table4$`UNSUBSIDIZED - GRADUATE: Recipients`
table4$`Parent PLUS` <- table4$`PARENT PLUS: $ of Disbursements` / table4$`PARENT PLUS: Recipients`
table4$`Grad PLUS` <- table4$`GRAD PLUS: $ of Disbursements` / table4$`GRAD PLUS: Recipients`

table4.1 <- table4 %>% select(State, Control, `Subsidized`, `Unsub. UG`, `Unsub. Grad.`, `Parent PLUS`, `Grad PLUS`)
table4.1 <- reshape2::melt(data=table4.1, id.vars = c("State", "Control"), value.name="Average Loan")

table4.1$Control <- as.factor(table4.1$Control)
table4.1$Control <- factor(table4.1$Control, levels = rev(c("For-profit", "Non-profit", "Public", "All controls")))
```
##### Figure 1
```{r figure1}
table4.1$`For Tooltip` <- paste(
  "State: ", table4.1$State, '\n',
  "Group: ", table4.1$Group, '\n',
  "Loan type: ", table4.1$variable, '\n',
  "Control: ", table4.1$Control, '\n', 
  "Average annual loan: ", dollar(table4.1$`Average Loan`, accuracy=1),
  sep=""
)

g1 <- ggplot(data=table4.1, mapping=aes(x=State, y=`Average Loan`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.4) + labs(title="Average annual loans at four-year colleges by loan type and sector: California vs. Rest of U.S.") + scale_y_continuous(labels=scales::dollar_format()) + facet_grid(Control ~ variable) + scale_fill_manual(values = stateCols) + theme(legend.position='none', text=element_text(family="Optima")) 

ggplotly(g1, width=800, height=500, tooltip="text")
```
##### Data Source and Notes

**Data source:** Federal Student Aid Data Center, spreadsheet on Direct Loan volume for Q4 2018-19, "Award year summary" tab, [available here](https://studentaid.gov/data-center/student/title-iv), accessed October 2022.

**Timeframe reflected:** Figures in this graph reflect the 2018-19 award year. 

**Notes:** Here I use the data on loan disbursements, not loan originations. These averages do not include students who receive no loans. Only four-year institutions are included. 

***

#### {-}

Across all three institutional control categories, California exceeds the rest of the U.S. in the average Parent PLUS loan and the average Grad PLUS loan. Unlike Stafford loans, Parent PLUS and Grad PLUS are both uncapped, meaning a borrower can take out as much as they would like any year. At California nonprofit and for-profit four-years, the average Parent PLUS loan *per year* is north of \$20,000, and the average Grad PLUS loan per year is around \$30,000. In both cases, the averages are lower at public institutions. 

Not every graduate student borrows Grad PLUS, and not every parent who sends their child to college borrows Parent PLUS. However, high averages mean that the lasting gap between those who do borrow and those who do not is greater. These programs are two driving reasons why California has a higher average student loan balance than most other states.

As for Stafford loans for undergraduates, California hews closely to the rest of the U.S. in average annual borrowing, across all levels of institutional control. 

## National Postsecondary Student Aid Study

#### About the data

The statistics in the previous section are all based on state-level and institution-level data. For the most robust information on the relationship between student loan borrowing and race in California, we need student-level data. In the absence of a [national student-level data set](https://www.thirdway.org/video/the-college-transparency-act-explained), we use survey data from the National Postsecondary Student Aid Study (NPSAS).

NPSAS is the largest survey of U.S. college students that has a primary focus on financial aid and college costs. The study has generally been conducted every four years, with the latest published data set reflecting the 2015-16 year (NPSAS:16). With every NPSAS release, separate data sets examine undergraduate and graduate students. 

For this analysis I use NPSAS:16 and focus the universe on in-state students. This enables us to compare California's in-state students with those across the country. 

It is worth noting here that an edition of NPSAS known as NPSAS-AC (NPSAS Administrative Collection) was released by NCES earlier this year and allows for state-representative samples at the public four-year and community college sector level. In NPSAS-AC, California is one of dozens of states a researcher could examine. By contrast, in NPSAS:16, California is one of the only states large enough to support state-specific queries. 

For information on another state's public four-year students or community college students, we would turn to NPSAS-AC. However, estimates on California's students are actually more robust in NPSAS:16, and I found that NPSAS:16 allowed for more breakdowns across subgroups than NPSAS-AC did. For that reason, I use NPSAS:16 in this section. However, I would recommend NPSAS-AC for examinations of almost any other state, as well as any analyses that seek to rank states based on a certain metric. 

NPSAS data are accessed using the National Center on Education Statistics' (NCES) [Datalab tool](https://nces.ed.gov/datalab/). Every query has a unique table retrieval number that can be used by any user to run the query in Datalab. These table retrieval numbers are included in the "Data Source and Notes" tabs of every chart. 

#### Findings

This research is primarily interested in examining how factors like the racial wealth gap shape the lasting burdens of student debt among California borrowers. Figure 2 below compares average undergraduate borrowing by racial group among California's students compared to the U.S. overall, and below that, the corresponding shares of students who borrow any loans. 

It is important to look at both the average loan amounts and the percentages who borrow. In California, undergraduates who *do* borrow must borrow *more* than undergraduate borrowers nationwide. However, a smaller share of families borrow in California than in the nation overall.

Within California, 28 percent of Black undergraduates receive student loans, the most of any group, and this rises to 31 percent for Black women specifically. 

#### {.tabset}
##### Figure 2: Undergraduate Loans by Race
```{r npsas1}
npsas1.US <- read.csv("Powerstats opspco.csv", skip=12, nrow=7, header=FALSE)
npsas1.US.total <- read.csv("Powerstats opspco.csv", skip=10, nrow=1, header=FALSE)
npsas1.US <- rbind(npsas1.US.total, npsas1.US)

npsas1.CA <- read.csv("Powerstats opspco.csv", skip=73, nrow=7, header=FALSE)
npsas1.CA.total <- read.csv("Powerstats opspco.csv", skip=71, nrow=1, header=FALSE)
npsas1.CA <- rbind(npsas1.CA.total, npsas1.CA)

names(npsas1.US) <- c("Group", "Average loans")
names(npsas1.CA) <- c("Group", "Average loans")

npsas1.US$State <- rep("U.S.", nrow(npsas1.US))
npsas1.CA$State <- rep("CA", nrow(npsas1.CA))
npsas1 <- rbind(npsas1.US, npsas1.CA)

npsas1 <- npsas1 %>% filter(Group != "American Indian or Alaska Native")
npsas1$Group[npsas1$Group=="Black or African American"] <- "Black"
npsas1$Group[npsas1$Group=="Hispanic or Latino"] <- "Latino/a"
npsas1$Group[npsas1$Group=="Native Hawaiian/other Pacific Islander"] <- "Pacific Islander"
npsas1$Group[npsas1$Group=="More than one race"] <- "2+ races"
npsas1$Group[npsas1$Group=="Total"] <- "Overall"

npsas1 <- reshape2::melt(data=npsas1, id.vars = c("Group", "State"), value.name="Average Loan")

npsas1$Group <- as.factor(npsas1$Group)
npsas1$Group <- factor(npsas1$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "Pacific Islander", "2+ races"))
npsas1$`Average Loan` <- as.numeric(npsas1$`Average Loan`)
```

```{r figure2A}
npsas1$`For Tooltip` <- paste(
  "State: ", npsas1$State, '\n', 
  "Group: ", npsas1$Group, '\n', 
  "Average annual loans: ", dollar(npsas1$`Average Loan`, accuracy=1), 
  sep="")

g2A <- ggplot(data=npsas1, mapping=aes(x=State, y=`Average Loan`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average annual undergraduate loans by group: CA vs U.S.") + facet_grid(. ~ Group) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_manual(values = stateCols) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g2A, tooltip="text", width=800, height=350)
```

```{r percentages.npsas1}
npsas1P.US <- read.csv("PowerStats njviui.csv", skip=14, nrow=7, header=FALSE) %>% select(V1, V3)
npsas1P.US.total <- read.csv("PowerStats njviui.csv", skip=12, nrow=1, header=FALSE) %>% select(V1, V3)
npsas1P.US <- rbind(npsas1P.US.total, npsas1P.US)

npsas1P.CA <- read.csv("PowerStats njviui.csv", skip=78, nrow=7, header=FALSE) %>% select(V1, V3)
npsas1P.CA.total <- read.csv("PowerStats njviui.csv", skip=76, nrow=1, header=FALSE) %>% select(V1, V3)
npsas1P.CA <- rbind(npsas1P.CA.total, npsas1P.CA)

names(npsas1P.US) <- c("Group", "Share Borrowing Loans")
names(npsas1P.CA) <- c("Group", "Share Borrowing Loans")

npsas1P.US$State <- rep("U.S.", nrow(npsas1P.US))
npsas1P.CA$State <- rep("CA", nrow(npsas1P.CA))
npsas1P <- rbind(npsas1P.US, npsas1P.CA)

npsas1P <- npsas1P %>% filter(Group != "American Indian or Alaska Native")
npsas1P$Group[npsas1P$Group=="Black or African American"] <- "Black"
npsas1P$Group[npsas1P$Group=="Hispanic or Latino"] <- "Latino/a"
npsas1P$Group[npsas1P$Group=="Native Hawaiian/other Pacific Islander"] <- "Pacific Islander"
npsas1P$Group[npsas1P$Group=="More than one race"] <- "2+ races"
npsas1P$Group[npsas1P$Group=="Total"] <- "Overall"

npsas1P <- reshape2::melt(data=npsas1P, id.vars = c("Group", "State"), value.name="Share Borrowing Loans")

npsas1P$Group <- as.factor(npsas1P$Group)
npsas1P$Group <- factor(npsas1P$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "Pacific Islander", "2+ races"))
npsas1P$`Share Borrowing Loans` <- as.numeric(npsas1P$`Share Borrowing Loans`) / 100
```

```{r percentages.figure2A}
npsas1P$`For Tooltip` <- paste(
  "State: ", npsas1P$State, '\n', 
  "Group: ", npsas1P$Group, '\n', 
  "Share borrowing loans: ", percent(npsas1P$`Share Borrowing Loans`, accuracy=0.1), 
  sep="")

g2AP <- ggplot(data=npsas1P, mapping=aes(x=State, y=`Share Borrowing Loans`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Share borrowing undergraduate loans by group: CA vs U.S.") + facet_grid(. ~ Group) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) + scale_fill_manual(values = stateCols2) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g2AP, tooltip="text", width=800, height=350)
```
##### Figure 2: Undergraduate Loans by Race and Gender 
```{r npsas1.1}
npsas1.1.US <- read.csv("Powerstats ztmgmm.csv", skip=12, nrow=14, header=FALSE)
npsas1.1.US.total <- read.csv("Powerstats vzreir.csv", skip=12, nrow=2, header=FALSE)
npsas1.1.US <- rbind(npsas1.1.US.total, npsas1.1.US)

npsas1.1.CA <- read.csv("Powerstats ztmgmm.csv", skip=108, nrow=14, header=FALSE)
npsas1.1.CA.total <- read.csv("Powerstats vzreir.csv", skip=48, nrow=2, header=FALSE)
npsas1.1.CA <- rbind(npsas1.1.CA.total, npsas1.1.CA)

names(npsas1.1.US) <- c("Group", "Average loans")
names(npsas1.1.CA) <- c("Group", "Average loans")

npsas1.1.US$State <- rep("U.S.", nrow(npsas1.1.US))
npsas1.1.CA$State <- rep("CA", nrow(npsas1.1.CA))

npsas1.1 <- rbind(npsas1.1.US, npsas1.1.CA)
npsas1.1$Gender <- rep(NA, nrow(npsas1.1))

npsas1.1$Gender[npsas1.1$Group=="Black or African American male"] <- "Male"
npsas1.1$Gender[npsas1.1$Group=="Black or African American female"] <- "Female"
npsas1.1$Group[npsas1.1$Group=="Black or African American male"] <- "Black"
npsas1.1$Group[npsas1.1$Group=="Black or African American female"] <- "Black"

npsas1.1$Gender[npsas1.1$Group=="Hispanic or Latino male"] <- "Male"
npsas1.1$Gender[npsas1.1$Group=="Hispanic or Latino female"] <- "Female"
npsas1.1$Group[npsas1.1$Group=="Hispanic or Latino male"] <- "Latino/a"
npsas1.1$Group[npsas1.1$Group=="Hispanic or Latino female"] <- "Latino/a"

npsas1.1$Gender[npsas1.1$Group=="Asian male"] <- "Male"
npsas1.1$Gender[npsas1.1$Group=="Asian female"] <- "Female"
npsas1.1$Group[npsas1.1$Group=="Asian male"] <- "Asian"
npsas1.1$Group[npsas1.1$Group=="Asian female"] <- "Asian"

npsas1.1$Gender[npsas1.1$Group=="Pacific Islander/Hawaiian male"] <- "Male"
npsas1.1$Gender[npsas1.1$Group=="Pacific Islander/Hawaiian female"] <- "Female"
npsas1.1$Group[npsas1.1$Group=="Pacific Islander/Hawaiian male"] <- "Pacific Islander"
npsas1.1$Group[npsas1.1$Group=="Pacific Islander/Hawaiian female"] <- "Pacific Islander"

npsas1.1$Gender[npsas1.1$Group=="White male"] <- "Male"
npsas1.1$Gender[npsas1.1$Group=="White female"] <- "Female"
npsas1.1$Group[npsas1.1$Group=="White male"] <- "White"
npsas1.1$Group[npsas1.1$Group=="White female"] <- "White"

npsas1.1$Gender[npsas1.1$Group=="American Indian or Alaska Native male"] <- "Male"
npsas1.1$Gender[npsas1.1$Group=="American Indian or Alaska Native female"] <- "Female"
npsas1.1$Group[npsas1.1$Group=="American Indian or Alaska Native male"] <- "Native American"
npsas1.1$Group[npsas1.1$Group=="American Indian or Alaska Native female"] <- "Native American"

npsas1.1$Gender[npsas1.1$Group=="Male of more than one race"] <- "Male"
npsas1.1$Gender[npsas1.1$Group=="Female of more than one race"] <- "Female"
npsas1.1$Group[npsas1.1$Group=="Male of more than one race"] <- "2+ races"
npsas1.1$Group[npsas1.1$Group=="Female of more than one race"] <- "2+ races"

npsas1.1$Gender[npsas1.1$Group=="Male"] <- "Male"
npsas1.1$Gender[npsas1.1$Group=="Female"] <- "Female"
npsas1.1$Group[npsas1.1$Group=="Male"] <- "Overall"
npsas1.1$Group[npsas1.1$Group=="Female"] <- "Overall"

npsas1.1 <- npsas1.1 %>% filter(Group %in% c("Native American", "Pacific Islander")==FALSE)

npsas1.1 <- reshape2::melt(data=npsas1.1, id.vars = c("Group", "State", "Gender"), value.name="Average Loan")

npsas1.1$Gender <- as.factor(npsas1.1$Gender)
npsas1.1$Gender <- factor(npsas1.1$Gender, levels=c("Male", "Female"))

npsas1.1$Group <- as.factor(npsas1.1$Group)
npsas1.1$Group <- factor(npsas1.1$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "2+ races"))
npsas1.1$`Average Loan` <- as.numeric(npsas1.1$`Average Loan`)
```

```{r figure2B}
npsas1.1$`For Tooltip` <- paste(
  "State: ", npsas1.1$State, '\n', 
  "Group: ", npsas1.1$Group, '\n', 
  "Gender: ", npsas1.1$Gender, '\n', 
  "Average annual loans: ", dollar(npsas1.1$`Average Loan`, accuracy=1), 
  sep="")

g2B <- ggplot(data=npsas1.1, mapping=aes(x=State, y=`Average Loan`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average annual undergraduate loans by group and gender: CA vs. U.S.") + facet_grid(Gender ~ Group) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_manual(values = flagCols) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g2B, tooltip="text", width=800, height=350)
```

```{r percentages.npsas1.1}
npsas1.1P.US <- read.csv("Powerstats tqbbxv.csv", skip=14, nrow=14, header=FALSE) %>% select(V1, V3)
npsas1.1P.US.total <- read.csv("Powerstats pqftzn.csv", skip=14, nrow=2, header=FALSE) %>% select(V1, V3)
npsas1.1P.US <- rbind(npsas1.1P.US.total, npsas1.1P.US)

npsas1.1P.CA <- read.csv("Powerstats tqbbxv.csv", skip=113, nrow=14, header=FALSE) %>% select(V1, V3)
npsas1.1P.CA.total <- read.csv("Powerstats pqftzn.csv", skip=53, nrow=2, header=FALSE) %>% select(V1, V3)
npsas1.1P.CA <- rbind(npsas1.1P.CA.total, npsas1.1P.CA)

names(npsas1.1P.US) <- c("Group", "Share Borrowing Loans")
names(npsas1.1P.CA) <- c("Group", "Share Borrowing Loans")

npsas1.1P.US$State <- rep("U.S.", nrow(npsas1.1P.US))
npsas1.1P.CA$State <- rep("CA", nrow(npsas1.1P.CA))
npsas1.1P <- rbind(npsas1.1P.US, npsas1.1P.CA)

npsas1.1P$Gender <- rep(NA, nrow(npsas1.1P))

npsas1.1P$Gender[npsas1.1P$Group=="Black or African American male"] <- "Male"
npsas1.1P$Gender[npsas1.1P$Group=="Black or African American female"] <- "Female"
npsas1.1P$Group[npsas1.1P$Group=="Black or African American male"] <- "Black"
npsas1.1P$Group[npsas1.1P$Group=="Black or African American female"] <- "Black"

npsas1.1P$Gender[npsas1.1P$Group=="Hispanic or Latino male"] <- "Male"
npsas1.1P$Gender[npsas1.1P$Group=="Hispanic or Latino female"] <- "Female"
npsas1.1P$Group[npsas1.1P$Group=="Hispanic or Latino male"] <- "Latino/a"
npsas1.1P$Group[npsas1.1P$Group=="Hispanic or Latino female"] <- "Latino/a"

npsas1.1P$Gender[npsas1.1P$Group=="Asian male"] <- "Male"
npsas1.1P$Gender[npsas1.1P$Group=="Asian female"] <- "Female"
npsas1.1P$Group[npsas1.1P$Group=="Asian male"] <- "Asian"
npsas1.1P$Group[npsas1.1P$Group=="Asian female"] <- "Asian"

npsas1.1P$Gender[npsas1.1P$Group=="Pacific Islander/Hawaiian male"] <- "Male"
npsas1.1P$Gender[npsas1.1P$Group=="Pacific Islander/Hawaiian female"] <- "Female"
npsas1.1P$Group[npsas1.1P$Group=="Pacific Islander/Hawaiian male"] <- "Pacific Islander"
npsas1.1P$Group[npsas1.1P$Group=="Pacific Islander/Hawaiian female"] <- "Pacific Islander"

npsas1.1P$Gender[npsas1.1P$Group=="White male"] <- "Male"
npsas1.1P$Gender[npsas1.1P$Group=="White female"] <- "Female"
npsas1.1P$Group[npsas1.1P$Group=="White male"] <- "White"
npsas1.1P$Group[npsas1.1P$Group=="White female"] <- "White"

npsas1.1P$Gender[npsas1.1P$Group=="American Indian or Alaska Native male"] <- "Male"
npsas1.1P$Gender[npsas1.1P$Group=="American Indian or Alaska Native female"] <- "Female"
npsas1.1P$Group[npsas1.1P$Group=="American Indian or Alaska Native male"] <- "Native American"
npsas1.1P$Group[npsas1.1P$Group=="American Indian or Alaska Native female"] <- "Native American"

npsas1.1P$Gender[npsas1.1P$Group=="Male of more than one race"] <- "Male"
npsas1.1P$Gender[npsas1.1P$Group=="Female of more than one race"] <- "Female"
npsas1.1P$Group[npsas1.1P$Group=="Male of more than one race"] <- "2+ races"
npsas1.1P$Group[npsas1.1P$Group=="Female of more than one race"] <- "2+ races"

npsas1.1P$Gender[npsas1.1P$Group=="Male"] <- "Male"
npsas1.1P$Gender[npsas1.1P$Group=="Female"] <- "Female"
npsas1.1P$Group[npsas1.1P$Group=="Male"] <- "Overall"
npsas1.1P$Group[npsas1.1P$Group=="Female"] <- "Overall"

npsas1.1P <- npsas1.1P %>% filter(Group %in% c("Native American", "Pacific Islander")==FALSE)

npsas1.1P <- reshape2::melt(data=npsas1.1P, id.vars = c("Group", "State", "Gender"), value.name="Share Borrowing Loans")

npsas1.1P$Group <- as.factor(npsas1.1P$Group)
npsas1.1P$Group <- factor(npsas1.1P$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "2+ races"))
npsas1.1P$`Share Borrowing Loans` <- as.numeric(npsas1.1P$`Share Borrowing Loans`) / 100
```

```{r percentages.figure2B}
npsas1.1P$`For Tooltip` <- paste(
  "State: ", npsas1.1P$State, '\n', 
  "Group: ", npsas1.1P$Group, '\n', 
  "Gender: ", npsas1.1P$Gender, '\n', 
  "Share borrowing loans: ", percent(npsas1.1P$`Share Borrowing Loans`, accuracy=0.1), 
  sep="")

g2BP <- ggplot(data=npsas1.1P, mapping=aes(x=State, y=`Share Borrowing Loans`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Share borrowing undergraduate loans by group and gender: CA vs. U.S.") + facet_grid(Gender ~ Group) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) + scale_fill_manual(values = flagCols2) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g2BP, tooltip="text", width=800, height=350)
```
##### Data Source and Notes

**Data source:** National Postsecondary Student Aid Study, Undergraduate. Datalab interface available [here](https://nces.ed.gov/datalab/) using table retrieval numbers *opspco* and *njviui* for "Figure 2: Race" and *ztmgmm*,  *vzreir*, *tqbbxv*, and *pqftzn* for "Figure 2: Race and Gender."

**Timeframe reflected:** Figures in this graph reflect students enrolled in the 2015-16 academic year. 

**Notes:** Due to limitations of NPSAS:16, the data in Figure 2 only apply to in-state students. The averages here do not include those who did not borrow any loans. These measures include all student loans, including federal student loans (including Parent PLUS), private loans, state loans, and institutional loans. 

***

#### {-}

Figure 3 shows that key differences at the graduate level. The average annual loans are larger than at the undergraduate level, and California more sharply exceeds the nation in the average loan. In addition, the share of California students who borrow is much higher at the graduate level than the undergraduate level. 

#### {.tabset}
##### Figure 3: Average Graduate Loans by Race
```{r npsas2}
npsas2.US <- read.csv("Powerstats avflfm.csv", skip=12, nrow=7, header=FALSE)
npsas2.US.total <- read.csv("Powerstats avflfm.csv", skip=10, nrow=1, header=FALSE)
npsas2.US <- rbind(npsas2.US.total, npsas2.US)

npsas2.CA <- read.csv("Powerstats avflfm.csv", skip=73, nrow=7, header=FALSE)
npsas2.CA.total <- read.csv("Powerstats avflfm.csv", skip=71, nrow=1, header=FALSE)
npsas2.CA <- rbind(npsas2.CA.total, npsas2.CA)

names(npsas2.US) <- c("Group", "Average loans")
names(npsas2.CA) <- c("Group", "Average loans")

npsas2.US$State <- rep("U.S.", nrow(npsas2.US))
npsas2.CA$State <- rep("CA", nrow(npsas2.CA))
npsas2 <- rbind(npsas2.US, npsas2.CA)

npsas2 <- npsas2 %>% filter((Group %in% c("American Indian or Alaska Native", "Native Hawaiian/other Pacific Islander", "More than one race"))==FALSE)

npsas2$Group[npsas2$Group=="Black or African American"] <- "Black"
npsas2$Group[npsas2$Group=="Hispanic or Latino"] <- "Latino/a"
npsas2$Group[npsas2$Group=="Total"] <- "Overall"

npsas2$Group <- as.factor(npsas2$Group)
npsas2$Group <- factor(npsas2$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian"))
npsas2$`Average loans` <- as.numeric(npsas2$`Average loans`)
```

```{r figure3A}
npsas2$`For Tooltip` <- paste(
  "State: ", npsas2$State, '\n',
  "Group: ", npsas2$Group, '\n',
  "Average annual federal loans: ", dollar(npsas2$`Average loans`, accuracy=1),
  sep=""
)

g3 <- ggplot(data=npsas2, mapping=aes(x=State, y=`Average loans`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average annual graduate loans by group: CA vs U.S.", y="Average Loan") + facet_grid(. ~ Group) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_manual(values = stateCols) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g3, width=800, height=350, tooltip="text")
```

```{r percentages.npsas2}
npsas2P.US <- read.csv("Powerstats lhkurg.csv", skip=14, nrow=7, header=FALSE) %>% select(V1, V3)
npsas2P.US.total <- read.csv("Powerstats lhkurg.csv", skip=12, nrow=1, header=FALSE) %>% select(V1, V3)
npsas2P.US <- rbind(npsas2P.US.total, npsas2P.US)

npsas2P.CA <- read.csv("Powerstats lhkurg.csv", skip=78, nrow=7, header=FALSE) %>% select(V1, V3)
npsas2P.CA.total <- read.csv("Powerstats lhkurg.csv", skip=76, nrow=1, header=FALSE) %>% select(V1, V3)
npsas2P.CA <- rbind(npsas2P.CA.total, npsas2P.CA)

names(npsas2P.US) <- c("Group", "Share Borrowing Loans")
names(npsas2P.CA) <- c("Group", "Share Borrowing Loans")

npsas2P.US$State <- rep("U.S.", nrow(npsas2P.US))
npsas2P.CA$State <- rep("CA", nrow(npsas2P.CA))
npsas2P <- rbind(npsas2P.US, npsas2P.CA)

npsas2P <- npsas2P %>% filter((Group %in% c("American Indian or Alaska Native", "Native Hawaiian/other Pacific Islander", "More than one race"))==FALSE)

npsas2P$Group[npsas2P$Group=="Black or African American"] <- "Black"
npsas2P$Group[npsas2P$Group=="Hispanic or Latino"] <- "Latino/a"
npsas2P$Group[npsas2P$Group=="Total"] <- "Overall"

npsas2P$Group <- as.factor(npsas2P$Group)
npsas2P$Group <- factor(npsas2P$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian"))
npsas2P$`Share Borrowing Loans` <- as.numeric(npsas2P$`Share Borrowing Loans`) / 100
```

```{r percentages.figure3A}
npsas2P$`For Tooltip` <- paste(
  "State: ", npsas2P$State, '\n',
  "Group: ", npsas2P$Group, '\n',
  "Share borrowing loans: ", percent(npsas2P$`Share Borrowing Loans`, accuracy=0.1),
  sep=""
)

g3P <- ggplot(data=npsas2P, mapping=aes(x=State, y=`Share Borrowing Loans`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Share borrowing graduate loans by group: CA vs U.S.", y="Share Borrowing Loans") + facet_grid(. ~ Group) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) + scale_fill_manual(values = stateCols2) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g3P, width=800, height=350, tooltip="text")
```
##### Figure 3: Average Graduate Loans by Race and Gender (U.S. only)
```{r npsas2.1}
npsas2.1 <- read.csv("Powerstats aotdhl.csv", skip=12, nrow=14, header=FALSE)
npsas2.1.total <- read.csv("Powerstats lyrbbf.csv", skip=12, nrow=2, header=FALSE)
npsas2.1 <- rbind(npsas2.1.total, npsas2.1)
names(npsas2.1) <- c("Group", "Average loans")

npsas2.1$State <- rep("U.S.", nrow(npsas2.1))
npsas2.1$Gender <- rep(NA, nrow(npsas2.1))

npsas2.1$Gender[npsas2.1$Group=="Black or African American male"] <- "Male"
npsas2.1$Gender[npsas2.1$Group=="Black or African American female"] <- "Female"
npsas2.1$Group[npsas2.1$Group=="Black or African American male"] <- "Black"
npsas2.1$Group[npsas2.1$Group=="Black or African American female"] <- "Black"

npsas2.1$Gender[npsas2.1$Group=="Hispanic or Latino male"] <- "Male"
npsas2.1$Gender[npsas2.1$Group=="Hispanic or Latino female"] <- "Female"
npsas2.1$Group[npsas2.1$Group=="Hispanic or Latino male"] <- "Latino/a"
npsas2.1$Group[npsas2.1$Group=="Hispanic or Latino female"] <- "Latino/a"

npsas2.1$Gender[npsas2.1$Group=="Asian male"] <- "Male"
npsas2.1$Gender[npsas2.1$Group=="Asian female"] <- "Female"
npsas2.1$Group[npsas2.1$Group=="Asian male"] <- "Asian"
npsas2.1$Group[npsas2.1$Group=="Asian female"] <- "Asian"

npsas2.1$Gender[npsas2.1$Group=="Pacific Islander/Hawaiian male"] <- "Male"
npsas2.1$Gender[npsas2.1$Group=="Pacific Islander/Hawaiian female"] <- "Female"
npsas2.1$Group[npsas2.1$Group=="Pacific Islander/Hawaiian male"] <- "Pacific Islander"
npsas2.1$Group[npsas2.1$Group=="Pacific Islander/Hawaiian female"] <- "Pacific Islander"

npsas2.1$Gender[npsas2.1$Group=="White male"] <- "Male"
npsas2.1$Gender[npsas2.1$Group=="White female"] <- "Female"
npsas2.1$Group[npsas2.1$Group=="White male"] <- "White"
npsas2.1$Group[npsas2.1$Group=="White female"] <- "White"

npsas2.1$Gender[npsas2.1$Group=="American Indian or Alaska Native male"] <- "Male"
npsas2.1$Gender[npsas2.1$Group=="American Indian or Alaska Native female"] <- "Female"
npsas2.1$Group[npsas2.1$Group=="American Indian or Alaska Native male"] <- "Native American"
npsas2.1$Group[npsas2.1$Group=="American Indian or Alaska Native female"] <- "Native American"

npsas2.1$Gender[npsas2.1$Group=="Male of more than one race"] <- "Male"
npsas2.1$Gender[npsas2.1$Group=="Female of more than one race"] <- "Female"
npsas2.1$Group[npsas2.1$Group=="Male of more than one race"] <- "2+ races"
npsas2.1$Group[npsas2.1$Group=="Female of more than one race"] <- "2+ races"

npsas2.1$Gender[npsas2.1$Group=="Male"] <- "Male"
npsas2.1$Gender[npsas2.1$Group=="Female"] <- "Female"
npsas2.1$Group[npsas2.1$Group=="Male"] <- "Overall"
npsas2.1$Group[npsas2.1$Group=="Female"] <- "Overall"

npsas2.1 <- npsas2.1 %>% filter((Group %in% c("Native American", "Pacific Islander", "2+ races"))==FALSE)

npsas2.1$Group <- as.factor(npsas2.1$Group)
npsas2.1$Group <- factor(npsas2.1$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "2+ races"))
npsas2.1$`Average loans` <- as.numeric(npsas2.1$`Average loans`)
```

```{r figure3B}
npsas2.1$`For Tooltip` <- paste(
  "State: ", npsas2.1$State, '\n', 
  "Group: ", npsas2.1$Group, '\n', 
  "Gender: ", npsas2.1$Gender, '\n', 
  "Average annual loans: ", dollar(npsas2.1$`Average loans`, accuracy=1), 
  sep="")

g3B <- ggplot(data=npsas2.1, mapping=aes(x=Gender, y=`Average loans`, fill=Gender, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average annual graduate loans by group and gender: U.S. only") + facet_grid(. ~ Group) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_manual(values = flagCols) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g3B, tooltip="text", width=800, height=350)
```

```{r percentages.npsas2.1}
npsas2.1P <- read.csv("Powerstats ukuclj.csv", skip=14, nrow=14, header=FALSE) %>% select(V1, V3)
npsas2.1P.total <- read.csv("Powerstats minyim.csv", skip=14, nrow=2, header=FALSE) %>% select(V1, V3)
npsas2.1P <- rbind(npsas2.1P.total, npsas2.1P)

names(npsas2.1P) <- c("Group", "Share Borrowing Loans")

npsas2.1P$State <- rep("U.S.", nrow(npsas2.1P))
npsas2.1P$Gender <- rep(NA, nrow(npsas2.1P))

npsas2.1P$Gender[npsas2.1P$Group=="Black or African American male"] <- "Male"
npsas2.1P$Gender[npsas2.1P$Group=="Black or African American female"] <- "Female"
npsas2.1P$Group[npsas2.1P$Group=="Black or African American male"] <- "Black"
npsas2.1P$Group[npsas2.1P$Group=="Black or African American female"] <- "Black"

npsas2.1P$Gender[npsas2.1P$Group=="Hispanic or Latino male"] <- "Male"
npsas2.1P$Gender[npsas2.1P$Group=="Hispanic or Latino female"] <- "Female"
npsas2.1P$Group[npsas2.1P$Group=="Hispanic or Latino male"] <- "Latino/a"
npsas2.1P$Group[npsas2.1P$Group=="Hispanic or Latino female"] <- "Latino/a"

npsas2.1P$Gender[npsas2.1P$Group=="Asian male"] <- "Male"
npsas2.1P$Gender[npsas2.1P$Group=="Asian female"] <- "Female"
npsas2.1P$Group[npsas2.1P$Group=="Asian male"] <- "Asian"
npsas2.1P$Group[npsas2.1P$Group=="Asian female"] <- "Asian"

npsas2.1P$Gender[npsas2.1P$Group=="Pacific Islander/Hawaiian male"] <- "Male"
npsas2.1P$Gender[npsas2.1P$Group=="Pacific Islander/Hawaiian female"] <- "Female"
npsas2.1P$Group[npsas2.1P$Group=="Pacific Islander/Hawaiian male"] <- "Pacific Islander"
npsas2.1P$Group[npsas2.1P$Group=="Pacific Islander/Hawaiian female"] <- "Pacific Islander"

npsas2.1P$Gender[npsas2.1P$Group=="White male"] <- "Male"
npsas2.1P$Gender[npsas2.1P$Group=="White female"] <- "Female"
npsas2.1P$Group[npsas2.1P$Group=="White male"] <- "White"
npsas2.1P$Group[npsas2.1P$Group=="White female"] <- "White"

npsas2.1P$Gender[npsas2.1P$Group=="American Indian or Alaska Native male"] <- "Male"
npsas2.1P$Gender[npsas2.1P$Group=="American Indian or Alaska Native female"] <- "Female"
npsas2.1P$Group[npsas2.1P$Group=="American Indian or Alaska Native male"] <- "Native American"
npsas2.1P$Group[npsas2.1P$Group=="American Indian or Alaska Native female"] <- "Native American"

npsas2.1P$Gender[npsas2.1P$Group=="Male of more than one race"] <- "Male"
npsas2.1P$Gender[npsas2.1P$Group=="Female of more than one race"] <- "Female"
npsas2.1P$Group[npsas2.1P$Group=="Male of more than one race"] <- "2+ races"
npsas2.1P$Group[npsas2.1P$Group=="Female of more than one race"] <- "2+ races"

npsas2.1P$Gender[npsas2.1P$Group=="Male"] <- "Male"
npsas2.1P$Gender[npsas2.1P$Group=="Female"] <- "Female"
npsas2.1P$Group[npsas2.1P$Group=="Male"] <- "Overall"
npsas2.1P$Group[npsas2.1P$Group=="Female"] <- "Overall"

npsas2.1P <- npsas2.1P %>% filter((Group %in% c("Native American", "Pacific Islander", "2+ races"))==FALSE)

npsas2.1P$Group <- as.factor(npsas2.1P$Group)
npsas2.1P$Group <- factor(npsas2.1P$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "2+ races"))
npsas2.1P$`Share Borrowing Loans` <- as.numeric(npsas2.1P$`Share Borrowing Loans`) / 100
```

```{r percentages.figure3B}
npsas2.1P$`For Tooltip` <- paste(
  "State: ", npsas2.1P$State, '\n', 
  "Group: ", npsas2.1P$Group, '\n', 
  "Gender: ", npsas2.1P$Gender, '\n', 
  "Share borrowing loans: ", percent(npsas2.1P$`Share Borrowing Loans`, accuracy=0.1), 
  sep="")

g3BP <- ggplot(data=npsas2.1P, mapping=aes(x=Gender, y=`Share Borrowing Loans`, fill=Gender, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Share borrowing graduate loans by group and gender: U.S. only") + facet_grid(. ~ Group) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) + scale_fill_manual(values = flagCols2) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g3BP, tooltip="text", width=800, height=350)
```
##### Data Source and Notes 

**Data source:** National Postsecondary Student Aid Study, Undergraduate. Datalab interface available [here](https://nces.ed.gov/datalab/) using table retrieval numbers *avflfm* and *lhkurg* for "Figure 3: Race" and *aotdhl*, *lyrbbf*, *ukuclj*, and *minyim* for "Figure 3: Race and Gender."

**Timeframe reflected:** Figures in this graph reflect students enrolled in the 2015-16 academic year. 

**Notes:** Due to limitations of NPSAS:16, the data in Figure 3 only apply to in-state students. For "Figure 3: Race and Gender," only the U.S. is used due to insufficient sample size for many subgroups in California. The averages here do not include those who did not borrow any loans. These measures include all student loans, including federal loans, private loans, state loans, and institutional loans. 

***

#### {-}

Differences by group within California are also concerning. More than 80 percent of Black California graduate students and 62 percent of Latino/a California graduate students must borrow student loans, compared to 44 percent of white California graduate students. Although the overall share who borrow is roughly the same in California as in the U.S., Black students are the exception, borrowing loans at a rate that is 13 percentage points higher.

At the graduate level in California, Asian students borrow the greatest average amount, exceeding $30,000 per year, which is slightly above the national average for Asian graduate students. However, Asian graduate students borrow the least frequently of these four groups, in California and in the U.S. overall. (Recall that this is limited to in-state students, so international enrollment is not a factor.)

The NPSAS sample size is not sufficient to add a breakdown by gender and still compare California to the U.S., so we provide the breakdown by race and gender for the U.S. only. Within all groups, graduate students who are women more frequently borrow, but their male peers who borrow tend to borrow slightly more. 

Among California graduate students, the NPSAS sample is not sufficient for a complete breakdown by program level. For context, Figure 4 below uses the national sample in NPSAS:16 to measure borrowing in the graduate program level for which there is sufficient data: namely, master's programs and professional doctorates (e.g. JDs, MDs). Unlike with other charts in this section, these are not limited to in-state students, since we use the national sample here.

#### {.tabset}
##### Figure 4: Average Graduate Loans by Program and Race
```{r npsas3}
npsas3.US.masters <- read.csv("PowerStats ibxxlt.csv", skip=73, nrow=7, header=FALSE)
npsas3.US.masters.total <- read.csv("PowerStats ibxxlt.csv", skip=71, nrow=1, header=FALSE)
npsas3.US.masters <- rbind(npsas3.US.masters.total, npsas3.US.masters
                           )
npsas3.US.professional <- read.csv("PowerStats ibxxlt.csv", skip=256, nrow=7, header=FALSE)
npsas3.US.professional.total <- read.csv("PowerStats ibxxlt.csv", skip=254, nrow=1, header=FALSE)
npsas3.US.professional <- rbind(npsas3.US.professional.total, npsas3.US.professional)

names(npsas3.US.masters) <- c("Group", "Total loans")
names(npsas3.US.professional) <- c("Group", "Total loans")

npsas3.US.masters$Level <- rep("Master's programs", nrow(npsas3.US.masters))
npsas3.US.professional$Level <- rep("Professional doctorates", nrow(npsas3.US.professional))

npsas3 <- rbind(npsas3.US.masters, 
                npsas3.US.professional)
npsas3$State <- rep("U.S.", nrow(npsas3))

npsas3$Group[npsas3$Group=="Black or African American"] <- "Black"
npsas3$Group[npsas3$Group=="Hispanic or Latino"] <- "Latino/a"
npsas3$Group[npsas3$Group=="More than one race"] <- "2+ races"
npsas3$Group[npsas3$Group=="Total"] <- "Overall"

npsas3 <- npsas3 %>% filter(Group %in% c("American Indian or Alaska Native", "Native Hawaiian/other Pacific Islander")==FALSE)

npsas3$Group <- as.factor(npsas3$Group)
npsas3$Group <- factor(npsas3$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "2+ races"))
npsas3$`Total loans` <- as.numeric(npsas3$`Total loans`)
```

```{r figure4A}
npsas3$`For Tooltip` <- paste(
  "State: ", npsas3$State, '\n',
  "Group: ", npsas3$Group, '\n',
  "Level: ", npsas3$Level, '\n',
  "Average annual loans: ", dollar(npsas3$`Total loans`, accuracy=1),
  sep=""
)

g4A <- ggplot(data=npsas3, mapping=aes(x=Group, y=`Total loans`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average annual graduate loans by program level and group: U.S. only", y="Average Loans") + facet_grid(. ~ Level) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_manual(values = stateCols) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g4A, width=800, height=350, tooltip="text")
```

```{r percentages.npsas3}
npsas3P.US.masters <- read.csv("PowerStats zlasyt.csv", skip=78, nrow=7, header=FALSE) %>% select(V1, V3)
npsas3P.US.masters.total <- read.csv("PowerStats zlasyt.csv", skip=76, nrow=1, header=FALSE) %>% select(V1, V3)
npsas3P.US.masters <- rbind(npsas3P.US.masters.total, npsas3P.US.masters)

npsas3P.US.professional <- read.csv("PowerStats zlasyt.csv", skip=270, nrow=7, header=FALSE) %>% select(V1, V3)
npsas3P.US.professional.total <- read.csv("PowerStats zlasyt.csv", skip=268, nrow=1, header=FALSE) %>% select(V1, V3)
npsas3P.US.professional <- rbind(npsas3P.US.professional.total, npsas3P.US.professional)

names(npsas3P.US.masters) <- c("Group", "Share Borrowing Loans")
names(npsas3P.US.professional) <- c("Group", "Share Borrowing Loans")

npsas3P.US.masters$Level <- rep("Master's programs", nrow(npsas3P.US.masters))
npsas3P.US.professional$Level <- rep("Professional doctorates", nrow(npsas3P.US.professional))

npsas3P <- rbind(npsas3P.US.masters, 
                npsas3P.US.professional)
npsas3P$State <- rep("U.S.", nrow(npsas3P))

npsas3P$Group[npsas3P$Group=="Black or African American"] <- "Black"
npsas3P$Group[npsas3P$Group=="Hispanic or Latino"] <- "Latino/a"
npsas3P$Group[npsas3P$Group=="More than one race"] <- "2+ races"
npsas3P$Group[npsas3P$Group=="Total"] <- "Overall"

npsas3P <- npsas3P %>% filter(Group %in% c("American Indian or Alaska Native", "Native Hawaiian/other Pacific Islander")==FALSE)

npsas3P$Group <- as.factor(npsas3P$Group)
npsas3P$Group <- factor(npsas3P$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "2+ races"))
npsas3P$`Share Borrowing Loans` <- as.numeric(npsas3P$`Share Borrowing Loans`) / 100
```

```{r percentages.figure4A}
npsas3P$`For Tooltip` <- paste(
  "State: ", npsas3P$State, '\n',
  "Group: ", npsas3P$Group, '\n',
  "Level: ", npsas3P$Level, '\n',
  "Share borrowing loans: ", percent(npsas3P$`Share Borrowing Loans`, accuracy=0.1),
  sep=""
)

g4AP <- ggplot(data=npsas3P, mapping=aes(x=Group, y=`Share Borrowing Loans`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Share borrowing graduate loans by program level and group: U.S. only", y="Share Borrowing Loans") + facet_grid(. ~ Level) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) + scale_fill_manual(values = stateCols2) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g4AP, width=800, height=350, tooltip="text")
```
##### Figure 4: Average Graduate Loans by Program, Race, and Gender
```{r npsas3.1}
npsas3.1.US.masters <- read.csv("PowerStats gouiaq.csv", skip=108, nrow=14, header=FALSE)
npsas3.1.US.masters.total <- read.csv("Powerstats hxgkel.csv", skip=48, nrow=2, header=FALSE)
npsas3.1.US.masters <- rbind(npsas3.1.US.masters.total, npsas3.1.US.masters)

npsas3.1.US.professional <- read.csv("PowerStats gouiaq.csv", skip=396, nrow=14, header=FALSE)
npsas3.1.US.professional.total <- read.csv("Powerstats hxgkel.csv", skip=156, nrow=2, header=FALSE)
npsas3.1.US.professional <- rbind(npsas3.1.US.professional.total, npsas3.1.US.professional)

names(npsas3.1.US.masters) <- c("Group", "Total loans")
names(npsas3.1.US.professional) <- c("Group", "Total loans")

npsas3.1.US.masters$Level <- rep("Master's programs", nrow(npsas3.1.US.masters))
npsas3.1.US.professional$Level <- rep("Professional doctorates", nrow(npsas3.1.US.professional))

npsas3.1 <- rbind(npsas3.1.US.masters, 
                npsas3.1.US.professional)

npsas3.1$Gender <- rep(NA, nrow(npsas3.1))

npsas3.1$Gender[npsas3.1$Group=="Black or African American male"] <- "Male"
npsas3.1$Gender[npsas3.1$Group=="Black or African American female"] <- "Female"
npsas3.1$Group[npsas3.1$Group=="Black or African American male"] <- "Black"
npsas3.1$Group[npsas3.1$Group=="Black or African American female"] <- "Black"

npsas3.1$Gender[npsas3.1$Group=="Hispanic or Latino male"] <- "Male"
npsas3.1$Gender[npsas3.1$Group=="Hispanic or Latino female"] <- "Female"
npsas3.1$Group[npsas3.1$Group=="Hispanic or Latino male"] <- "Latino/a"
npsas3.1$Group[npsas3.1$Group=="Hispanic or Latino female"] <- "Latino/a"

npsas3.1$Gender[npsas3.1$Group=="Asian male"] <- "Male"
npsas3.1$Gender[npsas3.1$Group=="Asian female"] <- "Female"
npsas3.1$Group[npsas3.1$Group=="Asian male"] <- "Asian"
npsas3.1$Group[npsas3.1$Group=="Asian female"] <- "Asian"

npsas3.1$Gender[npsas3.1$Group=="Pacific Islander/Hawaiian male"] <- "Male"
npsas3.1$Gender[npsas3.1$Group=="Pacific Islander/Hawaiian female"] <- "Female"
npsas3.1$Group[npsas3.1$Group=="Pacific Islander/Hawaiian male"] <- "Pacific Islander"
npsas3.1$Group[npsas3.1$Group=="Pacific Islander/Hawaiian female"] <- "Pacific Islander"

npsas3.1$Gender[npsas3.1$Group=="White male"] <- "Male"
npsas3.1$Gender[npsas3.1$Group=="White female"] <- "Female"
npsas3.1$Group[npsas3.1$Group=="White male"] <- "White"
npsas3.1$Group[npsas3.1$Group=="White female"] <- "White"

npsas3.1$Gender[npsas3.1$Group=="American Indian or Alaska Native male"] <- "Male"
npsas3.1$Gender[npsas3.1$Group=="American Indian or Alaska Native female"] <- "Female"
npsas3.1$Group[npsas3.1$Group=="American Indian or Alaska Native male"] <- "Native American"
npsas3.1$Group[npsas3.1$Group=="American Indian or Alaska Native female"] <- "Native American"

npsas3.1$Gender[npsas3.1$Group=="Male of more than one race"] <- "Male"
npsas3.1$Gender[npsas3.1$Group=="Female of more than one race"] <- "Female"
npsas3.1$Group[npsas3.1$Group=="Male of more than one race"] <- "2+ races"
npsas3.1$Group[npsas3.1$Group=="Female of more than one race"] <- "2+ races"

npsas3.1$Gender[npsas3.1$Group=="Male"] <- "Male"
npsas3.1$Gender[npsas3.1$Group=="Female"] <- "Female"
npsas3.1$Group[npsas3.1$Group=="Male"] <- "Overall"
npsas3.1$Group[npsas3.1$Group=="Female"] <- "Overall"

npsas3.1 <- npsas3.1 %>% filter(Group %in% c("Overall", "White",  "Latino/a", "Black", "Asian"))
npsas3.1$Group <- as.factor(npsas3.1$Group)
npsas3.1$Group <- factor(npsas3.1$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "2+ races"))
npsas3.1$`Total loans` <- as.numeric(npsas3.1$`Total loans`)
```

```{r  figure4B}
npsas3.1$`For Tooltip` <- paste(
  "State: ", npsas3.1$State, '\n',
  "Group: ", npsas3.1$Group, '\n',
  "Gender: ", npsas3.1$Gender, '\n',
  "Level: ", npsas3.1$Level, '\n',
  "Average annual loans: ", dollar(npsas3.1$`Total loans`, accuracy=1),
  sep=""
)

g4B <- ggplot(data=npsas3.1, mapping=aes(x=Group, y=`Total loans`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average annual graduate loans by program level, group and gender: U.S. only", y="Average Loans") + facet_grid(Gender ~ Level) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_manual(values = stateCols) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g4B, width=800, height=450, tooltip="text")
```

```{r percentages.npsas3.1}
npsas3.1P.US.masters <- read.csv("PowerStats iuyjsr.csv", skip=113, nrow=14, header=FALSE) %>% select(V1, V3)
npsas3.1P.US.masters.total <- read.csv("PowerStats ajghcg.csv", skip=53, nrow=2, header=FALSE) %>% select(V1, V3)
npsas3.1P.US.masters <- rbind(npsas3.1P.US.masters.total, npsas3.1P.US.masters)

npsas3.1P.US.professional <- read.csv("PowerStats iuyjsr.csv", skip=410, nrow=14, header=FALSE) %>% select(V1, V3)
npsas3.1P.US.professional.total <- read.csv("PowerStats ajghcg.csv", skip=170, nrow=2, header=FALSE) %>% select(V1, V3)
npsas3.1P.US.professional <- rbind(npsas3.1P.US.professional.total, npsas3.1P.US.professional)

names(npsas3.1P.US.masters) <- c("Group", "Share Borrowing Loans")
names(npsas3.1P.US.professional) <- c("Group", "Share Borrowing Loans")

npsas3.1P.US.masters$Level <- rep("Master's programs", nrow(npsas3.1P.US.masters))
npsas3.1P.US.professional$Level <- rep("Professional doctorates", nrow(npsas3.1P.US.professional))

npsas3.1P <- rbind(npsas3.1P.US.masters, 
                   npsas3.1P.US.professional)

npsas3.1P$Gender <- rep(NA, nrow(npsas3.1P))

npsas3.1P$Gender[npsas3.1P$Group=="Black or African American male"] <- "Male"
npsas3.1P$Gender[npsas3.1P$Group=="Black or African American female"] <- "Female"
npsas3.1P$Group[npsas3.1P$Group=="Black or African American male"] <- "Black"
npsas3.1P$Group[npsas3.1P$Group=="Black or African American female"] <- "Black"

npsas3.1P$Gender[npsas3.1P$Group=="Hispanic or Latino male"] <- "Male"
npsas3.1P$Gender[npsas3.1P$Group=="Hispanic or Latino female"] <- "Female"
npsas3.1P$Group[npsas3.1P$Group=="Hispanic or Latino male"] <- "Latino/a"
npsas3.1P$Group[npsas3.1P$Group=="Hispanic or Latino female"] <- "Latino/a"

npsas3.1P$Gender[npsas3.1P$Group=="Asian male"] <- "Male"
npsas3.1P$Gender[npsas3.1P$Group=="Asian female"] <- "Female"
npsas3.1P$Group[npsas3.1P$Group=="Asian male"] <- "Asian"
npsas3.1P$Group[npsas3.1P$Group=="Asian female"] <- "Asian"

npsas3.1P$Gender[npsas3.1P$Group=="Pacific Islander/Hawaiian male"] <- "Male"
npsas3.1P$Gender[npsas3.1P$Group=="Pacific Islander/Hawaiian female"] <- "Female"
npsas3.1P$Group[npsas3.1P$Group=="Pacific Islander/Hawaiian male"] <- "Pacific Islander"
npsas3.1P$Group[npsas3.1P$Group=="Pacific Islander/Hawaiian female"] <- "Pacific Islander"

npsas3.1P$Gender[npsas3.1P$Group=="White male"] <- "Male"
npsas3.1P$Gender[npsas3.1P$Group=="White female"] <- "Female"
npsas3.1P$Group[npsas3.1P$Group=="White male"] <- "White"
npsas3.1P$Group[npsas3.1P$Group=="White female"] <- "White"

npsas3.1P$Gender[npsas3.1P$Group=="American Indian or Alaska Native male"] <- "Male"
npsas3.1P$Gender[npsas3.1P$Group=="American Indian or Alaska Native female"] <- "Female"
npsas3.1P$Group[npsas3.1P$Group=="American Indian or Alaska Native male"] <- "Native American"
npsas3.1P$Group[npsas3.1P$Group=="American Indian or Alaska Native female"] <- "Native American"

npsas3.1P$Gender[npsas3.1P$Group=="Male of more than one race"] <- "Male"
npsas3.1P$Gender[npsas3.1P$Group=="Female of more than one race"] <- "Female"
npsas3.1P$Group[npsas3.1P$Group=="Male of more than one race"] <- "2+ races"
npsas3.1P$Group[npsas3.1P$Group=="Female of more than one race"] <- "2+ races"

npsas3.1P$Gender[npsas3.1P$Group=="Male"] <- "Male"
npsas3.1P$Gender[npsas3.1P$Group=="Female"] <- "Female"
npsas3.1P$Group[npsas3.1P$Group=="Male"] <- "Overall"
npsas3.1P$Group[npsas3.1P$Group=="Female"] <- "Overall"

npsas3.1P <- npsas3.1P %>% filter(Group %in% c("Overall", "White",  "Latino/a", "Black", "Asian", "2+ races"))
npsas3.1P$Group <- as.factor(npsas3.1P$Group)
npsas3.1P$Group <- factor(npsas3.1P$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "2+ races"))
npsas3.1P$`Share Borrowing Loans` <- as.numeric(npsas3.1P$`Share Borrowing Loans`) / 100
```

```{r percentages.figure4B}
npsas3.1P <- npsas3.1P %>% filter(Group != "2+ races")

npsas3.1P$`For Tooltip` <- paste(
  "State: ", npsas3.1P$State, '\n',
  "Group: ", npsas3.1P$Group, '\n',
  "Gender: ", npsas3.1P$Gender, '\n',
  "Level: ", npsas3.1P$Level, '\n',
  "Share borrowing loans: ", percent(npsas3.1P$`Share Borrowing Loans`, accuracy=0.1),
  sep=""
)

g4BP <- ggplot(data=npsas3.1P, mapping=aes(x=Group, y=`Share Borrowing Loans`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Share borrowing graduate loans by program level, group and gender: U.S. only", y="Share Borrowing Loans") + facet_grid(Gender ~ Level) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) + scale_fill_manual(values = stateCols2) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g4BP, width=800, height=450, tooltip="text")
```
##### Data Source and Notes

**Data source:** National Postsecondary Student Aid Study, Graduate. Datalab interface available [here](https://nces.ed.gov/datalab/) using table retrieval numbers *ibxxlt* and *zlasyt* for "Figure 4: Race" and table retrieval numbers *gouiaq*, *hxgkel*, *iuyjsr*, *ajghcg* for "Figure 4: Race and Gender."

**Timeframe reflected:** Figures in this graph reflect students enrolled in the 2015-16 academic year. 

**Notes:** The averages here do not include those who did not borrow federal loans. These measures include all student loans, including federal student loans, private loans, state loans, and institutional loans. In contrast to other charts in this section, Figure 4 is not limited to in-state students, since it does not have California-only statistics. 

***

#### {-}

Black and Latino/a students in master's programs and professional doctorate programs, as well as those who identify with more than one race, borrow more frequently than do their white or Asian peers. There is less variation when it comes to their average annual loan amount.

At the professional doctorate level, gender does not appear to play a large role. However, it is clear that female master's students borrow more frequently than male master's students. Combining the trends by race and gender, we observe that Black women in master's programs borrow almost threefold more often than do white men in master's programs. (Again, recall that this reflects the U.S. overall and not California specifically.)

Figure 5 returns to the undergraduate level and considers how much debt undergraduate students earn by the time they are about to earn their bachelor's degree. Specifically, I filter for those who are listed as a "graduating senior from a bachelor's degree program in 2015-16." Due to data limitations in NPSAS, Figure 5 does not include Parent PLUS loans. 

#### {.tabset}
##### Figure 5: Average Undergraduate Loans at Graduation by Race
```{r npsas4, warning=FALSE}
npsas4.US <- read.csv("PowerStats rcefsb.csv", skip=12, nrow=7, header=FALSE)
npsas4.US.total <- read.csv("PowerStats rcefsb.csv", skip=10, nrow=1, header=FALSE)
npsas4.US <- rbind(npsas4.US.total, npsas4.US)

npsas4.CA <- read.csv("PowerStats rcefsb.csv", skip=73, nrow=7, header=FALSE)
npsas4.CA.total <- read.csv("PowerStats rcefsb.csv", skip=71, nrow=1, header=FALSE)
npsas4.CA <- rbind(npsas4.CA.total, npsas4.CA)

names(npsas4.US) <- c("Group", "Average cumulative loans")
names(npsas4.CA) <- c("Group", "Average cumulative loans")

npsas4.US$State <- rep("U.S.", nrow(npsas4.US))
npsas4.CA$State <- rep("CA", nrow(npsas4.CA))
npsas4 <- rbind(npsas4.US, npsas4.CA)

npsas4 <- npsas4 %>% filter(Group != "American Indian or Alaska Native")

npsas4$Group[npsas4$Group=="Black or African American"] <- "Black"
npsas4$Group[npsas4$Group=="More than one race"] <- "2+ races"
npsas4$Group[npsas4$Group=="Hispanic or Latino"] <- "Latino/a"
npsas4$Group[npsas4$Group=="Native Hawaiian/other Pacific Islander"] <- "Pacific Islander"
npsas4$Group[npsas4$Group=="Total"] <- "Overall"

npsas4$`Average cumulative loans` <- as.numeric(npsas4$`Average cumulative loans`)

npsas4$Group <- as.factor(npsas4$Group)
npsas4$Group <- factor(npsas4$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "Pacific Islander", "2+ races"))
```

```{r figure5A}
npsas4$`For Tooltip` <- paste(
  "State: ", npsas4$State, '\n',
  "Group: ", npsas4$Group, '\n',
  "Average cumulative loans: ", dollar(npsas4$`Average cumulative loans`, accuracy=1),
  sep=""
)

g5A <- ggplot(data=npsas4, mapping=aes(x=State, y=`Average cumulative loans`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + facet_grid(. ~ Group) + scale_y_continuous(label=scales::dollar) + labs(x="State", title="Graduating undergraduates' average cumulative loans by group", y="Average cumulative loans") + scale_fill_manual(values = stateCols) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g5A, width=800, height=350, tooltip="text")
```

```{r percentages.npsas4}
npsas4P.US <- read.csv("PowerStats admfpj.csv", skip=14, nrow=7, header=FALSE) %>% select(V1, V3)
npsas4P.US.total <- read.csv("PowerStats admfpj.csv", skip=12, nrow=1, header=FALSE) %>% select(V1, V3)
npsas4P.US <- rbind(npsas4P.US.total, npsas4P.US)

npsas4P.CA <- read.csv("PowerStats admfpj.csv", skip=78, nrow=7, header=FALSE) %>% select(V1, V3)
npsas4P.CA.total <- read.csv("PowerStats admfpj.csv", skip=76, nrow=1, header=FALSE) %>% select(V1, V3)
npsas4P.CA <- rbind(npsas4P.CA.total, npsas4P.CA)

names(npsas4P.US) <- c("Group", "Share with Cumulative Loans")
names(npsas4P.CA) <- c("Group", "Share with Cumulative Loans")

npsas4P.US$State <- rep("U.S.", nrow(npsas4P.US))
npsas4P.CA$State <- rep("CA", nrow(npsas4P.CA))
npsas4P <- rbind(npsas4P.US, npsas4P.CA)

npsas4P <- npsas4P %>% filter(Group != "American Indian or Alaska Native")

npsas4P$Group[npsas4P$Group=="Black or African American"] <- "Black"
npsas4P$Group[npsas4P$Group=="More than one race"] <- "2+ races"
npsas4P$Group[npsas4P$Group=="Hispanic or Latino"] <- "Latino/a"
npsas4P$Group[npsas4P$Group=="Native Hawaiian/other Pacific Islander"] <- "Pacific Islander"
npsas4P$Group[npsas4P$Group=="Total"] <- "Overall"

npsas4P$`Share with Cumulative Loans` <- as.numeric(npsas4P$`Share with Cumulative Loans`) / 100

npsas4P$Group <- as.factor(npsas4P$Group)
npsas4P$Group <- factor(npsas4P$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "Pacific Islander", "2+ races"))
```

```{r percentages.figure5A}
npsas4P$`For Tooltip` <- paste(
  "State: ", npsas4P$State, '\n',
  "Group: ", npsas4P$Group, '\n',
  "Share with cumulative loans: ", percent(npsas4P$`Share with Cumulative Loans`, accuracy=0.1),
  sep=""
)

g5AP <- ggplot(data=npsas4P, mapping=aes(x=State, y=`Share with Cumulative Loans`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + facet_grid(. ~ Group) + scale_y_continuous(label=scales::percent_format(accuracy=1)) + labs(x="State", title="Share of graduating undergraduates with cumulative loans by group", y="Share with Cumulative Loans") + scale_fill_manual(values = stateCols2) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g5AP, width=800, height=350, tooltip="text")
```
##### Figure 5: Average Undergraduate Loans at Graduation by Race and Gender
```{r npsas4.1, warning=FALSE}
npsas4.1.US <- read.csv("PowerStats eggovn.csv", skip=12, nrow=14, header=FALSE)
npsas4.1.US.total <- read.csv("PowerStats gnvptv.csv", skip=12, nrow=2, header=FALSE)
npsas4.1.US <- rbind(npsas4.1.US.total, npsas4.1.US)

npsas4.1.CA <- read.csv("PowerStats eggovn.csv", skip=108, nrow=14, header=FALSE)
npsas4.1.CA.total <- read.csv("PowerStats gnvptv.csv", skip=48, nrow=2, header=FALSE)
npsas4.1.CA <- rbind(npsas4.1.CA.total, npsas4.1.CA)

names(npsas4.1.US) <- c("Group", "Average cumulative loans")
names(npsas4.1.CA) <- c("Group", "Average cumulative loans")
npsas4.1.US$State <- rep("U.S.", nrow(npsas4.1.US))
npsas4.1.CA$State <- rep("CA", nrow(npsas4.1.CA))

npsas4.1 <- rbind(npsas4.1.US, npsas4.1.CA)
npsas4.1$Gender <- rep(NA, nrow(npsas4.1))

npsas4.1$Gender[npsas4.1$Group=="Black or African American male"] <- "Male"
npsas4.1$Gender[npsas4.1$Group=="Black or African American female"] <- "Female"
npsas4.1$Group[npsas4.1$Group=="Black or African American male"] <- "Black"
npsas4.1$Group[npsas4.1$Group=="Black or African American female"] <- "Black"

npsas4.1$Gender[npsas4.1$Group=="Hispanic or Latino male"] <- "Male"
npsas4.1$Gender[npsas4.1$Group=="Hispanic or Latino female"] <- "Female"
npsas4.1$Group[npsas4.1$Group=="Hispanic or Latino male"] <- "Latino/a"
npsas4.1$Group[npsas4.1$Group=="Hispanic or Latino female"] <- "Latino/a"

npsas4.1$Gender[npsas4.1$Group=="Asian male"] <- "Male"
npsas4.1$Gender[npsas4.1$Group=="Asian female"] <- "Female"
npsas4.1$Group[npsas4.1$Group=="Asian male"] <- "Asian"
npsas4.1$Group[npsas4.1$Group=="Asian female"] <- "Asian"

npsas4.1$Gender[npsas4.1$Group=="Pacific Islander/Hawaiian male"] <- "Male"
npsas4.1$Gender[npsas4.1$Group=="Pacific Islander/Hawaiian female"] <- "Female"
npsas4.1$Group[npsas4.1$Group=="Pacific Islander/Hawaiian male"] <- "Pacific Islander"
npsas4.1$Group[npsas4.1$Group=="Pacific Islander/Hawaiian female"] <- "Pacific Islander"

npsas4.1$Gender[npsas4.1$Group=="White male"] <- "Male"
npsas4.1$Gender[npsas4.1$Group=="White female"] <- "Female"
npsas4.1$Group[npsas4.1$Group=="White male"] <- "White"
npsas4.1$Group[npsas4.1$Group=="White female"] <- "White"

npsas4.1$Gender[npsas4.1$Group=="American Indian or Alaska Native male"] <- "Male"
npsas4.1$Gender[npsas4.1$Group=="American Indian or Alaska Native female"] <- "Female"
npsas4.1$Group[npsas4.1$Group=="American Indian or Alaska Native male"] <- "Native American"
npsas4.1$Group[npsas4.1$Group=="American Indian or Alaska Native female"] <- "Native American"

npsas4.1$Gender[npsas4.1$Group=="Male of more than one race"] <- "Male"
npsas4.1$Gender[npsas4.1$Group=="Female of more than one race"] <- "Female"
npsas4.1$Group[npsas4.1$Group=="Male of more than one race"] <- "2+ races"
npsas4.1$Group[npsas4.1$Group=="Female of more than one race"] <- "2+ races"

npsas4.1$Gender[npsas4.1$Group=="Male"] <- "Male"
npsas4.1$Gender[npsas4.1$Group=="Female"] <- "Female"
npsas4.1$Group[npsas4.1$Group=="Male"] <- "Overall"
npsas4.1$Group[npsas4.1$Group=="Female"] <- "Overall"

npsas4.1 <- npsas4.1 %>% filter(Group %in% c("Native American", "Pacific Islander")==FALSE)

npsas4.1$Group <- as.factor(npsas4.1$Group)
npsas4.1$Group <- factor(npsas4.1$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "2+ races"))

npsas4.1$Gender <- as.factor(npsas4.1$Gender)
npsas4.1$Gender <- factor(npsas4.1$Gender, levels=c("Male", "Female"))
npsas4.1$`Average cumulative loans` <- as.numeric(npsas4.1$`Average cumulative loans`)
```

```{r figure5B}
npsas4.1$`For Tooltip` <- paste(
  "State: ", npsas4.1$State, '\n',
  "Group: ", npsas4.1$Group, '\n',
  "Gender: ", npsas4.1$Gender, '\n',
  "Average cumulative loans: ", dollar(npsas4.1$`Average cumulative loans`, accuracy=1),
  sep=""
)

g5B <- ggplot(data=npsas4.1, mapping=aes(x=State, y=`Average cumulative loans`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + facet_grid(Gender ~ Group) + scale_y_continuous(label=scales::dollar) + labs(title="Graduating undergraduates' average cumulative loans by group and gender", y="Average Cumulative Loans") + scale_fill_manual(values = flagCols) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g5B, width=800, height=350, tooltip="text")
```

```{r percentages.npsas4.1}
npsas4.1P.US <- read.csv("PowerStats pnfkhv.csv", skip=14, nrow=14, header=FALSE) %>% select(V1, V3)
npsas4.1P.US.total <- read.csv("PowerStats elhvny.csv", skip=14, nrow=2, header=FALSE) %>% select(V1, V3)
npsas4.1P.US <- rbind(npsas4.1P.US.total, npsas4.1P.US)

npsas4.1P.CA <- read.csv("PowerStats pnfkhv.csv", skip=113, nrow=14, header=FALSE) %>% select(V1, V3)
npsas4.1P.CA.total <- read.csv("PowerStats elhvny.csv", skip=53, nrow=2, header=FALSE) %>% select(V1, V3)
npsas4.1P.CA <- rbind(npsas4.1P.CA.total, npsas4.1P.CA)

names(npsas4.1P.US) <- c("Group", "Share with Cumulative Loans")
names(npsas4.1P.CA) <- c("Group", "Share with Cumulative Loans")
npsas4.1P.US$State <- rep("U.S.", nrow(npsas4.1P.US))
npsas4.1P.CA$State <- rep("CA", nrow(npsas4.1P.CA))

npsas4.1P <- rbind(npsas4.1P.US, npsas4.1P.CA)
npsas4.1P$Gender <- rep(NA, nrow(npsas4.1P))

npsas4.1P$Gender[npsas4.1P$Group=="Black or African American male"] <- "Male"
npsas4.1P$Gender[npsas4.1P$Group=="Black or African American female"] <- "Female"
npsas4.1P$Group[npsas4.1P$Group=="Black or African American male"] <- "Black"
npsas4.1P$Group[npsas4.1P$Group=="Black or African American female"] <- "Black"

npsas4.1P$Gender[npsas4.1P$Group=="Hispanic or Latino male"] <- "Male"
npsas4.1P$Gender[npsas4.1P$Group=="Hispanic or Latino female"] <- "Female"
npsas4.1P$Group[npsas4.1P$Group=="Hispanic or Latino male"] <- "Latino/a"
npsas4.1P$Group[npsas4.1P$Group=="Hispanic or Latino female"] <- "Latino/a"

npsas4.1P$Gender[npsas4.1P$Group=="Asian male"] <- "Male"
npsas4.1P$Gender[npsas4.1P$Group=="Asian female"] <- "Female"
npsas4.1P$Group[npsas4.1P$Group=="Asian male"] <- "Asian"
npsas4.1P$Group[npsas4.1P$Group=="Asian female"] <- "Asian"

npsas4.1P$Gender[npsas4.1P$Group=="Pacific Islander/Hawaiian male"] <- "Male"
npsas4.1P$Gender[npsas4.1P$Group=="Pacific Islander/Hawaiian female"] <- "Female"
npsas4.1P$Group[npsas4.1P$Group=="Pacific Islander/Hawaiian male"] <- "Pacific Islander"
npsas4.1P$Group[npsas4.1P$Group=="Pacific Islander/Hawaiian female"] <- "Pacific Islander"

npsas4.1P$Gender[npsas4.1P$Group=="White male"] <- "Male"
npsas4.1P$Gender[npsas4.1P$Group=="White female"] <- "Female"
npsas4.1P$Group[npsas4.1P$Group=="White male"] <- "White"
npsas4.1P$Group[npsas4.1P$Group=="White female"] <- "White"

npsas4.1P$Gender[npsas4.1P$Group=="American Indian or Alaska Native male"] <- "Male"
npsas4.1P$Gender[npsas4.1P$Group=="American Indian or Alaska Native female"] <- "Female"
npsas4.1P$Group[npsas4.1P$Group=="American Indian or Alaska Native male"] <- "Native American"
npsas4.1P$Group[npsas4.1P$Group=="American Indian or Alaska Native female"] <- "Native American"

npsas4.1P$Gender[npsas4.1P$Group=="Male of more than one race"] <- "Male"
npsas4.1P$Gender[npsas4.1P$Group=="Female of more than one race"] <- "Female"
npsas4.1P$Group[npsas4.1P$Group=="Male of more than one race"] <- "2+ races"
npsas4.1P$Group[npsas4.1P$Group=="Female of more than one race"] <- "2+ races"

npsas4.1P$Gender[npsas4.1P$Group=="Male"] <- "Male"
npsas4.1P$Gender[npsas4.1P$Group=="Female"] <- "Female"
npsas4.1P$Group[npsas4.1P$Group=="Male"] <- "Overall"
npsas4.1P$Group[npsas4.1P$Group=="Female"] <- "Overall"

npsas4.1P <- npsas4.1P %>% filter(Group %in% c("Native American", "Pacific Islander")==FALSE)
npsas4.1P$Group <- as.factor(npsas4.1P$Group)
npsas4.1P$Group <- factor(npsas4.1P$Group, levels = c("Overall", "White", "Latino/a", "Black", "Asian", "2+ races"))

npsas4.1P$Gender <- as.factor(npsas4.1P$Gender)
npsas4.1P$Gender <- factor(npsas4.1P$Gender, levels=c("Male", "Female"))
npsas4.1P$`Share with Cumulative Loans` <- as.numeric(npsas4.1P$`Share with Cumulative Loans`) / 100
```

```{r percentages.figure5B}
npsas4.1P$`For Tooltip` <- paste(
  "State: ", npsas4.1P$State, '\n',
  "Group: ", npsas4.1P$Group, '\n',
  "Gender: ", npsas4.1P$Gender, '\n',
  "Share with cumulative loans: ", percent(npsas4.1P$`Share with Cumulative Loans`, accuracy=0.1),
  sep=""
)

g5BP <- ggplot(data=npsas4.1P, mapping=aes(x=State, y=`Share with Cumulative Loans`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + facet_grid(Gender ~ Group) + scale_y_continuous(label=scales::percent_format(accuracy=1)) + labs(title="Share of graduating undergraduates with cumulative loans by group and gender", y="Share with Cumulative Loans") + scale_fill_manual(values = flagCols2) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g5BP, width=800, height=350, tooltip="text")
```
##### Data Source and Notes

**Data source:** National Postsecondary Student Aid Study, Undergraduate. Datalab interface available [here](https://nces.ed.gov/datalab/) using table retrieval numbers *rcefsb* and *admfpj* for "Figure 5: Race" and table retrieval number *eggovn*, *gnvptv*, *pnfkhv*, and *elhvny* for "Figure 5: Race and Gender (U.S. only)".

**Timeframe reflected:** Figures in this graph reflect students enrolled in the 2015-16 academic year. 

**Notes:** Due to limitations of NPSAS:16, the data in Figure 5 only apply to in-state students. The averages here do not include those with no cumulative loans. These measures include all student loans, including federal student loans (but not including Parent PLUS), private loans, state loans, and institutional loans. 

***

#### {-}

Here, California students fare the same or better than students nationwide, in terms of the share who borrow and the cumulative loans of those who do. However, equity concerns cut across both California and the nation overall. 

Nearly 85 percent of Black California undergraduates borrow student loans by graduation, which exceeds most other groups in the state by a concerning margin. (An estimated 80 percent of California Pacific Islander students borrow.) Notably, all groups are above 50 percent in California as in the U.S. overall. 

The trend of pronounced borrowing among women, and especially Black women, extends here as well. Roughly 95 percent of Black California undergraduate women borrow by the time they graduate, on par with the national rate but well above all other groups. 

NPSAS allows us to disaggregate by ethnicity (to a limited extent) for two racial groups, Hispanic and Asian. No individual Asian ethnic group stands out from the rest along these measures, although Indian, Korean, Filipino, and Mixed Asian California undergraduates all average more in annual loans than other groups and exceed the corresponding national averages. Fewer distinct groups are available in the Hispanic variable; California's Puerto Rican undergraduates show the highest average loans among those who borrow. 

#### {.tabset}
```{r npsas5}
npsas5.US.ASN <- read.csv("PowerStats famipl.csv", skip=12, nrow=9, header=FALSE)
npsas5.US.HSP <- read.csv("PowerStats famipl.csv", skip=23, nrow=6, header=FALSE)

npsas5.CA.ASN <- read.csv("PowerStats famipl.csv", skip=123, nrow=9, header=FALSE)
npsas5.CA.HSP <- read.csv("PowerStats famipl.csv", skip=134, nrow=6, header=FALSE)

names(npsas5.US.HSP) <- c("Group", "Total loans")
names(npsas5.US.ASN) <- c("Group", "Total loans")
names(npsas5.CA.HSP) <- c("Group", "Total loans")
names(npsas5.CA.ASN) <- c("Group", "Total loans")

npsas5.US.HSP$Race <- rep("Hispanic", nrow(npsas5.US.HSP))
npsas5.US.ASN$Race <- rep("Asian", nrow(npsas5.US.ASN))
npsas5.CA.HSP$Race <- rep("Hispanic", nrow(npsas5.CA.HSP))
npsas5.CA.ASN$Race <- rep("Asian", nrow(npsas5.CA.ASN))

npsas5.US.HSP$State <- rep("U.S.", nrow(npsas5.US.HSP))
npsas5.US.ASN$State <- rep("U.S.", nrow(npsas5.US.ASN))
npsas5.CA.HSP$State <- rep("CA", nrow(npsas5.CA.HSP))
npsas5.CA.ASN$State <- rep("CA", nrow(npsas5.CA.ASN))

npsas5 <- rbind(npsas5.US.HSP, 
                npsas5.US.ASN, 
                npsas5.CA.HSP, 
                npsas5.CA.ASN)

npsas5$`Total federal loans` <- as.numeric(npsas5$`Total loans`)

npsas5.ASN <- npsas5 %>% filter(Race=="Asian") %>% filter(Group != "Not of Asian origin")
npsas5.HSP <- npsas5 %>% filter(Race=="Hispanic") %>% filter(Group != "Not Hispanic or Latino origin")

npsas5.ASN$Group[npsas5.ASN$Group=="Asian Indian"] <- "Indian"
npsas5.ASN$Group[npsas5.ASN$Group=="Other Asian origin"] <- "Other Asian"
npsas5.ASN$Group[npsas5.ASN$Group=="Mixed Asian origin"] <- "Mixed Asian"

npsas5.HSP$Group[npsas5.HSP$Group=="Mexican, Mexican-American, or Chicano descent"] <- "Mexican/Chicano"
npsas5.HSP$Group[npsas5.HSP$Group=="Other Spanish, Hispanic, or Latino descent"] <- "Other Hispanic descent"

npsas5.HSP$Group <- as.factor(npsas5.HSP$Group)
npsas5.HSP$Group <- factor(npsas5.HSP$Group, levels=c(
  "Mexican/Chicano", 
  "Cuban descent", 
  "Puerto Rican descent",
  "Other Hispanic descent", 
  "Mixed Hispanic origin"
))

npsas5.ASN$Group <- as.factor(npsas5.ASN$Group)
npsas5.ASN$Group <- factor(npsas5.ASN$Group, levels=c(
  "Chinese", 
  "Indian", 
  "Japanese", 
  "Korean", 
  "Filipino", 
  "Vietnamese", 
  "Other Asian", 
  "Mixed Asian"
))
```

```{r percentages.npsas5}
npsas5P.US.ASN <- read.csv("PowerStats dzalav.csv", skip=14, nrow=9, header=FALSE) %>% select(V1, V3)
npsas5P.US.HSP <- read.csv("PowerStats dzalav.csv", skip=25, nrow=6, header=FALSE) %>% select(V1, V3)

npsas5P.CA.ASN <- read.csv("PowerStats dzalav.csv", skip=128, nrow=9, header=FALSE) %>% select(V1, V3)
npsas5P.CA.HSP <- read.csv("PowerStats dzalav.csv", skip=139, nrow=6, header=FALSE) %>% select(V1, V3)

names(npsas5P.US.HSP) <- c("Group", "Share Borrowing Loans")
names(npsas5P.US.ASN) <- c("Group", "Share Borrowing Loans")
names(npsas5P.CA.HSP) <- c("Group", "Share Borrowing Loans")
names(npsas5P.CA.ASN) <- c("Group", "Share Borrowing Loans")

npsas5P.US.HSP$Race <- rep("Hispanic", nrow(npsas5P.US.HSP))
npsas5P.US.ASN$Race <- rep("Asian", nrow(npsas5P.US.ASN))
npsas5P.CA.HSP$Race <- rep("Hispanic", nrow(npsas5P.CA.HSP))
npsas5P.CA.ASN$Race <- rep("Asian", nrow(npsas5P.CA.ASN))

npsas5P.US.HSP$State <- rep("U.S.", nrow(npsas5P.US.HSP))
npsas5P.US.ASN$State <- rep("U.S.", nrow(npsas5P.US.ASN))
npsas5P.CA.HSP$State <- rep("CA", nrow(npsas5P.CA.HSP))
npsas5P.CA.ASN$State <- rep("CA", nrow(npsas5P.CA.ASN))

npsas5P <- rbind(npsas5P.US.HSP, 
                npsas5P.US.ASN, 
                npsas5P.CA.HSP, 
                npsas5P.CA.ASN)

npsas5P$`Share Borrowing Loans` <- as.numeric(npsas5P$`Share Borrowing Loans`) / 100

npsas5P.ASN <- npsas5P %>% filter(Race=="Asian") %>% filter(Group != "Not of Asian origin")
npsas5P.HSP <- npsas5P %>% filter(Race=="Hispanic") %>% filter(Group != "Not Hispanic or Latino origin")

npsas5P.ASN$Group[npsas5P.ASN$Group=="Asian Indian"] <- "Indian"
npsas5P.ASN$Group[npsas5P.ASN$Group=="Other Asian origin"] <- "Other Asian"
npsas5P.ASN$Group[npsas5P.ASN$Group=="Mixed Asian origin"] <- "Mixed Asian"

npsas5P.HSP$Group[npsas5P.HSP$Group=="Mexican, Mexican-American, or Chicano descent"] <- "Mexican/Chicano"
npsas5P.HSP$Group[npsas5P.HSP$Group=="Other Spanish, Hispanic, or Latino descent"] <- "Other Hispanic descent"

npsas5P.HSP$Group <- as.factor(npsas5P.HSP$Group)
npsas5P.HSP$Group <- factor(npsas5P.HSP$Group, levels=c(
  "Mexican/Chicano", 
  "Cuban descent", 
  "Puerto Rican descent",
  "Other Hispanic descent", 
  "Mixed Hispanic origin"
))

npsas5P.ASN$Group <- as.factor(npsas5P.ASN$Group)
npsas5P.ASN$Group <- factor(npsas5P.ASN$Group, levels=c(
  "Chinese", 
  "Indian", 
  "Japanese", 
  "Korean", 
  "Filipino", 
  "Vietnamese", 
  "Other Asian", 
  "Mixed Asian"
))
```
##### Figure 6: Average Undergraduate Loans by Asian Ethnicity
```{r figure6A}
npsas5.ASN$`For Tooltip` <- paste(
  "State: ", npsas5.ASN$State, '\n',
  "Group: ", npsas5.ASN$Group, '\n',
  "Average annual loans: ", dollar(npsas5.ASN$`Total loans`, accuracy=1), 
  sep=""
)

g6A <- ggplot(data=npsas5.ASN, mapping=aes(x=State, y=`Total loans`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average annual undergraduate loans by Asian ethinicity: U.S. vs CA", y="Average Loans") + facet_grid(. ~ Group) +  scale_y_continuous(labels=scales::dollar_format()) + scale_fill_manual(values=stateCols) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g6A, width=800, height=350, tooltip="text")
```

```{r percentages.figure6A}
npsas5P.ASN$`For Tooltip` <- paste(
  "State: ", npsas5P.ASN$State, '\n',
  "Group: ", npsas5P.ASN$Group, '\n',
  "Share borrowing loans: ", percent(npsas5P.ASN$`Share Borrowing Loans`, accuracy=0.1), 
  sep=""
)

g6AP <- ggplot(data=npsas5P.ASN, mapping=aes(x=State, y=`Share Borrowing Loans`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Share borrowing undergraduate loans by Asian ethinicity: U.S. vs CA", y="Share Borrowing Loans") + facet_grid(. ~ Group) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) + scale_fill_manual(values=stateCols2) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g6AP, width=800, height=350, tooltip="text")
```
##### Figure 6: Average Undergraduate Loans by Hispanic Ethnicity
```{r figure6B}
npsas5.HSP$`For Tooltip` <- paste(
  "State: ", npsas5.HSP$State, '\n',
  "Group: ", npsas5.HSP$Group, '\n',
  "Average annual loans: ", dollar(npsas5.HSP$`Total loans`, accuracy=1), 
  sep=""
)

g6B <- ggplot(data=npsas5.HSP, mapping=aes(x=State, y=`Total loans`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average annual undergraduate loans by Hispanic ethinicity: U.S. vs CA", y="Average Loans") + facet_grid(. ~ Group) +  scale_y_continuous(labels=scales::dollar_format()) + scale_fill_manual(values=stateCols) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g6B, width=800, height=350, tooltip="text")
```

```{r percentages.figure6B}
npsas5P.HSP$`For Tooltip` <- paste(
  "State: ", npsas5P.HSP$State, '\n',
  "Group: ", npsas5P.HSP$Group, '\n',
  "Share borrowing loans: ", percent(npsas5P.HSP$`Share Borrowing Loans`, accuracy=0.1), 
  sep=""
)

g6BP <- ggplot(data=npsas5P.HSP, mapping=aes(x=State, y=`Share Borrowing Loans`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Share borrowing undergraduate loans by Hispanic ethinicity: U.S. vs CA", y="Share Borrowing Loans") + facet_grid(. ~ Group) +  scale_y_continuous(labels=scales::percent_format(accuracy=1)) + scale_fill_manual(values=stateCols2) + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g6BP, width=800, height=350, tooltip="text")
```
##### Data Source and Notes

**Data source:** National Postsecondary Student Aid Study, Undergraduate. Datalab interface available [here](https://nces.ed.gov/datalab/) using table retrieval numbers *famipl* and *dzalav*.

**Timeframe reflected:** Figures in this graph reflect students enrolled in the 2015-16 academic year. 

**Notes:** No other racial groups besides Hispanic and Asian have breakouts by ethnicity in NPSAS. Due to limitations of NPSAS:16, the data in Figure 6 only apply to in-state students. The averages here do not include those who did not borrow any loans. These measures include all student loans, including federal student loans (including Parent PLUS), private loans, state loans, and institutional loans. 

***

#### {-}

## Survey of Household Economics and Decisionmaking 

#### About the data

The Survey of Household Economics and Decisionmaking (SHED) is a survey of U.S. households conducted annually by the U.S. Federal Reserve. It asks a battery of questions about income and earnings, savings and financial well-being, and education, including student loans. The respondents are the heads of households and the weights can be used to create estimates of the U.S. adult population. 

The public SHED data files contain information from about 12,000 respondents every year, many of whom are in California and many of whom have student loans. For the analyses in this section, I pooled SHED data from each of the survey years between 2015 and 2021. The result has a sufficient sample for us to examine California student loan borrowers and breakdowns by race. All numeric responses, such as total student loan debt or total savings, are grouped into categories; therefore, I could not make any adjustments to account for inflation. 

Adding more and more filters to the sample reduces the confidence in our estimates. As much as it would be good to know how California student loan borrowers working in the nursing field compared to other California student loan borrowers, the resulting sample size would simply be too small for us to put stock in the results. This is why the charts in this section disaggregate by race and by state of residence but generally do not cut the data further than that. 

Some survey questions were not asked every year between 2015 and 2021, and as a result, some subgroups included here have very small samples. I include in the "Data Source and Notes" tab for every figure in this section the number of respondents whose data lead to the statistics shown, broken down by group. 

Please note when interpreting this data that SHED does not distinguish between federal student loans and private student loans. 

I selected the variables that seemed most likely to help tell the story of how student loan borrowers in California are faring. If you would like to see analysis on variables I did not include, please email me. More information about the SHED data can be found [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).  

#### Findings

```{r shedSetup1}
shed21 <- fread("SHED-2021.csv", header=TRUE, select=c("CaseID", "weight_pop", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "ppfs1482", "iclevel", "control", "L0_b"))

shed20 <- fread("SHED-2020.csv", header=TRUE, select=c("CaseID", "weight_pop", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "ppfs1482", "iclevel", "control", "L0_b"))

shed19 <- fread("SHED-2019.csv", header=TRUE, select=c("CaseID", "weight_pop", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "FS20_b", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "ppfs1482", "iclevel", "control", "L0_b"))

shed18 <- fread("SHED-2018.csv", header=TRUE, select=c("CaseID", "weight2b", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5",  "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d",  "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "FS20_b", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "iclevel", "control", "L0_b"))

shed17 <- fread("SHED-2017.csv", header=TRUE, select=c("CaseID", "weight3b", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "FS20_b", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "control", "L0_b"))

shed16 <- fread("SHED-2016.csv", header=TRUE, select=c("CaseID", "weight3b", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3_TOTAL",  "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1_i", "I0_e", "I4A", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "ppcm0160", "ppfs0596", "C1", "L0_b"))

shed15 <- fread("SHED-2015.csv", header=TRUE, select=c("CaseID", "weight3b", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C4A", "ED0", "ED5", "ED6A_a", "ED6A_b", "ED6A_c", "ED6A_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3_TOTAL", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "D2", "I0_e", "I4A", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "ppcm0160", "ppfs0596", "C1", "sector", "control", "D0_b"))

shed21$Weight <- shed21$weight_pop
shed20$Weight <- shed20$weight_pop
shed19$Weight <- shed19$weight_pop
shed18$Weight <- shed18$weight2b
shed17$Weight <- shed17$weight3b
shed16$Weight <- shed16$weight3b
shed15$Weight <- shed15$weight3b

shed21$State <- shed21$ppstaten
shed20$State <- shed20$ppstaten
shed19$State <- shed19$ppstaten
shed18$State <- shed18$ppstaten
shed17$State <- shed17$ppstaten
shed16$State <- shed16$ppstaten
shed15$State <- shed15$ppstaten

shed21$Race <- shed21$ppethm
shed20$Race <- shed20$ppethm
shed19$Race <- shed19$ppethm
shed18$Race <- shed18$ppethm
shed17$Race <- shed17$ppethm
shed16$Race <- shed16$ppethm
shed15$Race <- shed15$ppethm

shed21$Gender <- shed21$ppgender
shed20$Gender <- shed20$ppgender
shed19$Gender <- shed19$ppgender
shed18$Gender <- shed18$ppgender
shed17$Gender <- shed17$ppgender
shed16$Gender <- shed16$ppgender
shed15$Gender <- shed15$ppgender

shed21$FinManage <- shed21$B2
shed20$FinManage <- shed20$B2
shed19$FinManage <- shed19$B2
shed18$FinManage <- shed18$B2
shed17$FinManage <- shed17$B2
shed16$FinManage <- shed16$B2
shed15$FinManage <- shed15$B2

shed21$ParComp <- shed21$B6
shed20$ParComp <- shed20$B6
shed19$ParComp <- shed19$B6
shed18$ParComp <- shed18$B6
shed17$ParComp <- shed17$B6
shed16$ParComp <- shed16$B6
shed15$ParComp <- shed15$B6

shed21$HomeOwn <- shed21$GH1
shed20$HomeOwn <- shed20$GH1
shed19$HomeOwn <- shed19$GH1
shed18$HomeOwn <- shed18$GH1
shed17$HomeOwn <- shed17$GH1
shed16$HomeOwn <- shed16$GH1
shed15$HomeOwn <- shed15$GH1

shed21$CCApprov <- shed21$A6
shed20$CCApprov <- shed20$A6
shed19$CCApprov <- shed19$A6
shed18$CCApprov <- shed18$A6
shed17$CCApprov <- shed17$A6
shed16$CCApprov <- shed16$A6
shed15$CCApprov <- shed15$A6

shed21$CreditDeny <- shed21$A1_a
shed20$CreditDeny <- shed20$A1_a
shed19$CreditDeny <- shed19$A1_a
shed18$CreditDeny <- shed18$A1_a
shed17$CreditDeny <- shed17$A1_a
shed16$CreditDeny <- shed16$A1_a
shed15$CreditDeny <- shed15$A1_a

shed21$UnpaidCC <- shed21$C3
shed20$UnpaidCC <- shed20$C3
shed19$UnpaidCC <- shed19$C3
shed18$UnpaidCC <- shed18$C3
shed17$UnpaidCC <- shed17$C3
shed16$UnpaidCC <- shed16$C3
shed15$UnpaidCC <- rep(NA, nrow(shed15))

shed21$CCBalance <- shed21$C4A
shed20$CCBalance <- shed20$C4A
shed19$CCBalance <- shed19$C4A
shed18$CCBalance <- shed18$C4A
shed17$CCBalance <- shed17$C4A
shed16$CCBalance <- shed16$C4A
shed15$CCBalance <- shed15$C4A

shed21$EdAttain <- shed21$ED0
shed20$EdAttain <- shed20$ED0
shed19$EdAttain <- shed19$ED0
shed18$EdAttain <- shed18$ED0
shed17$EdAttain <- shed17$ED0
shed16$EdAttain <- shed16$ED0
shed15$EdAttain <- shed15$ED0

shed21$EdPayoff1 <- shed21$ED5
shed20$EdPayoff1 <- shed20$ED5
shed19$EdPayoff1 <- shed19$ED5
shed18$EdPayoff1 <- shed18$ED5
shed17$EdPayoff1 <- shed17$ED5
shed16$EdPayoff1 <- shed16$ED5
shed15$EdPayoff1 <- shed15$ED5

shed21$DiffField1 <- shed21$ED6_a
shed20$DiffField1 <- shed20$ED6_a
shed19$DiffField1 <- shed19$ED6_a
shed18$DiffField1 <- shed18$ED6_a
shed17$DiffField1 <- shed17$ED6_a
shed16$DiffField1 <- shed16$ED6_a
shed15$DiffField1 <- shed15$ED6A_a

shed21$DiffSchool1 <- shed21$ED6_b
shed20$DiffSchool1 <- shed20$ED6_b
shed19$DiffSchool1 <- shed19$ED6_b
shed18$DiffSchool1 <- shed18$ED6_b
shed17$DiffSchool1 <- shed17$ED6_b
shed16$DiffSchool1 <- shed16$ED6_b
shed15$DiffSchool1 <- shed15$ED6A_b

shed21$LessEd1 <- shed21$ED6_c
shed20$LessEd1 <- shed20$ED6_c
shed19$LessEd1 <- shed19$ED6_c
shed18$LessEd1 <- shed18$ED6_c
shed17$LessEd1 <- shed17$ED6_c
shed16$LessEd1 <- shed16$ED6_c
shed15$LessEd1 <- shed15$ED6A_c

shed21$MoreEd1 <- shed21$ED6_d
shed20$MoreEd1 <- shed20$ED6_d
shed19$MoreEd1 <- shed19$ED6_d
shed18$MoreEd1 <- shed18$ED6_d
shed17$MoreEd1 <- shed17$ED6_d
shed16$MoreEd1 <- shed16$ED6_d
shed15$MoreEd1 <- shed15$ED6A_d

shed21$OwnDebt <- shed21$SL1
shed20$OwnDebt <- shed20$SL1
shed19$OwnDebt <- shed19$SL1
shed18$OwnDebt <- shed18$SL1
shed17$OwnDebt <- shed17$SL1
shed16$OwnDebt <- shed16$SL1
shed15$OwnDebt <- shed15$SL1

shed21$OwnDebtSL <- shed21$SL2_a
shed20$OwnDebtSL <- shed20$SL2_a
shed19$OwnDebtSL <- shed19$SL2_a
shed18$OwnDebtSL <- shed18$SL2_a
shed17$OwnDebtSL <- shed17$SL2_a
shed16$OwnDebtSL <- shed16$SL2_a
shed15$OwnDebtSL <- shed15$SL2_a

shed21$OwnDebtHE <- shed21$SL2_b
shed20$OwnDebtHE <- shed20$SL2_b
shed19$OwnDebtHE <- shed19$SL2_b
shed18$OwnDebtHE <- shed18$SL2_b
shed17$OwnDebtHE <- shed17$SL2_b
shed16$OwnDebtHE <- shed16$SL2_b
shed15$OwnDebtHE <- shed15$SL2_b

shed21$OwnDebtCC <- shed21$SL2_c
shed20$OwnDebtCC <- shed20$SL2_c
shed19$OwnDebtCC <- shed19$SL2_c
shed18$OwnDebtCC <- shed18$SL2_c
shed17$OwnDebtCC <- shed17$SL2_c
shed16$OwnDebtCC <- shed16$SL2_c
shed15$OwnDebtCC <- shed15$SL2_c

shed21$OwnDebtOther <- shed21$SL2_d
shed20$OwnDebtOther <- shed20$SL2_d
shed19$OwnDebtOther <- shed19$SL2_d
shed18$OwnDebtOther <- shed18$SL2_d
shed17$OwnDebtOther <- shed17$SL2_d
shed16$OwnDebtOther <- shed16$SL2_d
shed15$OwnDebtOther <- shed15$SL2_d

shed21$OwnDebtTot <- shed21$SL3
shed20$OwnDebtTot <- shed20$SL3
shed19$OwnDebtTot <- shed19$SL3
shed18$OwnDebtTot <- shed18$SL3
shed17$OwnDebtTot <- shed17$SL3
shed16$OwnDebtTot <- shed16$SL3_TOTAL
shed15$OwnDebtTot <- shed15$SL3_TOTAL

shed21$OwnDebtMon <- shed21$SL4
shed20$OwnDebtMon <- shed20$SL4
shed19$OwnDebtMon <- shed19$SL4
shed18$OwnDebtMon <- shed18$SL4
shed17$OwnDebtMon <- shed17$SL4
shed16$OwnDebtMon <- shed16$SL4
shed15$OwnDebtMon <- shed15$SL4

shed21$OwnDebtBehind <- shed21$SL6
shed20$OwnDebtBehind <- shed20$SL6
shed19$OwnDebtBehind <- shed19$SL6
shed18$OwnDebtBehind <- shed18$SL6
shed17$OwnDebtBehind <- shed17$SL6
shed16$OwnDebtBehind <- shed16$SL6
shed15$OwnDebtBehind <- shed15$SL6

shed21$OwnRepaid <- shed21$SL7
shed20$OwnRepaid <- shed20$SL7
shed19$OwnRepaid <- shed19$SL7
shed18$OwnRepaid <- shed18$SL7
shed17$OwnRepaid <- shed17$SL7
shed16$OwnRepaid <- shed16$SL7
shed15$OwnRepaid <- shed15$SL7

shed21$OwnCert <- shed21$SL8_a
shed20$OwnCert <- shed20$SL8_a
shed19$OwnCert <- shed19$SL8_a
shed18$OwnCert <- shed18$SL8_a
shed17$OwnCert <- shed17$SL8_a
shed16$OwnCert <- shed16$SL8_a
shed15$OwnCert <- shed15$SL8_a

shed21$OwnAssoc <- shed21$SL8_b
shed20$OwnAssoc <- shed20$SL8_b
shed19$OwnAssoc <- shed19$SL8_b
shed18$OwnAssoc <- shed18$SL8_b
shed17$OwnAssoc <- shed17$SL8_b
shed16$OwnAssoc <- shed16$SL8_b
shed15$OwnAssoc <- shed15$SL8_b

shed21$OwnBach <- shed21$SL8_c
shed20$OwnBach <- shed20$SL8_c
shed19$OwnBach <- shed19$SL8_c
shed18$OwnBach <- shed18$SL8_c
shed17$OwnBach <- shed17$SL8_c
shed16$OwnBach <- shed16$SL8_c
shed15$OwnBach <- shed15$SL8_c

shed21$OwnGrad <- ifelse((shed21$SL8_d=="Yes") | (shed21$SL8_e=="Yes"), "Yes", "No")
shed20$OwnGrad <- ifelse((shed20$SL8_d=="Yes") | (shed20$SL8_e=="Yes"), "Yes", "No")
shed19$OwnGrad <- ifelse((shed19$SL8_d=="Yes") | (shed19$SL8_e=="Yes"), "Yes", "No")
shed18$OwnGrad <- ifelse((shed18$SL8_d=="Yes") | (shed18$SL8_e=="Yes"), "Yes", "No")
shed17$OwnGrad <- ifelse((shed17$SL8_d=="Yes") | (shed17$SL8_e=="Yes"), "Yes", "No")
shed16$OwnGrad <- ifelse((shed16$SL8_d=="Yes") | (shed16$SL8_e=="Yes"), "Yes", "No")
shed15$OwnGrad <- ifelse((shed15$SL8_d=="Yes") | (shed15$SL8_e=="Yes"), "Yes", "No")

shed21$SpouseDebt <- shed21$SL10
shed20$SpouseDebt <- shed20$SL10
shed19$SpouseDebt <- shed19$SL10
shed18$SpouseDebt <- shed18$SL10
shed17$SpouseDebt <- shed17$SL10
shed16$SpouseDebt <- shed16$SL10
shed15$SpouseDebt <- shed15$SL10

shed21$ChildDebt <- shed21$SL11
shed20$ChildDebt <- shed20$SL11
shed19$ChildDebt <- shed19$SL11
shed18$ChildDebt <- shed18$SL11
shed17$ChildDebt <- shed17$SL11
shed16$ChildDebt <- shed16$SL11
shed15$ChildDebt <- shed15$SL11

shed21$ChildDebtSL <- shed21$SL12_a
shed20$ChildDebtSL <- shed20$SL12_a
shed19$ChildDebtSL <- shed19$SL12_a
shed18$ChildDebtSL <- shed18$SL12_a
shed17$ChildDebtSL <- shed17$SL12_a
shed16$ChildDebtSL <- shed16$SL12_a
shed15$ChildDebtSL <- rep(NA, nrow(shed15))

shed21$ChildDebtHE <- shed21$SL12_b
shed20$ChildDebtHE <- shed20$SL12_b
shed19$ChildDebtHE <- shed19$SL12_b
shed18$ChildDebtHE <- shed18$SL12_b
shed17$ChildDebtHE <- shed17$SL12_b
shed16$ChildDebtHE <- shed16$SL12_b
shed15$ChildDebtHE <- rep(NA, nrow(shed15))

shed21$ChildDebtCC <- shed21$SL12_c
shed20$ChildDebtCC <- shed20$SL12_c
shed19$ChildDebtCC <- shed19$SL12_c
shed18$ChildDebtCC <- shed18$SL12_c
shed17$ChildDebtCC <- shed17$SL12_c
shed16$ChildDebtCC <- shed16$SL12_c
shed15$ChildDebtCC <- rep(NA, nrow(shed15))

shed21$ChildDebtOther <- shed21$SL12_d
shed20$ChildDebtOther <- shed20$SL12_d
shed19$ChildDebtOther <- shed19$SL12_d
shed18$ChildDebtOther <- shed18$SL12_d
shed17$ChildDebtOther <- shed17$SL12_d
shed16$ChildDebtOther <- shed16$SL12_d
shed15$ChildDebtOther <- rep(NA, nrow(shed15))

shed21$Retired <- shed21$D1I
shed20$Retired <- shed20$D1I
shed19$Retired <- shed19$D1I
shed18$Retired <- shed18$D1I
shed17$Retired <- shed17$D1I
shed16$Retired <- shed16$D1_i
shed15$Retired <- shed15$D2

shed21$RetireOnTrack <- shed21$K0
shed20$RetireOnTrack <- shed20$K0
shed19$RetireOnTrack <- shed19$K0
shed18$RetireOnTrack <- shed18$K0
shed17$RetireOnTrack <- shed17$K0
shed16$RetireOnTrack <- rep(NA, nrow(shed16))
shed15$RetireOnTrack <- rep(NA, nrow(shed15))

shed21$SocSec <- shed21$I0_c
shed20$SocSec <- shed20$I0_c
shed19$SocSec <- shed19$I0_c
shed18$SocSec <- shed18$I0_c
shed17$SocSec <- shed17$I0_c
shed16$SocSec <- shed16$I0_e
shed15$SocSec <- shed15$I0_e

shed21$Welfare <- shed21$I0_d
shed20$Welfare <- shed20$I0_d
shed19$Welfare <- shed19$I0_d
shed18$Welfare <- shed18$I0_d
shed17$Welfare <- shed17$I0_d
shed16$Welfare <- rep(NA, nrow(shed16))
shed15$Welfare <- rep(NA, nrow(shed15))

shed21$TotalInc <- shed21$I40
shed20$TotalInc <- shed20$I40
shed19$TotalInc <- shed19$I40
shed18$TotalInc <- shed18$I40
shed17$TotalInc <- shed17$I40
shed16$TotalInc <- shed16$I4A
shed15$TotalInc <- shed15$I4A

shed21$EITC <- shed21$I41_a
shed20$EITC <- shed20$I41_a
shed19$EITC <- shed19$I41_a
shed18$EITC <- shed18$I41_a
shed17$EITC <- shed17$I41_a
shed16$EITC <- rep(NA, nrow(shed16))
shed15$EITC <- rep(NA, nrow(shed15))

shed21$SNAP <- shed21$I41_b
shed20$SNAP <- shed20$I41_b
shed19$SNAP <- shed19$I41_b
shed18$SNAP <- shed18$I41_b
shed17$SNAP <- shed17$I41_b
shed16$SNAP <- rep(NA, nrow(shed16))
shed15$SNAP <- rep(NA, nrow(shed15))

shed21$WIC <- shed21$I41_c
shed20$WIC <- shed20$I41_c
shed19$WIC <- shed19$I41_c
shed18$WIC <- shed18$I41_c
shed17$WIC <- shed17$I41_c
shed16$WIC <- rep(NA, nrow(shed16))
shed15$WIC <- rep(NA, nrow(shed15))

shed21$HouseAssist <- shed21$I41_d
shed20$HouseAssist <- shed20$I41_d
shed19$HouseAssist <- shed19$I41_d
shed18$HouseAssist <- shed18$I41_d
shed17$HouseAssist <- shed17$I41_d
shed16$HouseAssist <- rep(NA, nrow(shed16))
shed15$HouseAssist <- rep(NA, nrow(shed15))

shed21$FRPL <- shed21$I41_e
shed20$FRPL <- shed20$I41_e
shed19$FRPL <- shed19$I41_e
shed18$FRPL <- shed18$I41_e
shed17$FRPL <- shed17$I41_e
shed16$FRPL <- rep(NA, nrow(shed16))
shed15$FRPL <- rep(NA, nrow(shed15))

shed21$ThreeMonSave <- shed21$EF1
shed20$ThreeMonSave <- shed20$EF1
shed19$ThreeMonSave <- shed19$EF1
shed18$ThreeMonSave <- shed18$EF1
shed17$ThreeMonSave <- shed17$EF1
shed16$ThreeMonSave <- shed16$EF1
shed15$ThreeMonSave <- shed15$EF1

shed21$ThreeMonCover <- shed21$EF2
shed20$ThreeMonCover <- shed20$EF2
shed19$ThreeMonCover <- shed19$EF2
shed18$ThreeMonCover <- shed18$EF2
shed17$ThreeMonCover <- shed17$EF2
shed16$ThreeMonCover <- shed16$EF2
shed15$ThreeMonCover <- shed15$EF2

shed21$CCA400 <- shed21$EF3_a
shed20$CCA400 <- shed20$EF3_a
shed19$CCA400 <- shed19$EF3_a
shed18$CCA400 <- shed18$EF3_a
shed17$CCA400 <- shed17$EF3_a
shed16$CCA400 <- shed16$EF3_a
shed15$CCA400 <- shed15$EF3_a

shed21$CCB400 <- shed21$EF3_b
shed20$CCB400 <- shed20$EF3_b
shed19$CCB400 <- shed19$EF3_b
shed18$CCB400 <- shed18$EF3_b
shed17$CCB400 <- shed17$EF3_b
shed16$CCB400 <- shed16$EF3_b
shed15$CCB400 <- shed15$EF3_b

shed21$Cash400 <- shed21$EF3_c
shed20$Cash400 <- shed20$EF3_c
shed19$Cash400 <- shed19$EF3_c
shed18$Cash400 <- shed18$EF3_c
shed17$Cash400 <- shed17$EF3_c
shed16$Cash400 <- shed16$EF3_c
shed15$Cash400 <- shed15$EF3_c

shed21$Loan400 <- shed21$EF3_d
shed20$Loan400 <- shed20$EF3_d
shed19$Loan400 <- shed19$EF3_d
shed18$Loan400 <- shed18$EF3_d
shed17$Loan400 <- shed17$EF3_d
shed16$Loan400 <- shed16$EF3_d
shed15$Loan400 <- shed15$EF3_d

shed21$Friend400 <- shed21$EF3_e
shed20$Friend400 <- shed20$EF3_e
shed19$Friend400 <- shed19$EF3_e
shed18$Friend400 <- shed18$EF3_e
shed17$Friend400 <- shed17$EF3_e
shed16$Friend400 <- shed16$EF3_e
shed15$Friend400 <- shed15$EF3_e

shed21$Payday400 <- shed21$EF3_f
shed20$Payday400 <- shed20$EF3_f
shed19$Payday400 <- shed19$EF3_f
shed18$Payday400 <- shed18$EF3_f
shed17$Payday400 <- shed17$EF3_f
shed16$Payday400 <- shed16$EF3_f
shed15$Payday400 <- shed15$EF3_f

shed21$Sell400 <- shed21$EF3_g
shed20$Sell400 <- shed20$EF3_g
shed19$Sell400 <- shed19$EF3_g
shed18$Sell400 <- shed18$EF3_g
shed17$Sell400 <- shed17$EF3_g
shed16$Sell400 <- shed16$EF3_g
shed15$Sell400 <- shed15$EF3_g

shed21$None400 <- shed21$EF3_h
shed20$None400 <- shed20$EF3_h
shed19$None400 <- shed19$EF3_h
shed18$None400 <- shed18$EF3_h
shed17$None400 <- shed17$EF3_h
shed16$None400 <- shed16$EF3_h
shed15$None400 <- shed15$EF3_h

shed21$PayBills <- shed21$EF5A
shed20$PayBills <- shed20$EF5A
shed19$PayBills <- shed19$EF5A
shed18$PayBills <- shed18$EF5A
shed17$PayBills <- shed17$EF5A
shed16$PayBills <- shed16$EF5A
shed15$PayBills <- rep(NA, nrow(shed15))

shed21$PayBills400 <- shed21$EF5B
shed20$PayBills400 <- shed20$EF5B
shed19$PayBills400 <- shed19$EF5B
shed18$PayBills400 <- shed18$EF5B
shed17$PayBills400 <- shed17$EF5B
shed16$PayBills400 <- shed16$EF5B
shed15$PayBills400 <- rep(NA, nrow(shed15))

shed21$PayBills400 <- shed21$EF5B
shed20$PayBills400 <- shed20$EF5B
shed19$PayBills400 <- shed19$EF5B
shed18$PayBills400 <- shed18$EF5B
shed17$PayBills400 <- shed17$EF5B
shed16$PayBills400 <- rep(NA, nrow(shed16))
shed15$PayBills400 <- rep(NA, nrow(shed15))

shed21$PartialRent <- shed21$EF6A_a
shed20$PartialRent <- shed20$EF6A_a
shed19$PartialRent <- shed19$EF6A_a
shed18$PartialRent <- shed18$EF6A_a
shed17$PartialRent <- shed17$EF6A_a
shed16$PartialRent <- rep(NA, nrow(shed16))
shed15$PartialRent <- rep(NA, nrow(shed15))

shed21$PartialCC <- shed21$EF6A_b
shed20$PartialCC <- shed20$EF6A_b
shed19$PartialCC <- shed19$EF6A_b
shed18$PartialCC <- shed18$EF6A_b
shed17$PartialCC <- shed17$EF6A_b
shed16$PartialCC <- rep(NA, nrow(shed16))
shed15$PartialCC <- rep(NA, nrow(shed15))

shed21$PartialSL <- shed21$EF6A_f
shed20$PartialSL <- shed20$EF6A_f
shed19$PartialSL <- shed19$EF6A_f
shed18$PartialSL <- shed18$EF6A_f
shed17$PartialSL <- shed17$EF6A_f
shed16$PartialSL <- rep(NA, nrow(shed16))
shed15$PartialSL <- rep(NA, nrow(shed15))

shed21$PartialSL400 <- shed21$EF6B_f
shed20$PartialSL400 <- shed20$EF6B_f
shed19$PartialSL400 <- shed19$EF6B_f
shed18$PartialSL400 <- shed18$EF6B_f
shed17$PartialSL400 <- shed17$EF6B_f
shed16$PartialSL400 <- rep(NA, nrow(shed16))
shed15$PartialSL400 <- rep(NA, nrow(shed15))

shed21$Occupation <- shed21$ppcm0160
shed20$Occupation <- shed20$ppcm0160
shed19$Occupation <- shed19$ppcm0160
shed18$Occupation <- shed18$ppcm0160
shed17$Occupation <- shed17$ppcm0160
shed16$Occupation <- shed16$ppcm0160
shed15$Occupation <- shed15$ppcm0160

shed21$Savings <- shed21$ppfs0596
shed20$Savings <- shed20$ppfs0596
shed19$Savings <- shed19$ppfs0596
shed18$Savings <- shed18$ppfs0596
shed17$Savings <- shed17$ppfs0596
shed16$Savings <- shed16$ppfs0596
shed15$Savings <- shed15$ppfs0596

shed21$CreditScore <- shed21$ppfs1482
shed20$CreditScore <- shed20$ppfs1482
shed19$CreditScore <- shed19$ppfs1482
shed18$CreditScore <- rep(NA, nrow(shed18))
shed17$CreditScore <- rep(NA, nrow(shed17))
shed16$CreditScore <- shed16$C1
shed15$CreditScore <- shed15$C1

shed21$InstLevel <- shed21$iclevel
shed20$InstLevel <- shed20$iclevel
shed19$InstLevel <- shed19$iclevel
shed18$InstLevel <- shed18$iclevel
shed17$InstLevel <- rep(NA, nrow(shed17))
shed16$InstLevel <- rep(NA, nrow(shed16))
shed15$InstLevel <- shed15$sector

shed21$InstControl <- shed21$control
shed20$InstControl <- shed20$control
shed19$InstControl <- shed19$control
shed18$InstControl <- shed18$control
shed17$InstControl <- shed17$control
shed16$InstControl <- rep(NA, nrow(shed16))
shed15$InstControl <- shed15$control

shed21$ChildrenUnder18 <- shed21$L0_b
shed20$ChildrenUnder18 <- shed20$L0_b
shed19$ChildrenUnder18 <- shed19$L0_b
shed18$ChildrenUnder18 <- shed18$L0_b
shed17$ChildrenUnder18 <- shed17$L0_b
shed16$ChildrenUnder18 <- shed16$L0_b
shed15$ChildrenUnder18 <- shed15$D0_b

shed21 <- shed21 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed20 <- shed20 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed19 <- shed19 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed18 <- shed18 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed17 <- shed17 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed16 <- shed16 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed15 <- shed15 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed21$SurveyYear <- rep(2021, nrow(shed21))
shed20$SurveyYear <- rep(2020, nrow(shed20))
shed19$SurveyYear <- rep(2019, nrow(shed19))
shed18$SurveyYear <- rep(2018, nrow(shed18))
shed17$SurveyYear <- rep(2017, nrow(shed17))
shed16$SurveyYear <- rep(2016, nrow(shed16))
shed15$SurveyYear <- rep(2015, nrow(shed15))

shed <- rbind(shed21, shed20, shed19, shed18, shed17, shed16, shed15)
```

```{r shedSetup2, warning=FALSE}

######################################################
### In this code chunk we make adjustments to the  ###
### data values to accommodate the fact that the   ###
### different years of SHED data have slight       ###
### differences to the survey responses that can   ###
### cause problems when pooling the data. I have   ###
### commented out the "table" calls, which were    ###
### used to know which adjustments needed to be    ###
### made.                                          ###
######################################################

# State
# table(shed$State)
shed$State <- toupper(shed$State)
shed$State[shed$State != "CA"] <- "Rest of U.S."
# table(shed$State)

# Race
shed$Race[shed$Race=="2+ Races, Non-Hispanic"] <- "Other, Non-Hispanic"
shed$Race <- factor(shed$Race, levels=rev(c("All", "White, Non-Hispanic", "Hispanic", "Black, Non-Hispanic", "Other, Non-Hispanic")))

# Gender
# table(shed$Gender)

# FinManage
# table(shed$FinManage)

# ParComp
# table(shed$ParComp)

# HomeOwn
# table(shed$HomeOwn)

shed$HomeOwn[shed$HomeOwn=="I [and/or my spouse/partner] don't own [our/my] home or pay rent."] <- "Other"
shed$HomeOwn[shed$HomeOwn=="I [and/or my spouse/partner] own [our/my] home free and clear (without a mortgage or loan)."] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="I [and/or my spouse/partner] own [our/my] home with a mortgage or loan."] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="I [and/or my spouse/partner] pay rent."] <- "Pay rent"
shed$HomeOwn[shed$HomeOwn=="I [PPMARITins2] don\x92t own [PPMARITins3] home or pay rent."] <- "Other"
shed$HomeOwn[shed$HomeOwn=="I [PPMARITins2] own [PPMARITins3] home free and clear (without a mortgage or loan)."] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="I [PPMARITins2] own [PPMARITins3] home with a mortgage or loan."] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="I [PPMARITins2] pay rent."] <- "Pay rent"
shed$HomeOwn[shed$HomeOwn=="Neither own home nor pay rent"] <- "Other"
shed$HomeOwn[shed$HomeOwn=="neither own home nor pay rent."] <- "Other"
shed$HomeOwn[shed$HomeOwn=="Neither own nor pay rent"] <- "Other"
shed$HomeOwn[shed$HomeOwn=="Own home free and clear (without a mortgage or loan)"] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="own home free and clear (without a mortgage or loan)."] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="Own home with a mortgage or loan"] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="own home with a mortgage or loan."] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="Own your home free and clear (without a mortgage or loan)"] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="Own your home with a mortgage or loan"] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="Pay rent"] <- "Pay rent"
shed$HomeOwn[shed$HomeOwn=="pay rent."] <- "Pay rent"
# table(shed$HomeOwn)

# CCApprov
# table(shed$CCApprov)
shed$CCApprov[shed$CCApprov=="Don't know"] <- "Don't know"
shed$CCApprov[shed$CCApprov=="Don’t know"] <- "Don't know"
shed$CCApprov[shed$CCApprov=="Don\x92t know"] <- "Don't know"
# table(shed$CCApprov)

# CreditDeny
# table(shed$CreditDeny)

# UnpaidCC
# table(shed$UnpaidCC)

# CCBalance
# table(shed$CCBalance)
shed$CCBalance[shed$CCBalance=="Never carried a balance (always pay in full)"] <- "Always pay in full"
shed$CCBalance[shed$CCBalance=="Never carried an unpaid balance (always pay in full)"] <- "Always pay in full"
# table(shed$CCBalance)

# EdAttain
# table(shed$EdAttain)
shed$EdAttain[shed$EdAttain=="Bachelor's degree"] <- "Bachelor's degree"
shed$EdAttain[shed$EdAttain=="Bachelor’s degree"] <- "Bachelor's degree"
shed$EdAttain[shed$EdAttain=="Bachelor\x92s degree"] <- "Bachelor's degree"
shed$EdAttain[shed$EdAttain=="Doctoral degree"] <- "Doctorate"
shed$EdAttain[shed$EdAttain=="Doctoral Degree"] <- "Doctorate"
shed$EdAttain[shed$EdAttain=="Less than high school degree"] <- "Less than high school diploma"
shed$EdAttain[shed$EdAttain=="Less than High School degree"] <- "Less than high school diploma"
shed$EdAttain[shed$EdAttain=="Master's degree"] <- "Master's degree"
shed$EdAttain[shed$EdAttain=="Master’s degree"] <- "Master's degree"
shed$EdAttain[shed$EdAttain=="Master\x92s degree"] <- "Master's degree"
shed$EdAttain[shed$EdAttain=="Professional degree (e.g. MBA, MD, JD)"] <- "Professional degree"
shed$EdAttain[shed$EdAttain=="Professional degree (e.g., MBA, MD, JD)"]  <- "Professional degree"
shed$EdAttain[shed$EdAttain=="Some college but no degree (including currently enrolled in college)"] <- "Some college, no degree"
shed$EdAttain[shed$EdAttain=="Certificate or technical degree"] <- "Some college, no degree"
# table(shed$EdAttain)

# EdPayoff1
# table(shed$EdPayoff1)
shed$EdPayoff1[shed$EdPayoff1=="About the same financial benefits and financial costs"] <- "About the same"

# DiffField1
# table(shed$DiffField1)

# DiffSchool1
# table(shed$DiffSchool1)

# LessEd1
# table(shed$LessEd1)

# MoreEd1
# table(shed$MoreEd1)

# OwnDebt
# table(shed$OwnDebt)

# OwnDebtSL
# table(shed$OwnDebtSL)

# OwnDebtHE
# table(shed$OwnDebtHE)

# OwnDebtCC
# table(shed$OwnDebtCC)

# OwnDebtOther
# table(shed$OwnDebtOther)

# OwnDebtTot
# table(shed$OwnDebtTot)
shed$OwnDebtTot1 <- shed$OwnDebtTot
shed$OwnDebtTot1[shed$OwnDebtTot=="Less than $5,000"] <- "2500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$5,000 to $9,999"] <- "7500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$10,000 to $14,999"] <- "12500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$15,000 to $19,999"] <- "17500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$20,000 to $24,999"] <- "22500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$25,000 to $29,999"] <- "27500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$30,000 to $39,999"] <- "35000"
shed$OwnDebtTot1[shed$OwnDebtTot=="$40,000 to $49,999"] <- "45000"
shed$OwnDebtTot1[shed$OwnDebtTot=="$50,000 to $74,999"] <- "62500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$75,000 to $99,999"] <- "87500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$100,000 or above"] <- "105000"
shed$OwnDebtTot2 <- as.numeric(shed$OwnDebtTot1)
shed$OwnDebtTot3 <- rep(NA, nrow(shed))
shed$OwnDebtTot3[shed$OwnDebtTot2 < 5000] <- "Less than $5,000"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 5000 & shed$OwnDebtTot2 <= 9999] <- "$5,000 to $9,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 10000 & shed$OwnDebtTot2 <= 14999] <- "$10,000 to $14,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 15000 & shed$OwnDebtTot2 <= 19999] <- "$15,000 to $19,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 20000 & shed$OwnDebtTot2 <= 24999] <- "$20,000 to $24,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 25000 & shed$OwnDebtTot2 <= 29999] <- "$25,000 to $29,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 30000 & shed$OwnDebtTot2 <= 39999] <- "$30,000 to $39,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 40000 & shed$OwnDebtTot2 <= 49999] <- "$40,000 to $49,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 50000 & shed$OwnDebtTot2 <= 74999] <- "$50,000 to $74,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 75000 & shed$OwnDebtTot2 <= 99999] <- "$75,000 to $99,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 > 100000] <- "$100,000 or above"
shed$OwnDebtTot3[shed$OwnDebtTot2 == 1e+05] <- NA
# table(shed$OwnDebtTot3)

# OwnDebtMon
# table(shed$OwnDebtMon)
shed$OwnDebtMon1 <- shed$OwnDebtMon
shed$OwnDebtMon1[shed$OwnDebtMon=="I am currently not required to make any payments on these loans"] <- "0"
shed$OwnDebtMon1[shed$OwnDebtMon=="I am not currently required to make any payments on these loans"] <- "0"
shed$OwnDebtMon1[shed$OwnDebtMon=="I was not required to make any payments on these loans"] <- "0"
shed$OwnDebtMon1[shed$OwnDebtMon=="$1 to $99"] <- "99"
shed$OwnDebtMon1[shed$OwnDebtMon=="$1 to $49"] <- "49"
shed$OwnDebtMon1[shed$OwnDebtMon=="$59 to $49"] <- "99"
shed$OwnDebtMon1[shed$OwnDebtMon=="$100 to $199"] <- "199"
shed$OwnDebtMon1[shed$OwnDebtMon=="$200 to $299"] <- "299"
shed$OwnDebtMon1[shed$OwnDebtMon=="$300 to $399"] <- "399"
shed$OwnDebtMon1[shed$OwnDebtMon=="$400 to $499"] <- "499"
shed$OwnDebtMon1[shed$OwnDebtMon=="$500 to $749"] <- "749"
shed$OwnDebtMon1[shed$OwnDebtMon=="$500 to $999"] <- "599"
shed$OwnDebtMon1[shed$OwnDebtMon=="$750 to $999"] <- "999"
shed$OwnDebtMon1[shed$OwnDebtMon=="$1,000 or above"] <- "1000"
shed$OwnDebtMon2 <- as.numeric(shed$OwnDebtMon1)
shed$OwnDebtMon3 <- rep(NA, nrow(shed))
shed$OwnDebtMon3[shed$OwnDebtMon2 == 0] <- "$0"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 1 & shed$OwnDebtMon2 <= 99] <- "$1 to $99"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 100 & shed$OwnDebtMon2 <= 199] <- "$100 to $199"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 200 & shed$OwnDebtMon2 <= 299] <- "$200 to $299"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 300 & shed$OwnDebtMon2 <= 399] <- "$300 to $399"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 400 & shed$OwnDebtMon2 <= 499] <- "$400 to $499"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 500 & shed$OwnDebtMon2 <= 999] <- "$500 to $999"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 1000] <- "$1,000 or above"
shed$OwnDebtMon3[shed$OwnDebtMon2 == "-2"] <- NA
# table(shed$OwnDebtMon3)

# OwnDebtBehind
# table(shed$OwnDebtBehind)

# OwnRepaid
# table(shed$OwnRepaid)

# OwnCert
# table(shed$OwnCert)

# OwnAssoc
# table(shed$OwnAssoc)

# OwnBach
# table(shed$OwnBach)

# OwnGrad
# table(shed$OwnGrad)

# SpouseDebt
# table(shed$SpouseDebt)

# ChildDebt
# table(shed$ChildDebt)

# ChildDebtSL
# table(shed$ChildDebtSL)

# ChildDebtHE
# table(shed$ChildDebtHE)

# ChildDebtCC
# table(shed$ChildDebtCC)

# ChildDebtOther
# table(shed$ChildDebtOther)

# Retired
# table(shed$Retired)
shed$Retired[shed$Retired=="No"] <- "Not retired"
shed$Retired[shed$Retired=="Disabled and not working"] <- "Not retired"
shed$Retired[shed$Retired=="Employed now"] <- "Not retired"
shed$Retired[shed$Retired=="Homemaker"] <- "Not retired"
shed$Retired[shed$Retired=="Not employed, but looking for a job"] <- "Not retired"
shed$Retired[shed$Retired=="Temporarily laid off"] <- "Not retired"
shed$Retired[shed$Retired=="Student"] <- "Not retired"
shed$Retired[shed$Retired=="Not employed and not looking for a job"] <- "Not retired"
shed$Retired[shed$Retired=="Yes"] <- "Retired"
# table(shed$Retired)

# RetireOnTrack
# table(shed$RetireOnTrack)
shed$RetireOnTrack[shed$RetireOnTrack=="Don't know"] <- "Don't know"
shed$RetireOnTrack[shed$RetireOnTrack=="Don’t know"] <- "Don't know"
shed$RetireOnTrack[shed$RetireOnTrack=="Don\x92t know"] <- "Don't know"
# table(shed$RetireOnTrack)

# SocSec
# table(shed$SocSec)

# Welfare
# table(shed$Welfare)

# TotalInc
# table(shed$TotalInc)
shed$TotalInc[shed$TotalInc=="0"] <- "$0 to $4,999"
shed$TotalInc[shed$TotalInc=="$0"] <- "$0 to $4,999"
shed$TotalInc[shed$TotalInc=="$1 to $4,999"] <- "$0 to $4,999"
# table(shed$TotalInc)

# EITC
# table(shed$EITC)

# SNAP
# table(shed$SNAP)

# WIC
# table(shed$WIC)

# HouseAssist
# table(shed$HouseAssist)

# FRPL
# table(shed$FRPL)

# ThreeMonSave
# table(shed$ThreeMonSave)

# ThreeMonCover
# table(shed$ThreeMonCover)

# CCA400
# table(shed$CCA400)
shed$CCA400[shed$CCA400=="Put it on my credit card and pay it off in full at the next statement"] <- "Yes"
# table(shed$CCA400)

# CCB400
# table(shed$CCB400)
shed$CCB400[shed$CCB400=="Put it on my credit card and pay it off over time"] <- "Yes"
# table(shed$CCB400)

# Cash400
# table(shed$Cash400)
shed$Cash400[shed$Cash400=="With the money currently in my checking/savings account or with cash"] <- "Yes"
# table(shed$Cash400)

# Loan400
# table(shed$Loan400)
shed$Loan400[shed$Loan400=="Using money from a bank loan or line of credit"] <- "Yes"
# table(shed$Loan400)

# Friend400
# table(shed$Friend400)
shed$Friend400[shed$Friend400=="By borrowing from a friend or family member"] <- "Yes"
# table(shed$Friend400)

# Payday400
# table(shed$Payday400)
shed$Payday400[shed$Payday400=="Using a payday loan, deposit advance, or overdraft"] <- "Yes"
# table(shed$Payday400)

# Sell400
# table(shed$Sell400)
shed$Sell400[shed$Sell400=="By selling something"] <- "Yes"
# table(shed$Sell400)

# None400
# table(shed$None400)
shed$None400[shed$None400=="I wouldn’t be able to pay for the expense right now"] <- "Yes"
# table(shed$None400)

# PayBills
# table(shed$PayBills)
shed$PayBills[shed$PayBills=="Able to pay all bills"] <- "I will be able to pay all of my bills in full"
shed$PayBills[shed$PayBills=="I cannot pay some bills or will only make a partial payment on some of them"] <- "I cannot pay some bills or will only make a partial payment on them"
shed$PayBills[shed$PayBills=="Can’t pay some bills"] <- "I cannot pay some bills or will only make a partial payment on them"
shed$PayBills[shed$PayBills=="Can\x92t pay some bills"] <- "I cannot pay some bills or will only make a partial payment on them"
# table(shed$PayBills)

# PayBills400
# table(shed$PayBills400)
shed$PayBills400[shed$PayBills400=="Could not pay some bills"] <- "I could not pay some other bills or would only make a partial payment on some of them"
shed$PayBills400[shed$PayBills400=="Would still be able to pay all bills"] <- "I would still be able to pay all of my other bills in full"
# table(shed$PayBills400)

# PartialRent
# table(shed$PartialRent)

# PartialCC
# table(shed$PartialCC)

# PartialSL
# table(shed$PartialSL)

# PartialSL400
# table(shed$PartialSL400)

# Occupation
# table(shed$Occupation)
shed$Occupation[shed$Occupation=="Business Operations (including Marketing)"] <- "Business and Financial Operations"
shed$Occupation[shed$Occupation=="Financial Operations or Financial Services (including Financial Advisor, Broker)"] <- "Business and Financial Operations"
shed$Occupation[shed$Occupation=="Health Diagnosing or Treating Practitioner (such as physician, nurse, dentist, v"] <- "Health Diagnosing or Treating Practitioner"
shed$Occupation[shed$Occupation=="Health Diagnosing or Treating Practitioner (such as physician, nurse, dentist, veterinarian, pharmacist)"] <- "Health Diagnosing or Treating Practitioner"
shed$Occupation[shed$Occupation=="Other Health Care Practitioner (such as nurse, pharmacist, chiropractor, dietici"] <- "Other Health Care Practitioner"
shed$Occupation[shed$Occupation=="Other Health Care Practitioner (such as nurse, pharmacist, chiropractor, dietician)"] <- "Other Health Care Practitioner"
shed$Occupation[shed$Occupation=="Retail Sales"] <- "Sales"
shed$Occupation[shed$Occupation=="Sales Representative"] <- "Sales"
# table(shed$Occupation)

# Savings
# table(shed$Savings)
shed$Savings[shed$Savings=="Under $5,000"] <- "Under $50,000"
shed$Savings[shed$Savings=="$5,000 - $9,999"] <- "Under $50,000"
shed$Savings[shed$Savings=="$10,000 - $24,999"] <- "Under $50,000"
shed$Savings[shed$Savings=="$25,000 - $34,999"] <- "Under $50,000"
shed$Savings[shed$Savings=="$35,000 - $49,999"] <- "Under $50,000"
shed$Savings[shed$Savings=="$50,000 - $74,999"] <- "$50,000 - $99,999"
shed$Savings[shed$Savings=="$75,000 - $99,999"] <- "$50,000 - $99,999"
shed$Savings[shed$Savings=="Not asked"] <- NA
# table(shed$Savings)

# CreditScore
# table(shed$CreditScore)
shed$CreditScore[shed$CreditScore=="Don\x92t know"] <- "Don't know"
shed$CreditScore[shed$CreditScore=="Don't know my score or how to rate it"] <- "Don't know"
shed$CreditScore[shed$CreditScore=="Don’t know"] <- "Don't know"
shed$CreditScore[shed$CreditScore=="Don\x92t know my score or how to rate it"] <- "Don't know"
shed$CreditScore[shed$SurveyYear %in% c(2015, 2016)] <- NA # Inconsistent measure
# table(shed$CreditScore, shed$SurveyYear)

# InstLevel
# table(shed$InstLevel)
shed$InstLevel[shed$InstLevel=="[2, 4) years"] <- "Two-year"
shed$InstLevel[shed$InstLevel=="<2 years"] <- "Less than two-year"
shed$InstLevel[shed$InstLevel==">=4 years"] <- "Four-year"
shed$InstLevel[shed$InstLevel=="Administrative Unit"] <- NA
shed$InstLevel[shed$InstLevel=="Private for-profit, 2-year"] <- "Two-year"
shed$InstLevel[shed$InstLevel=="Private for-profit, 4-year or above"] <- "Four-year"
shed$InstLevel[shed$InstLevel=="Private for-profit, less-than 2-year"] <- "Less than two-year"
shed$InstLevel[shed$InstLevel=="Private not-for-profit, 2-year"] <- "Two-year"
shed$InstLevel[shed$InstLevel=="Private not-for-profit, 4-year or above"] <- "Four-year"
shed$InstLevel[shed$InstLevel=="Private not-for-profit, less-than 2-year"] <- "Less than two-year"
shed$InstLevel[shed$InstLevel=="Public, 2-year"] <- "Two-year"
shed$InstLevel[shed$InstLevel=="Public, 4-year or above"] <- "Four-year"
shed$InstLevel[shed$InstLevel=="Public, less-than 2-year"] <- "Less than two-year"
# table(shed$InstLevel)

# InstControl
# table(shed$InstControl)

# AnyStudentLoans
shed$AnyStudentLoans <- rep("No", nrow(shed))
shed$AnyStudentLoans[shed$OwnDebtSL=="Yes"] <- "Yes"
shed$AnyStudentLoans[shed$ChildDebtSL=="Yes"] <- "Yes"

# Count variable
shed$Count <- rep(1, nrow(shed))

```

```{r SurveyYearFunction}
survey_years <- function(surveyYearVector) {
  allYears <- rev(unique(surveyYearVector))
  numYears <- length(allYears)
  if(numYears==1){cat(allYears[1])}
  if(numYears==2){cat(allYears[1], " and ", allYears[2], ".", sep="")}
  if(numYears==3){cat(allYears[1], ", ", allYears[2], ", and ", allYears[3], ".", sep="")}
  if(numYears==4){cat(allYears[1], ", ", allYears[2], ", ", allYears[3], ", and ", allYears[4], ".", sep="")}
  if(numYears==5){cat(allYears[1], ", ", allYears[2], ", ", allYears[3], ", ", allYears[4], ", and ", allYears[5], ".", sep="")}
  if(numYears==6){cat(allYears[1], ", ", allYears[2], ", ", allYears[3], ", ", allYears[4], ", ", allYears[5], ", and ", allYears[6], ".", sep="")}
  if(numYears==7){cat(allYears[1], ", ", allYears[2], ", ", allYears[3], ", ", allYears[4], ", ", allYears[5], ", ", allYears[6], ", and ", allYears[7], ".", sep="")}
}
```

Figure 7 examines which respondents have student loan debt or other debt used for their  educations. Overall, 13.8 percent of California respondents did, slightly below the 15.8 percent share for the rest of the U.S. 

Significantly more than other groups, Black respondents in California and the rest of the U.S. alike reported having education debt (26.3 percent). This is well above the share for white California respondents, just 9.6 percent. 

### {.tabset}
```{r ownDebt}
# OwnDebt: # Do you currently have student loan debt or owe any money used to pay for your own education? 

# table(shed$OwnDebt)
shed.OwnDebt <- shed %>% filter((OwnDebt %in% c("Not In Universe (not asked)", "Refused", NA))==FALSE)
tblOwnDebt <- aggregate(data=shed.OwnDebt, Weight ~ OwnDebt + Race + State, FUN=sum)
tblOwnDebt2 <- aggregate(data=shed.OwnDebt, Weight ~ OwnDebt + State, FUN=sum)
tblOwnDebt2$Race <- rep("All", nrow(tblOwnDebt2))
tblOwnDebt <- rbind(tblOwnDebt, tblOwnDebt2)
tblOwnDebt <- reshape2::dcast(data=tblOwnDebt, Race + State ~ OwnDebt, value.var="Weight")
tblOwnDebt$`Share with debt` <- tblOwnDebt$Yes / (tblOwnDebt$Yes + tblOwnDebt$No)
```
#### Figure 7
##### Responses to "Do you currently have student loan debt or owe any money used to pay for your own education?" 
```{r figure7}
tblOwnDebt$`For Tooltip` <- paste(
  "State: ", tblOwnDebt$State, '\n',
  "Group: ", tblOwnDebt$Race, '\n',
  "Share with debt: ", percent(tblOwnDebt$`Share with debt`, accuracy=0.1), 
  sep=""
)

g7 <- ggplot(data=tblOwnDebt, mapping=aes(y=Race, x=`Share with debt`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g7, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 7 are
```{r ownDebt.SY, results = 'asis'}
survey_years(shed.OwnDebt$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup. 
```{r ownDebt.N}
N.OwnDebt <- aggregate(data=shed.OwnDebt, Count ~ Race + State, FUN=sum)
names(N.OwnDebt) <- c("Group", "State", "Survey respondents")
kable(N.OwnDebt, caption="N size by group for Figure 7") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Figure 8 examines the type of debt that borrowers have. For the vast majority of borrowers, at least some of that debt is in the form of a student loan. 

SHED also asks about home equity loans that respondents took out to support their education. These are low percentages overall, but it is notable that Hispanic borrowers report this the most often. 

The share of respondents who say they hold credit card debt for their education is concerning, since credit card debt is the highest-interest of the three types of debt examined here. Around 40 percent of California borrowers have credit card debt for their education, which is 10 percentage points higher than Black borrowers nationwide and well above the share for white borrowers (16.7 percent). Hispanic borrowers are next-highest, with 27 percent of California borrowers holding credit card debt.  

### {.tabset}
#### Figure 8: Student loans
```{r OwnDebtSL}
# OwnDebtSL: # Student loan - Think about the money you currently owe for your own education. Is the money you owe for that education a: 

# table(shed$OwnDebtSL)
shed.OwnDebtSL <- shed %>% filter((OwnDebtSL %in% c("Not In Universe (not asked)", "Refused", NA))==FALSE) %>% filter(OwnDebt=="Yes")
tblOwnDebtSL <- aggregate(data=shed.OwnDebtSL, Weight ~ OwnDebtSL + Race + State, FUN=sum)
tblOwnDebtSL2 <- aggregate(data=shed.OwnDebtSL, Weight ~ OwnDebtSL + State, FUN=sum)
tblOwnDebtSL2$Race <- rep("All", nrow(tblOwnDebtSL2))
tblOwnDebtSL <- rbind(tblOwnDebtSL, tblOwnDebtSL2)
tblOwnDebtSL <- reshape2::dcast(data=tblOwnDebtSL, Race + State ~ OwnDebtSL, value.var="Weight")
tblOwnDebtSL$`Share of borrowers whose debt includes a student loan` <- tblOwnDebtSL$Yes / (tblOwnDebtSL$Yes + tblOwnDebtSL$No)
```
##### Responses to "Think about the money you currently owe for your own education. Is the money you owe for that education a student loan?"
```{r figure8A}
tblOwnDebtSL$`For Tooltip` <- paste(
  "State: ", tblOwnDebtSL$State, '\n',
  "Group: ", tblOwnDebtSL$Race, '\n',
  "Share whose debt includes a student loan: ", percent(tblOwnDebtSL$`Share of borrowers whose debt includes a student loan`, accuracy=0.1),
  sep=""
)

g8A <- ggplot(data=tblOwnDebtSL, mapping=aes(y=Race, x=`Share of borrowers whose debt includes a student loan`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g8A, width=800, height=350, tooltip="text")
```
#### Figure 8: Home equity
```{r OwnDebtHE}
# OwnDebtHE: # Home equity loan - Think about the money you currently owe for your own education. Is the money you owe for that education a: 

# table(shed$OwnDebtHE)
shed.OwnDebtHE <- shed %>% filter((OwnDebtHE %in% c("Not In Universe (not asked)", "Refused", NA))==FALSE) %>% filter(OwnDebt=="Yes")
tblOwnDebtHE <- aggregate(data=shed.OwnDebtHE, Weight ~ OwnDebtHE + Race + State, FUN=sum)
tblOwnDebtHE2 <- aggregate(data=shed.OwnDebtHE, Weight ~ OwnDebtHE + State, FUN=sum)
tblOwnDebtHE2$Race <- rep("All", nrow(tblOwnDebtHE2))
tblOwnDebtHE <- rbind(tblOwnDebtHE, tblOwnDebtHE2)
tblOwnDebtHE <- reshape2::dcast(data=tblOwnDebtHE, Race + State ~ OwnDebtHE, value.var="Weight")
tblOwnDebtHE$`Share of borrowers whose debt includes home equity` <- tblOwnDebtHE$Yes / (tblOwnDebtHE$Yes + tblOwnDebtHE$No)
```
##### Responses to "Think about the money you currently owe for your own education. Is the money you owe for that education home equity?
```{r figure8B}
tblOwnDebtHE$`For Tooltip` <- paste(
  "State: ", tblOwnDebtHE$State, '\n',
  "Group: ", tblOwnDebtHE$Race, '\n',
  "Share whose debt includes home equity: ", percent(tblOwnDebtHE$`Share of borrowers whose debt includes home equity`, accuracy=0.1),
  sep=""
)

g8B <- ggplot(data=tblOwnDebtHE, mapping=aes(y=Race, x=`Share of borrowers whose debt includes home equity`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g8B, width=800, height=350, tooltip="text")
```
#### Figure 8: Credit card debt
```{r OwnDebtCC}
# OwnDebtCC: # Credit card - Think about the money you currently owe for your own education. Is the money you owe for that education a:

# table(shed$OwnDebtCC)
shed.OwnDebtCC <- shed %>% filter((OwnDebtCC %in% c("Not In Universe (not asked)", "Refused", NA))==FALSE) %>% filter(OwnDebt=="Yes")
tblOwnDebtCC <- aggregate(data=shed.OwnDebtCC, Weight ~ OwnDebtCC + Race + State, FUN=sum)
tblOwnDebtCC2 <- aggregate(data=shed.OwnDebtCC, Weight ~ OwnDebtCC + State, FUN=sum)
tblOwnDebtCC2$Race <- rep("All", nrow(tblOwnDebtCC2))
tblOwnDebtCC <- rbind(tblOwnDebtCC, tblOwnDebtCC2)
tblOwnDebtCC <- reshape2::dcast(data=tblOwnDebtCC, Race + State ~ OwnDebtCC, value.var="Weight")
tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt` <- tblOwnDebtCC$Yes / (tblOwnDebtCC$Yes + tblOwnDebtCC$No)
```
##### Responses to "Think about the money you currently owe for your own education. Is the money you owe for that education credit card debt?"
```{r figure8C}
tblOwnDebtCC$`For Tooltip` <- paste(
  "State: ", tblOwnDebtCC$State, '\n',
  "Group: ", tblOwnDebtCC$Race, '\n',
  "Share whose debt includes credit card debt: ", percent(tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt`, accuracy=0.1),
  sep=""
)

g8C <- ggplot(data=tblOwnDebtCC, mapping=aes(y=Race, x=`Share of borrowers whose debt includes credit card debt`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols) 

ggplotly(g8C, width=800, height=350, tooltip="text")
```

```{r ForPolicyReport3, eval=FALSE}
tblOwnDebtCC0 <- tblOwnDebtCC %>% filter(Race != "Other, Non-Hispanic")
tblOwnDebtCC0$Race <- as.factor(tblOwnDebtCC0$Race)
tblOwnDebtCC0$Race <- factor(tblOwnDebtCC0$Race, levels=c("All", "White, Non-Hispanic", "Hispanic", "Black, Non-Hispanic"))
ggplot(data=tblOwnDebtCC0, mapping=aes(y=`Share of borrowers whose debt includes credit card debt`, x=Race, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.5) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) + labs(y="Share whose education debt includes credit card debt", x="Group") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols2)
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 8 are
```{r OwnDebtSL.SY, results = 'asis'}
survey_years(shed.OwnDebtSL$SurveyYear)
# I have checked and verified that all three versions of Figure 8 use the same survey years. 
```

**Notes:** See the tables below for the survey respondent sample size by subgroup. 
```{r OwnDebtSL.N}
N.OwnDebtSL <- aggregate(data=shed.OwnDebtSL, Count ~ Race + State, FUN=sum)
names(N.OwnDebtSL) <- c("Group", "State", "Survey respondents")
kable(N.OwnDebtSL, caption="N size by group for Figure 8: Student loans") %>% kable_paper("hover", full_width = F)
```

```{r OwnDebtHE.N}
N.OwnDebtHE <- aggregate(data=shed.OwnDebtHE, Count ~ Race + State, FUN=sum)
names(N.OwnDebtHE) <- c("Group", "State", "Survey respondents")
kable(N.OwnDebtHE, caption="N size by group for Figure 8: Home equity") %>% kable_paper("hover", full_width = F) 
```

```{r OwnDebtCC.N}
N.OwnDebtCC <- aggregate(data=shed.OwnDebtHE, Count ~ Race + State, FUN=sum)
names(N.OwnDebtCC) <- c("Group", "State", "Survey respondents")
kable(N.OwnDebtCC, caption="N size by group for Figure 8: Credit card debt") %>% kable_paper("hover", full_width = F) 
```

***

### {-}

SHED also asks about the total amount borrowers owe and reports responses in eleven categories. Hispanic borrowers in California are most likely to carry a balance of $15,000 or below, while Black borrowers in California are the most likely to carry a balance of \$100,000 or more. 

Compared to borrowers in the rest of the U.S., white California borrowers are more likely to report higher amounts of education debt. Hispanic California borrowers and California borrowers of another non-Hispanic race are more likely to report lower amounts of education debt compared to borrowers in the rest of the U.S. 

### {.tabset}
#### Figure 9: CA borrowers
```{r OwnDebtTotal}
# OwnDebtTot3: # Thinking specifically about the money that you owe for your own education, please tell the total amount that you currently owe on these loans. 

# table(shed$OwnDebtTot3)
shed.OwnDebtTot3 <- shed %>% filter(is.na(OwnDebtTot3)==FALSE)
tblOwnDebtTot3 <- aggregate(data=shed.OwnDebtTot3, Weight ~ OwnDebtTot3 + Race + State, FUN=sum)
tblOwnDebtTot32 <- aggregate(data=shed.OwnDebtTot3, Weight ~ OwnDebtTot3 + State, FUN=sum)
tblOwnDebtTot32$Race <- rep("All", nrow(tblOwnDebtTot32))
tblOwnDebtTot3 <- rbind(tblOwnDebtTot3, tblOwnDebtTot32)
tblOwnDebtTot3 <- reshape2::dcast(data=tblOwnDebtTot3, Race + State ~ OwnDebtTot3, value.var="Weight")
tblOwnDebtTot3$`Total weight` <- tblOwnDebtTot3$`Less than $5,000` + tblOwnDebtTot3$`$5,000 to $9,999` + tblOwnDebtTot3$`$10,000 to $14,999` + tblOwnDebtTot3$`$15,000 to $19,999` + tblOwnDebtTot3$`$20,000 to $24,999` + tblOwnDebtTot3$`$25,000 to $29,999` + tblOwnDebtTot3$`$30,000 to $39,999` + tblOwnDebtTot3$`$40,000 to $49,999` +  tblOwnDebtTot3$`$50,000 to $74,999` + tblOwnDebtTot3$`$75,000 to $99,999` + tblOwnDebtTot3$`$100,000 or above` 
tblOwnDebtTot3$`Less than $5,000` <- tblOwnDebtTot3$`Less than $5,000` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$5,000 to $9,999` <- tblOwnDebtTot3$`$5,000 to $9,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$10,000 to $14,999` <- tblOwnDebtTot3$`$10,000 to $14,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$15,000 to $19,999` <- tblOwnDebtTot3$`$15,000 to $19,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$20,000 to $24,999` <- tblOwnDebtTot3$`$20,000 to $24,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$25,000 to $29,999` <- tblOwnDebtTot3$`$25,000 to $29,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$30,000 to $39,999` <- tblOwnDebtTot3$`$30,000 to $39,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$40,000 to $49,999` <- tblOwnDebtTot3$`$40,000 to $49,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$50,000 to $74,999` <- tblOwnDebtTot3$`$50,000 to $74,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$75,000 to $99,999` <- tblOwnDebtTot3$`$75,000 to $99,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$100,000 or above` <- tblOwnDebtTot3$`$100,000 or above` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3 <- reshape2::melt(data=tblOwnDebtTot3, id.vars = c("Race", "State"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblOwnDebtTot3$variable <- factor(tblOwnDebtTot3$variable, levels = c("$100,000 or above", "$75,000 to $99,999", "$50,000 to $74,999", "$40,000 to $49,999", "$30,000 to $39,999", "$25,000 to $29,999", "$20,000 to $24,999","$15,000 to $19,999", "$10,000 to $14,999", "$5,000 to $9,999", "Less than $5,000"))
```
##### Responses to "Thinking specifically about the money that you owe for your own education, please tell the total amount that you currently owe on these loans."
```{r figure9A}
tblOwnDebtTot3.CA <- tblOwnDebtTot3 %>% filter(State=="CA")

tblOwnDebtTot3.CA$`For Tooltip` <- paste(
  "State: ", tblOwnDebtTot3.CA$State, '\n',
  "Group: ", tblOwnDebtTot3.CA$Race, '\n',
  "Total student debt: ", tblOwnDebtTot3.CA$variable, '\n',
  "Share of borrowers: ", percent(tblOwnDebtTot3.CA$`Share of borrowers`, accuracy=0.1), 
  sep=""
)

g9A <- ggplot(data=tblOwnDebtTot3.CA, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Total student debt") + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g9A, height=350, tooltip="text")
```
#### Figure 9: Rest of U.S. borrowers
##### Responses to "Thinking specifically about the money that you owe for your own education, please tell the total amount that you currently owe on these loans."
```{r figure9B}
tblOwnDebtTot3.US <- tblOwnDebtTot3 %>% filter(State=="Rest of U.S.")

tblOwnDebtTot3.US$`For Tooltip` <- paste(
  "State: ", tblOwnDebtTot3.US$State, '\n',
  "Group: ", tblOwnDebtTot3.US$Race, '\n',
  "Total student debt: ", tblOwnDebtTot3.US$variable, '\n',
  "Share of borrowers: ", percent(tblOwnDebtTot3.US$`Share of borrowers`, accuracy=0.1), 
  sep=""
)

g9B <- ggplot(data=tblOwnDebtTot3.US, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Total student debt") + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g9B, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 9 are
```{r OwnDebtTotal.SY, results = 'asis'}
survey_years(shed.OwnDebtTot3$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup. 
```{r OwnDebtTotal.N}
N.OwnDebtTotal <- aggregate(data=shed.OwnDebtTot3, Count ~ Race + State, FUN=sum)
names(N.OwnDebtTotal) <- c("Group", "State", "Survey respondents")
kable(N.OwnDebtTotal, caption="N size by group for Figure 9") %>% kable_paper("hover", full_width = F)
```

***

### {-}

According to Figure 10, the median California borrower across all groups must make a monthly payment between \$100 and \$199. California borrowers who are white report higher monthly payments on their education loans. 

For Figure 10, I excluded survey responses from 2020 and 2021 due to the federal student loan payment pause. 

### {.tabset}
```{r OwnDebtMon3}
# OwnDebtMon3: # Approximately how much is the total monthly payment that you are required to make on the loans from your education?

# table(shed$OwnDebtMon3)
shed.OwnDebtMon3 <- shed %>% filter(is.na(OwnDebtMon3)==FALSE) %>% filter(SurveyYear %in% c(2015, 2016, 2017, 2018, 2019))
shed.OwnDebtMon3 <- shed.OwnDebtMon3 %>% add_row(OwnDebtMon3="$400 to $499", Race="Black, Non-Hispanic", State="CA", Weight=0)
tblOwnDebtMon3 <- aggregate(data=shed.OwnDebtMon3, Weight ~ OwnDebtMon3 + Race + State, FUN=sum)
tblOwnDebtMon32 <- aggregate(data=shed.OwnDebtMon3, Weight ~ OwnDebtMon3 + State, FUN=sum)
tblOwnDebtMon32$Race <- rep("All", nrow(tblOwnDebtMon32))
tblOwnDebtMon3 <- rbind(tblOwnDebtMon3, tblOwnDebtMon32)
tblOwnDebtMon3 <- reshape2::dcast(data=tblOwnDebtMon3, Race + State ~ OwnDebtMon3, value.var="Weight")
tblOwnDebtMon3$`Total weight` <- tblOwnDebtMon3$`$0` + tblOwnDebtMon3$`$1 to $99` + tblOwnDebtMon3$`$100 to $199` + tblOwnDebtMon3$`$200 to $299` + tblOwnDebtMon3$`$300 to $399` + tblOwnDebtMon3$`$400 to $499` + tblOwnDebtMon3$`$500 to $999` + tblOwnDebtMon3$`$1,000 or above`
tblOwnDebtMon3$`$0` <- tblOwnDebtMon3$`$0` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$1 to $99` <- tblOwnDebtMon3$`$1 to $99` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$100 to $199` <- tblOwnDebtMon3$`$100 to $199` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$200 to $299` <- tblOwnDebtMon3$`$200 to $299` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$300 to $399` <- tblOwnDebtMon3$`$300 to $399` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$400 to $499` <- tblOwnDebtMon3$`$400 to $499` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$500 to $999` <- tblOwnDebtMon3$`$500 to $999` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$1,000 or above` <- tblOwnDebtMon3$`$1,000 or above` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3 <- reshape2::melt(data=tblOwnDebtMon3, id.vars = c("Race", "State"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblOwnDebtMon3$variable <- factor(tblOwnDebtMon3$variable, levels = c("$1,000 or above", "$500 to $999", "$400 to $499", "$300 to $399", "$200 to $299", "$100 to $199", "$1 to $99", "$0"))
tblOwnDebtMon3$Race <- factor(tblOwnDebtMon3$Race, levels=rev(c("All", "White, Non-Hispanic", "Hispanic", "Black, Non-Hispanic", "Other, Non-Hispanic")))
```
#### Figure 10: CA borrowers
##### Responses to "Approximately how much is the total monthly payment that you are required to make on the loans from your education?"
```{r figure10A}
tblOwnDebtMon3.CA <- tblOwnDebtMon3 %>% filter(State=="CA")

tblOwnDebtMon3.CA$`For Tooltip` <- paste(
  "State: ", tblOwnDebtMon3.CA$State, '\n',
  "Group: ", tblOwnDebtMon3.CA$Race, '\n',
  "Monthly student debt payment: ", tblOwnDebtMon3.CA$variable, '\n',
  "Share of borrowers: ", percent(tblOwnDebtMon3.CA$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g10A <- ggplot(data=tblOwnDebtMon3.CA, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Monthly student debt payment", y="", x="Share of student loan borrowers in California") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g10A, width=800, height=350, tooltip="text")
```
#### Figure 10: Rest of U.S. borrowers
##### Responses to "Approximately how much is the total monthly payment that you are required to make on the loans from your education?"
```{r figure10B}
tblOwnDebtMon3.US <- tblOwnDebtMon3 %>% filter(State=="Rest of U.S.")

tblOwnDebtMon3.US$`For Tooltip` <- paste(
  "State: ", tblOwnDebtMon3.US$State, '\n',
  "Group: ", tblOwnDebtMon3.US$Race, '\n',
  "Monthly student debt payment: ", tblOwnDebtMon3.US$variable, '\n',
  "Share of borrowers: ", percent(tblOwnDebtMon3.US$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g10A <- ggplot(data=tblOwnDebtMon3.US, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Monthly student debt payment", y="", x="Share of student loan borrowers in rest of U.S.") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g10A, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 10 are
```{r OwnDebtMon3.SY, results = 'asis'}
survey_years(shed.OwnDebtMon3$SurveyYear)
```
Survey responses collected in 2020 and 2021 are not included due to the federal student loan repayment pause.

**Notes:** Due to smaller sample size, interpret results with caution. See the table below for the survey respondent sample size by subgroup. 
```{r OwnDebtMon3.N}
N.OwnDebtMon3 <- aggregate(data=shed.OwnDebtMon3, Count ~ Race + State, FUN=sum)
names(N.OwnDebtMon3) <- c("Group", "State", "Survey respondents")
kable(N.OwnDebtMon3, caption="N size by group for Figure 10") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Whether or not a borrower is behind on their education loans is one indication of their financial well-being and ability to repay their loans. Figure 11 shows that, compared to the rest of the U.S., more borrowers in California are behind or in collections, at 21.5 percent versus 17.3 percent nationwide. Almost one-third (32.6 percent) of Hispanic California borrowers report being behind, followed by Black California borrowers (26.7 percent). These are double the share for white California borrowers (13.4 percent).

For Figure 11, I excluded survey responses from 2020 and 2021 due to the federal student loan payment pause and forbearance period. 

### {.tabset}
#### Figure 11
```{r OwnDebtBehind}
# OwnDebtBehind: # Are you behind on payments or in collections for one or more of the loans from your own education? 

# table(shed$OwnDebtBehind)
shed.OwnDebtBehind <- shed %>% filter((OwnDebtBehind %in% c("Not In Universe (not asked)", "Refused", "", NA))==FALSE) %>% filter(SurveyYear %in% c(2015, 2016, 2017, 2018, 2019))
tblOwnDebtBehind <- aggregate(data=shed.OwnDebtBehind, Weight ~ OwnDebtBehind + Race + State, FUN=sum)
tblOwnDebtBehind2 <- aggregate(data=shed.OwnDebtBehind, Weight ~ OwnDebtBehind + State, FUN=sum)
tblOwnDebtBehind2$Race <- rep("All", nrow(tblOwnDebtBehind2))
tblOwnDebtBehind <- rbind(tblOwnDebtBehind, tblOwnDebtBehind2)
tblOwnDebtBehind <- reshape2::dcast(data=tblOwnDebtBehind, Race + State ~ OwnDebtBehind, value.var="Weight")
tblOwnDebtBehind$`Share of borrowers behind on payments` <- tblOwnDebtBehind$Yes / (tblOwnDebtBehind$Yes + tblOwnDebtBehind$No)
```
##### Responses to "Are you behind on payments or in collections for one or more of the loans from your own education?"
```{r figure11}
tblOwnDebtBehind$`For Tooltip` <- paste(
  "State: ", tblOwnDebtBehind$State, '\n',
  "Group: ", tblOwnDebtBehind$Race, '\n',
  "Share of borrowers: ", percent(tblOwnDebtBehind$`Share of borrowers behind on payments`, accuracy=0.1), 
  sep=""
)

g11 <- ggplot(data=tblOwnDebtBehind, mapping=aes(y=Race, x=`Share of borrowers behind on payments`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g11, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 11 are
```{r OwnDebtBehind.SY, results = 'asis'}
survey_years(shed.OwnDebtBehind$SurveyYear)
```
Survey responses collected in 2020 and 2021 are not included due to the federal student loan repayment pause. 

**Notes:** Due to smaller sample size, interpret results with caution. See the table below for the survey respondent sample size by subgroup.
```{r OwnDebtBehind.N}
N.OwnDebtBehind <- aggregate(data=shed.OwnDebtBehind, Count ~ Race + State, FUN=sum)
names(N.OwnDebtBehind) <- c("Group", "State", "Survey respondents")
kable(N.OwnDebtBehind, caption="N size by group for Figure 11") %>% kable_paper("hover", full_width = F)
```

***

### {-}

A SHED survey respondent can also owe debt that was used for their spouse or partner's education, or for the education of their child or grandchild. Figure 12 shows this with one tab for each type of debt. 

Overall, about 6 percent of respondents had debt for their spouse, in California and the rest of the U.S. alike. The highest share is among Black California respondents at 11 percent, well above all other groups. 

Around 7.5 percent of respondents had debt for a child or grandchild's education, both in California and the rest of the U.S. Hispanic California respondents reported having this debt most often at 10.5 percent. 

### {.tabset}
#### Figure 12: Debt for spouse's or partner's education
```{r SpouseDebt}
# SpouseDebt: # Do you currently owe any money used to pay for your [spouse/ partner]'s education?

# table(shed$SpouseDebt)
shed.SpouseDebt <- shed %>% filter((SpouseDebt %in% c("Not In Universe (not asked)", "Refused", "", NA))==FALSE) 
tblSpouseDebt <- aggregate(data=shed.SpouseDebt, Weight ~ SpouseDebt + Race + State, FUN=sum)
tblSpouseDebt2 <- aggregate(data=shed.SpouseDebt, Weight ~ SpouseDebt + State, FUN=sum)
tblSpouseDebt2$Race <- rep("All", nrow(tblSpouseDebt2))
tblSpouseDebt <- rbind(tblSpouseDebt, tblSpouseDebt2)
tblSpouseDebt <- reshape2::dcast(data=tblSpouseDebt, Race + State ~ SpouseDebt, value.var="Weight")
tblSpouseDebt$`Share who have debt for a partner or spouse's education` <- tblSpouseDebt$Yes / (tblSpouseDebt$Yes + tblSpouseDebt$No)
```
##### Responses to "Do you currently owe any money used to pay for your [spouse/ partner]'s education?"
```{r figure12A}
tblSpouseDebt$`For Tooltip` <- paste(
  "State: ", tblSpouseDebt$State, '\n',
  "Group: ", tblSpouseDebt$Race, '\n',
  "Share with debt for a partner or spouse's education: ", percent(tblSpouseDebt$`Share who have debt for a partner or spouse's education`, accuracy=0.1),
  sep=""
)

g12A <- ggplot(data=tblSpouseDebt, mapping=aes(y=Race, x=`Share who have debt for a partner or spouse's education`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 0.2)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g12A, height=350, tooltip="text")
```
#### Figure 12: Debt for child's or grandchild's education
```{r ChildDebt}
# ChildDebt: # Do you currently owe any money used to pay for your child or grandchild’s education?

# table(shed$ChildDebt)
shed.ChildDebt <- shed %>% filter((ChildDebt %in% c("Not In Universe (not asked)", "Do not have children or grandchildren", "Refused", "", NA))==FALSE) 
tblChildDebt <- aggregate(data=shed.ChildDebt, Weight ~ ChildDebt + Race + State, FUN=sum)
tblChildDebt2 <- aggregate(data=shed.ChildDebt, Weight ~ ChildDebt + State, FUN=sum)
tblChildDebt2$Race <- rep("All", nrow(tblChildDebt2))
tblChildDebt <- rbind(tblChildDebt, tblChildDebt2)
tblChildDebt <- reshape2::dcast(data=tblChildDebt, Race + State ~ ChildDebt, value.var="Weight")
tblChildDebt$`Share who have debt for a child's or grandchild's education` <- tblChildDebt$Yes / (tblChildDebt$Yes + tblChildDebt$No)
```
##### Responses to "Do you currently owe any money used to pay for your child or grandchild’s education?"
```{r figure12B}
tblChildDebt$`For Tooltip` <- paste(
  "State: ", tblChildDebt$State, '\n',
  "Group: ", tblChildDebt$Race, '\n',
  "Share with debt for a partner or spouse's education: ", percent(tblChildDebt$`Share who have debt for a child's or grandchild's education`, accuracy=0.1),
  sep=""
)

g12B <- ggplot(data=tblChildDebt, mapping=aes(y=Race, x=`Share who have debt for a child's or grandchild's education`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 0.2)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g12B, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 12 are
```{r SpouseDebt.SY, results = 'asis'}
survey_years(shed.SpouseDebt$SurveyYear)
# I have checked and verified that both verions of Figure 12 use the same survey years. 
```

**Notes:** Figure 12 includes all respondents, not just those who have student debt for their own education. "Figure 12: Debt for spouse's or partner's education" does not include survey respondents without a spouse or partner. "Figure 12: Debt for child or grandchild's education" does not include survey respondents without children or grandchildren. See the tables below for the survey respondent sample size by subgroup.
```{r SpouseDebt.N}
N.SpouseDebt <- aggregate(data=shed.SpouseDebt, Count ~ Race + State, FUN=sum)
names(N.SpouseDebt) <- c("Group", "State", "Survey respondents")
kable(N.SpouseDebt, caption="N size by group for Figure 12: Debt for spouse's or partner's education") %>% kable_paper("hover", full_width = F)
```

```{r ChildDebt.N}
N.ChildDebt <- aggregate(data=shed.ChildDebt, Count ~ Race + State, FUN=sum)
names(N.ChildDebt) <- c("Group", "State", "Survey respondents")
kable(N.ChildDebt, caption="N size by group for Figure 12: Debt for child's or grandchild's education") %>% kable_paper("hover", full_width = F)
```

***

### {-}

For Figures 13 onward, we focus on respondents who had any student loan debt, be it debt for the respondent's own education, their spouse or partner's, or their child or grandchild's. These graphs will distinguish between borrowers and non-borrowers, except when the variable we are examining is only answered by student loan borrowers (e.g. their confidence in paying their next student loan bill). Most graphs will use borrowers in the rest of the U.S., as well as non-borrowers in California, for comparison against California student loan borrowers. 

Figure 13 examines the educational attainment of borrowers. In California, Hispanic borrowers (53.6 percent) and Black borrowers (43.5 percent) are the most likely to have less than a college degree. For most groups, California's student loan borrowers have a higher educational attainment than those in the rest of the U.S. Predictably, student loan borrowers in California and the rest of the U.S. alike have higher educational attainment than California's non-borrowers. 

Roughly 12 percent of California's student loan borrowers have only a high school degree, GED, or less. This is most commonly true of Hispanic (22 percent) and  Black (10 percent) student loan borrowers. When we discuss issues affecting student loan borrowers, it is important to remember that some borrowers who hold debt for a child's or spouse's education never went to college themselves at all and do not reap the economic rewards of that education.

This figure also includes a special tab for parents, examining the education levels of parents who hold student loan debt for their child's education. Respondents who are not parents are not included in that tab. 

### {.tabset}
```{r EdAttain}
# EdAttain: # What is the highest level of school you have completed or the highest degree you have received? 

# table(shed$EdAttain)
shed.EdAttain <- shed %>% filter(is.na(EdAttain)==FALSE)
tblEdAttain <- aggregate(data=shed.EdAttain, Weight ~ EdAttain + Race + State + AnyStudentLoans, FUN=sum)
tblEdAttain2 <- aggregate(data=shed.EdAttain, Weight ~ EdAttain + State + AnyStudentLoans, FUN=sum)
tblEdAttain2$Race <- rep("All", nrow(tblEdAttain2))
tblEdAttain <- rbind(tblEdAttain, tblEdAttain2)
tblEdAttain <- reshape2::dcast(data=tblEdAttain, Race + State + AnyStudentLoans ~ EdAttain, value.var="Weight")
tblEdAttain$`Total weight` <- tblEdAttain$`Associate degree` + tblEdAttain$`Bachelor's degree` + tblEdAttain$`Doctorate` + tblEdAttain$`High school degree or GED` + tblEdAttain$`Less than high school diploma` + tblEdAttain$`Master's degree` + tblEdAttain$`Professional degree` + tblEdAttain$`Some college, no degree`
tblEdAttain$`Associate degree` <- tblEdAttain$`Associate degree` / tblEdAttain$`Total weight`
tblEdAttain$`Bachelor's degree` <- tblEdAttain$`Bachelor's degree` / tblEdAttain$`Total weight`
tblEdAttain$`Doctorate` <- tblEdAttain$`Doctorate` / tblEdAttain$`Total weight`
tblEdAttain$`High school degree or GED` <- tblEdAttain$`High school degree or GED` / tblEdAttain$`Total weight`
tblEdAttain$`Less than high school diploma` <- tblEdAttain$`Less than high school diploma` / tblEdAttain$`Total weight`
tblEdAttain$`Master's degree` <- tblEdAttain$`Master's degree` / tblEdAttain$`Total weight`
tblEdAttain$`Professional degree` <- tblEdAttain$`Professional degree` / tblEdAttain$`Total weight`
tblEdAttain$`Some college, no degree` <- tblEdAttain$`Some college, no degree` / tblEdAttain$`Total weight`
tblEdAttain <- reshape2::melt(data=tblEdAttain, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblEdAttain$variable <- factor(tblEdAttain$variable, levels = c("Doctorate", "Professional degree", "Master's degree", "Bachelor's degree", "Associate degree", "Some college, no degree", "High school degree or GED", "Less than high school diploma"))
```
#### Figure 13: CA borrowers
##### Responses to "What is the highest level of school you have completed or the highest degree you have received?" 
```{r figure13A}
tblEdAttain.CA.Borrow <- tblEdAttain %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblEdAttain.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblEdAttain.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblEdAttain.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblEdAttain.CA.Borrow$Group, '\n',
  "Highest level of education: ", tblEdAttain.CA.Borrow$variable, '\n',
  "Share: ", percent(tblEdAttain.CA.Borrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g13A <- ggplot(data=tblEdAttain.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Highest level of education", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g13A, width=800, height=350, tooltip="text")
```
#### Figure 13: Rest of U.S. borrowers
##### Responses to "What is the highest level of school you have completed or the highest degree you have received?"
```{r figure13B}
tblEdAttain.US.Borrow <- tblEdAttain %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblEdAttain.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblEdAttain.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblEdAttain.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblEdAttain.US.Borrow$Group, '\n',
  "Highest level of education: ", tblEdAttain.US.Borrow$variable, '\n',
  "Share: ", percent(tblEdAttain.US.Borrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g13B <- ggplot(data=tblEdAttain.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Highest level of education", x="Share of student loan borrowers in the rest of the U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g13B, width=800, height=350, tooltip="text")
```
#### Figure 13: CA non-borrowers
##### Responses to "What is the highest level of school you have completed or the highest degree you have received?"
```{r figure13C}
tblEdAttain.CA.Nonborrow <- tblEdAttain %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblEdAttain.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblEdAttain.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblEdAttain.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblEdAttain.CA.Nonborrow$Group, '\n',
  "Highest level of education: ", tblEdAttain.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblEdAttain.CA.Nonborrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g13C <- ggplot(data=tblEdAttain.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Highest level of education", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g13C, width=800, height=350, tooltip="text")
```
#### Figure 13: Parents
##### Responses to "What is the highest level of school you have completed or the highest degree you have received?"
```{r figure13D}
shed$EdAttain0 <- shed$EdAttain

shed.EdAttain0 <- shed %>% filter(is.na(EdAttain0)==FALSE) %>% filter((ChildDebt %in% c("Refused", "Not In Universe (not asked)", "Do not have children or grandchildren", ""))==FALSE)
tblEdAttain0 <- aggregate(data=shed.EdAttain0, Weight ~ EdAttain0 + ChildDebt + State, FUN=sum)
tblEdAttain0 <- reshape2::dcast(data=tblEdAttain0, State + ChildDebt ~ EdAttain0, value.var="Weight")
tblEdAttain0$`Total weight` <- tblEdAttain0$`Associate degree` + tblEdAttain0$`Bachelor's degree` + tblEdAttain0$`Doctorate` + tblEdAttain0$`High school degree or GED` + tblEdAttain0$`Less than high school diploma` + tblEdAttain0$`Master's degree` + tblEdAttain0$`Professional degree` + tblEdAttain0$`Some college, no degree`
tblEdAttain0$`Associate degree` <- tblEdAttain0$`Associate degree` / tblEdAttain0$`Total weight`
tblEdAttain0$`Bachelor's degree` <- tblEdAttain0$`Bachelor's degree` / tblEdAttain0$`Total weight`
tblEdAttain0$`Doctorate` <- tblEdAttain0$`Doctorate` / tblEdAttain0$`Total weight`
tblEdAttain0$`High school degree or GED` <- tblEdAttain0$`High school degree or GED` / tblEdAttain0$`Total weight`
tblEdAttain0$`Less than high school diploma` <- tblEdAttain0$`Less than high school diploma` / tblEdAttain0$`Total weight`
tblEdAttain0$`Master's degree` <- tblEdAttain0$`Master's degree` / tblEdAttain0$`Total weight`
tblEdAttain0$`Professional degree` <- tblEdAttain0$`Professional degree` / tblEdAttain0$`Total weight`
tblEdAttain0$`Some college, no degree` <- tblEdAttain0$`Some college, no degree` / tblEdAttain0$`Total weight`
tblEdAttain0 <- reshape2::melt(data=tblEdAttain0, id.vars = c("State", "ChildDebt"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblEdAttain0$variable <- factor(tblEdAttain0$variable, levels = c("Doctorate", "Professional degree", "Master's degree", "Bachelor's degree", "Associate degree", "Some college, no degree", "High school degree or GED", "Less than high school diploma"))

tblEdAttain0$Group <- rep(NA, nrow(tblEdAttain0))
tblEdAttain0$Group[(tblEdAttain0$ChildDebt=="Yes") & (tblEdAttain0$State=="CA")] <- "California parent-borrowers"
tblEdAttain0$Group[(tblEdAttain0$ChildDebt=="No") & (tblEdAttain0$State=="CA")] <- "Other California parents"
tblEdAttain0$Group[(tblEdAttain0$ChildDebt=="Yes") & (tblEdAttain0$State=="Rest of U.S.")] <- "Rest of U.S. parent-borrowers"
tblEdAttain0 <- tblEdAttain0 %>% filter(is.na(Group)==FALSE)

tblEdAttain0$`For Tooltip` <- paste(
  "State: ", tblEdAttain0$State, '\n',
  "Parent-borrowers: ", tblEdAttain0$AnyStudentLoans, '\n',
  "Group: ", tblEdAttain0$Group, '\n',
  "Highest level of education: ", tblEdAttain0$variable, '\n',
  "Share: ", percent(tblEdAttain0$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g13D <- ggplot(data=tblEdAttain0, mapping=aes(y=Group, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Highest level of education", x="Share of parents", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g13D, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 13 are
```{r EdAttain.SY, results = 'asis'}
survey_years(shed.EdAttain$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r EdAttain.N1}
N.EdAttain1 <- aggregate(data=shed.EdAttain, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.EdAttain1 <- N.EdAttain1 %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.EdAttain1) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.EdAttain1, caption="N size by group for Figure 13") %>% kable_paper("hover", full_width = F)
```

```{r EdAttain.N0}
N.EdAttain2 <- aggregate(data=shed.EdAttain0, Count ~ State + ChildDebt, FUN=sum)
N.EdAttain2 <- N.EdAttain2 %>% filter(State=="CA" | ChildDebt=="Yes")
names(N.EdAttain2) <- c("State", "Parent-borrower", "Survey respondents")
kable(N.EdAttain2, caption="N size by group for Figure 13: Parents") %>% kable_paper("hover", full_width = F)
```
***

### {-}

Figure 14 shows a concerning pattern in home ownership among California student loan borrowers. Fewer than 1 in 4 Black California student loan borrowers owns a home, which is well below all other groups in California *or* the rest of the U.S., borrowers and non-borrowers alike. 

In general, student loan borrowers own a home less often than do non-borrowers. In California, 41.3 percent of borrowers own their home compared to 57.0 percent of non-borrowers. The younger average age of student loan borrowers may be a factor, although people may be less inclined to buy a home when they hold outstanding student loans. 

### {.tabset}
```{r HomeOwn}
# HomeOwn: # Do you own your home?

# table(shed$HomeOwn)
shed.HomeOwn <- shed %>% filter(is.na(HomeOwn)==FALSE) %>% filter(HomeOwn != "Refused") %>% filter(HomeOwn != "NA") 
tblHomeOwn <- aggregate(data=shed.HomeOwn, Weight ~ HomeOwn + Race + State + AnyStudentLoans, FUN=sum)
tblHomeOwn2 <- aggregate(data=shed.HomeOwn, Weight ~ HomeOwn + State + AnyStudentLoans, FUN=sum)
tblHomeOwn2$Race <- rep("All", nrow(tblHomeOwn2))
tblHomeOwn <- rbind(tblHomeOwn, tblHomeOwn2)
tblHomeOwn <- reshape2::dcast(data=tblHomeOwn, Race + State + AnyStudentLoans ~ HomeOwn, value.var="Weight")
tblHomeOwn$`Total weight` <- tblHomeOwn$`Own home with a mortgage or loan` + tblHomeOwn$`Own home free and clear` + tblHomeOwn$`Pay rent` + tblHomeOwn$`Other`
tblHomeOwn$`Own home with a mortgage or loan` <- tblHomeOwn$`Own home with a mortgage or loan` / tblHomeOwn$`Total weight`
tblHomeOwn$`Own home free and clear` <- tblHomeOwn$`Own home free and clear` / tblHomeOwn$`Total weight`
tblHomeOwn$`Pay rent` <- tblHomeOwn$`Pay rent` / tblHomeOwn$`Total weight`
tblHomeOwn$`Other` <- tblHomeOwn$`Other` / tblHomeOwn$`Total weight`
tblHomeOwn <- reshape2::melt(data=tblHomeOwn, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblHomeOwn$variable <- factor(tblHomeOwn$variable, levels = c("Own home free and clear", "Own home with a mortgage or loan", "Pay rent", "Other"))
```

```{r ForPolicyReport1, eval=FALSE}
# Chart on home ownership

shed.HomeOwn$`Owns home` <- rep("No", nrow(shed.HomeOwn))
shed.HomeOwn$`Owns home`[shed.HomeOwn$HomeOwn %in% c("Own home free and clear", "Own home with a mortgage or loan")] <- "Yes"
tblHomeOwn0 <- aggregate(data=shed.HomeOwn, Weight ~ `Owns home` + Race + State + AnyStudentLoans, FUN=sum)
tblHomeOwn02 <- aggregate(data=shed.HomeOwn, Weight ~ `Owns home` + State + AnyStudentLoans, FUN=sum)
tblHomeOwn02$Race <- rep("All", nrow(tblHomeOwn02))
tblHomeOwn0 <- rbind(tblHomeOwn0, tblHomeOwn02)
tblHomeOwn0 <- reshape2::dcast(data=tblHomeOwn0, Race + State + AnyStudentLoans ~ `Owns home`, value.var="Weight")
tblHomeOwn0$`Total weight` <- tblHomeOwn0$Yes + tblHomeOwn0$No
tblHomeOwn0$`Share who own home` <- tblHomeOwn0$Yes / tblHomeOwn0$`Total weight`
tblHomeOwn0 <- tblHomeOwn0 %>% filter(AnyStudentLoans=="Yes")

tblHomeOwn0 <- tblHomeOwn0 %>% filter(Race != "Other, Non-Hispanic")
tblHomeOwn0$Race <- as.factor(tblHomeOwn0$Race)
tblHomeOwn0$Race <- factor(tblHomeOwn0$Race, levels=c("All", "White, Non-Hispanic", "Hispanic", "Black, Non-Hispanic"))

ggplot(data=tblHomeOwn0, mapping=aes(y=`Share who own home`, x=Race, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.5) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) + labs(y="Share", x="Group", title="Share of student loan borrowers who own their home") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols2)

```

#### Figure 14: CA borrowers
##### Responses to "Do you own your home?"
```{r figure14A, warning=FALSE}
tblHomeOwn.CA.Borrow <- tblHomeOwn %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes") 

tblHomeOwn.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblHomeOwn.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblHomeOwn.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblHomeOwn.CA.Borrow$Race, '\n',
  "Home ownership status: ", tblHomeOwn.CA.Borrow$variable, '\n',
  "Share: ", percent(tblHomeOwn.CA.Borrow$`Share of borrowers`, accuracy=0.1), 
  sep=""
)

g14A <- ggplot(data=tblHomeOwn.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Home ownership status", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g14A, width=800, height=350, tooltip="text")
```
#### Figure 14: Rest of U.S. borrowers
##### Responses to "Do you own your home?"
```{r figure14B, warning=FALSE}
tblHomeOwn.US.Borrow <- tblHomeOwn %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes") 

tblHomeOwn.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblHomeOwn.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblHomeOwn.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblHomeOwn.US.Borrow$Race, '\n',
  "Home ownership status: ", tblHomeOwn.US.Borrow$variable, '\n',
  "Share: ", percent(tblHomeOwn.US.Borrow$`Share of borrowers`, accuracy=0.1), 
  sep=""
)

g14B <- ggplot(data=tblHomeOwn.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Home ownership status", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g14B, width=800, height=350, tooltip="text")
```
#### Figure 14: CA non-borrowers
##### Responses to "Do you own your home?"
```{r figure14C, warning=FALSE}
tblHomeOwn.CA.Nonborrow <- tblHomeOwn %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No") 

tblHomeOwn.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblHomeOwn.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblHomeOwn.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblHomeOwn.CA.Nonborrow$Race, '\n',
  "Home ownership status: ", tblHomeOwn.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblHomeOwn.CA.Nonborrow$`Share of borrowers`, accuracy=0.1), 
  sep=""
)

g14C <- ggplot(data=tblHomeOwn.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Home ownership status", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g14C, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 14 are
```{r HomeOwn.SY, results = 'asis'}
survey_years(shed.HomeOwn$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r HomeOwn.N}
N.HomeOwn <- aggregate(data=shed.HomeOwn, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.HomeOwn <- N.HomeOwn %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.HomeOwn) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.HomeOwn, caption="N size by group for Figure 14") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Long-term credit card debt is a major factor in the financial lives of many student loan borrowers. Figure 8 showed that almost a quarter of Californians with education debt see that debt take the form of credit card debt, most especially for Black borrowers.  

Figure 15 shows that 62.3 percent of California student loan borrowers have outstanding unpaid credit card debt. Black (80.1 percent) and Hispanic (70.3 percent) California student loan borrowers show the highest rates of holding this high-interest, month-over-month debt. When credit card debt hangs over student loan borrowers, it puts yet another obstacle between them and student loan repayment. 

### {.tabset}
```{r UnpaidCC}
# UnpaidCC: # Do you currently have any outstanding unpaid credit card debt?

# table(shed$UnpaidCC)
shed.UnpaidCC <- shed %>% filter((UnpaidCC %in% c("Refused", "Not In Universe (not asked)", NA)==FALSE)) 
tblUnpaidCC <- aggregate(data=shed.UnpaidCC, Weight ~ UnpaidCC + Race + State + AnyStudentLoans, FUN=sum)
tblUnpaidCC2 <- aggregate(data=shed.UnpaidCC, Weight ~ UnpaidCC + State + AnyStudentLoans, FUN=sum)
tblUnpaidCC2$Race <- rep("All", nrow(tblUnpaidCC2))
tblUnpaidCC <- rbind(tblUnpaidCC, tblUnpaidCC2)
tblUnpaidCC <- reshape2::dcast(data=tblUnpaidCC, Race + State + AnyStudentLoans ~ UnpaidCC, value.var="Weight")
tblUnpaidCC$`Share with unpaid credit card debt` <- tblUnpaidCC$Yes / (tblUnpaidCC$Yes + tblUnpaidCC$No)
tblUnpaidCC$Group <- rep(NA, nrow(tblUnpaidCC))
tblUnpaidCC$Group[tblUnpaidCC$State=="CA" & tblUnpaidCC$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblUnpaidCC$Group[tblUnpaidCC$State=="Rest of U.S." & tblUnpaidCC$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblUnpaidCC$Group[tblUnpaidCC$State=="CA" & tblUnpaidCC$AnyStudentLoans=="No"] <- "California non-borrowers"
tblUnpaidCC <- tblUnpaidCC %>% filter(is.na(Group)==FALSE)
tblUnpaidCC$Group <- factor(tblUnpaidCC$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
#### Figure 15
##### Responses to "Do you currently have any outstanding unpaid credit card debt?"
```{r figure15A}
tblUnpaidCC$`For Tooltip` <- paste(
  "State: ", tblUnpaidCC$State, '\n',
  "Student loan borrowers: ", tblUnpaidCC$AnyStudentLoans, '\n',
  "Group: ", tblUnpaidCC$Race, '\n',
  "Share with unpaid credit card debt: ", percent(tblUnpaidCC$`Share with unpaid credit card debt`, accuracy=0.1),
  sep=""
)

g15 <- ggplot(data=tblUnpaidCC, mapping=aes(y=Race, x=`Share with unpaid credit card debt`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share with outstanding credit card debt", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g15, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 15 are
```{r UnpaidCC.SY, results = 'asis'}
survey_years(shed.UnpaidCC$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r UnpaidCC.N}
N.UnpaidCC <- aggregate(data=shed.UnpaidCC, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.UnpaidCC <- N.UnpaidCC %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.UnpaidCC) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.UnpaidCC, caption="N size by group for Figure 15") %>% kable_paper("hover", full_width = F)
```


***

### {-}

Figure 16 further explores California student loan borrowers' difficulty escaping credit card debt: overall, 40.9 percent say that they carry an unpaid balance "Most or all of the time," which is almost identical to the rate for student loan borrowers in the rest of the U.S. However, this rises to a staggering 62.1 percent for Black California student loan borrowers. The gap between Black borrowers and white borrowers is much smaller (4.8 percentage points) in the rest of the U.S. than in California (26.6 percentage points). 

The Black-white gap is mirrored in the rest of the California population (17.5 percentage points) but is still not as extreme as it is for student loan borrowers in the state. 

Figure 16 also contains tabs for (1) parents and (2) borrowers with graduate degrees and student loans. 

### {.tabset}
```{r CCBalance}
# CCBalance: # In the past 12 months, how frequently have you carried an unpaid balance on one or more of your credit cards? 

# table(shed$CCBalance)
shed.CCBalance <- shed %>% filter(is.na(CCBalance)==FALSE) %>% filter((CCBalance %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblCCBalance <- aggregate(data=shed.CCBalance, Weight ~ CCBalance + Race + State + AnyStudentLoans, FUN=sum)
tblCCBalance2 <- aggregate(data=shed.CCBalance, Weight ~ CCBalance + State + AnyStudentLoans, FUN=sum)
tblCCBalance2$Race <- rep("All", nrow(tblCCBalance2))
tblCCBalance <- rbind(tblCCBalance, tblCCBalance2)
tblCCBalance <- reshape2::dcast(data=tblCCBalance, Race + State + AnyStudentLoans ~ CCBalance, value.var="Weight")
tblCCBalance$`Total weight` <- tblCCBalance$`Always pay in full` + tblCCBalance$`Most or all of the time` + tblCCBalance$`Some of the time` + tblCCBalance$`Once`
tblCCBalance$`Always pay in full` <- tblCCBalance$`Always pay in full` / tblCCBalance$`Total weight`
tblCCBalance$`Most or all of the time` <- tblCCBalance$`Most or all of the time` / tblCCBalance$`Total weight`
tblCCBalance$`Some of the time` <- tblCCBalance$`Some of the time` / tblCCBalance$`Total weight`
tblCCBalance$`Once` <- tblCCBalance$`Once` / tblCCBalance$`Total weight`
tblCCBalance0 <- tblCCBalance # For the "forPolicyReport4 chunk"
tblCCBalance <- reshape2::melt(data=tblCCBalance, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblCCBalance$variable <- factor(tblCCBalance$variable, levels = c("Most or all of the time", "Some of the time", "Once", "Always pay in full"))
```

```{r forPolicyReport4, eval=FALSE}
tblCCBalance0 <- tblCCBalance0 %>% filter(Race != "Other, Non-Hispanic") %>% filter(Race != "All") %>% filter(State == "CA" | AnyStudentLoans == "Yes") 
tblCCBalance0$Group <- rep(NA, nrow(tblCCBalance0))
tblCCBalance0$Group[(tblCCBalance0$State=="CA") & (tblCCBalance0$AnyStudentLoans=="Yes")] <- "California borrowers"
tblCCBalance0$Group[(tblCCBalance0$State=="Rest of U.S.") & (tblCCBalance0$AnyStudentLoans=="Yes")] <- "Rest of U.S. borrowers"
tblCCBalance0$Group[(tblCCBalance0$State=="CA") & (tblCCBalance0$AnyStudentLoans=="No")] <- "California non-borrowers"

tblCCBalance0$Group <- as.factor(tblCCBalance0$Group)
tblCCBalance0$Group <- factor(tblCCBalance0$Group, levels=rev(c("California borrowers", "Rest of U.S. borrowers", "California non-borrowers")))

ggplot(data=tblCCBalance0, mapping=aes(y=Group, x=`Most or all of the time`, fill=Group)) + geom_bar(stat="identity") + facet_wrap(Race ~ ., ncol=1, strip.position=c("top")) + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share who say they carry an unpaid credit card balance most or all of the time", y="") + theme(legend.position="none", text=element_text(family="Optima")) + scale_fill_manual(values = flagCols2)
```
#### Figure 16: CA borrowers
##### Responses to "In the past 12 months, how frequently have you carried an unpaid balance on one or more of your credit cards?"
```{r figure16A}
tblCCBalance.CA.Borrow <- tblCCBalance %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblCCBalance.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblCCBalance.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblCCBalance.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblCCBalance.CA.Borrow$Race, '\n',
  "Frequency of unpaid balance: ", tblCCBalance.CA.Borrow$variable, '\n',
  "Share: ", percent(tblCCBalance.CA.Borrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g16A <- ggplot(data=tblCCBalance.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g16A, width=800, height=350, tooltip="text")
```
#### Figure 16: Rest of U.S. borrowers
##### Responses to "In the past 12 months, how frequently have you carried an unpaid balance on one or more of your credit cards?"
```{r figure16B}
tblCCBalance.US.Borrow <- tblCCBalance %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblCCBalance.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblCCBalance.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblCCBalance.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblCCBalance.US.Borrow$Race, '\n',
  "Frequency of unpaid balance: ", tblCCBalance.US.Borrow$variable, '\n',
  "Share: ", percent(tblCCBalance.US.Borrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g16B <- ggplot(data=tblCCBalance.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g16B, width=800, height=350, tooltip="text")
```
#### Figure 16: CA non-borrowers
##### Responses to "In the past 12 months, how frequently have you carried an unpaid balance on one or more of your credit cards?"
```{r figure16C}
tblCCBalance.CA.Nonborrow <- tblCCBalance %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblCCBalance.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblCCBalance.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblCCBalance.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblCCBalance.CA.Nonborrow$Race, '\n',
  "Frequency of unpaid balance: ", tblCCBalance.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblCCBalance.CA.Nonborrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g16C <- ggplot(data=tblCCBalance.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g16C, width=800, height=350, tooltip="text")
```
#### Figure 16: Parents
##### Responses to "In the past 12 months, how frequently have you carried an unpaid balance on one or more of your credit cards?"
```{r figure16D}
shed$CCBalance0 <- shed$CCBalance

shed.CCBalance0 <- shed %>% filter(is.na(CCBalance0)==FALSE) %>% filter((CCBalance0 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) %>% filter((ChildDebt %in% c("Do not have children or grandchildren", "", "Refused", "Not In Universe (not asked)"))==FALSE) 
tblCCBalance0 <- aggregate(data=shed.CCBalance0, Weight ~ CCBalance0 + State + ChildDebt, FUN=sum)
tblCCBalance0 <- reshape2::dcast(data=tblCCBalance0, State + ChildDebt ~ CCBalance0, value.var="Weight")
tblCCBalance0$`Total weight` <- tblCCBalance0$`Always pay in full` + tblCCBalance0$`Most or all of the time` + tblCCBalance0$`Some of the time` + tblCCBalance0$`Once`
tblCCBalance0$`Always pay in full` <- tblCCBalance0$`Always pay in full` / tblCCBalance0$`Total weight`
tblCCBalance0$`Most or all of the time` <- tblCCBalance0$`Most or all of the time` / tblCCBalance0$`Total weight`
tblCCBalance0$`Some of the time` <- tblCCBalance0$`Some of the time` / tblCCBalance0$`Total weight`
tblCCBalance0$`Once` <- tblCCBalance0$`Once` / tblCCBalance0$`Total weight`
tblCCBalance0 <- reshape2::melt(data=tblCCBalance0, id.vars = c("State", "ChildDebt"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblCCBalance0$variable <- factor(tblCCBalance0$variable, levels = c("Most or all of the time", "Some of the time", "Once", "Always pay in full"))

tblCCBalance0$Group <- rep(NA, nrow(tblCCBalance0))
tblCCBalance0$Group[(tblCCBalance0$State=="CA") & (tblCCBalance0$ChildDebt=="Yes")] <- "California parent-borrowers"
tblCCBalance0$Group[(tblCCBalance0$State=="CA") & (tblCCBalance0$ChildDebt=="No")] <- "Other California parents"
tblCCBalance0$Group[(tblCCBalance0$State=="Rest of U.S.") & (tblCCBalance0$ChildDebt=="Yes")] <- "Rest of U.S. parent-borrowers"
tblCCBalance0 <- tblCCBalance0 %>% filter(State=="CA" | ChildDebt=="Yes")

tblCCBalance0$`For Tooltip` <- paste(
  "State: ", tblCCBalance0$State, '\n',
  "Parent-borrowers: ", tblCCBalance0$ChildDebt, '\n',
  "Group: ", tblCCBalance0$Group, '\n',
  "Frequency of unpaid balance: ", tblCCBalance0$variable, '\n',
  "Share: ", percent(tblCCBalance0$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g16D <- ggplot(data=tblCCBalance0, mapping=aes(y=Group, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of parents", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g16D, width=800, height=350, tooltip="text")
```
#### Figure 16: Graduate degee holders
##### Responses to "In the past 12 months, how frequently have you carried an unpaid balance on one or more of your credit cards?"
```{r figure16E}
shed$CCBalance1 <- shed$CCBalance

shed.CCBalance1 <- shed %>% filter(is.na(CCBalance1)==FALSE) %>% filter((CCBalance1 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) %>% filter(EdAttain %in% c("Master's degree", "Doctorate", "Professional degree")) %>% filter(OwnDebtSL=="Yes")
tblCCBalance1 <- aggregate(data=shed.CCBalance1, Weight ~ CCBalance1 + State, FUN=sum)
tblCCBalance1 <- reshape2::dcast(data=tblCCBalance1, State ~ CCBalance1, value.var="Weight")
tblCCBalance1$`Total weight` <- tblCCBalance1$`Always pay in full` + tblCCBalance1$`Most or all of the time` + tblCCBalance1$`Some of the time` + tblCCBalance1$`Once`
tblCCBalance1$`Always pay in full` <- tblCCBalance1$`Always pay in full` / tblCCBalance1$`Total weight`
tblCCBalance1$`Most or all of the time` <- tblCCBalance1$`Most or all of the time` / tblCCBalance1$`Total weight`
tblCCBalance1$`Some of the time` <- tblCCBalance1$`Some of the time` / tblCCBalance1$`Total weight`
tblCCBalance1$`Once` <- tblCCBalance1$`Once` / tblCCBalance1$`Total weight`
tblCCBalance1 <- reshape2::melt(data=tblCCBalance1, id.vars = c("State"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblCCBalance1$variable <- factor(tblCCBalance1$variable, levels = c("Most or all of the time", "Some of the time", "Once", "Always pay in full"))

tblCCBalance1$`For Tooltip` <- paste(
  "State: ", tblCCBalance1$State, '\n',
  "Frequency of unpaid balance: ", tblCCBalance1$variable, '\n',
  "Share: ", percent(tblCCBalance1$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g16E <- ggplot(data=tblCCBalance1, mapping=aes(y=State, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of graduate borrowers", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g16E, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 16 are
```{r CCBalance.SY, results = 'asis'}
survey_years(shed.CCBalance$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r CCBalance.N}
N.CCBalance <- aggregate(data=shed.CCBalance, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.CCBalance <- N.CCBalance %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.CCBalance) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.CCBalance, caption="N size by group for Figure 16") %>% kable_paper("hover", full_width = F)
```

```{r CCBalance.N0}
N.CCBalance0 <- aggregate(data=shed.CCBalance0, Count ~ State + ChildDebt, FUN=sum)
N.CCBalance0 <- N.CCBalance0 %>% filter(State=="CA" | ChildDebt=="Yes")
names(N.CCBalance0) <- c("State", "Parent-borrower", "Survey respondents")
kable(N.CCBalance0, caption="N size by group for Figure 16: Parents") %>% kable_paper("hover", full_width = F)
```

```{r CCBalance.N1}
N.CCBalance1 <- aggregate(data=shed.CCBalance1, Count ~ State, FUN=sum)
names(N.CCBalance1) <- c("State", "Survey respondents")
kable(N.CCBalance1, caption="N size by group for Figure 16: Graduate borrowers") %>% kable_paper("hover", full_width = F)
```
***

### {-}

Figure 17 asks about total household savings and investments. Most California student loan borrowers of all groups report having less than \$50,000 in total savings and investments, but especially Black California borrowers (78.1 percent) and Hispanic California borrowers (74.1 percent). White California borrowers are almost three times as likely (28.3 percent) to have \$100,000 in household wealth compared to Black California borrowers (10.2 percent). 

The distribution of California non-borrowers is much less skewed towards the low-wealth end of the spectrum. 

### {.tabset}
```{r Savings}
# Savings: # What is the approximate total amount of your household's savings and investments?

# table(shed$Savings)
shed.Savings <- shed %>% filter((Savings %in% c("Not sure", "Refused", ""))==FALSE) %>% filter(is.na(Savings)==FALSE) 
tblSavings <- aggregate(data=shed.Savings, Weight ~ Savings + Race + State + AnyStudentLoans, FUN=sum)
tblSavings <- tblSavings %>% add_row(Savings="$250,000 - $499,999", Race="Black, Non-Hispanic", State="CA", AnyStudentLoans="Yes", Weight=0)
tblSavings <- tblSavings %>% add_row(Savings="$500,000 - $999,999", Race="Black, Non-Hispanic", State="CA", AnyStudentLoans="Yes", Weight=0)
tblSavings2 <- aggregate(data=shed.Savings, Weight ~ Savings + State + AnyStudentLoans, FUN=sum)
tblSavings2$Race <- rep("All", nrow(tblSavings2))
tblSavings <- rbind(tblSavings, tblSavings2)
tblSavings <- reshape2::dcast(data=tblSavings, Race + State + AnyStudentLoans ~ Savings, value.var="Weight")
tblSavings$`Total weight` <- tblSavings$`Under $50,000` + tblSavings$`$50,000 - $99,999` + tblSavings$`$100,000 - $249,999` +  tblSavings$`$250,000 - $499,999` + tblSavings$`$500,000 - $999,999` + tblSavings$`$1,000,000 or more` 
tblSavings$`Under $50,000` <- tblSavings$`Under $50,000` / tblSavings$`Total weight`
tblSavings$`$50,000 - $99,999` <- tblSavings$`$50,000 - $99,999` / tblSavings$`Total weight`
tblSavings$`$100,000 - $249,999` <- tblSavings$`$100,000 - $249,999` / tblSavings$`Total weight`
tblSavings$`$250,000 - $499,999` <- tblSavings$`$250,000 - $499,999` / tblSavings$`Total weight`
tblSavings$`$500,000 - $999,999` <- tblSavings$`$500,000 - $999,999` / tblSavings$`Total weight`
tblSavings$`$1,000,000 or more` <- tblSavings$`$1,000,000 or more` / tblSavings$`Total weight`
tblSavings <- reshape2::melt(data=tblSavings, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblSavings$variable <- factor(tblSavings$variable, levels = c("$1,000,000 or more", "$500,000 - $999,999", "$250,000 - $499,999", "$100,000 - $249,999", "$50,000 - $99,999", "Under $50,000"))
tblSavings$Race <- factor(tblSavings$Race, levels=rev(c("All", "White, Non-Hispanic", "Hispanic", "Black, Non-Hispanic", "Other, Non-Hispanic")))
```
#### Figure 17: CA borrowers
##### Responses to "What is the approximate total amount of your household's savings and investments?"
```{r figure17A}
tblSavings.CA.Borrow <- tblSavings %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblSavings.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblSavings.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblSavings.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblSavings.CA.Borrow$Race, '\n',
  "Savings and investments: ", tblSavings.CA.Borrow$variable, '\n',
  "Share: ", percent(tblSavings.CA.Borrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g17A <- ggplot(data=tblSavings.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Savings and investments", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g17A, width=800, height=350, tooltip="text")
```
#### Figure 17: Rest of U.S. borrowers
##### Responses to "What is the approximate total amount of your household's savings and investments?"
```{r figure17B}
tblSavings.US.Borrow <- tblSavings %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblSavings.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblSavings.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblSavings.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblSavings.US.Borrow$Race, '\n',
  "Savings and investments: ", tblSavings.US.Borrow$variable, '\n',
  "Share: ", percent(tblSavings.US.Borrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g17B <- ggplot(data=tblSavings.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Savings and investments", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g17B, width=800, height=350, tooltip="text")
```
#### Figure 17: CA non-borrowers
##### Responses to "What is the approximate total amount of your household's savings and investments?"
```{r figure17C}
tblSavings.CA.Nonborrow <- tblSavings %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblSavings.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblSavings.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblSavings.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblSavings.CA.Nonborrow$Race, '\n',
  "Savings and investments: ", tblSavings.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblSavings.CA.Nonborrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g17C <- ggplot(data=tblSavings.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Savings and investments", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g17C, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 17 are
```{r Savings.SY, results = 'asis'}
survey_years(shed.Savings$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r Savings.N}
N.Savings <- aggregate(data=shed.Savings, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.Savings <- N.Savings %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.Savings) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.Savings, caption="N size by group for Figure 17") %>% kable_paper("hover", full_width = F)
```

***

Figure 18 shows the distribution of California student loan borrowers by income. We observe that: 

* The median California borrower earns between \$50,000 and \$75,000. 
* The median white California borrower earns between $75,000 and \$100,000. 
* The median Hispanic California borrower earns between \$40,000 and \$50,000. 
* The median Black California borrower earns between \$50,000 and \$75,000. 
* The median California borrower of another race earns between $75,000 and \$100,000. 

In other words, Hispanic borrowers in California skew the most towards the low-income side, followed next by Black borrowers in California. 

Comparing borrowers in California to borrowers outside California shows interesting trends. Black student loan borrowers across the country skew more low-income than Black borrowers in California, and same for the "Other, non-Hispanic" group. Overall, California has more high-income student loan borrowers (32.4 percent earning \$100,000 or more) than student loan borrowers in the rest of the country (26.7 percent). 

### {.tabset}
```{r TotalInc}
# TotalInc: # Which of the following categories best describes the total income that you received from all sources, before taxes and deductions, in the past 12 months? 

# table(shed$TotalInc)
shed.TotalInc <- shed %>% filter(is.na(TotalInc)==FALSE) %>% filter((TotalInc %in% c("Refused", ""))==FALSE) 
tblTotalInc <- aggregate(data=shed.TotalInc, Weight ~ TotalInc + Race + State + AnyStudentLoans, FUN=sum)
tblTotalInc2 <- aggregate(data=shed.TotalInc, Weight ~ TotalInc + State + AnyStudentLoans, FUN=sum)
tblTotalInc2$Race <- rep("All", nrow(tblTotalInc2))
tblTotalInc <- rbind(tblTotalInc, tblTotalInc2)
tblTotalInc <- reshape2::dcast(data=tblTotalInc, Race + State + AnyStudentLoans ~ TotalInc, value.var="Weight")
tblTotalInc$`Total weight` <- tblTotalInc$`$0 to $4,999` + tblTotalInc$`$5,000 to $14,999` + tblTotalInc$`$15,000 to $24,999` + tblTotalInc$`$25,000 to $39,999` + tblTotalInc$`$40,000 to $49,999` + tblTotalInc$`$50,000 to $74,999` + tblTotalInc$`$75,000 to $99,999` + tblTotalInc$`$100,000 to $149,999` + tblTotalInc$`$150,000 to $199,999` + tblTotalInc$`$200,000 or higher`
tblTotalInc$`$0 to $4,999` <- tblTotalInc$`$0 to $4,999` / tblTotalInc$`Total weight`
tblTotalInc$`$5,000 to $14,999` <- tblTotalInc$`$5,000 to $14,999` / tblTotalInc$`Total weight`
tblTotalInc$`$15,000 to $24,999` <- tblTotalInc$`$15,000 to $24,999` / tblTotalInc$`Total weight`
tblTotalInc$`$25,000 to $39,999` <- tblTotalInc$`$25,000 to $39,999` / tblTotalInc$`Total weight`
tblTotalInc$`$40,000 to $49,999` <- tblTotalInc$`$40,000 to $49,999` / tblTotalInc$`Total weight`
tblTotalInc$`$50,000 to $74,999` <- tblTotalInc$`$50,000 to $74,999` / tblTotalInc$`Total weight`
tblTotalInc$`$75,000 to $99,999` <- tblTotalInc$`$75,000 to $99,999` / tblTotalInc$`Total weight`
tblTotalInc$`$100,000 to $149,999` <- tblTotalInc$`$100,000 to $149,999` / tblTotalInc$`Total weight`
tblTotalInc$`$150,000 to $199,999` <- tblTotalInc$`$150,000 to $199,999` / tblTotalInc$`Total weight`
tblTotalInc$`$200,000 or higher` <- tblTotalInc$`$200,000 or higher` / tblTotalInc$`Total weight`
tblTotalInc <- reshape2::melt(data=tblTotalInc, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblTotalInc$variable <- factor(tblTotalInc$variable, levels = c("$200,000 or higher", "$150,000 to $199,999", "$100,000 to $149,999", "$75,000 to $99,999", "$50,000 to $74,999", "$40,000 to $49,999", "$25,000 to $39,999", "$15,000 to $24,999", "$5,000 to $14,999", "$0 to $4,999"))
```
#### Figure 18: CA borrowers
##### Responses to "Which of the following categories best describes the total income that you received from all sources, before taxes and deductions, in the past 12 months?"
```{r figure18A}
tblTotalInc.CA.Borrow <- tblTotalInc %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblTotalInc.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblTotalInc.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblTotalInc.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblTotalInc.CA.Borrow$Race, '\n',
  "Total income: ", tblTotalInc.CA.Borrow$variable, '\n',
  "Share: ", percent(tblTotalInc.CA.Borrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g18A <- ggplot(data=tblTotalInc.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Total income", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g18A, width=800, height=350, tooltip="text")
```
#### Figure 18: Rest of U.S. borrowers
##### Responses to "Which of the following categories best describes the total income that you received from all sources, before taxes and deductions, in the past 12 months?"
```{r figure18B}
tblTotalInc.US.Borrow <- tblTotalInc %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblTotalInc.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblTotalInc.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblTotalInc.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblTotalInc.US.Borrow$Race, '\n',
  "Total income: ", tblTotalInc.US.Borrow$variable, '\n',
  "Share: ", percent(tblTotalInc.US.Borrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g18B <- ggplot(data=tblTotalInc.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Total income", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g18B, width=800, height=350, tooltip="text")
```
#### Figure 18: CA non-borrowers
##### Responses to "Which of the following categories best describes the total income that you received from all sources, before taxes and deductions, in the past 12 months?"
```{r figure18C}
tblTotalInc.CA.Nonborrow <- tblTotalInc %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblTotalInc.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblTotalInc.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblTotalInc.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblTotalInc.CA.Nonborrow$Race, '\n',
  "Total income: ", tblTotalInc.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblTotalInc.CA.Nonborrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g18C <- ggplot(data=tblTotalInc.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Total income", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral", direction=-1) 

ggplotly(g18C, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 18 are
```{r TotalInc.SY, results = 'asis'}
survey_years(shed.TotalInc$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r TotalInc.N}
N.TotalInc <- aggregate(data=shed.TotalInc, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.TotalInc <- N.TotalInc %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.TotalInc) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.TotalInc, caption="N size by group for Figure 18") %>% kable_paper("hover", full_width = F)
```


***

### {-}

Figure 19 examines the first of some questions about subjective experiences. Asked how well they are managing financially, 25.1 percent of all California student loan borrowers reported "living comfortably." This falls to 9.1 percent among Black California student loan borrowers. Among student loan borrowers outside California, the Black-white gap is much smaller (7.6 percentage points) than among borrowers in California (24.3 percentage points). 

On the opposite end of the spectrum, between 9 and 12 percent of all white, Hispanic, and Black California borrowers report "Finding it difficult to get by." 

Across all groups, non-borrowers in California report greater financial well-being than student loan borrowers. 

Figure 19 also contains tabs for (1) parents and (2) borrowers with graduate degrees and student loans. 

### {.tabset}
```{r FinManage}
# FinManage: # Overall, which one of the following best describes how well you are managing financially these days? 

# table(shed$FinManage)
shed.FinManage <- shed %>% filter(is.na(FinManage)==FALSE) %>% filter((FinManage %in% c("Refused")==FALSE)) 
tblFinManage <- aggregate(data=shed.FinManage, Weight ~ FinManage + Race + State + AnyStudentLoans, FUN=sum)
tblFinManage2 <- aggregate(data=shed.FinManage, Weight ~ FinManage + State + AnyStudentLoans, FUN=sum)
tblFinManage2$Race <- rep("All", nrow(tblFinManage2))
tblFinManage <- rbind(tblFinManage, tblFinManage2)
tblFinManage <- reshape2::dcast(data=tblFinManage, Race + State + AnyStudentLoans ~ FinManage, value.var="Weight")
tblFinManage$`Total weight` <- tblFinManage$`Living comfortably` + tblFinManage$`Finding it difficult to get by` + tblFinManage$`Just getting by` + tblFinManage$`Doing okay`
tblFinManage$`Living comfortably` <- tblFinManage$`Living comfortably` / tblFinManage$`Total weight`
tblFinManage$`Finding it difficult to get by` <- tblFinManage$`Finding it difficult to get by` / tblFinManage$`Total weight`
tblFinManage$`Just getting by` <- tblFinManage$`Just getting by` / tblFinManage$`Total weight`
tblFinManage$`Doing okay` <- tblFinManage$`Doing okay` / tblFinManage$`Total weight`
tblFinManage <- reshape2::melt(data=tblFinManage, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblFinManage$variable <- factor(tblFinManage$variable, levels = c("Finding it difficult to get by", "Just getting by", "Doing okay", "Living comfortably"))
```

```{r forPolicyReport2, eval=FALSE}
# FinManage: # Overall, which one of the following best describes how well you are managing financially these days? 

# table(shed$FinManage)
shed.FinManage$`Managing well` <- rep("No", nrow(shed.FinManage))
shed.FinManage$`Managing well`[shed.FinManage$FinManage=="Living comfortably"] <- "Yes"

tblFinManage0 <- aggregate(data=shed.FinManage, Weight ~ `Managing well` + Race + State + AnyStudentLoans, FUN=sum)
tblFinManage02 <- aggregate(data=shed.FinManage, Weight ~ `Managing well` + State + AnyStudentLoans, FUN=sum)
tblFinManage02$Race <- rep("All", nrow(tblFinManage02))
tblFinManage0 <- rbind(tblFinManage0, tblFinManage02)
tblFinManage0 <- reshape2::dcast(data=tblFinManage0, Race + State + AnyStudentLoans ~ `Managing well`, value.var="Weight")
tblFinManage0$`Total weight` <- tblFinManage0$`Yes` + tblFinManage0$`No` 
tblFinManage0$`Share living comfortably` <- tblFinManage0$`Yes` / tblFinManage0$`Total weight`

tblFinManage0 <- tblFinManage0 %>% filter(AnyStudentLoans=="Yes") %>% filter(Race != "Other, Non-Hispanic")
tblFinManage0$Race <- as.factor(tblFinManage0$Race)
tblFinManage0$Race <- factor(tblFinManage0$Race, levels=c("All", "White, Non-Hispanic", "Hispanic", "Black, Non-Hispanic"))

ggplot(data=tblFinManage0, mapping=aes(y=`Share living comfortably`, x=Race, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.5) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) + labs(y="Share who report living comfortably", x="Group") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols2)

```

#### Figure 19: CA borrowers
##### Responses to "Overall, which one of the following best describes how well you are managing financially these days?"
```{r figure19A}
tblFinManage.CA.Borrow <- tblFinManage %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblFinManage.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblFinManage.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblFinManage.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblFinManage.CA.Borrow$Race, '\n',
  "Response: ", tblFinManage.CA.Borrow$variable, '\n',
  "Share: ", percent(tblFinManage.CA.Borrow$`Share of borrowers`, accuracy=0.1),
  sep="" 
)

g19A <- ggplot(data=tblFinManage.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g19A, width=800, height=350, tooltip="text")
```
#### Figure 19: Rest of U.S. borrowers
##### Responses to "Overall, which one of the following best describes how well you are managing financially these days?"
```{r figure19B}
tblFinManage.US.Borrow <- tblFinManage %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblFinManage.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblFinManage.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblFinManage.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblFinManage.US.Borrow$Race, '\n',
  "Response: ", tblFinManage.US.Borrow$variable, '\n',
  "Share: ", percent(tblFinManage.US.Borrow$`Share of borrowers`, accuracy=0.1),
  sep="" 
)

g19B <- ggplot(data=tblFinManage.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g19B, width=800, height=350, tooltip="text")
```
#### Figure 19: CA non-borrowers
##### Responses to "Overall, which one of the following best describes how well you are managing financially these days?"
```{r figure19C}
tblFinManage.CA.Nonborrow <- tblFinManage %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblFinManage.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblFinManage.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblFinManage.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblFinManage.CA.Nonborrow$Race, '\n',
  "Response: ", tblFinManage.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblFinManage.CA.Nonborrow$`Share of borrowers`, accuracy=0.1),
  sep="" 
)

g19C <- ggplot(data=tblFinManage.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g19C, width=800, height=350, tooltip="text")
```
#### Figure 19: Parents
##### Responses to "Overall, which one of the following best describes how well you are managing financially these days?"
```{r figure19D}
shed$FinManage0 <- shed$FinManage

shed.FinManage0 <- shed %>% filter(is.na(FinManage0)==FALSE) %>% filter((FinManage0 %in% c("Refused")==FALSE)) %>% filter(ChildDebt %in% c("No", "Yes"))
tblFinManage0 <- aggregate(data=shed.FinManage0, Weight ~ FinManage0 + State + ChildDebt, FUN=sum)
tblFinManage0 <- reshape2::dcast(data=tblFinManage0, State + ChildDebt ~ FinManage0, value.var="Weight")
tblFinManage0$`Total weight` <- tblFinManage0$`Living comfortably` + tblFinManage0$`Finding it difficult to get by` + tblFinManage0$`Just getting by` + tblFinManage0$`Doing okay`
tblFinManage0$`Living comfortably` <- tblFinManage0$`Living comfortably` / tblFinManage0$`Total weight`
tblFinManage0$`Finding it difficult to get by` <- tblFinManage0$`Finding it difficult to get by` / tblFinManage0$`Total weight`
tblFinManage0$`Just getting by` <- tblFinManage0$`Just getting by` / tblFinManage0$`Total weight`
tblFinManage0$`Doing okay` <- tblFinManage0$`Doing okay` / tblFinManage0$`Total weight`
tblFinManage0 <- reshape2::melt(data=tblFinManage0, id.vars = c("State", "ChildDebt"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblFinManage0$variable <- factor(tblFinManage0$variable, levels = c("Finding it difficult to get by", "Just getting by", "Doing okay", "Living comfortably"))

tblFinManage0$Group <- rep(NA, nrow(tblFinManage0))
tblFinManage0$Group[tblFinManage0$State=="CA" & tblFinManage0$ChildDebt=="Yes"] <- "California parent-borrowers"
tblFinManage0$Group[tblFinManage0$State=="Rest of U.S." & tblFinManage0$ChildDebt=="Yes"] <- "Rest of U.S. parent-borrowers"
tblFinManage0$Group[tblFinManage0$State=="CA" & tblFinManage0$ChildDebt=="No"] <- "Other California parents"
tblFinManage0 <- tblFinManage0 %>% filter(is.na(Group)==FALSE)

tblFinManage0$`For Tooltip` <- paste(
  "State: ", tblFinManage0$State, '\n',
  "Parent-borrowers: ", tblFinManage0$ChildDebt, '\n',
  "Group: ", tblFinManage0$Group, '\n',
  "Response: ", tblFinManage0$variable, '\n',
  "Share: ", percent(tblFinManage0$`Share of borrowers`, accuracy=0.1),
  sep="" 
)

g19D <- ggplot(data=tblFinManage0, mapping=aes(y=Group, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of parents", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g19D, width=800, height=350, tooltip="text")
```
#### Figure 19: Graduate borrowers
##### Responses to "Overall, which one of the following best describes how well you are managing financially these days?"
```{r figure19E}
shed$FinManage1 <- shed$FinManage

shed.FinManage1 <- shed %>% filter(is.na(FinManage1)==FALSE) %>% filter((FinManage1 %in% c("Refused"))==FALSE) %>% filter(OwnDebtSL=="Yes") %>% filter(EdAttain %in% c("Doctorate", "Master's degree", "Professional degree"))
tblFinManage1 <- aggregate(data=shed.FinManage1, Weight ~ FinManage1 + State, FUN=sum)
tblFinManage1 <- reshape2::dcast(data=tblFinManage1, State ~ FinManage1, value.var="Weight")
tblFinManage1$`Total weight` <- tblFinManage1$`Living comfortably` + tblFinManage1$`Finding it difficult to get by` + tblFinManage1$`Just getting by` + tblFinManage1$`Doing okay`
tblFinManage1$`Living comfortably` <- tblFinManage1$`Living comfortably` / tblFinManage1$`Total weight`
tblFinManage1$`Finding it difficult to get by` <- tblFinManage1$`Finding it difficult to get by` / tblFinManage1$`Total weight`
tblFinManage1$`Just getting by` <- tblFinManage1$`Just getting by` / tblFinManage1$`Total weight`
tblFinManage1$`Doing okay` <- tblFinManage1$`Doing okay` / tblFinManage1$`Total weight`
tblFinManage1 <- reshape2::melt(data=tblFinManage1, id.vars = c("State"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblFinManage1$variable <- factor(tblFinManage1$variable, levels = c("Finding it difficult to get by", "Just getting by", "Doing okay", "Living comfortably"))

tblFinManage1$`For Tooltip` <- paste(
  "State: ", tblFinManage1$State, '\n',
  "Response: ", tblFinManage1$variable, '\n',
  "Share: ", percent(tblFinManage1$`Share of borrowers`, accuracy=0.1),
  sep="" 
)

g19E <- ggplot(data=tblFinManage1, mapping=aes(y=State, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of graduate borrowers", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g19E, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 19 are
```{r FinManage.SY, results = 'asis'}
survey_years(shed.FinManage$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r FinManage.N}
N.FinManage <- aggregate(data=shed.FinManage, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.FinManage <- N.FinManage %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.FinManage) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.FinManage, caption="N size by group for Figure 19") %>% kable_paper("hover", full_width = F)
```

```{r FinManage.N0}
N.FinManage0 <- aggregate(data=shed.FinManage0, Count ~  State + ChildDebt, FUN=sum)
N.FinManage0 <- N.FinManage0 %>% filter(State=="CA" | ChildDebt=="Yes")
names(N.FinManage0) <- c("State", "Parent-borrower", "Survey respondents")
kable(N.FinManage0, caption="N size by group for Figure 19: Parents") %>% kable_paper("hover", full_width = F)
```

```{r FinManage.N1}
N.FinManage1 <- aggregate(data=shed.FinManage0, Count ~  State, FUN=sum)
names(N.FinManage1) <- c("State", "Survey respondents")
kable(N.FinManage1, caption="N size by group for Figure 19: Graduate borrowers") %>% kable_paper("hover", full_width = F)
```
***

### {-}

Figure 20 looks at how respondents think they doing compared to how their parents were doing at their age. In general, student loan borrowers feel positively about their financial standing compared to their parents at the same age, with more than half feeling better off. 

Compared to California student loan borrowers, borrowers in the rest of the U.S. appear slightly less satisfied, as do California non-borrowers. In both cases, the differentials are not large. 

It is difficult to read very much into the responses to this question. A respondent can feel that they are relatively better off than their parents while still dissatisfied with their circumstances, and a respondent from a wealthy background may observe some downward mobility compared to their parents without necessarily experiencing hardship. At the same time, the lack of major differences by race is interesting given the sizable gaps we have observed in previous figures. 

### {.tabset}
```{r ParComp}
# ParComp: # Think of your parents when they were your age. Would you say you (and your family) are better, the same, or worse off financially than they were? 

# table(shed$ParComp)
shed.ParComp <- shed %>% filter(is.na(ParComp)==FALSE) %>% filter((ParComp %in% c("Refused")==FALSE)) 
tblParComp <- aggregate(data=shed.ParComp, Weight ~ ParComp + Race + State + AnyStudentLoans, FUN=sum)
tblParComp2 <- aggregate(data=shed.ParComp, Weight ~ ParComp + State + AnyStudentLoans, FUN=sum)
tblParComp2$Race <- rep("All", nrow(tblParComp2))
tblParComp <- rbind(tblParComp, tblParComp2)
tblParComp <- reshape2::dcast(data=tblParComp, Race + State + AnyStudentLoans ~ ParComp, value.var="Weight")
tblParComp$`Total weight` <- tblParComp$`Much better off` + tblParComp$`Somewhat worse off` + tblParComp$`About the same` + tblParComp$`Somewhat better off` + tblParComp$`Much worse off`
tblParComp$`Much better off` <- tblParComp$`Much better off` / tblParComp$`Total weight`
tblParComp$`Somewhat better off` <- tblParComp$`Somewhat better off` / tblParComp$`Total weight`
tblParComp$`About the same` <- tblParComp$`About the same` / tblParComp$`Total weight`
tblParComp$`Somewhat worse off` <- tblParComp$`Somewhat worse off` / tblParComp$`Total weight`
tblParComp$`Much worse off` <- tblParComp$`Much worse off` / tblParComp$`Total weight`
tblParComp <- reshape2::melt(data=tblParComp, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblParComp$variable <- factor(tblParComp$variable, levels = c("Much worse off", "Somewhat worse off", "About the same", "Somewhat better off", "Much better off"))
```
#### Figure 20: CA borrowers
##### Responses to "Think of your parents when they were your age. Would you say you (and your family) are better, the same, or worse off financially than they were?"
```{r figure20A}
tblParComp.CA.Borrow <- tblParComp %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblParComp.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblParComp.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblParComp.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblParComp.CA.Borrow$Race, '\n',
  "Comparison to parents: ", tblParComp.CA.Borrow$variable, '\n',
  "Share: ", percent(tblParComp.CA.Borrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g20A <- ggplot(data=tblParComp.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g20A, width=800, height=350, tooltip="text")
```
#### Figure 20: Rest of U.S. borrowers
##### Responses to "Think of your parents when they were your age. Would you say you (and your family) are better, the same, or worse off financially than they were?"
```{r figure20B}
tblParComp.US.Borrow <- tblParComp %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblParComp.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblParComp.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblParComp.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblParComp.US.Borrow$Race, '\n',
  "Comparison to parents: ", tblParComp.US.Borrow$variable, '\n',
  "Share: ", percent(tblParComp.US.Borrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g20B <- ggplot(data=tblParComp.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g20B, width=800, height=350, tooltip="text")
```
#### Figure 20: CA non-borrowers
##### Responses to "Think of your parents when they were your age. Would you say you (and your family) are better, the same, or worse off financially than they were?"
```{r figure20C}
tblParComp.CA.Nonborrow <- tblParComp %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblParComp.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblParComp.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblParComp.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblParComp.CA.Nonborrow$Race, '\n',
  "Comparison to parents: ", tblParComp.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblParComp.CA.Nonborrow$`Share of borrowers`, accuracy=0.1),
  sep=""
)

g20C <- ggplot(data=tblParComp.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g20C, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 20 are
```{r ParComp.SY, results = 'asis'}
survey_years(shed.ParComp$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r ParComp.N}
N.ParComp <- aggregate(data=shed.ParComp, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.ParComp <- N.ParComp %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.ParComp) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.ParComp, caption="N size by group for Figure 20") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Figure 21 displays where respondents think their credit score falls. The disparities by race are stark: only 32.3 percent of Black California student loan borrowers think their credit score is "excellent" or "good," compared to 75.1 percent of white California student loan borrowers. This Black-white gap (42.8 percentage points) is larger than it is for student loan borrowers in the rest of the U.S. (25.6 percentage points). 

Student loan borrowers in California report having worse credit scores than non-borrowers in California. Looking within California, the disparity between Black borrowers and Black non-borrowers is especially strong: 63.9 percent of Black California non-borrowers say they think their credit score is "excellent" or "good," almost *double* the 32.3 percent among Black California borrowers. In other words, for Black Californians, having student loans is associated with halving the likelihood of having a good or excellent credit score. 

### {.tabset}
```{r CreditScore}
# CreditScore: # Where do you think your credit score falls? 

# table(shed$CreditScore)
shed.CreditScore <- shed %>% filter(is.na(CreditScore)==FALSE) %>% filter((CreditScore %in% c("Refused", "", "Don't know")==FALSE)) 
tblCreditScore <- aggregate(data=shed.CreditScore, Weight ~ CreditScore + Race + State + AnyStudentLoans, FUN=sum)
tblCreditScore2 <- aggregate(data=shed.CreditScore, Weight ~ CreditScore + State + AnyStudentLoans, FUN=sum)
tblCreditScore2$Race <- rep("All", nrow(tblCreditScore2))
tblCreditScore <- rbind(tblCreditScore, tblCreditScore2)
tblCreditScore <- reshape2::dcast(data=tblCreditScore, Race + State + AnyStudentLoans ~ CreditScore, value.var="Weight")
tblCreditScore$`Total weight` <- tblCreditScore$`Excellent` + tblCreditScore$`Poor` + tblCreditScore$`Fair` + tblCreditScore$`Good` + tblCreditScore$`Very poor`
tblCreditScore$`Excellent` <- tblCreditScore$`Excellent` / tblCreditScore$`Total weight`
tblCreditScore$`Good` <- tblCreditScore$`Good` / tblCreditScore$`Total weight`
tblCreditScore$`Fair` <- tblCreditScore$`Fair` / tblCreditScore$`Total weight`
tblCreditScore$`Poor` <- tblCreditScore$`Poor` / tblCreditScore$`Total weight`
tblCreditScore$`Very poor` <- tblCreditScore$`Very poor` / tblCreditScore$`Total weight`
tblCreditScore <- reshape2::melt(data=tblCreditScore, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblCreditScore$variable <- factor(tblCreditScore$variable, levels = c("Very poor", "Poor", "Fair", "Good", "Excellent"))
```

```{r forPolicyReport5, eval=FALSE}
shed.CreditScore$`Poor or very poor credit score` <- rep("No", nrow(shed.CreditScore))
shed.CreditScore$`Poor or very poor credit score`[shed.CreditScore$CreditScore %in% c("Poor", "Very poor")] <- "Yes"
tblCreditScore0 <- aggregate(data=shed.CreditScore, Weight ~ `Poor or very poor credit score` + Race + State + AnyStudentLoans, FUN=sum)
tblCreditScore02 <- aggregate(data=shed.CreditScore, Weight ~ `Poor or very poor credit score` + State + AnyStudentLoans, FUN=sum)
tblCreditScore02$Race <- rep("All", nrow(tblCreditScore02))
tblCreditScore0 <- rbind(tblCreditScore0, tblCreditScore02)
tblCreditScore0 <- reshape2::dcast(data=tblCreditScore0, Race + State + AnyStudentLoans ~ `Poor or very poor credit score`, value.var="Weight")
tblCreditScore0$`Share with poor or very poor credit score` <- tblCreditScore0$Yes / (tblCreditScore0$Yes + tblCreditScore0$No)

tblCreditScore0 <- tblCreditScore0 %>% filter(AnyStudentLoans=="Yes") %>% filter(Race != "Other, Non-Hispanic")
tblCreditScore0$Race <- as.factor(tblCreditScore0$Race)
tblCreditScore0$Race <- factor(tblCreditScore0$Race, levels=c("All", "White, Non-Hispanic", "Hispanic", "Black, Non-Hispanic"))

ggplot(data=tblCreditScore0, mapping=aes(y=`Share with poor or very poor credit score`, x=Race, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.5) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) + labs(y="Share with a poor or very poor credit score", x="Group") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols2)
```

#### Figure 21: CA borrowers
##### Responses to "Where do you think your credit score falls?"
```{r Figure21A}
tblCreditScore.CA.Borrow <- tblCreditScore %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblCreditScore.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblCreditScore.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblCreditScore.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblCreditScore.CA.Borrow$Race, '\n',
  "Credit score: ", tblCreditScore.CA.Borrow$variable, '\n',
  "Share: ", percent(tblCreditScore.CA.Borrow$`Share`, accuracy=0.1),
  sep=""
)

g21A <- ggplot(data=tblCreditScore.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g21A, width=800, height=350, tooltip="text")
```
#### Figure 21: Rest of U.S. borrowers
##### Responses to "Where do you think your credit score falls?"
```{r Figure21B}
tblCreditScore.US.Borrow <- tblCreditScore %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblCreditScore.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblCreditScore.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblCreditScore.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblCreditScore.US.Borrow$Race, '\n',
  "Credit score: ", tblCreditScore.US.Borrow$variable, '\n',
  "Share: ", percent(tblCreditScore.US.Borrow$`Share`, accuracy=0.1),
  sep=""
)

g21B <- ggplot(data=tblCreditScore.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g21B, width=800, height=350, tooltip="text")
```
#### Figure 21: CA Non-borrowers
##### Responses to "Where do you think your credit score falls?"
```{r Figure21C}
tblCreditScore.CA.Nonborrow <- tblCreditScore %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblCreditScore.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblCreditScore.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblCreditScore.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblCreditScore.CA.Nonborrow$Race, '\n',
  "Credit score: ", tblCreditScore.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblCreditScore.CA.Nonborrow$`Share`, accuracy=0.1),
  sep=""
)

g21C <- ggplot(data=tblCreditScore.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g21C, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 21 are
```{r CreditScore.SY, results = 'asis'}
survey_years(shed.CreditScore$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r CreditScore.N}
N.CreditScore <- aggregate(data=shed.CreditScore, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.CreditScore <- N.CreditScore %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.CreditScore) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.CreditScore, caption="N size by group for Figure 21") %>% kable_paper("hover", full_width = F)
```


***

### {-}

Figure 22 examines borrower's reported ability to pay off their bills in full in the month they were surveyed. About 6 in 10 Black California borrowers and Hispanic California borrowers report being able to fully pay their monthly bills, versus 7 in 10 among California borrowers overall. By comparison, a slightly higher percentage of student loan borrowers outside California report being able to pay their bills in full. 

Figure 22 also contains tabs for (1) parents and (2) borrowers with graduate degrees and student loans. 

### {.tabset}
```{r PayBills}
# PayBills: # Which best describes your ability to pay all of your bills in full this month? 

# table(shed$PayBills)
shed.PayBills <- shed %>% filter(is.na(PayBills)==FALSE) %>% filter((PayBills %in% c("Refused")==FALSE)) 
tblPayBills <- aggregate(data=shed.PayBills, Weight ~ PayBills + Race + State + AnyStudentLoans, FUN=sum)
tblPayBills2 <- aggregate(data=shed.PayBills, Weight ~ PayBills + State + AnyStudentLoans, FUN=sum)
tblPayBills2$Race <- rep("All", nrow(tblPayBills2))
tblPayBills <- rbind(tblPayBills, tblPayBills2)
tblPayBills <- reshape2::dcast(data=tblPayBills, Race + State + AnyStudentLoans ~ PayBills, value.var="Weight")
tblPayBills$`Total weight` <- tblPayBills$`I cannot pay some bills or will only make a partial payment on them` + tblPayBills$`I will be able to pay all of my bills in full`
tblPayBills$`I cannot pay some bills or will only make a partial payment on them` <- tblPayBills$`I cannot pay some bills or will only make a partial payment on them` / tblPayBills$`Total weight`
tblPayBills$`I will be able to pay all of my bills in full` <- tblPayBills$`I will be able to pay all of my bills in full` / tblPayBills$`Total weight`
tblPayBills <- reshape2::melt(data=tblPayBills, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblPayBills$variable <- factor(tblPayBills$variable, levels = c("I will be able to pay all of my bills in full", "I cannot pay some bills or will only make a partial payment on them"))
```
#### Figure 22: CA borrowers
##### Responses to "Which best describes your ability to pay all of your bills in full this month?"
```{r figure22A}
tblPayBills.CA.Borrow <- tblPayBills %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblPayBills.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblPayBills.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblPayBills.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblPayBills.CA.Borrow$Race, '\n',
  "Ability to pay: ", tblPayBills.CA.Borrow$variable, '\n',
  "Share: ", percent(tblPayBills.CA.Borrow$`Share`, accuracy=0.1),
  sep=""
)

g22A <- ggplot(data=tblPayBills.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g22A, width=800, height=350, tooltip="text")
```
#### Figure 22: Rest of U.S. borrowers
##### Responses to "Which best describes your ability to pay all of your bills in full this month?"
```{r figure22B}
tblPayBills.US.Borrow <- tblPayBills %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblPayBills.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblPayBills.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblPayBills.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblPayBills.US.Borrow$Race, '\n',
  "Ability to pay: ", tblPayBills.US.Borrow$variable, '\n',
  "Share: ", percent(tblPayBills.US.Borrow$`Share`, accuracy=0.1),
  sep=""
)

g22B <- ggplot(data=tblPayBills.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g22B, width=800, height=350, tooltip="text")
```
#### Figure 22: CA non-borrowers
##### Responses to "Which best describes your ability to pay all of your bills in full this month?"
```{r figure22C}
tblPayBills.CA.Nonborrow <- tblPayBills %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblPayBills.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblPayBills.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblPayBills.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblPayBills.CA.Nonborrow$Race, '\n',
  "Ability to pay: ", tblPayBills.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblPayBills.CA.Nonborrow$`Share`, accuracy=0.1),
  sep=""
)

g22C <- ggplot(data=tblPayBills.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g22C, width=800, height=350, tooltip="text")
```
#### Figure 22: Parents
##### Responses to "Which best describes your ability to pay all of your bills in full this month?"
```{r figure22D}
shed$PayBills0 <- shed$PayBills

shed.PayBills0 <- shed %>% filter(is.na(PayBills0)==FALSE) %>% filter((PayBills0 %in% c("Refused")==FALSE)) %>% filter(ChildDebt %in% c("No", "Yes"))
tblPayBills0 <- aggregate(data=shed.PayBills0, Weight ~ PayBills0 + State + ChildDebt, FUN=sum)
tblPayBills0 <- reshape2::dcast(data=tblPayBills0, State + ChildDebt ~ PayBills0, value.var="Weight")
tblPayBills0$`Total weight` <- tblPayBills0$`I cannot pay some bills or will only make a partial payment on them` + tblPayBills0$`I will be able to pay all of my bills in full`
tblPayBills0$`I cannot pay some bills or will only make a partial payment on them` <- tblPayBills0$`I cannot pay some bills or will only make a partial payment on them` / tblPayBills0$`Total weight`
tblPayBills0$`I will be able to pay all of my bills in full` <- tblPayBills0$`I will be able to pay all of my bills in full` / tblPayBills0$`Total weight`
tblPayBills0 <- reshape2::melt(data=tblPayBills0, id.vars = c("State", "ChildDebt"), value.name="Share") %>% filter(variable != "Total weight")
tblPayBills0$variable <- factor(tblPayBills0$variable, levels = c("I will be able to pay all of my bills in full", "I cannot pay some bills or will only make a partial payment on them"))

tblPayBills0$Group <- rep(NA, nrow(tblPayBills0))
tblPayBills0$Group[(tblPayBills0$State=="CA") & (tblPayBills0$ChildDebt=="Yes")] <- "California parent-borrowers"
tblPayBills0$Group[(tblPayBills0$State=="Rest of U.S.") & (tblPayBills0$ChildDebt=="Yes")] <- "Rest of U.S. parent-borrowers"
tblPayBills0$Group[(tblPayBills0$State=="CA") & (tblPayBills0$ChildDebt=="No")] <- "Other California parents"
tblPayBills0 <- tblPayBills0 %>% filter(State=="CA" | ChildDebt=="Yes")

tblPayBills0$`For Tooltip` <- paste(
  "State: ", tblPayBills0$State, '\n',
  "Parent-borrowers: ", tblPayBills0$ChildDebt, '\n',
  "Group: ", tblPayBills0$Group, '\n',
  "Ability to pay: ", tblPayBills0$variable, '\n',
  "Share: ", percent(tblPayBills0$`Share`, accuracy=0.1),
  sep=""
)

g22D <- ggplot(data=tblPayBills0, mapping=aes(y=Group, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of parents", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g22D, width=800, height=350, tooltip="text")
```
#### Figure 22: Graduate borrowers
##### Responses to "Which best describes your ability to pay all of your bills in full this month?"
```{r figure22E}
shed$PayBills1 <- shed$PayBills

shed.PayBills1 <- shed %>% filter(is.na(PayBills1)==FALSE) %>% filter((PayBills1 %in% c("Refused")==FALSE)) %>% filter(EdAttain %in% c("Doctorate", "Master's degree", "Professional degree")) %>% filter(OwnDebtSL=="Yes")

tblPayBills1 <- aggregate(data=shed.PayBills1, Weight ~ PayBills1 + State, FUN=sum)
tblPayBills1 <- reshape2::dcast(data=tblPayBills1, State ~ PayBills1, value.var="Weight")
tblPayBills1$`Total weight` <- tblPayBills1$`I cannot pay some bills or will only make a partial payment on them` + tblPayBills1$`I will be able to pay all of my bills in full`
tblPayBills1$`I cannot pay some bills or will only make a partial payment on them` <- tblPayBills1$`I cannot pay some bills or will only make a partial payment on them` / tblPayBills1$`Total weight`
tblPayBills1$`I will be able to pay all of my bills in full` <- tblPayBills1$`I will be able to pay all of my bills in full` / tblPayBills1$`Total weight`
tblPayBills1 <- reshape2::melt(data=tblPayBills1, id.vars = c("State"), value.name="Share") %>% filter(variable != "Total weight")
tblPayBills1$variable <- factor(tblPayBills1$variable, levels = c("I will be able to pay all of my bills in full", "I cannot pay some bills or will only make a partial payment on them"))

tblPayBills1$`For Tooltip` <- paste(
  "State: ", tblPayBills1$State, '\n',
  "Ability to pay: ", tblPayBills1$variable, '\n',
  "Share: ", percent(tblPayBills1$`Share`, accuracy=0.1),
  sep=""
)

g22E <- ggplot(data=tblPayBills1, mapping=aes(y=State, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of graduate borrowers", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g22E, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 22 are
```{r PayBills.SY, results = 'asis'}
survey_years(shed.PayBills$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r PayBills.N}
N.PayBills <- aggregate(data=shed.PayBills, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.PayBills <- N.PayBills %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.PayBills) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.PayBills, caption="N size by group for Figure 22") %>% kable_paper("hover", full_width = F)
```

```{r PayBills.N0}
N.PayBills0 <- aggregate(data=shed.PayBills0, Count ~ State + ChildDebt, FUN=sum)
N.PayBills0 <- N.PayBills0 %>% filter(State=="CA" | ChildDebt=="Yes")
names(N.PayBills0) <- c("State", "Parent-borrower", "Survey respondents")
kable(N.PayBills0, caption="N size by group for Figure 22: Parents") %>% kable_paper("hover", full_width = F)
```

```{r PayBills.N1}
N.PayBills1 <- aggregate(data=shed.PayBills1, Count ~ State, FUN=sum)
names(N.PayBills1) <- c("State", "Survey respondents")
kable(N.PayBills1, caption="N size by group for Figure 22: Graduate borrowera") %>% kable_paper("hover", full_width = F)
```


***

### {-}

In the first tab of Figure 23, we examine the same question but for monthly student loan bills specifically. Overall, California borrowers (27.2 percent) appear more likely to be able to pay their next student loan bill than those outside California (34.2 percent). The differences across groups are small among California borrowers, but it is actually white California borrowers (33.6 percent) who report being unable to fully pay their next student loan bill the most often, and it is Hispanic California borrowers (22.2 percent) who report that response the least often. 

The next tab applies the same question to rent or mortgage bills. Once again, the differences across groups are small, but Hispanic California borrowers report being unable to pay their next rent or mortgage bill the most often (24.3 percent) and white California borrowers the least often (11.6 percent).

In the next tab, the shares who say that they cannot pay their next credit card bill are much higher than for student loan bills and rent or mortgage bills. More than half (57.2 percent) of California student loan borrowers say that they cannot, though this is not significantly higher than the rates for student loan borrowers outside California (51.9 percent) and California non-borrowers (45.5 percent). 

For "Figure 23: Ability to pay student loan bill," I excluded survey responses from 2020 and 2021 due to the federal student loan payment pause and forbearance period. The sample sizes are smaller for Figure 23 than for others, so interpret with a greater degree of caution.

### {.tabset}
#### Figure 23: Ability to pay student loan bill
```{r PartialSL}
# PartialSL: # Student loan ‐ Are you expecting to be unable to pay or only make a partial payment on each of the following bills this month? 

# table(shed$PartialSL)
shed.PartialSL <- shed %>% filter((PartialSL %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) %>% filter(SurveyYear %in% c(2015, 2016, 2017, 2018, 2019)) 
tblPartialSL <- aggregate(data=shed.PartialSL, Weight ~ PartialSL + Race + State + AnyStudentLoans, FUN=sum)
tblPartialSL2 <- aggregate(data=shed.PartialSL, Weight ~ PartialSL + State + AnyStudentLoans, FUN=sum)
tblPartialSL2$Race <- rep("All", nrow(tblPartialSL2))
tblPartialSL <- rbind(tblPartialSL, tblPartialSL2)
tblPartialSL <- reshape2::dcast(data=tblPartialSL, Race + State + AnyStudentLoans ~ PartialSL, value.var="Weight")
tblPartialSL$`Share of borrowers expecting to be unable to fully pay their student loan bill this month` <- tblPartialSL$Yes / (tblPartialSL$Yes + tblPartialSL$No)
tblPartialSL$Group <- rep(NA, nrow(tblPartialSL))
tblPartialSL$Group[tblPartialSL$State=="CA" & tblPartialSL$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblPartialSL$Group[tblPartialSL$State=="Rest of U.S." & tblPartialSL$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblPartialSL <- tblPartialSL %>% filter(is.na(Group)==FALSE)
tblPartialSL$Group <- factor(tblPartialSL$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Are you expecting to be unable to pay or only make a partial payment on your student loan bill this month?"
```{r figure23A}
tblPartialSL$`For Tooltip` <- paste(
  "State: ", tblPartialSL$State, '\n',
  "Group: ", tblPartialSL$Race, '\n',
  "Share unable to fully pay: ", percent(tblPartialSL$`Share of borrowers expecting to be unable to fully pay their student loan bill this month`, accuracy=0.1), 
  sep=""
)

g23A <- ggplot(data=tblPartialSL, mapping=aes(y=Race, x=`Share of borrowers expecting to be unable to fully pay their student loan bill this month`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who expect to be unable to pay their student loan bill this month", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g23A, width=800, height=350, tooltip="text")
```
#### Figure 23: Ability to pay rent or mortgage bill
```{r PartialRent}
# PartialRent: # Rent or mortgage ‐ Are you expecting to be unable to pay or only make a partial payment on each of the following bills this month? 

# table(shed$PartialRent)
shed.PartialRent <- shed %>% filter((PartialRent %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblPartialRent <- aggregate(data=shed.PartialRent, Weight ~ PartialRent + Race + State + AnyStudentLoans, FUN=sum)
tblPartialRent2 <- aggregate(data=shed.PartialRent, Weight ~ PartialRent + State + AnyStudentLoans, FUN=sum)
tblPartialRent2$Race <- rep("All", nrow(tblPartialRent2))
tblPartialRent <- rbind(tblPartialRent, tblPartialRent2)
tblPartialRent <- reshape2::dcast(data=tblPartialRent, Race + State + AnyStudentLoans ~ PartialRent, value.var="Weight")
tblPartialRent$`Share of borrowers expecting to be unable to fully pay their rent this month` <- tblPartialRent$Yes / (tblPartialRent$Yes + tblPartialRent$No)
tblPartialRent$Group <- rep(NA, nrow(tblPartialRent))
tblPartialRent$Group[tblPartialRent$State=="CA" & tblPartialRent$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblPartialRent$Group[tblPartialRent$State=="Rest of U.S." & tblPartialRent$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblPartialRent$Group[tblPartialRent$State=="CA" & tblPartialRent$AnyStudentLoans=="No"] <- "California non-borrowers"
tblPartialRent <- tblPartialRent %>% filter(is.na(Group)==FALSE)
tblPartialSL$Group <- factor(tblPartialSL$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Are you expecting to be unable to pay or only make a partial payment on each of the following bills this month?"
```{r figure23B}
tblPartialRent$`For Tooltip` <- paste(
  "State: ", tblPartialRent$State, '\n',
  "Student loan borrowers: ", tblPartialRent$AnyStudentLoans, '\n',
  "Group: ", tblPartialRent$Race, '\n',
  "Share unable to fully pay: ", percent(tblPartialRent$`Share of borrowers expecting to be unable to fully pay their rent this month`, accuracy=0.1), 
  sep=""
)

g23B <- ggplot(data=tblPartialRent, mapping=aes(y=Race, x=`Share of borrowers expecting to be unable to fully pay their rent this month`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who expect to be unable to pay their rent or mortgage bill this month", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g23B, width=800, height=350, tooltip="text")
```
#### Figure 23: Ability to pay credit card bill
```{r PartialCC}
# PartialCC: # Credit card ‐ Are you expecting to be unable to pay or only make a partial payment on each of the following bills this month?

# table(shed$PartialCC)
shed.PartialCC <- shed %>% filter((PartialCC %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblPartialCC <- aggregate(data=shed.PartialCC, Weight ~ PartialCC + Race + State + AnyStudentLoans, FUN=sum)
tblPartialCC2 <- aggregate(data=shed.PartialCC, Weight ~ PartialCC + State + AnyStudentLoans, FUN=sum)
tblPartialCC2$Race <- rep("All", nrow(tblPartialCC2))
tblPartialCC <- rbind(tblPartialCC, tblPartialCC2)
tblPartialCC <- reshape2::dcast(data=tblPartialCC, Race + State + AnyStudentLoans~ PartialCC, value.var="Weight")
tblPartialCC$`Share of borrowers expecting to be unable to fully pay their credit card bill this month` <- tblPartialCC$Yes / (tblPartialCC$Yes + tblPartialCC$No)
tblPartialCC$Group <- rep(NA, nrow(tblPartialCC))
tblPartialCC$Group[tblPartialCC$State=="CA" & tblPartialCC$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblPartialCC$Group[tblPartialCC$State=="Rest of U.S." & tblPartialCC$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblPartialCC$Group[tblPartialCC$State=="CA" & tblPartialCC$AnyStudentLoans=="No"] <- "California non-borrowers"
tblPartialCC <- tblPartialCC %>% filter(is.na(Group)==FALSE)
tblPartialSL$Group <- factor(tblPartialSL$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to 
```{r figure23C}
tblPartialCC$`For Tooltip` <- paste(
  "State: ", tblPartialCC$State, '\n',
  "Student loan borrowers: ", tblPartialCC$AnyStudentLoans, '\n',
  "Group: ", tblPartialCC$Race, '\n',
  "Share unable to fully pay: ", percent(tblPartialCC$`Share of borrowers expecting to be unable to fully pay their credit card bill this month`, accuracy=0.1), 
  sep=""
)

g23C <- ggplot(data=tblPartialCC, mapping=aes(y=Race, x=`Share of borrowers expecting to be unable to fully pay their credit card bill this month`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who expect to be unable to pay their credit card bill this month", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g23C, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for "Figure 23: Ability to pay student loan bill" are
```{r PartialSL.SY, results = 'asis'}
survey_years(shed.PartialSL$SurveyYear)
```
Survey years 2020 and 2021 not included in "Figure 23: Ability to pay student loan bill" due to the federal student loan repayment pause. 

The survey years included for "Figure 23: Ability to pay rent or mortgage bill" and "Figure 23: Ability to pay credit card bill" are
```{r PartialRent.SY, results = 'asis'}
survey_years(shed.PartialRent$SurveyYear)
# I have checked and verified that these survey years match those used for the credit card bill analysis. 
```

**Notes:** Each of these analyses are limited to those who have each of these bills. Interpret results for subgroups with small sample sizes with caution. See the table below for the survey respondent sample size by subgroup.
```{r PartialSL.N}
N.PartialSL <- aggregate(data=shed.PartialSL, Count ~ Race + State, FUN=sum)
names(N.PartialSL) <- c("Group", "State", "Survey respondents")
kable(N.PartialSL, caption="N size by group for Figure 23: Ability to pay student loan bill") %>% kable_paper("hover", full_width = F)
```

```{r PartialRent.N}
N.PartialRent <- aggregate(data=shed.PartialRent, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.PartialRent <- N.PartialRent %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.PartialRent) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.PartialRent, caption="N size by group for Figure 23: Ability to pay rent or mortgage bill") %>% kable_paper("hover", full_width = F)
```

```{r PartialCC.N}
N.PartialCC <- aggregate(data=shed.PartialCC, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.PartialCC <- N.PartialCC %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.PartialCC) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.PartialCC, caption="N size by group for Figure 23: Ability to pay credit card bill") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Figure 24 displays the results of the first of a series of questions related to how much respondents' financial circumstances would be affected by a \$400 emergency expense. Overall, about 1 in 4 California borrowers (22.9 percent) would be unable to fully pay their monthly student loan bill if they had to pay a sudden \$400 expense to pay, with white California borrowers (12.7 percent) showing a greater ability to withstand the financial emergency than other groups. 

The California sample sizes for "Black, Non-Hispanic" and "Other, Non-Hispanic" are very small for Figure 24. I include the graph for the sake of transparency but recommend interpreting these results with great caution. 

### {.tabset}
```{r PartialSL400}
# PartialSL400: # Student loan ‐ Which of the following bills would you likely skip paying, or make only a partial payment on, if you had a $400 emergency expense that you had to pay?

# table(shed$PartialSL400)
shed.PartialSL400 <- shed %>% filter((PartialSL400 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) %>% filter(SurveyYear %in% c(2015, 2016, 2017, 2018, 2019)) 
tblPartialSL400 <- aggregate(data=shed.PartialSL400, Weight ~ PartialSL400 + Race + State, FUN=sum)
tblPartialSL4002 <- aggregate(data=shed.PartialSL400, Weight ~ PartialSL400 + State, FUN=sum)
tblPartialSL4002$Race <- rep("All", nrow(tblPartialSL4002))
tblPartialSL400 <- rbind(tblPartialSL400, tblPartialSL4002)
tblPartialSL400 <- reshape2::dcast(data=tblPartialSL400, Race + State ~ PartialSL400, value.var="Weight")
tblPartialSL400$`Share of borrowers who would skip paying, or make only a partial payment on, their student loan bill if they had a $400 emergency expense` <- tblPartialSL400$Yes / (tblPartialSL400$Yes + tblPartialSL400$No)
```
#### Figure 24
##### Responses to "Would you likely skip paying, or make only a partial payment on, your student loan bill if you had a $400 emergency expense that you had to pay?"
```{r figure24}
tblPartialSL400$`For Tooltip` <- paste(
  "State: ", tblPartialSL400$State, '\n',
  "Group: ", tblPartialSL400$Race, '\n',
  "Share who would not fully pay: ", percent(tblPartialSL400$`Share of borrowers who would skip paying, or make only a partial payment on, their student loan bill if they had a $400 emergency expense`, accuracy=0.1),
  sep=""
)

g24 <- ggplot(data=tblPartialSL400, mapping=aes(y=Race, x=`Share of borrowers who would skip paying, or make only a partial payment on, their student loan bill if they had a $400 emergency expense`, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(y="", title="", x="Share of borrowers who would not fully pay student loan bill") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g24, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 24 are
```{r PartialSL400.SY, results = 'asis'}
survey_years(shed.PartialSL400$SurveyYear)
```
Survey years 2020 and 2021 not included due to the federal student loan repayment pause.
 
**Notes:** This analysis is limited to those who have student loans. See the table below for the survey respondent sample size by subgroup.
```{r PartialSL400.N}
N.PartialSL400 <- aggregate(data=shed.PartialSL400, Count ~ Race + State, FUN=sum)
names(N.PartialSL400) <- c("Group", "State", "Survey respondents")
kable(N.PartialSL400, caption="N size by group for Figure 24") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Figure 25 shows results for a question about how a sudden \$400 expense would affect respondents' ability to pay other bills (besides the emergency expense). As with Figure 24, white California borrowers show the least likelihood of being unable fully pay their other bills (7.3 percent), with higher likelihoods for Black (19.5 percent) and Hispanic (24.2 percent) California borrowers. 

The results are not very different for non-borrowers in California. In general, student loan borrowers outside California (19.3 percent) would have more difficulty paying their monthly loans after the emergency expense than student loan borrowers in California (16.5 percent). 

### {.tabset}
```{r PayBills400}
# PayBills400: # How would a $400 emergency expense that you had to pay impact your ability to pay your other bills this month? 

# table(shed$PayBills400)
shed.PayBills400 <- shed %>% filter(is.na(PayBills400)==FALSE) %>% filter((PayBills400 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblPayBills400 <- aggregate(data=shed.PayBills400, Weight ~ PayBills400 + Race + State + AnyStudentLoans, FUN=sum)
tblPayBills4002 <- aggregate(data=shed.PayBills400, Weight ~ PayBills400 + State + AnyStudentLoans, FUN=sum)
tblPayBills4002$Race <- rep("All", nrow(tblPayBills4002))
tblPayBills400 <- rbind(tblPayBills400, tblPayBills4002)
tblPayBills400 <- reshape2::dcast(data=tblPayBills400, Race + State + AnyStudentLoans ~ PayBills400, value.var="Weight")
tblPayBills400$`Total weight` <- tblPayBills400$`I could not pay some other bills or would only make a partial payment on some of them` + tblPayBills400$`I would still be able to pay all of my other bills in full`
tblPayBills400$`I could not pay some other bills or would only make a partial payment on some of them` <- tblPayBills400$`I could not pay some other bills or would only make a partial payment on some of them` / tblPayBills400$`Total weight`
tblPayBills400$`I would still be able to pay all of my other bills in full` <- tblPayBills400$`I would still be able to pay all of my other bills in full` / tblPayBills400$`Total weight`
tblPayBills400 <- reshape2::melt(data=tblPayBills400, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblPayBills400$variable <- as.character(tblPayBills400$variable)
tblPayBills400$variable[tblPayBills400$variable=="I could not pay some other bills or would only make a partial payment on some of them"] <- "I could not fully pay some bills"
tblPayBills400$variable <- factor(tblPayBills400$variable, levels = c("I would still be able to pay all of my other bills in full", "I could not fully pay some bills"))
```
#### Figure 25: CA borrowers
##### Responses to "How would a $400 emergency expense that you had to pay impact your ability to pay your other bills this month?"
```{r figure25A}
tblPayBills400.CA.Borrow <- tblPayBills400 %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblPayBills400.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblPayBills400.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblPayBills400.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblPayBills400.CA.Borrow$Race, '\n',
  "Impact of emergency expense: ", tblPayBills400.CA.Borrow$variable, '\n',
  "Share: ", percent(tblPayBills400.CA.Borrow$Share, accuracy=0.1),
  sep=""
)

g25A <- ggplot(data=tblPayBills400.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g25A, width=800, height=350, tooltip="text")
```
#### Figure 25: Rest of U.S. borrowers
##### Responses to "How would a $400 emergency expense that you had to pay impact your ability to pay your other bills this month?"
```{r figure25B}
tblPayBills400.US.Borrow <- tblPayBills400 %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblPayBills400.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblPayBills400.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblPayBills400.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblPayBills400.US.Borrow$Race, '\n',
  "Impact of emergency expense: ", tblPayBills400.US.Borrow$variable, '\n',
  "Share: ", percent(tblPayBills400.US.Borrow$Share, accuracy=0.1),
  sep=""
)

g25B <- ggplot(data=tblPayBills400.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g25B, width=800, height=350, tooltip="text")
```
#### Figure 25: CA non-borrowers
##### Responses to "How would a $400 emergency expense that you had to pay impact your ability to pay your other bills this month?"
```{r figure25C}
tblPayBills400.CA.Nonborrow <- tblPayBills400 %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblPayBills400.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblPayBills400.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblPayBills400.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblPayBills400.CA.Nonborrow$Race, '\n',
  "Impact of emergency expense: ", tblPayBills400.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblPayBills400.CA.Nonborrow$Share, accuracy=0.1),
  sep=""
)

g25C <- ggplot(data=tblPayBills400.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g25C, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 25 are
```{r PayBills400.SY, results = 'asis'}
survey_years(shed.PayBills400$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r PayBills400.N}
N.PayBills400 <- aggregate(data=shed.PayBills400, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.PayBills400 <- N.PayBills400 %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.PayBills400) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.PayBills400, caption="N size by group for Figure 25") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Figure 26 is the first of two figures that considers the likelihood that respondents would be approved if they applied for a line of credit. Asked about their confidence that they would be approved for a new credit card, about a quarter (25.3 percent) of California borrowers say that they are "not confident," rising to about 4 in 10 (39.1 percent) among Black California borrowers. The majority of white California borrowers (58.1 percent) and those of another race (59.9 percent) say they are "very confident." 

The results are not very different for student loan borrowers outside California. By and large, non-borrowers in California are much more likely to feel confident about being approved for a credit card than student loan borrowers in California. 

### {.tabset}
```{r CCApprov}
# CCApprov: # If you were to apply for a credit card today, how confident are you that you would be approved? 

# table(shed$CCApprov)
shed.CCApprov <- shed %>% filter(is.na(CCApprov)==FALSE) %>% filter((CCApprov %in% c("Refused", "Not In Universe (not asked)", "Don't know", "")==FALSE)) 
tblCCApprov <- aggregate(data=shed.CCApprov, Weight ~ CCApprov + Race + State + AnyStudentLoans, FUN=sum)
tblCCApprov2 <- aggregate(data=shed.CCApprov, Weight ~ CCApprov + State + AnyStudentLoans, FUN=sum)
tblCCApprov2$Race <- rep("All", nrow(tblCCApprov2))
tblCCApprov <- rbind(tblCCApprov, tblCCApprov2)
tblCCApprov <- reshape2::dcast(data=tblCCApprov, Race + State + AnyStudentLoans ~ CCApprov, value.var="Weight")
tblCCApprov$`Total weight` <- tblCCApprov$`Not confident` + tblCCApprov$`Somewhat confident` +  tblCCApprov$`Very confident`
tblCCApprov$`Not confident` <- tblCCApprov$`Not confident` / tblCCApprov$`Total weight`
tblCCApprov$`Somewhat confident` <- tblCCApprov$`Somewhat confident` / tblCCApprov$`Total weight`
tblCCApprov$`Very confident` <- tblCCApprov$`Very confident` / tblCCApprov$`Total weight`
tblCCApprov <- reshape2::melt(data=tblCCApprov, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblCCApprov$variable <- factor(tblCCApprov$variable, levels = c("Very confident", "Somewhat confident", "Not confident"))
```
#### Figure 26: CA borrowers
##### Responses to "If you were to apply for a credit card today, how confident are you that you would be approved?"
```{r figure26A}
tblCCApprov.CA.Borrow <- tblCCApprov %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblCCApprov.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblCCApprov.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblCCApprov.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblCCApprov.CA.Borrow$Race, '\n',
  "Confidence in approval: ", tblCCApprov.CA.Borrow$variable, '\n',
  "Share: ", percent(tblCCApprov.CA.Borrow$`Share`, accuracy=0.1),
  sep=""
)

g26A <- ggplot(data=tblCCApprov.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g26A, width=800, height=350, tooltip="text")
```
#### Figure 26: Rest of U.S. borrowers
##### Responses to "If you were to apply for a credit card today, how confident are you that you would be approved?"
```{r figure26B}
tblCCApprov.US.Borrow <- tblCCApprov %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblCCApprov.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblCCApprov.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblCCApprov.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblCCApprov.US.Borrow$Race, '\n',
  "Confidence in approval: ", tblCCApprov.US.Borrow$variable, '\n',
  "Share: ", percent(tblCCApprov.US.Borrow$`Share`, accuracy=0.1),
  sep=""
)

g26B <- ggplot(data=tblCCApprov.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g26B, width=800, height=350, tooltip="text")
```
#### Figure 26: CA non-borrowers
##### Responses to "If you were to apply for a credit card today, how confident are you that you would be approved?"
```{r figure26C}
tblCCApprov.CA.Nonborrow <- tblCCApprov %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblCCApprov.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblCCApprov.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblCCApprov.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblCCApprov.CA.Nonborrow$Race, '\n',
  "Confidence in approval: ", tblCCApprov.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblCCApprov.CA.Nonborrow$`Share`, accuracy=0.1),
  sep=""
)

g26C <- ggplot(data=tblCCApprov.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g26C, width=800, height=350)

# dataset$`For Tooltip` <- paste(
#   "var1: ", dataset$variable, '\n', 
#   "var2: ", dataset$variable, 
#   sep=""
# )
# , text=`For Tooltip`
# , tooltip="text"
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 26 are
```{r CCApprov.SY, results = 'asis'}
survey_years(shed.CCApprov$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r CCApprov.N}
N.CCApprov <- aggregate(data=shed.CCApprov, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.CCApprov <- N.CCApprov %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.CCApprov) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.CCApprov, caption="N size by group for Figure 26") %>% kable_paper("hover", full_width = F)
```


***

### {-}

Figure 27 shows how frequently respondents say that they were turned down for credit in the prior 12 months. In general, student loan borrowers appear more likely to report being turned down than non-borrowers. Almost 1 in 3 student loan borrowers in California (32.1 percent) and the rest of the U.S. (31.6 percent) say they were turned down, compared to fewer than 1 in 5 among California non-borrowers (18.6 percent).  

In general, Black (53.5 percent in California) and Hispanic (37.6 percent in California) student loan borrowers are the most likely to say that they were turned down.  

### {.tabset}
```{r CreditDeny}
# CreditDeny: # Turned down for credit ‐ In the past 12 months, has each of the following happened to you or your spouse/partner: 

# table(shed$CreditDeny)
shed.CreditDeny <- shed %>% filter((CreditDeny %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblCreditDeny <- aggregate(data=shed.CreditDeny, Weight ~ CreditDeny + Race + State + AnyStudentLoans, FUN=sum)
tblCreditDeny2 <- aggregate(data=shed.CreditDeny, Weight ~ CreditDeny + State + AnyStudentLoans, FUN=sum)
tblCreditDeny2$Race <- rep("All", nrow(tblCreditDeny2))
tblCreditDeny <- rbind(tblCreditDeny, tblCreditDeny2)
tblCreditDeny <- reshape2::dcast(data=tblCreditDeny, Race + State + AnyStudentLoans ~ CreditDeny, value.var="Weight")
tblCreditDeny$`Share of borrowers who were turned down for credit in the past 12 months` <- tblCreditDeny$Yes / (tblCreditDeny$Yes + tblCreditDeny$No)
tblCreditDeny$Group <- rep(NA, nrow(tblCreditDeny))
tblCreditDeny$Group[tblCreditDeny$State=="CA" & tblCreditDeny$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblCreditDeny$Group[tblCreditDeny$State=="Rest of U.S." & tblCreditDeny$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblCreditDeny$Group[tblCreditDeny$State=="CA" & tblCreditDeny$AnyStudentLoans=="No"] <- "California non-borrowers"
tblCreditDeny <- tblCreditDeny %>% filter(is.na(Group)==FALSE)
tblCreditDeny$Group <- factor(tblCreditDeny$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
#### Figure 27
##### Responses to "In the past 12 months, have you or your spouse/partner been turned down for credit?"
```{r figure27}
tblCreditDeny$`For Tooltip` <- paste(
  "State: ", tblCreditDeny$State, '\n',
  "Student loan borrowers: ", tblCreditDeny$AnyStudentLoans, '\n',
  "Group: ", tblCreditDeny$Race, '\n',
  "Share turned down for credit: ", percent(tblCreditDeny$`Share of borrowers who were turned down for credit in the past 12 months`, accuracy=0.1),
  sep=""
)

g27 <- ggplot(data=tblCreditDeny, mapping=aes(y=Race, x=`Share of borrowers who were turned down for credit in the past 12 months`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who were turned down for credit in the past 12 months", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g27, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 27 are
```{r CreditDeny.SY, results = 'asis'}
survey_years(shed.CreditDeny$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r CreditDeny.N}
N.CreditDeny <- aggregate(data=shed.CreditDeny, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.CreditDeny <- N.CreditDeny %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.CreditDeny) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.CreditDeny, caption="N size by group for Figure 27") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Figure 28 contains six tabs corresponding to different public benefits households can claim: 

* Social Security, including old age and disability insurance
* Cash assistance, including SSI, TANF, or cash from a welfare program
* The Earned Income Tax Credit
* Food benefits through the Supplemental Nutrition Assistance Program (SNAP, formerly food stamps)
* Housing assistance from a government program 
* Free or reduced-price school lunch 

Whether it is considered good or bad to have higher rates along these measures is in the eye of the beholder. Taking cash assistance as an example, it is a good thing for the finances of a household in need to receive that benefit, but it is a bad sign of the household's finances if they are eligible. Therefore, I do not comment on the results here but leave it to the reader to explore. 

The sample for "Figure 28: Free or reduced price lunch" is limited to those with children under 18. This cuts the sample size, and as a result, the sample size for for California student loan borrowers in that tab is quite small. Interpret those results with some caution. 

### {.tabset}
#### Figure 28: Social Security
```{r SocSec}
# SocSec: # Social Security (including old age and DI) -In the past 12 months, did you [and/or your spouse/parnter] receive any income from the following sources:

# table(shed$SocSec)
shed.SocSec <- shed %>% filter((SocSec %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblSocSec <- aggregate(data=shed.SocSec, Weight ~ SocSec + Race + State + AnyStudentLoans, FUN=sum)
tblSocSec2 <- aggregate(data=shed.SocSec, Weight ~ SocSec + State + AnyStudentLoans, FUN=sum)
tblSocSec2$Race <- rep("All", nrow(tblSocSec2))
tblSocSec <- rbind(tblSocSec, tblSocSec2)
tblSocSec <- reshape2::dcast(data=tblSocSec, Race + State + AnyStudentLoans ~ SocSec, value.var="Weight")
tblSocSec$`Share` <- tblSocSec$Yes / (tblSocSec$Yes + tblSocSec$No)
tblSocSec$Group <- rep(NA, nrow(tblSocSec))
tblSocSec$Group[tblSocSec$State=="CA" & tblSocSec$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblSocSec$Group[tblSocSec$State=="Rest of U.S." & tblSocSec$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblSocSec$Group[tblSocSec$State=="CA" & tblSocSec$AnyStudentLoans=="No"] <- "California non-borrowers"
tblSocSec <- tblSocSec %>% filter(is.na(Group)==FALSE)
tblSocSec$Group <- factor(tblSocSec$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "In the past 12 months, have you [and/or your spouse/ parnter] received Social Security (including old age and DI)?"
```{r figure28A}
tblSocSec$`For Tooltip` <- paste(
  "State: ", tblSocSec$State, '\n',
  "Student loan borrowers: ", tblSocSec$AnyStudentLoans, '\n',
  "Group: ", tblSocSec$Race, '\n',
  "Share who receive Social Security: ", percent(tblSocSec$`Share`, accuracy=0.1),
  sep=""
)

g28A <- ggplot(data=tblSocSec, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who received Social Security", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols) 

ggplotly(g28A, width=800, height=350, tooltip="text")
```
#### Figure 28: Cash assistance
```{r Welfare}
# Welfare: # Supplemental Security Income (SSI), TANF, or cash assistance from a welfare program - In the past 12 months, did you [and/or your spouse/parnter] receive any income from the following sources: 

# table(shed$Welfare)
shed.Welfare <- shed %>% filter((Welfare %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblWelfare <- aggregate(data=shed.Welfare, Weight ~ Welfare + Race + State + AnyStudentLoans, FUN=sum)
tblWelfare2 <- aggregate(data=shed.Welfare, Weight ~ Welfare + State + AnyStudentLoans, FUN=sum)
tblWelfare2$Race <- rep("All", nrow(tblWelfare2))
tblWelfare <- rbind(tblWelfare, tblWelfare2)
tblWelfare <- reshape2::dcast(data=tblWelfare, Race + State + AnyStudentLoans ~ Welfare, value.var="Weight")
tblWelfare$`Share` <- tblWelfare$Yes / (tblWelfare$Yes + tblWelfare$No)
tblWelfare$Group <- rep(NA, nrow(tblWelfare))
tblWelfare$Group[tblWelfare$State=="CA" & tblWelfare$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblWelfare$Group[tblWelfare$State=="Rest of U.S." & tblWelfare$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblWelfare$Group[tblWelfare$State=="CA" & tblWelfare$AnyStudentLoans=="No"] <- "California non-borrowers"
tblWelfare <- tblWelfare %>% filter(is.na(Group)==FALSE)
tblWelfare$Group <- factor(tblWelfare$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "In the past 12 months, have you [and/or your spouse/ parnter] received Supplemental Security Income (SSI), TANF, or cash assistance from a welfare program?"
```{r figure28B}
tblWelfare$`For Tooltip` <- paste(
  "State: ", tblWelfare$State, '\n',
  "Student loan borrowers: ", tblWelfare$AnyStudentLoans, '\n',
  "Group: ", tblWelfare$Race, '\n',
  "Share who receive cash assistance: ", percent(tblWelfare$`Share`, accuracy=0.1),
  sep=""
)

g28B <- ggplot(data=tblWelfare, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who received cash assistance (TANF, SSI, etc.)", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g28B, width=800, height=350, tooltip="text")
```
#### Figure 28: EITC
```{r EITC}
# EITC: # Earned Income Tax Credit (EITC) - In the past 12 months, have you [and/or your spouse/parnter] received any of the following?

# table(shed$EITC)
shed.EITC <- shed %>% filter((EITC %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblEITC <- aggregate(data=shed.EITC, Weight ~ EITC + Race + State + AnyStudentLoans, FUN=sum)
tblEITC2 <- aggregate(data=shed.EITC, Weight ~ EITC + State + AnyStudentLoans, FUN=sum)
tblEITC2$Race <- rep("All", nrow(tblEITC2))
tblEITC <- rbind(tblEITC, tblEITC2)
tblEITC <- reshape2::dcast(data=tblEITC, Race + State + AnyStudentLoans ~ EITC, value.var="Weight")
tblEITC$`Share` <- tblEITC$Yes / (tblEITC$Yes + tblEITC$No)
tblEITC$Group <- rep(NA, nrow(tblEITC))
tblEITC$Group[tblEITC$State=="CA" & tblEITC$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblEITC$Group[tblEITC$State=="Rest of U.S." & tblEITC$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblEITC$Group[tblEITC$State=="CA" & tblEITC$AnyStudentLoans=="No"] <- "California non-borrowers"
tblEITC <- tblEITC %>% filter(is.na(Group)==FALSE)
tblEITC$Group <- factor(tblEITC$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "In the past 12 months, have you [and/or your spouse/ parnter] received the Earned Income Tax Credit (EITC)?"
```{r figure28C}
tblEITC$`For Tooltip` <- paste(
  "State: ", tblEITC$State, '\n',
  "Student loan borrowers: ", tblEITC$AnyStudentLoans, '\n',
  "Group: ", tblEITC$Race, '\n',
  "Share who receive the EITC: ", percent(tblEITC$`Share`, accuracy=0.1),
  sep=""
)

g28C <- ggplot(data=tblEITC, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who received the Earned Income Tax Credit", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g28C, width=800, height=350, tooltip="text")
```
#### Figure 28: SNAP
```{r SNAP}
# SNAP: # Supplemental Nutrition Assistance Program (SNAP or food stamps) - In the past 12 months, have you [and/or your spouse/parnter] received any of the following? 

# table(shed$SNAP)
shed.SNAP <- shed %>% filter((SNAP %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblSNAP <- aggregate(data=shed.SNAP, Weight ~ SNAP + Race + State + AnyStudentLoans, FUN=sum)
tblSNAP2 <- aggregate(data=shed.SNAP, Weight ~ SNAP + State + AnyStudentLoans, FUN=sum)
tblSNAP2$Race <- rep("All", nrow(tblSNAP2))
tblSNAP <- rbind(tblSNAP, tblSNAP2)
tblSNAP <- reshape2::dcast(data=tblSNAP, Race + State + AnyStudentLoans ~ SNAP, value.var="Weight")
tblSNAP$`Share` <- tblSNAP$Yes / (tblSNAP$Yes + tblSNAP$No)
tblSNAP$Group <- rep(NA, nrow(tblSNAP))
tblSNAP$Group[tblSNAP$State=="CA" & tblSNAP$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblSNAP$Group[tblSNAP$State=="Rest of U.S." & tblSNAP$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblSNAP$Group[tblSNAP$State=="CA" & tblSNAP$AnyStudentLoans=="No"] <- "California non-borrowers"
tblSNAP <- tblSNAP %>% filter(is.na(Group)==FALSE)
tblSNAP$Group <- factor(tblSNAP$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "In the past 12 months, have you [and/or your spouse/ parnter] received Supplemental Nutrition Assistance Program (SNAP or food stamps)?"
```{r figure28D}
tblSNAP$`For Tooltip` <- paste(
  "State: ", tblSNAP$State, '\n',
  "Student loan borrowers: ", tblSNAP$AnyStudentLoans, '\n',
  "Group: ", tblSNAP$Race, '\n',
  "Share who receive SNAP: ", percent(tblSNAP$`Share`, accuracy=0.1),
  sep=""
)

g28D <- ggplot(data=tblSNAP, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who received SNAP", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g28D, width=800, height=350, tooltip="text")
```
#### Figure 28: Housing assistance
```{r HouseAssist}
# HouseAssist: # Housing assistance from government program - In the past 12 months, have you [and/or your spouse/parnter] received any of the following? 

# table(shed$HouseAssist)
shed.HouseAssist <- shed %>% filter((HouseAssist %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblHouseAssist <- aggregate(data=shed.HouseAssist, Weight ~ HouseAssist + Race + State + AnyStudentLoans, FUN=sum)
tblHouseAssist2 <- aggregate(data=shed.HouseAssist, Weight ~ HouseAssist + State + AnyStudentLoans, FUN=sum)
tblHouseAssist2$Race <- rep("All", nrow(tblHouseAssist2))
tblHouseAssist <- rbind(tblHouseAssist, tblHouseAssist2)
tblHouseAssist <- reshape2::dcast(data=tblHouseAssist, Race + State + AnyStudentLoans ~ HouseAssist, value.var="Weight")
tblHouseAssist$`Share` <- tblHouseAssist$Yes / (tblHouseAssist$Yes + tblHouseAssist$No)
tblHouseAssist$Group <- rep(NA, nrow(tblHouseAssist))
tblHouseAssist$Group[tblHouseAssist$State=="CA" & tblHouseAssist$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblHouseAssist$Group[tblHouseAssist$State=="Rest of U.S." & tblHouseAssist$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblHouseAssist$Group[tblHouseAssist$State=="CA" & tblHouseAssist$AnyStudentLoans=="No"] <- "California non-borrowers"
tblHouseAssist <- tblHouseAssist %>% filter(is.na(Group)==FALSE)
tblHouseAssist$Group <- factor(tblHouseAssist$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "In the past 12 months, have you [and/or your spouse/ parnter] received housing assistance from a government program?"
```{r figure28E}
tblHouseAssist$`For Tooltip` <- paste(
  "State: ", tblHouseAssist$State, '\n',
  "Student loan borrowers: ", tblHouseAssist$AnyStudentLoans, '\n',
  "Group: ", tblHouseAssist$Race, '\n',
  "Share who receive housing assistance: ", percent(tblHouseAssist$`Share`, accuracy=0.1),
  sep=""
)

g28E <- ggplot(data=tblHouseAssist, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who received housing assistance", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g28E, width=800, height=350, tooltip="text")
```
#### Figure 28: Free or reduced price lunch
```{r FRPL}
# FRPL: # Free or reduced price school lunches - In the past 12 months, have you [and/or your spouse/ parnter] received any of the following? 

# table(shed$FRPL)
shed.FRPL <- shed %>% filter((FRPL %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) %>% filter(ChildrenUnder18=="Yes")
tblFRPL <- aggregate(data=shed.FRPL, Weight ~ FRPL + Race + State + AnyStudentLoans, FUN=sum)
tblFRPL2 <- aggregate(data=shed.FRPL, Weight ~ FRPL + State + AnyStudentLoans, FUN=sum)
tblFRPL2$Race <- rep("All", nrow(tblFRPL2))
tblFRPL <- rbind(tblFRPL, tblFRPL2)
tblFRPL <- reshape2::dcast(data=tblFRPL, Race + State + AnyStudentLoans ~ FRPL, value.var="Weight")
tblFRPL$`Share` <- tblFRPL$Yes / (tblFRPL$Yes + tblFRPL$No)
tblFRPL$Group <- rep(NA, nrow(tblFRPL))
tblFRPL$Group[tblFRPL$State=="CA" & tblFRPL$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblFRPL$Group[tblFRPL$State=="Rest of U.S." & tblFRPL$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblFRPL$Group[tblFRPL$State=="CA" & tblFRPL$AnyStudentLoans=="No"] <- "California non-borrowers"
tblFRPL <- tblFRPL %>% filter(is.na(Group)==FALSE)
tblFRPL$Group <- factor(tblFRPL$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "In the past 12 months, have you [and/or your spouse/ parnter] received free or reduced price school lunches?"
```{r figure28F}
tblFRPL$`For Tooltip` <- paste(
  "State: ", tblFRPL$State, '\n',
  "Student loan borrowers: ", tblFRPL$AnyStudentLoans, '\n',
  "Group: ", tblFRPL$Race, '\n',
  "Share who receive housing assistance: ", percent(tblFRPL$`Share`, accuracy=0.1),
  sep=""
)

g28F <- ggplot(data=tblFRPL, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who received free or reduced price lunch", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g28F, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for "Figure 28: Social Security" are
```{r SocSec.SY, results = 'asis'}
survey_years(shed.SocSec$SurveyYear)
```
The survey years included for all other versions of Figure 28 are
```{r Welfare.SY, results = 'asis'}
survey_years(shed.Welfare$SurveyYear)
# I have checked and verified that the survey years for these analyses are all the same. 
```

**Notes:** See the tables below for the survey respondent sample size by subgroup.
```{r SocSec.N}
N.SocSec <- aggregate(data=shed.SocSec, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.SocSec <- N.SocSec %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.SocSec) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.SocSec, caption="N size by group for Figure 28: Social Security") %>% kable_paper("hover", full_width = F)
```

```{r Welfare.N}
N.Welfare <- aggregate(data=shed.Welfare, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.Welfare <- N.Welfare %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.Welfare) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.Welfare, caption="N size by group for Figure 28: Cash assistance") %>% kable_paper("hover", full_width = F)
```

```{r EITC.N}
N.EITC <- aggregate(data=shed.EITC, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.EITC <- N.EITC %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.EITC) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.EITC, caption="N size by group for Figure 28: EITC") %>% kable_paper("hover", full_width = F)
```

```{r SNAP.N}
N.SNAP <- aggregate(data=shed.SNAP, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.SNAP <- N.SNAP %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.SNAP) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.SNAP, caption="N size by group for Figure 28: SNAP") %>% kable_paper("hover", full_width = F)
```

```{r HouseAssist.N}
N.HouseAssist <- aggregate(data=shed.HouseAssist, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.HouseAssist <- N.HouseAssist %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.HouseAssist) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.HouseAssist, caption="N size by group for Figure 28: Housing Assistance") %>% kable_paper("hover", full_width = F)
```

```{r FRPL.N}
N.FRPL <- aggregate(data=shed.FRPL, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.FRPL <- N.FRPL %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.FRPL) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.FRPL, caption="N size by group for Figure 28: FRPL") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Methodologically, Figure 29 requires a little more explaining than other figures in this section. The data shown in Figure 29 are based on two questions in the SHED survey: 

* The first question is, "Have you set aside emergency or rainy day funds that would cover your expenses for 3 months in case of sickness, job loss, economic downturn, or other emergencies?" 
* The second question is only asked to those who answered "No" to the prior question. The second question is, "If you were to lose your main source of income (for example, job or government benefits), could you cover your expenses for 3 months by borrowing money, using savings, or selling assets?"

I combined the responses to these two questions into one variable that takes three values: "I can cover three months of expenses with my rainy day funds," "I can cover three months of expenses by another means besides rainy day funds," and "I cannot replace the income needed for three months of expenses." 

About 3 in 4 non-borrowers in California (72.9 percent) report being confident that they can replace income for three months through some means, compared to about 6 in 10 student loan borrowers in California (59.6 percent). In California, Black borrowers report having a sufficient rainy day fund much less often (24.0 percent) than do white borrowers (41.6 percent). 

### {.tabset}
```{r ThreeMonExpenses}
shed$ThreeMonExpenses <- rep(NA, nrow(shed))
shed$ThreeMonExpenses[shed$ThreeMonSave=="Yes"] <- "I can cover three months of expenses with my rainy day funds"
shed$ThreeMonExpenses[shed$ThreeMonCover=="Yes"] <- "I can cover three months of expenses by another means (but not with my rainy day funds)"
shed$ThreeMonExpenses[shed$ThreeMonCover=="No"] <- "I cannot replace the income needed for three months of expenses"

shed.ThreeMonExpenses <- shed %>% filter(is.na(ThreeMonExpenses)==FALSE)
tblThreeMonExpenses <- aggregate(data=shed.ThreeMonExpenses, Weight ~ ThreeMonExpenses + Race + State + AnyStudentLoans, FUN=sum)
tblThreeMonExpenses2 <- aggregate(data=shed.ThreeMonExpenses, Weight ~ ThreeMonExpenses + State + AnyStudentLoans, FUN=sum)
tblThreeMonExpenses2$Race <- rep("All", nrow(tblThreeMonExpenses2))
tblThreeMonExpenses <- rbind(tblThreeMonExpenses, tblThreeMonExpenses2)
tblThreeMonExpenses <- reshape2::dcast(data=tblThreeMonExpenses, Race + State + AnyStudentLoans ~ ThreeMonExpenses, value.var="Weight")
tblThreeMonExpenses$`Total weight` <- tblThreeMonExpenses$`I can cover three months of expenses with my rainy day funds` + tblThreeMonExpenses$`I cannot replace the income needed for three months of expenses` + tblThreeMonExpenses$`I can cover three months of expenses by another means (but not with my rainy day funds)`
tblThreeMonExpenses$`I can cover three months of expenses with my rainy day funds` <- tblThreeMonExpenses$`I can cover three months of expenses with my rainy day funds` / tblThreeMonExpenses$`Total weight`
tblThreeMonExpenses$`I can cover three months of expenses by another means (but not with my rainy day funds)` <- tblThreeMonExpenses$`I can cover three months of expenses by another means (but not with my rainy day funds)` / tblThreeMonExpenses$`Total weight`
tblThreeMonExpenses$`I cannot replace the income needed for three months of expenses` <- tblThreeMonExpenses$`I cannot replace the income needed for three months of expenses` / tblThreeMonExpenses$`Total weight`
tblThreeMonExpenses <- reshape2::melt(data=tblThreeMonExpenses, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblThreeMonExpenses$variable <- factor(tblThreeMonExpenses$variable, levels = c("I cannot replace the income needed for three months of expenses", "I can cover three months of expenses by another means (but not with my rainy day funds)", "I can cover three months of expenses with my rainy day funds"))
```
#### Figure 29: CA borrowers
##### Ability to cover three months of expenses using rainy day funds or another source
```{r figure29A}
tblThreeMonExpenses.CA.Borrow <- tblThreeMonExpenses %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblThreeMonExpenses.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblThreeMonExpenses.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblThreeMonExpenses.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblThreeMonExpenses.CA.Borrow$Race, '\n',
  "Response: ", tblThreeMonExpenses.CA.Borrow$variable, '\n',
  "Share: ", percent(tblThreeMonExpenses.CA.Borrow$`Share`, accuracy=0.1), 
  sep=""
)

g29A <- ggplot(data=tblThreeMonExpenses.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g29A, width=800, height=350, tooltip="text") %>% layout(legend = list(orientation = 'h'))
```
#### Figure 29: Rest of U.S. borrowers
##### Ability to cover three months of expenses using rainy day funds or another source
```{r figure29B}
tblThreeMonExpenses.US.Borrow <- tblThreeMonExpenses %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblThreeMonExpenses.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblThreeMonExpenses.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblThreeMonExpenses.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblThreeMonExpenses.US.Borrow$Race, '\n',
  "Response: ", tblThreeMonExpenses.US.Borrow$variable, '\n',
  "Share: ", percent(tblThreeMonExpenses.US.Borrow$`Share`, accuracy=0.1), 
  sep=""
)

g29B <- ggplot(data=tblThreeMonExpenses.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g29B, width=800, height=350, tooltip="text") %>% layout(legend = list(orientation = 'h'))
```
#### Figure 29: CA non-borrowers
##### Ability to cover three months of expenses using rainy day funds or another source
```{r figure29C}
tblThreeMonExpenses.CA.Nonborrow <- tblThreeMonExpenses %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblThreeMonExpenses.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblThreeMonExpenses.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblThreeMonExpenses.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblThreeMonExpenses.CA.Nonborrow$Race, '\n',
  "Response: ", tblThreeMonExpenses.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblThreeMonExpenses.CA.Nonborrow$`Share`, accuracy=0.1), 
  sep=""
)

g29C <- ggplot(data=tblThreeMonExpenses.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g29C, width=800, height=350, tooltip="text") %>% layout(legend = list(orientation = 'h'))
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 29 are
```{r ThreeMonExpenses.SY, results = 'asis'}
survey_years(shed.ThreeMonExpenses$SurveyYear)
```

**Notes:** See the tables below for the survey respondent sample size by subgroup.
```{r ThreeMonExpenses.N}
N.ThreeMonExpenses <- aggregate(data=shed.ThreeMonExpenses, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.ThreeMonExpenses <- N.ThreeMonExpenses %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.ThreeMonExpenses) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.ThreeMonExpenses, caption="N size by group for Figure 29") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Figure 30 continues on the theme of how the respondents would financially manage during an unexpected emergency. There are eight tabs, each representing to a different way of paying a \$400 sudden expense. They highly vary in terms of interest rates and the effort required to access that financing: 

* Using cash or savings is the simplest and likely has the least significant long-term consequences, followed next by charging the expense to a credit card and paying it off in full that same month.
* Letting the credit card expense roll over, or using a bank loan, means there will be accumulated interest and some more effort required. 
* Borrowing from a friend could be low-risk depending on the circumstance, but it could also add to the risk that the expense causes someone's interpersonal relationships to suffer long-term.
* Selling one's items requires time and energy, and depending on what is sold, it could mean parting with necessities (such as a car or an amenity) or items with genuine sentimental value. 
* The typical payday loan has an APR that is [more than 40 times](https://www.cnbc.com/2021/02/16/map-shows-typical-payday-loan-rate-in-each-state.html) the typical credit card interest rate. 
* Finally, a respondent could say that they simply cannot pay the \$400 emergency expense. 

A respondent can select more than one method of finance: for example, a household might borrow from a friend and use a payday loan. In other words, the sum of the bars for a group adds up to more than 100 percent. 

Around 40 to 50 percent of all groups would pay in cash. White borrowers (41.7 percent among California borrowers) and those in the "Other, Non-Hispanic" (49.5 percent among California borrowers) are the most likely to pay with a credit card and not let the balance roll over. Black and Hispanic respondents are virtually the only respondents to say they would use a payday loan, although it it less than 8 percent across state and borrower categories. Lastly, Black (18.9 percent among California borrowers) and Hispanic (17.6 percent among California borrowers) respondents are more likely to say that they cannot cover the expense. 

In general, the margins between California student loan borrowers, borrowers in the rest of the U.S., and California non-borrowers are all rather small. 

### {.tabset}
#### Figure 30: Pay $400 with cash or savings
```{r Cash400}
# Cash400: # With the money currently in my checking/savings account or with cash ‐ Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? 

# table(shed$Cash400)
shed.Cash400 <- shed %>% filter((Cash400 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblCash400 <- aggregate(data=shed.Cash400, Weight ~ Cash400 + Race + State + AnyStudentLoans, FUN=sum)
tblCash4002 <- aggregate(data=shed.Cash400, Weight ~ Cash400 + State + AnyStudentLoans, FUN=sum)
tblCash4002$Race <- rep("All", nrow(tblCash4002))
tblCash400 <- rbind(tblCash400, tblCash4002)
tblCash400 <- reshape2::dcast(data=tblCash400, Race + State + AnyStudentLoans ~ Cash400, value.var="Weight")
tblCash400$`Share` <- tblCash400$Yes / (tblCash400$Yes + tblCash400$No)

tblCash400$Group <- rep(NA, nrow(tblCash400))
tblCash400$Group[tblCash400$State=="CA" & tblCash400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblCash400$Group[tblCash400$State=="Rest of U.S." & tblCash400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblCash400$Group[tblCash400$State=="CA" & tblCash400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblCash400 <- tblCash400 %>% filter(is.na(Group)==FALSE)
tblCash400$Group <- factor(tblCash400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [With the money currently in my checking/savings account or with cash]"
```{r figure30C}
tblCash400$`For Tooltip` <- paste(
  "State: ", tblCash400$State, '\n',
  "Student loan borrowers: ", tblCash400$AnyStudentLoans, '\n',
  "Group: ", tblCash400$Race, '\n',
  "Share: ", percent(tblCash400$`Share`, accuracy=0.1),
  sep=""
)

g30C <- ggplot(data=tblCash400, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would pay with cash or money in checking or savings", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g30C, width=800, height=350, tooltip="text")
```
#### Figure 30: Pay $400 with credit card (no interest)
```{r CCA400}
# CCA400: # Put it on my credit card and pay it off in full at the next statement ‐ Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? 

# table(shed$CCA400)
shed.CCA400 <- shed %>% filter((CCA400 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblCCA400 <- aggregate(data=shed.CCA400, Weight ~ CCA400 + Race + State + AnyStudentLoans, FUN=sum)
tblCCA4002 <- aggregate(data=shed.CCA400, Weight ~ CCA400 + State + AnyStudentLoans, FUN=sum)
tblCCA4002$Race <- rep("All", nrow(tblCCA4002))
tblCCA400 <- rbind(tblCCA400, tblCCA4002)
tblCCA400 <- reshape2::dcast(data=tblCCA400, Race + State + AnyStudentLoans ~ CCA400, value.var="Weight")
tblCCA400$`Share` <- tblCCA400$Yes / (tblCCA400$Yes + tblCCA400$No)

tblCCA400$Group <- rep(NA, nrow(tblCCA400))
tblCCA400$Group[tblCCA400$State=="CA" & tblCCA400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblCCA400$Group[tblCCA400$State=="Rest of U.S." & tblCCA400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblCCA400$Group[tblCCA400$State=="CA" & tblCCA400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblCCA400 <- tblCCA400 %>% filter(is.na(Group)==FALSE)
tblCCA400$Group <- factor(tblCCA400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [Put it on my credit card and pay it off in full at the next statement]"
```{r figure30A}
tblCCA400$`For Tooltip` <- paste(
  "State: ", tblCCA400$State, '\n',
  "Student loan borrowers: ", tblCCA400$AnyStudentLoans, '\n',
  "Group: ", tblCCA400$Race, '\n',
  "Share: ", percent(tblCCA400$`Share`, accuracy=0.1),
  sep=""
)

g30A <- ggplot(data=tblCCA400, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would put it on a credit card and pay it off immediately", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g30A, width=800, height=350, tooltip="text")
```
#### Figure 30: Pay $400 with credit card (with interest)
```{r CCB400}
# CCB400: # Put it on my credit card and pay it off over time ‐ Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense?

# table(shed$CCB400)
shed.CCB400 <- shed %>% filter((CCB400 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblCCB400 <- aggregate(data=shed.CCB400, Weight ~ CCB400 + Race + State + AnyStudentLoans, FUN=sum)
tblCCB4002 <- aggregate(data=shed.CCB400, Weight ~ CCB400 + State + AnyStudentLoans, FUN=sum)
tblCCB4002$Race <- rep("All", nrow(tblCCB4002))
tblCCB400 <- rbind(tblCCB400, tblCCB4002)
tblCCB400 <- reshape2::dcast(data=tblCCB400, Race + State + AnyStudentLoans ~ CCB400, value.var="Weight")
tblCCB400$`Share` <- tblCCB400$Yes / (tblCCB400$Yes + tblCCB400$No)

tblCCB400$Group <- rep(NA, nrow(tblCCB400))
tblCCB400$Group[tblCCB400$State=="CA" & tblCCB400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblCCB400$Group[tblCCB400$State=="Rest of U.S." & tblCCB400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblCCB400$Group[tblCCB400$State=="CA" & tblCCB400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblCCB400 <- tblCCB400 %>% filter(is.na(Group)==FALSE)
tblCCB400$Group <- factor(tblCCB400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [Put it on my credit card and pay it off over time]"
```{r figure30B}
tblCCB400$`For Tooltip` <- paste(
  "State: ", tblCCB400$State, '\n',
  "Student loan borrowers: ", tblCCB400$AnyStudentLoans, '\n',
  "Group: ", tblCCB400$Race, '\n',
  "Share: ", percent(tblCCB400$`Share`, accuracy=0.1),
  sep=""
)

g30B <- ggplot(data=tblCCB400, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would put it on a credit card and pay it off over time", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g30B, width=800, height=350, tooltip="text")
```
#### Figure 30: Pay $400 with a bank loan
```{r Loan400}
# Loan400: #  Using money from a bank loan or line of credit ‐ Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense?

# table(shed$Loan400)
shed.Loan400 <- shed %>% filter((Loan400 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblLoan400 <- aggregate(data=shed.Loan400, Weight ~ Loan400 + Race + State + AnyStudentLoans, FUN=sum)
tblLoan4002 <- aggregate(data=shed.Loan400, Weight ~ Loan400 + State + AnyStudentLoans, FUN=sum)
tblLoan4002$Race <- rep("All", nrow(tblLoan4002))
tblLoan400 <- rbind(tblLoan400, tblLoan4002)
tblLoan400 <- reshape2::dcast(data=tblLoan400, Race + State + AnyStudentLoans ~ Loan400, value.var="Weight")
tblLoan400$`Share` <- tblLoan400$Yes / (tblLoan400$Yes + tblLoan400$No)

tblLoan400$Group <- rep(NA, nrow(tblLoan400))
tblLoan400$Group[tblLoan400$State=="CA" & tblLoan400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblLoan400$Group[tblLoan400$State=="Rest of U.S." & tblLoan400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblLoan400$Group[tblLoan400$State=="CA" & tblLoan400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblLoan400 <- tblLoan400 %>% filter(is.na(Group)==FALSE)
tblLoan400$Group <- factor(tblLoan400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [Using money from a bank loan or line of credit]"
```{r figure30D}
tblLoan400$`For Tooltip` <- paste(
  "State: ", tblLoan400$State, '\n',
  "Student loan borrowers: ", tblLoan400$AnyStudentLoans, '\n',
  "Group: ", tblLoan400$Race, '\n',
  "Share: ", percent(tblLoan400$`Share`, accuracy=0.1),
  sep=""
)

g30D <- ggplot(data=tblLoan400, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would pay with a bank loan", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g30D, width=800, height=350, tooltip="text")
```
#### Figure 30: Pay $400 by borrowing from a friend
```{r Friend400}
# Friend400: # By borrowing from a friend or family member ‐ Suppose that you have an emergency that costs $400. Based on your current financial situation, how would you pay for this expense?

# table(shed$Friend400)
shed.Friend400 <- shed %>% filter((Friend400 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblFriend400 <- aggregate(data=shed.Friend400, Weight ~ Friend400 + Race + State + AnyStudentLoans, FUN=sum)
tblFriend4002 <- aggregate(data=shed.Friend400, Weight ~ Friend400 + State + AnyStudentLoans, FUN=sum)
tblFriend4002$Race <- rep("All", nrow(tblFriend4002))
tblFriend400 <- rbind(tblFriend400, tblFriend4002)
tblFriend400 <- reshape2::dcast(data=tblFriend400, Race + State + AnyStudentLoans ~ Friend400, value.var="Weight")
tblFriend400$`Share` <- tblFriend400$Yes / (tblFriend400$Yes + tblFriend400$No)

tblFriend400$Group <- rep(NA, nrow(tblFriend400))
tblFriend400$Group[tblFriend400$State=="CA" & tblFriend400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblFriend400$Group[tblFriend400$State=="Rest of U.S." & tblFriend400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblFriend400$Group[tblFriend400$State=="CA" & tblFriend400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblFriend400 <- tblFriend400 %>% filter(is.na(Group)==FALSE)
tblFriend400$Group <- factor(tblFriend400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [By borrowing from a friend or family member]"
```{r figure30E}
tblFriend400$`For Tooltip` <- paste(
  "State: ", tblFriend400$State, '\n',
  "Student loan borrowers: ", tblFriend400$AnyStudentLoans, '\n',
  "Group: ", tblFriend400$Race, '\n',
  "Share: ", percent(tblFriend400$`Share`, accuracy=0.1),
  sep=""
)

g30E <- ggplot(data=tblFriend400, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would borrow from family or a friend", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g30E, width=800, height=350, tooltip="text")
```
#### Figure 30: Pay $400 with a payday loan
```{r Payday400}
# Payday400: # Using a payday loan, deposit advance, or overdraft ‐ Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense?

# table(shed$Payday400)
shed.Payday400 <- shed %>% filter((Payday400 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblPayday400 <- aggregate(data=shed.Payday400, Weight ~ Payday400 + Race + State + AnyStudentLoans, FUN=sum)
tblPayday4002 <- aggregate(data=shed.Payday400, Weight ~ Payday400 + State + AnyStudentLoans, FUN=sum)
tblPayday4002$Race <- rep("All", nrow(tblPayday4002))
tblPayday400 <- rbind(tblPayday400, tblPayday4002)
tblPayday400 <- reshape2::dcast(data=tblPayday400, Race + State + AnyStudentLoans ~ Payday400, value.var="Weight")
tblPayday400$`Share` <- tblPayday400$Yes / (tblPayday400$Yes + tblPayday400$No)

tblPayday400$Group <- rep(NA, nrow(tblPayday400))
tblPayday400$Group[tblPayday400$State=="CA" & tblPayday400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblPayday400$Group[tblPayday400$State=="Rest of U.S." & tblPayday400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblPayday400$Group[tblPayday400$State=="CA" & tblPayday400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblPayday400 <- tblPayday400 %>% filter(is.na(Group)==FALSE)
tblPayday400$Group <- factor(tblPayday400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [Using a payday loan, deposit advance, or overdraft]"
```{r figure30F}
tblPayday400$`For Tooltip` <- paste(
  "State: ", tblPayday400$State, '\n',
  "Student loan borrowers: ", tblPayday400$AnyStudentLoans, '\n',
  "Group: ", tblPayday400$Race, '\n',
  "Share: ", percent(tblPayday400$`Share`, accuracy=0.1),
  sep=""
)

g30F <- ggplot(data=tblPayday400, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would use a payday loan, deposit advance, or overdraft", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g30F, width=800, height=350, tooltip="text")
```
#### Figure 30: Pay $400 by selling something
```{r Sell400}
# Sell400: # By selling something ‐ Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? 

# table(shed$Sell400)
shed.Sell400 <- shed %>% filter((Sell400 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblSell400 <- aggregate(data=shed.Sell400, Weight ~ Sell400 + Race + State + AnyStudentLoans, FUN=sum)
tblSell4002 <- aggregate(data=shed.Sell400, Weight ~ Sell400 + State + AnyStudentLoans, FUN=sum)
tblSell4002$Race <- rep("All", nrow(tblSell4002))
tblSell400 <- rbind(tblSell400, tblSell4002)
tblSell400 <- reshape2::dcast(data=tblSell400, Race + State + AnyStudentLoans ~ Sell400, value.var="Weight")
tblSell400$`Share` <- tblSell400$Yes / (tblSell400$Yes + tblSell400$No)

tblSell400$Group <- rep(NA, nrow(tblSell400))
tblSell400$Group[tblSell400$State=="CA" & tblSell400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblSell400$Group[tblSell400$State=="Rest of U.S." & tblSell400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblSell400$Group[tblSell400$State=="CA" & tblSell400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblSell400 <- tblSell400 %>% filter(is.na(Group)==FALSE)
tblSell400$Group <- factor(tblSell400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [By selling something]"
```{r figure30G}
tblSell400$`For Tooltip` <- paste(
  "State: ", tblSell400$State, '\n',
  "Student loan borrowers: ", tblSell400$AnyStudentLoans, '\n',
  "Group: ", tblSell400$Race, '\n',
  "Share: ", percent(tblSell400$`Share`, accuracy=0.1),
  sep=""
)

g30G <- ggplot(data=tblSell400, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would pay by selling something", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g30G, width=800, height=350, tooltip="text")
```
#### Figure 30: Unable to pay $400
```{r None400}
# None400: # I wouldn't be able to pay for the expense right now ‐ Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense?

# table(shed$None400)
shed.None400 <- shed %>% filter((None400 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblNone400 <- aggregate(data=shed.None400, Weight ~ None400 + Race + State + AnyStudentLoans, FUN=sum)
tblNone4002 <- aggregate(data=shed.None400, Weight ~ None400 + State + AnyStudentLoans, FUN=sum)
tblNone4002$Race <- rep("All", nrow(tblNone4002))
tblNone400 <- rbind(tblNone400, tblNone4002)
tblNone400 <- reshape2::dcast(data=tblNone400, Race + State + AnyStudentLoans ~ None400, value.var="Weight")
tblNone400$`Share` <- tblNone400$Yes / (tblNone400$Yes + tblNone400$No)

tblNone400$Group <- rep(NA, nrow(tblNone400))
tblNone400$Group[tblNone400$State=="CA" & tblNone400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblNone400$Group[tblNone400$State=="Rest of U.S." & tblNone400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblNone400$Group[tblNone400$State=="CA" & tblNone400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblNone400 <- tblNone400 %>% filter(is.na(Group)==FALSE)
tblNone400$Group <- factor(tblNone400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [I wouldn't be able to pay for the expense right now]"
```{r figure30H}
tblNone400$`For Tooltip` <- paste(
  "State: ", tblNone400$State, '\n',
  "Student loan borrowers: ", tblNone400$AnyStudentLoans, '\n',
  "Group: ", tblNone400$Race, '\n',
  "Share: ", percent(tblNone400$`Share`, accuracy=0.1),
  sep=""
)

g30H <- ggplot(data=tblNone400, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who could not cover the expense", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g30H, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 30 are
```{r CCA400.SY, results = 'asis'}
survey_years(shed.CCA400$SurveyYear)
# Running survey_years for just one of these variables is sufficient. I have checked and verified that the survey years are the same for all of these variables.
```

**Notes:** Responses are not exclusive to one another. For an example, a respondent could say that they would sell belongings and use a payday loan. Because of this, groups' bars cannot be stacked on top of each other in one chart and are instead presented here in a series of charts. See the table below for the survey respondent sample size by subgroup.
```{r CCA400.N}
N.CCA400 <- aggregate(data=shed.CCA400, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.CCA400 <- N.CCA400 %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.CCA400) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.CCA400, caption="N size by group for Figure 30") %>% kable_paper("hover", full_width = F)
# I have checked and verified that these variables all have Ns that are all roughly equal. 
```

***

### {-}

Figures 31 and 32 consider how respondents think about their own education. Figure 31 shows respondents' opinions about whether they think the financial benefits or costs of their most recent educational program are larger. 

The most common response is that the costs and benefits are the same. Overall, non-borrowers in California are less likely to say that they find the costs greater than the benefits (21.7 percent) compared to California student loan borrowers (38.0 percent). 

Among California borrowers, Black respondents appear more likely than other groups to say that the costs are "much larger." However, the sample sizes for California student loan borrowers in the "Black, Non-Hispanic" and "Other, Non-Hispanic" categories are very small, meaning those rows of results should be interpreted with caution. 

### {.tabset}
```{r EdPayoff1}
# EdPayoff1: # Overall, how would you say the lifetime financial benefits of your [current/most recent] educational program compare to its financial costs? 

# table(shed$EdPayoff1)
shed.EdPayoff1 <- shed %>% filter(is.na(EdPayoff1)==FALSE) %>% filter((EdPayoff1 %in% c("Refused", "", "Don't know", "Not In Universe (not asked)")==FALSE)) 
tblEdPayoff1 <- aggregate(data=shed.EdPayoff1, Weight ~ EdPayoff1 + Race + State + AnyStudentLoans, FUN=sum)
tblEdPayoff12 <- aggregate(data=shed.EdPayoff1, Weight ~ EdPayoff1 + State + AnyStudentLoans, FUN=sum)
tblEdPayoff12$Race <- rep("All", nrow(tblEdPayoff12))
tblEdPayoff1 <- rbind(tblEdPayoff1, tblEdPayoff12)
tblEdPayoff1 <- reshape2::dcast(data=tblEdPayoff1, Race + State + AnyStudentLoans ~ EdPayoff1, value.var="Weight")
tblEdPayoff1$`Total weight` <- tblEdPayoff1$`Financial benefits are much larger` + tblEdPayoff1$`Financial costs are somewhat larger` + tblEdPayoff1$`About the same` + tblEdPayoff1$`Financial benefits are somewhat larger` + tblEdPayoff1$`Financial costs are much larger`
tblEdPayoff1$`Financial benefits are much larger` <- tblEdPayoff1$`Financial benefits are much larger` / tblEdPayoff1$`Total weight`
tblEdPayoff1$`Financial benefits are somewhat larger` <- tblEdPayoff1$`Financial benefits are somewhat larger` / tblEdPayoff1$`Total weight`
tblEdPayoff1$`About the same` <- tblEdPayoff1$`About the same` / tblEdPayoff1$`Total weight`
tblEdPayoff1$`Financial costs are somewhat larger` <- tblEdPayoff1$`Financial costs are somewhat larger` / tblEdPayoff1$`Total weight`
tblEdPayoff1$`Financial costs are much larger` <- tblEdPayoff1$`Financial costs are much larger` / tblEdPayoff1$`Total weight`
tblEdPayoff1 <- reshape2::melt(data=tblEdPayoff1, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblEdPayoff1$variable <- factor(tblEdPayoff1$variable, levels = c("Financial costs are much larger", "Financial costs are somewhat larger", "About the same", "Financial benefits are somewhat larger", "Financial benefits are much larger"))
```
#### Figure 31: CA borrowers
##### Responses to "Overall, how would you say the lifetime financial benefits of your [current/most recent] educational program compare to its financial costs?"
```{r figure31A}
tblEdPayoff1.CA.Borrow <- tblEdPayoff1 %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblEdPayoff1.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblEdPayoff1.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblEdPayoff1.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblEdPayoff1.CA.Borrow$Race, '\n',
  "Opinion: ", tblEdPayoff1.CA.Borrow$variable, '\n',
  "Share: ", percent(tblEdPayoff1.CA.Borrow$`Share`, accuracy=0.1), 
  sep=""
)

g31A <- ggplot(data=tblEdPayoff1.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g31A, width=800, height=350, tooltip="text")
```
#### Figure 31: Rest of U.S. borrowers
##### Responses to "Overall, how would you say the lifetime financial benefits of your [current/most recent] educational program compare to its financial costs?"
```{r figure31B}
tblEdPayoff1.US.Borrow <- tblEdPayoff1 %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblEdPayoff1.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblEdPayoff1.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblEdPayoff1.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblEdPayoff1.US.Borrow$Race, '\n',
  "Opinion: ", tblEdPayoff1.US.Borrow$variable, '\n',
  "Share: ", percent(tblEdPayoff1.US.Borrow$`Share`, accuracy=0.1), 
  sep=""
)

g31B <- ggplot(data=tblEdPayoff1.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g31B, width=800, height=350, tooltip="text")
```
#### Figure 31: CA non-borrowers
##### Responses to "Overall, how would you say the lifetime financial benefits of your [current/most recent] educational program compare to its financial costs?"
```{r figure31C}
tblEdPayoff1.CA.Nonborrow <- tblEdPayoff1 %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblEdPayoff1.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblEdPayoff1.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblEdPayoff1.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblEdPayoff1.CA.Nonborrow$Race, '\n',
  "Opinion: ", tblEdPayoff1.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblEdPayoff1.CA.Nonborrow$`Share`, accuracy=0.1), 
  sep=""
)

g31C <- ggplot(data=tblEdPayoff1.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g31C, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 31 are
```{r EdPayoff1.SY, results = 'asis'}
survey_years(shed.EdPayoff1$SurveyYear)
```

**Notes:** See the table below for the survey respondent sample size by subgroup.
```{r EdPayoff1.N}
N.EdPayoff1 <- aggregate(data=shed.EdPayoff1, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.EdPayoff1 <- N.EdPayoff1 %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.EdPayoff1) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.EdPayoff1, caption="N size by group for Figure 31") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Figure 32 examines what respondents say they would do differently if they could go back and make their educational decisions again. Around half of California student loan borrowers say they would choose a different field, and the same share say they would choose a different school. Student loan borrowers outside California responded similarly. 

Only 1 in 8 California student loan borrowers said they would have completed less education if they could do it over again, and almost 3 in 4 said that they would complete more education. 

As with Figure 31, the sample sizes for California student loan borrowers in the "Black, Non-Hispanic" and "Other, Non-Hispanic" categories are very small, meaning those rows of results should be interpreted with caution. 

### {.tabset}
#### Figure 32: Different field
```{r DiffField}
# DiffField1: # Chosen a different field of study - If you could go back and make your education decisions again, would you have done any of these things: 

# table(shed$DiffField1)
shed.DiffField1 <- shed %>% filter((DiffField1 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblDiffField1 <- aggregate(data=shed.DiffField1, Weight ~ DiffField1 + Race + State + AnyStudentLoans, FUN=sum)
tblDiffField12 <- aggregate(data=shed.DiffField1, Weight ~ DiffField1 + State + AnyStudentLoans, FUN=sum)
tblDiffField12$Race <- rep("All", nrow(tblDiffField12))
tblDiffField1 <- rbind(tblDiffField1, tblDiffField12)
tblDiffField1 <- reshape2::dcast(data=tblDiffField1, Race + State + AnyStudentLoans ~ DiffField1, value.var="Weight")
tblDiffField1$`Share` <- tblDiffField1$Yes / (tblDiffField1$Yes + tblDiffField1$No)

tblDiffField1$Group <- rep(NA, nrow(tblDiffField1))
tblDiffField1$Group[tblDiffField1$State=="CA" & tblDiffField1$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblDiffField1$Group[tblDiffField1$State=="Rest of U.S." & tblDiffField1$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblDiffField1$Group[tblDiffField1$State=="CA" & tblDiffField1$AnyStudentLoans=="No"] <- "California non-borrowers"
tblDiffField1 <- tblDiffField1 %>% filter(is.na(Group)==FALSE)
tblDiffField1$Group <- factor(tblDiffField1$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "If you could go back and make your education decisions again, would you have chosen a different field of study?"
```{r figure32A}
tblDiffField1$`For Tooltip` <- paste(
  "State: ", tblDiffField1$State, '\n',
  "Student loan borrowers: ", tblDiffField1$AnyStudentLoans, '\n',
  "Group: ", tblDiffField1$Race, '\n',
  "Share: ", percent(tblDiffField1$Share, accuracy=0.1),
  sep=""
)

g32A <- ggplot(data=tblDiffField1, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would have chosen a different field of study", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g32A, width=800, height=350, tooltip="text")
```
#### Figure 32: Different school
```{r DiffSchool}
# DiffSchool1: # Attended a different school - If you could go back and make your education decisions again, would you have done any of these things: 

# table(shed$DiffSchool1)
shed.DiffSchool1 <- shed %>% filter((DiffSchool1 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblDiffSchool1 <- aggregate(data=shed.DiffSchool1, Weight ~ DiffSchool1 + Race + State + AnyStudentLoans, FUN=sum)
tblDiffSchool12 <- aggregate(data=shed.DiffSchool1, Weight ~ DiffSchool1 + State + AnyStudentLoans, FUN=sum)
tblDiffSchool12$Race <- rep("All", nrow(tblDiffSchool12))
tblDiffSchool1 <- rbind(tblDiffSchool1, tblDiffSchool12)
tblDiffSchool1 <- reshape2::dcast(data=tblDiffSchool1, Race + State + AnyStudentLoans ~ DiffSchool1, value.var="Weight")
tblDiffSchool1$`Share` <- tblDiffSchool1$Yes / (tblDiffSchool1$Yes + tblDiffSchool1$No)

tblDiffSchool1$Group <- rep(NA, nrow(tblDiffSchool1))
tblDiffSchool1$Group[tblDiffSchool1$State=="CA" & tblDiffSchool1$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblDiffSchool1$Group[tblDiffSchool1$State=="Rest of U.S." & tblDiffSchool1$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblDiffSchool1$Group[tblDiffSchool1$State=="CA" & tblDiffSchool1$AnyStudentLoans=="No"] <- "California non-borrowers"
tblDiffSchool1 <- tblDiffSchool1 %>% filter(is.na(Group)==FALSE)
tblDiffSchool1$Group <- factor(tblDiffSchool1$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "If you could go back and make your education decisions again, would you have attended a different school?"
```{r figure32B}
tblDiffSchool1$`For Tooltip` <- paste(
  "State: ", tblDiffSchool1$State, '\n',
  "Student loan borrowers: ", tblDiffSchool1$AnyStudentLoans, '\n',
  "Group: ", tblDiffSchool1$Race, '\n',
  "Share: ", percent(tblDiffSchool1$Share, accuracy=0.1),
  sep=""
)

g32B <- ggplot(data=tblDiffSchool1, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would have chosen a different school", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g32B, width=800, height=350, tooltip="text")
```
#### Figure 32: Less education
```{r LessEd}
# LessEd1: # Not attended college or completed less education - If you could go back and make your education decisions again, would have done any of these things: 

# table(shed$LessEd1)
shed.LessEd1 <- shed %>% filter((LessEd1 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblLessEd1 <- aggregate(data=shed.LessEd1, Weight ~ LessEd1 + Race + State + AnyStudentLoans, FUN=sum)
tblLessEd12 <- aggregate(data=shed.LessEd1, Weight ~ LessEd1 + State + AnyStudentLoans, FUN=sum)
tblLessEd12$Race <- rep("All", nrow(tblLessEd12))
tblLessEd1 <- rbind(tblLessEd1, tblLessEd12)
tblLessEd1 <- reshape2::dcast(data=tblLessEd1, Race + State + AnyStudentLoans ~ LessEd1, value.var="Weight")
tblLessEd1$`Share` <- tblLessEd1$Yes / (tblLessEd1$Yes + tblLessEd1$No)

tblLessEd1$Group <- rep(NA, nrow(tblLessEd1))
tblLessEd1$Group[tblLessEd1$State=="CA" & tblLessEd1$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblLessEd1$Group[tblLessEd1$State=="Rest of U.S." & tblLessEd1$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblLessEd1$Group[tblLessEd1$State=="CA" & tblLessEd1$AnyStudentLoans=="No"] <- "California non-borrowers"
tblLessEd1 <- tblLessEd1 %>% filter(is.na(Group)==FALSE)
tblLessEd1$Group <- factor(tblLessEd1$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "If you could go back and make your education decisions again, would have not attended college or completed less education?" 
```{r figure32C}
tblLessEd1$`For Tooltip` <- paste(
  "State: ", tblLessEd1$State, '\n',
  "Student loan borrowers: ", tblLessEd1$AnyStudentLoans, '\n',
  "Group: ", tblLessEd1$Race, '\n',
  "Share: ", percent(tblLessEd1$Share, accuracy=0.1),
  sep=""
)

g32C <- ggplot(data=tblLessEd1, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would have completed less education", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g32C, width=800, height=350, tooltip="text")
```
#### Figure 32: More education
```{r MoreEd}
# MoreEd1: # Completed more education - If you could go back and make your education decisions again, would you have done any of these things:

# table(shed$MoreEd1)
shed.MoreEd1 <- shed %>% filter((MoreEd1 %in% c("Refused", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblMoreEd1 <- aggregate(data=shed.MoreEd1, Weight ~ MoreEd1 + Race + State + AnyStudentLoans, FUN=sum)
tblMoreEd12 <- aggregate(data=shed.MoreEd1, Weight ~ MoreEd1 + State + AnyStudentLoans, FUN=sum)
tblMoreEd12$Race <- rep("All", nrow(tblMoreEd12))
tblMoreEd1 <- rbind(tblMoreEd1, tblMoreEd12)
tblMoreEd1 <- reshape2::dcast(data=tblMoreEd1, Race + State + AnyStudentLoans ~ MoreEd1, value.var="Weight")
tblMoreEd1$`Share` <- tblMoreEd1$Yes / (tblMoreEd1$Yes + tblMoreEd1$No)

tblMoreEd1$Group <- rep(NA, nrow(tblMoreEd1))
tblMoreEd1$Group[tblMoreEd1$State=="CA" & tblMoreEd1$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblMoreEd1$Group[tblMoreEd1$State=="Rest of U.S." & tblMoreEd1$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblMoreEd1$Group[tblMoreEd1$State=="CA" & tblMoreEd1$AnyStudentLoans=="No"] <- "California non-borrowers"
tblMoreEd1 <- tblMoreEd1 %>% filter(is.na(Group)==FALSE)
tblMoreEd1$Group <- factor(tblMoreEd1$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "If you could go back and make your education decisions again, would you have completed more education?"
```{r figure32D}
tblMoreEd1$`For Tooltip` <- paste(
  "State: ", tblMoreEd1$State, '\n',
  "Student loan borrowers: ", tblMoreEd1$AnyStudentLoans, '\n',
  "Group: ", tblMoreEd1$Race, '\n',
  "Share: ", percent(tblMoreEd1$Share, accuracy=0.1),
  sep=""
)

g32D <- ggplot(data=tblMoreEd1, mapping=aes(y=Race, x=`Share`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would have completed more education", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g32D, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 32 are
```{r DiffField1.SY, results = 'asis'}
survey_years(shed.DiffField1$SurveyYear)
# I have checked and verified that the survey years for all versions of Figure 32 match.
```

**Notes:** Interpret the "California student loan borrowers" results with caution due to small sample size. See the tables below for the survey respondent sample size by subgroup.
```{r DiffField.N}
N.DiffField <- aggregate(data=shed.DiffField1, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.DiffField <- N.DiffField %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.DiffField) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.DiffField, caption="N size by group for Figure 32: Different field") %>% kable_paper("hover", full_width = F)
```

```{r DiffSchool.N}
N.DiffSchool <- aggregate(data=shed.DiffSchool1, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.DiffSchool <- N.DiffSchool %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.DiffSchool) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.DiffSchool, caption="N size by group for Figure 32: Different school") %>% kable_paper("hover", full_width = F)
```

```{r LessEd.N}
N.LessEd <- aggregate(data=shed.LessEd1, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.LessEd <- N.LessEd %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.LessEd) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.LessEd, caption="N size by group for Figure 32: Less education") %>% kable_paper("hover", full_width = F)
```

```{r MoreEd.N}
N.MoreEd <- aggregate(data=shed.MoreEd1, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.MoreEd <- N.MoreEd %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.MoreEd) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.MoreEd, caption="N size by group for Figure 32: More education") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Figures 33, 34, and 35 provide some breakdowns of respondents using basic information that is relevant for the discussion of student loans. Figure 33 shows the breakdown by gender. The gender variable uses here only provides two values, male and female. 

A slight majority of student loan borrowers are female, closer to two-thirds among Black student loan borrowers. 

### {.tabset}
#### Figure 33: Gender
```{r Gender}
# Gender: # Gender 

# table(shed$Gender)
shed.Gender <- shed %>% filter((Gender %in% c("Refused", "Don't know", "Not In Universe (not asked)", "", NA)==FALSE)) 
tblGender <- aggregate(data=shed.Gender, Weight ~ Gender + Race + State + AnyStudentLoans, FUN=sum)
tblGender2 <- aggregate(data=shed.Gender, Weight ~ Gender + State + AnyStudentLoans, FUN=sum)
tblGender2$Race <- rep("All", nrow(tblGender2))
tblGender <- rbind(tblGender, tblGender2)
tblGender <- reshape2::dcast(data=tblGender, Race + State + AnyStudentLoans ~ Gender, value.var="Weight")
tblGender$`Share of borrowers who are male` <- tblGender$Male / (tblGender$Male + tblGender$Female)

tblGender$Group <- rep(NA, nrow(tblGender))
tblGender$Group[tblGender$State=="CA" & tblGender$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblGender$Group[tblGender$State=="Rest of U.S." & tblGender$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblGender$Group[tblGender$State=="CA" & tblGender$AnyStudentLoans=="No"] <- "California non-borrowers"
tblGender <- tblGender %>% filter(is.na(Group)==FALSE)
tblGender$Group <- factor(tblGender$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Share who are male: 
```{r figure33}
tblGender$`For Tooltip` <- paste(
  "State: ", tblGender$State, '\n',
  "Student loan borrowers: ", tblGender$AnyStudentLoans, '\n',
  "Group: ", tblGender$Race, '\n',
  "Share who are male: ", percent(tblGender$`Share of borrowers who are male`, accuracy=0.1),
  sep=""
)

g33 <- ggplot(data=tblGender, mapping=aes(y=Race, x=`Share of borrowers who are male`, fill=Group, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who are male", fill="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g33, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 33 are
```{r Gender.SY, results = 'asis'}
survey_years(shed.Gender$SurveyYear)
```

**Notes:** The gender variable, as collected and reported by SHED, only has "male" and "female" values. See the tables below for the survey respondent sample size by subgroup. 
```{r Gender.N}
N.Gender <- aggregate(data=shed.Gender, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.Gender <- N.Gender %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.Gender) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.Gender, caption="N size by group for Figure 33") %>% kable_paper("hover", full_width = F)
```

***

### {-}

In Figure 34, we see a breakdown by the level of higher education institution that the respondents attended. Around three-quarters of all student loan borrowers attended four-year institutions, compared to about 5 in 8 non-borrowers in California. Among California borrowers, white respondents (82.6 percent) were more likely to have attended a four-year college than Black (70.4 percent) or Hispanic (66.6 percent) respondents. 

Those who did not attend any college are not included in this figure.

### {.tabset}
```{r InstLevel}
# InstLevel: # Level of institution

# table(shed$InstLevel)
shed.InstLevel <- shed %>% filter(is.na(InstLevel)==FALSE) %>% filter((InstLevel %in% c("Refused", "", "Don't know")==FALSE)) 
tblInstLevel <- aggregate(data=shed.InstLevel, Weight ~ InstLevel + Race + State + AnyStudentLoans, FUN=sum)
tblInstLevel2 <- aggregate(data=shed.InstLevel, Weight ~ InstLevel + State + AnyStudentLoans, FUN=sum)
tblInstLevel2$Race <- rep("All", nrow(tblInstLevel2))
tblInstLevel <- rbind(tblInstLevel, tblInstLevel2)
tblInstLevel <- reshape2::dcast(data=tblInstLevel, Race + State + AnyStudentLoans ~ InstLevel, value.var="Weight")
tblInstLevel$`Total weight` <- tblInstLevel$`Four-year` + tblInstLevel$`Less than two-year` + tblInstLevel$`Two-year` 
tblInstLevel$`Four-year` <- tblInstLevel$`Four-year` / tblInstLevel$`Total weight`
tblInstLevel$`Two-year` <- tblInstLevel$`Two-year` / tblInstLevel$`Total weight`
tblInstLevel$`Less than two-year` <- tblInstLevel$`Less than two-year` / tblInstLevel$`Total weight`
tblInstLevel <- reshape2::melt(data=tblInstLevel, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblInstLevel$variable <- factor(tblInstLevel$variable, levels = c("Less than two-year", "Two-year", "Four-year"))
```
#### Figure 34: CA borrowers
##### Level of higher education institution
```{r figure34A}
tblInstLevel.CA.Borrow <- tblInstLevel %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblInstLevel.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblInstLevel.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblInstLevel.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblInstLevel.CA.Borrow$Race, '\n',
  "Level of higher education institution: ", tblInstLevel.CA.Borrow$variable, '\n',
  "Share: ", percent(tblInstLevel.CA.Borrow$Share, accuracy=0.1), 
  sep=""
)

g34A <- ggplot(data=tblInstLevel.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g34A, width=800, height=350, tooltip="text")
```
#### Figure 34: Rest of U.S. borrowers
##### Level of higher education institution
```{r figure34B}
tblInstLevel.US.Borrow <- tblInstLevel %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblInstLevel.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblInstLevel.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblInstLevel.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblInstLevel.US.Borrow$Race, '\n',
  "Level of higher education institution: ", tblInstLevel.US.Borrow$variable, '\n',
  "Share: ", percent(tblInstLevel.US.Borrow$Share, accuracy=0.1), 
  sep=""
)

g34B <- ggplot(data=tblInstLevel.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g34B, width=800, height=350, tooltip="text")
```
#### Figure 34: CA non-borrowers
##### Level of higher education institution
```{r figure34C}
tblInstLevel.CA.Nonborrow <- tblInstLevel %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblInstLevel.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblInstLevel.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblInstLevel.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblInstLevel.CA.Nonborrow$Race, '\n',
  "Level of higher education institution: ", tblInstLevel.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblInstLevel.CA.Nonborrow$Share, accuracy=0.1), 
  sep=""
)

g34C <- ggplot(data=tblInstLevel.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g34C, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 34 are
```{r InstLevel.SY, results = 'asis'}
survey_years(shed.InstLevel$SurveyYear)
```

**Notes:** This analysis only includes those who have college experience. See the tables below for the survey respondent sample size by subgroup. 
```{r InstLevel.N}
N.InstLevel <- aggregate(data=shed.InstLevel, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.InstLevel <- N.InstLevel %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.InstLevel) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.InstLevel, caption="N size by group for Figure 34") %>% kable_paper("hover", full_width = F)
```

***

### {-}

Figure 35 shows the distribution of respondents by institutional control. Student loan borrowers in California and the rest of the U.S. are more likely to have attended a private institution than non-borrowers. 

For-profit colleges are particularly represented among student loan borrowers, especially for borrowers of color. Black (21.7 percent) and Hispanic (25.1 percent) California student loan borrowers attended for-profit colleges more frequently than white California student loan borrowers (11.4 percent). By comparison, just 6 percent of non-borrowers in California attended a for-profit college. 

Those who did not attend any college are not included in this figure.
 
### {.tabset}
```{r InstControl}
# InstControl: # Control of institution

# table(shed$InstControl)
shed.InstControl <- shed %>% filter(is.na(InstControl)==FALSE) %>% filter((InstControl %in% c("Refused", "", "Don't know")==FALSE)) 
tblInstControl <- aggregate(data=shed.InstControl, Weight ~ InstControl + Race + State + AnyStudentLoans, FUN=sum)
tblInstControl2 <- aggregate(data=shed.InstControl, Weight ~ InstControl + State + AnyStudentLoans, FUN=sum)
tblInstControl2$Race <- rep("All", nrow(tblInstControl2))
tblInstControl <- rbind(tblInstControl, tblInstControl2)
tblInstControl <- reshape2::dcast(data=tblInstControl, Race + State + AnyStudentLoans ~ InstControl, value.var="Weight")
tblInstControl$`Total weight` <- tblInstControl$`Public` + tblInstControl$`Private for-profit` + tblInstControl$`Private not-for-profit` 
tblInstControl$`Public` <- tblInstControl$`Public` / tblInstControl$`Total weight`
tblInstControl$`Private not-for-profit` <- tblInstControl$`Private not-for-profit` / tblInstControl$`Total weight`
tblInstControl$`Private for-profit` <- tblInstControl$`Private for-profit` / tblInstControl$`Total weight`
tblInstControl <- reshape2::melt(data=tblInstControl, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblInstControl$variable <- factor(tblInstControl$variable, levels = c("Private for-profit", "Private not-for-profit", "Public"))
```
#### Figure 35: CA borrowers
##### Control of higher education institution
```{r figure35A}
tblInstControl.CA.Borrow <- tblInstControl %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")

tblInstControl.CA.Borrow$`For Tooltip` <- paste(
  "State: ", tblInstControl.CA.Borrow$State, '\n',
  "Student loan borrowers: ", tblInstControl.CA.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblInstControl.CA.Borrow$Race, '\n',
  "Control of higher education institution: ", tblInstControl.CA.Borrow$variable, '\n',
  "Share: ", percent(tblInstControl.CA.Borrow$Share, accuracy=0.1), 
  sep=""
)

g35A <- ggplot(data=tblInstControl.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g35A, width=800, height=350, tooltip="text")
```
#### Figure 35: Rest of U.S. borrowers
##### Control of higher education institution
```{r figure35B}
tblInstControl.US.Borrow <- tblInstControl %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")

tblInstControl.US.Borrow$`For Tooltip` <- paste(
  "State: ", tblInstControl.US.Borrow$State, '\n',
  "Student loan borrowers: ", tblInstControl.US.Borrow$AnyStudentLoans, '\n',
  "Group: ", tblInstControl.US.Borrow$Race, '\n',
  "Control of higher education institution: ", tblInstControl.US.Borrow$variable, '\n',
  "Share: ", percent(tblInstControl.US.Borrow$Share, accuracy=0.1), 
  sep=""
)

g35B <- ggplot(data=tblInstControl.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g35B, width=800, height=350, tooltip="text")
```
#### Figure 35: CA non-borrowers
##### Control of higher education institution
```{r figure35C}
tblInstControl.CA.Nonborrow <- tblInstControl %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")

tblInstControl.CA.Nonborrow$`For Tooltip` <- paste(
  "State: ", tblInstControl.CA.Nonborrow$State, '\n',
  "Student loan borrowers: ", tblInstControl.CA.Nonborrow$AnyStudentLoans, '\n',
  "Group: ", tblInstControl.CA.Nonborrow$Race, '\n',
  "Control of higher education institution: ", tblInstControl.CA.Nonborrow$variable, '\n',
  "Share: ", percent(tblInstControl.CA.Nonborrow$Share, accuracy=0.1), 
  sep=""
)

g35C <- ggplot(data=tblInstControl.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable, text=`For Tooltip`)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_manual(values = stateCols)

ggplotly(g35C, width=800, height=350, tooltip="text")
```
#### Data Source and Notes

**Data source:** Survey of Household Economics and Decision-making, accessed November 2022, available through the U.S. Federal Reserve [here](https://www.federalreserve.gov/consumerscommunities/shed_data.htm).

**Timeframe reflected:** The survey years included for Figure 35 are
```{r InstControl.SY, results = 'asis'}
survey_years(shed.InstControl$SurveyYear)
```

**Notes:** This analysis only includes those who have college experience. See the tables below for the survey respondent sample size by subgroup. 
```{r InstControl.N}
N.InstControl <- aggregate(data=shed.InstControl, Count ~ Race + State + AnyStudentLoans, FUN=sum)
N.InstControl <- N.InstControl %>% filter(State=="CA" | AnyStudentLoans=="Yes")
names(N.InstControl) <- c("Group", "State", "Student loan borrower", "Survey respondents")
kable(N.InstControl, caption="N size by group for Figure 34") %>% kable_paper("hover", full_width = F)
```

***

### {-}

## College Scorecard

#### About the data

We now turn away from survey data and back towards administrative data, this time from the College Scorecard. The College Scorecard is a dataset published and regularly updated by the U.S. Department of Education that combines information on debt and borrowers from the National Student Loan Data System, data on earnings from the U.S. Treasury, institutions' self-reported data from the Integrated Postsecondary Education Data System (IEPDS), and more. 

Scorecard is used as a [consumer-facing tool](https://collegescorecard.ed.gov/) to help families make informed decisions about college, highlighting the post-graduation outcomes of students who attend. The public-facing website contains just a subset of the wealth of variables in its [downloadable data files](https://collegescorecard.ed.gov/data). Scorecard is divided into two datasets, one at the institution level and another at the program level.

For our analysis of student loan debt in California here, I focus on certain variables from Scorecard that tell us about how debt is borrowed and repaid. 

A key limitation of Scorecard for our purposes here is that it does not have many breakdowns by students' race, which is a downstream consequence of the FAFSA's lack of a question about racial identity. Legislative changes to the FAFSA are slated to add that question, but as for now, the best way to consider the racial impacts of institutions' metrics of debt and earnings is to link in IPEDS data on enrollment and completions by race. I will explain below how and when I do this. 

The Department of Education reports debt repayment data in such a way that the federal student loan payment pause and forbearance period do not distort the results. Although data on total outstanding loan balances are current, default rates and repayment variables reflect pre-pandemic borrower outcomes. The Biden Administration's announcement of student loan debt cancellation similarly has no bearing on the data. 

#### Findings

```{r conversionsDF}
conversionsDF <- data.frame("Character.Entry" = c("PrivacySuppressed", "NULL"), "Numeric.Entry"=c(NA, NA))
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "<=0.01", Numeric.Entry = 0)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "<=0.02", Numeric.Entry = 0.01)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "<=0.05", Numeric.Entry = 0.025)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "<=0.10", Numeric.Entry = 0.05) 
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "<=0.20", Numeric.Entry = 0.1)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.01", Numeric.Entry = 0.01)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.02", Numeric.Entry = 0.02)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.03", Numeric.Entry = 0.03)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.04", Numeric.Entry = 0.04)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.05", Numeric.Entry = 0.05)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.06", Numeric.Entry = 0.06)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.07", Numeric.Entry = 0.07)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.08", Numeric.Entry = 0.08)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.09", Numeric.Entry = 0.09)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.10", Numeric.Entry = 0.10)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.11", Numeric.Entry = 0.11)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.12", Numeric.Entry = 0.12)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.13", Numeric.Entry = 0.13)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.14", Numeric.Entry = 0.14)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.15", Numeric.Entry = 0.15)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.16", Numeric.Entry = 0.16)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.17", Numeric.Entry = 0.17)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.18", Numeric.Entry = 0.18)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.19", Numeric.Entry = 0.19)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.20", Numeric.Entry = 0.20)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.21", Numeric.Entry = 0.21)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.22", Numeric.Entry = 0.22)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.23", Numeric.Entry = 0.23)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.24", Numeric.Entry = 0.24)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.25", Numeric.Entry = 0.25)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.26", Numeric.Entry = 0.26)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.27", Numeric.Entry = 0.27)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.28", Numeric.Entry = 0.28)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.29", Numeric.Entry = 0.29)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.30", Numeric.Entry = 0.30)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.31", Numeric.Entry = 0.31)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.32", Numeric.Entry = 0.32)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.33", Numeric.Entry = 0.33)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.34", Numeric.Entry = 0.34)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.35", Numeric.Entry = 0.35)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.36", Numeric.Entry = 0.36)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.37", Numeric.Entry = 0.37)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.38", Numeric.Entry = 0.38)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.39", Numeric.Entry = 0.39)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.03-0.04", Numeric.Entry = 0.035)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.05-0.06", Numeric.Entry = 0.055) 
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.05-0.09", Numeric.Entry = 0.07)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.07-0.08", Numeric.Entry = 0.075)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.09-0.10", Numeric.Entry = 0.095)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.10-0.14", Numeric.Entry = 0.12)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.10-0.19", Numeric.Entry = 0.145)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.11-0.12", Numeric.Entry = 0.115)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.13-0.14", Numeric.Entry = 0.135)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.15-0.16", Numeric.Entry = 0.155)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.17-0.18", Numeric.Entry = 0.175)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.15-0.19", Numeric.Entry = 0.17)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.19-0.20", Numeric.Entry = 0.195)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.20-0.24", Numeric.Entry = 0.22)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.20-0.29", Numeric.Entry = 0.245)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.20-0.39", Numeric.Entry = 0.295)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.21-0.22", Numeric.Entry = 0.215)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.23-0.24", Numeric.Entry = 0.235)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.25-0.26", Numeric.Entry = 0.255)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.25-0.29", Numeric.Entry = 0.27)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.27-0.28", Numeric.Entry = 0.275)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.29-0.30", Numeric.Entry = 0.295)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.30-0.34", Numeric.Entry = 0.32)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.30-0.39", Numeric.Entry = 0.345)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.31-0.32", Numeric.Entry = 0.315)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.33-0.34", Numeric.Entry = 0.335)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.40-0.44", Numeric.Entry = 0.42)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.40-0.49", Numeric.Entry = 0.445)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.40-0.59", Numeric.Entry = 0.495)
conversionsDF <- conversionsDF %>% add_row(Character.Entry = "0.60-0.79", Numeric.Entry = 0.695)
```

```{r c2yr}
# We pool completion data from 2019-20 and 2020-21. We do not go back further in order to use consistent CIP code schemes. 

c2021 <- fread("c2021_a.csv", header=TRUE, select=c(
  "UNITID",   # Unique identification number of the institution
  "CIPCODE",  # CIP Code -  2020 Classification
  "MAJORNUM", # First or Second Major
  "AWLEVEL",  # Award Level code
  "CTOTALT",  # Grand total
  "CAIANT",   # American Indian or Alaska Native total
  "CASIAT",   # Asian total
  "CBKAAT",   # Black or African American total
  "CHISPT",   # Hispanic or Latino total
  "CNHPIT",   # Native Hawaiian or Other Pacific Islander total
  "CWHITT",   # White total
  "C2MORT",   # Two or more races total
  "CUNKNT",   # Race/ethnicity unknown total
  "CNRALT"    # Nonresident alien total
)) %>% filter(MAJORNUM==1)

c2020 <- fread("c2020_a.csv", header=TRUE, select=c(
  "UNITID",   # Unique identification number of the institution
  "CIPCODE",  # CIP Code -  2020 Classification
  "MAJORNUM", # First or Second Major
  "AWLEVEL",  # Award Level code
  "CTOTALT",  # Grand total
  "CAIANT",   # American Indian or Alaska Native total
  "CASIAT",   # Asian total
  "CBKAAT",   # Black or African American total
  "CHISPT",   # Hispanic or Latino total
  "CNHPIT",   # Native Hawaiian or Other Pacific Islander total
  "CWHITT",   # White total
  "C2MORT",   # Two or more races total
  "CUNKNT",   # Race/ethnicity unknown total
  "CNRALT"    # Nonresident alien total
)) %>% filter(MAJORNUM==1)

c2yr <- rbind(c2021, c2020) %>% filter(CTOTALT != 0)
c2yr <- aggregate(data=c2yr, cbind(
  CTOTALT,  # Grand total
  CAIANT,   # American Indian or Alaska Native total
  CASIAT,   # Asian total
  CBKAAT,   # Black or African American total
  CHISPT,   # Hispanic or Latino total
  CNHPIT,   # Native Hawaiian or Other Pacific Islander total
  CWHITT,   # White total
  C2MORT,   # Two or more races total
  CUNKNT,   # Race/ethnicity unknown total
  CNRALT    # Nonresident alien total
) ~ UNITID + CIPCODE + AWLEVEL, FUN=sum)
hd2021.temp <- fread("hd2021.csv", header=TRUE, select=c("UNITID", "INSTNM", "STABBR", "OPEID"))
c2yr <- left_join(x=c2yr, y=hd2021.temp, by="UNITID")

c2yr$CTOTALT[is.na(c2yr$CTOTALT)] <- 0
c2yr$CAIANT[is.na(c2yr$CAIANT)] <- 0
c2yr$CASIAT[is.na(c2yr$CASIAT)] <- 0
c2yr$CBKAAT[is.na(c2yr$CBKAAT)] <- 0
c2yr$CHISPT[is.na(c2yr$CHISPT)] <- 0
c2yr$CNHPIT[is.na(c2yr$CNHPIT)] <- 0
c2yr$CWHITT[is.na(c2yr$CWHITT)] <- 0
c2yr$C2MORT[is.na(c2yr$C2MORT)] <- 0
c2yr$CUNKNT[is.na(c2yr$CUNKNT)] <- 0
c2yr$CNRALT[is.na(c2yr$CNRALT)] <- 0

c2yr$`Share who are AIAN` <- c2yr$CAIANT / c2yr$CTOTALT
c2yr$`Share who are ASIA` <- c2yr$CASIAT / c2yr$CTOTALT
c2yr$`Share who are BKAA` <- c2yr$CBKAAT / c2yr$CTOTALT
c2yr$`Share who are HISP` <- c2yr$CHISPT / c2yr$CTOTALT
c2yr$`Share who are NHPI` <- c2yr$CNHPIT / c2yr$CTOTALT
c2yr$`Share who are WHIT` <- c2yr$CWHITT / c2yr$CTOTALT
c2yr$`Share who are 2MOR` <- c2yr$C2MORT / c2yr$CTOTALT
c2yr$`Share who are UNKN` <- c2yr$CUNKNT / c2yr$CTOTALT
c2yr$`Share who are NRAL` <- c2yr$CNRALT / c2yr$CTOTALT
c2yr$`Share who are BKAA or HISP` <- (c2yr$CBKAAT + c2yr$CHISPT) / c2yr$CTOTALT
```

```{r CSILoad}
CSI <- fread("Most-Recent-Cohorts-Institution.csv", header=TRUE, select=c(
  
  # Basic information about institutions: 
  "UNITID",       # Unit ID for institution
  "OPEID",        # 8-digit OPEID
  "OPEID6",       # 6-digit OPEID
  "INSTNM",       # Institution name
  "CITY",         # City
  "STABBR",       # State postcode
  "MAIN",         # "Flag for main campus (0 Not main campus, 1 Main campus)
  "PREDDEG",      # Predominant undergraduate degree awarded
  "CONTROL",      # Control of institution
  "CCBASIC",      # Carnegie Classification -- basic
  
  # Information about federal student loan borrowing frequency: 
  "PCTFLOAN",   # Percent of all undergraduate students receiving a federal student loan
  "D_PCTPELL_PCTFLOAN",  # Number of undergraduate students (denominator percent receiving a pell grant or federal student loan)
  
  # Total existing student loan borrowers and total outstanding debt: 
  "LPSTAFFORD_CNT", # Number of borrowers with outstanding federal Direct Loan balances
  "LPSTAFFORD_AMT", # Total outstanding federal Direct Loan balance
  "LPPPLUS_CNT",    # Number of students associated with outstanding Parent PLUS Loan balances
  "LPPPLUS_AMT",    # Total outstanding Parent PLUS Loan balance
  "LPGPLUS_CNT",    # Number of students associated with outstanding Grad PLUS Loan balances
  "LPGPLUS_AMT",    # Total outstanding Grad PLUS Loan balance
  
  # Estimated range of students who receive Parent PLUS debt: 
  "PPLUS_PCT_LOW",  # Lower bound of estimated percentage range of students whose parents took out a PLUS loan
  "PPLUS_PCT_HIGH", # Upper bound of estimated percentage range of students whose parents took out a PLUS loan
  
  # Median Parent PLUS loan debt
  "PLUS_DEBT_INST_MD",        # Median PLUS loan debt disbursed at this institution
  "PLUS_DEBT_INST_COMP_MD",   # Median PLUS loan debt disbursed to completers at this institution
  "PLUS_DEBT_INST_PELL_MD",   # Median PLUS loan debt disbursed to Pell recipients at this institution
  "PLUS_DEBT_INST_NOPELL_MD", # Median PLUS loan debt disbursed to non-Pell-recipients at this institution
  
  # Median debt (excl. Parent PLUS)
  "DEBT_MDN",             # The median original amount of the loan principal upon entering repayment
  "GRAD_DEBT_MDN",        # The median debt for students who have completed
  
  # Median debt: student counts
  "DEBT_N",       # The number of students in the median debt cohort
  "GRAD_DEBT_N",  # The number of students in the median debt completers cohort
  
  # DBRR repayment rates: Undergraduate loans
  "DBRR10_FED_UG_N",   # Undergraduate federal student loan dollar-based 10-year repayment rate borrower count
  "DBRR10_FED_UG_NUM", # Undergraduate federal student loan dollar-based 10-year repayment rate numerator
  "DBRR10_FED_UG_DEN", # Undergraduate federal student loan dollar-based 10-year repayment rate denominator
  "DBRR10_FED_UG_RT",  # Undergraduate federal student loan dollar-based 10-year repayment rate
  
  # DBRR repayment rates: Graduate loans
  "DBRR10_FED_GR_N",   # Graduate federal student loan dollar-based 10-year repayment rate borrower count
  "DBRR10_FED_GR_NUM", # Graduate federal student loan dollar-based 10-year repayment rate numerator
  "DBRR10_FED_GR_DEN", # Graduate federal student loan dollar-based 10-year repayment rate denominator
  "DBRR10_FED_GR_RT",  # Graduate federal student loan dollar-based 10-year repayment rate
  
  # DBRR repayment rates: Parent PLUS loans
  "DBRR10_PP_UG_N",    # Undergraduate Parent PLUS Loan dollar-based 10-year repayment rate borrower count
  "DBRR10_PP_UG_NUM",  # Undergraduate Parent PLUS Loan dollar-based 10-year repayment rate numerator
  "DBRR10_PP_UG_DEN",  # Undergraduate Parent PLUS Loan dollar-based 10-year repayment rate denominator
  "DBRR10_PP_UG_RT",   # Undergraduate Parent PLUS Loan dollar-based 10-year repayment rate
  
  # BBRR repayment rates: 3-year Ns 
  "BBRR3_FED_UG_N",  # Undergraduate federal student loan borrower-based 3-year borrower count 
  "BBRR3_FED_GR_N",  # Graduate federal student loan borrower-based 3-year borrower count
  "BBRR3_PP_UG_N",   # Undergraduate student Parent PLUS Loan borrower-based 3-year borrower count
  
  # BBRR repayment rates: Undergraduate borrowers
  "BBRR3_FED_UG_DFLT",           # Percentage of undergraduate federal student loan borrowers in default after 3 years
  "BBRR3_FED_UG_DLNQ",           # Percentage of undergraduate federal student loan borrowers in delinquency after 3 years
  "BBRR3_FED_UG_NOPROG",         # Percentage of undergraduate federal student loan borrowers not making progress after 3 years
  "BBRR3_FED_UG_MAKEPROG",       # Percentage of undergraduate federal student loan borrowers making progress after 3 years
  
  # BBRR repayment rates: Graduate borrowers
  "BBRR3_FED_GR_DFLT",           # Percentage of graduate federal student loan borrowers in default after 3 years
  "BBRR3_FED_GR_DLNQ",           # Percentage of graduate federal student loan borrowers in delinquency after 3 years
  "BBRR3_FED_GR_NOPROG",         # Percentage of graduate federal student loan borrowers not making progress after 3 years
  "BBRR3_FED_GR_MAKEPROG",       # Percentage of graduate federal student loan borrowers making progress after 3 years
  
  # BBRR repayment rates: Parent PLUS borrowers
  "BBRR3_PP_UG_DFLT",           # Percentage of undergraduate student Parent PLUS Loan borrowers in default after 3 years
  "BBRR3_PP_UG_DLNQ",           # Percentage of undergraduate student Parent PLUS Loan borrowers in delinquency after 3 years
  "BBRR3_PP_UG_NOPROG",         # Percentage of undergraduate student Parent PLUS Loan borrowers not making progress after 3 years
  "BBRR3_PP_UG_MAKEPROG"       # Percentage of undergraduate student Parent PLUS Loan borrowers making progress after 3 years
))
```

```{r OPEID6byState}
allCA <- CSI
allCA$Count <- rep(1, nrow(allCA))
allCA <- aggregate(data=allCA, Count ~ OPEID6 + STABBR, FUN=sum)
notInCA <- allCA %>% filter(STABBR != "CA")
Institutions.Based.At.Least.Partially.Outside.CA <- notInCA$OPEID6
```

```{r CSPLoad}
CSP <- fread("Most-Recent-Cohorts-Field-of-Study.csv", header=TRUE, select=c(
  
  # Basic information about institutions: 
  "UNITID",       # Unit ID for institution
  "OPEID6",       # 6-digit OPE ID for institution
  "INSTNM",       # Institution name
  "MAIN",         # Flag for main campus
  "CONTROL",      # Control of institution
  "CIPCODE",      # Classification of Instructional Programs (CIP) code for the field of study
  "CIPDESC",      # Text description of the field of study CIP Code
  "CREDLEV",      # Level of credential
  "CREDDESC",     # Text description of the level of credential
  
  # Median Parent PLUS debt
  "DEBT_ALL_PP_EVAL_N",            # Student recipient count for average/median Parent PLUS loan debt disbursed at this institution
  "DEBT_ALL_PP_EVAL_MEAN",         # Average Parent PLUS loan debt disbursed at this institution
  "DEBT_ALL_PP_EVAL_MDN",          # Median Parent PLUS loan debt disbursed at this institution
  
  # Median Stafford / Grad PLUS debt 
  "DEBT_ALL_STGP_EVAL_N",          # Borrower count for average/median Stafford and Grad PLUS loan debt disbursed at this institution
  "DEBT_ALL_STGP_EVAL_MEAN",       # Average Stafford and Grad PLUS loan debt disbursed at this institution
  "DEBT_ALL_STGP_EVAL_MDN",        # Median Stafford and Grad PLUS loan debt disbursed at this institution
  
  # Median Stafford / Grad PLUS debt among students that received Pell 
  "DEBT_PELL_STGP_EVAL_N",         # Borrower count for average/median Stafford and Grad PLUS loan debt disbursed to Pell recipients at this institution
  "DEBT_PELL_STGP_EVAL_MEAN",      # Average Stafford and Grad PLUS loan debt disbursed to Pell recipients at this institution
  "DEBT_PELL_STGP_EVAL_MDN",       # Median Stafford and Grad PLUS loan debt disbursed to Pell recipients at this institution
  
  # Median earnings of graduates working and not enrolled
  "EARN_MDN_HI_1YR",         # Median earnings of graduates working and not enrolled 1 year after completing highest credential
  "EARN_COUNT_WNE_HI_1YR",   # Number of graduates working and not enrolled 1 year after completing highest credential	
  "EARN_CNTOVER150_HI_1YR",  # Number of graduates working and not enrolled who earned more than 150% of the single-person household poverty threshold 1 year after completing highest credential
  "EARN_MDN_HI_2YR",         # Median earnings of graduates working and not enrolled 2 years after completing highest credential
  "EARN_COUNT_WNE_HI_2YR",   # Number of graduates working and not enrolled 2 years after completing highest credential	
  "EARN_CNTOVER150_HI_2YR",  # Number of graduates working and not enrolled who earned more than 150% of the single-person household poverty threshold 2 years after completing highest credential
  
  # Median earnings of graduates working and not enrolled, by Pell status and gender
  "EARN_PELL_WNE_MDN_1YR",   # Median earnings of graduates who received a Pell Grant and were working and not enrolled 1 year after completing highest credential
  "EARN_COUNT_PELL_WNE_1YR", # Number of graduates who received a Pell Grant and were working and not enrolled 1 year after completing highest credential
  "EARN_MALE_WNE_MDN_1YR",   # Median earnings of male graduates working and not enrolled 1 year after completing highest credential
  "EARN_NOMALE_WNE_MDN_1YR"  # Median earnings of non-male graduates working and not enrolled 1 year after completing highest credential
))
states <- CSI %>% select(UNITID, STABBR)
states$UNITID <- as.character(states$UNITID)
CSP <- left_join(x=CSP, y=states, by="UNITID")
```

```{r ScorecardAdjustments}
CSI$STABBR2 <- CSI$STABBR
c2yr$STABBR[c2yr$STABBR != "CA"] <- "Rest of U.S."
CSI$STABBR[CSI$STABBR != "CA"] <- "Rest of U.S."
CSP$STABBR[CSP$STABBR != "CA"] <- "Rest of U.S."

c2yr$STABBR[is.na(c2yr$STABBR)] <- "Rest of U.S."
CSI$STABBR[is.na(CSI$STABBR)] <- "Rest of U.S."
CSP$STABBR[is.na(CSP$STABBR)] <- "Rest of U.S."

CSI$CONTROL <- as.character(CSI$CONTROL)
CSI$CONTROL[CSI$CONTROL==1] <- "Public"
CSI$CONTROL[CSI$CONTROL==2] <- "Non-profit"
CSI$CONTROL[CSI$CONTROL==3] <- "For-profit"

CSP$CONTROL <- as.character(CSP$CONTROL)
CSP$CONTROL[CSP$CONTROL==1] <- "Public"
CSP$CONTROL[CSP$CONTROL==2] <- "Non-profit"
CSP$CONTROL[CSP$CONTROL==3] <- "For-profit"
```

Table 4 shows institutions in California by their total outstanding loan debt, total borrowers with outstanding debt, and average debt balance. I included the top 100 by the average outstanding debt amount. There is one tab for each of three loan programs: Stafford, Parent PLUS, and Grad PLUS. 

Some of the top institutions by the average Stafford debt are health sciences schools and law schools. There are only two public institutions in the top 75, and neither confers undergraduate degrees. 

The institutions with the largest average Parent PLUS loan debt balances include art colleges and selective universities. It is not until 33 rows down the table that the first public institution appears. While a Parent PLUS debt balance of \$50,000 or more may be manageable for a very wealthy family, it can spell [long-term financial harship](https://tcf.org/content/report/parent-plus-borrowers-the-hidden-casualties-of-the-student-debt-crisis/) for those with less resources. 

The top institutions by average outstanding Grad PLUS debt include many of the same as the top for average Stafford balance: the top 10 for both includes Palo Alto University, Five Branches University, and Touro University California, to name a few. 

### {.tabset}
```{r TotalOutstandingDebt, warning=FALSE}
Q6 <- CSI %>% select(UNITID, OPEID, OPEID6, INSTNM, CONTROL, STABBR, MAIN, LPSTAFFORD_CNT, LPSTAFFORD_AMT, LPPPLUS_CNT, LPPPLUS_AMT, LPGPLUS_CNT, LPGPLUS_AMT) %>% filter(STABBR=="CA") %>% filter(MAIN==1) %>% filter(duplicated(OPEID6)==FALSE)

Q6$LPSTAFFORD_CNT <- as.numeric(Q6$LPSTAFFORD_CNT)
Q6$LPSTAFFORD_AMT <- as.numeric(Q6$LPSTAFFORD_AMT)
Q6$LPPPLUS_CNT <- as.numeric(Q6$LPPPLUS_CNT)
Q6$LPPPLUS_AMT <- as.numeric(Q6$LPPPLUS_AMT)
Q6$LPGPLUS_CNT <- as.numeric(Q6$LPGPLUS_CNT)
Q6$LPGPLUS_AMT <- as.numeric(Q6$LPGPLUS_AMT)

Q6$`Total outstanding debt` <- Q6$LPSTAFFORD_AMT + Q6$LPPPLUS_AMT + Q6$LPGPLUS_AMT
Q6$`Average outstanding Stafford debt` <- Q6$LPSTAFFORD_AMT / Q6$LPSTAFFORD_CNT
Q6$`Average outstanding Parent PLUS debt` <- Q6$LPPPLUS_AMT / Q6$LPPPLUS_CNT
Q6$`Average outstanding Grad PLUS debt` <- Q6$LPGPLUS_AMT / Q6$LPGPLUS_CNT

Q6.TotalStaffordDebt <- Q6 %>% arrange(desc(`Average outstanding Stafford debt`)) %>% filter(LPSTAFFORD_CNT >= 500) %>% select(INSTNM, CONTROL, LPSTAFFORD_AMT, LPSTAFFORD_CNT, `Average outstanding Stafford debt`)
Q6.TotalParentDebt <- Q6 %>% arrange(desc(`Average outstanding Parent PLUS debt`)) %>% filter(LPPPLUS_CNT >= 500) %>% select(INSTNM, CONTROL, LPPPLUS_AMT, LPPPLUS_CNT, `Average outstanding Parent PLUS debt`)
Q6.TotalGradDebt <- Q6 %>% arrange(desc(`Average outstanding Grad PLUS debt`)) %>% filter(LPGPLUS_CNT >= 500) %>% select(INSTNM, CONTROL, LPGPLUS_AMT, LPGPLUS_CNT, `Average outstanding Grad PLUS debt`)
Q6.TotalDebt <- Q6 %>% filter((OPEID6 %in% Institutions.Based.At.Least.Partially.Outside.CA)==FALSE) %>% arrange(desc(`Total outstanding debt`)) %>% select(INSTNM, CONTROL, `Total outstanding debt`)

Q6.TotalStaffordDebt$`Average outstanding Stafford debt` <- dollar(round((Q6.TotalStaffordDebt$`Average outstanding Stafford debt`), -2), accuracy=1)
Q6.TotalParentDebt$`Average outstanding Parent PLUS debt` <- dollar(round((Q6.TotalParentDebt$`Average outstanding Parent PLUS debt`), -2), accuracy=1)
Q6.TotalGradDebt$`Average outstanding Grad PLUS debt` <- dollar(round((Q6.TotalGradDebt$`Average outstanding Grad PLUS debt`), -2), accuracy=1)

Q6.TotalStaffordDebt$LPSTAFFORD_AMT <- dollar(round((Q6.TotalStaffordDebt$LPSTAFFORD_AMT), -3), accuracy=1)
Q6.TotalParentDebt$LPPPLUS_AMT <- dollar(round((Q6.TotalParentDebt$LPPPLUS_AMT), -3), accuracy=1)
Q6.TotalGradDebt$LPGPLUS_AMT <- dollar(round((Q6.TotalGradDebt$LPGPLUS_AMT), -3), accuracy=1)
Q6.TotalDebt$`Total outstanding debt` <- dollar(round((Q6.TotalDebt$`Total outstanding debt`), -3), accuracy=1)

Q6.TotalStaffordDebt$LPSTAFFORD_CNT <- comma(round(Q6.TotalStaffordDebt$LPSTAFFORD_CNT, -1))
Q6.TotalParentDebt$LPPPLUS_CNT <- comma(round(Q6.TotalParentDebt$LPPPLUS_CNT, -1))
Q6.TotalGradDebt$LPGPLUS_CNT <- comma(round(Q6.TotalGradDebt$LPGPLUS_CNT, -1))
```
#### Table 4: Stafford debt
```{r kable4A, results='asis'}
kable4A <- Q6.TotalStaffordDebt[1:100, ] %>% select(INSTNM, CONTROL, LPSTAFFORD_AMT, LPSTAFFORD_CNT, `Average outstanding Stafford debt`)
names(kable4A) <- c("Institution name", "Control of institution", "Total outstanding Stafford loan debt", "Total Stafford loan borrowers", "Average outstanding Stafford debt")
kable(kable4A, caption="Top 100 California institutions by average outstanding Stafford balance") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Table 4: Parent PLUS debt
```{r kable4B, results='asis'}
kable4B <- Q6.TotalParentDebt[1:100, ] %>% select(INSTNM, CONTROL, LPPPLUS_AMT, LPPPLUS_CNT, `Average outstanding Parent PLUS debt`)
names(kable4B) <- c("Institution name", "Control of institution", "Total outstanding Parent PLUS loan debt", "Total Parent PLUS loan borrowers", "Average outstanding Parent PLUS debt")
kable(kable4B, caption="Top 100 California institutions by average outstanding Parent PLUS balance") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Table 4: Grad PLUS debt
```{r kable4C, results='asis'}
kable4C <- Q6.TotalGradDebt %>% select(INSTNM, CONTROL, LPGPLUS_AMT, LPGPLUS_CNT, `Average outstanding Grad PLUS debt`)
names(kable4C) <- c("Institution name", "Control of institution", "Total outstanding Grad PLUS loan debt", "Total Grad PLUS loan borrowers", "Average outstanding Grad PLUS debt")
kable(kable4C, caption="Top California institutions by average outstanding Grad PLUS balance") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Table 4: Total debt
```{r kable4D, results='asis'}
kable4D <- Q6.TotalDebt[1:100, ] %>% select(INSTNM, CONTROL, `Total outstanding debt`)
names(kable4D) <- c("Institution name", "Control of institution", "Total outstanding debt")
kable(kable4D, caption="Top 100 California institutions by total outstanding loan balance") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Data Source and Notes

**Data source:** College Scorecard institution dataset, accessed November 2022, available through the U.S. Department of Education [here](https://collegescorecard.ed.gov/data/). 

**Timeframe reflected:** Loan data in this table reflect borrowers' balances as measured in the National Student Loan Data System on June 30, 2021. 

**Notes:** Only 73 institutions have at least 500 borrowers with outstanding Grad PLUS debt. Total debt rounded to nearest \$1,000, total borrowers rounded to nearest 10, and average debt rounded to nearest \$100. 

***

### {-}

Table 4 was limited to institutions headquartered in California. However, institutions based outside of California are also a major source of debt for Californians thanks to online education. 

For Table 5, I use IPEDS data on the share of enrollment that is online and the share of enrollment from California to estimate online enrollment by college students who reside in California. By applying those percentages to measures of outstanding debt, I estimate the share of debt that comes from California students enrolled online. 

Table 5 ranks the top institutions headquartered outside of California by total estimated outstanding debt from California students enrolled online. It is perhaps no surprise to see these institutions listed, as they are the largest universities in the country by online enrollment. However, it is somewhat startling to think about the volume of debt placed on Californians' shoulders from these out-of-state institutions: almost \$5 billion from just the University of Phoenix and Grand Canyon University alone. 

### {.tabset}
```{r outsideDebt, warning=FALSE}
### What is the amount of debt that comes to California borrowers who are enrolled entirely online?

ef2018a <- fread("ef2018a_dist_rv.csv", header=TRUE, select=c(
  "UNITID",  # Unique identification number of the institution
  "EFDELEV", # Level of student
  "EFDETOT", # All students enrolled
  "EFDEEXC"  # Students enrolled exclusively in distance education courses
)) %>% filter(EFDELEV==1) %>% select(UNITID, EFDETOT, EFDEEXC) # Distance education status and level of student: Fall 2018
names(ef2018a) <- c("UNITID", "All students enrolled", "Students enrolled exclusively online")

ef2018c <- fread("ef2018c_rv.csv", header=TRUE, select=c(
  "UNITID",   # Unique identification number of the institution
  "EFCSTATE", # State of residence when student was first admitted
  "EFRES01"   # First-time degree/certificate-seeking undergraduate students
)) # Residence and migration of first-time freshman: Fall 2018
# 58	US total
# 6	California
ef2018c.CA <- ef2018c %>% filter(EFCSTATE == 6) %>% select(UNITID, EFRES01)
names(ef2018c.CA) <- c("UNITID", "Undergraduates from California")
ef2018c.US <- ef2018c %>% filter(EFCSTATE == 58) %>% select(UNITID, EFRES01)
names(ef2018c.US) <- c("UNITID", "All undergraduates")
ef2018c <- full_join(x=ef2018c.US, y=ef2018c.CA, by="UNITID")

hd2019 <- fread("hd2019.csv", header=TRUE, select=c(
  "UNITID", # Unique identification number of the institution
  "STABBR", # State abbreviation
  "OPEID"   # Office of Postsecondary Education (OPE) ID Number
)) # Institutional characteristics: 2018-19

Q17 <- left_join(x=hd2019, y=ef2018c, by="UNITID")
Q17 <- left_join(x=Q17, y=ef2018a, by="UNITID")
Q17$OPEID <- as.character(Q17$OPEID)
Q17 <- Q17 %>% filter(OPEID != "-2")

Q17$`All students enrolled`[is.na(Q17$`All students enrolled`)] <- 0
Q17$`Students enrolled exclusively online`[is.na(Q17$`Students enrolled exclusively online`)] <- 0
Q17$`All undergraduates`[is.na(Q17$`All undergraduates`)] <- 0
Q17$`Undergraduates from California`[is.na(Q17$`Undergraduates from California`)] <- 0

Q17$OPEID6 <- Q17$OPEID
Q17$OPEID6 <- ifelse(nchar(Q17$OPEID6)==6, paste("0", Q17$OPEID6, sep=""), Q17$OPEID6)
Q17$OPEID6 <- ifelse(nchar(Q17$OPEID6)==7, paste("0", Q17$OPEID6, sep=""), Q17$OPEID6)
Q17$OPEID6 <- substr(Q17$OPEID6, 1, 6)

Q17 <- aggregate(data=Q17, cbind(`All undergraduates`, `Undergraduates from California`, `Students enrolled exclusively online`, `All students enrolled`) ~ OPEID6, FUN=sum)
Q17$`California share of all undergraduates` <- Q17$`Undergraduates from California` / Q17$`All undergraduates`
Q17$`California share of all undergraduates`[is.na(Q17$`California share of all undergraduates`)] <- 0
Q17$`Estimated students from California enrolled online` <- Q17$`California share of all undergraduates` * Q17$`Students enrolled exclusively online`
Q17$`Estimated students from California enrolled online as a share of all undergraduates` <- Q17$`Estimated students from California enrolled online` / Q17$`All students enrolled`

# Let's find out which institutions *not* based in California have the most students from California enrolled entirely online. 

Q17.2 <- CSI %>% select(OPEID6, INSTNM, CONTROL, STABBR2, MAIN, DEBT_MDN, GRAD_DEBT_MDN, LPSTAFFORD_AMT, LPPPLUS_AMT, LPGPLUS_AMT) %>% filter(MAIN==1)

Q17.2$DEBT_MDN <- as.numeric(Q17.2$DEBT_MDN)
Q17.2$GRAD_DEBT_MDN <- as.numeric(Q17.2$GRAD_DEBT_MDN)
Q17.2$LPSTAFFORD_AMT <- as.numeric(Q17.2$LPSTAFFORD_AMT)
Q17.2$LPPPLUS_AMT <- as.numeric(Q17.2$LPPPLUS_AMT)
Q17.2$LPGPLUS_AMT <- as.numeric(Q17.2$LPGPLUS_AMT)

Q17.2$LPSTAFFORD_AMT[is.na(Q17.2$LPSTAFFORD_AMT)] <- 0
Q17.2$LPPPLUS_AMT[is.na(Q17.2$LPPPLUS_AMT)] <- 0
Q17.2$LPGPLUS_AMT[is.na(Q17.2$LPGPLUS_AMT)] <- 0

Q17.2$OPEID6 <- as.character(Q17.2$OPEID6)
Q17.2$OPEID6 <- ifelse(nchar(Q17.2$OPEID6)==4, paste("0", Q17.2$OPEID6, sep=""), Q17.2$OPEID6)
Q17.2$OPEID6 <- ifelse(nchar(Q17.2$OPEID6)==5, paste("0", Q17.2$OPEID6, sep=""), Q17.2$OPEID6)
Q17 <- left_join(x=Q17, y=Q17.2, by="OPEID6")

Q17.OutsideCA <- Q17 %>% filter(STABBR2 != "CA")
Q17.OutsideCA <- Q17.OutsideCA %>% select(INSTNM, STABBR2, `Estimated students from California enrolled online`, `California share of all undergraduates`, `Estimated students from California enrolled online as a share of all undergraduates`, DEBT_MDN, GRAD_DEBT_MDN, LPSTAFFORD_AMT, LPPPLUS_AMT, LPGPLUS_AMT)

Q17.OutsideCA$`Total outstanding debt` <- Q17.OutsideCA$LPSTAFFORD_AMT + Q17.OutsideCA$LPPPLUS_AMT + Q17.OutsideCA$LPGPLUS_AMT
Q17.OutsideCA$`Estimated debt for students from California enrolled online` <- Q17.OutsideCA$`Estimated students from California enrolled online as a share of all undergraduates` * Q17.OutsideCA$`Total outstanding debt`

Q17.OutsideCA <- Q17.OutsideCA %>% arrange(desc(`Estimated debt for students from California enrolled online`)) %>% select(INSTNM, STABBR2, `Estimated students from California enrolled online`, `Estimated debt for students from California enrolled online`)

totalOutsideDebt <- sum(Q17.OutsideCA$`Estimated debt for students from California enrolled online`, na.rm=TRUE)

Q17.OutsideCA$`Estimated students from California enrolled online` <- comma(round(Q17.OutsideCA$`Estimated students from California enrolled online`, -1))
Q17.OutsideCA$`Estimated debt for students from California enrolled online` <- dollar(round(Q17.OutsideCA$`Estimated debt for students from California enrolled online`, -3), accuracy=1)

# sum(Q17.OutsideCA$`Estimated students from California enrolled online`, na.rm=TRUE)
# sum(Q17.OutsideCA$`Estimated debt for students from California enrolled online`, na.rm=TRUE)
```
#### Table 5
```{r kable5, results='asis'}
kable5 <- Q17.OutsideCA[1:100, ]
names(kable5) <- c("Institution name", "State", "Estimated students from California enrolled online, Fall 2018", "Estimated outstanding debt from California students enrolled online")
kable(kable5, caption="Top 100 institutions based outside California, by estimated outstanding debt from online enrollment by California students") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Data Source and Notes

**Data source:** The figures in this table were calculated using data from two sources. First is the College Scorecard institution dataset, accessed November 2022, available through the U.S. Department of Education [here](https://collegescorecard.ed.gov/data/). Second is the IPEDS Fall Enrollment survey, accessed December 2022, available through NCES [here](https://nces.ed.gov/ipeds/use-the-data).

**Timeframe reflected:** Loan data used for this table reflect borrowers' balances as measured in the National Student Loan Data System on June 30, 2021. Enrollment data on distance education reflect Fall 2018. I use this enrollment data as a proxy for current enrollment. 

**Notes:** Estimated outstanding debt is rounded to the nearest $1,000. Estimated online enrollment is rounded to the nearest 10. 

***

### {-}

In total, an estimated $11.6 billion comes from online enrollment by California students at institutions based outside the state.

The top institutions by outstanding debt have so far all been private institutions. In the first tab of Table 6, we see the breakdown of loan debt from California's three public sectors. In total, there is \$37 billion in outstanding debt from California's public colleges and universities, with the CSU and UC contributing the vast majority. 

The next tab shows outstanding debt by program and institutional control. Nonprofit institutions contribute the most total debt, \$54 billion, with an outsized share coming from the Grad PLUS program (25.6 percent). Debt from for-profit colleges totals \$24 billion and is almost all in Stafford loans. Meanwhile, public institutions see Parent PLUS contributing the largest share of total sector debt at 8.2 percent.

### {.tabset}
#### Table 6: California public segments
```{r segments, warning=FALSE}
Q18 <- CSI %>% select(OPEID6, INSTNM, STABBR, CONTROL, LPSTAFFORD_AMT, LPPPLUS_AMT, LPGPLUS_AMT) %>% filter(STABBR=="CA") %>% filter(CONTROL=="Public") %>% filter(duplicated(OPEID6)==FALSE)

Q18$LPSTAFFORD_AMT <- as.numeric(Q18$LPSTAFFORD_AMT)
Q18$LPPPLUS_AMT <- as.numeric(Q18$LPPPLUS_AMT)
Q18$LPGPLUS_AMT <- as.numeric(Q18$LPGPLUS_AMT)

Q18$LPSTAFFORD_AMT[is.na(Q18$LPSTAFFORD_AMT)] <- 0
Q18$LPPPLUS_AMT[is.na(Q18$LPPPLUS_AMT)] <- 0
Q18$LPGPLUS_AMT[is.na(Q18$LPGPLUS_AMT)] <- 0

Q18$OPEID6 <- as.character(Q18$OPEID6)
Q18$OPEID6 <- ifelse(nchar(Q18$OPEID6)==4, paste("0", Q18$OPEID6, sep=""), Q18$OPEID6)
Q18$OPEID6 <- ifelse(nchar(Q18$OPEID6)==5, paste("0", Q18$OPEID6, sep=""), Q18$OPEID6)

Q18$`Segment` <- rep(NA, nrow(Q18))

Q18$`Segment`[Q18$OPEID6 %in% c(
  "001111",
  "001113",
  "001118",
  "001119",
  "001124",
  "001161",
  "001162",
  "001163",
  "001166",
  "001176",
  "001178",
  "001181",
  "001182",
  "001185",
  "001186",
  "001187",
  "001190",
  "001191",
  "001192",
  "001193",
  "001197",
  "001199",
  "001201",
  "001202",
  "001203",
  "001206",
  "001208",
  "001209",
  "001214",
  "001217",
  "001219",
  "001223",
  "001224",
  "001226",
  "001227",
  "001228",
  "001232",
  "001233",
  "001237",
  "001239",
  "001239",
  "001240",
  "001242",
  "001245",
  "001246",
  "001247",
  "001250",
  "001259",
  "001260",
  "001261",
  "001266",
  "001267",
  "001268",
  "001269",
  "001270",
  "001272",
  "001273",
  "001275",
  "001280",
  "001282",
  "001284",
  "001285",
  "001286",
  "001287",
  "001289",
  "001290",
  "001292",
  "001294",
  "001307",
  "001308",
  "001309",
  "001334",
  "001335",
  "001338",
  "001344",
  "004480",
  "004481",
  "004502",
  "006720",
  "006973",
  "007047",
  "007115",
  "007536",
  "007707",
  "007713",
  "008073",
  "008596",
  "008597",
  "008903",
  "008918",
  "009272",
  "010111",
  "010340",
  "011672",
  "011820",
  "012452",
  "012550",
  "012842",
  "012907",
  "020635",
  "021113",
  "021191",
  "022260",
  "022427",
  "030357",
  "035424",
  "036957",
  "038713",
  "041113",
  "041438",
  "041735",
  "041761",
  "042534",
  "042817"
)] <- "California Community Colleges"

Q18$`Segment`[Q18$OPEID6 %in% c(
  "001134", 
  "001137", 
  "001138", 
  "001139", 
  "001140", 
  "001141", 
  "001142", 
  "001143", 
  "001144", 
  "001146", 
  "001147", 
  "001149", 
  "001150", 
  "001151", 
  "001153", 
  "001154", 
  "001155", 
  "001156", 
  "001157", 
  "007993",
  "030113", 
  "032603", 
  "039803"
)] <- "California State University"

Q18$`Segment`[Q18$OPEID6 %in% c(
  "001312", 
  "001313", 
  "001314", 
  "001315", 
  "001316", 
  "001317", 
  "001319", 
  "001320", 
  "001321", 
  "003947",
  "041271"
)] <- "University of California"

Q18 <- Q18 %>% filter(is.na(`Segment`)==FALSE)
Q18.1 <- aggregate(data=Q18, cbind(LPSTAFFORD_AMT, LPPPLUS_AMT, LPGPLUS_AMT) ~ Segment, FUN=sum)
Q18.1 <- Q18.1 %>% add_row(Segment="All segments", 
                           LPSTAFFORD_AMT=sum(Q18.1$LPSTAFFORD_AMT, na.rm=TRUE), 
                           LPPPLUS_AMT=sum(Q18.1$LPPPLUS_AMT, na.rm=TRUE), 
                           LPGPLUS_AMT=sum(Q18.1$LPGPLUS_AMT, na.rm=TRUE))
Q18.1$`Total debt` <- Q18.1$LPSTAFFORD_AMT + Q18.1$LPPPLUS_AMT + Q18.1$LPGPLUS_AMT

Q18.1$LPSTAFFORD_AMT <- dollar(round(Q18.1$LPSTAFFORD_AMT, -3), accuracy=1)
Q18.1$LPPPLUS_AMT <- dollar(round(Q18.1$LPPPLUS_AMT, -3), accuracy=1)
Q18.1$LPGPLUS_AMT <- dollar(round(Q18.1$LPGPLUS_AMT, -3), accuracy=1)
Q18.1$`Total debt` <- dollar(round(Q18.1$`Total debt`, -3), accuracy=1)
```

```{r kable6A, results='asis'}
kable6A <- Q18.1
names(kable6A) <- c("Segment", "Outstanding Stafford debt", "Outstanding Parent PLUS debt", "Outstanding Grad PLUS debt", "Total debt")
kable(kable6A, caption="Public segments of California higher education by outstanding federal student loan debt") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%")
```
#### Table 6: All California sectors
```{r sectors, warning=FALSE}
Q19 <- CSI %>% select(OPEID6, INSTNM, STABBR, MAIN, CONTROL, LPSTAFFORD_AMT, LPPPLUS_AMT, LPGPLUS_AMT) %>% filter(STABBR=="CA") %>% filter(MAIN==1) %>% filter(duplicated(OPEID6)==FALSE)

Q19$LPSTAFFORD_AMT <- as.numeric(Q19$LPSTAFFORD_AMT)
Q19$LPPPLUS_AMT <- as.numeric(Q19$LPPPLUS_AMT)
Q19$LPGPLUS_AMT <- as.numeric(Q19$LPGPLUS_AMT)

Q19$LPSTAFFORD_AMT[is.na(Q19$LPSTAFFORD_AMT)] <- 0
Q19$LPPPLUS_AMT[is.na(Q19$LPPPLUS_AMT)] <- 0
Q19$LPGPLUS_AMT[is.na(Q19$LPGPLUS_AMT)] <- 0

Q19$OPEID6 <- as.character(Q19$OPEID6)
Q19$OPEID6 <- ifelse(nchar(Q19$OPEID6)==4, paste("0", Q19$OPEID6, sep=""), Q19$OPEID6)
Q19$OPEID6 <- ifelse(nchar(Q19$OPEID6)==5, paste("0", Q19$OPEID6, sep=""), Q19$OPEID6)

Q19 <- aggregate(data=Q19, cbind(LPSTAFFORD_AMT, LPPPLUS_AMT, LPGPLUS_AMT) ~ CONTROL, FUN=sum)

Q19$`Total debt` <- Q19$LPSTAFFORD_AMT + Q19$LPPPLUS_AMT + Q19$LPGPLUS_AMT

Q19 <- Q19 %>% add_row(CONTROL="All sectors", 
                       LPSTAFFORD_AMT=sum(Q19$LPSTAFFORD_AMT), 
                       LPPPLUS_AMT=sum(Q19$LPPPLUS_AMT), 
                       LPGPLUS_AMT=sum(Q19$LPGPLUS_AMT), 
                       `Total debt`=sum(Q19$`Total debt`))
Q19$LPSTAFFORD_AMT <- dollar(round(Q19$LPSTAFFORD_AMT, -3), accuracy=1)
Q19$LPPPLUS_AMT <- dollar(round(Q19$LPPPLUS_AMT, -3), accuracy=1)
Q19$LPGPLUS_AMT <- dollar(round(Q19$LPGPLUS_AMT, -3), accuracy=1)
Q19$`Total debt` <- dollar(round(Q19$`Total debt`, -3), accuracy=1)
```

```{r kable6B, results='asis'}
kable6B <- Q19
names(kable6B) <- c("Sector", "Outstanding Stafford debt", "Outstanding Parent PLUS debt", "Outstanding Grad PLUS debt", "Total debt")
kable(kable6B, caption="Sectors of California higher education by outstanding federal student loan debt") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%")
```
#### Data Source and Notes

**Data source:** College Scorecard institution dataset, accessed November 2022, available through the U.S. Department of Education [here](https://collegescorecard.ed.gov/data/). 

**Timeframe reflected:** Loan data in this table reflect borrowers' balances as measured in the National Student Loan Data System on June 30, 2021. 

**Notes:** Values rounded to the nearest \$1,000. 

***

### {-}

Table 7 compares institutions by their share of undergraduates who receive federal student loans. The top 25 are all for-profit colleges, with a few exceptions. Examples like West Coast University-Los Angeles, which have a median debt at graduation north of \$30,000 and see almost 9 out of every 10 undergraduates borrowing loans, are cases where a student who graduates without significant debt is almost a rarity. 

### {.tabset}
```{r highestBorrowingRates, warning=FALSE}
Q20 <- CSI %>% select(INSTNM,              # Institution name
                      OPEID6,              # 6-digit OPEID 
                      STABBR,              # State abbreviation
                      CONTROL,             # Control of institution
                      MAIN,                # Flag for main campus
                      PCTFLOAN,            # Percent of all undergraduate students receiving a federal student loan
                      D_PCTPELL_PCTFLOAN,  # Number of undergraduate students (denominator percent receiving a pell grant or federal student loan)
                      GRAD_DEBT_MDN,       # The median debt for students who have completed
                      GRAD_DEBT_N          # The number of students in the median debt completers cohort
) %>% filter(STABBR=="CA")

Q20$PCTFLOAN <- as.numeric(Q20$PCTFLOAN)
Q20$D_PCTPELL_PCTFLOAN <- as.numeric(Q20$D_PCTPELL_PCTFLOAN)
Q20$N_PCTFLOAN <- Q20$PCTFLOAN * Q20$D_PCTPELL_PCTFLOAN

Q20$GRAD_DEBT_MDN <- as.numeric(Q20$GRAD_DEBT_MDN)
Q20$GRAD_DEBT_N <- as.numeric(Q20$GRAD_DEBT_N)

Q20.1 <- aggregate(data=Q20, cbind(N_PCTFLOAN, D_PCTPELL_PCTFLOAN) ~ OPEID6, FUN=sum)
Q20.1$`Percent of undergraduates who receive federal student loans` <- Q20.1$N_PCTFLOAN / Q20.1$D_PCTPELL_PCTFLOAN
Q20.1 <- Q20.1 %>% select(OPEID6, `Percent of undergraduates who receive federal student loans`)
Q20.2 <- Q20 %>% arrange(desc(MAIN)) %>% filter(duplicated(OPEID6)==FALSE) %>% select(OPEID6, INSTNM, CONTROL, GRAD_DEBT_MDN, GRAD_DEBT_N)
Q20.3 <- left_join(x=Q20.1, y=Q20.2, by="OPEID6")

Q20.3 <- Q20.3 %>% filter(GRAD_DEBT_N > 300) %>% arrange(desc(`Percent of undergraduates who receive federal student loans`)) %>% select(INSTNM, CONTROL, `Percent of undergraduates who receive federal student loans`, GRAD_DEBT_MDN) 
Q20.3$`Percent of undergraduates who receive federal student loans` <- percent(Q20.3$`Percent of undergraduates who receive federal student loans`, accuracy=0.1)
Q20.3$GRAD_DEBT_MDN <- dollar(Q20.3$GRAD_DEBT_MDN, accuracy=1)
```
#### Table 7
```{r kable7, results='asis'}
kable7 <- Q20.3[1:100, ]
names(kable7) <- c("Institution name", "Control", "Percent of undergraduates who receive federal student loans", "Median debt at graduation")
kable(kable7, caption="Top 100 California institutions by the shares of undergraduates borrowing loans") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Data Source and Notes 

**Data source:** College Scorecard institution dataset, accessed November 2022, available through the U.S. Department of Education [here](https://collegescorecard.ed.gov/data/). 

**Timeframe reflected:** Data in the "Percent of undergraduates who received federal student loans" column reflect students enrolled in academic year 2019-20. Data in the "Median debt at graduation" reflect pooled cohorts of students who graduated in fiscal year 2019 or fiscal year 2020. 

**Notes:** Percentages rounded to nearest 0.1%. 

***

### {-}

Table 8 is the first to look at long-term debt repayment. When a student borrows, are they able to pay down the balance or do those balances rise as interest accumulates? The data in this table reflect the cohort of borrowers who entered repayment in 2008-09, and it compares the cohort's original total balance with their balance at the ten-year mark of repayment. For example, a ratio of 0.7 would mean that the current total balance is 70 percent of the original total balance. A ratio above 1 indicates that the cohort is struggling to even keep up with interest payments. 

Some colleges near the top of the list for Stafford loans are, in fact, California community colleges. The average outstanding balance 10 years into repayment is less than $15,000, but ratios about 1 indicate that this average is actually greater than the original average balance the borrowers had when they entered repayment. 

With Parent PLUS loans, the ratios for California institutions do not reach as high, but the average balances are higher. Taking La Sierra University as an example, the ratio of 0.85 and average balance of $15,000 means that, after ten years, Parent PLUS borrowers with loans from this school continue to owe \$15,000 and have only successfully paid off 15 percent of their balance. These families are likely to continue struggling to repay, especially as the parents holding these loans approach retirement age. Some of the top institutions on this list are art colleges, which may not bode well for the recipients of those loans to be able to help pay off their parents' PLUS loans. 

The table on Grad PLUS could be taken with a grain of salt since those in the medical and law fields often start with very high debt amounts and take years to build up their incomes to start repaying. However, the fact that some ratios are as high as 1.2 is concerning: this means the typical borrower owes 30 percent more after ten years than they did at the start of repayment. Four schools raise flags for high ratios and high average Grad PLUS debt amounts: Life Chiropractic College West, Southern California University of Health Sciences, American Film Institute Conservatory, and Thomas Jefferson School of Law. 

### {.tabset}
```{r DBBR10, warning=FALSE}
Q21 <- CSI %>% select(UNITID, OPEID, OPEID6, INSTNM, STABBR, CONTROL, MAIN, 
                      DBRR10_FED_UG_N, DBRR10_FED_UG_NUM, DBRR10_FED_UG_DEN, DBRR10_FED_UG_RT, 
                      DBRR10_PP_UG_N, DBRR10_PP_UG_NUM, DBRR10_PP_UG_DEN, DBRR10_PP_UG_RT,
                      DBRR10_FED_GR_N, DBRR10_FED_GR_NUM, DBRR10_FED_GR_DEN, DBRR10_FED_GR_RT) %>% filter(STABBR=="CA")
Q21 <- Q21 %>% arrange(desc(MAIN)) %>% filter(duplicated(OPEID6)==FALSE)

Q21$DBRR10_FED_UG_N <- as.numeric(Q21$DBRR10_FED_UG_N)
Q21$DBRR10_FED_UG_NUM <- as.numeric(Q21$DBRR10_FED_UG_NUM)
Q21$DBRR10_FED_UG_DEN <- as.numeric(Q21$DBRR10_FED_UG_DEN)
Q21$DBRR10_FED_UG_RT <- as.numeric(Q21$DBRR10_FED_UG_RT)

Q21$DBRR10_PP_UG_N <- as.numeric(Q21$DBRR10_PP_UG_N)
Q21$DBRR10_PP_UG_NUM <- as.numeric(Q21$DBRR10_PP_UG_NUM)
Q21$DBRR10_PP_UG_DEN <- as.numeric(Q21$DBRR10_PP_UG_DEN)
Q21$DBRR10_PP_UG_RT <- as.numeric(Q21$DBRR10_PP_UG_RT)

Q21$DBRR10_FED_GR_N <- as.numeric(Q21$DBRR10_FED_GR_N)
Q21$DBRR10_FED_GR_NUM <- as.numeric(Q21$DBRR10_FED_GR_NUM)
Q21$DBRR10_FED_GR_DEN <- as.numeric(Q21$DBRR10_FED_GR_DEN)
Q21$DBRR10_FED_GR_RT <- as.numeric(Q21$DBRR10_FED_GR_RT)

Q21.S <- Q21 %>% filter(is.na(DBRR10_FED_UG_RT)==FALSE) %>% arrange(desc(DBRR10_FED_UG_RT)) %>% filter(DBRR10_FED_UG_N >= 100) %>% select(OPEID6, INSTNM, CONTROL, DBRR10_FED_UG_RT, DBRR10_FED_UG_NUM, DBRR10_FED_UG_DEN, DBRR10_FED_UG_N)
Q21.P <- Q21 %>% filter(is.na(DBRR10_PP_UG_RT)==FALSE) %>% arrange(desc(DBRR10_PP_UG_RT)) %>% filter(DBRR10_PP_UG_N >= 100) %>% select(OPEID6, INSTNM, CONTROL, DBRR10_PP_UG_RT, DBRR10_PP_UG_NUM, DBRR10_PP_UG_DEN, DBRR10_PP_UG_N)
Q21.G <- Q21 %>% filter(is.na(DBRR10_FED_GR_RT)==FALSE) %>% arrange(desc(DBRR10_FED_GR_RT)) %>% filter(DBRR10_FED_GR_N >= 100) %>% select(OPEID6, INSTNM, CONTROL, DBRR10_FED_GR_RT, DBRR10_FED_GR_NUM, DBRR10_FED_GR_DEN, DBRR10_FED_GR_N)

names(Q21.S) <- c("OPEID6", "INSTNM", "CONTROL", "Repayment ratio", "Current balance", "Original balance", "Number of borrowers")
names(Q21.P) <- c("OPEID6", "INSTNM", "CONTROL", "Repayment ratio", "Current balance", "Original balance", "Number of borrowers")
names(Q21.G) <- c("OPEID6", "INSTNM", "CONTROL", "Repayment ratio", "Current balance", "Original balance", "Number of borrowers")

Q21.S$`Average balance after ten years in repayment` <- Q21.S$`Current balance` / Q21.S$`Number of borrowers`
Q21.P$`Average balance after ten years in repayment` <- Q21.P$`Current balance` / Q21.P$`Number of borrowers`
Q21.G$`Average balance after ten years in repayment` <- Q21.G$`Current balance` / Q21.G$`Number of borrowers`

Q21.S$`Repayment ratio` <- round(Q21.S$`Repayment ratio`, 3)
Q21.P$`Repayment ratio` <- round(Q21.P$`Repayment ratio`, 3)
Q21.G$`Repayment ratio` <- round(Q21.G$`Repayment ratio`, 3)

Q21.S$`Current balance` <- dollar(round(Q21.S$`Current balance`, -3))
Q21.P$`Current balance` <- dollar(round(Q21.P$`Current balance`, -3))
Q21.G$`Current balance` <- dollar(round(Q21.G$`Current balance`, -3))

Q21.S$`Original balance` <- dollar(round(Q21.S$`Original balance`, -3))
Q21.P$`Original balance` <- dollar(round(Q21.P$`Original balance`, -3))
Q21.G$`Original balance` <- dollar(round(Q21.G$`Original balance`, -3))

Q21.S$`Number of borrowers` <- comma(Q21.S$`Number of borrowers`)
Q21.P$`Number of borrowers` <- comma(Q21.P$`Number of borrowers`)
Q21.G$`Number of borrowers` <- comma(Q21.G$`Number of borrowers`)

Q21.S$`Average balance after ten years in repayment` <- dollar(Q21.S$`Average balance after ten years in repayment`, accuracy=1)
Q21.P$`Average balance after ten years in repayment` <- dollar(Q21.P$`Average balance after ten years in repayment`, accuracy=1)
Q21.G$`Average balance after ten years in repayment` <- dollar(Q21.G$`Average balance after ten years in repayment`, accuracy=1)
```
#### Table 8: Stafford
```{r kable8A, results='asis'}
kable8A <- Q21.S %>% select(INSTNM, CONTROL, `Repayment ratio`, `Average balance after ten years in repayment`)
names(kable8A) <- c("Institution name", "Control of institution", "Ratio of current Stafford balance to original balance, 10 years into repayment", "Average outstanding Stafford debt, 10 years into repayment")
kable(kable8A, caption="California institutions by ratio of Stafford borrowers' current balance to original balance, 10 years into repayment") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Table 8: Parent PLUS
```{r kable8B, results='asis'}
kable8B <- Q21.P %>% select(INSTNM, CONTROL, `Repayment ratio`, `Average balance after ten years in repayment`)
names(kable8B) <- c("Institution name", "Control of institution", "Ratio of current Parent PLUS balance to original balance, 10 years into repayment", "Average outstanding Parent PLUS debt, 10 years into repayment")
kable(kable8B, caption="California institutions by ratio of Parent PLUS borrowers' current balance to original balance, 10 years into repayment") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Table 8: Grad PLUS
```{r kable8C, results='asis'}
kable8C <- Q21.G %>% select(INSTNM, CONTROL, `Repayment ratio`, `Average balance after ten years in repayment`)
names(kable8C) <- c("Institution name", "Control of institution", "Ratio of current Grad PLUS balance to original balance, 10 years into repayment", "Average outstanding Grad PLUS debt, 10 years into repayment")
kable(kable8C, caption="California institutions by ratio of Grad PLUS borrowers' current balance to original balance, 10 years into repayment") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Data Source and Notes

**Data source:** College Scorecard institution dataset, accessed November 2022, available through the U.S. Department of Education [here](https://collegescorecard.ed.gov/data/). 

**Timeframe reflected:** Loan balance data in this table reflect borrowers who entered repayment in either award year 2007-08 or award year 2008-09, with outstanding debt measured 10 years after entering repayment. 

**Notes:** Ratios rounded to nearest thousandth. 

***

### {-}

Table 9 uses data on the status of borrowers three years into repayment and asks how many are in default, delinquent, or otherwise not making progress to reduce the principal of those loans. As noted above, the federal student loan payment pause and forbearance period do not affect this measure.

Here we see for-profit trade schools high on the list for Stafford loans, even though the students who attend them often have small loan amounts. At some colleges, half of all Stafford borrowers are behind on payments three years into repayment. The percentages for Parent PLUS are not as high, although some are above one-third. The colleges at the top of the list for Grad PLUS include some arts colleges and health sciences college.

### {.tabset}
```{r DDNP, warning=FALSE}

Q22.S <- CSI %>% select(UNITID, OPEID, OPEID6, INSTNM, STABBR, CONTROL, BBRR3_FED_UG_N, BBRR3_FED_UG_DFLT, BBRR3_FED_UG_DLNQ, BBRR3_FED_UG_NOPROG) %>% filter(STABBR=="CA") %>% filter(duplicated(OPEID6)==FALSE)

Q22.S$BBRR3_FED_UG_N <- as.numeric(Q22.S$BBRR3_FED_UG_N)
Q22.S <- Q22.S %>% filter(BBRR3_FED_UG_N >= 200)

conversionsDF.BBRR3_FED_UG_DFLT <- conversionsDF
conversionsDF.BBRR3_FED_UG_DLNQ <- conversionsDF
conversionsDF.BBRR3_FED_UG_NOPROG <- conversionsDF

names(conversionsDF.BBRR3_FED_UG_DFLT) <- c("BBRR3_FED_UG_DFLT", "BBRR3_FED_UG_DFLT.modified")
names(conversionsDF.BBRR3_FED_UG_DLNQ) <- c("BBRR3_FED_UG_DLNQ", "BBRR3_FED_UG_DLNQ.modified")
names(conversionsDF.BBRR3_FED_UG_NOPROG) <- c("BBRR3_FED_UG_NOPROG", "BBRR3_FED_UG_NOPROG.modified")

Q22.S <- left_join(x=Q22.S, y=conversionsDF.BBRR3_FED_UG_DFLT, by="BBRR3_FED_UG_DFLT")
Q22.S <- left_join(x=Q22.S, y=conversionsDF.BBRR3_FED_UG_DLNQ, by="BBRR3_FED_UG_DLNQ")
Q22.S <- left_join(x=Q22.S, y=conversionsDF.BBRR3_FED_UG_NOPROG, by="BBRR3_FED_UG_NOPROG")

Q22.S$`Default delinquent or not making progress` <- Q22.S$BBRR3_FED_UG_DFLT.modified + Q22.S$BBRR3_FED_UG_DLNQ.modified + Q22.S$BBRR3_FED_UG_NOPROG.modified
Q22.S <- Q22.S %>% arrange(desc(`Default delinquent or not making progress`))
Q22.S$`Default delinquent or not making progress` <- percent(Q22.S$`Default delinquent or not making progress`, accuracy=0.1)

# Now the same for Parent PLUS borrowers. 

Q22.P <- CSI %>% select(UNITID, OPEID, OPEID6, INSTNM, STABBR, CONTROL, BBRR3_PP_UG_N, BBRR3_PP_UG_DFLT, BBRR3_PP_UG_DLNQ, BBRR3_PP_UG_NOPROG) %>% filter(STABBR=="CA") %>% filter(duplicated(OPEID6)==FALSE)

Q22.P$BBRR3_PP_UG_N <- as.numeric(Q22.P$BBRR3_PP_UG_N)
Q22.P <- Q22.P %>% filter(BBRR3_PP_UG_N >= 200)

conversionsDF.BBRR3_PP_UG_DFLT <- conversionsDF
conversionsDF.BBRR3_PP_UG_DLNQ <- conversionsDF
conversionsDF.BBRR3_PP_UG_NOPROG <- conversionsDF

names(conversionsDF.BBRR3_PP_UG_DFLT) <- c("BBRR3_PP_UG_DFLT", "BBRR3_PP_UG_DFLT.modified")
names(conversionsDF.BBRR3_PP_UG_DLNQ) <- c("BBRR3_PP_UG_DLNQ", "BBRR3_PP_UG_DLNQ.modified")
names(conversionsDF.BBRR3_PP_UG_NOPROG) <- c("BBRR3_PP_UG_NOPROG", "BBRR3_PP_UG_NOPROG.modified")

Q22.P <- left_join(x=Q22.P, y=conversionsDF.BBRR3_PP_UG_DFLT, by="BBRR3_PP_UG_DFLT")
Q22.P <- left_join(x=Q22.P, y=conversionsDF.BBRR3_PP_UG_DLNQ, by="BBRR3_PP_UG_DLNQ")
Q22.P <- left_join(x=Q22.P, y=conversionsDF.BBRR3_PP_UG_NOPROG, by="BBRR3_PP_UG_NOPROG")

Q22.P$`Default delinquent or not making progress` <- Q22.P$BBRR3_PP_UG_DFLT.modified + Q22.P$BBRR3_PP_UG_DLNQ.modified + Q22.P$BBRR3_PP_UG_NOPROG.modified
Q22.P <- Q22.P %>% arrange(desc(`Default delinquent or not making progress`))
Q22.P$`Default delinquent or not making progress` <- percent(Q22.P$`Default delinquent or not making progress`, accuracy=0.1)

# Now the same for graduate borrowers. 

Q22.G <- CSI %>% select(UNITID, OPEID, OPEID6, INSTNM, STABBR, CONTROL, BBRR3_FED_GR_N, BBRR3_FED_GR_DFLT, BBRR3_FED_GR_DLNQ, BBRR3_FED_GR_NOPROG) %>% filter(STABBR=="CA") %>% filter(duplicated(OPEID6)==FALSE)

Q22.G$BBRR3_FED_GR_N <- as.numeric(Q22.G$BBRR3_FED_GR_N)
Q22.G <- Q22.G %>% filter(BBRR3_FED_GR_N >= 200)

conversionsDF.BBRR3_FED_GR_DFLT <- conversionsDF
conversionsDF.BBRR3_FED_GR_DLNQ <- conversionsDF
conversionsDF.BBRR3_FED_GR_NOPROG <- conversionsDF

names(conversionsDF.BBRR3_FED_GR_DFLT) <- c("BBRR3_FED_GR_DFLT", "BBRR3_FED_GR_DFLT.modified")
names(conversionsDF.BBRR3_FED_GR_DLNQ) <- c("BBRR3_FED_GR_DLNQ", "BBRR3_FED_GR_DLNQ.modified")
names(conversionsDF.BBRR3_FED_GR_NOPROG) <- c("BBRR3_FED_GR_NOPROG", "BBRR3_FED_GR_NOPROG.modified")

Q22.G <- left_join(x=Q22.G, y=conversionsDF.BBRR3_FED_GR_DFLT, by="BBRR3_FED_GR_DFLT")
Q22.G <- left_join(x=Q22.G, y=conversionsDF.BBRR3_FED_GR_DLNQ, by="BBRR3_FED_GR_DLNQ")
Q22.G <- left_join(x=Q22.G, y=conversionsDF.BBRR3_FED_GR_NOPROG, by="BBRR3_FED_GR_NOPROG")

Q22.G$`Default delinquent or not making progress` <- Q22.G$BBRR3_FED_GR_DFLT.modified + Q22.G$BBRR3_FED_GR_DLNQ.modified + Q22.G$BBRR3_FED_GR_NOPROG.modified
Q22.G <- Q22.G %>% arrange(desc(`Default delinquent or not making progress`))
Q22.G$`Default delinquent or not making progress` <- percent(Q22.G$`Default delinquent or not making progress`, accuracy=0.1)

```
#### Table 9: Stafford
```{r kable9A, results='asis'}
kable9A <- Q22.S %>% select(INSTNM, CONTROL, `Default delinquent or not making progress`)
names(kable9A) <- c("Institution name", "Control of institution", "Estimated share of Stafford borrowers who are in default, delinquent, or not making progress three years into repayment")
kable(kable9A, caption="California institutions by share of Stafford borrowers who are in default, delinquent, or not making progress three years into repayment") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Table 9: Parent PLUS
```{r kable9B, results='asis'}
kable9B <- Q22.P %>% select(INSTNM, CONTROL, `Default delinquent or not making progress`)
names(kable9B) <- c("Institution name", "Control of institution", "Estimated share of Parent PLUS borrowers who are in default, delinquent, or not making progress three years into repayment")
kable(kable9B, caption="California institutions by share of Parent PLUS borrowers who are in default, delinquent, or not making progress three years into repayment") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Table 9: Grad PLUS
```{r kable9C, results='asis'}
kable9C <- Q22.G %>% select(INSTNM, CONTROL, `Default delinquent or not making progress`)
names(kable9C) <- c("Institution name", "Control of institution", "Estimated share of Grad PLUS borrowers who are in default, delinquent, or not making progress three years into repayment")
kable(kable9C, caption="California institutions by share of Grad PLUS borrowers who are in default, delinquent, or not making progress three years into repayment") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Data Source and Notes

**Data source:** College Scorecard institution dataset, accessed November 2022, available through the U.S. Department of Education [here](https://collegescorecard.ed.gov/data/). 

**Timeframe reflected:** Borrower status data reflect borrowers who entered repayment in award year 2015-16 or 2016-17, at the time when the borrower had been in repayment for three years. 

**Notes:** I applied a threshold of minimum 200 borrowers per institution in the ten-year repayment cohort. This does not include those in forbearance or deferment. Percentages rounded to nearest 0.1%. 

***

### {-}

With Table 10, we now turn to program-level data. The College Scorecard provides debt and earnings data using an index called the Classification of Instructional Programs (CIP). CIP codes identify college programs so that when we talk about earth science programs or biostatistics programs, for example, we have a foundational basis for what programs those are. There are three levels of CIP codes with varying specificity, and the Scorecard program-level data are reported at the 4-digit CIP code level. 

For this analysis, I aggregated debt and earnings data by area of study and credential level using programs at institutions located in California. I use median earnings 1 year after graduation. While Scorecard also reports earnings at the 2 year mark after graduation, breakouts by Pell are only available at 1 year. The first tab of Table 10 reflects all borrowers and the second tab reflects borrowers who received Pell at some point in their educational careers (not necessarily for the same program). 

I use the ratio of debt to earnings as a barometer for how high debt is compared to earnings, an indication of how the borrower may struggle with repayment. Six of the seven programs with the highest ratios are in medicine, perhaps to little surprise. However, master's degree programs in film/video and drama/theater are also in the top ten, and these borrowers see starting salaries of \$30,000 or less alongside median debts above \$100,000. 

The top programs for this debt-to-earnings ratio among Pell recipients largely match the list for all borrowers. The median debt levels appear slightly higher for Pell recipients, pointing to the role that family resources likely play in financing education. 

In the first tab, the first undergraduate program does not appear until 33 rows down (Bachelor's in Arts, Entertainment, and Media Management). This is one indication of how unmanageable student loan debt can be a particularly significant issue for borrowers from graduate programs in California. 

### {.tabset}
```{r DebtVsEarningsCIPs}
Q24 <- CSP %>% select(
  UNITID,       # Unit ID for institution
  OPEID6,       # 6-digit OPE ID for institution
  INSTNM,       # Institution name
  STABBR,       # Institution state
  MAIN,         # Flag for main campus
  CONTROL,      # Control of institution
  CIPCODE,      # Classification of Instructional Programs (CIP) code for the field of study
  CIPDESC,      # Text description of the field of study CIP Code
  CREDLEV,      # Level of credential
  CREDDESC,     # Text description of the level of credential
  DEBT_ALL_STGP_EVAL_N,          # Borrower count for average/median Stafford and Grad PLUS loan debt disbursed at this institution
  DEBT_ALL_STGP_EVAL_MDN,        # Median Stafford and Grad PLUS loan debt disbursed at this institution
  EARN_MDN_HI_1YR,               # Median earnings of graduates working and not enrolled 1 year after completing highest credential
  EARN_COUNT_WNE_HI_1YR          # Number of graduates working and not enrolled 1 year after completing highest credential	
) %>% filter(STABBR=="CA") %>% arrange(desc(MAIN))

Q24 <- Q24 %>% filter(DEBT_ALL_STGP_EVAL_N != "PrivacySuppressed") 
Q24 <- Q24 %>% filter(DEBT_ALL_STGP_EVAL_MDN != "PrivacySuppressed")
Q24 <- Q24 %>% filter(EARN_MDN_HI_1YR != "PrivacySuppressed") 
Q24 <- Q24 %>% filter(EARN_COUNT_WNE_HI_1YR != "PrivacySuppressed")

Q24$`Unique combination of OPEID, CIP, and CREDLEV` <- paste(Q24$OPEID6, Q24$CIPCODE, Q24$CREDLEV, sep="+")
Q24 <- Q24 %>% filter(duplicated(`Unique combination of OPEID, CIP, and CREDLEV`)==FALSE)

Q24$DEBT_ALL_STGP_EVAL_N <- as.numeric(Q24$DEBT_ALL_STGP_EVAL_N)
Q24$DEBT_ALL_STGP_EVAL_MDN <- as.numeric(Q24$DEBT_ALL_STGP_EVAL_MDN)
Q24$EARN_MDN_HI_1YR <- as.numeric(Q24$EARN_MDN_HI_1YR)
Q24$EARN_COUNT_WNE_HI_1YR <- as.numeric(Q24$EARN_COUNT_WNE_HI_1YR)

Q24.1 <- aggregate(data=Q24, cbind(DEBT_ALL_STGP_EVAL_N, EARN_COUNT_WNE_HI_1YR) ~ CIPDESC + CREDDESC, FUN=sum)
names(Q24.1) <- c("CIPDESC", "CREDDESC", "Total borrower count", "Total earner count")
Q24 <- left_join(x=Q24, y=Q24.1, by=c("CIPDESC", "CREDDESC"))

Q24$`Share of all borrowers` <- Q24$DEBT_ALL_STGP_EVAL_N / Q24$`Total borrower count`
Q24$`Weighted debt median` <- Q24$`Share of all borrowers` * Q24$DEBT_ALL_STGP_EVAL_MDN

Q24$`Share of all earners` <- Q24$EARN_COUNT_WNE_HI_1YR / Q24$`Total earner count`
Q24$`Weighted earnings median` <- Q24$`Share of all earners` * Q24$EARN_MDN_HI_1YR

Q24.2 <- aggregate(data=Q24, cbind(`Weighted debt median`, `Weighted earnings median`) ~ CIPDESC + CREDDESC, FUN=sum)
Q24.2$`Ratio of debt to earnings` <- Q24.2$`Weighted debt median` / Q24.2$`Weighted earnings median`

Q24.2 <- Q24.2 %>% arrange(desc(`Ratio of debt to earnings`))
Q24.2$`Weighted debt median` <- dollar(Q24.2$`Weighted debt median`, accuracy=1)
Q24.2$`Weighted earnings median` <- dollar(Q24.2$`Weighted earnings median`, accuracy=1)
Q24.2$`Ratio of debt to earnings` <- round(Q24.2$`Ratio of debt to earnings`, 2)
```
#### Table 10: Debt vs earnings for student loan borrowers 
```{r kable10A}
kable10A <- Q24.2 %>% select(CIPDESC, CREDDESC, `Weighted debt median`, `Weighted earnings median`, `Ratio of debt to earnings`)
names(kable10A) <- c("Area of study", "Credential level", "Estimated median debt", "Estimated median earnings, 1 year after completing program", "Ratio of debt to earnings")
kable(kable10A, caption="4-digit CIPs and award levels by debt compared to earnings in California") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Table 10: Debt vs earnings for for student loan borrowers who received Pell 
```{r DebtVsEarningsPell}
Q25 <- CSP %>% select(
  UNITID,       # Unit ID for institution
  OPEID6,       # 6-digit OPE ID for institution
  INSTNM,       # Institution name
  STABBR,       # Institution state
  MAIN,         # Flag for main campus
  CONTROL,      # Control of institution
  CIPCODE,      # Classification of Instructional Programs (CIP) code for the field of study
  CIPDESC,      # Text description of the field of study CIP Code
  CREDLEV,      # Level of credential
  CREDDESC,     # Text description of the level of credential
  DEBT_PELL_STGP_EVAL_N,         # Borrower count for average/median Stafford and Grad PLUS loan debt disbursed to Pell recipients at this institution
  DEBT_PELL_STGP_EVAL_MDN,       # Median Stafford and Grad PLUS loan debt disbursed to Pell recipients at this institution
  EARN_PELL_WNE_MDN_1YR,         # Median earnings of graduates who received a Pell Grant and were working and not enrolled 1 year after completing highest credential
  EARN_COUNT_PELL_WNE_1YR        # Number of graduates who received a Pell Grant and were working and not enrolled 1 year after completing highest credential
) %>% filter(STABBR=="CA")

Q25 <- Q25 %>% filter(DEBT_PELL_STGP_EVAL_N != "PrivacySuppressed") 
Q25 <- Q25 %>% filter(DEBT_PELL_STGP_EVAL_MDN != "PrivacySuppressed")
Q25 <- Q25 %>% filter(EARN_PELL_WNE_MDN_1YR != "PrivacySuppressed") 
Q25 <- Q25 %>% filter(EARN_COUNT_PELL_WNE_1YR != "PrivacySuppressed")

Q25$`Unique combination of OPEID, CIP, and CREDLEV` <- paste(Q25$OPEID6, Q25$CIPCODE, Q25$CREDLEV, sep="+")
Q25 <- Q25 %>% filter(duplicated(`Unique combination of OPEID, CIP, and CREDLEV`)==FALSE)

Q25$DEBT_PELL_STGP_EVAL_N <- as.numeric(Q25$DEBT_PELL_STGP_EVAL_N)
Q25$DEBT_PELL_STGP_EVAL_MDN <- as.numeric(Q25$DEBT_PELL_STGP_EVAL_MDN)
Q25$EARN_PELL_WNE_MDN_1YR <- as.numeric(Q25$EARN_PELL_WNE_MDN_1YR)
Q25$EARN_COUNT_PELL_WNE_1YR <- as.numeric(Q25$EARN_COUNT_PELL_WNE_1YR)

Q25.1 <- aggregate(data=Q25, cbind(DEBT_PELL_STGP_EVAL_N, EARN_COUNT_PELL_WNE_1YR) ~ CIPDESC + CREDDESC, FUN=sum)
names(Q25.1) <- c("CIPDESC", "CREDDESC", "Total borrower count", "Total earner count")
Q25 <- left_join(x=Q25, y=Q25.1, by=c("CIPDESC", "CREDDESC"))

Q25$`Share of all borrowers` <- Q25$DEBT_PELL_STGP_EVAL_N / Q25$`Total borrower count`
Q25$`Weighted debt median` <- Q25$`Share of all borrowers` * Q25$DEBT_PELL_STGP_EVAL_MDN

Q25$`Share of all earners` <- Q25$EARN_COUNT_PELL_WNE_1YR / Q25$`Total earner count`
Q25$`Weighted earnings median` <- Q25$`Share of all earners` * Q25$EARN_PELL_WNE_MDN_1YR

Q25.2 <- aggregate(data=Q25, cbind(`Weighted debt median`, `Weighted earnings median`) ~ CIPDESC + CREDDESC, FUN=sum)
Q25.2$`Ratio of debt to earnings` <- Q25.2$`Weighted debt median` / Q25.2$`Weighted earnings median`

Q25.2 <- Q25.2 %>% arrange(desc(`Ratio of debt to earnings`))
Q25.2$`Weighted debt median` <- dollar(Q25.2$`Weighted debt median`, accuracy=1)
Q25.2$`Weighted earnings median` <- dollar(Q25.2$`Weighted earnings median`, accuracy=1)
Q25.2$`Ratio of debt to earnings` <- round(Q25.2$`Ratio of debt to earnings`, 2)
```

```{r kable10B}
kable10B <- Q25.2 %>% select(CIPDESC, CREDDESC, `Weighted debt median`, `Weighted earnings median`, `Ratio of debt to earnings`)
names(kable10B) <- c("Area of study", "Credential level", "Estimated median debt for Pell recipients", "Estimated median earnings for Pell recipeints, 1 year after completing program", "Ratio of debt to earnings for Pell recipients")
kable(kable10B, caption="4-digit CIPs and award levels by debt compared to earnings in California") %>% kable_paper("hover", full_width = F) %>% scroll_box(width = "100%", height = "400px")
```
#### Data Source and Notes 

**Data source:** College Scorecard field-of-study dataset, accessed November 2022, available through the U.S. Department of Education [here](https://collegescorecard.ed.gov/data/). 

**Timeframe reflected:** Data in the "Estimated median debt" column are author's calculations using data reflecting borrowers who entered repayment in award year 2017-18 or 2018-19. Data in the "Estimated median earnings, 1 year after completing program" column are author's calculations using data reflecting the calendar year 2018 or 2019 earnings of students who received federal student aid and graduated from their program in academic year 2016-17 or 2017-18. Earnings data were adjusted by the Department of Education to 2020 dollars. 

**Notes:** Ratios rounded to nearest thousandth. 

***

### {-}


Next, we will use College Scorecard data to show how federal student loan repayment in California compares to the rest of the U.S. 

First, I examine dollar-based repayment rates, or "DBRR." DBRR data in the College Scorecard measure the total current loan balances for cohorts of federal student loan borrowers, as well as the original amount that the cohort collectively owed when they entered repayment. I use data for cohorts that are 1, 5, 10, and 20 years into repayment. 

We can calculate a cohort's "DBRR ratio" by dividing its current total balance by its original total balance. When the ratio is over 1, the borrowers owe more than they originally borrowed, presumably due to the accumulation of interest outpacing the borrowers' payments. When the ratio is under 1, the borrowers are making forward progress on repayment. 

A few data notes may be useful when interpreting Figures 36 and 37: 

* These data reflect pre-pandemic balances. 
* DBRR does not track the same cohort of borrowers and report their loan balances at 1, 5, 10, and 20 years. Rather, each of these cohorts is a separate group of borrowers.
* Not all colleges and universities have DBRR data in the College Scorecard. In Figures 36 and 37, you can hover over the points in the chart to see the count of institution represented in each cohort.  

In the College Scorecard, DBRR data are reported at the institution level and disaggregated by loan type (Stafford, Parent PLUS, and Grad PLUS). I aggregated the DBRR values across all institutions with sufficient data and compared institutions in California to institutions in the rest of the U.S., with breakouts by institutional control and loan type. 

Figure 36 shows the DBRR ratios for four cohorts of borrowers in repayment. When the blue line (California) is higher than the yellow line (Rest of U.S.), it means that borrowers from California institutions owe a larger share of their original balance than do those from institutions across the rest of the U.S. 

In all three tabs, we see that loan borrowers from California public institutions tend to have better (i.e. lower) DBRR ratios than loan borrowers from public institutions in the rest of the country, regardless of loan type. In the DBRR ratios for borrowers who took out loans for a nonprofit or for-profit institution, California institutions roughly match institutions nationwide. 

### {.tabset}
```{r CSI.DBRR, warning=FALSE}
CSI2 <- fread("Most-Recent-Cohorts-Institution.csv", header=TRUE, select=c(
  
  # Basic information about institutions: 
  "UNITID",       # Unit ID for institution
  "OPEID",        # 8-digit OPEID
  "OPEID6",       # 6-digit OPEID
  "INSTNM",       # Institution name
  "CITY",         # City
  "STABBR",       # State postcode
  "MAIN",         # "Flag for main campus (0 Not main campus, 1 Main campus)
  "PREDDEG",      # Predominant undergraduate degree awarded
  "CONTROL",      # Control of institution
  "CCBASIC",      # Carnegie Classification -- basic
  
  # DBRR 1-year repayment rates: Undergraduate loans
  "DBRR1_FED_UG_N",   # Undergraduate federal student loan dollar-based 1-year repayment rate borrower count
  "DBRR1_FED_UG_NUM", # Undergraduate federal student loan dollar-based 1-year repayment rate numerator
  "DBRR1_FED_UG_DEN", # Undergraduate federal student loan dollar-based 1-year repayment rate denominator
  "DBRR1_FED_UG_RT",  # Undergraduate federal student loan dollar-based 1-year repayment rate
  
  # DBRR 1-year repayment rates: Graduate loans
  "DBRR1_FED_GR_N",   # Graduate federal student loan dollar-based 1-year repayment rate borrower count
  "DBRR1_FED_GR_NUM", # Graduate federal student loan dollar-based 1-year repayment rate numerator
  "DBRR1_FED_GR_DEN", # Graduate federal student loan dollar-based 1-year repayment rate denominator
  "DBRR1_FED_GR_RT",  # Graduate federal student loan dollar-based 1-year repayment rate
  
  # DBRR 1-year repayment rates: Parent PLUS loans
  "DBRR1_PP_UG_N",    # Undergraduate Parent PLUS Loan dollar-based 1-year repayment rate borrower count
  "DBRR1_PP_UG_NUM",  # Undergraduate Parent PLUS Loan dollar-based 1-year repayment rate numerator
  "DBRR1_PP_UG_DEN",  # Undergraduate Parent PLUS Loan dollar-based 1-year repayment rate denominator
  "DBRR1_PP_UG_RT",   # Undergraduate Parent PLUS Loan dollar-based 1-year repayment rate
  
  # DBRR 4-year repayment rates: Undergraduate loans
  "DBRR4_FED_UG_N",   # Undergraduate federal student loan dollar-based 4-year repayment rate borrower count
  "DBRR4_FED_UG_NUM", # Undergraduate federal student loan dollar-based 4-year repayment rate numerator
  "DBRR4_FED_UG_DEN", # Undergraduate federal student loan dollar-based 4-year repayment rate denominator
  "DBRR4_FED_UG_RT",  # Undergraduate federal student loan dollar-based 4-year repayment rate
  
  # DBRR 4-year repayment rates: Graduate loans
  "DBRR4_FED_GR_N",   # Graduate federal student loan dollar-based 4-year repayment rate borrower count
  "DBRR4_FED_GR_NUM", # Graduate federal student loan dollar-based 4-year repayment rate numerator
  "DBRR4_FED_GR_DEN", # Graduate federal student loan dollar-based 4-year repayment rate denominator
  "DBRR4_FED_GR_RT",  # Graduate federal student loan dollar-based 4-year repayment rate
  
  # DBRR 4-year repayment rates: Parent PLUS loans
  "DBRR4_PP_UG_N",    # Undergraduate Parent PLUS Loan dollar-based 4-year repayment rate borrower count
  "DBRR4_PP_UG_NUM",  # Undergraduate Parent PLUS Loan dollar-based 4-year repayment rate numerator
  "DBRR4_PP_UG_DEN",  # Undergraduate Parent PLUS Loan dollar-based 4-year repayment rate denominator
  "DBRR4_PP_UG_RT",   # Undergraduate Parent PLUS Loan dollar-based 4-year repayment rate

  # DBRR 5-year repayment rates: Undergraduate loans
  "DBRR5_FED_UG_N",   # Undergraduate federal student loan dollar-based 5-year repayment rate borrower count
  "DBRR5_FED_UG_NUM", # Undergraduate federal student loan dollar-based 5-year repayment rate numerator
  "DBRR5_FED_UG_DEN", # Undergraduate federal student loan dollar-based 5-year repayment rate denominator
  "DBRR5_FED_UG_RT",  # Undergraduate federal student loan dollar-based 5-year repayment rate
  
  # DBRR 5-year repayment rates: Graduate loans
  "DBRR5_FED_GR_N",   # Graduate federal student loan dollar-based 5-year repayment rate borrower count
  "DBRR5_FED_GR_NUM", # Graduate federal student loan dollar-based 5-year repayment rate numerator
  "DBRR5_FED_GR_DEN", # Graduate federal student loan dollar-based 5-year repayment rate denominator
  "DBRR5_FED_GR_RT",  # Graduate federal student loan dollar-based 5-year repayment rate
  
  # DBRR 5-year repayment rates: Parent PLUS loans
  "DBRR5_PP_UG_N",    # Undergraduate Parent PLUS Loan dollar-based 5-year repayment rate borrower count
  "DBRR5_PP_UG_NUM",  # Undergraduate Parent PLUS Loan dollar-based 5-year repayment rate numerator
  "DBRR5_PP_UG_DEN",  # Undergraduate Parent PLUS Loan dollar-based 5-year repayment rate denominator
  "DBRR5_PP_UG_RT",   # Undergraduate Parent PLUS Loan dollar-based 5-year repayment rate
  
  # DBRR 10-year repayment rates: Undergraduate loans
  "DBRR10_FED_UG_N",   # Undergraduate federal student loan dollar-based 10-year repayment rate borrower count
  "DBRR10_FED_UG_NUM", # Undergraduate federal student loan dollar-based 10-year repayment rate numerator
  "DBRR10_FED_UG_DEN", # Undergraduate federal student loan dollar-based 10-year repayment rate denominator
  "DBRR10_FED_UG_RT",  # Undergraduate federal student loan dollar-based 10-year repayment rate
  
  # DBRR 10-year repayment rates: Graduate loans
  "DBRR10_FED_GR_N",   # Graduate federal student loan dollar-based 10-year repayment rate borrower count
  "DBRR10_FED_GR_NUM", # Graduate federal student loan dollar-based 10-year repayment rate numerator
  "DBRR10_FED_GR_DEN", # Graduate federal student loan dollar-based 10-year repayment rate denominator
  "DBRR10_FED_GR_RT",  # Graduate federal student loan dollar-based 10-year repayment rate
  
  # DBRR 10-year repayment rates: Parent PLUS loans
  "DBRR10_PP_UG_N",    # Undergraduate Parent PLUS Loan dollar-based 10-year repayment rate borrower count
  "DBRR10_PP_UG_NUM",  # Undergraduate Parent PLUS Loan dollar-based 10-year repayment rate numerator
  "DBRR10_PP_UG_DEN",  # Undergraduate Parent PLUS Loan dollar-based 10-year repayment rate denominator
  "DBRR10_PP_UG_RT",   # Undergraduate Parent PLUS Loan dollar-based 10-year repayment rate
  
  # DBRR 20-year repayment rates: Undergraduate loans
  "DBRR20_FED_UG_N",   # Undergraduate federal student loan dollar-based 20-year repayment rate borrower count
  "DBRR20_FED_UG_NUM", # Undergraduate federal student loan dollar-based 20-year repayment rate numerator
  "DBRR20_FED_UG_DEN", # Undergraduate federal student loan dollar-based 20-year repayment rate denominator
  "DBRR20_FED_UG_RT",  # Undergraduate federal student loan dollar-based 20-year repayment rate
  
  # DBRR 20-year repayment rates: Graduate loans
  "DBRR20_FED_GR_N",   # Graduate federal student loan dollar-based 20-year repayment rate borrower count
  "DBRR20_FED_GR_NUM", # Graduate federal student loan dollar-based 20-year repayment rate numerator
  "DBRR20_FED_GR_DEN", # Graduate federal student loan dollar-based 20-year repayment rate denominator
  "DBRR20_FED_GR_RT",  # Graduate federal student loan dollar-based 20-year repayment rate
  
  # DBRR 20-year repayment rates: Parent PLUS loans
  "DBRR20_PP_UG_N",    # Undergraduate Parent PLUS Loan dollar-based 20-year repayment rate borrower count
  "DBRR20_PP_UG_NUM",  # Undergraduate Parent PLUS Loan dollar-based 20-year repayment rate numerator
  "DBRR20_PP_UG_DEN",  # Undergraduate Parent PLUS Loan dollar-based 20-year repayment rate denominator
  "DBRR20_PP_UG_RT"    # Undergraduate Parent PLUS Loan dollar-based 20-year repayment rate
  ))

CSI2$DBRR1_FED_UG_N   <- as.numeric(CSI2$DBRR1_FED_UG_N)
CSI2$DBRR1_FED_UG_NUM <- as.numeric(CSI2$DBRR1_FED_UG_NUM)
CSI2$DBRR1_FED_UG_DEN <- as.numeric(CSI2$DBRR1_FED_UG_DEN)
CSI2$DBRR1_FED_UG_RT  <- as.numeric(CSI2$DBRR1_FED_UG_RT)
CSI2$DBRR1_FED_GR_N   <- as.numeric(CSI2$DBRR1_FED_GR_N)
CSI2$DBRR1_FED_GR_NUM <- as.numeric(CSI2$DBRR1_FED_GR_NUM)
CSI2$DBRR1_FED_GR_DEN <- as.numeric(CSI2$DBRR1_FED_GR_DEN)
CSI2$DBRR1_FED_GR_RT  <- as.numeric(CSI2$DBRR1_FED_GR_RT)
CSI2$DBRR1_PP_UG_N    <- as.numeric(CSI2$DBRR1_PP_UG_N)
CSI2$DBRR1_PP_UG_NUM  <- as.numeric(CSI2$DBRR1_PP_UG_NUM)
CSI2$DBRR1_PP_UG_DEN  <- as.numeric(CSI2$DBRR1_PP_UG_DEN)
CSI2$DBRR1_PP_UG_RT   <- as.numeric(CSI2$DBRR1_PP_UG_RT)
CSI2$DBRR4_FED_UG_N   <- as.numeric(CSI2$DBRR4_FED_UG_N)
CSI2$DBRR4_FED_UG_NUM <- as.numeric(CSI2$DBRR4_FED_UG_NUM)
CSI2$DBRR4_FED_UG_DEN <- as.numeric(CSI2$DBRR4_FED_UG_DEN)
CSI2$DBRR4_FED_UG_RT  <- as.numeric(CSI2$DBRR4_FED_UG_RT)
CSI2$DBRR4_FED_GR_N   <- as.numeric(CSI2$DBRR4_FED_GR_N)
CSI2$DBRR4_FED_GR_NUM <- as.numeric(CSI2$DBRR4_FED_GR_NUM)
CSI2$DBRR4_FED_GR_DEN <- as.numeric(CSI2$DBRR4_FED_GR_DEN)
CSI2$DBRR4_FED_GR_RT  <- as.numeric(CSI2$DBRR4_FED_GR_RT)
CSI2$DBRR4_PP_UG_N    <- as.numeric(CSI2$DBRR4_PP_UG_N)
CSI2$DBRR4_PP_UG_NUM  <- as.numeric(CSI2$DBRR4_PP_UG_NUM)
CSI2$DBRR4_PP_UG_DEN  <- as.numeric(CSI2$DBRR4_PP_UG_DEN)
CSI2$DBRR4_PP_UG_RT   <- as.numeric(CSI2$DBRR4_PP_UG_RT)
CSI2$DBRR5_FED_UG_N   <- as.numeric(CSI2$DBRR5_FED_UG_N)
CSI2$DBRR5_FED_UG_NUM <- as.numeric(CSI2$DBRR5_FED_UG_NUM)
CSI2$DBRR5_FED_UG_DEN <- as.numeric(CSI2$DBRR5_FED_UG_DEN)
CSI2$DBRR5_FED_UG_RT  <- as.numeric(CSI2$DBRR5_FED_UG_RT)
CSI2$DBRR5_FED_GR_N   <- as.numeric(CSI2$DBRR5_FED_GR_N)
CSI2$DBRR5_FED_GR_NUM <- as.numeric(CSI2$DBRR5_FED_GR_NUM)
CSI2$DBRR5_FED_GR_DEN <- as.numeric(CSI2$DBRR5_FED_GR_DEN)
CSI2$DBRR5_FED_GR_RT  <- as.numeric(CSI2$DBRR5_FED_GR_RT)
CSI2$DBRR5_PP_UG_N    <- as.numeric(CSI2$DBRR5_PP_UG_N)
CSI2$DBRR5_PP_UG_NUM  <- as.numeric(CSI2$DBRR5_PP_UG_NUM)
CSI2$DBRR5_PP_UG_DEN  <- as.numeric(CSI2$DBRR5_PP_UG_DEN)
CSI2$DBRR5_PP_UG_RT   <- as.numeric(CSI2$DBRR5_PP_UG_RT)
CSI2$DBRR10_FED_UG_N   <- as.numeric(CSI2$DBRR10_FED_UG_N)
CSI2$DBRR10_FED_UG_NUM <- as.numeric(CSI2$DBRR10_FED_UG_NUM)
CSI2$DBRR10_FED_UG_DEN <- as.numeric(CSI2$DBRR10_FED_UG_DEN)
CSI2$DBRR10_FED_UG_RT  <- as.numeric(CSI2$DBRR10_FED_UG_RT)
CSI2$DBRR10_FED_GR_N   <- as.numeric(CSI2$DBRR10_FED_GR_N)
CSI2$DBRR10_FED_GR_NUM <- as.numeric(CSI2$DBRR10_FED_GR_NUM)
CSI2$DBRR10_FED_GR_DEN <- as.numeric(CSI2$DBRR10_FED_GR_DEN)
CSI2$DBRR10_FED_GR_RT  <- as.numeric(CSI2$DBRR10_FED_GR_RT)
CSI2$DBRR10_PP_UG_N    <- as.numeric(CSI2$DBRR10_PP_UG_N)
CSI2$DBRR10_PP_UG_NUM  <- as.numeric(CSI2$DBRR10_PP_UG_NUM)
CSI2$DBRR10_PP_UG_DEN  <- as.numeric(CSI2$DBRR10_PP_UG_DEN)
CSI2$DBRR10_PP_UG_RT   <- as.numeric(CSI2$DBRR10_PP_UG_RT)
CSI2$DBRR20_FED_UG_N   <- as.numeric(CSI2$DBRR20_FED_UG_N)
CSI2$DBRR20_FED_UG_NUM <- as.numeric(CSI2$DBRR20_FED_UG_NUM)
CSI2$DBRR20_FED_UG_DEN <- as.numeric(CSI2$DBRR20_FED_UG_DEN)
CSI2$DBRR20_FED_UG_RT  <- as.numeric(CSI2$DBRR20_FED_UG_RT)
CSI2$DBRR20_FED_GR_N   <- as.numeric(CSI2$DBRR20_FED_GR_N)
CSI2$DBRR20_FED_GR_NUM <- as.numeric(CSI2$DBRR20_FED_GR_NUM)
CSI2$DBRR20_FED_GR_DEN <- as.numeric(CSI2$DBRR20_FED_GR_DEN)
CSI2$DBRR20_FED_GR_RT  <- as.numeric(CSI2$DBRR20_FED_GR_RT)
CSI2$DBRR20_PP_UG_N    <- as.numeric(CSI2$DBRR20_PP_UG_N)
CSI2$DBRR20_PP_UG_NUM  <- as.numeric(CSI2$DBRR20_PP_UG_NUM)
CSI2$DBRR20_PP_UG_DEN  <- as.numeric(CSI2$DBRR20_PP_UG_DEN)
CSI2$DBRR20_PP_UG_RT   <- as.numeric(CSI2$DBRR20_PP_UG_RT)

CSI2$DBRR1_FED_UG_N[is.na(CSI2$DBRR1_FED_UG_N)] <- 0
CSI2$DBRR1_FED_UG_NUM[is.na(CSI2$DBRR1_FED_UG_NUM)] <- 0
CSI2$DBRR1_FED_UG_DEN[is.na(CSI2$DBRR1_FED_UG_DEN)] <- 0
CSI2$DBRR1_FED_UG_RT[is.na(CSI2$DBRR1_FED_UG_RT)] <- 0
CSI2$DBRR1_FED_GR_N[is.na(CSI2$DBRR1_FED_GR_N)] <- 0
CSI2$DBRR1_FED_GR_NUM[is.na(CSI2$DBRR1_FED_GR_NUM)] <- 0
CSI2$DBRR1_FED_GR_DEN[is.na(CSI2$DBRR1_FED_GR_DEN)] <- 0
CSI2$DBRR1_FED_GR_RT[is.na(CSI2$DBRR1_FED_GR_RT)] <- 0
CSI2$DBRR1_PP_UG_N[is.na(CSI2$DBRR1_PP_UG_N)] <- 0
CSI2$DBRR1_PP_UG_NUM[is.na(CSI2$DBRR1_PP_UG_NUM)] <- 0
CSI2$DBRR1_PP_UG_DEN[is.na(CSI2$DBRR1_PP_UG_DEN)] <- 0
CSI2$DBRR1_PP_UG_RT[is.na(CSI2$DBRR1_PP_UG_RT)] <- 0
CSI2$DBRR4_FED_UG_N[is.na(CSI2$DBRR4_FED_UG_N)] <- 0
CSI2$DBRR4_FED_UG_NUM[is.na(CSI2$DBRR4_FED_UG_NUM)] <- 0
CSI2$DBRR4_FED_UG_DEN[is.na(CSI2$DBRR4_FED_UG_DEN)] <- 0
CSI2$DBRR4_FED_UG_RT[is.na(CSI2$DBRR4_FED_UG_RT)] <- 0
CSI2$DBRR4_FED_GR_N[is.na(CSI2$DBRR4_FED_GR_N)] <- 0
CSI2$DBRR4_FED_GR_NUM[is.na(CSI2$DBRR4_FED_GR_NUM)] <- 0
CSI2$DBRR4_FED_GR_DEN[is.na(CSI2$DBRR4_FED_GR_DEN)] <- 0
CSI2$DBRR4_FED_GR_RT[is.na(CSI2$DBRR4_FED_GR_RT)] <- 0
CSI2$DBRR4_PP_UG_N[is.na(CSI2$DBRR4_PP_UG_N)] <- 0
CSI2$DBRR4_PP_UG_NUM[is.na(CSI2$DBRR4_PP_UG_NUM)] <- 0
CSI2$DBRR4_PP_UG_DEN[is.na(CSI2$DBRR4_PP_UG_DEN)] <- 0
CSI2$DBRR4_PP_UG_RT[is.na(CSI2$DBRR4_PP_UG_RT)] <- 0
CSI2$DBRR5_FED_UG_N[is.na(CSI2$DBRR5_FED_UG_N)] <- 0
CSI2$DBRR5_FED_UG_NUM[is.na(CSI2$DBRR5_FED_UG_NUM)] <- 0
CSI2$DBRR5_FED_UG_DEN[is.na(CSI2$DBRR5_FED_UG_DEN)] <- 0
CSI2$DBRR5_FED_UG_RT[is.na(CSI2$DBRR5_FED_UG_RT)] <- 0
CSI2$DBRR5_FED_GR_N[is.na(CSI2$DBRR5_FED_GR_N)] <- 0
CSI2$DBRR5_FED_GR_NUM[is.na(CSI2$DBRR5_FED_GR_NUM)] <- 0
CSI2$DBRR5_FED_GR_DEN[is.na(CSI2$DBRR5_FED_GR_DEN)] <- 0
CSI2$DBRR5_FED_GR_RT[is.na(CSI2$DBRR5_FED_GR_RT)] <- 0
CSI2$DBRR5_PP_UG_N[is.na(CSI2$DBRR5_PP_UG_N)] <- 0
CSI2$DBRR5_PP_UG_NUM[is.na(CSI2$DBRR5_PP_UG_NUM)] <- 0
CSI2$DBRR5_PP_UG_DEN[is.na(CSI2$DBRR5_PP_UG_DEN)] <- 0
CSI2$DBRR5_PP_UG_RT[is.na(CSI2$DBRR5_PP_UG_RT)] <- 0
CSI2$DBRR10_FED_UG_N[is.na(CSI2$DBRR10_FED_UG_N)] <- 0
CSI2$DBRR10_FED_UG_NUM[is.na(CSI2$DBRR10_FED_UG_NUM)] <- 0
CSI2$DBRR10_FED_UG_DEN[is.na(CSI2$DBRR10_FED_UG_DEN)] <- 0
CSI2$DBRR10_FED_UG_RT[is.na(CSI2$DBRR10_FED_UG_RT)] <- 0
CSI2$DBRR10_FED_GR_N[is.na(CSI2$DBRR10_FED_GR_N)] <- 0
CSI2$DBRR10_FED_GR_NUM[is.na(CSI2$DBRR10_FED_GR_NUM)] <- 0
CSI2$DBRR10_FED_GR_DEN[is.na(CSI2$DBRR10_FED_GR_DEN)] <- 0
CSI2$DBRR10_FED_GR_RT[is.na(CSI2$DBRR10_FED_GR_RT)] <- 0
CSI2$DBRR10_PP_UG_N[is.na(CSI2$DBRR10_PP_UG_N)] <- 0
CSI2$DBRR10_PP_UG_NUM[is.na(CSI2$DBRR10_PP_UG_NUM)] <- 0
CSI2$DBRR10_PP_UG_DEN[is.na(CSI2$DBRR10_PP_UG_DEN)] <- 0
CSI2$DBRR10_PP_UG_RT[is.na(CSI2$DBRR10_PP_UG_RT)] <- 0
CSI2$DBRR20_FED_UG_N[is.na(CSI2$DBRR20_FED_UG_N)] <- 0
CSI2$DBRR20_FED_UG_NUM[is.na(CSI2$DBRR20_FED_UG_NUM)] <- 0
CSI2$DBRR20_FED_UG_DEN[is.na(CSI2$DBRR20_FED_UG_DEN)] <- 0
CSI2$DBRR20_FED_UG_RT[is.na(CSI2$DBRR20_FED_UG_RT)] <- 0
CSI2$DBRR20_FED_GR_N[is.na(CSI2$DBRR20_FED_GR_N)] <- 0
CSI2$DBRR20_FED_GR_NUM[is.na(CSI2$DBRR20_FED_GR_NUM)] <- 0
CSI2$DBRR20_FED_GR_DEN[is.na(CSI2$DBRR20_FED_GR_DEN)] <- 0
CSI2$DBRR20_FED_GR_RT[is.na(CSI2$DBRR20_FED_GR_RT)] <- 0
CSI2$DBRR20_PP_UG_N[is.na(CSI2$DBRR20_PP_UG_N)] <- 0
CSI2$DBRR20_PP_UG_NUM[is.na(CSI2$DBRR20_PP_UG_NUM)] <- 0
CSI2$DBRR20_PP_UG_DEN[is.na(CSI2$DBRR20_PP_UG_DEN)] <- 0
CSI2$DBRR20_PP_UG_RT[is.na(CSI2$DBRR20_PP_UG_RT)] <- 0
```

```{r DBRRx}
Q28 <- CSI2 %>% arrange(desc(MAIN)) %>% filter(duplicated(OPEID6)==FALSE) 

Q28$State <- rep(NA, nrow(Q28))
Q28$State[Q28$STABBR == "CA"] <- "California"
Q28$State[Q28$STABBR != "CA"] <- "Rest of U.S."

Q28$Control <- rep(NA, nrow(Q28))
Q28$Control[Q28$CONTROL==1] <- "Public"
Q28$Control[Q28$CONTROL==2] <- "Nonprofit"
Q28$Control[Q28$CONTROL==3] <- "For-profit"

Q28$DBRR1_FED_UG_INST  <- ifelse(Q28$DBRR1_FED_UG_NUM > 0, 1, 0)
Q28$DBRR1_FED_GR_INST  <- ifelse(Q28$DBRR1_FED_GR_NUM > 0, 1, 0)
Q28$DBRR1_PP_UG_INST   <- ifelse(Q28$DBRR1_PP_UG_NUM > 0, 1, 0)
Q28$DBRR5_FED_UG_INST  <- ifelse(Q28$DBRR5_FED_UG_NUM > 0, 1, 0)
Q28$DBRR5_FED_GR_INST  <- ifelse(Q28$DBRR5_FED_GR_NUM > 0, 1, 0)
Q28$DBRR5_PP_UG_INST   <- ifelse(Q28$DBRR5_PP_UG_NUM > 0, 1, 0)
Q28$DBRR10_FED_UG_INST <- ifelse(Q28$DBRR10_FED_UG_NUM > 0, 1, 0)
Q28$DBRR10_FED_GR_INST <- ifelse(Q28$DBRR10_FED_GR_NUM > 0, 1, 0)
Q28$DBRR10_PP_UG_INST  <- ifelse(Q28$DBRR10_PP_UG_NUM > 0, 1, 0)
Q28$DBRR20_FED_UG_INST <- ifelse(Q28$DBRR20_FED_UG_NUM > 0, 1, 0)
Q28$DBRR20_FED_GR_INST <- ifelse(Q28$DBRR20_FED_GR_NUM > 0, 1, 0)
Q28$DBRR20_PP_UG_INST  <- ifelse(Q28$DBRR20_PP_UG_NUM > 0, 1, 0)

Q28.1 <- aggregate(data=Q28, cbind(
  DBRR1_FED_UG_N,
  DBRR1_FED_UG_NUM,
  DBRR1_FED_UG_DEN,
  DBRR1_FED_GR_N,
  DBRR1_FED_GR_NUM,
  DBRR1_FED_GR_DEN,
  DBRR1_PP_UG_N,
  DBRR1_PP_UG_NUM,
  DBRR1_PP_UG_DEN,
  DBRR5_FED_UG_N,
  DBRR5_FED_UG_NUM,
  DBRR5_FED_UG_DEN,
  DBRR5_FED_GR_N,
  DBRR5_FED_GR_NUM,
  DBRR5_FED_GR_DEN,
  DBRR5_PP_UG_N,
  DBRR5_PP_UG_NUM,
  DBRR5_PP_UG_DEN,
  DBRR10_FED_UG_N,
  DBRR10_FED_UG_NUM,
  DBRR10_FED_UG_DEN,
  DBRR10_FED_GR_N,
  DBRR10_FED_GR_NUM,
  DBRR10_FED_GR_DEN,
  DBRR10_PP_UG_N,
  DBRR10_PP_UG_NUM,
  DBRR10_PP_UG_DEN,
  DBRR20_FED_UG_N,
  DBRR20_FED_UG_NUM,
  DBRR20_FED_UG_DEN,
  DBRR20_FED_GR_N,
  DBRR20_FED_GR_NUM,
  DBRR20_FED_GR_DEN,
  DBRR20_PP_UG_N,
  DBRR20_PP_UG_NUM,
  DBRR20_PP_UG_DEN, 
  DBRR1_FED_UG_INST,
  DBRR1_FED_GR_INST,
  DBRR1_PP_UG_INST,
  DBRR5_FED_UG_INST,
  DBRR5_FED_GR_INST,
  DBRR5_PP_UG_INST,
  DBRR10_FED_UG_INST,
  DBRR10_FED_GR_INST,
  DBRR10_PP_UG_INST,
  DBRR20_FED_UG_INST,
  DBRR20_FED_GR_INST,
  DBRR20_PP_UG_INST
) ~ State + Control, FUN=sum)


Q28.2 <- aggregate(data=Q28, cbind(
  DBRR1_FED_UG_N,
  DBRR1_FED_UG_NUM,
  DBRR1_FED_UG_DEN,
  DBRR1_FED_GR_N,
  DBRR1_FED_GR_NUM,
  DBRR1_FED_GR_DEN,
  DBRR1_PP_UG_N,
  DBRR1_PP_UG_NUM,
  DBRR1_PP_UG_DEN,
  DBRR5_FED_UG_N,
  DBRR5_FED_UG_NUM,
  DBRR5_FED_UG_DEN,
  DBRR5_FED_GR_N,
  DBRR5_FED_GR_NUM,
  DBRR5_FED_GR_DEN,
  DBRR5_PP_UG_N,
  DBRR5_PP_UG_NUM,
  DBRR5_PP_UG_DEN,
  DBRR10_FED_UG_N,
  DBRR10_FED_UG_NUM,
  DBRR10_FED_UG_DEN,
  DBRR10_FED_GR_N,
  DBRR10_FED_GR_NUM,
  DBRR10_FED_GR_DEN,
  DBRR10_PP_UG_N,
  DBRR10_PP_UG_NUM,
  DBRR10_PP_UG_DEN,
  DBRR20_FED_UG_N,
  DBRR20_FED_UG_NUM,
  DBRR20_FED_UG_DEN,
  DBRR20_FED_GR_N,
  DBRR20_FED_GR_NUM,
  DBRR20_FED_GR_DEN,
  DBRR20_PP_UG_N,
  DBRR20_PP_UG_NUM,
  DBRR20_PP_UG_DEN, 
  DBRR1_FED_UG_INST,
  DBRR1_FED_GR_INST,
  DBRR1_PP_UG_INST,
  DBRR5_FED_UG_INST,
  DBRR5_FED_GR_INST,
  DBRR5_PP_UG_INST,
  DBRR10_FED_UG_INST,
  DBRR10_FED_GR_INST,
  DBRR10_PP_UG_INST,
  DBRR20_FED_UG_INST,
  DBRR20_FED_GR_INST,
  DBRR20_PP_UG_INST
) ~ State, FUN=sum)
Q28.2$Control <- rep("All controls", nrow(Q28.2))

Q28 <- rbind(Q28.1, Q28.2)
Q28 <- reshape2::melt(data=Q28, id.vars = c("State", "Control"))

Q28$Year <- rep(NA, nrow(Q28))
Q28$Year[grepl("DBRR1_", Q28$variable)] <- 1
Q28$Year[grepl("DBRR5_", Q28$variable)] <- 5
Q28$Year[grepl("DBRR10_", Q28$variable)] <- 10
Q28$Year[grepl("DBRR20_", Q28$variable)] <- 20

Q28$Program <- rep(NA, nrow(Q28))
Q28$Program[grepl("_FED_UG_", Q28$variable)] <- "Stafford"
Q28$Program[grepl("_FED_GR_", Q28$variable)] <- "Grad PLUS"
Q28$Program[grepl("_PP_UG_", Q28$variable)] <- "Parent PLUS"

Q28$Measure <- rep(NA, nrow(Q28))
Q28$Measure[grepl("_N", Q28$variable)] <- "Borrower count"
Q28$Measure[grepl("_NUM", Q28$variable)] <- "Balance at repayment year X" 
Q28$Measure[grepl("_DEN", Q28$variable)] <- "Original balance"
Q28$Measure[grepl("_INST", Q28$variable)] <- "Institution count"

Q28 <- reshape2::dcast(data=Q28, State + Control + Program + Year ~ Measure)
Q28$Ratio <- Q28$`Balance at repayment year X` / Q28$`Original balance`

placehold.DF <- data.frame("State"=c(rep("California", 12), rep("Rest of U.S.", 12)), 
                           "Control"=rep(c(rep("Public", 3), rep("Nonprofit", 3), rep("For-profit", 3), rep("All controls", 3)), 2), 
                           "Program"=rep(c("Stafford", "Grad PLUS", "Parent PLUS"), 8), 
                           "Year"=rep(0, 24), 
                           "Balance at repayment year X"=rep(NA, 24), 
                           "Borrower count"=rep(NA, 24), 
                           "Original balance"=rep(NA, 24),
                           "Institution count"=rep(NA, 24),
                           "Ratio"=rep(1, 24))
names(placehold.DF) <- names(Q28)
Q28 <- rbind(Q28, placehold.DF)

Q28.S <- Q28 %>% filter(Program=="Stafford")
Q28.G <- Q28 %>% filter(Program=="Grad PLUS")
Q28.P <- Q28 %>% filter(Program=="Parent PLUS")
```
#### Figure 36: Stafford
```{r figure36A}
Q28.S$`For Tooltip` <- paste(
  "State: ", Q28.S$State, '\n',
  "Control: ", Q28.S$Control, '\n',
  "Loan program: ", Q28.S$Program, '\n',
  "Years into repayment: ", Q28.S$Year, '\n',
  "Original balance: ", dollar(round(Q28.S$`Original balance`, -3), accuracy=1), '\n',
  "Balance X years into repayment: ", dollar(round(Q28.S$`Balance at repayment year X`, -3), accuracy=1), '\n',
  "Ratio: ", round(Q28.S$Ratio, 2), '\n',
  "Institution count: ", Q28.S$`Institution count`, 
  sep=""
)

g36A <- ggplot(data=Q28.S, mapping=aes(x=Year, y=Ratio, group=State, text=`For Tooltip`)) + geom_point(aes(color=State)) + geom_line(aes(color=State)) + facet_wrap(Control ~ ., nrow=2) + scale_y_continuous(limits=c(0, 1.4)) + labs(x="Years into repayment", y="Ratio of current balance to original balance") + theme(text=element_text(family="Optima"), legend.position="right") + scale_color_manual(values = stateCols)

ggplotly(g36A, width=800, height=600, tooltip="text")
```
#### Figure 36: Parent PLUS
```{r figure36B}
Q28.P$`For Tooltip` <- paste(
  "State: ", Q28.P$State, '\n',
  "Control: ", Q28.P$Control, '\n',
  "Loan program: ", Q28.P$Program, '\n',
  "Years into repayment: ", Q28.P$Year, '\n',
  "Original balance: ", dollar(round(Q28.P$`Original balance`, -3), accuracy=1), '\n',
  "Balance X years into repayment: ", dollar(round(Q28.P$`Balance at repayment year X`, -3), accuracy=1), '\n',
  "Ratio: ", round(Q28.P$Ratio, 2), '\n',
  "Institution count: ", Q28.P$`Institution count`,
  sep=""
)

g36B <- ggplot(data=Q28.P, mapping=aes(x=Year, y=Ratio, group=State, text=`For Tooltip`)) + geom_point(aes(color=State)) + geom_line(aes(color=State)) + facet_wrap(Control ~ ., nrow=2) + scale_y_continuous(limits=c(0, 1.4)) + labs(x="Years into repayment", y="Ratio of current balance to original balance") + theme(text=element_text(family="Optima"), legend.position="right") + scale_color_manual(values = stateCols)

ggplotly(g36B, width=800, height=600, tooltip="text")
```
#### Figure 36: Grad PLUS
```{r figure36C}
Q28.G$`For Tooltip` <- paste(
  "State: ", Q28.G$State, '\n',
  "Control: ", Q28.G$Control, '\n',
  "Loan program: ", Q28.G$Program, '\n',
  "Years into repayment: ", Q28.G$Year, '\n',
  "Original balance: ", dollar(round(Q28.G$`Original balance`, -3), accuracy=1), '\n',
  "Balance X years into repayment: ", dollar(round(Q28.G$`Balance at repayment year X`, -3), accuracy=1), '\n',
  "Ratio: ", round(Q28.G$Ratio, 2), '\n',
  "Institution count: ", Q28.G$`Institution count`,
  sep=""
)

g36C <- ggplot(data=Q28.G, mapping=aes(x=Year, y=Ratio, group=State, text=`For Tooltip`)) + geom_point(aes(color=State)) + geom_line(aes(color=State)) + facet_wrap(Control ~ ., nrow=2) + scale_y_continuous(limits=c(0, 1.4)) + labs(x="Years into repayment", y="Ratio of current balance to original balance") + theme(text=element_text(family="Optima"), legend.position="right") + scale_color_manual(values = stateCols)

ggplotly(g36C, width=800, height=600, tooltip="text")
```
#### Data Source and Notes

**Data source:** College Scorecard institution dataset, accessed November 2022, available through the U.S. Department of Education [here](https://collegescorecard.ed.gov/data/). 

**Timeframe reflected:** These charts are comprised of data on loan balances for four distinct cohorts: the "1-year cohort," the "5-year cohort," the "10-year cohort," and the "20-year cohort," signifying how many years the cohort of borrowers has been in repayment. The data values are derived from the current balance of the borrowers compared to the original balance when they entered repayment (be it 1, 5, 10, or 20 years prior). 

More specifically, the cohorts are defined as the following: 

* 1-year cohort: Borrowers who entered repayment in AY2017-18 or AY2018-19. Data on current balances reflect balances in 2018-2019 or 2019-2020. 
* 5-year cohort: Borrowers who entered repayment in AY2013-14 or AY2014-15. Data on current balances reflect balances in 2018-2019 or 2019-2020. 
* 10-year cohort: Borrowers who entered repayment in AY2008-09 or AY2009-10. Data on current balances reflect balances in 2018-2019 or 2019-2020.
* 20-year cohort: Borrowers who entered repayment in AY1998-99 or AY1999-00. Data on current balances reflect balances in 2018-2019 or 2019-2020.

The measures reflect pre-pandemic balances.

**Notes:**

***

### {-}

Overall, California performs well along DBRR metrics compared to the rest of the U.S. However, this same data can be used to track cohorts' average loan balances, which reveals some concerning trends for California. I derived the average loan balance by dividing current balances by borrower count. Note that a borrower who has fully paid off their loan is still counted in the average measure. 

Figure 37 shows the average current loan amount for four cohorts, organized by institutional control and loan type, comparing California institutions to those in the rest of the U.S. In the first tab, we see that average Stafford loan amounts are lower among borrowers from California institutions than those from institutions across the rest of the U.S., driven by lower average loans at California's public institutions. 

The next two tabs tell stories that more worrisome. Borrowers from California's private colleges have higher average Parent PLUS loans than those from non-California private colleges. This is especially true in the for-profit sector: 5 years into repayment, Parent PLUS borrowers from California for-profit institutions owe an average of \$22,000, versus \$14,000 for Parent PLUS borrowers from for-profits outside of California. This may be a more recent trend, as the gap is much smaller in the 10- and 20-year cohorts. 

Looking now to Grad PLUS, we see similar trends. Borrowers from California's private colleges have higher average Grad PLUS loans than those from non-California private colleges, especially for-profits. For the 5-year cohort, average Grad PLUS loans for borrowers from California nonprofits are 29 percent higher than those for borrowers from non-California nonprofits. In the same cohort, average Grad PLUS loans for borrowers from California for-profits are 38 percent higher than those for borrowers from non-California for-profits. On the bright side, average Grad PLUS loans from California's public colleges are lower than average Grad PLUS loans from non-California public colleges, across all four cohorts. 

### {.tabset}
```{r average.DBRR, warning=FALSE}
Q29.S <- Q28.S
Q29.P <- Q28.P
Q29.G <- Q28.G

Q29.S$`Average loan balance at year X` <- Q29.S$`Balance at repayment year X` / Q29.S$`Borrower count`
Q29.P$`Average loan balance at year X` <- Q29.P$`Balance at repayment year X` / Q29.P$`Borrower count`
Q29.G$`Average loan balance at year X` <- Q29.G$`Balance at repayment year X` / Q29.G$`Borrower count`
```
#### Figure 37: Stafford
```{r figure37A}
Q29.S$`For Tooltip` <- paste(
  "State: ", Q29.S$State, '\n',
  "Control: ", Q29.S$Control, '\n',
  "Loan program: ", Q29.S$Program, '\n',
  "Years into repayment: ", Q29.S$Year, '\n',
  "Average loan balance X years into repayment: ", dollar(round(Q29.S$`Average loan balance at year X`), accuracy=1), '\n',
  "Number of borrowers in cohort: ", comma(Q29.S$`Borrower count`, accuracy=10), '\n',
  "Institution count: ", Q29.S$`Institution count`,
  sep=""
)

g37A <- ggplot(data=Q29.S, mapping=aes(x=Year, y=`Average loan balance at year X`, group=State, text=`For Tooltip`)) + geom_point(aes(color=State)) + geom_line(aes(color=State)) + facet_wrap(Control ~ ., nrow=2) + scale_y_continuous(labels=scales::dollar_format(), limits=c(0, (max(Q29.S$`Average loan balance at year X`)+2500))) + labs(x="Years into repayment", y="Average loan balance at year X") + theme(text=element_text(family="Optima"), legend.position="right") + scale_color_manual(values = stateCols)

ggplotly(g37A, width=800, height=600, tooltip="text")
```
#### Figure 37: Parent PLUS
```{r figure37B}
Q29.P$`For Tooltip` <- paste(
  "State: ", Q29.P$State, '\n',
  "Control: ", Q29.P$Control, '\n',
  "Loan program: ", Q29.P$Program, '\n',
  "Years into repayment: ", Q29.P$Year, '\n',
  "Average loan balance X years into repayment: ", dollar(round(Q29.P$`Average loan balance at year X`), accuracy=1), '\n',
  "Number of borrowers in cohort: ", comma(Q29.P$`Borrower count`, accuracy=10), '\n',
  "Institution count: ", Q29.P$`Institution count`,
  sep=""
)

g37B <- ggplot(data=Q29.P, mapping=aes(x=Year, y=`Average loan balance at year X`, group=State, text=`For Tooltip`)) + geom_point(aes(color=State)) + geom_line(aes(color=State)) + facet_wrap(Control ~ ., nrow=2) + scale_y_continuous(labels=scales::dollar_format(), limits=c(0, (max(Q29.P$`Average loan balance at year X`)+2500))) + labs(x="Years into repayment", y="Average loan balance at year X") + theme(text=element_text(family="Optima"), legend.position="right") + scale_color_manual(values = stateCols)

ggplotly(g37B, width=800, height=600, tooltip="text")
```
#### Figure 37: Grad PLUS
```{r figure37C}
Q29.G$`For Tooltip` <- paste(
  "State: ", Q29.G$State, '\n',
  "Control: ", Q29.G$Control, '\n',
  "Loan program: ", Q29.G$Program, '\n',
  "Years into repayment: ", Q29.G$Year, '\n',
  "Average loan balance X years into repayment: ", dollar(round(Q29.G$`Average loan balance at year X`), accuracy=1), '\n',
  "Number of borrowers in cohort: ", comma(Q29.G$`Borrower count`, accuracy=10), '\n',
  "Institution count: ", Q29.G$`Institution count`,
  sep=""
)

g37C <- ggplot(data=Q29.G, mapping=aes(x=Year, y=`Average loan balance at year X`, group=State, text=`For Tooltip`)) + geom_point(aes(color=State)) + geom_line(aes(color=State)) + facet_wrap(Control ~ ., nrow=2) + scale_y_continuous(labels=scales::dollar_format(), limits=c(0, (max(Q29.G$`Average loan balance at year X`)+2500))) + labs(x="Years into repayment", y="Average loan balance at year X") + theme(text=element_text(family="Optima"), legend.position="right") + scale_color_manual(values = stateCols)

ggplotly(g37C, width=800, height=600, tooltip="text")
```
#### Data Source and Notes

**Data source:** College Scorecard institution dataset, accessed November 2022, available through the U.S. Department of Education [here](https://collegescorecard.ed.gov/data/). 

**Timeframe reflected:** These charts are comprised of data on loan balances for four distinct cohorts: the "1-year cohort," the "5-year cohort," the "10-year cohort," and the "20-year cohort," signifying how many years the cohort of borrowers has been in repayment. The data values are derived from the current balance of the borrowers compared to the original balance when they entered repayment (be it 1, 5, 10, or 20 years prior). 

More specifically, the cohorts are defined as the following: 

* 1-year cohort: Borrowers who entered repayment in AY2017-18 or AY2018-19. Data on current balances reflect balances in 2018-2019 or 2019-2020. 
* 5-year cohort: Borrowers who entered repayment in AY2013-14 or AY2014-15. Data on current balances reflect balances in 2018-2019 or 2019-2020. 
* 10-year cohort: Borrowers who entered repayment in AY2008-09 or AY2009-10. Data on current balances reflect balances in 2018-2019 or 2019-2020.
* 20-year cohort: Borrowers who entered repayment in AY1998-99 or AY1999-00. Data on current balances reflect balances in 2018-2019 or 2019-2020.

The measures reflect pre-pandemic balances.

**Notes:** One factor influencing the slope of these lines is the rising cost of college. For example, the far-right points in each chart represent borrowers who entered repayment twenty years ago, when college costs were somewhat lower than they are today; it follows that their average loan amount would be slightly lower than other cohorts', even after accounting for the additional time the 20-year cohort has had to repay their loans. 

***

### {-}

Taken together, figures 36 and 37 show that borrowers from California's colleges and universities make similar or better progress on repayment compared to borrowers from colleges and universities across the rest of the U.S. However, for borrowers with Parent PLUS and Grad PLUS loans, average loan balances tend to be higher when they are for enrollment in California institutions, and it takes those borrowers even longer to bring down those balances. 

Consider that, for borrowers with Grad PLUS loans from a California for-profit college, the average loan of those who have been in repayment for 20 years is roughly $27,800. That means, for the typical borrower with Grad PLUS loans for a California for-profit, even 20 years is not enough to get the balance below \$20,000. Grad PLUS borrowers from for-profits outside California owe an average of \$8,618 after 20 years in repayment. 

Now we will examine institutions' cohort default rates (CDR), a measure of the frequency with which borrowers from an institution default. I use CDR data from the College Scorecard and aggregate by institutional control and institutions' predominant degree awarded. Unfortunately, the College Scorecard does not disaggregate CDR data by loan type. 

Figure 38 shows that, overall, California institutions have lower CDR rates than those outside the U.S., across all three institutional controls. This is good news, because it means borrowers are finding ways to stave off default. One exception is for-profit colleges that predominantly offer bachelor's degrees: those in California have a CDR of 12.8 percent, compared to a CDR of 11.3 percent for those outside California.  

### {.tabset}
```{r CDR, warning=FALSE}
CSI3 <- fread("Most-Recent-Cohorts-Institution.csv", header=TRUE, select=c(
  
  # Basic information about institutions: 
  "UNITID",       # Unit ID for institution
  "OPEID",        # 8-digit OPEID
  "OPEID6",       # 6-digit OPEID
  "INSTNM",       # Institution name
  "CITY",         # City
  "STABBR",       # State postcode
  "MAIN",         # "Flag for main campus (0 Not main campus, 1 Main campus)
  "PREDDEG",      # Predominant undergraduate degree awarded
  "CONTROL",      # Control of institution
  "CCBASIC",      # Carnegie Classification -- basic
  
  # Cohort default rates: 
  "CDR2",         # Two-year cohort default rate
  "CDR3",         # Three-year cohort default rate
  "CDR2_DENOM",   # Number of students in the cohort for the two-year cohort default rate	
  "CDR3_DENOM"    # Number of students in the cohort for the three-year cohort default rate	
))

CSI3$CDR2 <- as.numeric(CSI3$CDR2)
CSI3$CDR3 <- as.numeric(CSI3$CDR3)
CSI3$CDR2_DENOM <- as.numeric(CSI3$CDR2_DENOM)
CSI3$CDR3_DENOM <- as.numeric(CSI3$CDR3_DENOM)

# I used the following lines to confirm that, for every institution with data for CDR2, there is data for CDR2_DENOM, and the same for CDR3 and CDR3_DENOM.
#
# CSI3$CDR2.real <- ifelse(is.na(CSI3$CDR2), 0, 1)
# CSI3$CDR3.real <- ifelse(is.na(CSI3$CDR3), 0, 1)
# CSI3$CDR2_DENOM.real <- ifelse(is.na(CSI3$CDR2_DENOM), 0, 1)
# CSI3$CDR3_DENOM.real <- ifelse(is.na(CSI3$CDR3_DENOM), 0, 1)
# table(CSI3$CDR2.real, CSI3$CDR2_DENOM.real)
# table(CSI3$CDR3.real, CSI3$CDR3_DENOM.real)

CSI3$CDR2_INST <- ifelse(is.na(CSI3$CDR2_DENOM), 0, 1)
CSI3$CDR3_INST <- ifelse(is.na(CSI3$CDR3_DENOM), 0, 1)

CSI3$CDR2_NUMER <- CSI3$CDR2 * CSI3$CDR2_DENOM
CSI3$CDR3_NUMER <- CSI3$CDR3 * CSI3$CDR3_DENOM

CSI3 <- CSI3 %>% arrange(desc(MAIN)) %>% filter(duplicated(OPEID6)==FALSE) 

CSI3$State <- rep(NA, nrow(CSI3))
CSI3$State[CSI3$STABBR == "CA"] <- "California"
CSI3$State[CSI3$STABBR != "CA"] <- "Rest of U.S."
```
#### Figure 38: CDR by Control
```{r CDR.control}
CSI3$Control <- rep(NA, nrow(CSI3))
CSI3$Control[CSI3$CONTROL==1] <- "Public"
CSI3$Control[CSI3$CONTROL==2] <- "Nonprofit"
CSI3$Control[CSI3$CONTROL==3] <- "For-profit"

Q30A.1 <- aggregate(data=CSI3, cbind(
  CDR2_NUMER, 
  CDR2_DENOM, 
  CDR3_NUMER, 
  CDR3_DENOM, 
  CDR2_INST, 
  CDR3_INST
) ~ State + Control, FUN=sum)
Q30A.2 <- aggregate(data=CSI3, cbind(
  CDR2_NUMER, 
  CDR2_DENOM, 
  CDR3_NUMER, 
  CDR3_DENOM, 
  CDR2_INST, 
  CDR3_INST
) ~ State, FUN=sum)
Q30A.2$Control <- rep("All controls", nrow(Q30A.2))

Q30A <- rbind(Q30A.1, Q30A.2)

Q30A$CDR2 <- Q30A$CDR2_NUMER / Q30A$CDR2_DENOM
Q30A$CDR3 <- Q30A$CDR3_NUMER / Q30A$CDR3_DENOM
```

```{r figure38A}
Q30A$`For Tooltip` <- paste(
  "State: ", Q30A$State, '\n',
  "Control: ", Q30A$Control, '\n',
  "Borrowers in 3-year cohort: ", comma(Q30A$CDR3_DENOM, accuracy=1), '\n',
  "Defaulted borrowers: ", comma(Q30A$CDR3_NUMER, accuracy=1), '\n',
  "3-year cohort default rate: ", percent(Q30A$CDR3, accuracy=0.1), '\n',
  "Institution count: ", comma(Q30A$CDR3_INST, accuracy=1),
  sep=""
)

g38A <- ggplot(data=Q30A, mapping=aes(x=Control, y=CDR3, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.4) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) + labs(x="Control", y="Three-year cohort default rate") + theme(text=element_text(family="Optima"), legend.position="right") + scale_fill_manual(values = stateCols)

ggplotly(g38A, width=600, height=350, tooltip="text")
```
#### Figure 38: CDR by Control and Predominant Degree Awarded
```{r CDR.highdeg}
CSI3 <- CSI3 %>% filter(PREDDEG != 0) # This only removes Stockton Christian Life College, which does not have CDR data in Scorecard. 

CSI3$PredDeg <- rep(NA, nrow(CSI3))
CSI3$PredDeg[CSI3$PREDDEG==1] <- "Certificate"
CSI3$PredDeg[CSI3$PREDDEG==2] <- "Associate's"
CSI3$PredDeg[CSI3$PREDDEG==3] <- "Bachelor's"
CSI3$PredDeg[CSI3$PREDDEG==4] <- "Graduate"

CSI3$PredDeg <- as.factor(CSI3$PredDeg)
CSI3$PredDeg <- factor(CSI3$PredDeg, levels=c(
  "Certificate", 
  "Associate's", 
  "Bachelor's", 
  "Graduate"
))

Q30B <- aggregate(data=CSI3, cbind(
  CDR2_NUMER, 
  CDR2_DENOM, 
  CDR3_NUMER, 
  CDR3_DENOM, 
  CDR2_INST, 
  CDR3_INST
) ~ State + Control + PredDeg, FUN=sum)

Q30B$CDR2 <- Q30B$CDR2_NUMER / Q30B$CDR2_DENOM
Q30B$CDR3 <- Q30B$CDR3_NUMER / Q30B$CDR3_DENOM
```

```{r figure38B}
Q30B$`For Tooltip` <- paste(
  "State: ", Q30B$State, '\n',
  "Control: ", Q30B$Control, '\n',
  "Predominant degree awarded: ", Q30B$PredDeg, '\n',
  "Borrowers in 3-year cohort: ", comma(Q30B$CDR3_DENOM, accuracy=1), '\n',
  "Defaulted borrowers: ", comma(Q30B$CDR3_NUMER, accuracy=1), '\n',
  "3-year cohort default rate: ", percent(Q30B$CDR3, accuracy=0.1), '\n',
  "Institution count: ", comma(Q30B$CDR3_INST, accuracy=1),
  sep=""
)

g38B <- ggplot(data=Q30B, mapping=aes(x=PredDeg, y=CDR3, fill=State, text=`For Tooltip`)) + geom_bar(stat="identity", position="dodge", width=0.4) + facet_grid(Control ~ .) +  scale_y_continuous(labels=scales::percent_format(accuracy=1)) + labs(x="Institution's predominant degree awarded", y="Three-year cohort default rate") + theme(text=element_text(family="Optima"), legend.position="right") + scale_fill_manual(values = stateCols)

ggplotly(g38B, width=600, height=600, tooltip="text")
```
#### Data Source and Notes

**Data source:** College Scorecard institution dataset, accessed November 2022, available through the U.S. Department of Education [here](https://collegescorecard.ed.gov/data/). 

**Timeframe reflected:** The three-year cohort default rates presented here represent borrowers who entered repayment between October 1, 2017 and September 30, 2018. Those counted as defaulters are those who defaulted anytime before September 30, 2020. 

**Notes:** 

***

### {-}


## American Community Survey 

Finally, we are interested in why people take out student loan debt, particularly the motivation to increase one's income. California is a high-income state, but it is also a state with a high cost of living. Is California a state where someone particularly *needs* education to achieve a comfortable living, to a greater degree than most states? We can explore this using data from the American Community Survey. 

#### About the data

The American Community Survey (ACS) is an annual survey conducted by the U.S. Census Bureau that samples one percent of all U.S. households every year. It asks about a battery of person-level and household-level questions. Here, we are interested in data on education and income. 

The COVID-19 pandemic severely strained the Census Bureau's ability to conduct the ACS in a way that meets the bureau's quality standards in the 2020 survey year. Therefore, we focus on a five-year data set spanning years 2015 to 2019, known as the "Public Use Microdata Sample." 

The 2015-2019 ACS PUMS data set contains records on 16 million individuals across all states, bringing to bear an immense volume of data. I filter for those who are aged 18 to 65 and in the labor force, reducing the sample size to 7.3 million individuals. We can compare annual income across education level and state. 

#### Findings 

We will examine two ways of measuring gaps in income across groups: the attainment of a threshold income, and average income. 

First, we find what percentage of California's workers attain certain benchmark incomes, broken out by education level. Comparing California's rank along these measures is one way to visualize how the state's income dynamics differ from the rest of the country's. 

I use \$60,000 as an income cutoff for comparing workers whose highest education is a bachelor's degree to those whose highest education is a high school diploma (or equivalent). I use \$80,000 as an income cutoff for comparing workers whose highest education is a graduate degree to those whose highest education is a bachelor's degree. 

Figure 39 shows the percentages of workers meeting these benchmarks by state, separated by education level. California's share of bachelor's degree holders who earn \$60,000 is seventh-highest, but its share of high school diploma holders who earn \$60,000 is barely in the top half. Table 11 breaks down the percentage point differences and find that California has one of the largest increases between high school-educated workers and four-year college-educated workers, in terms of the attainment of a \$60,000 income. Similar trends can be found for the jump in likelihood that a California worker earns \$80,000, based on whether they have attained a graduate degree instead of only a bachelor's degree. 

### {.tabset}
```{r PUMS.income1}
PUMS.Income.Vars <- c("SERIALNO", 
                      "PWGTP",
                      "ST", 
                      "SCHL", 
                      "SEX", 
                      "WAGP", 
                      "AGEP", 
                      "RAC1P",
                      "HISP",
                      "ESR")
pusa1519 <- fread("psam1519_pusa.csv", header=TRUE, select=PUMS.Income.Vars)
pusb1519 <- fread("psam1519_pusb.csv", header=TRUE, select=PUMS.Income.Vars)
pusc1519 <- fread("psam1519_pusc.csv", header=TRUE, select=PUMS.Income.Vars)
pusd1519 <- fread("psam1519_pusd.csv", header=TRUE, select=PUMS.Income.Vars)
pusm1519 <- rbind(pusa1519, pusb1519, pusc1519, pusd1519)
rm("pusa1519", "pusb1519", "pusc1519", "pusd1519")

pusm1519 <- pusm1519 %>% filter(AGEP %in% (18:65))
pusm1519 <- pusm1519 %>% filter(ESR %in% (1:5))
pusm1519 <- left_join(x=pusm1519, y=statenames, by="ST")

pusm1519$Education <- rep(NA, nrow(pusm1519))
pusm1519$Education[pusm1519$SCHL %in% (1:15)] <- "Less than high school diploma"
pusm1519$Education[pusm1519$SCHL %in% (16:17)] <- "High school diploma or equivalent"
pusm1519$Education[pusm1519$SCHL %in% (18:19)] <- "Some college, no degree"
pusm1519$Education[pusm1519$SCHL == 20] <- "Associate's degree"
pusm1519$Education[pusm1519$SCHL == 21] <- "Bachelor's degree"
pusm1519$Education[pusm1519$SCHL %in% (22:24)] <- "Graduate degree"

pusm1519$Sex <- rep(NA, nrow(pusm1519))
pusm1519$Sex[pusm1519$SEX == 1] <- "Male"
pusm1519$Sex[pusm1519$SEX == 2] <- "Female"

pusm1519$Race <- rep(NA, nrow(pusm1519))
pusm1519$Race[(pusm1519$RAC1P == 1) & (pusm1519$HISP == 1)] <- "White"
pusm1519$Race[(pusm1519$RAC1P == 2) & (pusm1519$HISP == 1)] <- "Black"
pusm1519$Race[pusm1519$HISP > 1] <- "Latino/a"
pusm1519$Race[(pusm1519$RAC1P %in% (3:5)) & (pusm1519$HISP == 1)] <- "Native American"
pusm1519$Race[(pusm1519$RAC1P %in% (6:7)) & (pusm1519$HISP == 1)] <- "Asian / Pacific Islander"
pusm1519$Race[(pusm1519$RAC1P == 8) & (pusm1519$HISP == 1)] <- "Other"
pusm1519$Race[pusm1519$RAC1P == 9] <- "More than one"

pusm1519 <- pusm1519 %>% mutate(`Earning at least $50,000` = ifelse(WAGP > 50000, 1, 0))
pusm1519 <- pusm1519 %>% mutate(`Earning at least $60,000` = ifelse(WAGP > 60000, 1, 0))
pusm1519 <- pusm1519 %>% mutate(`Earning at least $75,000` = ifelse(WAGP > 75000, 1, 0))
pusm1519 <- pusm1519 %>% mutate(`Earning at least $80,000` = ifelse(WAGP > 80000, 1, 0))
pusm1519 <- pusm1519 %>% mutate(`Earning at least $100,000` = ifelse(WAGP > 100000, 1, 0))

agg50 <- aggregate(data=pusm1519, PWGTP ~ State + Education + `Earning at least $50,000`, FUN=sum)
agg60 <- aggregate(data=pusm1519, PWGTP ~ State + Education + `Earning at least $60,000`, FUN=sum)
agg75 <- aggregate(data=pusm1519, PWGTP ~ State + Education + `Earning at least $75,000`, FUN=sum)
agg80 <- aggregate(data=pusm1519, PWGTP ~ State + Education + `Earning at least $80,000`, FUN=sum)
agg100 <- aggregate(data=pusm1519, PWGTP ~ State + Education + `Earning at least $100,000`, FUN=sum)

agg50 <- reshape2::dcast(data=agg50, State + Education ~ `Earning at least $50,000`, value.var="PWGTP") %>% mutate(`Share earning at least $50,000` = `1` / (`1` + `0`)) %>% select(`State`, `Education`, `Share earning at least $50,000`)
agg60 <- reshape2::dcast(data=agg60, State + Education ~ `Earning at least $60,000`, value.var="PWGTP") %>% mutate(`Share earning at least $60,000` = `1` / (`1` + `0`)) %>% select(`State`, `Education`, `Share earning at least $60,000`)
agg75 <- reshape2::dcast(data=agg75, State + Education ~ `Earning at least $75,000`, value.var="PWGTP") %>% mutate(`Share earning at least $75,000` = `1` / (`1` + `0`)) %>% select(`State`, `Education`, `Share earning at least $75,000`)
agg80 <- reshape2::dcast(data=agg80, State + Education ~ `Earning at least $80,000`, value.var="PWGTP") %>% mutate(`Share earning at least $80,000` = `1` / (`1` + `0`)) %>% select(`State`, `Education`, `Share earning at least $80,000`)
agg100 <- reshape2::dcast(data=agg100, State + Education ~ `Earning at least $100,000`, value.var="PWGTP") %>% mutate(`Share earning at least $100,000` = `1` / (`1` + `0`)) %>% select(`State`, `Education`, `Share earning at least $100,000`)

agg.income <- left_join(x=agg50, y=agg60, by=c("State", "Education"))
agg.income <- left_join(x=agg.income, y=agg75, by=c("State", "Education"))
agg.income <- left_join(x=agg.income, y=agg80, by=c("State", "Education"))
agg.income <- left_join(x=agg.income, y=agg100, by=c("State", "Education"))

agg50 <- reshape2::dcast(data=agg.income, State ~ Education, value.var="Share earning at least $50,000") 
agg60 <- reshape2::dcast(data=agg.income, State ~ Education, value.var="Share earning at least $60,000")
agg75 <- reshape2::dcast(data=agg.income, State ~ Education, value.var="Share earning at least $75,000")
agg80 <- reshape2::dcast(data=agg.income, State ~ Education, value.var="Share earning at least $80,000")
agg100 <- reshape2::dcast(data=agg.income, State ~ Education, value.var="Share earning at least $100,000")

agg50 <- agg50 %>% mutate(`Bachelor's over HS` = `Bachelor's degree` - `High school diploma or equivalent`) %>% mutate(`Graduate over bachelor's` = `Graduate degree` - `Bachelor's degree`)
agg60 <- agg60 %>% mutate(`Bachelor's over HS` = `Bachelor's degree` - `High school diploma or equivalent`) %>% mutate(`Graduate over bachelor's` = `Graduate degree` - `Bachelor's degree`)
agg75 <- agg75 %>% mutate(`Bachelor's over HS` = `Bachelor's degree` - `High school diploma or equivalent`) %>% mutate(`Graduate over bachelor's` = `Graduate degree` - `Bachelor's degree`)
agg80 <- agg80 %>% mutate(`Bachelor's over HS` = `Bachelor's degree` - `High school diploma or equivalent`) %>% mutate(`Graduate over bachelor's` = `Graduate degree` - `Bachelor's degree`)
agg100 <- agg100 %>% mutate(`Bachelor's over HS` = `Bachelor's degree` - `High school diploma or equivalent`) %>% mutate(`Graduate over bachelor's` = `Graduate degree` - `Bachelor's degree`)

agg50 <- left_join(x=agg50, y=statenames2, by="State")
agg60 <- left_join(x=agg60, y=statenames2, by="State")
agg75 <- left_join(x=agg75, y=statenames2, by="State")
agg80 <- left_join(x=agg80, y=statenames2, by="State")
agg100 <- left_join(x=agg100, y=statenames2, by="State")
```
#### Figure 39: Share of workforce earning $60,000
```{r figure39A1}
agg60$`For Tooltip` <- paste(
  "State: ", agg60$State, '\n',
  "Share of bachelors holders earning at least $60,000: ", percent(agg60$`Bachelor's degree`, accuracy=0.1), '\n',
  "Share of high school diploma holders earning at least $60,000: ", percent(agg60$`High school diploma or equivalent`, accuracy=0.1), '\n', 
  sep=""
)
agg60$California <- as.factor(ifelse(agg60$State.Abbreviation=="CA", 1, 0))

f39A1 <- agg60
f39A1$State.Abbreviation <- factor(f39A1$State.Abbreviation, levels = f39A1$State.Abbreviation[order(f39A1$`Bachelor's degree`)])
g39A1 <- ggplot(data=f39A1, mapping=aes(x=`State.Abbreviation`, y=`Bachelor's degree`, fill=California, text=`For Tooltip`)) + geom_bar(stat="identity") + labs(x="State", y="Share of B.A. holders earning $60,000+") + scale_fill_manual(values = rev(flagCols2[4:5])) + theme(legend.position='none', text=element_text(family="Optima"), axis.text = element_text(size = 7)) + scale_y_continuous(labels=scales::percent_format(accuracy=1))

ggplotly(g39A1, width=900, height=400, tooltip="text")
```

```{r figure39A2}
f39A2 <- agg60
f39A2$State.Abbreviation <- factor(f39A2$State.Abbreviation, levels = f39A2$State.Abbreviation[order(f39A2$`High school diploma or equivalent`)])
g39A2 <- ggplot(data=f39A2, mapping=aes(x=`State.Abbreviation`, y=`High school diploma or equivalent`, fill=California, text=`For Tooltip`)) + geom_bar(stat="identity") + labs(x="State", y="Share of H.S. diploma holders earning $60,000+") + scale_fill_manual(values = rev(flagCols2[4:5])) + theme(legend.position='none', text=element_text(family="Optima"), axis.text = element_text(size = 7)) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) 

ggplotly(g39A2, width=900, height=400, tooltip="text")
```
#### Figure 39: Share of workforce earning $80,000
```{r figure39B1}
agg80$`For Tooltip` <- paste(
  "State: ", agg80$State, '\n',
  "Share of graduate degree holders earning at least $80,000: ", percent(agg80$`Graduate degree`, accuracy=0.1), '\n', 
  "Share of bachelors holders earning at least $80,000: ", percent(agg80$`Bachelor's degree`, accuracy=0.1), '\n',
  sep=""
)
agg80$California <- as.factor(ifelse(agg80$State.Abbreviation=="CA", 1, 0))

f39B1 <- agg80
f39B1$State.Abbreviation <- factor(f39B1$State.Abbreviation, levels = f39B1$State.Abbreviation[order(f39B1$`Graduate degree`)])
g39B1 <- ggplot(data=f39B1, mapping=aes(x=`State.Abbreviation`, y=`Graduate degree`, fill=California, text=`For Tooltip`)) + geom_bar(stat="identity") + labs(x="State", y="Share of graduate degree holders earning $80,000+") + scale_fill_manual(values = rev(flagCols2[4:5])) + theme(legend.position='none', text=element_text(family="Optima"), axis.text = element_text(size = 7)) + scale_y_continuous(labels=scales::percent_format(accuracy=1))

ggplotly(g39B1, width=900, height=400, tooltip="text")
```

```{r figure39B2}
f39B2 <- agg80
f39B2$State.Abbreviation <- factor(f39B2$State.Abbreviation, levels = f39B2$State.Abbreviation[order(f39B2$`Bachelor's degree`)])
g39B2 <- ggplot(data=f39B2, mapping=aes(x=`State.Abbreviation`, y=`Bachelor's degree`, fill=California, text=`For Tooltip`)) + geom_bar(stat="identity") + labs(x="State", y="Share of B.A. holders earning $80,000+") + scale_fill_manual(values = rev(flagCols2[4:5])) + theme(legend.position='none', text=element_text(family="Optima"), axis.text = element_text(size = 7)) + scale_y_continuous(labels=scales::percent_format(accuracy=1)) 

ggplotly(g39B2, width=900, height=400, tooltip="text")
```
#### Table 11: State ranks
```{r kable11A, results='asis'}
table11A <- agg60 %>% select(`State`, `Bachelor's degree`, `High school diploma or equivalent`, `Bachelor's over HS`)
table11A <- table11A %>% mutate(`Rank of Bachelor's over HS` = rank(-(`Bachelor's over HS`), ties.method="average"))
table11A <- table11A %>% filter(State=="California")

table11A <- data.frame("Measure" = c(
  "Share of high school diploma holders in California who earn $60,000", 
  "Share of bachelor's degree holders in California who earn $60,000",
  "Percentage point increase in likelihood of earning $60,000, high school to bachelor's", 
  "California's national rank by percentage point difference (1=greatest difference)"
), "Value" = c(
  percent(table11A$`High school diploma or equivalent`[1], accuracy=0.1),
  percent(table11A$`Bachelor's degree`[1], accuracy=0.1), 
  paste(round(((table11A$`Bachelor's over HS`[1]) * 100), 1), "pp", sep=""), 
  round(table11A$`Rank of Bachelor's over HS`[1], 0)
))

kable(table11A, caption="Share of workforce who earn $60,000, by educational attainment") %>% kable_paper("hover", full_width = F)
```

```{r kable11B, results='asis'}
table11B <- agg80 %>% select(`State`, `Graduate degree`, `Bachelor's degree`, `Graduate over bachelor's`)
table11B <- table11B %>% mutate(`Rank of Graduate over bachelor's` = rank(-(`Graduate over bachelor's`), ties.method="average"))
table11B <- table11B %>% filter(State=="California")

table11B <- data.frame("Measure" = c(
  "Share of bachelor's degree holders in California who earn $80,000",
  "Share of graduate degree holders in California who earn $80,000",
  "Percentage point increase in likelihood of earning $80,000, bachelor's to graduate degree", 
  "California's national rank by percentage point difference (1=greatest difference)"
), "Value" = c(
  percent(table11B$`Bachelor's degree`[1], accuracy=0.1),
  percent(table11B$`Graduate degree`[1], accuracy=0.1),
  paste(round(((table11B$`Graduate over bachelor's`[1]) * 100), 1), "pp", sep=""),
  round(table11B$`Rank of Graduate over bachelor's`[1], 0)
))

kable(table11B, caption="Share of workforce who earn $80,000, by educational attainment") %>% kable_paper("hover", full_width = F)

```

#### Data Source and Notes

**Data source:** American Community Survey Public Use Microdata Survey 5-year 2019 dataset, accessed April 2023, available through the U.S. Census Bureau [here](https://www2.census.gov/programs-surveys/acs/data/pums/2019/5-Year/). 

**Timeframe reflected:** The 5-year PUMS data set reflects survey data collected in 2015, 2016, 2017, 2018, and 2019.

**Notes:** 

***

### {-}

Next, we turn to average wages, examined in Figure 40 and Table 12. Californians with only a high school diploma earn about the same amount as they would in other states, based on their education level. But the average wages of workers with a bachelor's degree are higher in California than in other states, and the same goes for workers with a graduate degree. We can see why the state is first overall in the average wage increase between high school-educated workers and those with a bachelor's degree. 

### {.tabset}
```{r PUMS.income2}
pusm1519R <- pusm1519
pusm1519S0 <- pusm1519 %>% mutate(State = ifelse(`State` == "California", "California", "Rest of U.S."))
pusm1519S1 <- pusm1519 %>% filter(State=="California")
pusm1519S2 <- pusm1519 %>% filter(State=="California")

# For all workers (for state ranks):
PWGTP.st.ed <- aggregate(data=pusm1519R, PWGTP ~ State + Education, FUN=sum)
names(PWGTP.st.ed)[3] <- "Weight in group"
pusm1519R <- left_join(x=pusm1519R, y=PWGTP.st.ed, by=c("State", "Education"))
pusm1519R <- pusm1519R %>% mutate(`Adjusted WAGP` = `WAGP` * (`PWGTP` / `Weight in group`))
agg4 <- aggregate(data=pusm1519R, `Adjusted WAGP` ~ State + Education, FUN=sum)
agg4 <- reshape2::dcast(data=agg4, State ~ Education, value.var="Adjusted WAGP")
agg4 <- agg4 %>% mutate(`Difference: BA over HS` = `Bachelor's degree` - `High school diploma or equivalent`)
agg4 <- agg4 %>% mutate(`Ratio: BA over HS` = `Bachelor's degree` / `High school diploma or equivalent`)
agg4 <- agg4 %>% mutate(`Difference: GD over BA` =  `Graduate degree` - `Bachelor's degree`)
agg4 <- agg4 %>% mutate(`Ratio: GD over BA` = `Graduate degree` / `Bachelor's degree`)

# For all workers, California vs. Rest of US:
PWGTP.st.ed <- aggregate(data=pusm1519S0, PWGTP ~ State + Education, FUN=sum)
names(PWGTP.st.ed)[3] <- "Weight in group"
pusm1519S0 <- left_join(x=pusm1519S0, y=PWGTP.st.ed, by=c("State", "Education"))
pusm1519S0 <- pusm1519S0 %>% mutate(`Adjusted WAGP` = `WAGP` * (`PWGTP` / `Weight in group`))
agg5 <- aggregate(data=pusm1519S0, `Adjusted WAGP` ~ State + Education, FUN=sum)

# For race and gender: 
PWGTP.st.ed <- aggregate(data=pusm1519S1, PWGTP ~ Education + Race + Sex, FUN=sum)
names(PWGTP.st.ed)[4] <- "Weight in group"
pusm1519S1 <- left_join(x=pusm1519S1, y=PWGTP.st.ed, by=c("Education", "Race", "Sex"))
pusm1519S1 <- pusm1519S1 %>% mutate(`Adjusted WAGP` = `WAGP` * (`PWGTP` / `Weight in group`))
agg6 <- aggregate(data=pusm1519S1, `Adjusted WAGP` ~ Education + Race + Sex, FUN=sum)
agg6 <- reshape2::dcast(data=agg6, Race + Sex ~ Education, value.var="Adjusted WAGP")
agg6 <- agg6 %>% mutate(`Difference: BA over HS` = `Bachelor's degree` - `High school diploma or equivalent`)
agg6 <- agg6 %>% mutate(`Ratio: BA over HS` = `Bachelor's degree` / `High school diploma or equivalent`)
agg6 <- agg6 %>% mutate(`Difference: GD over BA` =  `Graduate degree` - `Bachelor's degree`)
agg6 <- agg6 %>% mutate(`Ratio: GD over BA` = `Graduate degree` / `Bachelor's degree`)

# For race only: 
PWGTP.st.ed <- aggregate(data=pusm1519S2, PWGTP ~ Education + Race, FUN=sum)
names(PWGTP.st.ed)[3] <- "Weight in group"
pusm1519S2 <- left_join(x=pusm1519S2, y=PWGTP.st.ed, by=c("Education", "Race"))
pusm1519S2 <- pusm1519S2 %>% mutate(`Adjusted WAGP` = `WAGP` * (`PWGTP` / `Weight in group`))
agg7 <- aggregate(data=pusm1519S2, `Adjusted WAGP` ~ Education + Race, FUN=sum)
agg7 <- reshape2::dcast(data=agg7, Race ~ Education, value.var="Adjusted WAGP")
agg7 <- agg7 %>% mutate(`Difference: BA over HS` = `Bachelor's degree` - `High school diploma or equivalent`)
agg7 <- agg7 %>% mutate(`Ratio: BA over HS` = `Bachelor's degree` / `High school diploma or equivalent`)
agg7 <- agg7 %>% mutate(`Difference: GD over BA` =  `Graduate degree` - `Bachelor's degree`)
agg7 <- agg7 %>% mutate(`Ratio: GD over BA` = `Graduate degree` / `Bachelor's degree`)
```
#### Figure 40: Average income by education level 
```{r figure40}
agg5 <- agg5 %>% mutate(`Education` = as.factor(`Education`))
agg5$Education <- factor(agg5$Education, levels=c(
  "Less than high school diploma", 
  "High school diploma or equivalent", 
  "Some college, no degree", 
  "Associate's degree", 
  "Bachelor's degree", 
  "Graduate degree"
))
agg5$`For Tooltip` <- paste(
  "State: ", agg5$State, '\n',
  "Highest level of education: ", agg5$Education, '\n',
  "Average wages: ", dollar(agg5$`Adjusted WAGP`, accuracy=1),
  sep=""
)

g40 <- ggplot(data=agg5, mapping=aes(x=`Adjusted WAGP`, y=Education, fill=Education, text=`For Tooltip`)) + geom_bar(stat="identity") + facet_wrap(State ~ ., ncol=1, strip.position=c("top")) + scale_x_continuous(labels=dollar_format(accuracy=1)) + labs(x="Workers' average annual wages", "Highest education level") + scale_fill_manual(values = rev(flagCols)) + theme(legend.position='none', text=element_text(family="Optima"), axis.text = element_text(size = 7)) 

ggplotly(g40, width=800, height=350, tooltip="text")
```
#### Table 12: State ranks
```{r kable12A, results='asis'}
agg4.0 <- agg4 %>% filter(State != "District of Columbia") %>% mutate(`Rank of Ratio: BA over HS` = rank(-(`Ratio: BA over HS`))) %>% mutate(`Rank of Ratio: GD over BA` = rank(-(`Ratio: GD over BA`)))
agg4.0 <- agg4.0 %>% filter(State=="California")

table12A <- data.frame("Measure" = c(
  "Average wages of workers with a high school diploma in California", 
  "Average wages of workers with a bachelor's degree in California",
  "Percentage increase in average wages, high school to bachelor's", 
  "California's national rank by percentage increase (1=greatest increase)"
), "Value"=c(
  dollar(agg4.0$`High school diploma or equivalent`[1], accuracy=1), 
  dollar(agg4.0$`Bachelor's degree`[1], accuracy=1), 
  percent((agg4.0$`Ratio: BA over HS`[1] - 1), accuracy=0.1), 
  round(agg4.0$`Rank of Ratio: BA over HS`[1], 0)
))

kable(table12A, caption="Average annual wages of workers by highest education: High school diploma vs. Bachelor's degree") %>% kable_paper("hover", full_width = F)
```

```{r kable12B, results='asis'}
table12B <- data.frame("Measure" = c(
  "Average wages of workers with a bachelor's degree in California", 
  "Average wages of workers with a graduate degree in California",
  "Percentage increase in average wages, bachelor's to graduate degree", 
  "California's national rank by percentage increase (1=greatest increase)"
), "Value"=c(
  dollar(agg4.0$`Bachelor's degree`[1], accuracy=1), 
  dollar(agg4.0$`Graduate degree`[1], accuracy=1), 
  percent((agg4.0$`Ratio: GD over BA`[1] - 1), accuracy=0.1), 
  round(agg4.0$`Rank of Ratio: GD over BA`[1], 0)
))

kable(table12B, caption="Average annual wages of workers by highest education: Bachelor's degree vs. Graduate degree") %>% kable_paper("hover", full_width = F)
```

#### Data Source and Notes

**Data source:** American Community Survey Public Use Microdata Survey 5-year 2019 dataset, accessed April 2023, available through the U.S. Census Bureau [here](https://www2.census.gov/programs-surveys/acs/data/pums/2019/5-Year/). 

**Timeframe reflected:** The 5-year PUMS data set reflects survey data collected in 2015, 2016, 2017, 2018, and 2019.

**Notes:** This analysis is limited to adults aged 18 to 65 who are in the workforce, including those who are unemployed. Annual wages refer to wages earned over a 12 month period. 

***

### {-}

## Checks on Data Universes and Samples

In this final section, I provide further statistics to check the validity of our data universes and samples. 

*Is the subsample on California households from SHED sufficiently large to draw comparisons across groups?*

The pooled data from SHED that we use contains survey records from 71,710 households nationwide, of which 7,891 (or 11%) are from California. Of those 7,891 California households, 1,117 hold student loan debt.  

Throughout this document, the number of households included in each sub-sample is provided in the "Data Source and Notes" tab of each figure or table. We use the household-level population weights provided by the Federal Reserve to derive estimates of population statistics.

The smallest sub-samples used in our analysis are for California households with student loans, broken down by the racial identity of the survey respondent. In nearly every case, Black student loan borrowers in California are the smallest group. The next-smallest sub-sample is student loan borrowers in California who fall into the "Other, Non-Hispanic" category, which encompasses Asian, Pacific Islander, Native American, and other groups besides white, Hispanic, and Black families. 

Not every survey question has an answer from every respondent, and some questions were not asked in every year in our pooled set. This causes variation in the number of respondents by sub-sample, depending on the variable under focus. What would be a sufficient number of respondents in a given sub-sample for us to feel confident drawing conclusions about differences across groups? For questions such as this, statisticians refer to a study's "power," a measure of sample size that we can apply to the individual analyses in this document. A study that aims to detect an inter-group difference of 5 percent along a key variable needs more power (and thus more subjects) than a study that only aims to detect an inter-group difference of 10 percent or more. More respondents means more power, and it means smaller inter-group differences can be regarded as meaningful. 

Take "Figure 8: Credit Card debt" as an example. It is notable that Black Californians report having credit card debt that they used for their education at a high level (40.2%), more so than do Black adults in the rest of the U.S. (29.8%). The sub-samples contain 107 and 1,713 respondents, respectively. Are those enough to detect a difference of 10.4 percentage points?   


```{r check.SHED1}
pwr.2p2n.test(n1 = NULL, n2 = NULL, sig.level=0.05, power = NULL, alternative="greater")

# Fig 7
pwr.2p2n.test(
  n1 = 450, 
  n2 = 4039, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")

# Fig 9
pwr.2p2n.test(
  n1 = 108, 
  n2 = 1692, 
  sig.level=0.05,
  power = 0.8, 
  alternative="less")

# Fig 11
pwr.2p2n.test(
  n1 = 81, 
  n2 = 235, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")

# Fig 13 
pwr.2p2n.test(
  n1 = 121, 
  n2 = 412, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")

# Fig 14 
pwr.2p2n.test(
  n1 = 120, 
  n2 = 412, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")

# Fig 18
pwr.2p2n.test(
  n1 = 386, 
  n2 = 411, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")
pwr.2p2n.test(
  n1 = 118, 
  n2 = 411, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")

# Fig 19
pwr.2p2n.test(
  n1 = 120, 
  n2 = 412, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")
pwr.2p2n.test(
  n1 = 120, 
  n2 = 1935, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")

# Fig 29
pwr.2p2n.test(
  n1 = 121, 
  n2 = 412, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")

# Fig 22
pwr.2p2n.test(
  n1 = 474, 
  n2 = 385, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")
pwr.2p2n.test(
  n1 = (186 + 112 + 362 + 385), 
  n2 = (758 + 1793 + 1273 + 6585), 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")

# Fig 8
pwr.2p2n.test(
  n1 = 107, 
  n2 = 323, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")

# Fig 15
pwr.2p2n.test(
  n1 = (179 + 107 + 348 + 376), 
  n2 = (980 + 287 + 1457 + 3290), 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")

# Fig 16
pwr.2p2n.test(
  n1 = 102, 
  n2 = 368, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")

# Fig 21
pwr.2p2n.test(
  n1 = 49, 
  n2 = 163, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")
pwr.2p2n.test(
  n1 = 49, 
  n2 = 784, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")
pwr.2p2n.test(
  n1 = 180, 
  n2 = 163, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")

# Fig 26 
pwr.2p2n.test(
  n1 = 119, 
  n2 = 397, 
  sig.level=0.05,
  power = 0.8, 
  alternative="greater")


power.SHED <- data.frame(
  "Measure"= c(NA), 
  "Figure"=c(NA), 
  "Group 1"=c(NA), 
  "Group 2"=c(NA), 
  "N1"=c(NA), 
  "N2"=c(NA),
  "P1"=c(NA), 
  "P2"=c(NA),
  "Difference"=c(NA),
  "Power"=c(NA)
)
names(power.SHED)[3] <- "Group 1" 
names(power.SHED)[4] <- "Group 2" 


# Figure 7
# Code OwnDebt
# Share of households who hold education debt 
# Black households in CA vs. white households in CA
pc.n1 <- N.OwnDebt$`Survey respondents`[(N.OwnDebt$State=="CA") & (N.OwnDebt$Group=="Black, Non-Hispanic")]
pc.n2 <- N.OwnDebt$`Survey respondents`[(N.OwnDebt$State=="CA") & (N.OwnDebt$Group=="White, Non-Hispanic")]
pc.p1 <- tblOwnDebt$`Share with debt`[(tblOwnDebt$State=="CA") & (tblOwnDebt$Race=="Black, Non-Hispanic")]
pc.p2 <- tblOwnDebt$`Share with debt`[(tblOwnDebt$State=="CA") & (tblOwnDebt$Race=="White, Non-Hispanic")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share of households who hold student loan debt", 
  `Figure`="Figure 7", 
  `Group 1`="Black households in CA",
  `Group 2`="White households in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 7
# Code OwnDebt
# Share of households who hold education debt 
# Hispanic households in CA vs. white households in CA 
pc.n1 <- N.OwnDebt$`Survey respondents`[(N.OwnDebt$State=="CA") & (N.OwnDebt$Group=="Hispanic")]
pc.n2 <- N.OwnDebt$`Survey respondents`[(N.OwnDebt$State=="CA") & (N.OwnDebt$Group=="White, Non-Hispanic")]
pc.p1 <- tblOwnDebt$`Share with debt`[(tblOwnDebt$State=="CA") & (tblOwnDebt$Race=="Hispanic")]
pc.p2 <- tblOwnDebt$`Share with debt`[(tblOwnDebt$State=="CA") & (tblOwnDebt$Race=="White, Non-Hispanic")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share of households who hold student loan debt", 
  `Figure`="Figure 7", 
  `Group 1`="Hispanic households in CA",
  `Group 2`="White households in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 8
# Code OwnDebtCC
# Share of borrowers who have education-related credit card debt 
# Hispanic borrowers in CA vs. white borrowers in CA 
pc.n1 <- N.OwnDebtCC$`Survey respondents`[(N.OwnDebtCC$State=="CA") & (N.OwnDebtCC$Group=="Hispanic")]
pc.n2 <- N.OwnDebtCC$`Survey respondents`[(N.OwnDebtCC$State=="CA") & (N.OwnDebtCC$Group=="White, Non-Hispanic")]
pc.p1 <- tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt`[(tblOwnDebtCC$State=="CA") & (tblOwnDebtCC$Race=="Hispanic")]
pc.p2 <- tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt`[(tblOwnDebtCC$State=="CA") & (tblOwnDebtCC$Race=="White, Non-Hispanic")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share of borrowers who hold education-related credit card debt", 
  `Figure`="Figure 8", 
  `Group 1`="Hispanic borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 8
# Code OwnDebtCC
# Share of borrowers who have education-related credit card debt 
# Black borrowers in CA vs. white borrowers in CA 
pc.n1 <- N.OwnDebtCC$`Survey respondents`[(N.OwnDebtCC$State=="CA") & (N.OwnDebtCC$Group=="Black, Non-Hispanic")]
pc.n2 <- N.OwnDebtCC$`Survey respondents`[(N.OwnDebtCC$State=="CA") & (N.OwnDebtCC$Group=="White, Non-Hispanic")]
pc.p1 <- tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt`[(tblOwnDebtCC$State=="CA") & (tblOwnDebtCC$Race=="Black, Non-Hispanic")]
pc.p2 <- tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt`[(tblOwnDebtCC$State=="CA") & (tblOwnDebtCC$Race=="White, Non-Hispanic")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share of borrowers who hold education-related credit card debt", 
  `Figure`="Figure 8", 
  `Group 1`="Black borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 8
# Code OwnDebtCC
# Share of borrowers who have education-related credit card debt 
# Hispanic or Black borrowers in CA vs. white borrowers in CA 
pc.m1 <- N.OwnDebtCC$`Survey respondents`[(N.OwnDebtCC$State=="CA") & (N.OwnDebtCC$Group=="Black, Non-Hispanic")]
pc.m2 <- N.OwnDebtCC$`Survey respondents`[(N.OwnDebtCC$State=="CA") & (N.OwnDebtCC$Group=="Hispanic")]
pc.o1 <- tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt`[(tblOwnDebtCC$State=="CA") & (tblOwnDebtCC$Race=="Black, Non-Hispanic")]
pc.o2 <- tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt`[(tblOwnDebtCC$State=="CA") & (tblOwnDebtCC$Race=="Hispanic")]
pc.n1 <- pc.m1 + pc.m2
pc.n2 <- N.OwnDebtCC$`Survey respondents`[(N.OwnDebtCC$State=="CA") & (N.OwnDebtCC$Group=="White, Non-Hispanic")]
pc.p1 <- (pc.o1 * (pc.m1 / (pc.m1 + pc.m2))) + (pc.o2 * (pc.m2 / (pc.m1 + pc.m2)))
pc.p2 <- tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt`[(tblOwnDebtCC$State=="CA") & (tblOwnDebtCC$Race=="White, Non-Hispanic")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share of borrowers who hold education-related credit card debt", 
  `Figure`="Figure 8", 
  `Group 1`="Black and Hispanic borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.m1", "pc.m2", "pc.o1", "pc.o2", "pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 8
# Code OwnDebtCC
# Share of borrowers who have education-related credit card debt 
# Black borrowers in CA vs. Black borrowers in rest of US 
pc.n1 <- N.OwnDebtCC$`Survey respondents`[(N.OwnDebtCC$State=="CA") & (N.OwnDebtCC$Group=="Black, Non-Hispanic")]
pc.n2 <- N.OwnDebtCC$`Survey respondents`[(N.OwnDebtCC$State=="Rest of U.S.") & (N.OwnDebtCC$Group=="Black, Non-Hispanic")]
pc.p1 <- tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt`[(tblOwnDebtCC$State=="CA") & (tblOwnDebtCC$Race=="Black, Non-Hispanic")]
pc.p2 <- tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt`[(tblOwnDebtCC$State=="Rest of U.S.") & (tblOwnDebtCC$Race=="Black, Non-Hispanic")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share of borrowers who hold education-related credit card debt", 
  `Figure`="Figure 8", 
  `Group 1`="Black borrowers in CA",
  `Group 2`="Black borrowers in rest of U.S.", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 9
# Code OwnDebtTotal
# Share who owe $25K or less 
# Hispanic borrowers in CA vs. white borrowers in CA 
tblOwnDebtTot4 <- reshape2::dcast(data=tblOwnDebtTot3, Race + State ~ variable, value.var="Share of borrowers")
tblOwnDebtTot4 <- tblOwnDebtTot4 %>% mutate(`Less than $25,000` = `Less than $5,000` + `$5,000 to $9,999` + `$10,000 to $14,999` + `$15,000 to $19,999` + `$20,000 to $24,999`)
pc.n1 <- N.OwnDebtTot3$`Survey respondents`[(N.OwnDebtTot3$State=="CA") & (N.OwnDebtTot3$Group=="Hispanic")]
pc.n2 <- N.OwnDebtTot3$`Survey respondents`[(N.OwnDebtTot3$State=="CA") & (N.OwnDebtTot3$Group=="White, Non-Hispanic")]
pc.p1 <- tblOwnDebtTot4$`Less than $25,000`[(tblOwnDebtTot4$State=="CA") & (tblOwnDebtTot4$Race=="Hispanic")]
pc.p2 <- tblOwnDebtTot4$`Less than $25,000`[(tblOwnDebtTot4$State=="CA") & (tblOwnDebtTot4$Race=="White, Non-Hispanic")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share of borrowers who owe $25,000 or less", 
  `Figure`="Figure 9", 
  `Group 1`="Hispanic borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 11
# Code OwnDebtBehind
# Share who are behind on payments 
# Black and Hispanic borrowers in CA vs. white borrowers in CA 
pc.m1 <- N.OwnDebtBehind$`Survey respondents`[(N.OwnDebtBehind$State=="CA") & (N.OwnDebtBehind$Group=="Black, Non-Hispanic")]
pc.m2 <- N.OwnDebtBehind$`Survey respondents`[(N.OwnDebtBehind$State=="CA") & (N.OwnDebtBehind$Group=="Hispanic")]
pc.o1 <- tblOwnDebtBehind$`Share of borrowers behind on payments`[(tblOwnDebtBehind$State=="CA") & (tblOwnDebtBehind$Race=="Black, Non-Hispanic")]
pc.o2 <- tblOwnDebtBehind$`Share of borrowers behind on payments`[(tblOwnDebtBehind$State=="CA") & (tblOwnDebtBehind$Race=="Hispanic")]
pc.n1 <- pc.m1 + pc.m2
pc.n2 <- N.OwnDebtBehind$`Survey respondents`[(N.OwnDebtBehind$State=="CA") & (N.OwnDebtBehind$Group=="White, Non-Hispanic")]
pc.p1 <- (pc.o1 * (pc.m1 / (pc.m1 + pc.m2))) + (pc.o2 * (pc.m2 / (pc.m1 + pc.m2)))
pc.p2 <- tblOwnDebtBehind$`Share of borrowers behind on payments`[(tblOwnDebtBehind$State=="CA") & (tblOwnDebtBehind$Race=="White, Non-Hispanic")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share of borrowers who are behind on payments", 
  `Figure`="Figure 11", 
  `Group 1`="Black and Hispanic borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.m1", "pc.m2", "pc.o1", "pc.o2", "pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 13
# Code EdAttain
# Share who do not have a college degree
# Hispanic borrowers in CA vs. white borrowers in CA 
tblEdAttain2 <- reshape2::dcast(data=tblEdAttain, Race + State + AnyStudentLoans ~ `variable`, value.var="Share of borrowers")
tblEdAttain2 <- tblEdAttain2 %>% mutate(`No college degree` = `Less than high school diploma` + `High school degree or GED` + `Some college, no degree`)
pc.n1 <- N.EdAttain$`Survey respondents`[(N.EdAttain$State=="CA") & (N.EdAttain$Group=="Hispanic") & (N.EdAttain$AnyStudentLoans=="Yes")]
pc.n2 <- N.EdAttain$`Survey respondents`[(N.EdAttain$State=="CA") & (N.EdAttain$Group=="White, Non-Hispanic") & (N.EdAttain$AnyStudentLoans=="Yes")]
pc.p1 <- tblEdAttain2$`No college degree`[(tblEdAttain2$State=="CA") & (tblEdAttain2$Race=="Hispanic") & (tblEdAttain2$tblEdAttain2$AnyStudentLoans=="Yes")]
pc.p2 <- tblEdAttain2$`No college degree`[(tblEdAttain2$State=="CA") & (tblEdAttain2$Race=="White, Non-Hispanic") & (tblEdAttain2$tblEdAttain2$AnyStudentLoans=="Yes")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share without a college degree", 
  `Figure`="Figure 13", 
  `Group 1`="Hispanic borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 14
# Code HomeOwn
# Share who own their home 
# Black borrowers in CA vs. Black borrowers in rest of U.S. 
tblHomeOwn2 <- reshape2::dcast(data=tblHomeOwn, State + Race + AnyStudentLoans ~ variable, value.var="Share of borrowers")
tblHomeOwn2 <- tblHomeOwn2 %>% mutate(`Own home` = `Own home free and clear` + `Own home with a mortgage or loan`)
pc.n1 <- N.HomeOwn$`Survey respondents`[(N.HomeOwn$State=="CA") & (N.HomeOwn$Group=="Black, Non-Hispanic") & (N.HomeOwn$AnyStudentLoans=="Yes")]
pc.n2 <- N.HomeOwn$`Survey respondents`[(N.HomeOwn$State=="Rest of U.S.") & (N.HomeOwn$Group=="Black, Non-Hispanic") & (N.HomeOwn$AnyStudentLoans=="Yes")]
pc.p1 <- tblHomeOwn2$`Own home`[(tblHomeOwn2$State=="CA") & (tblHomeOwn2$Race=="Black, Non-Hispanic") & (tblHomeOwn2$AnyStudentLoans=="Yes")]
pc.p2 <- tblHomeOwn2$`Own home`[(tblHomeOwn2$State=="Rest of U.S.") & (tblHomeOwn2$Race=="Black, Non-Hispanic") & (tblHomeOwn2$AnyStudentLoans=="Yes")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who own their home", 
  `Figure`="Figure 14", 
  `Group 1`="Black borrowers in CA",
  `Group 2`="Black borrowers in rest of U.S.", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 14
# Code HomeOwn
# Share who own their home 
# Black borrowers in CA vs. white borrowers in CA 
pc.n1 <- N.HomeOwn$`Survey respondents`[(N.HomeOwn$State=="CA") & (N.HomeOwn$Group=="Black, Non-Hispanic") & (N.HomeOwn$AnyStudentLoans=="Yes")]
pc.n2 <- N.HomeOwn$`Survey respondents`[(N.HomeOwn$State=="CA") & (N.HomeOwn$Group=="White, Non-Hispanic") & (N.HomeOwn$AnyStudentLoans=="Yes")]
pc.p1 <- tblHomeOwn2$`Own home`[(tblHomeOwn2$State=="CA") & (tblHomeOwn2$Race=="Black, Non-Hispanic") & (tblHomeOwn2$AnyStudentLoans=="Yes")]
pc.p2 <- tblHomeOwn2$`Own home`[(tblHomeOwn2$State=="CA") & (tblHomeOwn2$Race=="White, Non-Hispanic") & (tblHomeOwn2$AnyStudentLoans=="Yes")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who own their home", 
  `Figure`="Figure 14", 
  `Group 1`="Black borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 15
# Code UnpaidCC
# Share who hold unpaid credit card debt 
# Borrowers in CA vs. Non-borrowers in CA
tblUnpaidCC3 <- aggregate(data=shed.UnpaidCC, Weight ~ UnpaidCC + State + AnyStudentLoans, FUN=sum) 
tblUnpaidCC3 <- tblUnpaidCC3 %>% filter(UnpaidCC != "")
tblUnpaidCC3 <- reshape2::dcast(data=tblUnpaidCC3, State + AnyStudentLoans ~ UnpaidCC, value.var="Weight")
tblUnpaidCC3$`Share with unpaid credit card debt` <- tblUnpaidCC3$Yes / (tblUnpaidCC3$Yes + tblUnpaidCC3$No)
pc.n1 <- sum(N.UnpaidCC$`Survey respondents`[(N.UnpaidCC$State=="CA") & (N.UnpaidCC$`Student loan borrower`=="Yes")])
pc.n2 <- sum(N.UnpaidCC$`Survey respondents`[(N.UnpaidCC$State=="CA") & (N.UnpaidCC$`Student loan borrower`=="No")])
pc.p1 <- tblUnpaidCC3$`Share with unpaid credit card debt`[(tblUnpaidCC3$State=="CA") & (tblUnpaidCC3$`AnyStudentLoans`=="Yes")]
pc.p2 <- tblUnpaidCC3$`Share with unpaid credit card debt`[(tblUnpaidCC3$State=="CA") & (tblUnpaidCC3$`AnyStudentLoans`=="No")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who hold unpaid credit card debt", 
  `Figure`="Figure 15", 
  `Group 1`="Borrowers in CA",
  `Group 2`="Non-borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 15
# Code UnpaidCC
# Share who hold unpaid credit card debt
# Black and Hispanic borrowers in CA vs. white borrowers in CA 
pc.m1 <- N.UnpaidCC$`Survey respondents`[(N.UnpaidCC$State=="CA") & (N.UnpaidCC$Group=="Black, Non-Hispanic") & (N.UnpaidCC$`Student loan borrower`=="Yes")]
pc.m2 <- N.UnpaidCC$`Survey respondents`[(N.UnpaidCC$State=="CA") & (N.UnpaidCC$Group=="Hispanic") & (N.UnpaidCC$`Student loan borrower`=="Yes")]
pc.o1 <- tblUnpaidCC$`Share with unpaid credit card debt`[(tblUnpaidCC$State=="CA") & (tblUnpaidCC$Race=="Black, Non-Hispanic") & (tblUnpaidCC$AnyStudentLoans=="Yes")]
pc.o2 <- tblUnpaidCC$`Share with unpaid credit card debt`[(tblUnpaidCC$State=="CA") & (tblUnpaidCC$Race=="Hispanic") & (tblUnpaidCC$AnyStudentLoans=="Yes")]
pc.n1 <- pc.m1 + pc.m2
pc.n2 <- N.UnpaidCC$`Survey respondents`[(N.UnpaidCC$State=="CA") & (N.UnpaidCC$Group=="White, Non-Hispanic") & (N.UnpaidCC$`Student loan borrower`=="Yes")]
pc.p1 <- (pc.o1 * (pc.m1 / (pc.m1 + pc.m2))) + (pc.o2 * (pc.m2 / (pc.m1 + pc.m2)))
pc.p2 <- tblUnpaidCC$`Share with unpaid credit card debt`[(tblUnpaidCC$State=="CA") & (tblUnpaidCC$Race=="White, Non-Hispanic") & (tblUnpaidCC$AnyStudentLoans=="Yes")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who hold unpaid credit card debt", 
  `Figure`="Figure 15", 
  `Group 1`="Black and Hispanic borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.m1", "pc.m2", "pc.o1", "pc.o2", "pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 16 
# Code CCBalance
# Share who carry an unpaid credit card balance at least "some of the time" 
# Black borrowers in CA vs. white borrowers in CA 
tblCCBalance2 <- reshape2::dcast(data=tblCCBalance, Race + State + AnyStudentLoans ~ variable, value.var="Share of borrowers")
tblCCBalance2 <- tblCCBalance2 %>% mutate(`At least some of the time` = `Some of the time` + `Most or all of the time`)
pc.n1 <- N.CCBalance$`Survey respondents`[(N.CCBalance$State=="CA") & (N.CCBalance$Group=="Black, Non-Hispanic") & (N.CCBalance$AnyStudentLoans=="Yes")]
pc.n2 <- N.CCBalance$`Survey respondents`[(N.CCBalance$State=="CA") & (N.CCBalance$Group=="White, Non-Hispanic") & (N.CCBalance$AnyStudentLoans=="Yes")]
pc.p1 <- tblCCBalance2$`At least some of the time`[(tblCCBalance2$State=="CA") & (tblCCBalance2$Race=="Black, Non-Hispanic") & (tblCCBalance2$AnyStudentLoans=="Yes")] 
pc.p2 <-  tblCCBalance2$`At least some of the time`[(tblCCBalance2$State=="CA") & (tblCCBalance2$Race=="White, Non-Hispanic") & (tblCCBalance2$AnyStudentLoans=="Yes")] 
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who carry an unpaid credit card balance at least some of the time", 
  `Figure`="Figure 16", 
  `Group 1`="Black borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 16 
# Code CCBalance
# Share who carry an unpaid credit card balance at least "some of the time" 
# Hispanic borrowers in CA vs. white borrowers in CA
pc.n1 <- N.CCBalance$`Survey respondents`[(N.CCBalance$State=="CA") & (N.CCBalance$Group=="Hispanic") & (N.CCBalance$AnyStudentLoans=="Yes")]
pc.n2 <- N.CCBalance$`Survey respondents`[(N.CCBalance$State=="CA") & (N.CCBalance$Group=="White, Non-Hispanic") & (N.CCBalance$AnyStudentLoans=="Yes")]
pc.p1 <- tblCCBalance2$`At least some of the time`[(tblCCBalance2$State=="CA") & (tblCCBalance2$Race=="Hispanic") & (tblCCBalance2$AnyStudentLoans=="Yes")] 
pc.p2 <- tblCCBalance2$`At least some of the time`[(tblCCBalance2$State=="CA") & (tblCCBalance2$Race=="White, Non-Hispanic") & (tblCCBalance2$AnyStudentLoans=="Yes")] 
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who carry an unpaid credit card balance at least some of the time", 
  `Figure`="Figure 16", 
  `Group 1`="Hispanic borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 16 
# Code CCBalance
# Share who carry an unpaid credit card balance at least "some of the time" 
# Black borrowers in CA vs. Black borrowers outside CA  
pc.n1 <- N.CCBalance$`Survey respondents`[(N.CCBalance$State=="CA") & (N.CCBalance$Group=="Black, Non-Hispanic") & (N.CCBalance$AnyStudentLoans=="Yes")]
pc.n2 <- N.CCBalance$`Survey respondents`[(N.CCBalance$State=="Rest of U.S.") & (N.CCBalance$Group=="Black, Non-Hispanic") & (N.CCBalance$AnyStudentLoans=="Yes")]
pc.p1 <- tblCCBalance2$`At least some of the time`[(tblCCBalance2$State=="CA") & (tblCCBalance2$Race=="Black, Non-Hispanic") & (tblCCBalance2$AnyStudentLoans=="Yes")] 
pc.p2 <- tblCCBalance2$`At least some of the time`[(tblCCBalance2$State=="Rest of U.S.") & (tblCCBalance2$Race=="Black, Non-Hispanic") & (tblCCBalance2$AnyStudentLoans=="Yes")] 
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who carry an unpaid credit card balance at least some of the time", 
  `Figure`="Figure 16", 
  `Group 1`="Black borrowers in CA",
  `Group 2`="Black borrowers in rest of U.S.", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 17
# Code Savings
# Share who have under $50,000
# Black or Hispanic borrowers in CA vs. white borrowers in CA 
pc.o1 <- tblSavings$`Share of borrowers`[(tblSavings$State=="CA") & (tblSavings$Race=="Black, Non-Hispanic") & (tblSavings$AnyStudentLoans=="Yes") & (tblSavings$variable=="Under $50,000")]
pc.o2 <- tblSavings$`Share of borrowers`[(tblSavings$State=="CA") & (tblSavings$Race=="Hispanic") & (tblSavings$AnyStudentLoans=="Yes") & (tblSavings$variable=="Under $50,000")]
pc.m1 <- N.Savings$`Survey respondents`[(N.Savings$State=="CA") & (N.Savings$Group=="Black, Non-Hispanic") & (N.Savings$AnyStudentLoans=="Yes")]
pc.m2 <- N.Savings$`Survey respondents`[(N.Savings$State=="CA") & (N.Savings$Group=="Hispanic") & (N.Savings$AnyStudentLoans=="Yes")]
pc.n1 <- pc.m1 + pc.m2
pc.n2 <- N.Savings$`Survey respondents`[(N.Savings$State=="CA") & (N.Savings$Group=="White, Non-Hispanic") & (N.Savings$AnyStudentLoans=="Yes")]
pc.p1 <- (pc.o1 * (pc.m1 / (pc.m1 + pc.m2))) + (pc.o2 * (pc.m2 / (pc.m1 + pc.m2)))
pc.p2 <- tblSavings$`Share of borrowers`[(tblSavings$State=="CA") & (tblSavings$Race=="White, Non-Hispanic") & (tblSavings$AnyStudentLoans=="Yes") & (tblSavings$variable=="Under $50,000")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who have savings under $50,000", 
  `Figure`="Figure 17", 
  `Group 1`="Black and Hispanic borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.m1", "pc.m2", "pc.o1", "pc.o2", "pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 18
# Code TotalInc
# Share who earn under $75,000 
# Hispanic borrowers in CA vs. white borrowers in CA 
tblTotalInc2 <- reshape2::dcast(data=tblTotalInc, Race + State + AnyStudentLoans ~ variable, value.var="Share of borrowers")
tblTotalInc2 <- tblTotalInc2 %>% mutate(`Under $75,000` = `$0 to $4,999` + `$5,000 to $14,999` + `$15,000 to $24,999` + `$25,000 to $39,999` + `$40,000 to $49,999` + `$50,000 to $74,999`)
pc.n1 <- N.TotalInc$`Survey respondents`[(N.TotalInc$State=="CA") & (N.TotalInc$Group=="Hispanic") & (N.TotalInc$AnyStudentLoans=="Yes")]
pc.n2 <- N.TotalInc$`Survey respondents`[(N.TotalInc$State=="CA") & (N.TotalInc$Group=="White, Non-Hispanic") & (N.TotalInc$AnyStudentLoans=="Yes")]
pc.p1 <- tblTotalInc2$`Under $75,000`[(tblTotalInc2$State=="CA") & (tblTotalInc2$Race=="Hispanic") & (tblTotalInc2$AnyStudentLoans=="Yes")] 
pc.p2 <- tblTotalInc2$`Under $75,000`[(tblTotalInc2$State=="CA") & (tblTotalInc2$Race=="White, Non-Hispanic") & (tblTotalInc2$AnyStudentLoans=="Yes")] 
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who earn under $75,000", 
  `Figure`="Figure 18", 
  `Group 1`="Hispanic borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 18
# Code TotalInc
# Share who earn under $75,000
# Black borrowers in CA vs. white borrowers in CA 
pc.n1 <- N.TotalInc$`Survey respondents`[(N.TotalInc$State=="CA") & (N.TotalInc$Group=="Black, Non-Hispanic") & (N.TotalInc$AnyStudentLoans=="Yes")]
pc.n2 <- N.TotalInc$`Survey respondents`[(N.TotalInc$State=="CA") & (N.TotalInc$Group=="White, Non-Hispanic") & (N.TotalInc$AnyStudentLoans=="Yes")]
pc.p1 <- tblTotalInc2$`Under $75,000`[(tblTotalInc2$State=="CA") & (tblTotalInc2$Race=="Black, Non-Hispanic") & (tblTotalInc2$AnyStudentLoans=="Yes")] 
pc.p2 <- tblTotalInc2$`Under $75,000`[(tblTotalInc2$State=="CA") & (tblTotalInc2$Race=="White, Non-Hispanic") & (tblTotalInc2$AnyStudentLoans=="Yes")] 
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who earn under $75,000", 
  `Figure`="Figure 18", 
  `Group 1`="Black borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 18
# Code TotalInc
# Share who earn under $75,000
# Hispanic or Black borrowers in CA vs. white borrowers in CA
pc.o1 <- tblTotalInc2$`Under $75,000`[(tblTotalInc2$State=="CA") & (tblTotalInc2$Race=="Black, Non-Hispanic") & (tblTotalInc2$AnyStudentLoans=="Yes")] 
pc.o2 <- tblTotalInc2$`Under $75,000`[(tblTotalInc2$State=="CA") & (tblTotalInc2$Race=="Hispanic") & (tblTotalInc2$AnyStudentLoans=="Yes")] 
pc.m1 <- N.TotalInc$`Survey respondents`[(N.TotalInc$State=="CA") & (N.TotalInc$Group=="Black, Non-Hispanic") & (N.TotalInc$AnyStudentLoans=="Yes")]
pc.m2 <- N.TotalInc$`Survey respondents`[(N.TotalInc$State=="CA") & (N.TotalInc$Group=="Hispanic") & (N.TotalInc$AnyStudentLoans=="Yes")]
pc.n1 <- pc.m1 + pc.m2
pc.n2 <- N.TotalInc$`Survey respondents`[(N.TotalInc$State=="CA") & (N.TotalInc$Group=="White, Non-Hispanic") & (N.TotalInc$AnyStudentLoans=="Yes")]
pc.p1 <- (pc.o1 * (pc.m1 / (pc.m1 + pc.m2))) + (pc.o2 * (pc.m2 / (pc.m1 + pc.m2)))
pc.p2 <- tblTotalInc2$`Under $75,000`[(tblTotalInc2$State=="CA") & (tblTotalInc2$Race=="White, Non-Hispanic") & (tblTotalInc2$AnyStudentLoans=="Yes")] 
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who earn under $75,000", 
  `Figure`="Figure 18", 
  `Group 1`="Black or Hispanic borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.m1", "pc.m2", "pc.o1", "pc.o2", "pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 19
# Code FinManage
# Share who report living comfortably 
# Black borrowers in CA vs. white borrowers in CA
pc.n1 <- N.FinManage$`Survey respondents`[(N.FinManage$State=="CA") & (N.FinManage$Group=="Black, Non-Hispanic") & (N.FinManage$AnyStudentLoans=="Yes")]
pc.n2 <- N.FinManage$`Survey respondents`[(N.FinManage$State=="CA") & (N.FinManage$Group=="White, Non-Hispanic") & (N.FinManage$AnyStudentLoans=="Yes")]
pc.p1 <- tblFinManage$`Share of borrowers`[(tblFinManage$State=="CA") & (tblFinManage$Race=="Black, Non-Hispanic") & (tblFinManage$AnyStudentLoans=="Yes") & (tblFinManage$variable=="Living comfortably")]
pc.p2 <- tblFinManage$`Share of borrowers`[(tblFinManage$State=="CA") & (tblFinManage$Race=="White, Non-Hispanic") & (tblFinManage$AnyStudentLoans=="Yes") & (tblFinManage$variable=="Living comfortably")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who report living comfortably", 
  `Figure`="Figure 19", 
  `Group 1`="Black borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 21
# Code CreditScore
# Share who believe their credit score is "poor" or "very poor"
# Black borrowers in CA vs. white borrowers in CA
tblCreditScore2 <- reshape2::dcast(data=tblCreditScore, Race + State + AnyStudentLoans ~ variable, value.var="Share")
tblCreditScore2 <- tblCreditScore2 %>% mutate(`Poor or very poor` = `Poor` + `Very poor`)
pc.n1 <- N.CreditScore$`Survey respondents`[(N.CreditScore$State=="CA") & (N.CreditScore$Group=="Black, Non-Hispanic") & (N.CreditScore$AnyStudentLoans=="Yes")]
pc.n2 <- N.CreditScore$`Survey respondents`[(N.CreditScore$State=="CA") & (N.CreditScore$Group=="White, Non-Hispanic") & (N.CreditScore$AnyStudentLoans=="Yes")]
pc.p1 <- tblCreditScore2$`Poor or very poor`[(tblCreditScore2$State=="CA") & (tblCreditScore2$Race=="Black, Non-Hispanic") & (tblCreditScore2$AnyStudentLoans=="Yes")]
pc.p2 <- tblCreditScore2$`Poor or very poor`[(tblCreditScore2$State=="CA") & (tblCreditScore2$Race=="White, Non-Hispanic") & (tblCreditScore2$AnyStudentLoans=="Yes")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who report living comfortably", 
  `Figure`="Figure 21", 
  `Group 1`="Black borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 21
# Code CreditScore
# Share who believe their credit score is "poor" or "very poor"
# Black borrowers in CA vs. Black borrowers in rest of US 
pc.n1 <- N.CreditScore$`Survey respondents`[(N.CreditScore$State=="CA") & (N.CreditScore$Group=="Black, Non-Hispanic") & (N.CreditScore$AnyStudentLoans=="Yes")]
pc.n2 <- N.CreditScore$`Survey respondents`[(N.CreditScore$State=="Rest of U.S.") & (N.CreditScore$Group=="Black, Non-Hispanic") & (N.CreditScore$AnyStudentLoans=="Yes")]
pc.p1 <- tblCreditScore2$`Poor or very poor`[(tblCreditScore2$State=="CA") & (tblCreditScore2$Race=="Black, Non-Hispanic") & (tblCreditScore2$AnyStudentLoans=="Yes")]
pc.p2 <- tblCreditScore2$`Poor or very poor`[(tblCreditScore2$State=="Rest of U.S.") & (tblCreditScore2$Race=="Black, Non-Hispanic") & (tblCreditScore2$AnyStudentLoans=="Yes")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who report living comfortably", 
  `Figure`="Figure 21", 
  `Group 1`="Black borrowers in CA",
  `Group 2`="Black borrowers in rest of U.S.", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 22
# Code PayBills
# Share who say that they cannot pay all their month's bills in full 
# Borrowers in CA vs. borrowers in rest of US 
tblPayBills3 <- aggregate(data=shed.PayBills, Weight ~ PayBills + State + AnyStudentLoans, FUN=sum)
tblPayBills3 <- reshape2::dcast(data=tblPayBills3, State + AnyStudentLoans ~ PayBills, value.var="Weight")
tblPayBills3$`Total weight` <- tblPayBills3$`I cannot pay some bills or will only make a partial payment on them` + tblPayBills3$`I will be able to pay all of my bills in full`
tblPayBills3$`I cannot pay some bills or will only make a partial payment on them` <- tblPayBills3$`I cannot pay some bills or will only make a partial payment on them` / tblPayBills3$`Total weight`
tblPayBills3$`I will be able to pay all of my bills in full` <- tblPayBills3$`I will be able to pay all of my bills in full` / tblPayBills3$`Total weight`
pc.n1 <- sum(N.PayBills$`Survey respondents`[(N.PayBills$State=="CA") & (N.PayBills$`Student loan borrower`=="Yes")])
pc.n2 <- sum(N.PayBills$`Survey respondents`[(N.PayBills$State=="CA") & (N.PayBills$`Student loan borrower`=="No")])
pc.p1 <- tblPayBills3$`I cannot pay some bills or will only make a partial payment on them`[(tblPayBills3$State=="CA") & (N.PayBills3$`AnyStudentLoans`=="Yes")]
pc.p2 <- tblPayBills3$`I cannot pay some bills or will only make a partial payment on them`[(tblPayBills3$State=="CA") & (N.PayBills3$`AnyStudentLoans`=="No")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who cannot pay all their month's bills in full ", 
  `Figure`="Figure 22", 
  `Group 1`="Borrowers in CA",
  `Group 2`="Non-borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 22
# Code PayBills
# Share who say that they cannot pay all their month's bills in full 
# Black and Hispanic borrowers in CA vs. white borrowers in CA 
pc.m1 <- N.PayBills$`Survey respondents`[(N.PayBills$State=="CA") & (N.PayBills$Group=="Black, Non-Hispanic") & (N.PayBills$`Student loan borrower`=="Yes")]
pc.m2 <- N.PayBills$`Survey respondents`[(N.PayBills$State=="CA") & (N.PayBills$Group=="Hispanic") & (N.PayBills$`Student loan borrower`=="Yes")]
pc.o1 <- tblPayBills$Share[(tblPayBills$State=="CA") & (tblPayBills$Race=="Black, Non-Hispanic") & (tblPayBills$AnyStudentLoans=="Yes") & (tblPayBills$variable=="I cannot pay some bills or will only make a partial payment on them")]
pc.o2 <- tblPayBills$Share[(tblPayBills$State=="CA") & (tblPayBills$Race=="Hispanic") & (tblPayBills$AnyStudentLoans=="Yes") & (tblPayBills$variable=="I cannot pay some bills or will only make a partial payment on them")]
pc.n1 <- pc.m1 + pc.m2
pc.n2 <- N.PayBills$`Survey respondents`[(N.PayBills$State=="CA") & (N.PayBills$Group=="White, Non-Hispanic") & (N.PayBills$`Student loan borrower`=="Yes")]
pc.p1 <- (pc.o1 * (pc.m1 / (pc.m1 + pc.m2))) + (pc.o2 * (pc.m2 / (pc.m1 + pc.m2)))
pc.p2 <- tblPayBills$Share[(tblPayBills$State=="CA") & (tblPayBills$Race=="White, Non-Hispanic") & (tblPayBills$AnyStudentLoans=="Yes") & (tblPayBills$variable=="I cannot pay some bills or will only make a partial payment on them")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who cannot pay all their month's bills in full ", 
  `Figure`="Figure 22", 
  `Group 1`="Black and Hispanic borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.m1", "pc.m2", "pc.o1", "pc.o2", "pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 26
# Code CCApprov
# Share who are "very confident" they would be approved for a credit card
# Black and Hispanic borrowers in CA vs. white borrowers in CA 
pc.m1 <- N.CCApprov$`Survey respondents`[(N.CCApprov$State=="CA") & (N.CCApprov$Group=="Black, Non-Hispanic") & (N.CCApprov$`Student loan borrower`=="Yes")]
pc.m2 <- N.CCApprov$`Survey respondents`[(N.CCApprov$State=="CA") & (N.CCApprov$Group=="Hispanic") & (N.CCApprov$`Student loan borrower`=="Yes")]
pc.o1 <- tblCCApprov$Share[(tblCCApprov$State=="CA") & (tblCCApprov$Race=="Black, Non-Hispanic") & (tblCCApprov$AnyStudentLoans=="Yes") & (tblCCApprov$variable=="Very confident")]
pc.o2 <- tblCCApprov$Share[(tblCCApprov$State=="CA") & (tblCCApprov$Race=="Hispanic") & (tblCCApprov$AnyStudentLoans=="Yes") & (tblCCApprov$variable=="Very confident")]
pc.n1 <- pc.m1 + pc.m2
pc.n2 <- N.CCApprov$`Survey respondents`[(N.CCApprov$State=="CA") & (N.CCApprov$Group=="White, Non-Hispanic") & (N.CCApprov$`Student loan borrower`=="Yes")]
pc.p1 <- (pc.o1 * (pc.m1 / (pc.m1 + pc.m2))) + (pc.o2 * (pc.m2 / (pc.m1 + pc.m2)))
pc.p2 <- tblCCApprov$Share[(tblCCApprov$State=="CA") & (tblCCApprov$Race=="White, Non-Hispanic") & (tblCCApprov$AnyStudentLoans=="Yes") & (tblCCApprov$variable=="Very confident")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who are very confident they would be approved for a credit card", 
  `Figure`="Figure 26", 
  `Group 1`="Black and Hispanic borrowers in CA",
  `Group 2`="White borrowers in CA", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.m1", "pc.m2", "pc.o1", "pc.o2", "pc.n1", "pc.n2", "pc.p1", "pc.p2")

# Figure 29
# Code ThreeMonExpenses
# Share who could replace 3 months of income using savings
# Black borrowers in CA vs. white borrowers in CA
pc.n1 <- N.ThreeMonExpenses$`Survey respondents`[(N.ThreeMonExpenses$State=="CA") & (N.ThreeMonExpenses$Group=="Black, Non-Hispanic") & (N.ThreeMonExpenses$AnyStudentLoans=="Yes")]
pc.n2 <- N.ThreeMonExpenses$`Survey respondents`[(N.ThreeMonExpenses$State=="CA") & (N.ThreeMonExpenses$Group=="White, Non-Hispanic") & (N.ThreeMonExpenses$AnyStudentLoans=="Yes")]
pc.p1 <- tblThreeMonExpenses$`Share`[(tblThreeMonExpenses$State=="CA") & (tblThreeMonExpenses$Race=="Black, Non-Hispanic") & (tblThreeMonExpenses$AnyStudentLoans=="Yes") & (tblThreeMonExpenses$variable=="I cannot replace the income needed for three months of expenses")]
pc.p2 <- tblThreeMonExpenses$`Share`[(tblThreeMonExpenses$State=="CA") & (tblThreeMonExpenses$Race=="White, Non-Hispanic") & (tblThreeMonExpenses$AnyStudentLoans=="Yes") & (tblThreeMonExpenses$variable=="I cannot replace the income needed for three months of expenses")]
power.SHED <- power.SHED %>% add_row(
  `Measure`="Share who report living comfortably", 
  `Figure`="Figure 21", 
  `Group 1`="Black borrowers in CA",
  `Group 2`="Black borrowers in rest of U.S.", 
  `N1`=pc.n1, `N2`=pc.n2, `P1`=percent(pc.p1, accuracy=0.1), `P2`=percent(pc.p2, accuracy=0.1), `Difference`= percent((pc.p1 - pc.p2), accuracy=0.1), 
  `Power`=pwr.2p2n.test(n1 = pc.n1, n2 = pc.n2, h = (pc.p1 - pc.p2), sig.level=0.05, alternative="greater")$power
)
rm("pc.n1", "pc.n2", "pc.p1", "pc.p2")
# Black borrowers in CA vs. Black borrowers in rest of US




power.SHED <- power.SHED %>% filter(is.na(`Measure`)==FALSE)
```
*Is the SHED sample sufficiently representative of California households?*
```{r check.SHED2}
```
*To what extent are the aggregate statistics based on FSA data influenced by individual institutions?* 
```{r check.FSA1}
```
*To what extent are the aggregate statistics based on College Scorecard data influenced by individual institutions?*
```{r check.Scorecard1}
```
*How strong is our confidence in the statistics derived from NPSAS?*
```{r check.NPSAS1}
```

<!-- The code chunks below are for anlayses that are not included in this report but are included in the accompanying policy report.  -->

```{r forPolicyReport6, eval=FALSE}
# This dataset comes from the following site: https://www.politico.com/news/2023/02/16/joe-biden-student-debt-relief-00083243 
politico.data <- read.delim("Student Loan Forgiveness by ZIP.txt", sep='\t')
names(politico.data) <- c("ZIP", "Application count")
politico.data$ZIP <- as.numeric(politico.data$ZIP)
politico.data <- politico.data %>% filter(is.na(ZIP)==FALSE)
# This dataset comes from the following site: https://data.census.gov/table?t=Age+and+Sex:Educational+Attainment&g=0100000US$8600000&tid=ACSDT5Y2021.B15001 
education.data <- fread("ACSDT5Y2021.B15001-Data.csv", header=TRUE, select=c("NAME", "B15001_049E", "B15001_050E", "B15001_051E", "B15001_048E", "B15001_057E", "B15001_058E", "B15001_059E", "B15001_056E", "B15001_065E", "B15001_066E", "B15001_067E", "B15001_064E", "B15001_073E", "B15001_074E", "B15001_075E", "B15001_072E", "B15001_081E", "B15001_082E", "B15001_083E", "B15001_080E", "B15001_008E", "B15001_009E", "B15001_010E", "B15001_007E", "B15001_016E", "B15001_017E", "B15001_018E", "B15001_015E", "B15001_024E", "B15001_025E", "B15001_026E", "B15001_023E", "B15001_032E", "B15001_033E", "B15001_034E", "B15001_031E", "B15001_040E","B15001_041E", "B15001_042E", "B15001_039E"))
names(education.data)[1] <- "ZIP"
education.data$B15001_049E <- as.numeric(education.data$B15001_049E)
education.data$B15001_050E <- as.numeric(education.data$B15001_050E)
education.data$B15001_051E <- as.numeric(education.data$B15001_051E)
education.data$B15001_048E <- as.numeric(education.data$B15001_048E)
education.data$B15001_057E <- as.numeric(education.data$B15001_057E)
education.data$B15001_058E <- as.numeric(education.data$B15001_058E)
education.data$B15001_059E <- as.numeric(education.data$B15001_059E)
education.data$B15001_056E <- as.numeric(education.data$B15001_056E)
education.data$B15001_065E <- as.numeric(education.data$B15001_065E)
education.data$B15001_066E <- as.numeric(education.data$B15001_066E)
education.data$B15001_067E <- as.numeric(education.data$B15001_067E)
education.data$B15001_064E <- as.numeric(education.data$B15001_064E)
education.data$B15001_073E <- as.numeric(education.data$B15001_073E)
education.data$B15001_074E <- as.numeric(education.data$B15001_074E)
education.data$B15001_075E <- as.numeric(education.data$B15001_075E)
education.data$B15001_072E <- as.numeric(education.data$B15001_072E)
education.data$B15001_081E <- as.numeric(education.data$B15001_081E)
education.data$B15001_082E <- as.numeric(education.data$B15001_082E)
education.data$B15001_083E <- as.numeric(education.data$B15001_083E)
education.data$B15001_080E <- as.numeric(education.data$B15001_080E)
education.data$B15001_008E <- as.numeric(education.data$B15001_008E)
education.data$B15001_009E <- as.numeric(education.data$B15001_009E)
education.data$B15001_010E <- as.numeric(education.data$B15001_010E)
education.data$B15001_007E <- as.numeric(education.data$B15001_007E)
education.data$B15001_016E <- as.numeric(education.data$B15001_016E)
education.data$B15001_017E <- as.numeric(education.data$B15001_017E)
education.data$B15001_018E <- as.numeric(education.data$B15001_018E)
education.data$B15001_015E <- as.numeric(education.data$B15001_015E)
education.data$B15001_024E <- as.numeric(education.data$B15001_024E)
education.data$B15001_025E <- as.numeric(education.data$B15001_025E)
education.data$B15001_026E <- as.numeric(education.data$B15001_026E)
education.data$B15001_023E <- as.numeric(education.data$B15001_023E)
education.data$B15001_032E <- as.numeric(education.data$B15001_032E)
education.data$B15001_033E <- as.numeric(education.data$B15001_033E)
education.data$B15001_034E <- as.numeric(education.data$B15001_034E)
education.data$B15001_031E <- as.numeric(education.data$B15001_031E)
education.data$B15001_040E <- as.numeric(education.data$B15001_040E)
education.data$B15001_041E <- as.numeric(education.data$B15001_041E)
education.data$B15001_042E <- as.numeric(education.data$B15001_042E)
education.data$B15001_039E <- as.numeric(education.data$B15001_039E)
education.data <- education.data %>% mutate(`College-educated population aged 18 or older` = B15001_049E + B15001_050E + B15001_051E + B15001_048E + B15001_057E + B15001_058E + B15001_059E + B15001_056E + B15001_065E + B15001_066E + B15001_067E + B15001_064E + B15001_073E + B15001_074E + B15001_075E + B15001_072E + B15001_081E + B15001_082E + B15001_083E + B15001_080E + B15001_008E + B15001_009E + B15001_010E + B15001_007E + B15001_016E + B15001_017E + B15001_018E + B15001_015E + B15001_024E + B15001_025E + B15001_026E + B15001_023E + B15001_032E + B15001_033E + B15001_034E + B15001_031E + B15001_040E + B15001_041E + B15001_042E + B15001_039E)
education.data$ZIP <- gsub("ZCTA5 ", "", education.data$ZIP)
education.data$ZIP <- as.numeric(education.data$ZIP)
education.data <- education.data %>% select(ZIP, `College-educated population aged 18 or older`) %>% filter(is.na(ZIP)==FALSE)

# This dataset comes from the following site: https://data.census.gov/table?q=income+per+capita&t=Income+(Households,+Families,+Individuals)&g=0100000US$8600000&tid=ACSST5Y2021.S1902 
income.data <- fread("ACSST5Y2021.S1902-Data.csv", header=TRUE, select=c("NAME", "S1902_C03_001E"))
names(income.data) <- c("ZIP", "Mean household income")
income.data$ZIP <- gsub("ZCTA5 ", "", income.data$ZIP)
income.data$ZIP <- as.numeric(income.data$ZIP)
income.data$`Mean household income` <- as.numeric(income.data$`Mean household income`)
income.data <- income.data %>% filter(is.na(ZIP)==FALSE)

# This dataset comes from the following site: https://data.census.gov/table?g=0100000US$8600000&tid=ACSST5Y2021.S0101 
# population.data <- fread("ACSST5Y2021.S0101-Data.csv", header=TRUE, select=c("NAME", "S0101_C01_006E", "S0101_C01_007E", "S0101_C01_008E", "S0101_C01_009E", "S0101_C01_010E", "S0101_C01_011E", "S0101_C01_012E", "S0101_C01_013E"))
# names(population.data) <- as.character(population.data[1, 1:9])
# names(population.data) <- gsub("Estimate!!Total!!Total population!!AGE!!", "", names(population.data))
# names(population.data)[1] <- "ZIP"
# population.data$ZIP <- gsub("ZCTA5 ", "", population.data$ZIP)
# population.data$ZIP <- as.numeric(population.data$ZIP)
# population.data$`20 to 24 years` <- as.numeric(population.data$`20 to 24 years`)
# population.data$`25 to 29 years` <- as.numeric(population.data$`25 to 29 years`)
# population.data$`30 to 34 years` <- as.numeric(population.data$`30 to 34 years`)
# population.data$`35 to 39 years` <- as.numeric(population.data$`35 to 39 years`)
# population.data$`40 to 44 years` <- as.numeric(population.data$`40 to 44 years`)
# population.data$`45 to 49 years` <- as.numeric(population.data$`45 to 49 years`)
# population.data$`50 to 54 years` <- as.numeric(population.data$`50 to 54 years`)
# population.data$`55 to 59 years` <- as.numeric(population.data$`55 to 59 years`)
# population.data <- population.data %>% mutate(`Population aged 20 to 59 years` = `20 to 24 years` + `25 to 29 years` + `30 to 34 years` + `35 to 39 years` + `40 to 44 years` + `45 to 49 years` + `50 to 54 years` + `55 to 59 years`)
# population.data <- population.data %>% select(`ZIP`, `Population aged 20 to 59 years`)

# This dataset comes from the following site: https://data.census.gov/table?t=Poverty&g=0100000US$8600000&tid=ACSST5Y2021.S1701 
# poverty.data <- fread("ACSST5Y2021.S1701-Data.csv", header=TRUE, select=c("NAME", "S1701_C01_001E", "S1701_C02_001E"))
# names(poverty.data) <- as.character(c(poverty.data[1, 1], poverty.data[1, 2], poverty.data[1, 3]))
# names(poverty.data) <- gsub("!!Population for whom poverty status is determined", "", names(poverty.data))
# names(poverty.data) <- gsub("!!", " - ", names(poverty.data))
# names(poverty.data)[1] <- "ZIP"
# poverty.data$ZIP <- gsub("ZCTA5 ", "", poverty.data$ZIP)
# poverty.data$ZIP <- as.numeric(poverty.data$ZIP)
# poverty.data$`Estimate - Total` <- as.numeric(poverty.data$`Estimate - Total`)
# poverty.data$`Estimate - Below poverty level` <- as.numeric(poverty.data$`Estimate - Below poverty level`)
# poverty.data <- poverty.data %>% filter(is.na(ZIP)==FALSE)

merged <- full_join(x=politico.data, y=education.data, by="ZIP")
merged <- full_join(x=merged, y=income.data, by="ZIP")
merged <- merged %>% filter(ZIP %in% (90000:96199)) # California zip codes
merged <- merged %>% mutate(`Share who applied` = `Application count` / `College-educated population aged 18 or older`)

merged <- merged %>% mutate(`Income under $95,000` = ifelse(`Mean household income` < 95000, 1, 0))
merged <- merged %>% mutate(`Income under $75,000` = ifelse(`Mean household income` < 75000, 1, 0))
merged <- merged %>% mutate(`Income under $60,000` = ifelse(`Mean household income` < 60000, 1, 0))
merged <- merged %>% mutate(`Income under $50,000` = ifelse(`Mean household income` < 50000, 1, 0))
merged <- merged %>% mutate(`Income under $40,000` = ifelse(`Mean household income` < 40000, 1, 0))

agg0 <- aggregate(data=merged, cbind(`Application count`, `College-educated population aged 18 or older`) ~ `Income under $95,000`, FUN=sum) %>% mutate(`Share who applied` = `Application count` / `College-educated population aged 18 or older`)
agg1 <- aggregate(data=merged, cbind(`Application count`, `College-educated population aged 18 or older`) ~ `Income under $75,000`, FUN=sum) %>% mutate(`Share who applied` = `Application count` / `College-educated population aged 18 or older`)
agg2 <- aggregate(data=merged, cbind(`Application count`, `College-educated population aged 18 or older`) ~ `Income under $60,000`, FUN=sum) %>% mutate(`Share who applied` = `Application count` / `College-educated population aged 18 or older`)
agg3 <- aggregate(data=merged, cbind(`Application count`, `College-educated population aged 18 or older`) ~ `Income under $50,000`, FUN=sum) %>% mutate(`Share who applied` = `Application count` / `College-educated population aged 18 or older`)
agg4 <- aggregate(data=merged, cbind(`Application count`, `College-educated population aged 18 or older`) ~ `Income under $40,000`, FUN=sum) %>% mutate(`Share who applied` = `Application count` / `College-educated population aged 18 or older`)
```

```{r forPolicyReport7, eval=FALSE}
effy2021 <- fread("effy2021.csv", header=TRUE, select=c(
  "UNITID",
  "EFFYALEV",
  "EFYTOTLT",
  "EFYAIANT",
  "EFYASIAT",
  "EFYBKAAT",
  "EFYHISPT",
  "EFYNHPIT",
  "EFYWHITT",
  "EFY2MORT",
  "EFYUNKNT",
  "EFYNRALT"
)) %>% filter(EFFYALEV==1)
hd2021 <- fread("hd2021.csv", header=TRUE, select=c(
  "UNITID", 
  "SECTOR",
  "STABBR"
))
effy2021 <- left_join(x=effy2021, y=hd2021, by="UNITID")
effy2021 <- effy2021 %>% filter((SECTOR %in% c(4, 7))==FALSE) # Filtering out community colleges
agg1 <- aggregate(data=effy2021, cbind(EFYTOTLT,  EFYAIANT,  EFYASIAT,  EFYBKAAT,  EFYHISPT,  EFYNHPIT,  EFYWHITT,  EFY2MORT,  EFYUNKNT,  EFYNRALT) ~ STABBR, FUN=sum)
agg1 <- agg1 %>% filter(STABBR=="CA")
agg1 <- reshape2::melt(data=agg1, id.vars=c("STABBR"))
agg1 <- agg1 %>% mutate(`Enrollment share` = percent(`value` / (agg1$value[1] - (agg1$value[9] + agg1$value[10])), accuracy=0.01))
agg1 <- agg1 %>% filter((variable %in% c("EFYTOTLT", "EFYNRALT", "EFYUNKNT"))==FALSE)

pusa21 <- fread("psam_pusa_2021.csv", header=TRUE, select=c(
  "SERIALNO",
  "ST",
  "PWGTP",
  "RAC1P", 
  "HISP", 
  "AGEP"
)) 
pusb21 <- fread("psam_pusb_2021.csv", header=TRUE, select=c(
  "SERIALNO",
  "ST",
  "PWGTP",
  "RAC1P", 
  "HISP", 
  "AGEP"
)) 
pusm2021 <- rbind(pusa21, pusb21)
pusm2021 <- pusm2021 %>% filter(AGEP %in% (18:35)) # Age condition
pusm2021 <- pusm2021 %>% filter(ST==6)
pusm2021$Group <- rep(NA, nrow(pusm2021))
pusm2021$Group[pusm2021$HISP > 1] <- "Latino/a"
pusm2021$Group[(pusm2021$HISP==1) & (pusm2021$RAC1P %in% c(1))] <- "White"
pusm2021$Group[(pusm2021$HISP==1) & (pusm2021$RAC1P %in% c(2))] <- "Black"
pusm2021$Group[(pusm2021$HISP==1) & (pusm2021$RAC1P %in% c(3, 4, 5))] <- "Native American"
pusm2021$Group[(pusm2021$HISP==1) & (pusm2021$RAC1P %in% c(6, 7))] <- "AAPI"
pusm2021$Group[(pusm2021$HISP==1) & (pusm2021$RAC1P %in% c(8, 9))] <- "Other / more than one race"
agg2 <- aggregate(data=pusm2021, PWGTP ~ Group, FUN=sum)
agg2 <- agg2 %>% mutate(`Population share` = percent(`PWGTP` / sum(agg2$PWGTP), accuracy=0.01))


```


