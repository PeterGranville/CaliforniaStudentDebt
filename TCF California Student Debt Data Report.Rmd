---
title: "What the Data Do - and Do Not - Tell Us About Student Debt in California"
author: "Peter Granville"
date: 'December 2022'
output:
  html_document:
    toc: true
    toc_depth: 2
    theme: cosmo

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(knitr)
library(shiny)
library(scales)
library(plotly)
library(stringr)
library(ggplot2)
library(reshape2)
library(data.table)
```

## Introduction

This report accompanies The Century Foundation's report "Exact Title TBD: Student Debt and Race in California," which examines how student debt puts outsized financial burdens on Black and Latino families in California, especially for graduate borrowers and parents. 

While California lawmakers rightly draw on national research on student debt and race, the state-specific analyses we conduct in this research can help guide state policy that accounts for the distinct patterns of borrowing in California. In particular, these analyses draw attention to the effects of uncapped Parent PLUS and Grad PLUS loans on California's families.

In this report, we walk through the details of the data that underlie that report and explain in greater depth what we do and do not know about student debt in California. Our analysis relies on four sources:

* The Federal Student Aid (FSA) Data Center
* The National Postsecondary Student Aid Study (NPSAS)
* The Survey of Household Economics and Decisionmaking (SHED)
* The College Scorecard

We also draw from the Integrated Postsecondary Education Data System (IPEDS) and the American Community Survey (ACS) to lesser extents. 

The structure of this data-focused report mirrors that of the policy-focused report: the charts and tables in the policy report draw from our four primary data sources in the same order that they are presented here. The first figures in the report draw from the FSA Data Center, and they are followed by figures that draw from NPSAS, and so on. This report is not a static PDF: you can toggle between different versions of charts and hover over barcharts and scatterplots to reveal data points. 

The code used to produce this document and its charts and tables can be found at [this GitHub repository](https://github.com/PeterGranville/CaliforniaStudentDebt). All data sets used in this report are publicly available, courtesy of the U.S. Department of Education, the U.S. Federal Reserve, and the U.S. Census Bureau. 

For any questions, please email [granville@tcf.org](granville@tcf.org). 

## Federal Student Aid Data Center

#### About the data

The FSA Data Center is a repository of data and statistics on federal student aid, including spreadsheets on student loans reported directly from the National Student Loan Data System. For this analysis we use two files from the FSA Data Center: 

* Quarterly reports on the federal student loan portfolio by borrower location, [available here](https://studentaid.gov/data-center/student/portfolio). 
* Quarterly reports on Direct Loan disbursements and borrowers by program at the level of the institution, [available here](https://studentaid.gov/data-center/student/title-iv). 

For "per capita" measures of student debt and borrowing below, the population for comparison is the estimated total of all California adults aged 18 to 50, using American Community Survey data reflecting calendar year 2021, [available here](https://www.census.gov/programs-surveys/acs/microdata/access.html). 

#### Findings

```{r statenames}

######################################################
### We start with some basic setup. First we make  ###
### a dataframe that relates two-digit state codes ###
### to state names. This will be useful while      ###
### working with PUMS data.                        ###
######################################################

statenames <- data.frame("ST"=c(
  01,     # .Alabama/AL
  02,     # .Alaska/AK
  04,     # .Arizona/AZ
  05,     # .Arkansas/AR
  06,     # .California/CA
  08,     # .Colorado/CO
  09,     # .Connecticut/CT
  10,     # .Delaware/DE
  11,     # .District of Columbia/DC
  12,     # .Florida/FL
  13,     # .Georgia/GA
  15,     # .Hawaii/HI
  16,     # .Idaho/ID
  17,     # .Illinois/IL
  18,     # .Indiana/IN
  19,     # .Iowa/IA
  20,     # .Kansas/KS
  21,     # .Kentucky/KY
  22,     # .Louisiana/LA
  23,     # .Maine/ME
  24,     # .Maryland/MD
  25,     # .Massachusetts/MA
  26,     # .Michigan/MI
  27,     # .Minnesota/MN
  28,     # .Mississippi/MS
  29,     # .Missouri/MO
  30,     # .Montana/MT
  31,     # .Nebraska/NE
  32,     # .Nevada/NV
  33,     # .New Hampshire/NH
  34,     # .New Jersey/NJ
  35,     # .New Mexico/NM
  36,     # .New York/NY
  37,     # .North Carolina/NC
  38,     # .North Dakota/ND
  39,     # .Ohio/OH
  40,     # .Oklahoma/OK
  41,     # .Oregon/OR
  42,     # .Pennsylvania/PA
  44,     # .Rhode Island/RI
  45,     # .South Carolina/SC
  46,     # .South Dakota/SD
  47,     # .Tennessee/TN
  48,     # .Texas/TX
  49,     # .Utah/UT
  50,     # .Vermont/VT
  51,     # .Virginia/VA
  53,     # .Washington/WA
  54,     # .West Virginia/WV
  55,     # .Wisconsin/WI
  56,     # .Wyoming/WY
  72     # .Puerto Rico/PR
), "State"=c(
  "Alabama",
  "Alaska",
  "Arizona",
  "Arkansas",
  "California",
  "Colorado",
  "Connecticut",
  "Delaware",
  "District of Columbia",
  "Florida",
  "Georgia",
  "Hawaii",
  "Idaho",
  "Illinois",
  "Indiana",
  "Iowa",
  "Kansas",
  "Kentucky",
  "Louisiana",
  "Maine",
  "Maryland",
  "Massachusetts",
  "Michigan",
  "Minnesota",
  "Mississippi",
  "Missouri",
  "Montana",
  "Nebraska",
  "Nevada",
  "New Hampshire",
  "New Jersey",
  "New Mexico",
  "New York",
  "North Carolina",
  "North Dakota",
  "Ohio",
  "Oklahoma",
  "Oregon",
  "Pennsylvania",
  "Rhode Island",
  "South Carolina",
  "South Dakota",
  "Tennessee",
  "Texas",
  "Utah",
  "Vermont",
  "Virginia",
  "Washington",
  "West Virginia",
  "Wisconsin",
  "Wyoming",
  "Puerto Rico"))
```

```{r pums}
######################################################
### Here we load in person-level data from every   ###
### state, merging the two datasets that contain   ###
### the sample. This is useful for later.          ###
######################################################

pusa <- fread("psam_pusa_2021.csv", header=TRUE, select=c("SERIALNO", "ST", "AGEP", "PWGTP"))
pusb <- fread("psam_pusb_2021.csv", header=TRUE, select=c("SERIALNO", "ST", "AGEP", "PWGTP"))
pusm <- rbind(pusa, pusb)
rm("pusa", "pusb")
```

```{r interstateComp}

######################################################
### Because we will present these results in two   ###
### tables, we first create the tables.            ###
######################################################

interstateComp <- data.frame(
  "X1" = c(NA), 
  "X2" = c(NA), 
  "X3" = c(NA), 
  "X4" = c(NA)
)
names(interstateComp) <- c("Measure", "50-state median", "California value", "California rank")

scaleCali <- data.frame(
  "X1" = c(NA), 
  "X2" = c(NA), 
  "X3" = c(NA), 
  "X4" = c(NA)
)
names(scaleCali) <- c("Measure", "U.S. total", "California value", "California share")

######################################################
### Next we load in the FSA data on student loan   ###
### portfolio by state.                            ###
######################################################

portfolio <- fread("Portfolio-by-Location.csv", header=TRUE, skip=5, nrow=54)

######################################################
### Now we convert the units of the data.          ###
######################################################

portfolio$`Balance (in billions)` <- portfolio$`Balance (in billions)` * 1000000000
portfolio$`Borrowers (in thousands)` <- portfolio$`Borrowers (in thousands)` * 1000
names(portfolio) <- c("State", "Balance", "Borrowers")

######################################################
### We derive a per-borrower "average balance"     ###
### measure for every state.                       ###
######################################################

portfolio$`Average balance` <- portfolio$Balance / portfolio$Borrowers

######################################################
### We also remove non-state entries in the list.  ###
### Before doing so we save the total borrowers    ###
### and total debt for later.                      ###
######################################################

totalDebt <- sum(portfolio$Balance)
totalBorrowers <- sum(portfolio$Borrowers)
portfolio <- portfolio %>% filter(State != "Other") %>% filter(State != "Not Reported")

######################################################
### Now we want to consider the portfolio on a     ###
### per-capita basis.                              ###
######################################################

######################################################
### Most debt is held by those 18 to 50, so we     ###
### divide total debt by state by the aggregated   ###
### total of people aged 18 to 50 in the state.    ###
######################################################

pusm <- pusm %>% filter(AGEP >= 18 & AGEP <= 50)
population18to50 <- aggregate(data=pusm, PWGTP ~ ST, FUN=sum)
population18to50 <- left_join(x=population18to50, y=statenames, by="ST")
population18to50 <- population18to50 %>% select(State, PWGTP)
names(population18to50) <- c("State", "Number of adults aged 18-50")
portfolio <- left_join(x=portfolio, y=population18to50, by="State")

portfolio$`Debt per capita` <- portfolio$Balance / portfolio$`Number of adults aged 18-50`
portfolio$`Borrowers per capita` <- portfolio$Borrowers / portfolio$`Number of adults aged 18-50`

######################################################
### Now we can rank California alongside other     ###
### states according to these key measures.        ###
######################################################

######################################################
### First we create the rank variables.            ###
######################################################

portfolio$`Rank: Balance` <- rank(portfolio$Balance, ties.method="average")
portfolio$`Rank: Borrowers` <- rank(portfolio$Borrowers, ties.method="average")
portfolio$`Rank: Debt per capita` <- rank(portfolio$`Debt per capita`, ties.method="average")
portfolio$`Rank: Borrowers per capita` <- rank(portfolio$`Borrowers per capita`, ties.method="average")
portfolio$`Rank: Average balance` <- rank(portfolio$`Average balance`, ties.method="average")

######################################################
### Here we add the results into the table.        ###
######################################################

interstateComp <- interstateComp %>% add_row(
  `Measure` = "Federal student loan debt per capita", 
  `50-state median` = dollar(median(portfolio$`Debt per capita`, na.rm=TRUE), accuracy=1), 
  `California value` = dollar(portfolio$`Debt per capita`[portfolio$State=="California"], accuracy=1), 
  `California rank` = (portfolio$`Rank: Debt per capita`[portfolio$State=="California"])
)

interstateComp <- interstateComp %>% add_row(
  `Measure` = "Federal student loan borrowers per capita", 
  `50-state median` = as.character(round(median(portfolio$`Borrowers per capita`, na.rm=TRUE), digits=3)), 
  `California value` = as.character(round(portfolio$`Borrowers per capita`[portfolio$State=="California"], digits=3)), 
  `California rank` = (portfolio$`Rank: Borrowers per capita`[portfolio$State=="California"])
)

interstateComp <- interstateComp %>% add_row(
  `Measure` = "Average federal student loan balance",
  `50-state median` = dollar(median(portfolio$`Average balance`, na.rm=TRUE), accuracy=1),
  `California value` = dollar(portfolio$`Average balance`[portfolio$State=="California"], accuracy=1),
  `California rank` = (portfolio$`Rank: Average balance`[portfolio$State=="California"])
)

scaleCali <- scaleCali %>% add_row(
  `Measure` = "Total outstanding federal student loan debt",
  `U.S. total` = dollar(sum(portfolio$`Balance`, na.rm=TRUE), accuracy=1000000),
  `California value` = dollar(portfolio$`Balance`[portfolio$State=="California"], accuracy=1000000), 
  `California share` = percent((portfolio$`Balance`[portfolio$State=="California"] / sum(portfolio$`Balance`, na.rm=TRUE)), accuracy=0.1)
)

scaleCali <- scaleCali %>% add_row(
  `Measure` = "Total federal student loan borrowers",
  `U.S. total` = comma(round(sum(portfolio$`Borrowers`, na.rm=TRUE), digits=-3)),
  `California value` = comma(round(portfolio$`Borrowers`[portfolio$State=="California"], digits=-3)),
  `California share` = percent((portfolio$`Borrowers`[portfolio$State=="California"] / sum(portfolio$`Borrowers`, na.rm=TRUE)), accuracy=0.1)
)

######################################################
### Finally, let's remove the placeholder row.     ###
######################################################

interstateComp <- interstateComp %>% filter(is.na(Measure)==FALSE)
scaleCali <- scaleCali %>% filter(is.na(Measure)==FALSE)
```

#### {.tabset}
##### Table 1
```{r kable1, results='asis'}
kable(interstateComp, caption="California's rank on average debt measures")
```
##### Data source and notes
***
#### {-}

California has the most outstanding federal student loan debt and borrowers of any state, amounting to around 9 percent of the total portfolio. 

#### {.tabset}
##### Table 2
```{r kable2, results='asis'}
kable(scaleCali, caption="Size of California borrowers' outstanding debt")
```
##### Data source and notes
***
#### {-}

Now we turn to the quarterly data on disbursements. To evade any impact from the COVID-19 pandemic on the data, we examine data from the 2018-19 award year. 

```{r loanPrep1, warning=FALSE}

######################################################
### First we load in student loan disbursement     ###
### data from 2018-19.                             ###
######################################################

loans1819 <- fread("dl-dashboard-ay2018-2019-q4-california.csv", header=TRUE, skip=6)
names(loans1819) <- c(
  "OPEID",
  "School",
  "State",
  "Zip Code",
  "School Type",

  "SUBSIDIZED: Recipients", 
  "SUBSIDIZED: # of Loans Originated", 
  "SUBSIDIZED: $ of Loans Originated", 
  "SUBSIDIZED: # of Disbursements", 
  "SUBSIDIZED: $ of Disbursements", 
   
  "UNSUBSIDIZED - UNDERGRADUATE: Recipients", 
  "UNSUBSIDIZED - UNDERGRADUATE: # of Loans Originated", 
  "UNSUBSIDIZED - UNDERGRADUATE: $ of Loans Originated", 
  "UNSUBSIDIZED - UNDERGRADUATE: # of Disbursements", 
  "UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements", 

  "UNSUBSIDIZED - GRADUATE: Recipients", 
  "UNSUBSIDIZED - GRADUATE: # of Loans Originated", 
  "UNSUBSIDIZED - GRADUATE: $ of Loans Originated", 
  "UNSUBSIDIZED - GRADUATE: # of Disbursements", 
  "UNSUBSIDIZED - GRADUATE: $ of Disbursements", 

  "PARENT PLUS: Recipients", 
  "PARENT PLUS: # of Loans Originated", 
  "PARENT PLUS: $ of Loans Originated", 
  "PARENT PLUS: # of Disbursements", 
  "PARENT PLUS: $ of Disbursements", 

  "GRAD PLUS: Recipients", 
  "GRAD PLUS: # of Loans Originated", 
  "GRAD PLUS: $ of Loans Originated", 
  "GRAD PLUS: # of Disbursements", 
  "GRAD PLUS: $ of Disbursements"
)

######################################################
### Here we must format the OPEIDs, bringing them  ###
### to eight digits.                               ###
######################################################

loans1819$OPEID <- as.character(loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==1, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==2, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==3, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==4, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==5, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==6, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==7, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)

######################################################
### We only need each school's total disbursements ###
### and its total recipients, so we select only    ###
### those variables.                               ###
######################################################

loans1819 <- loans1819 %>% select(
  `OPEID`,
  `School`,
  `State`,
  `Zip Code`,
  `School Type`,

  `SUBSIDIZED: Recipients`, 
  `SUBSIDIZED: $ of Disbursements`, 
   
  `UNSUBSIDIZED - UNDERGRADUATE: Recipients`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`, 

  `UNSUBSIDIZED - GRADUATE: Recipients`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 

  `PARENT PLUS: Recipients`, 
  `PARENT PLUS: $ of Disbursements`, 

  `GRAD PLUS: Recipients`, 
  `GRAD PLUS: $ of Disbursements`
)

######################################################
### Here we make sure that the data are stored     ###
### numerically.                                   ###
######################################################

loans1819$`SUBSIDIZED: Recipients` <- as.numeric(loans1819$`SUBSIDIZED: Recipients`)
loans1819$`SUBSIDIZED: $ of Disbursements` <- as.numeric(loans1819$`SUBSIDIZED: $ of Disbursements`)
   
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients` <- as.numeric(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`)
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` <- as.numeric(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`)

loans1819$`UNSUBSIDIZED - GRADUATE: Recipients` <- as.numeric(loans1819$`UNSUBSIDIZED - GRADUATE: Recipients`)
loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` <- as.numeric(loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`)

loans1819$`PARENT PLUS: Recipients` <- as.numeric(loans1819$`PARENT PLUS: Recipients`)
loans1819$`PARENT PLUS: $ of Disbursements` <- as.numeric(loans1819$`PARENT PLUS: $ of Disbursements`)

loans1819$`GRAD PLUS: Recipients` <- as.numeric(loans1819$`GRAD PLUS: Recipients`)
loans1819$`GRAD PLUS: $ of Disbursements` <- as.numeric(loans1819$`GRAD PLUS: $ of Disbursements`)

######################################################
### We also want to make sure any NA values are    ###
### stored as zeroes.                              ###
######################################################

loans1819$`SUBSIDIZED: Recipients`[is.na(loans1819$`SUBSIDIZED: Recipients`)] <- 0
loans1819$`SUBSIDIZED: $ of Disbursements`[is.na(loans1819$`SUBSIDIZED: $ of Disbursements`)] <- 0
   
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`[is.na(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`)] <- 0
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`[is.na(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`)] <- 0

loans1819$`UNSUBSIDIZED - GRADUATE: Recipients`[is.na(loans1819$`UNSUBSIDIZED - GRADUATE: Recipients`)] <- 0
loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`[is.na(loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`)] <- 0

loans1819$`PARENT PLUS: Recipients`[is.na(loans1819$`PARENT PLUS: Recipients`)] <- 0
loans1819$`PARENT PLUS: $ of Disbursements`[is.na(loans1819$`PARENT PLUS: $ of Disbursements`)] <- 0

loans1819$`GRAD PLUS: Recipients`[is.na(loans1819$`GRAD PLUS: Recipients`)] <- 0
loans1819$`GRAD PLUS: $ of Disbursements`[is.na(loans1819$`GRAD PLUS: $ of Disbursements`)] <- 0

######################################################
### Here we create a variable for total loan       ###
### disbursements at a college.                    ###
######################################################

loans1819$`Total $ of Disbursements` <- loans1819$`SUBSIDIZED: $ of Disbursements` + loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` + loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` + loans1819$`PARENT PLUS: $ of Disbursements` + loans1819$`GRAD PLUS: $ of Disbursements`

```

```{r loanPrograms}

######################################################
### Using the loan data we had imported earlier,   ###
### we aggregate totals by state.                  ###
######################################################

table3 <- aggregate(data=loans1819, cbind(  
  `SUBSIDIZED: $ of Disbursements`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `PARENT PLUS: $ of Disbursements`, 
  `GRAD PLUS: $ of Disbursements`, 
  `Total $ of Disbursements`) ~ State, FUN=sum)

######################################################
### Next we add the U.S. totals for comparison.    ###
######################################################

table3 <- table3 %>% add_row(
  `State`="U.S.",
  `SUBSIDIZED: $ of Disbursements`=sum(table3$`SUBSIDIZED: $ of Disbursements`), 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`=sum(table3$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`), 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`=sum(table3$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`), 
  `PARENT PLUS: $ of Disbursements`=sum(table3$`PARENT PLUS: $ of Disbursements`), 
  `GRAD PLUS: $ of Disbursements`=sum(table3$`GRAD PLUS: $ of Disbursements`), 
  `Total $ of Disbursements`=sum(table3$`Total $ of Disbursements`)
)

######################################################
### Now we derive each loan program's share of     ###
### total borrowing in every state.                ###
######################################################

table3$`SUBSIDIZED share of total` <- table3$`SUBSIDIZED: $ of Disbursements` / table3$`Total $ of Disbursements`
table3$`UNSUBSIDIZED - UNDERGRADUATE share of total` <- table3$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` / table3$`Total $ of Disbursements`
table3$`UNSUBSIDIZED - GRADUATE share of total` <- table3$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` / table3$`Total $ of Disbursements`
table3$`PARENT PLUS share of total` <- table3$`PARENT PLUS: $ of Disbursements` / table3$`Total $ of Disbursements`
table3$`GRAD PLUS share of total` <- table3$`GRAD PLUS: $ of Disbursements` / table3$`Total $ of Disbursements`

######################################################
### We can now compare how California stacks up    ###
### versus the rest of the nation.                 ###
######################################################

table3.1 <- table3 %>% filter(State %in% c("CA", "U.S.")) %>% select(State, `SUBSIDIZED share of total`, `UNSUBSIDIZED - UNDERGRADUATE share of total`, `UNSUBSIDIZED - GRADUATE share of total`, `PARENT PLUS share of total`, `GRAD PLUS share of total`)
names(table3.1) <- c("State", "Subsidized", "Unsubsidized undergraduate", "Unsubsidized graduate", "Parent PLUS loans", "Grad PLUS")
table3.1$`Subsidized` <- percent(table3.1$`Subsidized`)
table3.1$`Unsubsidized undergraduate` <- percent(table3.1$`Unsubsidized undergraduate`)
table3.1$`Unsubsidized graduate` <- percent(table3.1$`Unsubsidized graduate`)
table3.1$`Parent PLUS loans` <- percent(table3.1$`Parent PLUS loans`)
table3.1$`Grad PLUS` <- percent(table3.1$`Grad PLUS`)
```

#### {.tabset}
##### Table 3
```{r kable3}
kable(table3.1, caption="Share of loan dollars disbursed in 2018-19 by loan type, California vs. U.S.")
```
##### Data source and notes
***
#### {-}

```{r sectorLoans}

#######################################################
### Now we load in data from the College Scorecard. ###
#######################################################

scorecard1 <- fread("Most-Recent-Cohorts-Institution.csv", header=TRUE, select=c(
  "OPEID",   # 8-digit OPE ID for institution
  "CONTROL", # Control of institution
  "CCBASIC"  # Carnegie Classification -- basic
))

######################################################
### I now add this variable for later.             ###
######################################################

scorecard1$`Two-year` <- ifelse(scorecard1$CCBASIC %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14), 1, 0)
scorecard1$`Four-year` <- ifelse(scorecard1$CCBASIC %in% c(15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32), 1, 0)

######################################################
### Here I want to format the control variable.    ###
######################################################

scorecard1$Control <- rep(NA, nrow(scorecard1))
scorecard1$Control[scorecard1$CONTROL==1] <- "Public"
scorecard1$Control[scorecard1$CONTROL==2] <- "Non-profit"
scorecard1$Control[scorecard1$CONTROL==3] <- "For-profit"

######################################################
### It's important first to remove the rows that   ###
### have repeated OPEIDs.                          ###
######################################################

scorecard1 <- scorecard1 %>% filter(duplicated(OPEID)==FALSE)

######################################################
### Here we must format the OPEIDs, bringing them  ###
### to eight digits.                               ###
######################################################

scorecard1$OPEID <- as.character(scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==1, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==2, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==3, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==4, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==5, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==6, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==7, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)

######################################################
### Now we merge the two datasets by OPEID.        ###
######################################################

loans1819 <- left_join(x=loans1819, y=scorecard1, by="OPEID")
forTable4 <- loans1819 %>% filter(`Four-year`==1)

table4 <- aggregate(data=forTable4, cbind(
  `SUBSIDIZED: $ of Disbursements`, 
  `SUBSIDIZED: Recipients`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`,
  `UNSUBSIDIZED - UNDERGRADUATE: Recipients`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: Recipients`, 
  `PARENT PLUS: $ of Disbursements`, 
  `PARENT PLUS: Recipients`, 
  `GRAD PLUS: $ of Disbursements`,
  `GRAD PLUS: Recipients`
) ~ State + Control, FUN=sum)

table4.US <- aggregate(data=forTable4, cbind(
  `SUBSIDIZED: $ of Disbursements`, 
  `SUBSIDIZED: Recipients`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`,
  `UNSUBSIDIZED - UNDERGRADUATE: Recipients`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: Recipients`, 
  `PARENT PLUS: $ of Disbursements`, 
  `PARENT PLUS: Recipients`, 
  `GRAD PLUS: $ of Disbursements`,
  `GRAD PLUS: Recipients`
) ~ Control, FUN=sum)
table4.US$State <- rep("U.S.", nrow(table4.US))
table4 <- rbind(table4, table4.US)

table4 <- table4 %>% filter(State %in% c("CA", "U.S."))

table4$`Subsidized` <- table4$`SUBSIDIZED: $ of Disbursements` / table4$`SUBSIDIZED: Recipients`
table4$`Unsub. UG` <- table4$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` / table4$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`
table4$`Unsub. Grad.` <- table4$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` / table4$`UNSUBSIDIZED - GRADUATE: Recipients`
table4$`Parent PLUS` <- table4$`PARENT PLUS: $ of Disbursements` / table4$`PARENT PLUS: Recipients`
table4$`Grad PLUS` <- table4$`GRAD PLUS: $ of Disbursements` / table4$`GRAD PLUS: Recipients`

table4.1 <- table4 %>% select(State, Control, `Subsidized`, `Unsub. UG`, `Unsub. Grad.`, `Parent PLUS`, `Grad PLUS`)
table4.1 <- reshape2::melt(data=table4.1, id.vars = c("State", "Control"), value.name="Average Loan")
```

#### {.tabset}
##### Figure 1
```{r figure1}
g1 <- ggplot(data=table4.1, mapping=aes(x=State, y=`Average Loan`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.4) + labs(title="Average Loan by Type and Sector: California vs. U.S.", caption="Author's analysis of data from the Federal Student Aid Data Center.") + scale_y_continuous(labels=scales::dollar_format()) + facet_grid(Control ~ variable) + scale_fill_brewer(palette="Dark2") + theme(text=element_text(family="Optima")) 

ggplotly(g1, width=850, height=500)
```
##### Data source and notes

Source: FSA Data Center. 

Year(s) of analysis: Reflects loans distributed in 2018-19. Filtered for four-year institutions.

***

#### {-}

The breakdown of loans distributed by California institutions is skewed more towards Grad PLUS than the breakdown of loans distributed by institutions nationwide. Unsubsidized graduate loans also take up a larger slice of the pie in California than in the nation overall.  

## National Postsecondary Student Aid Study

#### About the data

The statistics in the previous section have all been based on institution-level data. For the most robust information on the relationship between student loan borrowing and race in California, we need student-level data. In the absence of a national student-level data set, we use survey data from the National Postsecondary Student Aid Study (NPSAS). 

NPSAS is the largest federal survey of U.S. college students with a primary focus on financial aid. The study has generally been conducted every four years, most recently in 2016 (NPSAS:16), with separate data sets examining undergraduate and graduate students. 

NPSAS data sets have not traditionally been used for state-level analyses, although the sample size for California students can be large enough to produce reliable estimates depending on the query. This past year, a new edition of NPSAS that was designed for state-representative samples was released. Known as NPSAS-AC (Administrative Collection), it draws from student records housed by colleges and the U.S. Department of Education for a sample of 325,000 undergraduates. Representative samples for public 4-year systems are available in NPSAS-AC for 45 states, and representative samples for public 2-year systems are available for 36 states. Thirty states have representative samples for undergraduate students overall. More information on NPSAS-AC can be found [here](https://nces.ed.gov/pubs2022/2022477.pdf). 

In this section we rely primarily on NPSAS-AC, which reflects the 2017-18 year. For analysis of graduate students, we use NPSAS:16 and filter for in-state students in California. (The in-state condition is required for this query.)

These data are accessed using the National Center on Education Statistics' (NCES) [Datalab tool](https://nces.ed.gov/datalab/). Every query has a unique table retrieval number that can be used by any user to run the query in Datalab. 

#### Findings

The figure below compares average undergraduate borrowing by racial group at California public four-years, compared to U.S. public four-years. Across all groups, the average federal loan total is lower in California than nationwide. However, California resembles the U.S. in that Black undergraduates and their families borrow more than their peers. California differs from the U.S. in that Latino/a undergraduates in the state borrow more than white undergraduates, though this is only the case for direct loans to the students and not Parent PLUS.   

```{r npsas1}
npsas1.US <- read.csv("Powerstats_lounfy.csv", skip=12, nrow=7, header=FALSE)
npsas1.CA <- read.csv("Powerstats_lounfy.csv", skip=73, nrow=7, header=FALSE)

names(npsas1.US) <- c("Group", "Federal loans (excl. PLUS)", "Parent PLUS")
names(npsas1.CA) <- c("Group", "Federal loans (excl. PLUS)", "Parent PLUS")

npsas1.US$State <- rep("U.S.", nrow(npsas1.US))
npsas1.CA$State <- rep("CA", nrow(npsas1.CA))
npsas1 <- rbind(npsas1.US, npsas1.CA)

npsas1$Group[npsas1$Group=="Black or African American"] <- "Black"
npsas1$Group[npsas1$Group=="Hispanic or Latino"] <- "Latino/a"
npsas1$Group[npsas1$Group=="Native Hawaiian/other Pacific Islander"] <- "Pacific Islander"
npsas1$Group[npsas1$Group=="More than one race"] <- "2+ races"
npsas1 <- npsas1 %>% filter(Group != "American Indian or Alaska Native")

npsas1 <- reshape2::melt(data=npsas1, id.vars = c("Group", "State"), value.name="Average Loan")

npsas1$`Average Loan` <- gsub(pattern="!", x=npsas1$`Average Loan`, replacement="")
npsas1$`Average Loan` <- gsub(pattern=",", x=npsas1$`Average Loan`, replacement="")
npsas1$`Average Loan` <- gsub(pattern=" ", x=npsas1$`Average Loan`, replacement="")
npsas1$`Average Loan` <- as.numeric(npsas1$`Average Loan`)
```

#### {.tabset}
##### Figure 2
```{r figure2}
g2 <- ggplot(data=npsas1, mapping=aes(x=State, y=`Average Loan`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.4) + labs(title="Average undergraduate loans at public 4-years by group: CA vs U.S.") + facet_grid(variable ~ Group) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g2)
```
##### Data source and notes
Source: NPSAS:18-AC. Table retrieval number: lounfy.

Year(s) of analysis: Reflects students enrolled in the 2017-18 academic year. Only reflects undergraduate public 4-year institutions.  

Note: Insufficient sample size for Native American / Alaskan Native population. Zeros are counted in the averages, meaning it includes those who took out no loans. 

***
#### {-}


```{r npsas2}
npsas2.US <- read.csv("Powerstats_psiqll.csv", skip=12, nrow=7, header=FALSE)
npsas2.CA <- read.csv("Powerstats_psiqll.csv", skip=73, nrow=7, header=FALSE)

names(npsas2.US) <- c("Group", "Total federal loans")
names(npsas2.CA) <- c("Group", "Total federal loans")

npsas2.US$State <- rep("U.S.", nrow(npsas2.US))
npsas2.CA$State <- rep("CA", nrow(npsas2.CA))
npsas2 <- rbind(npsas2.US, npsas2.CA)

npsas2$Group[npsas2$Group=="Black or African American"] <- "Black"
npsas2$Group[npsas2$Group=="Hispanic or Latino"] <- "Latino/a"
npsas2$Group[npsas2$Group=="More than one race"] <- "2+ races"
npsas2 <- npsas2 %>% filter((Group %in% c("American Indian or Alaska Native", "Native Hawaiian/other Pacific Islander"))==FALSE)

npsas2$`Total federal loans` <- gsub(pattern="!", x=npsas2$`Total federal loans`, replacement="")
npsas2$`Total federal loans` <- gsub(pattern=",", x=npsas2$`Total federal loans`, replacement="")
npsas2$`Total federal loans` <- gsub(pattern=" ", x=npsas2$`Total federal loans`, replacement="")
npsas2$`Total federal loans` <- as.numeric(npsas2$`Total federal loans`)
```

#### {.tabset}
##### Figure 3
```{r figure3}
g3 <- ggplot(data=npsas2, mapping=aes(x=State, y=`Total federal loans`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average federal student loans for graduate students, by group: CA vs U.S.", caption="Groups not shown lacked sufficient samples.") + facet_grid(. ~ Group) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g3, height=350)
```
##### Data source and notes 
Source: NPSAS:16. Table retrieval number: psiqll. Data can be accessed at [NCES Datalab](https://nces.ed.gov/datalab/). 

Year(s) of analysis: Reflects students enrolled in the 2015-16 academic year. Only reflects public 4-year institutions.  

Notes: Private loans are also used, but the average loans are so small that Datalab considers the estimates unreliable. Due to limitations of NPSAS:16, this only applies to in-state students. 

***
#### {-}

Across all groups, graduate students in California borrow more than graduate students nationwide. Black students and those of two or more races show the highest average loans, upwards of $20,000 per year. It is striking how Black graduate students in California borrow an average that is roughly two-thirds higher than both the average for Black graduate students nationwide and the average for white graduate students in California.

Among California students, the sample is not sufficient for a breakdown by award level. For context, here is a breakdown of gaps in average loans across all graduate program levels, reflecting the national sample. This demonstrates how professional doctorates show an extreme version of the trends just described. Although professional doctoral students in California constitutes a very small subsample in NPSAS, we can explore this further using the College Scorecard later on.

```{r npsas4}
npsas4.US.masters <- read.csv("Powerstats_vcbaev.csv", skip=73, nrow=7, header=FALSE)
npsas4.US.certificate <- read.csv("Powerstats_vcbaev.csv", skip=134, nrow=7, header=FALSE)
npsas4.US.phd <- read.csv("Powerstats_vcbaev.csv", skip=195, nrow=7, header=FALSE)
npsas4.US.professional <- read.csv("Powerstats_vcbaev.csv", skip=256, nrow=7, header=FALSE)

names(npsas4.US.masters) <- c("Group", "Total federal loans")
names(npsas4.US.certificate) <- c("Group", "Total federal loans")
names(npsas4.US.phd) <- c("Group", "Total federal loans")
names(npsas4.US.professional) <- c("Group", "Total federal loans")

npsas4.US.masters$Level <- rep("Master's programs", nrow(npsas4.US.masters))
npsas4.US.certificate$Level <- rep("Post-bac certificates", nrow(npsas4.US.certificate))
npsas4.US.phd$Level <- rep("Research doctorates", nrow(npsas4.US.phd))
npsas4.US.professional$Level <- rep("Professional doctorates", nrow(npsas4.US.professional))

npsas4 <- rbind(npsas4.US.masters, 
                npsas4.US.certificate, 
                npsas4.US.phd, 
                npsas4.US.professional)

npsas4$Group[npsas4$Group=="Black or African American"] <- "Black"
npsas4$Group[npsas4$Group=="Hispanic or Latino"] <- "Latino/a"
npsas4$Group[npsas4$Group=="More than one race"] <- "2+ races"
npsas4 <- npsas4 %>% filter((Group %in% c("American Indian or Alaska Native", "Native Hawaiian/other Pacific Islander", "2+ races"))==FALSE)

npsas4$`Total federal loans` <- gsub(pattern="!", x=npsas4$`Total federal loans`, replacement="")
npsas4$`Total federal loans` <- gsub(pattern=",", x=npsas4$`Total federal loans`, replacement="")
npsas4$`Total federal loans` <- gsub(pattern=" ", x=npsas4$`Total federal loans`, replacement="")
npsas4$`Total federal loans` <- as.numeric(npsas4$`Total federal loans`)
```

#### {.tabset}
##### Figure 4
```{r figure4}
g4 <- ggplot(data=npsas4, mapping=aes(x=Group, y=`Total federal loans`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average federal loans for graduate students by group and level: U.S. only", caption="Groups not shown lacked sufficient samples.") + facet_grid(. ~ Level) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g4, width=800, height=350)
```
##### Data source and notes
***
#### {-}

NPSAS allows us to disaggregate by ethnicity, to a limited extent, for two racial groups (Hispanic and Asian). In California, average federal loans among Filipino undergraduates are higher than other Asian groups, matching a trend seen nationwide. Among Hispanic ethnicities in California, average loans are greatest among those of Puerto Rican descent. 

#### {.tabset}
##### Figure 5: Asian ethnicities
```{r npsas5}
npsas5.US.HSP <- read.csv("Powerstats_tpsawz.csv", skip=11, nrow=6, header=FALSE)
npsas5.US.ASN <- read.csv("Powerstats_tpsawz.csv", skip=19, nrow=9, header=FALSE)

npsas5.CA.HSP <- read.csv("Powerstats_jejvld.csv", skip=11, nrow=6, header=FALSE)
npsas5.CA.ASN <- read.csv("Powerstats_jejvld.csv", skip=19, nrow=9, header=FALSE)

names(npsas5.US.HSP) <- c("Group", "Total federal loans")
names(npsas5.US.ASN) <- c("Group", "Total federal loans")
names(npsas5.CA.HSP) <- c("Group", "Total federal loans")
names(npsas5.CA.ASN) <- c("Group", "Total federal loans")

npsas5.US.HSP$Race <- rep("Hispanic", nrow(npsas5.US.HSP))
npsas5.US.ASN$Race <- rep("Asian", nrow(npsas5.US.ASN))
npsas5.CA.HSP$Race <- rep("Hispanic", nrow(npsas5.CA.HSP))
npsas5.CA.ASN$Race <- rep("Asian", nrow(npsas5.CA.ASN))

npsas5.US.HSP$State <- rep("U.S.", nrow(npsas5.US.HSP))
npsas5.US.ASN$State <- rep("U.S.", nrow(npsas5.US.ASN))
npsas5.CA.HSP$State <- rep("CA", nrow(npsas5.CA.HSP))
npsas5.CA.ASN$State <- rep("CA", nrow(npsas5.CA.ASN))

npsas5 <- rbind(npsas5.US.HSP, 
                npsas5.US.ASN, 
                npsas5.CA.HSP, 
                npsas5.CA.ASN)

npsas5$`Total federal loans` <- gsub(pattern="!", x=npsas5$`Total federal loans`, replacement="")
npsas5$`Total federal loans` <- gsub(pattern=",", x=npsas5$`Total federal loans`, replacement="")
npsas5$`Total federal loans` <- gsub(pattern=" ", x=npsas5$`Total federal loans`, replacement="")
npsas5$`Total federal loans` <- as.numeric(npsas5$`Total federal loans`)

npsas5.ASN <- npsas5 %>% filter(Race=="Asian") %>% filter(Group != "Not of Asian origin")
npsas5.HSP <- npsas5 %>% filter(Race=="Hispanic") %>% filter(Group != "Not Hispanic or Latino origin")
npsas5.HSP$Group[npsas5.HSP$Group=="Mexican, Mexican-American, or Chicano descent"] <- "Mexican or Chicano descent"
npsas5.HSP$Group[npsas5.HSP$Group=="Other Spanish, Hispanic, or Latino descent"] <- "Other Hispanic or Latino descent"
```

```{r figure5A}
g5A <- ggplot(data=npsas5.ASN, mapping=aes(y=Group, x=`Total federal loans`, fill=Group)) + geom_bar(stat="identity", position="dodge") + labs(title="Average federal student loans by Asian ethinicity: U.S. vs CA", x="Average federal student loans") + facet_grid(State ~ .) + scale_x_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g5A)
```
##### Figure 5: Hispanic ethnicities
```{r figure5B}
g5B <- ggplot(data=npsas5.HSP, mapping=aes(y=Group, x=`Total federal loans`, fill=Group)) + geom_bar(stat="identity", position="dodge") + labs(title="Average federal student loans by Hispanic ethinicity: U.S. vs CA", x="Average federal student loans") + facet_grid(State ~ .) + scale_x_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g5B)
```
##### Data source and notes
Source:  NPSAS, table retrieval number ddgpwg (U.S. all), jejvld (California in-state), tpsawz (U.S. in-state).

Note: Filtered for 4-year colleges and U.S. citizenship. Limited to in-state, undergraduate students. "Total federal loans" includes Parent PLUS. No other racial groups besides Hispanic and Asian have breakouts by ethnicity in NPSAS.

***
#### {-}

## Survey of Household Economics and Decisionmaking 

#### About the data

This is some information about SHED. 

#### Findings

Here we tee up the findings. 

```{r shedSetup1}
shed21 <- fread("SHED-2021.csv", header=TRUE, select=c("CaseID", "weight_pop", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "ppfs1482", "iclevel", "control", "L0_b"))

shed20 <- fread("SHED-2020.csv", header=TRUE, select=c("CaseID", "weight_pop", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "ppfs1482", "iclevel", "control", "L0_b"))

shed19 <- fread("SHED-2019.csv", header=TRUE, select=c("CaseID", "weight_pop", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "FS20_b", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "ppfs1482", "iclevel", "control", "L0_b"))

shed18 <- fread("SHED-2018.csv", header=TRUE, select=c("CaseID", "weight2b", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5",  "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d",  "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "FS20_b", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "iclevel", "control", "L0_b"))

shed17 <- fread("SHED-2017.csv", header=TRUE, select=c("CaseID", "weight3b", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "FS20_b", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "control", "L0_b"))

shed16 <- fread("SHED-2016.csv", header=TRUE, select=c("CaseID", "weight3b", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3_TOTAL",  "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1_i", "I0_e", "I4A", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "ppcm0160", "ppfs0596", "C1", "L0_b"))

shed15 <- fread("SHED-2015.csv", header=TRUE, select=c("CaseID", "weight3b", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C4A", "ED0", "ED5", "ED6A_a", "ED6A_b", "ED6A_c", "ED6A_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3_TOTAL", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "D2", "I0_e", "I4A", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "ppcm0160", "ppfs0596", "C1", "sector", "control", "D0_b"))

shed21$Weight <- shed21$weight_pop
shed20$Weight <- shed20$weight_pop
shed19$Weight <- shed19$weight_pop
shed18$Weight <- shed18$weight2b
shed17$Weight <- shed17$weight3b
shed16$Weight <- shed16$weight3b
shed15$Weight <- shed15$weight3b

shed21$State <- shed21$ppstaten
shed20$State <- shed20$ppstaten
shed19$State <- shed19$ppstaten
shed18$State <- shed18$ppstaten
shed17$State <- shed17$ppstaten
shed16$State <- shed16$ppstaten
shed15$State <- shed15$ppstaten

shed21$Race <- shed21$ppethm
shed20$Race <- shed20$ppethm
shed19$Race <- shed19$ppethm
shed18$Race <- shed18$ppethm
shed17$Race <- shed17$ppethm
shed16$Race <- shed16$ppethm
shed15$Race <- shed15$ppethm

shed21$Gender <- shed21$ppgender
shed20$Gender <- shed20$ppgender
shed19$Gender <- shed19$ppgender
shed18$Gender <- shed18$ppgender
shed17$Gender <- shed17$ppgender
shed16$Gender <- shed16$ppgender
shed15$Gender <- shed15$ppgender

shed21$FinManage <- shed21$B2
shed20$FinManage <- shed20$B2
shed19$FinManage <- shed19$B2
shed18$FinManage <- shed18$B2
shed17$FinManage <- shed17$B2
shed16$FinManage <- shed16$B2
shed15$FinManage <- shed15$B2

shed21$ParComp <- shed21$B6
shed20$ParComp <- shed20$B6
shed19$ParComp <- shed19$B6
shed18$ParComp <- shed18$B6
shed17$ParComp <- shed17$B6
shed16$ParComp <- shed16$B6
shed15$ParComp <- shed15$B6

shed21$HomeOwn <- shed21$GH1
shed20$HomeOwn <- shed20$GH1
shed19$HomeOwn <- shed19$GH1
shed18$HomeOwn <- shed18$GH1
shed17$HomeOwn <- shed17$GH1
shed16$HomeOwn <- shed16$GH1
shed15$HomeOwn <- shed15$GH1

shed21$CCApprov <- shed21$A6
shed20$CCApprov <- shed20$A6
shed19$CCApprov <- shed19$A6
shed18$CCApprov <- shed18$A6
shed17$CCApprov <- shed17$A6
shed16$CCApprov <- shed16$A6
shed15$CCApprov <- shed15$A6

shed21$CreditDeny <- shed21$A1_a
shed20$CreditDeny <- shed20$A1_a
shed19$CreditDeny <- shed19$A1_a
shed18$CreditDeny <- shed18$A1_a
shed17$CreditDeny <- shed17$A1_a
shed16$CreditDeny <- shed16$A1_a
shed15$CreditDeny <- shed15$A1_a

shed21$UnpaidCC <- shed21$C3
shed20$UnpaidCC <- shed20$C3
shed19$UnpaidCC <- shed19$C3
shed18$UnpaidCC <- shed18$C3
shed17$UnpaidCC <- shed17$C3
shed16$UnpaidCC <- shed16$C3
shed15$UnpaidCC <- rep(NA, nrow(shed15))

shed21$CCBalance <- shed21$C4A
shed20$CCBalance <- shed20$C4A
shed19$CCBalance <- shed19$C4A
shed18$CCBalance <- shed18$C4A
shed17$CCBalance <- shed17$C4A
shed16$CCBalance <- shed16$C4A
shed15$CCBalance <- shed15$C4A

shed21$EdAttain <- shed21$ED0
shed20$EdAttain <- shed20$ED0
shed19$EdAttain <- shed19$ED0
shed18$EdAttain <- shed18$ED0
shed17$EdAttain <- shed17$ED0
shed16$EdAttain <- shed16$ED0
shed15$EdAttain <- shed15$ED0

shed21$EdPayoff1 <- shed21$ED5
shed20$EdPayoff1 <- shed20$ED5
shed19$EdPayoff1 <- shed19$ED5
shed18$EdPayoff1 <- shed18$ED5
shed17$EdPayoff1 <- shed17$ED5
shed16$EdPayoff1 <- shed16$ED5
shed15$EdPayoff1 <- shed15$ED5

shed21$DiffField1 <- shed21$ED6_a
shed20$DiffField1 <- shed20$ED6_a
shed19$DiffField1 <- shed19$ED6_a
shed18$DiffField1 <- shed18$ED6_a
shed17$DiffField1 <- shed17$ED6_a
shed16$DiffField1 <- shed16$ED6_a
shed15$DiffField1 <- shed15$ED6A_a

shed21$DiffSchool1 <- shed21$ED6_b
shed20$DiffSchool1 <- shed20$ED6_b
shed19$DiffSchool1 <- shed19$ED6_b
shed18$DiffSchool1 <- shed18$ED6_b
shed17$DiffSchool1 <- shed17$ED6_b
shed16$DiffSchool1 <- shed16$ED6_b
shed15$DiffSchool1 <- shed15$ED6A_b

shed21$LessEd1 <- shed21$ED6_c
shed20$LessEd1 <- shed20$ED6_c
shed19$LessEd1 <- shed19$ED6_c
shed18$LessEd1 <- shed18$ED6_c
shed17$LessEd1 <- shed17$ED6_c
shed16$LessEd1 <- shed16$ED6_c
shed15$LessEd1 <- shed15$ED6A_c

shed21$MoreEd1 <- shed21$ED6_d
shed20$MoreEd1 <- shed20$ED6_d
shed19$MoreEd1 <- shed19$ED6_d
shed18$MoreEd1 <- shed18$ED6_d
shed17$MoreEd1 <- shed17$ED6_d
shed16$MoreEd1 <- shed16$ED6_d
shed15$MoreEd1 <- shed15$ED6A_d

shed21$OwnDebt <- shed21$SL1
shed20$OwnDebt <- shed20$SL1
shed19$OwnDebt <- shed19$SL1
shed18$OwnDebt <- shed18$SL1
shed17$OwnDebt <- shed17$SL1
shed16$OwnDebt <- shed16$SL1
shed15$OwnDebt <- shed15$SL1

shed21$OwnDebtSL <- shed21$SL2_a
shed20$OwnDebtSL <- shed20$SL2_a
shed19$OwnDebtSL <- shed19$SL2_a
shed18$OwnDebtSL <- shed18$SL2_a
shed17$OwnDebtSL <- shed17$SL2_a
shed16$OwnDebtSL <- shed16$SL2_a
shed15$OwnDebtSL <- shed15$SL2_a

shed21$OwnDebtHE <- shed21$SL2_b
shed20$OwnDebtHE <- shed20$SL2_b
shed19$OwnDebtHE <- shed19$SL2_b
shed18$OwnDebtHE <- shed18$SL2_b
shed17$OwnDebtHE <- shed17$SL2_b
shed16$OwnDebtHE <- shed16$SL2_b
shed15$OwnDebtHE <- shed15$SL2_b

shed21$OwnDebtCC <- shed21$SL2_c
shed20$OwnDebtCC <- shed20$SL2_c
shed19$OwnDebtCC <- shed19$SL2_c
shed18$OwnDebtCC <- shed18$SL2_c
shed17$OwnDebtCC <- shed17$SL2_c
shed16$OwnDebtCC <- shed16$SL2_c
shed15$OwnDebtCC <- shed15$SL2_c

shed21$OwnDebtOther <- shed21$SL2_d
shed20$OwnDebtOther <- shed20$SL2_d
shed19$OwnDebtOther <- shed19$SL2_d
shed18$OwnDebtOther <- shed18$SL2_d
shed17$OwnDebtOther <- shed17$SL2_d
shed16$OwnDebtOther <- shed16$SL2_d
shed15$OwnDebtOther <- shed15$SL2_d

shed21$OwnDebtTot <- shed21$SL3
shed20$OwnDebtTot <- shed20$SL3
shed19$OwnDebtTot <- shed19$SL3
shed18$OwnDebtTot <- shed18$SL3
shed17$OwnDebtTot <- shed17$SL3
shed16$OwnDebtTot <- shed16$SL3_TOTAL
shed15$OwnDebtTot <- shed15$SL3_TOTAL

shed21$OwnDebtMon <- shed21$SL4
shed20$OwnDebtMon <- shed20$SL4
shed19$OwnDebtMon <- shed19$SL4
shed18$OwnDebtMon <- shed18$SL4
shed17$OwnDebtMon <- shed17$SL4
shed16$OwnDebtMon <- shed16$SL4
shed15$OwnDebtMon <- shed15$SL4

shed21$OwnDebtBehind <- shed21$SL6
shed20$OwnDebtBehind <- shed20$SL6
shed19$OwnDebtBehind <- shed19$SL6
shed18$OwnDebtBehind <- shed18$SL6
shed17$OwnDebtBehind <- shed17$SL6
shed16$OwnDebtBehind <- shed16$SL6
shed15$OwnDebtBehind <- shed15$SL6

shed21$OwnRepaid <- shed21$SL7
shed20$OwnRepaid <- shed20$SL7
shed19$OwnRepaid <- shed19$SL7
shed18$OwnRepaid <- shed18$SL7
shed17$OwnRepaid <- shed17$SL7
shed16$OwnRepaid <- shed16$SL7
shed15$OwnRepaid <- shed15$SL7

shed21$OwnCert <- shed21$SL8_a
shed20$OwnCert <- shed20$SL8_a
shed19$OwnCert <- shed19$SL8_a
shed18$OwnCert <- shed18$SL8_a
shed17$OwnCert <- shed17$SL8_a
shed16$OwnCert <- shed16$SL8_a
shed15$OwnCert <- shed15$SL8_a

shed21$OwnAssoc <- shed21$SL8_b
shed20$OwnAssoc <- shed20$SL8_b
shed19$OwnAssoc <- shed19$SL8_b
shed18$OwnAssoc <- shed18$SL8_b
shed17$OwnAssoc <- shed17$SL8_b
shed16$OwnAssoc <- shed16$SL8_b
shed15$OwnAssoc <- shed15$SL8_b

shed21$OwnBach <- shed21$SL8_c
shed20$OwnBach <- shed20$SL8_c
shed19$OwnBach <- shed19$SL8_c
shed18$OwnBach <- shed18$SL8_c
shed17$OwnBach <- shed17$SL8_c
shed16$OwnBach <- shed16$SL8_c
shed15$OwnBach <- shed15$SL8_c

shed21$OwnGrad <- ifelse((shed21$SL8_d=="Yes") | (shed21$SL8_e=="Yes"), "Yes", "No")
shed20$OwnGrad <- ifelse((shed20$SL8_d=="Yes") | (shed20$SL8_e=="Yes"), "Yes", "No")
shed19$OwnGrad <- ifelse((shed19$SL8_d=="Yes") | (shed19$SL8_e=="Yes"), "Yes", "No")
shed18$OwnGrad <- ifelse((shed18$SL8_d=="Yes") | (shed18$SL8_e=="Yes"), "Yes", "No")
shed17$OwnGrad <- ifelse((shed17$SL8_d=="Yes") | (shed17$SL8_e=="Yes"), "Yes", "No")
shed16$OwnGrad <- ifelse((shed16$SL8_d=="Yes") | (shed16$SL8_e=="Yes"), "Yes", "No")
shed15$OwnGrad <- ifelse((shed15$SL8_d=="Yes") | (shed15$SL8_e=="Yes"), "Yes", "No")

shed21$SpouseDebt <- shed21$SL10
shed20$SpouseDebt <- shed20$SL10
shed19$SpouseDebt <- shed19$SL10
shed18$SpouseDebt <- shed18$SL10
shed17$SpouseDebt <- shed17$SL10
shed16$SpouseDebt <- shed16$SL10
shed15$SpouseDebt <- shed15$SL10

shed21$ChildDebt <- shed21$SL11
shed20$ChildDebt <- shed20$SL11
shed19$ChildDebt <- shed19$SL11
shed18$ChildDebt <- shed18$SL11
shed17$ChildDebt <- shed17$SL11
shed16$ChildDebt <- shed16$SL11
shed15$ChildDebt <- shed15$SL11

shed21$ChildDebtSL <- shed21$SL12_a
shed20$ChildDebtSL <- shed20$SL12_a
shed19$ChildDebtSL <- shed19$SL12_a
shed18$ChildDebtSL <- shed18$SL12_a
shed17$ChildDebtSL <- shed17$SL12_a
shed16$ChildDebtSL <- shed16$SL12_a
shed15$ChildDebtSL <- rep(NA, nrow(shed15))

shed21$ChildDebtHE <- shed21$SL12_b
shed20$ChildDebtHE <- shed20$SL12_b
shed19$ChildDebtHE <- shed19$SL12_b
shed18$ChildDebtHE <- shed18$SL12_b
shed17$ChildDebtHE <- shed17$SL12_b
shed16$ChildDebtHE <- shed16$SL12_b
shed15$ChildDebtHE <- rep(NA, nrow(shed15))

shed21$ChildDebtCC <- shed21$SL12_c
shed20$ChildDebtCC <- shed20$SL12_c
shed19$ChildDebtCC <- shed19$SL12_c
shed18$ChildDebtCC <- shed18$SL12_c
shed17$ChildDebtCC <- shed17$SL12_c
shed16$ChildDebtCC <- shed16$SL12_c
shed15$ChildDebtCC <- rep(NA, nrow(shed15))

shed21$ChildDebtOther <- shed21$SL12_d
shed20$ChildDebtOther <- shed20$SL12_d
shed19$ChildDebtOther <- shed19$SL12_d
shed18$ChildDebtOther <- shed18$SL12_d
shed17$ChildDebtOther <- shed17$SL12_d
shed16$ChildDebtOther <- shed16$SL12_d
shed15$ChildDebtOther <- rep(NA, nrow(shed15))

shed21$Retired <- shed21$D1I
shed20$Retired <- shed20$D1I
shed19$Retired <- shed19$D1I
shed18$Retired <- shed18$D1I
shed17$Retired <- shed17$D1I
shed16$Retired <- shed16$D1_i
shed15$Retired <- shed15$D2

shed21$RetireOnTrack <- shed21$K0
shed20$RetireOnTrack <- shed20$K0
shed19$RetireOnTrack <- shed19$K0
shed18$RetireOnTrack <- shed18$K0
shed17$RetireOnTrack <- shed17$K0
shed16$RetireOnTrack <- rep(NA, nrow(shed16))
shed15$RetireOnTrack <- rep(NA, nrow(shed15))

shed21$SocSec <- shed21$I0_c
shed20$SocSec <- shed20$I0_c
shed19$SocSec <- shed19$I0_c
shed18$SocSec <- shed18$I0_c
shed17$SocSec <- shed17$I0_c
shed16$SocSec <- shed16$I0_e
shed15$SocSec <- shed15$I0_e

shed21$Welfare <- shed21$I0_d
shed20$Welfare <- shed20$I0_d
shed19$Welfare <- shed19$I0_d
shed18$Welfare <- shed18$I0_d
shed17$Welfare <- shed17$I0_d
shed16$Welfare <- rep(NA, nrow(shed16))
shed15$Welfare <- rep(NA, nrow(shed15))

shed21$TotalInc <- shed21$I40
shed20$TotalInc <- shed20$I40
shed19$TotalInc <- shed19$I40
shed18$TotalInc <- shed18$I40
shed17$TotalInc <- shed17$I40
shed16$TotalInc <- shed16$I4A
shed15$TotalInc <- shed15$I4A

shed21$EITC <- shed21$I41_a
shed20$EITC <- shed20$I41_a
shed19$EITC <- shed19$I41_a
shed18$EITC <- shed18$I41_a
shed17$EITC <- shed17$I41_a
shed16$EITC <- rep(NA, nrow(shed16))
shed15$EITC <- rep(NA, nrow(shed15))

shed21$SNAP <- shed21$I41_b
shed20$SNAP <- shed20$I41_b
shed19$SNAP <- shed19$I41_b
shed18$SNAP <- shed18$I41_b
shed17$SNAP <- shed17$I41_b
shed16$SNAP <- rep(NA, nrow(shed16))
shed15$SNAP <- rep(NA, nrow(shed15))

shed21$WIC <- shed21$I41_c
shed20$WIC <- shed20$I41_c
shed19$WIC <- shed19$I41_c
shed18$WIC <- shed18$I41_c
shed17$WIC <- shed17$I41_c
shed16$WIC <- rep(NA, nrow(shed16))
shed15$WIC <- rep(NA, nrow(shed15))

shed21$HouseAssist <- shed21$I41_d
shed20$HouseAssist <- shed20$I41_d
shed19$HouseAssist <- shed19$I41_d
shed18$HouseAssist <- shed18$I41_d
shed17$HouseAssist <- shed17$I41_d
shed16$HouseAssist <- rep(NA, nrow(shed16))
shed15$HouseAssist <- rep(NA, nrow(shed15))

shed21$FRPL <- shed21$I41_e
shed20$FRPL <- shed20$I41_e
shed19$FRPL <- shed19$I41_e
shed18$FRPL <- shed18$I41_e
shed17$FRPL <- shed17$I41_e
shed16$FRPL <- rep(NA, nrow(shed16))
shed15$FRPL <- rep(NA, nrow(shed15))

shed21$ThreeMonSave <- shed21$EF1
shed20$ThreeMonSave <- shed20$EF1
shed19$ThreeMonSave <- shed19$EF1
shed18$ThreeMonSave <- shed18$EF1
shed17$ThreeMonSave <- shed17$EF1
shed16$ThreeMonSave <- shed16$EF1
shed15$ThreeMonSave <- shed15$EF1

shed21$ThreeMonCover <- shed21$EF2
shed20$ThreeMonCover <- shed20$EF2
shed19$ThreeMonCover <- shed19$EF2
shed18$ThreeMonCover <- shed18$EF2
shed17$ThreeMonCover <- shed17$EF2
shed16$ThreeMonCover <- shed16$EF2
shed15$ThreeMonCover <- shed15$EF2

shed21$CCA400 <- shed21$EF3_a
shed20$CCA400 <- shed20$EF3_a
shed19$CCA400 <- shed19$EF3_a
shed18$CCA400 <- shed18$EF3_a
shed17$CCA400 <- shed17$EF3_a
shed16$CCA400 <- shed16$EF3_a
shed15$CCA400 <- shed15$EF3_a

shed21$CCB400 <- shed21$EF3_b
shed20$CCB400 <- shed20$EF3_b
shed19$CCB400 <- shed19$EF3_b
shed18$CCB400 <- shed18$EF3_b
shed17$CCB400 <- shed17$EF3_b
shed16$CCB400 <- shed16$EF3_b
shed15$CCB400 <- shed15$EF3_b

shed21$Cash400 <- shed21$EF3_c
shed20$Cash400 <- shed20$EF3_c
shed19$Cash400 <- shed19$EF3_c
shed18$Cash400 <- shed18$EF3_c
shed17$Cash400 <- shed17$EF3_c
shed16$Cash400 <- shed16$EF3_c
shed15$Cash400 <- shed15$EF3_c

shed21$Loan400 <- shed21$EF3_d
shed20$Loan400 <- shed20$EF3_d
shed19$Loan400 <- shed19$EF3_d
shed18$Loan400 <- shed18$EF3_d
shed17$Loan400 <- shed17$EF3_d
shed16$Loan400 <- shed16$EF3_d
shed15$Loan400 <- shed15$EF3_d

shed21$Friend400 <- shed21$EF3_e
shed20$Friend400 <- shed20$EF3_e
shed19$Friend400 <- shed19$EF3_e
shed18$Friend400 <- shed18$EF3_e
shed17$Friend400 <- shed17$EF3_e
shed16$Friend400 <- shed16$EF3_e
shed15$Friend400 <- shed15$EF3_e

shed21$Payday400 <- shed21$EF3_f
shed20$Payday400 <- shed20$EF3_f
shed19$Payday400 <- shed19$EF3_f
shed18$Payday400 <- shed18$EF3_f
shed17$Payday400 <- shed17$EF3_f
shed16$Payday400 <- shed16$EF3_f
shed15$Payday400 <- shed15$EF3_f

shed21$Sell400 <- shed21$EF3_g
shed20$Sell400 <- shed20$EF3_g
shed19$Sell400 <- shed19$EF3_g
shed18$Sell400 <- shed18$EF3_g
shed17$Sell400 <- shed17$EF3_g
shed16$Sell400 <- shed16$EF3_g
shed15$Sell400 <- shed15$EF3_g

shed21$None400 <- shed21$EF3_h
shed20$None400 <- shed20$EF3_h
shed19$None400 <- shed19$EF3_h
shed18$None400 <- shed18$EF3_h
shed17$None400 <- shed17$EF3_h
shed16$None400 <- shed16$EF3_h
shed15$None400 <- shed15$EF3_h

shed21$PayBills <- shed21$EF5A
shed20$PayBills <- shed20$EF5A
shed19$PayBills <- shed19$EF5A
shed18$PayBills <- shed18$EF5A
shed17$PayBills <- shed17$EF5A
shed16$PayBills <- shed16$EF5A
shed15$PayBills <- rep(NA, nrow(shed15))

shed21$PayBills400 <- shed21$EF5B
shed20$PayBills400 <- shed20$EF5B
shed19$PayBills400 <- shed19$EF5B
shed18$PayBills400 <- shed18$EF5B
shed17$PayBills400 <- shed17$EF5B
shed16$PayBills400 <- shed16$EF5B
shed15$PayBills400 <- rep(NA, nrow(shed15))

shed21$PayBills400 <- shed21$EF5B
shed20$PayBills400 <- shed20$EF5B
shed19$PayBills400 <- shed19$EF5B
shed18$PayBills400 <- shed18$EF5B
shed17$PayBills400 <- shed17$EF5B
shed16$PayBills400 <- rep(NA, nrow(shed16))
shed15$PayBills400 <- rep(NA, nrow(shed15))

shed21$PartialRent <- shed21$EF6A_a
shed20$PartialRent <- shed20$EF6A_a
shed19$PartialRent <- shed19$EF6A_a
shed18$PartialRent <- shed18$EF6A_a
shed17$PartialRent <- shed17$EF6A_a
shed16$PartialRent <- rep(NA, nrow(shed16))
shed15$PartialRent <- rep(NA, nrow(shed15))

shed21$PartialCC <- shed21$EF6A_b
shed20$PartialCC <- shed20$EF6A_b
shed19$PartialCC <- shed19$EF6A_b
shed18$PartialCC <- shed18$EF6A_b
shed17$PartialCC <- shed17$EF6A_b
shed16$PartialCC <- rep(NA, nrow(shed16))
shed15$PartialCC <- rep(NA, nrow(shed15))

shed21$PartialSL <- shed21$EF6A_f
shed20$PartialSL <- shed20$EF6A_f
shed19$PartialSL <- shed19$EF6A_f
shed18$PartialSL <- shed18$EF6A_f
shed17$PartialSL <- shed17$EF6A_f
shed16$PartialSL <- rep(NA, nrow(shed16))
shed15$PartialSL <- rep(NA, nrow(shed15))

shed21$PartialSL400 <- shed21$EF6B_f
shed20$PartialSL400 <- shed20$EF6B_f
shed19$PartialSL400 <- shed19$EF6B_f
shed18$PartialSL400 <- shed18$EF6B_f
shed17$PartialSL400 <- shed17$EF6B_f
shed16$PartialSL400 <- rep(NA, nrow(shed16))
shed15$PartialSL400 <- rep(NA, nrow(shed15))

shed21$Occupation <- shed21$ppcm0160
shed20$Occupation <- shed20$ppcm0160
shed19$Occupation <- shed19$ppcm0160
shed18$Occupation <- shed18$ppcm0160
shed17$Occupation <- shed17$ppcm0160
shed16$Occupation <- shed16$ppcm0160
shed15$Occupation <- shed15$ppcm0160

shed21$Savings <- shed21$ppfs0596
shed20$Savings <- shed20$ppfs0596
shed19$Savings <- shed19$ppfs0596
shed18$Savings <- shed18$ppfs0596
shed17$Savings <- shed17$ppfs0596
shed16$Savings <- shed16$ppfs0596
shed15$Savings <- shed15$ppfs0596

shed21$CreditScore <- shed21$ppfs1482
shed20$CreditScore <- shed20$ppfs1482
shed19$CreditScore <- shed19$ppfs1482
shed18$CreditScore <- rep(NA, nrow(shed18))
shed17$CreditScore <- rep(NA, nrow(shed17))
shed16$CreditScore <- shed16$C1
shed15$CreditScore <- shed15$C1

shed21$InstLevel <- shed21$iclevel
shed20$InstLevel <- shed20$iclevel
shed19$InstLevel <- shed19$iclevel
shed18$InstLevel <- shed18$iclevel
shed17$InstLevel <- rep(NA, nrow(shed17))
shed16$InstLevel <- rep(NA, nrow(shed16))
shed15$InstLevel <- shed15$sector

shed21$InstControl <- shed21$control
shed20$InstControl <- shed20$control
shed19$InstControl <- shed19$control
shed18$InstControl <- shed18$control
shed17$InstControl <- shed17$control
shed16$InstControl <- rep(NA, nrow(shed16))
shed15$InstControl <- shed15$control

shed21$ChildrenUnder18 <- shed21$L0_b
shed20$ChildrenUnder18 <- shed20$L0_b
shed19$ChildrenUnder18 <- shed19$L0_b
shed18$ChildrenUnder18 <- shed18$L0_b
shed17$ChildrenUnder18 <- shed17$L0_b
shed16$ChildrenUnder18 <- shed16$L0_b
shed15$ChildrenUnder18 <- shed15$D0_b

shed21 <- shed21 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed20 <- shed20 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed19 <- shed19 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed18 <- shed18 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed17 <- shed17 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed16 <- shed16 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed15 <- shed15 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed21$SurveyYear <- rep(2021, nrow(shed21))
shed20$SurveyYear <- rep(2020, nrow(shed20))
shed19$SurveyYear <- rep(2019, nrow(shed19))
shed18$SurveyYear <- rep(2018, nrow(shed18))
shed17$SurveyYear <- rep(2017, nrow(shed17))
shed16$SurveyYear <- rep(2016, nrow(shed16))
shed15$SurveyYear <- rep(2015, nrow(shed15))

shed <- rbind(shed21, shed20, shed19, shed18, shed17, shed16, shed15)
```

```{r shedSetup2, warning=FALSE}

######################################################
### In this code chunk we make adjustments to the  ###
### data values to accommodate the fact that the   ###
### different years of SHED data have slight       ###
### differences to the survey responses that can   ###
### cause problems when pooling the data. I have   ###
### commented out the "table" calls, which were    ###
### used to know which adjustments needed to be    ###
### made.                                          ###
######################################################

# State
# table(shed$State)
shed$State <- toupper(shed$State)
shed$State[shed$State != "CA"] <- "Rest of U.S."
# table(shed$State)

# Race
# table(shed$Race)

# Gender
# table(shed$Gender)

# FinManage
# table(shed$FinManage)

# ParComp
# table(shed$ParComp)

# HomeOwn
# table(shed$HomeOwn)

shed$HomeOwn[shed$HomeOwn=="I [and/or my spouse/partner] don't own [our/my] home or pay rent."] <- "Other"
shed$HomeOwn[shed$HomeOwn=="I [and/or my spouse/partner] own [our/my] home free and clear (without a mortgage or loan)."] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="I [and/or my spouse/partner] own [our/my] home with a mortgage or loan."] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="I [and/or my spouse/partner] pay rent."] <- "Pay rent"
shed$HomeOwn[shed$HomeOwn=="I [PPMARITins2] don\x92t own [PPMARITins3] home or pay rent."] <- "Other"
shed$HomeOwn[shed$HomeOwn=="I [PPMARITins2] own [PPMARITins3] home free and clear (without a mortgage or loan)."] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="I [PPMARITins2] own [PPMARITins3] home with a mortgage or loan."] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="I [PPMARITins2] pay rent."] <- "Pay rent"
shed$HomeOwn[shed$HomeOwn=="Neither own home nor pay rent"] <- "Other"
shed$HomeOwn[shed$HomeOwn=="neither own home nor pay rent."] <- "Other"
shed$HomeOwn[shed$HomeOwn=="Neither own nor pay rent"] <- "Other"
shed$HomeOwn[shed$HomeOwn=="Own home free and clear (without a mortgage or loan)"] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="own home free and clear (without a mortgage or loan)."] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="Own home with a mortgage or loan"] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="own home with a mortgage or loan."] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="Own your home free and clear (without a mortgage or loan)"] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="Own your home with a mortgage or loan"] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="Pay rent"] <- "Pay rent"
shed$HomeOwn[shed$HomeOwn=="pay rent."] <- "Pay rent"
# table(shed$HomeOwn)

# CCApprov
# table(shed$CCApprov)
shed$CCApprov[shed$CCApprov=="Don't know"] <- "Don't know"
shed$CCApprov[shed$CCApprov=="Don’t know"] <- "Don't know"
shed$CCApprov[shed$CCApprov=="Don\x92t know"] <- "Don't know"
# table(shed$CCApprov)

# CreditDeny
# table(shed$CreditDeny)

# UnpaidCC
# table(shed$UnpaidCC)

# CCBalance
# table(shed$CCBalance)
shed$CCBalance[shed$CCBalance=="Never carried a balance (always pay in full)"] <- "Always pay in full"
shed$CCBalance[shed$CCBalance=="Never carried an unpaid balance (always pay in full)"] <- "Always pay in full"
# table(shed$CCBalance)

# EdAttain
# table(shed$EdAttain)
shed$EdAttain[shed$EdAttain=="Bachelor's degree"] <- "Bachelor's degree"
shed$EdAttain[shed$EdAttain=="Bachelor’s degree"] <- "Bachelor's degree"
shed$EdAttain[shed$EdAttain=="Bachelor\x92s degree"] <- "Bachelor's degree"
shed$EdAttain[shed$EdAttain=="Doctoral degree"] <- "Doctorate"
shed$EdAttain[shed$EdAttain=="Doctoral Degree"] <- "Doctorate"
shed$EdAttain[shed$EdAttain=="Less than high school degree"] <- "Less than high school diploma"
shed$EdAttain[shed$EdAttain=="Less than High School degree"] <- "Less than high school diploma"
shed$EdAttain[shed$EdAttain=="Master's degree"] <- "Master's degree"
shed$EdAttain[shed$EdAttain=="Master’s degree"] <- "Master's degree"
shed$EdAttain[shed$EdAttain=="Master\x92s degree"] <- "Master's degree"
shed$EdAttain[shed$EdAttain=="Professional degree (e.g. MBA, MD, JD)"] <- "Professional degree"
shed$EdAttain[shed$EdAttain=="Professional degree (e.g., MBA, MD, JD)"]  <- "Professional degree"
shed$EdAttain[shed$EdAttain=="Some college but no degree (including currently enrolled in college)"] <- "Some college, no degree"
shed$EdAttain[shed$EdAttain=="Certificate or technical degree"] <- "Some college, no degree"
# table(shed$EdAttain)

# EdPayoff1
# table(shed$EdPayoff1)
shed$EdPayoff1[shed$EdPayoff1=="About the same financial benefits and financial costs"] <- "About the same"

# DiffField1
# table(shed$DiffField1)

# DiffSchool1
# table(shed$DiffSchool1)

# LessEd1
# table(shed$LessEd1)

# MoreEd1
# table(shed$MoreEd1)

# OwnDebt
# table(shed$OwnDebt)

# OwnDebtSL
# table(shed$OwnDebtSL)

# OwnDebtHE
# table(shed$OwnDebtHE)

# OwnDebtCC
# table(shed$OwnDebtCC)

# OwnDebtOther
# table(shed$OwnDebtOther)

# OwnDebtTot
# table(shed$OwnDebtTot)
shed$OwnDebtTot1 <- shed$OwnDebtTot
shed$OwnDebtTot1[shed$OwnDebtTot=="Less than $5,000"] <- "2500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$5,000 to $9,999"] <- "7500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$10,000 to $14,999"] <- "12500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$15,000 to $19,999"] <- "17500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$20,000 to $24,999"] <- "22500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$25,000 to $29,999"] <- "27500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$30,000 to $39,999"] <- "35000"
shed$OwnDebtTot1[shed$OwnDebtTot=="$40,000 to $49,999"] <- "45000"
shed$OwnDebtTot1[shed$OwnDebtTot=="$50,000 to $74,999"] <- "62500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$75,000 to $99,999"] <- "87500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$100,000 or above"] <- "105000"
shed$OwnDebtTot2 <- as.numeric(shed$OwnDebtTot1)
shed$OwnDebtTot3 <- rep(NA, nrow(shed))
shed$OwnDebtTot3[shed$OwnDebtTot2 < 5000] <- "Less than $5,000"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 5000 & shed$OwnDebtTot2 <= 9999] <- "$5,000 to $9,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 10000 & shed$OwnDebtTot2 <= 14999] <- "$10,000 to $14,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 15000 & shed$OwnDebtTot2 <= 19999] <- "$15,000 to $19,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 20000 & shed$OwnDebtTot2 <= 24999] <- "$20,000 to $24,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 25000 & shed$OwnDebtTot2 <= 29999] <- "$25,000 to $29,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 30000 & shed$OwnDebtTot2 <= 39999] <- "$30,000 to $39,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 40000 & shed$OwnDebtTot2 <= 49999] <- "$40,000 to $49,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 50000 & shed$OwnDebtTot2 <= 74999] <- "$50,000 to $74,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 75000 & shed$OwnDebtTot2 <= 99999] <- "$75,000 to $99,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 > 100000] <- "$100,000 or above"
shed$OwnDebtTot3[shed$OwnDebtTot2 == 1e+05] <- NA
# table(shed$OwnDebtTot3)

# OwnDebtMon
# table(shed$OwnDebtMon)
shed$OwnDebtMon1 <- shed$OwnDebtMon
shed$OwnDebtMon1[shed$OwnDebtMon=="I am currently not required to make any payments on these loans"] <- "0"
shed$OwnDebtMon1[shed$OwnDebtMon=="I am not currently required to make any payments on these loans"] <- "0"
shed$OwnDebtMon1[shed$OwnDebtMon=="I was not required to make any payments on these loans"] <- "0"
shed$OwnDebtMon1[shed$OwnDebtMon=="$1 to $99"] <- "99"
shed$OwnDebtMon1[shed$OwnDebtMon=="$1 to $49"] <- "49"
shed$OwnDebtMon1[shed$OwnDebtMon=="$59 to $49"] <- "99"
shed$OwnDebtMon1[shed$OwnDebtMon=="$100 to $199"] <- "199"
shed$OwnDebtMon1[shed$OwnDebtMon=="$200 to $299"] <- "299"
shed$OwnDebtMon1[shed$OwnDebtMon=="$300 to $399"] <- "399"
shed$OwnDebtMon1[shed$OwnDebtMon=="$400 to $499"] <- "499"
shed$OwnDebtMon1[shed$OwnDebtMon=="$500 to $749"] <- "749"
shed$OwnDebtMon1[shed$OwnDebtMon=="$500 to $999"] <- "599"
shed$OwnDebtMon1[shed$OwnDebtMon=="$750 to $999"] <- "999"
shed$OwnDebtMon1[shed$OwnDebtMon=="$1,000 or above"] <- "1000"
shed$OwnDebtMon2 <- as.numeric(shed$OwnDebtMon1)
shed$OwnDebtMon3 <- rep(NA, nrow(shed))
shed$OwnDebtMon3[shed$OwnDebtMon2 == 0] <- "$0"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 1 & shed$OwnDebtMon2 <= 99] <- "$1 to $99"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 100 & shed$OwnDebtMon2 <= 199] <- "$100 to $199"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 200 & shed$OwnDebtMon2 <= 299] <- "$200 to $299"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 300 & shed$OwnDebtMon2 <= 399] <- "$300 to $399"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 400 & shed$OwnDebtMon2 <= 499] <- "$400 to $499"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 500 & shed$OwnDebtMon2 <= 999] <- "$500 to $999"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 1000] <- "$1,000 or above"
shed$OwnDebtMon3[shed$OwnDebtMon2 == "-2"] <- NA
# table(shed$OwnDebtMon3)

# OwnDebtBehind
# table(shed$OwnDebtBehind)

# OwnRepaid
# table(shed$OwnRepaid)

# OwnCert
# table(shed$OwnCert)

# OwnAssoc
# table(shed$OwnAssoc)

# OwnBach
# table(shed$OwnBach)

# OwnGrad
# table(shed$OwnGrad)

# SpouseDebt
# table(shed$SpouseDebt)

# ChildDebt
# table(shed$ChildDebt)

# ChildDebtSL
# table(shed$ChildDebtSL)

# ChildDebtHE
# table(shed$ChildDebtHE)

# ChildDebtCC
# table(shed$ChildDebtCC)

# ChildDebtOther
# table(shed$ChildDebtOther)

# Retired
# table(shed$Retired)
shed$Retired[shed$Retired=="No"] <- "Not retired"
shed$Retired[shed$Retired=="Disabled and not working"] <- "Not retired"
shed$Retired[shed$Retired=="Employed now"] <- "Not retired"
shed$Retired[shed$Retired=="Homemaker"] <- "Not retired"
shed$Retired[shed$Retired=="Not employed, but looking for a job"] <- "Not retired"
shed$Retired[shed$Retired=="Temporarily laid off"] <- "Not retired"
shed$Retired[shed$Retired=="Student"] <- "Not retired"
shed$Retired[shed$Retired=="Not employed and not looking for a job"] <- "Not retired"
shed$Retired[shed$Retired=="Yes"] <- "Retired"
# table(shed$Retired)

# RetireOnTrack
# table(shed$RetireOnTrack)
shed$RetireOnTrack[shed$RetireOnTrack=="Don't know"] <- "Don't know"
shed$RetireOnTrack[shed$RetireOnTrack=="Don’t know"] <- "Don't know"
shed$RetireOnTrack[shed$RetireOnTrack=="Don\x92t know"] <- "Don't know"
# table(shed$RetireOnTrack)

# SocSec
# table(shed$SocSec)

# Welfare
# table(shed$Welfare)

# TotalInc
# table(shed$TotalInc)
shed$TotalInc[shed$TotalInc=="0"] <- "$0 to $4,999"
shed$TotalInc[shed$TotalInc=="$0"] <- "$0 to $4,999"
shed$TotalInc[shed$TotalInc=="$1 to $4,999"] <- "$0 to $4,999"
# table(shed$TotalInc)

# EITC
# table(shed$EITC)

# SNAP
# table(shed$SNAP)

# WIC
# table(shed$WIC)

# HouseAssist
# table(shed$HouseAssist)

# FRPL
# table(shed$FRPL)

# ThreeMonSave
# table(shed$ThreeMonSave)

# ThreeMonCover
# table(shed$ThreeMonCover)

# CCA400
# table(shed$CCA400)
shed$CCA400[shed$CCA400=="Put it on my credit card and pay it off in full at the next statement"] <- "Yes"
# table(shed$CCA400)

# CCB400
# table(shed$CCB400)
shed$CCB400[shed$CCB400=="Put it on my credit card and pay it off over time"] <- "Yes"
# table(shed$CCB400)

# Cash400
# table(shed$Cash400)
shed$Cash400[shed$Cash400=="With the money currently in my checking/savings account or with cash"] <- "Yes"
# table(shed$Cash400)

# Loan400
# table(shed$Loan400)
shed$Loan400[shed$Loan400=="Using money from a bank loan or line of credit"] <- "Yes"
# table(shed$Loan400)

# Friend400
# table(shed$Friend400)
shed$Friend400[shed$Friend400=="By borrowing from a friend or family member"] <- "Yes"
# table(shed$Friend400)

# Payday400
# table(shed$Payday400)
shed$Payday400[shed$Payday400=="Using a payday loan, deposit advance, or overdraft"] <- "Yes"
# table(shed$Payday400)

# Sell400
# table(shed$Sell400)
shed$Sell400[shed$Sell400=="By selling something"] <- "Yes"
# table(shed$Sell400)

# None400
# table(shed$None400)
shed$None400[shed$None400=="I wouldn’t be able to pay for the expense right now"] <- "Yes"
# table(shed$None400)

# PayBills
# table(shed$PayBills)
shed$PayBills[shed$PayBills=="Able to pay all bills"] <- "I will be able to pay all of my bills in full"
shed$PayBills[shed$PayBills=="I cannot pay some bills or will only make a partial payment on some of them"] <- "I cannot pay some bills or will only make a partial payment on them"
shed$PayBills[shed$PayBills=="Can’t pay some bills"] <- "I cannot pay some bills or will only make a partial payment on them"
shed$PayBills[shed$PayBills=="Can\x92t pay some bills"] <- "I cannot pay some bills or will only make a partial payment on them"
# table(shed$PayBills)

# PayBills400
# table(shed$PayBills400)
shed$PayBills400[shed$PayBills400=="Could not pay some bills"] <- "I could not pay some other bills or would only make a partial payment on some of them"
shed$PayBills400[shed$PayBills400=="Would still be able to pay all bills"] <- "I would still be able to pay all of my other bills in full"
# table(shed$PayBills400)

# PartialRent
# table(shed$PartialRent)

# PartialCC
# table(shed$PartialCC)

# PartialSL
# table(shed$PartialSL)

# PartialSL400
# table(shed$PartialSL400)

# Occupation
# table(shed$Occupation)
shed$Occupation[shed$Occupation=="Business Operations (including Marketing)"] <- "Business and Financial Operations"
shed$Occupation[shed$Occupation=="Financial Operations or Financial Services (including Financial Advisor, Broker)"] <- "Business and Financial Operations"
shed$Occupation[shed$Occupation=="Health Diagnosing or Treating Practitioner (such as physician, nurse, dentist, v"] <- "Health Diagnosing or Treating Practitioner"
shed$Occupation[shed$Occupation=="Health Diagnosing or Treating Practitioner (such as physician, nurse, dentist, veterinarian, pharmacist)"] <- "Health Diagnosing or Treating Practitioner"
shed$Occupation[shed$Occupation=="Other Health Care Practitioner (such as nurse, pharmacist, chiropractor, dietici"] <- "Other Health Care Practitioner"
shed$Occupation[shed$Occupation=="Other Health Care Practitioner (such as nurse, pharmacist, chiropractor, dietician)"] <- "Other Health Care Practitioner"
shed$Occupation[shed$Occupation=="Retail Sales"] <- "Sales"
shed$Occupation[shed$Occupation=="Sales Representative"] <- "Sales"
# table(shed$Occupation)

# Savings
# table(shed$Savings)
shed$Savings[shed$Savings=="Under $5,000"] <- "Under $50,000"
shed$Savings[shed$Savings=="$5,000 - $9,999"] <- "Under $50,000"
shed$Savings[shed$Savings=="$10,000 - $24,999"] <- "Under $50,000"
shed$Savings[shed$Savings=="$25,000 - $34,999"] <- "Under $50,000"
shed$Savings[shed$Savings=="$35,000 - $49,999"] <- "Under $50,000"
shed$Savings[shed$Savings=="$50,000 - $74,999"] <- "$50,000 - $99,999"
shed$Savings[shed$Savings=="$75,000 - $99,999"] <- "$50,000 - $99,999"
shed$Savings[shed$Savings=="Not asked"] <- NA
# table(shed$Savings)

# CreditScore
# table(shed$CreditScore)
shed$CreditScore[shed$CreditScore=="Don\x92t know"] <- "Don't know"
shed$CreditScore[shed$CreditScore=="Don't know my score or how to rate it"] <- "Don't know"
shed$CreditScore[shed$CreditScore=="Don’t know"] <- "Don't know"
shed$CreditScore[shed$CreditScore=="Don\x92t know my score or how to rate it"] <- "Don't know"
shed$CreditScore[shed$SurveyYear %in% c(2015, 2016)] <- NA # Inconsistent measure
# table(shed$CreditScore, shed$SurveyYear)

# InstLevel
# table(shed$InstLevel)
shed$InstLevel[shed$InstLevel=="[2, 4) years"] <- "Two-year"
shed$InstLevel[shed$InstLevel=="<2 years"] <- "Less than two-year"
shed$InstLevel[shed$InstLevel==">=4 years"] <- "Four-year"
shed$InstLevel[shed$InstLevel=="Administrative Unit"] <- NA
shed$InstLevel[shed$InstLevel=="Private for-profit, 2-year"] <- "Two-year"
shed$InstLevel[shed$InstLevel=="Private for-profit, 4-year or above"] <- "Four-year"
shed$InstLevel[shed$InstLevel=="Private for-profit, less-than 2-year"] <- "Less than two-year"
shed$InstLevel[shed$InstLevel=="Private not-for-profit, 2-year"] <- "Two-year"
shed$InstLevel[shed$InstLevel=="Private not-for-profit, 4-year or above"] <- "Four-year"
shed$InstLevel[shed$InstLevel=="Private not-for-profit, less-than 2-year"] <- "Less than two-year"
shed$InstLevel[shed$InstLevel=="Public, 2-year"] <- "Two-year"
shed$InstLevel[shed$InstLevel=="Public, 4-year or above"] <- "Four-year"
shed$InstLevel[shed$InstLevel=="Public, less-than 2-year"] <- "Less than two-year"
# table(shed$InstLevel)

# InstControl
# table(shed$InstControl)

# AnyStudentLoans
shed$AnyStudentLoans <- rep("No", nrow(shed))
shed$AnyStudentLoans[shed$OwnDebtSL=="Yes"] <- "Yes"
shed$AnyStudentLoans[shed$ChildDebtSL=="Yes"] <- "Yes"

# Count variable
shed$Count <- rep(1, nrow(shed))

```

### {.tabset}
```{r ownDebt}
# OwnDebt: # Do you currently have student loan debt or owe any money used to pay for your own education? 

# table(shed$OwnDebt)
shed.OwnDebt <- shed %>% filter((OwnDebt %in% c("Not In Universe (not asked)", "Refused", NA))==FALSE)
tblOwnDebt <- aggregate(data=shed.OwnDebt, Weight ~ OwnDebt + Race + State, FUN=sum)
tblOwnDebt2 <- aggregate(data=shed.OwnDebt, Weight ~ OwnDebt + State, FUN=sum)
tblOwnDebt2$Race <- rep("All", nrow(tblOwnDebt2))
tblOwnDebt <- rbind(tblOwnDebt, tblOwnDebt2)
tblOwnDebt <- reshape2::dcast(data=tblOwnDebt, Race + State ~ OwnDebt, value.var="Weight")
tblOwnDebt$`Share with debt` <- tblOwnDebt$Yes / (tblOwnDebt$Yes + tblOwnDebt$No)
```
#### Figure 6
##### Responses to "Do you currently have student loan debt or owe any money used to pay for your own education?" 
```{r figure6}
g6 <- ggplot(data=tblOwnDebt, mapping=aes(y=Race, x=`Share with debt`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2")

ggplotly(g6, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
#### Figure 7: Student loans
```{r OwnDebtSL}
# OwnDebtSL: # Student loan - Think about the money you currently owe for your own education. Is the money you owe for that education a: 

# table(shed$OwnDebtSL)
shed.OwnDebtSL <- shed %>% filter((OwnDebtSL %in% c("Not In Universe (not asked)", "Refused", NA))==FALSE) %>% filter(OwnDebt=="Yes")
tblOwnDebtSL <- aggregate(data=shed.OwnDebtSL, Weight ~ OwnDebtSL + Race + State, FUN=sum)
tblOwnDebtSL2 <- aggregate(data=shed.OwnDebtSL, Weight ~ OwnDebtSL + State, FUN=sum)
tblOwnDebtSL2$Race <- rep("All", nrow(tblOwnDebtSL2))
tblOwnDebtSL <- rbind(tblOwnDebtSL, tblOwnDebtSL2)
tblOwnDebtSL <- reshape2::dcast(data=tblOwnDebtSL, Race + State ~ OwnDebtSL, value.var="Weight")
tblOwnDebtSL$`Share of borrowers whose debt includes a student loan` <- tblOwnDebtSL$Yes / (tblOwnDebtSL$Yes + tblOwnDebtSL$No)
```
##### Responses to "Think about the money you currently owe for your own education. Is the money you owe for that education a student loan?"
```{r figure7A}
tblOwnDebtSL <- tblOwnDebtSL %>% filter(Race != "2+ Races, Non-Hispanic")
g7A <- ggplot(data=tblOwnDebtSL, mapping=aes(y=Race, x=`Share of borrowers whose debt includes a student loan`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2")

ggplotly(g7A, width=700, height=400)
```
#### Figure 7: Home equity
```{r OwnDebtHE}
# OwnDebtHE: # Home equity loan - Think about the money you currently owe for your own education. Is the money you owe for that education a: 

# table(shed$OwnDebtHE)
shed.OwnDebtHE <- shed %>% filter((OwnDebtHE %in% c("Not In Universe (not asked)", "Refused", NA))==FALSE) %>% filter(OwnDebt=="Yes")
tblOwnDebtHE <- aggregate(data=shed.OwnDebtHE, Weight ~ OwnDebtHE + Race + State, FUN=sum)
tblOwnDebtHE2 <- aggregate(data=shed.OwnDebtHE, Weight ~ OwnDebtHE + State, FUN=sum)
tblOwnDebtHE2$Race <- rep("All", nrow(tblOwnDebtHE2))
tblOwnDebtHE <- rbind(tblOwnDebtHE, tblOwnDebtHE2)
tblOwnDebtHE <- reshape2::dcast(data=tblOwnDebtHE, Race + State ~ OwnDebtHE, value.var="Weight")
tblOwnDebtHE$`Share of borrowers whose debt includes home equity` <- tblOwnDebtHE$Yes / (tblOwnDebtHE$Yes + tblOwnDebtHE$No)
```
##### Responses to "Think about the money you currently owe for your own education. Is the money you owe for that education home equity?
```{r figure7B}
tblOwnDebtHE <- tblOwnDebtHE %>% filter(Race != "2+ Races, Non-Hispanic")
g7B <- ggplot(data=tblOwnDebtHE, mapping=aes(y=Race, x=`Share of borrowers whose debt includes home equity`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2")

ggplotly(g7B, width=700, height=400)
```
#### Figure 7: Credit card debt
```{r OwnDebtCC}
# OwnDebtCC: # Credit card - Think about the money you currently owe for your own education. Is the money you owe for that education a:

# table(shed$OwnDebtCC)
shed.OwnDebtCC <- shed %>% filter((OwnDebtCC %in% c("Not In Universe (not asked)", "Refused", NA))==FALSE) %>% filter(OwnDebt=="Yes")
tblOwnDebtCC <- aggregate(data=shed.OwnDebtCC, Weight ~ OwnDebtCC + Race + State, FUN=sum)
tblOwnDebtCC2 <- aggregate(data=shed.OwnDebtCC, Weight ~ OwnDebtCC + State, FUN=sum)
tblOwnDebtCC2$Race <- rep("All", nrow(tblOwnDebtCC2))
tblOwnDebtCC <- rbind(tblOwnDebtCC, tblOwnDebtCC2)
tblOwnDebtCC <- reshape2::dcast(data=tblOwnDebtCC, Race + State ~ OwnDebtCC, value.var="Weight")
tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt` <- tblOwnDebtCC$Yes / (tblOwnDebtCC$Yes + tblOwnDebtCC$No)
```
##### Responses to "Think about the money you currently owe for your own education. Is the money you owe for that education credit card debt?"
```{r figure7C}
tblOwnDebtCC <- tblOwnDebtCC %>% filter(Race != "2+ Races, Non-Hispanic")
g7C <- ggplot(data=tblOwnDebtCC, mapping=aes(y=Race, x=`Share of borrowers whose debt includes credit card debt`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g7C, width=700, height=400)
```
#### Data source and notes
Insufficient data for the "2+ Races, Non-Hispanic" group. 
***
### {-}

xxx 

### {.tabset}
#### Figure 8: CA borrowers
```{r OwnDebtTotal}
# OwnDebtTot3: # Thinking specifically about the money that you owe for your own education, please tell the total amount that you currently owe on these loans. 

# table(shed$OwnDebtTot3)
shed.OwnDebtTot3 <- shed %>% filter(is.na(OwnDebtTot3)==FALSE)
tblOwnDebtTot3 <- aggregate(data=shed.OwnDebtTot3, Weight ~ OwnDebtTot3 + Race + State, FUN=sum)
tblOwnDebtTot32 <- aggregate(data=shed.OwnDebtTot3, Weight ~ OwnDebtTot3 + State, FUN=sum)
tblOwnDebtTot32$Race <- rep("All", nrow(tblOwnDebtTot32))
tblOwnDebtTot3 <- rbind(tblOwnDebtTot3, tblOwnDebtTot32)
tblOwnDebtTot3 <- reshape2::dcast(data=tblOwnDebtTot3, Race + State ~ OwnDebtTot3, value.var="Weight")
tblOwnDebtTot3$`Total weight` <- tblOwnDebtTot3$`Less than $5,000` + tblOwnDebtTot3$`$5,000 to $9,999` + tblOwnDebtTot3$`$10,000 to $14,999` + tblOwnDebtTot3$`$15,000 to $19,999` + tblOwnDebtTot3$`$20,000 to $24,999` + tblOwnDebtTot3$`$25,000 to $29,999` + tblOwnDebtTot3$`$30,000 to $39,999` + tblOwnDebtTot3$`$40,000 to $49,999` +  tblOwnDebtTot3$`$50,000 to $74,999` + tblOwnDebtTot3$`$75,000 to $99,999` + tblOwnDebtTot3$`$100,000 or above` 
tblOwnDebtTot3$`Less than $5,000` <- tblOwnDebtTot3$`Less than $5,000` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$5,000 to $9,999` <- tblOwnDebtTot3$`$5,000 to $9,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$10,000 to $14,999` <- tblOwnDebtTot3$`$10,000 to $14,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$15,000 to $19,999` <- tblOwnDebtTot3$`$15,000 to $19,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$20,000 to $24,999` <- tblOwnDebtTot3$`$20,000 to $24,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$25,000 to $29,999` <- tblOwnDebtTot3$`$25,000 to $29,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$30,000 to $39,999` <- tblOwnDebtTot3$`$30,000 to $39,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$40,000 to $49,999` <- tblOwnDebtTot3$`$40,000 to $49,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$50,000 to $74,999` <- tblOwnDebtTot3$`$50,000 to $74,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$75,000 to $99,999` <- tblOwnDebtTot3$`$75,000 to $99,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$100,000 or above` <- tblOwnDebtTot3$`$100,000 or above` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3 <- reshape2::melt(data=tblOwnDebtTot3, id.vars = c("Race", "State"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblOwnDebtTot3$variable <- factor(tblOwnDebtTot3$variable, levels = c("$100,000 or above", "$75,000 to $99,999", "$50,000 to $74,999", "$40,000 to $49,999", "$30,000 to $39,999", "$25,000 to $29,999", "$20,000 to $24,999","$15,000 to $19,999", "$10,000 to $14,999", "$5,000 to $9,999", "Less than $5,000"))
```
##### Responses to "Thinking specifically about the money that you owe for your own education, please tell the total amount that you currently owe on these loans."
```{r figure8A}
tblOwnDebtTot3.CA <- tblOwnDebtTot3 %>% filter(State=="CA")
g8A <- ggplot(data=tblOwnDebtTot3.CA, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Total student debt") + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g8A)
```
#### Figure 8: Rest of U.S. borrowers
##### Responses to "Thinking specifically about the money that you owe for your own education, please tell the total amount that you currently owe on these loans."
```{r figure8B}
tblOwnDebtTot3.US <- tblOwnDebtTot3 %>% filter(State=="Rest of U.S.")
g8B <- ggplot(data=tblOwnDebtTot3.US, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Total student debt") + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g8B)
```
#### Data source and notes
***
#### {-}

xxx 

### {.tabset}
```{r OwnDebtMon3}
# OwnDebtMon3: # Approximately how much is the total monthly payment that you are required to make on the loans from your education?

# table(shed$OwnDebtMon3)
shed.OwnDebtMon3 <- shed %>% filter(is.na(OwnDebtMon3)==FALSE) %>% filter(SurveyYear %in% c(2015, 2016, 2017, 2018, 2019))
shed.OwnDebtMon3 <- shed.OwnDebtMon3 %>% add_row(OwnDebtMon3="$400 to $499", Race="Black, Non-Hispanic", State="CA", Weight=0)
tblOwnDebtMon3 <- aggregate(data=shed.OwnDebtMon3, Weight ~ OwnDebtMon3 + Race + State, FUN=sum)
tblOwnDebtMon32 <- aggregate(data=shed.OwnDebtMon3, Weight ~ OwnDebtMon3 + State, FUN=sum)
tblOwnDebtMon32$Race <- rep("All", nrow(tblOwnDebtMon32))
tblOwnDebtMon3 <- rbind(tblOwnDebtMon3, tblOwnDebtMon32)
tblOwnDebtMon3 <- reshape2::dcast(data=tblOwnDebtMon3, Race + State ~ OwnDebtMon3, value.var="Weight")
tblOwnDebtMon3$`Total weight` <- tblOwnDebtMon3$`$0` + tblOwnDebtMon3$`$1 to $99` + tblOwnDebtMon3$`$100 to $199` + tblOwnDebtMon3$`$200 to $299` + tblOwnDebtMon3$`$300 to $399` + tblOwnDebtMon3$`$400 to $499` + tblOwnDebtMon3$`$500 to $999` + tblOwnDebtMon3$`$1,000 or above`
tblOwnDebtMon3$`$0` <- tblOwnDebtMon3$`$0` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$1 to $99` <- tblOwnDebtMon3$`$1 to $99` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$100 to $199` <- tblOwnDebtMon3$`$100 to $199` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$200 to $299` <- tblOwnDebtMon3$`$200 to $299` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$300 to $399` <- tblOwnDebtMon3$`$300 to $399` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$400 to $499` <- tblOwnDebtMon3$`$400 to $499` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$500 to $999` <- tblOwnDebtMon3$`$500 to $999` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$1,000 or above` <- tblOwnDebtMon3$`$1,000 or above` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3 <- reshape2::melt(data=tblOwnDebtMon3, id.vars = c("Race", "State"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblOwnDebtMon3$variable <- factor(tblOwnDebtMon3$variable, levels = c("$1,000 or above", "$500 to $999", "$400 to $499", "$300 to $399", "$200 to $299", "$100 to $199", "$1 to $99", "$0"))
```
#### Figure 9: CA borrowers
##### Responses to "Approximately how much is the total monthly payment that you are required to make on the loans from your education?"
```{r figure9A}
tblOwnDebtMon3.CA <- tblOwnDebtMon3 %>% filter(State=="CA")
g9A <- ggplot(data=tblOwnDebtMon3.CA, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Monthly student debt payment") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g9A, width=800, height=350)
```
#### Figure 9: Rest of U.S. borrowers
##### Responses to "Approximately how much is the total monthly payment that you are required to make on the loans from your education?"
```{r figure9B}
tblOwnDebtMon3.US <- tblOwnDebtMon3 %>% filter(State=="Rest of U.S.")
g9A <- ggplot(data=tblOwnDebtMon3.US, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Monthly student debt payment") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g9A, width=800, height=350)
```
#### Data source and notes
Survey responses collected in 2020 and 2021 are not included due to the federal student loan payment pause in place that started in March 2020 and continued through all of 2021.  
***
### {-}

xxx 

### {.tabset}
#### Figure 10
```{r OwnDebtBehind}
# OwnDebtBehind: # Are you behind on payments or in collections for one or more of the loans from your own education? 

# table(shed$OwnDebtBehind)
shed.OwnDebtBehind <- shed %>% filter((OwnDebtBehind %in% c("Not In Universe (not asked)", "Refused", "", NA))==FALSE) 
tblOwnDebtBehind <- aggregate(data=shed.OwnDebtBehind, Weight ~ OwnDebtBehind + Race + State, FUN=sum)
tblOwnDebtBehind2 <- aggregate(data=shed.OwnDebtBehind, Weight ~ OwnDebtBehind + State, FUN=sum)
tblOwnDebtBehind2$Race <- rep("All", nrow(tblOwnDebtBehind2))
tblOwnDebtBehind <- rbind(tblOwnDebtBehind, tblOwnDebtBehind2)
tblOwnDebtBehind <- reshape2::dcast(data=tblOwnDebtBehind, Race + State ~ OwnDebtBehind, value.var="Weight")
tblOwnDebtBehind$`Share of borrowers behind on payments` <- tblOwnDebtBehind$Yes / (tblOwnDebtBehind$Yes + tblOwnDebtBehind$No)
```
##### Responses to "Are you behind on payments or in collections for one or more of the loans from your own education?"
```{r figure10}
g10 <- ggplot(data=tblOwnDebtBehind, mapping=aes(y=Race, x=`Share of borrowers behind on payments`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2")

ggplotly(g10, height=350)
```
#### Data source and notes
Survey responses collected in 2020 and 2021 are not included due to the federal student loan payment pause in place that started in March 2020 and continued through all of 2021.  

***
### {-}

xxx 

### {.tabset}
#### Figure 11: CA borrowers
##### Responses to
#### Figure 11: Rest of U.S. borrowers
##### Responses to
#### Figure 11: CA non-borrowers
##### Responses to
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
#### Figure 12: CA borrowers
##### Responses to
#### Figure 12: Rest of U.S. borrowers
##### Responses to
#### Figure 12: CA non-borrowers
##### Responses to
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
#### Figure 13: CA borrowers
##### Responses to
#### Figure 13: Rest of U.S. borrowers
##### Responses to
#### Figure 13: CA non-borrowers
##### Responses to
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
#### Figure 14: CA borrowers
##### Responses to
#### Figure 14: Rest of U.S. borrowers
##### Responses to
#### Figure 14: CA non-borrowers
##### Responses to
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
#### Figure 15: CA borrowers
##### Responses to
#### Figure 15: Rest of U.S. borrowers
##### Responses to
#### Figure 15: CA non-borrowers
##### Responses to
#### Data source and notes
***
### {-}

xxx 

## College Scorecard


## Remaining Gaps

