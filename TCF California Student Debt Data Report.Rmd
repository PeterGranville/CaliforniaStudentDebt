---
title: "What the Data Do - and Do Not - Tell Us About Student Debt in California"
author: "Peter Granville"
date: 'December 2022'
output:
  html_document:
    toc: true
    toc_depth: 2
    theme: cosmo

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(knitr)
library(shiny)
library(scales)
library(plotly)
library(stringr)
library(ggplot2)
library(reshape2)
library(data.table)
```

## Introduction

This report accompanies The Century Foundation's report "Exact Title TBD: Student Debt and Race in California," which examines how student debt puts outsized financial burdens on Black and Latino families in California, especially for graduate borrowers and parents. 

While California lawmakers rightly draw on national research on student debt and race, the state-specific analyses we conduct in this research can help guide state policy that accounts for the distinct patterns of borrowing in California. In particular, these analyses draw attention to the effects of uncapped Parent PLUS and Grad PLUS loans on California's families.

In this report, we walk through the details of the data that underlie that report and explain in greater depth what we do and do not know about student debt in California. Our analysis relies on four sources:

* The Federal Student Aid (FSA) Data Center
* The National Postsecondary Student Aid Study (NPSAS)
* The Survey of Household Economics and Decisionmaking (SHED)
* The College Scorecard

We also draw from the Integrated Postsecondary Education Data System (IPEDS) and the American Community Survey (ACS) to lesser extents. 

The structure of this data-focused report mirrors that of the policy-focused report: the charts and tables in the policy report draw from our four primary data sources in the same order that they are presented here. The first figures in the report draw from the FSA Data Center, and they are followed by figures that draw from NPSAS, and so on. This report is not a static PDF: you can toggle between different versions of charts and hover over barcharts and scatterplots to reveal data points. 

This document is more descriptive than prescriptive. Even data queries did not show striking contrasts between groups are included for full transparency, so long as they are relevant to the examination of student loan debt's burden on California borrowers. 

The code used to produce this document and its charts and tables can be found at [this GitHub repository](https://github.com/PeterGranville/CaliforniaStudentDebt). All data sets used in this report are publicly available, courtesy of the U.S. Department of Education, the U.S. Federal Reserve, and the U.S. Census Bureau. 

For any questions, please email [granville@tcf.org](granville@tcf.org). 

## Federal Student Aid Data Center

#### About the data

The FSA Data Center is a repository of data and statistics on federal student aid, including spreadsheets on student loans reported directly from the National Student Loan Data System. For this analysis we use two files from the FSA Data Center: 

* Quarterly reports on the federal student loan portfolio by borrower location, [available here](https://studentaid.gov/data-center/student/portfolio). 
* Quarterly reports on Direct Loan disbursements and borrowers by program at the level of the institution, [available here](https://studentaid.gov/data-center/student/title-iv). 

For "per capita" measures of student debt and borrowing below, the population for comparison is the estimated total of all California adults aged 18 to 50, using American Community Survey data reflecting calendar year 2021, [available here](https://www.census.gov/programs-surveys/acs/microdata/access.html). 

#### Findings

```{r statenames}

######################################################
### We start with some basic setup. First we make  ###
### a dataframe that relates two-digit state codes ###
### to state names. This will be useful while      ###
### working with PUMS data.                        ###
######################################################

statenames <- data.frame("ST"=c(
  01,     # .Alabama/AL
  02,     # .Alaska/AK
  04,     # .Arizona/AZ
  05,     # .Arkansas/AR
  06,     # .California/CA
  08,     # .Colorado/CO
  09,     # .Connecticut/CT
  10,     # .Delaware/DE
  11,     # .District of Columbia/DC
  12,     # .Florida/FL
  13,     # .Georgia/GA
  15,     # .Hawaii/HI
  16,     # .Idaho/ID
  17,     # .Illinois/IL
  18,     # .Indiana/IN
  19,     # .Iowa/IA
  20,     # .Kansas/KS
  21,     # .Kentucky/KY
  22,     # .Louisiana/LA
  23,     # .Maine/ME
  24,     # .Maryland/MD
  25,     # .Massachusetts/MA
  26,     # .Michigan/MI
  27,     # .Minnesota/MN
  28,     # .Mississippi/MS
  29,     # .Missouri/MO
  30,     # .Montana/MT
  31,     # .Nebraska/NE
  32,     # .Nevada/NV
  33,     # .New Hampshire/NH
  34,     # .New Jersey/NJ
  35,     # .New Mexico/NM
  36,     # .New York/NY
  37,     # .North Carolina/NC
  38,     # .North Dakota/ND
  39,     # .Ohio/OH
  40,     # .Oklahoma/OK
  41,     # .Oregon/OR
  42,     # .Pennsylvania/PA
  44,     # .Rhode Island/RI
  45,     # .South Carolina/SC
  46,     # .South Dakota/SD
  47,     # .Tennessee/TN
  48,     # .Texas/TX
  49,     # .Utah/UT
  50,     # .Vermont/VT
  51,     # .Virginia/VA
  53,     # .Washington/WA
  54,     # .West Virginia/WV
  55,     # .Wisconsin/WI
  56,     # .Wyoming/WY
  72     # .Puerto Rico/PR
), "State"=c(
  "Alabama",
  "Alaska",
  "Arizona",
  "Arkansas",
  "California",
  "Colorado",
  "Connecticut",
  "Delaware",
  "District of Columbia",
  "Florida",
  "Georgia",
  "Hawaii",
  "Idaho",
  "Illinois",
  "Indiana",
  "Iowa",
  "Kansas",
  "Kentucky",
  "Louisiana",
  "Maine",
  "Maryland",
  "Massachusetts",
  "Michigan",
  "Minnesota",
  "Mississippi",
  "Missouri",
  "Montana",
  "Nebraska",
  "Nevada",
  "New Hampshire",
  "New Jersey",
  "New Mexico",
  "New York",
  "North Carolina",
  "North Dakota",
  "Ohio",
  "Oklahoma",
  "Oregon",
  "Pennsylvania",
  "Rhode Island",
  "South Carolina",
  "South Dakota",
  "Tennessee",
  "Texas",
  "Utah",
  "Vermont",
  "Virginia",
  "Washington",
  "West Virginia",
  "Wisconsin",
  "Wyoming",
  "Puerto Rico"))
```

```{r pums}
######################################################
### Here we load in person-level data from every   ###
### state, merging the two datasets that contain   ###
### the sample. This is useful for later.          ###
######################################################

pusa <- fread("psam_pusa_2021.csv", header=TRUE, select=c("SERIALNO", "ST", "AGEP", "PWGTP"))
pusb <- fread("psam_pusb_2021.csv", header=TRUE, select=c("SERIALNO", "ST", "AGEP", "PWGTP"))
pusm <- rbind(pusa, pusb)
rm("pusa", "pusb")
```

```{r interstateComp}

######################################################
### Because we will present these results in two   ###
### tables, we first create the tables.            ###
######################################################

interstateComp <- data.frame(
  "X1" = c(NA), 
  "X2" = c(NA), 
  "X3" = c(NA), 
  "X4" = c(NA)
)
names(interstateComp) <- c("Measure", "50-state median", "California value", "California rank")

scaleCali <- data.frame(
  "X1" = c(NA), 
  "X2" = c(NA), 
  "X3" = c(NA), 
  "X4" = c(NA)
)
names(scaleCali) <- c("Measure", "U.S. total", "California value", "California share")

######################################################
### Next we load in the FSA data on student loan   ###
### portfolio by state.                            ###
######################################################

portfolio <- fread("Portfolio-by-Location.csv", header=TRUE, skip=5, nrow=54)

######################################################
### Now we convert the units of the data.          ###
######################################################

portfolio$`Balance (in billions)` <- portfolio$`Balance (in billions)` * 1000000000
portfolio$`Borrowers (in thousands)` <- portfolio$`Borrowers (in thousands)` * 1000
names(portfolio) <- c("State", "Balance", "Borrowers")

######################################################
### We derive a per-borrower "average balance"     ###
### measure for every state.                       ###
######################################################

portfolio$`Average balance` <- portfolio$Balance / portfolio$Borrowers

######################################################
### We also remove non-state entries in the list.  ###
### Before doing so we save the total borrowers    ###
### and total debt for later.                      ###
######################################################

totalDebt <- sum(portfolio$Balance)
totalBorrowers <- sum(portfolio$Borrowers)
portfolio <- portfolio %>% filter(State != "Other") %>% filter(State != "Not Reported")

######################################################
### Now we want to consider the portfolio on a     ###
### per-capita basis.                              ###
######################################################

######################################################
### Most debt is held by those 18 to 50, so we     ###
### divide total debt by state by the aggregated   ###
### total of people aged 18 to 50 in the state.    ###
######################################################

pusm <- pusm %>% filter(AGEP >= 18 & AGEP <= 50)
population18to50 <- aggregate(data=pusm, PWGTP ~ ST, FUN=sum)
population18to50 <- left_join(x=population18to50, y=statenames, by="ST")
population18to50 <- population18to50 %>% select(State, PWGTP)
names(population18to50) <- c("State", "Number of adults aged 18-50")
portfolio <- left_join(x=portfolio, y=population18to50, by="State")

portfolio$`Debt per capita` <- portfolio$Balance / portfolio$`Number of adults aged 18-50`
portfolio$`Borrowers per capita` <- portfolio$Borrowers / portfolio$`Number of adults aged 18-50`

######################################################
### Now we can rank California alongside other     ###
### states according to these key measures.        ###
######################################################

######################################################
### First we create the rank variables.            ###
######################################################

portfolio$`Rank: Balance` <- rank(portfolio$Balance, ties.method="average")
portfolio$`Rank: Borrowers` <- rank(portfolio$Borrowers, ties.method="average")
portfolio$`Rank: Debt per capita` <- rank(portfolio$`Debt per capita`, ties.method="average")
portfolio$`Rank: Borrowers per capita` <- rank(portfolio$`Borrowers per capita`, ties.method="average")
portfolio$`Rank: Average balance` <- rank(portfolio$`Average balance`, ties.method="average")

######################################################
### Here we add the results into the table.        ###
######################################################

interstateComp <- interstateComp %>% add_row(
  `Measure` = "Federal student loan debt per capita", 
  `50-state median` = dollar(median(portfolio$`Debt per capita`, na.rm=TRUE), accuracy=1), 
  `California value` = dollar(portfolio$`Debt per capita`[portfolio$State=="California"], accuracy=1), 
  `California rank` = (portfolio$`Rank: Debt per capita`[portfolio$State=="California"])
)

interstateComp <- interstateComp %>% add_row(
  `Measure` = "Federal student loan borrowers per capita", 
  `50-state median` = as.character(round(median(portfolio$`Borrowers per capita`, na.rm=TRUE), digits=3)), 
  `California value` = as.character(round(portfolio$`Borrowers per capita`[portfolio$State=="California"], digits=3)), 
  `California rank` = (portfolio$`Rank: Borrowers per capita`[portfolio$State=="California"])
)

interstateComp <- interstateComp %>% add_row(
  `Measure` = "Average federal student loan balance",
  `50-state median` = dollar(median(portfolio$`Average balance`, na.rm=TRUE), accuracy=1),
  `California value` = dollar(portfolio$`Average balance`[portfolio$State=="California"], accuracy=1),
  `California rank` = (portfolio$`Rank: Average balance`[portfolio$State=="California"])
)

scaleCali <- scaleCali %>% add_row(
  `Measure` = "Total outstanding federal student loan debt",
  `U.S. total` = dollar(sum(portfolio$`Balance`, na.rm=TRUE), accuracy=1000000),
  `California value` = dollar(portfolio$`Balance`[portfolio$State=="California"], accuracy=1000000), 
  `California share` = percent((portfolio$`Balance`[portfolio$State=="California"] / sum(portfolio$`Balance`, na.rm=TRUE)), accuracy=0.1)
)

scaleCali <- scaleCali %>% add_row(
  `Measure` = "Total federal student loan borrowers",
  `U.S. total` = comma(round(sum(portfolio$`Borrowers`, na.rm=TRUE), digits=-3)),
  `California value` = comma(round(portfolio$`Borrowers`[portfolio$State=="California"], digits=-3)),
  `California share` = percent((portfolio$`Borrowers`[portfolio$State=="California"] / sum(portfolio$`Borrowers`, na.rm=TRUE)), accuracy=0.1)
)

######################################################
### Finally, let's remove the placeholder row.     ###
######################################################

interstateComp <- interstateComp %>% filter(is.na(Measure)==FALSE)
scaleCali <- scaleCali %>% filter(is.na(Measure)==FALSE)
```

#### {.tabset}
##### Table 1
```{r kable1, results='asis'}
kable(interstateComp, caption="California's rank on average debt measures")
```
##### Data source and notes
***
#### {-}

California has the most outstanding federal student loan debt and borrowers of any state, amounting to around 9 percent of the total portfolio. 

#### {.tabset}
##### Table 2
```{r kable2, results='asis'}
kable(scaleCali, caption="Size of California borrowers' outstanding debt")
```
##### Data source and notes
***
#### {-}

Now we turn to the quarterly data on disbursements. To evade any impact from the COVID-19 pandemic on the data, we examine data from the 2018-19 award year. 

```{r loanPrep1, warning=FALSE}

######################################################
### First we load in student loan disbursement     ###
### data from 2018-19.                             ###
######################################################

loans1819 <- fread("dl-dashboard-ay2018-2019-q4-california.csv", header=TRUE, skip=6)
names(loans1819) <- c(
  "OPEID",
  "School",
  "State",
  "Zip Code",
  "School Type",

  "SUBSIDIZED: Recipients", 
  "SUBSIDIZED: # of Loans Originated", 
  "SUBSIDIZED: $ of Loans Originated", 
  "SUBSIDIZED: # of Disbursements", 
  "SUBSIDIZED: $ of Disbursements", 
   
  "UNSUBSIDIZED - UNDERGRADUATE: Recipients", 
  "UNSUBSIDIZED - UNDERGRADUATE: # of Loans Originated", 
  "UNSUBSIDIZED - UNDERGRADUATE: $ of Loans Originated", 
  "UNSUBSIDIZED - UNDERGRADUATE: # of Disbursements", 
  "UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements", 

  "UNSUBSIDIZED - GRADUATE: Recipients", 
  "UNSUBSIDIZED - GRADUATE: # of Loans Originated", 
  "UNSUBSIDIZED - GRADUATE: $ of Loans Originated", 
  "UNSUBSIDIZED - GRADUATE: # of Disbursements", 
  "UNSUBSIDIZED - GRADUATE: $ of Disbursements", 

  "PARENT PLUS: Recipients", 
  "PARENT PLUS: # of Loans Originated", 
  "PARENT PLUS: $ of Loans Originated", 
  "PARENT PLUS: # of Disbursements", 
  "PARENT PLUS: $ of Disbursements", 

  "GRAD PLUS: Recipients", 
  "GRAD PLUS: # of Loans Originated", 
  "GRAD PLUS: $ of Loans Originated", 
  "GRAD PLUS: # of Disbursements", 
  "GRAD PLUS: $ of Disbursements"
)

######################################################
### Here we must format the OPEIDs, bringing them  ###
### to eight digits.                               ###
######################################################

loans1819$OPEID <- as.character(loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==1, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==2, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==3, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==4, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==5, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==6, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==7, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)

######################################################
### We only need each school's total disbursements ###
### and its total recipients, so we select only    ###
### those variables.                               ###
######################################################

loans1819 <- loans1819 %>% select(
  `OPEID`,
  `School`,
  `State`,
  `Zip Code`,
  `School Type`,

  `SUBSIDIZED: Recipients`, 
  `SUBSIDIZED: $ of Disbursements`, 
   
  `UNSUBSIDIZED - UNDERGRADUATE: Recipients`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`, 

  `UNSUBSIDIZED - GRADUATE: Recipients`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 

  `PARENT PLUS: Recipients`, 
  `PARENT PLUS: $ of Disbursements`, 

  `GRAD PLUS: Recipients`, 
  `GRAD PLUS: $ of Disbursements`
)

######################################################
### Here we make sure that the data are stored     ###
### numerically.                                   ###
######################################################

loans1819$`SUBSIDIZED: Recipients` <- as.numeric(loans1819$`SUBSIDIZED: Recipients`)
loans1819$`SUBSIDIZED: $ of Disbursements` <- as.numeric(loans1819$`SUBSIDIZED: $ of Disbursements`)
   
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients` <- as.numeric(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`)
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` <- as.numeric(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`)

loans1819$`UNSUBSIDIZED - GRADUATE: Recipients` <- as.numeric(loans1819$`UNSUBSIDIZED - GRADUATE: Recipients`)
loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` <- as.numeric(loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`)

loans1819$`PARENT PLUS: Recipients` <- as.numeric(loans1819$`PARENT PLUS: Recipients`)
loans1819$`PARENT PLUS: $ of Disbursements` <- as.numeric(loans1819$`PARENT PLUS: $ of Disbursements`)

loans1819$`GRAD PLUS: Recipients` <- as.numeric(loans1819$`GRAD PLUS: Recipients`)
loans1819$`GRAD PLUS: $ of Disbursements` <- as.numeric(loans1819$`GRAD PLUS: $ of Disbursements`)

######################################################
### We also want to make sure any NA values are    ###
### stored as zeroes.                              ###
######################################################

loans1819$`SUBSIDIZED: Recipients`[is.na(loans1819$`SUBSIDIZED: Recipients`)] <- 0
loans1819$`SUBSIDIZED: $ of Disbursements`[is.na(loans1819$`SUBSIDIZED: $ of Disbursements`)] <- 0
   
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`[is.na(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`)] <- 0
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`[is.na(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`)] <- 0

loans1819$`UNSUBSIDIZED - GRADUATE: Recipients`[is.na(loans1819$`UNSUBSIDIZED - GRADUATE: Recipients`)] <- 0
loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`[is.na(loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`)] <- 0

loans1819$`PARENT PLUS: Recipients`[is.na(loans1819$`PARENT PLUS: Recipients`)] <- 0
loans1819$`PARENT PLUS: $ of Disbursements`[is.na(loans1819$`PARENT PLUS: $ of Disbursements`)] <- 0

loans1819$`GRAD PLUS: Recipients`[is.na(loans1819$`GRAD PLUS: Recipients`)] <- 0
loans1819$`GRAD PLUS: $ of Disbursements`[is.na(loans1819$`GRAD PLUS: $ of Disbursements`)] <- 0

######################################################
### Here we create a variable for total loan       ###
### disbursements at a college.                    ###
######################################################

loans1819$`Total $ of Disbursements` <- loans1819$`SUBSIDIZED: $ of Disbursements` + loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` + loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` + loans1819$`PARENT PLUS: $ of Disbursements` + loans1819$`GRAD PLUS: $ of Disbursements`

```

```{r loanPrograms}

######################################################
### Using the loan data we had imported earlier,   ###
### we aggregate totals by state.                  ###
######################################################

table3 <- aggregate(data=loans1819, cbind(  
  `SUBSIDIZED: $ of Disbursements`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `PARENT PLUS: $ of Disbursements`, 
  `GRAD PLUS: $ of Disbursements`, 
  `Total $ of Disbursements`) ~ State, FUN=sum)

######################################################
### Next we add the U.S. totals for comparison.    ###
######################################################

table3 <- table3 %>% add_row(
  `State`="U.S.",
  `SUBSIDIZED: $ of Disbursements`=sum(table3$`SUBSIDIZED: $ of Disbursements`), 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`=sum(table3$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`), 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`=sum(table3$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`), 
  `PARENT PLUS: $ of Disbursements`=sum(table3$`PARENT PLUS: $ of Disbursements`), 
  `GRAD PLUS: $ of Disbursements`=sum(table3$`GRAD PLUS: $ of Disbursements`), 
  `Total $ of Disbursements`=sum(table3$`Total $ of Disbursements`)
)

######################################################
### Now we derive each loan program's share of     ###
### total borrowing in every state.                ###
######################################################

table3$`SUBSIDIZED share of total` <- table3$`SUBSIDIZED: $ of Disbursements` / table3$`Total $ of Disbursements`
table3$`UNSUBSIDIZED - UNDERGRADUATE share of total` <- table3$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` / table3$`Total $ of Disbursements`
table3$`UNSUBSIDIZED - GRADUATE share of total` <- table3$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` / table3$`Total $ of Disbursements`
table3$`PARENT PLUS share of total` <- table3$`PARENT PLUS: $ of Disbursements` / table3$`Total $ of Disbursements`
table3$`GRAD PLUS share of total` <- table3$`GRAD PLUS: $ of Disbursements` / table3$`Total $ of Disbursements`

######################################################
### We can now compare how California stacks up    ###
### versus the rest of the nation.                 ###
######################################################

table3.1 <- table3 %>% filter(State %in% c("CA", "U.S.")) %>% select(State, `SUBSIDIZED share of total`, `UNSUBSIDIZED - UNDERGRADUATE share of total`, `UNSUBSIDIZED - GRADUATE share of total`, `PARENT PLUS share of total`, `GRAD PLUS share of total`)
names(table3.1) <- c("State", "Subsidized", "Unsubsidized undergraduate", "Unsubsidized graduate", "Parent PLUS loans", "Grad PLUS")
table3.1$`Subsidized` <- percent(table3.1$`Subsidized`)
table3.1$`Unsubsidized undergraduate` <- percent(table3.1$`Unsubsidized undergraduate`)
table3.1$`Unsubsidized graduate` <- percent(table3.1$`Unsubsidized graduate`)
table3.1$`Parent PLUS loans` <- percent(table3.1$`Parent PLUS loans`)
table3.1$`Grad PLUS` <- percent(table3.1$`Grad PLUS`)
```

#### {.tabset}
##### Table 3
```{r kable3}
kable(table3.1, caption="Share of loan dollars disbursed in 2018-19 by loan type, California vs. U.S.")
```
##### Data source and notes
***
#### {-}

```{r sectorLoans}

#######################################################
### Now we load in data from the College Scorecard. ###
#######################################################

scorecard1 <- fread("Most-Recent-Cohorts-Institution.csv", header=TRUE, select=c(
  "OPEID",   # 8-digit OPE ID for institution
  "CONTROL", # Control of institution
  "CCBASIC"  # Carnegie Classification -- basic
))

######################################################
### I now add this variable for later.             ###
######################################################

scorecard1$`Two-year` <- ifelse(scorecard1$CCBASIC %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14), 1, 0)
scorecard1$`Four-year` <- ifelse(scorecard1$CCBASIC %in% c(15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32), 1, 0)

######################################################
### Here I want to format the control variable.    ###
######################################################

scorecard1$Control <- rep(NA, nrow(scorecard1))
scorecard1$Control[scorecard1$CONTROL==1] <- "Public"
scorecard1$Control[scorecard1$CONTROL==2] <- "Non-profit"
scorecard1$Control[scorecard1$CONTROL==3] <- "For-profit"

######################################################
### It's important first to remove the rows that   ###
### have repeated OPEIDs.                          ###
######################################################

scorecard1 <- scorecard1 %>% filter(duplicated(OPEID)==FALSE)

######################################################
### Here we must format the OPEIDs, bringing them  ###
### to eight digits.                               ###
######################################################

scorecard1$OPEID <- as.character(scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==1, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==2, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==3, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==4, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==5, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==6, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==7, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)

######################################################
### Now we merge the two datasets by OPEID.        ###
######################################################

loans1819 <- left_join(x=loans1819, y=scorecard1, by="OPEID")
forTable4 <- loans1819 %>% filter(`Four-year`==1)

table4 <- aggregate(data=forTable4, cbind(
  `SUBSIDIZED: $ of Disbursements`, 
  `SUBSIDIZED: Recipients`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`,
  `UNSUBSIDIZED - UNDERGRADUATE: Recipients`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: Recipients`, 
  `PARENT PLUS: $ of Disbursements`, 
  `PARENT PLUS: Recipients`, 
  `GRAD PLUS: $ of Disbursements`,
  `GRAD PLUS: Recipients`
) ~ State + Control, FUN=sum)

table4.US <- aggregate(data=forTable4, cbind(
  `SUBSIDIZED: $ of Disbursements`, 
  `SUBSIDIZED: Recipients`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`,
  `UNSUBSIDIZED - UNDERGRADUATE: Recipients`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: Recipients`, 
  `PARENT PLUS: $ of Disbursements`, 
  `PARENT PLUS: Recipients`, 
  `GRAD PLUS: $ of Disbursements`,
  `GRAD PLUS: Recipients`
) ~ Control, FUN=sum)
table4.US$State <- rep("U.S.", nrow(table4.US))
table4 <- rbind(table4, table4.US)

table4 <- table4 %>% filter(State %in% c("CA", "U.S."))

table4$`Subsidized` <- table4$`SUBSIDIZED: $ of Disbursements` / table4$`SUBSIDIZED: Recipients`
table4$`Unsub. UG` <- table4$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` / table4$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`
table4$`Unsub. Grad.` <- table4$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` / table4$`UNSUBSIDIZED - GRADUATE: Recipients`
table4$`Parent PLUS` <- table4$`PARENT PLUS: $ of Disbursements` / table4$`PARENT PLUS: Recipients`
table4$`Grad PLUS` <- table4$`GRAD PLUS: $ of Disbursements` / table4$`GRAD PLUS: Recipients`

table4.1 <- table4 %>% select(State, Control, `Subsidized`, `Unsub. UG`, `Unsub. Grad.`, `Parent PLUS`, `Grad PLUS`)
table4.1 <- reshape2::melt(data=table4.1, id.vars = c("State", "Control"), value.name="Average Loan")
```

#### {.tabset}
##### Figure 1
```{r figure1}
g1 <- ggplot(data=table4.1, mapping=aes(x=State, y=`Average Loan`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.4) + labs(title="Average Loan by Type and Sector: California vs. U.S.", caption="Author's analysis of data from the Federal Student Aid Data Center.") + scale_y_continuous(labels=scales::dollar_format()) + facet_grid(Control ~ variable) + scale_fill_brewer(palette="Dark2") + theme(text=element_text(family="Optima")) 

ggplotly(g1, width=850, height=500)
```
##### Data source and notes

Source: FSA Data Center. 

Year(s) of analysis: Reflects loans distributed in 2018-19. Filtered for four-year institutions.

***

#### {-}

The breakdown of loans distributed by California institutions is skewed more towards Grad PLUS than the breakdown of loans distributed by institutions nationwide. Unsubsidized graduate loans also take up a larger slice of the pie in California than in the nation overall.  

## National Postsecondary Student Aid Study

#### About the data

The statistics in the previous section have all been based on institution-level data. For the most robust information on the relationship between student loan borrowing and race in California, we need student-level data. In the absence of a national student-level data set, we use survey data from the National Postsecondary Student Aid Study (NPSAS). 

NPSAS is the largest federal survey of U.S. college students with a primary focus on financial aid. The study has generally been conducted every four years, most recently in 2016 (NPSAS:16), with separate data sets examining undergraduate and graduate students. 

NPSAS data sets have not traditionally been used for state-level analyses, although the sample size for California students can be large enough to produce reliable estimates depending on the query. This past year, a new edition of NPSAS that was designed for state-representative samples was released. Known as NPSAS-AC (Administrative Collection), it draws from student records housed by colleges and the U.S. Department of Education for a sample of 325,000 undergraduates. Representative samples for public 4-year systems are available in NPSAS-AC for 45 states, and representative samples for public 2-year systems are available for 36 states. Thirty states have representative samples for undergraduate students overall. More information on NPSAS-AC can be found [here](https://nces.ed.gov/pubs2022/2022477.pdf). 

In this section we rely primarily on NPSAS-AC, which reflects the 2017-18 year. For analysis of graduate students, we use NPSAS:16 and filter for in-state students in California. (The in-state condition is required for this query.)

These data are accessed using the National Center on Education Statistics' (NCES) [Datalab tool](https://nces.ed.gov/datalab/). Every query has a unique table retrieval number that can be used by any user to run the query in Datalab. 

#### Findings

The figure below compares average undergraduate borrowing by racial group at California public four-years, compared to U.S. public four-years. Across all groups, the average federal loan total is lower in California than nationwide. However, California resembles the U.S. in that Black undergraduates and their families borrow more than their peers. California differs from the U.S. in that Latino/a undergraduates in the state borrow more than white undergraduates, though this is only the case for direct loans to the students and not Parent PLUS.   

```{r npsas1}
npsas1.US <- read.csv("Powerstats_lounfy.csv", skip=12, nrow=7, header=FALSE)
npsas1.CA <- read.csv("Powerstats_lounfy.csv", skip=73, nrow=7, header=FALSE)

names(npsas1.US) <- c("Group", "Federal loans (excl. PLUS)", "Parent PLUS")
names(npsas1.CA) <- c("Group", "Federal loans (excl. PLUS)", "Parent PLUS")

npsas1.US$State <- rep("U.S.", nrow(npsas1.US))
npsas1.CA$State <- rep("CA", nrow(npsas1.CA))
npsas1 <- rbind(npsas1.US, npsas1.CA)

npsas1$Group[npsas1$Group=="Black or African American"] <- "Black"
npsas1$Group[npsas1$Group=="Hispanic or Latino"] <- "Latino/a"
npsas1$Group[npsas1$Group=="Native Hawaiian/other Pacific Islander"] <- "Pacific Islander"
npsas1$Group[npsas1$Group=="More than one race"] <- "2+ races"
npsas1 <- npsas1 %>% filter(Group != "American Indian or Alaska Native")

npsas1 <- reshape2::melt(data=npsas1, id.vars = c("Group", "State"), value.name="Average Loan")

npsas1$`Average Loan` <- gsub(pattern="!", x=npsas1$`Average Loan`, replacement="")
npsas1$`Average Loan` <- gsub(pattern=",", x=npsas1$`Average Loan`, replacement="")
npsas1$`Average Loan` <- gsub(pattern=" ", x=npsas1$`Average Loan`, replacement="")
npsas1$`Average Loan` <- as.numeric(npsas1$`Average Loan`)
```

#### {.tabset}
##### Figure 2
```{r figure2}
g2 <- ggplot(data=npsas1, mapping=aes(x=State, y=`Average Loan`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.4) + labs(title="Average undergraduate loans at public 4-years by group: CA vs U.S.") + facet_grid(variable ~ Group) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g2)
```
##### Data source and notes
Source: NPSAS:18-AC. Table retrieval number: lounfy.

Year(s) of analysis: Reflects students enrolled in the 2017-18 academic year. Only reflects undergraduate public 4-year institutions.  

Note: Insufficient sample size for Native American / Alaskan Native population. Zeros are counted in the averages, meaning it includes those who took out no loans. 

***
#### {-}


```{r npsas2}
npsas2.US <- read.csv("Powerstats_psiqll.csv", skip=12, nrow=7, header=FALSE)
npsas2.CA <- read.csv("Powerstats_psiqll.csv", skip=73, nrow=7, header=FALSE)

names(npsas2.US) <- c("Group", "Total federal loans")
names(npsas2.CA) <- c("Group", "Total federal loans")

npsas2.US$State <- rep("U.S.", nrow(npsas2.US))
npsas2.CA$State <- rep("CA", nrow(npsas2.CA))
npsas2 <- rbind(npsas2.US, npsas2.CA)

npsas2$Group[npsas2$Group=="Black or African American"] <- "Black"
npsas2$Group[npsas2$Group=="Hispanic or Latino"] <- "Latino/a"
npsas2$Group[npsas2$Group=="More than one race"] <- "2+ races"
npsas2 <- npsas2 %>% filter((Group %in% c("American Indian or Alaska Native", "Native Hawaiian/other Pacific Islander"))==FALSE)

npsas2$`Total federal loans` <- gsub(pattern="!", x=npsas2$`Total federal loans`, replacement="")
npsas2$`Total federal loans` <- gsub(pattern=",", x=npsas2$`Total federal loans`, replacement="")
npsas2$`Total federal loans` <- gsub(pattern=" ", x=npsas2$`Total federal loans`, replacement="")
npsas2$`Total federal loans` <- as.numeric(npsas2$`Total federal loans`)
```

#### {.tabset}
##### Figure 3
```{r figure3}
g3 <- ggplot(data=npsas2, mapping=aes(x=State, y=`Total federal loans`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average federal student loans for graduate students, by group: CA vs U.S.", caption="Groups not shown lacked sufficient samples.") + facet_grid(. ~ Group) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g3, height=350)
```
##### Data source and notes 
Source: NPSAS:16. Table retrieval number: psiqll. Data can be accessed at [NCES Datalab](https://nces.ed.gov/datalab/). 

Year(s) of analysis: Reflects students enrolled in the 2015-16 academic year. Only reflects public 4-year institutions.  

Notes: Private loans are also used, but the average loans are so small that Datalab considers the estimates unreliable. Due to limitations of NPSAS:16, this only applies to in-state students. 

***
#### {-}

Across all groups, graduate students in California borrow more than graduate students nationwide. Black students and those of two or more races show the highest average loans, upwards of $20,000 per year. It is striking how Black graduate students in California borrow an average that is roughly two-thirds higher than both the average for Black graduate students nationwide and the average for white graduate students in California.

Among California students, the sample is not sufficient for a breakdown by award level. For context, here is a breakdown of gaps in average loans across all graduate program levels, reflecting the national sample. This demonstrates how professional doctorates show an extreme version of the trends just described. Although professional doctoral students in California constitutes a very small subsample in NPSAS, we can explore this further using the College Scorecard later on.

```{r npsas4}
npsas4.US.masters <- read.csv("Powerstats_vcbaev.csv", skip=73, nrow=7, header=FALSE)
npsas4.US.certificate <- read.csv("Powerstats_vcbaev.csv", skip=134, nrow=7, header=FALSE)
npsas4.US.phd <- read.csv("Powerstats_vcbaev.csv", skip=195, nrow=7, header=FALSE)
npsas4.US.professional <- read.csv("Powerstats_vcbaev.csv", skip=256, nrow=7, header=FALSE)

names(npsas4.US.masters) <- c("Group", "Total federal loans")
names(npsas4.US.certificate) <- c("Group", "Total federal loans")
names(npsas4.US.phd) <- c("Group", "Total federal loans")
names(npsas4.US.professional) <- c("Group", "Total federal loans")

npsas4.US.masters$Level <- rep("Master's programs", nrow(npsas4.US.masters))
npsas4.US.certificate$Level <- rep("Post-bac certificates", nrow(npsas4.US.certificate))
npsas4.US.phd$Level <- rep("Research doctorates", nrow(npsas4.US.phd))
npsas4.US.professional$Level <- rep("Professional doctorates", nrow(npsas4.US.professional))

npsas4 <- rbind(npsas4.US.masters, 
                npsas4.US.certificate, 
                npsas4.US.phd, 
                npsas4.US.professional)

npsas4$Group[npsas4$Group=="Black or African American"] <- "Black"
npsas4$Group[npsas4$Group=="Hispanic or Latino"] <- "Latino/a"
npsas4$Group[npsas4$Group=="More than one race"] <- "2+ races"
npsas4 <- npsas4 %>% filter((Group %in% c("American Indian or Alaska Native", "Native Hawaiian/other Pacific Islander", "2+ races"))==FALSE)

npsas4$`Total federal loans` <- gsub(pattern="!", x=npsas4$`Total federal loans`, replacement="")
npsas4$`Total federal loans` <- gsub(pattern=",", x=npsas4$`Total federal loans`, replacement="")
npsas4$`Total federal loans` <- gsub(pattern=" ", x=npsas4$`Total federal loans`, replacement="")
npsas4$`Total federal loans` <- as.numeric(npsas4$`Total federal loans`)
```

#### {.tabset}
##### Figure 4
```{r figure4}
g4 <- ggplot(data=npsas4, mapping=aes(x=Group, y=`Total federal loans`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average federal loans for graduate students by group and level: U.S. only", caption="Groups not shown lacked sufficient samples.") + facet_grid(. ~ Level) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g4, width=800, height=350)
```
##### Data source and notes
***
#### {-}

NPSAS allows us to disaggregate by ethnicity, to a limited extent, for two racial groups (Hispanic and Asian). In California, average federal loans among Filipino undergraduates are higher than other Asian groups, matching a trend seen nationwide. Among Hispanic ethnicities in California, average loans are greatest among those of Puerto Rican descent. 

#### {.tabset}
##### Figure 5: Asian ethnicities
```{r npsas5}
npsas5.US.HSP <- read.csv("Powerstats_tpsawz.csv", skip=11, nrow=6, header=FALSE)
npsas5.US.ASN <- read.csv("Powerstats_tpsawz.csv", skip=19, nrow=9, header=FALSE)

npsas5.CA.HSP <- read.csv("Powerstats_jejvld.csv", skip=11, nrow=6, header=FALSE)
npsas5.CA.ASN <- read.csv("Powerstats_jejvld.csv", skip=19, nrow=9, header=FALSE)

names(npsas5.US.HSP) <- c("Group", "Total federal loans")
names(npsas5.US.ASN) <- c("Group", "Total federal loans")
names(npsas5.CA.HSP) <- c("Group", "Total federal loans")
names(npsas5.CA.ASN) <- c("Group", "Total federal loans")

npsas5.US.HSP$Race <- rep("Hispanic", nrow(npsas5.US.HSP))
npsas5.US.ASN$Race <- rep("Asian", nrow(npsas5.US.ASN))
npsas5.CA.HSP$Race <- rep("Hispanic", nrow(npsas5.CA.HSP))
npsas5.CA.ASN$Race <- rep("Asian", nrow(npsas5.CA.ASN))

npsas5.US.HSP$State <- rep("U.S.", nrow(npsas5.US.HSP))
npsas5.US.ASN$State <- rep("U.S.", nrow(npsas5.US.ASN))
npsas5.CA.HSP$State <- rep("CA", nrow(npsas5.CA.HSP))
npsas5.CA.ASN$State <- rep("CA", nrow(npsas5.CA.ASN))

npsas5 <- rbind(npsas5.US.HSP, 
                npsas5.US.ASN, 
                npsas5.CA.HSP, 
                npsas5.CA.ASN)

npsas5$`Total federal loans` <- gsub(pattern="!", x=npsas5$`Total federal loans`, replacement="")
npsas5$`Total federal loans` <- gsub(pattern=",", x=npsas5$`Total federal loans`, replacement="")
npsas5$`Total federal loans` <- gsub(pattern=" ", x=npsas5$`Total federal loans`, replacement="")
npsas5$`Total federal loans` <- as.numeric(npsas5$`Total federal loans`)

npsas5.ASN <- npsas5 %>% filter(Race=="Asian") %>% filter(Group != "Not of Asian origin")
npsas5.HSP <- npsas5 %>% filter(Race=="Hispanic") %>% filter(Group != "Not Hispanic or Latino origin")
npsas5.HSP$Group[npsas5.HSP$Group=="Mexican, Mexican-American, or Chicano descent"] <- "Mexican or Chicano descent"
npsas5.HSP$Group[npsas5.HSP$Group=="Other Spanish, Hispanic, or Latino descent"] <- "Other Hispanic or Latino descent"
```

```{r figure5A}
g5A <- ggplot(data=npsas5.ASN, mapping=aes(y=Group, x=`Total federal loans`, fill=Group)) + geom_bar(stat="identity", position="dodge") + labs(title="Average federal student loans by Asian ethinicity: U.S. vs CA", x="Average federal student loans") + facet_grid(State ~ .) + scale_x_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g5A)
```
##### Figure 5: Hispanic ethnicities
```{r figure5B}
g5B <- ggplot(data=npsas5.HSP, mapping=aes(y=Group, x=`Total federal loans`, fill=Group)) + geom_bar(stat="identity", position="dodge") + labs(title="Average federal student loans by Hispanic ethinicity: U.S. vs CA", x="Average federal student loans") + facet_grid(State ~ .) + scale_x_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g5B)
```
##### Data source and notes
Source:  NPSAS, table retrieval number ddgpwg (U.S. all), jejvld (California in-state), tpsawz (U.S. in-state).

Note: Filtered for 4-year colleges and U.S. citizenship. Limited to in-state, undergraduate students. "Total federal loans" includes Parent PLUS. No other racial groups besides Hispanic and Asian have breakouts by ethnicity in NPSAS.

***
#### {-}

## Survey of Household Economics and Decisionmaking 

#### About the data

This is some information about SHED. 
Explain your process of variable selection: there are many but you chose the ones that seemed most relevant to the question of the financial burden of student loans. 
Emphasize here that the relationship between student loans and these variables may be chicken-and-egg, where we can't say for sure what causes the other. 
Acknowledge the limitations of the sample size. Would it be nice to filter by institution level and control? Yes. Would it cut the sample size down very, very far? Yes. 
Small differences of one of two percentage points may be attributable to random noise that can raise from sampling. 
Remember to say that the respondents are heads of households, meaning that the population represented is that of U.S. adults. (Children are not included.)
A good example of the kind of questions SHED answers that other datasets cannot: do borrowers think their education was worth it?

#### Findings

Here we tee up the findings. 

```{r shedSetup1}
shed21 <- fread("SHED-2021.csv", header=TRUE, select=c("CaseID", "weight_pop", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "ppfs1482", "iclevel", "control", "L0_b"))

shed20 <- fread("SHED-2020.csv", header=TRUE, select=c("CaseID", "weight_pop", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "ppfs1482", "iclevel", "control", "L0_b"))

shed19 <- fread("SHED-2019.csv", header=TRUE, select=c("CaseID", "weight_pop", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "FS20_b", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "ppfs1482", "iclevel", "control", "L0_b"))

shed18 <- fread("SHED-2018.csv", header=TRUE, select=c("CaseID", "weight2b", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5",  "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d",  "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "FS20_b", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "iclevel", "control", "L0_b"))

shed17 <- fread("SHED-2017.csv", header=TRUE, select=c("CaseID", "weight3b", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1I", "K0", "I0_c", "I0_d", "I40", "I41_a", "I41_b", "I41_c", "I41_d", "I41_e", "FS20_b", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "EF6A_a", "EF6A_b", "EF6A_f", "EF6B_f", "ppcm0160", "ppfs0596", "control", "L0_b"))

shed16 <- fread("SHED-2016.csv", header=TRUE, select=c("CaseID", "weight3b", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C3", "C4A", "ED0", "ED5", "ED6_a", "ED6_b", "ED6_c", "ED6_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3_TOTAL",  "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "SL12_a", "SL12_b", "SL12_c", "SL12_d", "D1_i", "I0_e", "I4A", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "EF5A", "EF5B", "ppcm0160", "ppfs0596", "C1", "L0_b"))

shed15 <- fread("SHED-2015.csv", header=TRUE, select=c("CaseID", "weight3b", "ppstaten", "ppethm", "ppgender", "B2", "B6", "GH1", "A6", "A1_a", "C4A", "ED0", "ED5", "ED6A_a", "ED6A_b", "ED6A_c", "ED6A_d", "SL1", "SL2_a", "SL2_b", "SL2_c", "SL2_d", "SL3_TOTAL", "SL4", "SL6", "SL7", "SL8_a", "SL8_b", "SL8_c", "SL8_d", "SL8_e", "SL10", "SL11", "D2", "I0_e", "I4A", "EF1", "EF2", "EF3_a", "EF3_b", "EF3_c", "EF3_d", "EF3_e", "EF3_f", "EF3_g", "EF3_h", "ppcm0160", "ppfs0596", "C1", "sector", "control", "D0_b"))

shed21$Weight <- shed21$weight_pop
shed20$Weight <- shed20$weight_pop
shed19$Weight <- shed19$weight_pop
shed18$Weight <- shed18$weight2b
shed17$Weight <- shed17$weight3b
shed16$Weight <- shed16$weight3b
shed15$Weight <- shed15$weight3b

shed21$State <- shed21$ppstaten
shed20$State <- shed20$ppstaten
shed19$State <- shed19$ppstaten
shed18$State <- shed18$ppstaten
shed17$State <- shed17$ppstaten
shed16$State <- shed16$ppstaten
shed15$State <- shed15$ppstaten

shed21$Race <- shed21$ppethm
shed20$Race <- shed20$ppethm
shed19$Race <- shed19$ppethm
shed18$Race <- shed18$ppethm
shed17$Race <- shed17$ppethm
shed16$Race <- shed16$ppethm
shed15$Race <- shed15$ppethm

shed21$Gender <- shed21$ppgender
shed20$Gender <- shed20$ppgender
shed19$Gender <- shed19$ppgender
shed18$Gender <- shed18$ppgender
shed17$Gender <- shed17$ppgender
shed16$Gender <- shed16$ppgender
shed15$Gender <- shed15$ppgender

shed21$FinManage <- shed21$B2
shed20$FinManage <- shed20$B2
shed19$FinManage <- shed19$B2
shed18$FinManage <- shed18$B2
shed17$FinManage <- shed17$B2
shed16$FinManage <- shed16$B2
shed15$FinManage <- shed15$B2

shed21$ParComp <- shed21$B6
shed20$ParComp <- shed20$B6
shed19$ParComp <- shed19$B6
shed18$ParComp <- shed18$B6
shed17$ParComp <- shed17$B6
shed16$ParComp <- shed16$B6
shed15$ParComp <- shed15$B6

shed21$HomeOwn <- shed21$GH1
shed20$HomeOwn <- shed20$GH1
shed19$HomeOwn <- shed19$GH1
shed18$HomeOwn <- shed18$GH1
shed17$HomeOwn <- shed17$GH1
shed16$HomeOwn <- shed16$GH1
shed15$HomeOwn <- shed15$GH1

shed21$CCApprov <- shed21$A6
shed20$CCApprov <- shed20$A6
shed19$CCApprov <- shed19$A6
shed18$CCApprov <- shed18$A6
shed17$CCApprov <- shed17$A6
shed16$CCApprov <- shed16$A6
shed15$CCApprov <- shed15$A6

shed21$CreditDeny <- shed21$A1_a
shed20$CreditDeny <- shed20$A1_a
shed19$CreditDeny <- shed19$A1_a
shed18$CreditDeny <- shed18$A1_a
shed17$CreditDeny <- shed17$A1_a
shed16$CreditDeny <- shed16$A1_a
shed15$CreditDeny <- shed15$A1_a

shed21$UnpaidCC <- shed21$C3
shed20$UnpaidCC <- shed20$C3
shed19$UnpaidCC <- shed19$C3
shed18$UnpaidCC <- shed18$C3
shed17$UnpaidCC <- shed17$C3
shed16$UnpaidCC <- shed16$C3
shed15$UnpaidCC <- rep(NA, nrow(shed15))

shed21$CCBalance <- shed21$C4A
shed20$CCBalance <- shed20$C4A
shed19$CCBalance <- shed19$C4A
shed18$CCBalance <- shed18$C4A
shed17$CCBalance <- shed17$C4A
shed16$CCBalance <- shed16$C4A
shed15$CCBalance <- shed15$C4A

shed21$EdAttain <- shed21$ED0
shed20$EdAttain <- shed20$ED0
shed19$EdAttain <- shed19$ED0
shed18$EdAttain <- shed18$ED0
shed17$EdAttain <- shed17$ED0
shed16$EdAttain <- shed16$ED0
shed15$EdAttain <- shed15$ED0

shed21$EdPayoff1 <- shed21$ED5
shed20$EdPayoff1 <- shed20$ED5
shed19$EdPayoff1 <- shed19$ED5
shed18$EdPayoff1 <- shed18$ED5
shed17$EdPayoff1 <- shed17$ED5
shed16$EdPayoff1 <- shed16$ED5
shed15$EdPayoff1 <- shed15$ED5

shed21$DiffField1 <- shed21$ED6_a
shed20$DiffField1 <- shed20$ED6_a
shed19$DiffField1 <- shed19$ED6_a
shed18$DiffField1 <- shed18$ED6_a
shed17$DiffField1 <- shed17$ED6_a
shed16$DiffField1 <- shed16$ED6_a
shed15$DiffField1 <- shed15$ED6A_a

shed21$DiffSchool1 <- shed21$ED6_b
shed20$DiffSchool1 <- shed20$ED6_b
shed19$DiffSchool1 <- shed19$ED6_b
shed18$DiffSchool1 <- shed18$ED6_b
shed17$DiffSchool1 <- shed17$ED6_b
shed16$DiffSchool1 <- shed16$ED6_b
shed15$DiffSchool1 <- shed15$ED6A_b

shed21$LessEd1 <- shed21$ED6_c
shed20$LessEd1 <- shed20$ED6_c
shed19$LessEd1 <- shed19$ED6_c
shed18$LessEd1 <- shed18$ED6_c
shed17$LessEd1 <- shed17$ED6_c
shed16$LessEd1 <- shed16$ED6_c
shed15$LessEd1 <- shed15$ED6A_c

shed21$MoreEd1 <- shed21$ED6_d
shed20$MoreEd1 <- shed20$ED6_d
shed19$MoreEd1 <- shed19$ED6_d
shed18$MoreEd1 <- shed18$ED6_d
shed17$MoreEd1 <- shed17$ED6_d
shed16$MoreEd1 <- shed16$ED6_d
shed15$MoreEd1 <- shed15$ED6A_d

shed21$OwnDebt <- shed21$SL1
shed20$OwnDebt <- shed20$SL1
shed19$OwnDebt <- shed19$SL1
shed18$OwnDebt <- shed18$SL1
shed17$OwnDebt <- shed17$SL1
shed16$OwnDebt <- shed16$SL1
shed15$OwnDebt <- shed15$SL1

shed21$OwnDebtSL <- shed21$SL2_a
shed20$OwnDebtSL <- shed20$SL2_a
shed19$OwnDebtSL <- shed19$SL2_a
shed18$OwnDebtSL <- shed18$SL2_a
shed17$OwnDebtSL <- shed17$SL2_a
shed16$OwnDebtSL <- shed16$SL2_a
shed15$OwnDebtSL <- shed15$SL2_a

shed21$OwnDebtHE <- shed21$SL2_b
shed20$OwnDebtHE <- shed20$SL2_b
shed19$OwnDebtHE <- shed19$SL2_b
shed18$OwnDebtHE <- shed18$SL2_b
shed17$OwnDebtHE <- shed17$SL2_b
shed16$OwnDebtHE <- shed16$SL2_b
shed15$OwnDebtHE <- shed15$SL2_b

shed21$OwnDebtCC <- shed21$SL2_c
shed20$OwnDebtCC <- shed20$SL2_c
shed19$OwnDebtCC <- shed19$SL2_c
shed18$OwnDebtCC <- shed18$SL2_c
shed17$OwnDebtCC <- shed17$SL2_c
shed16$OwnDebtCC <- shed16$SL2_c
shed15$OwnDebtCC <- shed15$SL2_c

shed21$OwnDebtOther <- shed21$SL2_d
shed20$OwnDebtOther <- shed20$SL2_d
shed19$OwnDebtOther <- shed19$SL2_d
shed18$OwnDebtOther <- shed18$SL2_d
shed17$OwnDebtOther <- shed17$SL2_d
shed16$OwnDebtOther <- shed16$SL2_d
shed15$OwnDebtOther <- shed15$SL2_d

shed21$OwnDebtTot <- shed21$SL3
shed20$OwnDebtTot <- shed20$SL3
shed19$OwnDebtTot <- shed19$SL3
shed18$OwnDebtTot <- shed18$SL3
shed17$OwnDebtTot <- shed17$SL3
shed16$OwnDebtTot <- shed16$SL3_TOTAL
shed15$OwnDebtTot <- shed15$SL3_TOTAL

shed21$OwnDebtMon <- shed21$SL4
shed20$OwnDebtMon <- shed20$SL4
shed19$OwnDebtMon <- shed19$SL4
shed18$OwnDebtMon <- shed18$SL4
shed17$OwnDebtMon <- shed17$SL4
shed16$OwnDebtMon <- shed16$SL4
shed15$OwnDebtMon <- shed15$SL4

shed21$OwnDebtBehind <- shed21$SL6
shed20$OwnDebtBehind <- shed20$SL6
shed19$OwnDebtBehind <- shed19$SL6
shed18$OwnDebtBehind <- shed18$SL6
shed17$OwnDebtBehind <- shed17$SL6
shed16$OwnDebtBehind <- shed16$SL6
shed15$OwnDebtBehind <- shed15$SL6

shed21$OwnRepaid <- shed21$SL7
shed20$OwnRepaid <- shed20$SL7
shed19$OwnRepaid <- shed19$SL7
shed18$OwnRepaid <- shed18$SL7
shed17$OwnRepaid <- shed17$SL7
shed16$OwnRepaid <- shed16$SL7
shed15$OwnRepaid <- shed15$SL7

shed21$OwnCert <- shed21$SL8_a
shed20$OwnCert <- shed20$SL8_a
shed19$OwnCert <- shed19$SL8_a
shed18$OwnCert <- shed18$SL8_a
shed17$OwnCert <- shed17$SL8_a
shed16$OwnCert <- shed16$SL8_a
shed15$OwnCert <- shed15$SL8_a

shed21$OwnAssoc <- shed21$SL8_b
shed20$OwnAssoc <- shed20$SL8_b
shed19$OwnAssoc <- shed19$SL8_b
shed18$OwnAssoc <- shed18$SL8_b
shed17$OwnAssoc <- shed17$SL8_b
shed16$OwnAssoc <- shed16$SL8_b
shed15$OwnAssoc <- shed15$SL8_b

shed21$OwnBach <- shed21$SL8_c
shed20$OwnBach <- shed20$SL8_c
shed19$OwnBach <- shed19$SL8_c
shed18$OwnBach <- shed18$SL8_c
shed17$OwnBach <- shed17$SL8_c
shed16$OwnBach <- shed16$SL8_c
shed15$OwnBach <- shed15$SL8_c

shed21$OwnGrad <- ifelse((shed21$SL8_d=="Yes") | (shed21$SL8_e=="Yes"), "Yes", "No")
shed20$OwnGrad <- ifelse((shed20$SL8_d=="Yes") | (shed20$SL8_e=="Yes"), "Yes", "No")
shed19$OwnGrad <- ifelse((shed19$SL8_d=="Yes") | (shed19$SL8_e=="Yes"), "Yes", "No")
shed18$OwnGrad <- ifelse((shed18$SL8_d=="Yes") | (shed18$SL8_e=="Yes"), "Yes", "No")
shed17$OwnGrad <- ifelse((shed17$SL8_d=="Yes") | (shed17$SL8_e=="Yes"), "Yes", "No")
shed16$OwnGrad <- ifelse((shed16$SL8_d=="Yes") | (shed16$SL8_e=="Yes"), "Yes", "No")
shed15$OwnGrad <- ifelse((shed15$SL8_d=="Yes") | (shed15$SL8_e=="Yes"), "Yes", "No")

shed21$SpouseDebt <- shed21$SL10
shed20$SpouseDebt <- shed20$SL10
shed19$SpouseDebt <- shed19$SL10
shed18$SpouseDebt <- shed18$SL10
shed17$SpouseDebt <- shed17$SL10
shed16$SpouseDebt <- shed16$SL10
shed15$SpouseDebt <- shed15$SL10

shed21$ChildDebt <- shed21$SL11
shed20$ChildDebt <- shed20$SL11
shed19$ChildDebt <- shed19$SL11
shed18$ChildDebt <- shed18$SL11
shed17$ChildDebt <- shed17$SL11
shed16$ChildDebt <- shed16$SL11
shed15$ChildDebt <- shed15$SL11

shed21$ChildDebtSL <- shed21$SL12_a
shed20$ChildDebtSL <- shed20$SL12_a
shed19$ChildDebtSL <- shed19$SL12_a
shed18$ChildDebtSL <- shed18$SL12_a
shed17$ChildDebtSL <- shed17$SL12_a
shed16$ChildDebtSL <- shed16$SL12_a
shed15$ChildDebtSL <- rep(NA, nrow(shed15))

shed21$ChildDebtHE <- shed21$SL12_b
shed20$ChildDebtHE <- shed20$SL12_b
shed19$ChildDebtHE <- shed19$SL12_b
shed18$ChildDebtHE <- shed18$SL12_b
shed17$ChildDebtHE <- shed17$SL12_b
shed16$ChildDebtHE <- shed16$SL12_b
shed15$ChildDebtHE <- rep(NA, nrow(shed15))

shed21$ChildDebtCC <- shed21$SL12_c
shed20$ChildDebtCC <- shed20$SL12_c
shed19$ChildDebtCC <- shed19$SL12_c
shed18$ChildDebtCC <- shed18$SL12_c
shed17$ChildDebtCC <- shed17$SL12_c
shed16$ChildDebtCC <- shed16$SL12_c
shed15$ChildDebtCC <- rep(NA, nrow(shed15))

shed21$ChildDebtOther <- shed21$SL12_d
shed20$ChildDebtOther <- shed20$SL12_d
shed19$ChildDebtOther <- shed19$SL12_d
shed18$ChildDebtOther <- shed18$SL12_d
shed17$ChildDebtOther <- shed17$SL12_d
shed16$ChildDebtOther <- shed16$SL12_d
shed15$ChildDebtOther <- rep(NA, nrow(shed15))

shed21$Retired <- shed21$D1I
shed20$Retired <- shed20$D1I
shed19$Retired <- shed19$D1I
shed18$Retired <- shed18$D1I
shed17$Retired <- shed17$D1I
shed16$Retired <- shed16$D1_i
shed15$Retired <- shed15$D2

shed21$RetireOnTrack <- shed21$K0
shed20$RetireOnTrack <- shed20$K0
shed19$RetireOnTrack <- shed19$K0
shed18$RetireOnTrack <- shed18$K0
shed17$RetireOnTrack <- shed17$K0
shed16$RetireOnTrack <- rep(NA, nrow(shed16))
shed15$RetireOnTrack <- rep(NA, nrow(shed15))

shed21$SocSec <- shed21$I0_c
shed20$SocSec <- shed20$I0_c
shed19$SocSec <- shed19$I0_c
shed18$SocSec <- shed18$I0_c
shed17$SocSec <- shed17$I0_c
shed16$SocSec <- shed16$I0_e
shed15$SocSec <- shed15$I0_e

shed21$Welfare <- shed21$I0_d
shed20$Welfare <- shed20$I0_d
shed19$Welfare <- shed19$I0_d
shed18$Welfare <- shed18$I0_d
shed17$Welfare <- shed17$I0_d
shed16$Welfare <- rep(NA, nrow(shed16))
shed15$Welfare <- rep(NA, nrow(shed15))

shed21$TotalInc <- shed21$I40
shed20$TotalInc <- shed20$I40
shed19$TotalInc <- shed19$I40
shed18$TotalInc <- shed18$I40
shed17$TotalInc <- shed17$I40
shed16$TotalInc <- shed16$I4A
shed15$TotalInc <- shed15$I4A

shed21$EITC <- shed21$I41_a
shed20$EITC <- shed20$I41_a
shed19$EITC <- shed19$I41_a
shed18$EITC <- shed18$I41_a
shed17$EITC <- shed17$I41_a
shed16$EITC <- rep(NA, nrow(shed16))
shed15$EITC <- rep(NA, nrow(shed15))

shed21$SNAP <- shed21$I41_b
shed20$SNAP <- shed20$I41_b
shed19$SNAP <- shed19$I41_b
shed18$SNAP <- shed18$I41_b
shed17$SNAP <- shed17$I41_b
shed16$SNAP <- rep(NA, nrow(shed16))
shed15$SNAP <- rep(NA, nrow(shed15))

shed21$WIC <- shed21$I41_c
shed20$WIC <- shed20$I41_c
shed19$WIC <- shed19$I41_c
shed18$WIC <- shed18$I41_c
shed17$WIC <- shed17$I41_c
shed16$WIC <- rep(NA, nrow(shed16))
shed15$WIC <- rep(NA, nrow(shed15))

shed21$HouseAssist <- shed21$I41_d
shed20$HouseAssist <- shed20$I41_d
shed19$HouseAssist <- shed19$I41_d
shed18$HouseAssist <- shed18$I41_d
shed17$HouseAssist <- shed17$I41_d
shed16$HouseAssist <- rep(NA, nrow(shed16))
shed15$HouseAssist <- rep(NA, nrow(shed15))

shed21$FRPL <- shed21$I41_e
shed20$FRPL <- shed20$I41_e
shed19$FRPL <- shed19$I41_e
shed18$FRPL <- shed18$I41_e
shed17$FRPL <- shed17$I41_e
shed16$FRPL <- rep(NA, nrow(shed16))
shed15$FRPL <- rep(NA, nrow(shed15))

shed21$ThreeMonSave <- shed21$EF1
shed20$ThreeMonSave <- shed20$EF1
shed19$ThreeMonSave <- shed19$EF1
shed18$ThreeMonSave <- shed18$EF1
shed17$ThreeMonSave <- shed17$EF1
shed16$ThreeMonSave <- shed16$EF1
shed15$ThreeMonSave <- shed15$EF1

shed21$ThreeMonCover <- shed21$EF2
shed20$ThreeMonCover <- shed20$EF2
shed19$ThreeMonCover <- shed19$EF2
shed18$ThreeMonCover <- shed18$EF2
shed17$ThreeMonCover <- shed17$EF2
shed16$ThreeMonCover <- shed16$EF2
shed15$ThreeMonCover <- shed15$EF2

shed21$CCA400 <- shed21$EF3_a
shed20$CCA400 <- shed20$EF3_a
shed19$CCA400 <- shed19$EF3_a
shed18$CCA400 <- shed18$EF3_a
shed17$CCA400 <- shed17$EF3_a
shed16$CCA400 <- shed16$EF3_a
shed15$CCA400 <- shed15$EF3_a

shed21$CCB400 <- shed21$EF3_b
shed20$CCB400 <- shed20$EF3_b
shed19$CCB400 <- shed19$EF3_b
shed18$CCB400 <- shed18$EF3_b
shed17$CCB400 <- shed17$EF3_b
shed16$CCB400 <- shed16$EF3_b
shed15$CCB400 <- shed15$EF3_b

shed21$Cash400 <- shed21$EF3_c
shed20$Cash400 <- shed20$EF3_c
shed19$Cash400 <- shed19$EF3_c
shed18$Cash400 <- shed18$EF3_c
shed17$Cash400 <- shed17$EF3_c
shed16$Cash400 <- shed16$EF3_c
shed15$Cash400 <- shed15$EF3_c

shed21$Loan400 <- shed21$EF3_d
shed20$Loan400 <- shed20$EF3_d
shed19$Loan400 <- shed19$EF3_d
shed18$Loan400 <- shed18$EF3_d
shed17$Loan400 <- shed17$EF3_d
shed16$Loan400 <- shed16$EF3_d
shed15$Loan400 <- shed15$EF3_d

shed21$Friend400 <- shed21$EF3_e
shed20$Friend400 <- shed20$EF3_e
shed19$Friend400 <- shed19$EF3_e
shed18$Friend400 <- shed18$EF3_e
shed17$Friend400 <- shed17$EF3_e
shed16$Friend400 <- shed16$EF3_e
shed15$Friend400 <- shed15$EF3_e

shed21$Payday400 <- shed21$EF3_f
shed20$Payday400 <- shed20$EF3_f
shed19$Payday400 <- shed19$EF3_f
shed18$Payday400 <- shed18$EF3_f
shed17$Payday400 <- shed17$EF3_f
shed16$Payday400 <- shed16$EF3_f
shed15$Payday400 <- shed15$EF3_f

shed21$Sell400 <- shed21$EF3_g
shed20$Sell400 <- shed20$EF3_g
shed19$Sell400 <- shed19$EF3_g
shed18$Sell400 <- shed18$EF3_g
shed17$Sell400 <- shed17$EF3_g
shed16$Sell400 <- shed16$EF3_g
shed15$Sell400 <- shed15$EF3_g

shed21$None400 <- shed21$EF3_h
shed20$None400 <- shed20$EF3_h
shed19$None400 <- shed19$EF3_h
shed18$None400 <- shed18$EF3_h
shed17$None400 <- shed17$EF3_h
shed16$None400 <- shed16$EF3_h
shed15$None400 <- shed15$EF3_h

shed21$PayBills <- shed21$EF5A
shed20$PayBills <- shed20$EF5A
shed19$PayBills <- shed19$EF5A
shed18$PayBills <- shed18$EF5A
shed17$PayBills <- shed17$EF5A
shed16$PayBills <- shed16$EF5A
shed15$PayBills <- rep(NA, nrow(shed15))

shed21$PayBills400 <- shed21$EF5B
shed20$PayBills400 <- shed20$EF5B
shed19$PayBills400 <- shed19$EF5B
shed18$PayBills400 <- shed18$EF5B
shed17$PayBills400 <- shed17$EF5B
shed16$PayBills400 <- shed16$EF5B
shed15$PayBills400 <- rep(NA, nrow(shed15))

shed21$PayBills400 <- shed21$EF5B
shed20$PayBills400 <- shed20$EF5B
shed19$PayBills400 <- shed19$EF5B
shed18$PayBills400 <- shed18$EF5B
shed17$PayBills400 <- shed17$EF5B
shed16$PayBills400 <- rep(NA, nrow(shed16))
shed15$PayBills400 <- rep(NA, nrow(shed15))

shed21$PartialRent <- shed21$EF6A_a
shed20$PartialRent <- shed20$EF6A_a
shed19$PartialRent <- shed19$EF6A_a
shed18$PartialRent <- shed18$EF6A_a
shed17$PartialRent <- shed17$EF6A_a
shed16$PartialRent <- rep(NA, nrow(shed16))
shed15$PartialRent <- rep(NA, nrow(shed15))

shed21$PartialCC <- shed21$EF6A_b
shed20$PartialCC <- shed20$EF6A_b
shed19$PartialCC <- shed19$EF6A_b
shed18$PartialCC <- shed18$EF6A_b
shed17$PartialCC <- shed17$EF6A_b
shed16$PartialCC <- rep(NA, nrow(shed16))
shed15$PartialCC <- rep(NA, nrow(shed15))

shed21$PartialSL <- shed21$EF6A_f
shed20$PartialSL <- shed20$EF6A_f
shed19$PartialSL <- shed19$EF6A_f
shed18$PartialSL <- shed18$EF6A_f
shed17$PartialSL <- shed17$EF6A_f
shed16$PartialSL <- rep(NA, nrow(shed16))
shed15$PartialSL <- rep(NA, nrow(shed15))

shed21$PartialSL400 <- shed21$EF6B_f
shed20$PartialSL400 <- shed20$EF6B_f
shed19$PartialSL400 <- shed19$EF6B_f
shed18$PartialSL400 <- shed18$EF6B_f
shed17$PartialSL400 <- shed17$EF6B_f
shed16$PartialSL400 <- rep(NA, nrow(shed16))
shed15$PartialSL400 <- rep(NA, nrow(shed15))

shed21$Occupation <- shed21$ppcm0160
shed20$Occupation <- shed20$ppcm0160
shed19$Occupation <- shed19$ppcm0160
shed18$Occupation <- shed18$ppcm0160
shed17$Occupation <- shed17$ppcm0160
shed16$Occupation <- shed16$ppcm0160
shed15$Occupation <- shed15$ppcm0160

shed21$Savings <- shed21$ppfs0596
shed20$Savings <- shed20$ppfs0596
shed19$Savings <- shed19$ppfs0596
shed18$Savings <- shed18$ppfs0596
shed17$Savings <- shed17$ppfs0596
shed16$Savings <- shed16$ppfs0596
shed15$Savings <- shed15$ppfs0596

shed21$CreditScore <- shed21$ppfs1482
shed20$CreditScore <- shed20$ppfs1482
shed19$CreditScore <- shed19$ppfs1482
shed18$CreditScore <- rep(NA, nrow(shed18))
shed17$CreditScore <- rep(NA, nrow(shed17))
shed16$CreditScore <- shed16$C1
shed15$CreditScore <- shed15$C1

shed21$InstLevel <- shed21$iclevel
shed20$InstLevel <- shed20$iclevel
shed19$InstLevel <- shed19$iclevel
shed18$InstLevel <- shed18$iclevel
shed17$InstLevel <- rep(NA, nrow(shed17))
shed16$InstLevel <- rep(NA, nrow(shed16))
shed15$InstLevel <- shed15$sector

shed21$InstControl <- shed21$control
shed20$InstControl <- shed20$control
shed19$InstControl <- shed19$control
shed18$InstControl <- shed18$control
shed17$InstControl <- shed17$control
shed16$InstControl <- rep(NA, nrow(shed16))
shed15$InstControl <- shed15$control

shed21$ChildrenUnder18 <- shed21$L0_b
shed20$ChildrenUnder18 <- shed20$L0_b
shed19$ChildrenUnder18 <- shed19$L0_b
shed18$ChildrenUnder18 <- shed18$L0_b
shed17$ChildrenUnder18 <- shed17$L0_b
shed16$ChildrenUnder18 <- shed16$L0_b
shed15$ChildrenUnder18 <- shed15$D0_b

shed21 <- shed21 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed20 <- shed20 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed19 <- shed19 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed18 <- shed18 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed17 <- shed17 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed16 <- shed16 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed15 <- shed15 %>% select(CaseID, Weight, State, Race, Gender, FinManage, ParComp, HomeOwn, CCApprov, CreditDeny, UnpaidCC, CCBalance, EdAttain, EdPayoff1, DiffField1, DiffSchool1, LessEd1, MoreEd1, OwnDebt, OwnDebtSL, OwnDebtHE, OwnDebtCC, OwnDebtOther, OwnDebtTot, OwnDebtMon, OwnDebtBehind, OwnRepaid, OwnCert, OwnAssoc, OwnBach, OwnGrad, SpouseDebt, ChildDebt, ChildDebtSL, ChildDebtHE, ChildDebtCC, ChildDebtOther, Retired, RetireOnTrack, SocSec, Welfare, TotalInc, EITC, SNAP, WIC, HouseAssist, FRPL, ThreeMonSave, ThreeMonCover, CCA400, CCB400, Cash400, Loan400, Friend400, Payday400, Sell400, None400, PayBills, PayBills400, PartialRent, PartialCC, PartialSL, PartialSL400, Occupation, Savings, CreditScore, InstLevel, InstControl, ChildrenUnder18)

shed21$SurveyYear <- rep(2021, nrow(shed21))
shed20$SurveyYear <- rep(2020, nrow(shed20))
shed19$SurveyYear <- rep(2019, nrow(shed19))
shed18$SurveyYear <- rep(2018, nrow(shed18))
shed17$SurveyYear <- rep(2017, nrow(shed17))
shed16$SurveyYear <- rep(2016, nrow(shed16))
shed15$SurveyYear <- rep(2015, nrow(shed15))

shed <- rbind(shed21, shed20, shed19, shed18, shed17, shed16, shed15)
```

```{r shedSetup2, warning=FALSE}

######################################################
### In this code chunk we make adjustments to the  ###
### data values to accommodate the fact that the   ###
### different years of SHED data have slight       ###
### differences to the survey responses that can   ###
### cause problems when pooling the data. I have   ###
### commented out the "table" calls, which were    ###
### used to know which adjustments needed to be    ###
### made.                                          ###
######################################################

# State
# table(shed$State)
shed$State <- toupper(shed$State)
shed$State[shed$State != "CA"] <- "Rest of U.S."
# table(shed$State)

# Race
shed$Race[shed$Race=="2+ Races, Non-Hispanic"] <- "Other, Non-Hispanic"
shed$Race <- factor(shed$Race, levels=rev(c("All", "White, Non-Hispanic", "Hispanic", "Black, Non-Hispanic", "Other, Non-Hispanic")))

# Gender
# table(shed$Gender)

# FinManage
# table(shed$FinManage)

# ParComp
# table(shed$ParComp)

# HomeOwn
# table(shed$HomeOwn)

shed$HomeOwn[shed$HomeOwn=="I [and/or my spouse/partner] don't own [our/my] home or pay rent."] <- "Other"
shed$HomeOwn[shed$HomeOwn=="I [and/or my spouse/partner] own [our/my] home free and clear (without a mortgage or loan)."] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="I [and/or my spouse/partner] own [our/my] home with a mortgage or loan."] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="I [and/or my spouse/partner] pay rent."] <- "Pay rent"
shed$HomeOwn[shed$HomeOwn=="I [PPMARITins2] don\x92t own [PPMARITins3] home or pay rent."] <- "Other"
shed$HomeOwn[shed$HomeOwn=="I [PPMARITins2] own [PPMARITins3] home free and clear (without a mortgage or loan)."] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="I [PPMARITins2] own [PPMARITins3] home with a mortgage or loan."] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="I [PPMARITins2] pay rent."] <- "Pay rent"
shed$HomeOwn[shed$HomeOwn=="Neither own home nor pay rent"] <- "Other"
shed$HomeOwn[shed$HomeOwn=="neither own home nor pay rent."] <- "Other"
shed$HomeOwn[shed$HomeOwn=="Neither own nor pay rent"] <- "Other"
shed$HomeOwn[shed$HomeOwn=="Own home free and clear (without a mortgage or loan)"] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="own home free and clear (without a mortgage or loan)."] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="Own home with a mortgage or loan"] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="own home with a mortgage or loan."] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="Own your home free and clear (without a mortgage or loan)"] <- "Own home free and clear"
shed$HomeOwn[shed$HomeOwn=="Own your home with a mortgage or loan"] <- "Own home with a mortgage or loan"
shed$HomeOwn[shed$HomeOwn=="Pay rent"] <- "Pay rent"
shed$HomeOwn[shed$HomeOwn=="pay rent."] <- "Pay rent"
# table(shed$HomeOwn)

# CCApprov
# table(shed$CCApprov)
shed$CCApprov[shed$CCApprov=="Don't know"] <- "Don't know"
shed$CCApprov[shed$CCApprov=="Dont know"] <- "Don't know"
shed$CCApprov[shed$CCApprov=="Don\x92t know"] <- "Don't know"
# table(shed$CCApprov)

# CreditDeny
# table(shed$CreditDeny)

# UnpaidCC
# table(shed$UnpaidCC)

# CCBalance
# table(shed$CCBalance)
shed$CCBalance[shed$CCBalance=="Never carried a balance (always pay in full)"] <- "Always pay in full"
shed$CCBalance[shed$CCBalance=="Never carried an unpaid balance (always pay in full)"] <- "Always pay in full"
# table(shed$CCBalance)

# EdAttain
# table(shed$EdAttain)
shed$EdAttain[shed$EdAttain=="Bachelor's degree"] <- "Bachelor's degree"
shed$EdAttain[shed$EdAttain=="Bachelors degree"] <- "Bachelor's degree"
shed$EdAttain[shed$EdAttain=="Bachelor\x92s degree"] <- "Bachelor's degree"
shed$EdAttain[shed$EdAttain=="Doctoral degree"] <- "Doctorate"
shed$EdAttain[shed$EdAttain=="Doctoral Degree"] <- "Doctorate"
shed$EdAttain[shed$EdAttain=="Less than high school degree"] <- "Less than high school diploma"
shed$EdAttain[shed$EdAttain=="Less than High School degree"] <- "Less than high school diploma"
shed$EdAttain[shed$EdAttain=="Master's degree"] <- "Master's degree"
shed$EdAttain[shed$EdAttain=="Masters degree"] <- "Master's degree"
shed$EdAttain[shed$EdAttain=="Master\x92s degree"] <- "Master's degree"
shed$EdAttain[shed$EdAttain=="Professional degree (e.g. MBA, MD, JD)"] <- "Professional degree"
shed$EdAttain[shed$EdAttain=="Professional degree (e.g., MBA, MD, JD)"]  <- "Professional degree"
shed$EdAttain[shed$EdAttain=="Some college but no degree (including currently enrolled in college)"] <- "Some college, no degree"
shed$EdAttain[shed$EdAttain=="Certificate or technical degree"] <- "Some college, no degree"
# table(shed$EdAttain)

# EdPayoff1
# table(shed$EdPayoff1)
shed$EdPayoff1[shed$EdPayoff1=="About the same financial benefits and financial costs"] <- "About the same"

# DiffField1
# table(shed$DiffField1)

# DiffSchool1
# table(shed$DiffSchool1)

# LessEd1
# table(shed$LessEd1)

# MoreEd1
# table(shed$MoreEd1)

# OwnDebt
# table(shed$OwnDebt)

# OwnDebtSL
# table(shed$OwnDebtSL)

# OwnDebtHE
# table(shed$OwnDebtHE)

# OwnDebtCC
# table(shed$OwnDebtCC)

# OwnDebtOther
# table(shed$OwnDebtOther)

# OwnDebtTot
# table(shed$OwnDebtTot)
shed$OwnDebtTot1 <- shed$OwnDebtTot
shed$OwnDebtTot1[shed$OwnDebtTot=="Less than $5,000"] <- "2500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$5,000 to $9,999"] <- "7500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$10,000 to $14,999"] <- "12500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$15,000 to $19,999"] <- "17500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$20,000 to $24,999"] <- "22500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$25,000 to $29,999"] <- "27500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$30,000 to $39,999"] <- "35000"
shed$OwnDebtTot1[shed$OwnDebtTot=="$40,000 to $49,999"] <- "45000"
shed$OwnDebtTot1[shed$OwnDebtTot=="$50,000 to $74,999"] <- "62500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$75,000 to $99,999"] <- "87500"
shed$OwnDebtTot1[shed$OwnDebtTot=="$100,000 or above"] <- "105000"
shed$OwnDebtTot2 <- as.numeric(shed$OwnDebtTot1)
shed$OwnDebtTot3 <- rep(NA, nrow(shed))
shed$OwnDebtTot3[shed$OwnDebtTot2 < 5000] <- "Less than $5,000"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 5000 & shed$OwnDebtTot2 <= 9999] <- "$5,000 to $9,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 10000 & shed$OwnDebtTot2 <= 14999] <- "$10,000 to $14,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 15000 & shed$OwnDebtTot2 <= 19999] <- "$15,000 to $19,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 20000 & shed$OwnDebtTot2 <= 24999] <- "$20,000 to $24,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 25000 & shed$OwnDebtTot2 <= 29999] <- "$25,000 to $29,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 30000 & shed$OwnDebtTot2 <= 39999] <- "$30,000 to $39,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 40000 & shed$OwnDebtTot2 <= 49999] <- "$40,000 to $49,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 50000 & shed$OwnDebtTot2 <= 74999] <- "$50,000 to $74,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 >= 75000 & shed$OwnDebtTot2 <= 99999] <- "$75,000 to $99,999"
shed$OwnDebtTot3[shed$OwnDebtTot2 > 100000] <- "$100,000 or above"
shed$OwnDebtTot3[shed$OwnDebtTot2 == 1e+05] <- NA
# table(shed$OwnDebtTot3)

# OwnDebtMon
# table(shed$OwnDebtMon)
shed$OwnDebtMon1 <- shed$OwnDebtMon
shed$OwnDebtMon1[shed$OwnDebtMon=="I am currently not required to make any payments on these loans"] <- "0"
shed$OwnDebtMon1[shed$OwnDebtMon=="I am not currently required to make any payments on these loans"] <- "0"
shed$OwnDebtMon1[shed$OwnDebtMon=="I was not required to make any payments on these loans"] <- "0"
shed$OwnDebtMon1[shed$OwnDebtMon=="$1 to $99"] <- "99"
shed$OwnDebtMon1[shed$OwnDebtMon=="$1 to $49"] <- "49"
shed$OwnDebtMon1[shed$OwnDebtMon=="$59 to $49"] <- "99"
shed$OwnDebtMon1[shed$OwnDebtMon=="$100 to $199"] <- "199"
shed$OwnDebtMon1[shed$OwnDebtMon=="$200 to $299"] <- "299"
shed$OwnDebtMon1[shed$OwnDebtMon=="$300 to $399"] <- "399"
shed$OwnDebtMon1[shed$OwnDebtMon=="$400 to $499"] <- "499"
shed$OwnDebtMon1[shed$OwnDebtMon=="$500 to $749"] <- "749"
shed$OwnDebtMon1[shed$OwnDebtMon=="$500 to $999"] <- "599"
shed$OwnDebtMon1[shed$OwnDebtMon=="$750 to $999"] <- "999"
shed$OwnDebtMon1[shed$OwnDebtMon=="$1,000 or above"] <- "1000"
shed$OwnDebtMon2 <- as.numeric(shed$OwnDebtMon1)
shed$OwnDebtMon3 <- rep(NA, nrow(shed))
shed$OwnDebtMon3[shed$OwnDebtMon2 == 0] <- "$0"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 1 & shed$OwnDebtMon2 <= 99] <- "$1 to $99"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 100 & shed$OwnDebtMon2 <= 199] <- "$100 to $199"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 200 & shed$OwnDebtMon2 <= 299] <- "$200 to $299"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 300 & shed$OwnDebtMon2 <= 399] <- "$300 to $399"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 400 & shed$OwnDebtMon2 <= 499] <- "$400 to $499"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 500 & shed$OwnDebtMon2 <= 999] <- "$500 to $999"
shed$OwnDebtMon3[shed$OwnDebtMon2 >= 1000] <- "$1,000 or above"
shed$OwnDebtMon3[shed$OwnDebtMon2 == "-2"] <- NA
# table(shed$OwnDebtMon3)

# OwnDebtBehind
# table(shed$OwnDebtBehind)

# OwnRepaid
# table(shed$OwnRepaid)

# OwnCert
# table(shed$OwnCert)

# OwnAssoc
# table(shed$OwnAssoc)

# OwnBach
# table(shed$OwnBach)

# OwnGrad
# table(shed$OwnGrad)

# SpouseDebt
# table(shed$SpouseDebt)

# ChildDebt
# table(shed$ChildDebt)

# ChildDebtSL
# table(shed$ChildDebtSL)

# ChildDebtHE
# table(shed$ChildDebtHE)

# ChildDebtCC
# table(shed$ChildDebtCC)

# ChildDebtOther
# table(shed$ChildDebtOther)

# Retired
# table(shed$Retired)
shed$Retired[shed$Retired=="No"] <- "Not retired"
shed$Retired[shed$Retired=="Disabled and not working"] <- "Not retired"
shed$Retired[shed$Retired=="Employed now"] <- "Not retired"
shed$Retired[shed$Retired=="Homemaker"] <- "Not retired"
shed$Retired[shed$Retired=="Not employed, but looking for a job"] <- "Not retired"
shed$Retired[shed$Retired=="Temporarily laid off"] <- "Not retired"
shed$Retired[shed$Retired=="Student"] <- "Not retired"
shed$Retired[shed$Retired=="Not employed and not looking for a job"] <- "Not retired"
shed$Retired[shed$Retired=="Yes"] <- "Retired"
# table(shed$Retired)

# RetireOnTrack
# table(shed$RetireOnTrack)
shed$RetireOnTrack[shed$RetireOnTrack=="Don't know"] <- "Don't know"
shed$RetireOnTrack[shed$RetireOnTrack=="Dont know"] <- "Don't know"
shed$RetireOnTrack[shed$RetireOnTrack=="Don\x92t know"] <- "Don't know"
# table(shed$RetireOnTrack)

# SocSec
# table(shed$SocSec)

# Welfare
# table(shed$Welfare)

# TotalInc
# table(shed$TotalInc)
shed$TotalInc[shed$TotalInc=="0"] <- "$0 to $4,999"
shed$TotalInc[shed$TotalInc=="$0"] <- "$0 to $4,999"
shed$TotalInc[shed$TotalInc=="$1 to $4,999"] <- "$0 to $4,999"
# table(shed$TotalInc)

# EITC
# table(shed$EITC)

# SNAP
# table(shed$SNAP)

# WIC
# table(shed$WIC)

# HouseAssist
# table(shed$HouseAssist)

# FRPL
# table(shed$FRPL)

# ThreeMonSave
# table(shed$ThreeMonSave)

# ThreeMonCover
# table(shed$ThreeMonCover)

# CCA400
# table(shed$CCA400)
shed$CCA400[shed$CCA400=="Put it on my credit card and pay it off in full at the next statement"] <- "Yes"
# table(shed$CCA400)

# CCB400
# table(shed$CCB400)
shed$CCB400[shed$CCB400=="Put it on my credit card and pay it off over time"] <- "Yes"
# table(shed$CCB400)

# Cash400
# table(shed$Cash400)
shed$Cash400[shed$Cash400=="With the money currently in my checking/savings account or with cash"] <- "Yes"
# table(shed$Cash400)

# Loan400
# table(shed$Loan400)
shed$Loan400[shed$Loan400=="Using money from a bank loan or line of credit"] <- "Yes"
# table(shed$Loan400)

# Friend400
# table(shed$Friend400)
shed$Friend400[shed$Friend400=="By borrowing from a friend or family member"] <- "Yes"
# table(shed$Friend400)

# Payday400
# table(shed$Payday400)
shed$Payday400[shed$Payday400=="Using a payday loan, deposit advance, or overdraft"] <- "Yes"
# table(shed$Payday400)

# Sell400
# table(shed$Sell400)
shed$Sell400[shed$Sell400=="By selling something"] <- "Yes"
# table(shed$Sell400)

# None400
# table(shed$None400)
shed$None400[shed$None400=="I wouldnt be able to pay for the expense right now"] <- "Yes"
# table(shed$None400)

# PayBills
# table(shed$PayBills)
shed$PayBills[shed$PayBills=="Able to pay all bills"] <- "I will be able to pay all of my bills in full"
shed$PayBills[shed$PayBills=="I cannot pay some bills or will only make a partial payment on some of them"] <- "I cannot pay some bills or will only make a partial payment on them"
shed$PayBills[shed$PayBills=="Cant pay some bills"] <- "I cannot pay some bills or will only make a partial payment on them"
shed$PayBills[shed$PayBills=="Can\x92t pay some bills"] <- "I cannot pay some bills or will only make a partial payment on them"
# table(shed$PayBills)

# PayBills400
# table(shed$PayBills400)
shed$PayBills400[shed$PayBills400=="Could not pay some bills"] <- "I could not pay some other bills or would only make a partial payment on some of them"
shed$PayBills400[shed$PayBills400=="Would still be able to pay all bills"] <- "I would still be able to pay all of my other bills in full"
# table(shed$PayBills400)

# PartialRent
# table(shed$PartialRent)

# PartialCC
# table(shed$PartialCC)

# PartialSL
# table(shed$PartialSL)

# PartialSL400
# table(shed$PartialSL400)

# Occupation
# table(shed$Occupation)
shed$Occupation[shed$Occupation=="Business Operations (including Marketing)"] <- "Business and Financial Operations"
shed$Occupation[shed$Occupation=="Financial Operations or Financial Services (including Financial Advisor, Broker)"] <- "Business and Financial Operations"
shed$Occupation[shed$Occupation=="Health Diagnosing or Treating Practitioner (such as physician, nurse, dentist, v"] <- "Health Diagnosing or Treating Practitioner"
shed$Occupation[shed$Occupation=="Health Diagnosing or Treating Practitioner (such as physician, nurse, dentist, veterinarian, pharmacist)"] <- "Health Diagnosing or Treating Practitioner"
shed$Occupation[shed$Occupation=="Other Health Care Practitioner (such as nurse, pharmacist, chiropractor, dietici"] <- "Other Health Care Practitioner"
shed$Occupation[shed$Occupation=="Other Health Care Practitioner (such as nurse, pharmacist, chiropractor, dietician)"] <- "Other Health Care Practitioner"
shed$Occupation[shed$Occupation=="Retail Sales"] <- "Sales"
shed$Occupation[shed$Occupation=="Sales Representative"] <- "Sales"
# table(shed$Occupation)

# Savings
# table(shed$Savings)
shed$Savings[shed$Savings=="Under $5,000"] <- "Under $50,000"
shed$Savings[shed$Savings=="$5,000 - $9,999"] <- "Under $50,000"
shed$Savings[shed$Savings=="$10,000 - $24,999"] <- "Under $50,000"
shed$Savings[shed$Savings=="$25,000 - $34,999"] <- "Under $50,000"
shed$Savings[shed$Savings=="$35,000 - $49,999"] <- "Under $50,000"
shed$Savings[shed$Savings=="$50,000 - $74,999"] <- "$50,000 - $99,999"
shed$Savings[shed$Savings=="$75,000 - $99,999"] <- "$50,000 - $99,999"
shed$Savings[shed$Savings=="Not asked"] <- NA
# table(shed$Savings)

# CreditScore
# table(shed$CreditScore)
shed$CreditScore[shed$CreditScore=="Don\x92t know"] <- "Don't know"
shed$CreditScore[shed$CreditScore=="Don't know my score or how to rate it"] <- "Don't know"
shed$CreditScore[shed$CreditScore=="Dont know"] <- "Don't know"
shed$CreditScore[shed$CreditScore=="Don\x92t know my score or how to rate it"] <- "Don't know"
shed$CreditScore[shed$SurveyYear %in% c(2015, 2016)] <- NA # Inconsistent measure
# table(shed$CreditScore, shed$SurveyYear)

# InstLevel
# table(shed$InstLevel)
shed$InstLevel[shed$InstLevel=="[2, 4) years"] <- "Two-year"
shed$InstLevel[shed$InstLevel=="<2 years"] <- "Less than two-year"
shed$InstLevel[shed$InstLevel==">=4 years"] <- "Four-year"
shed$InstLevel[shed$InstLevel=="Administrative Unit"] <- NA
shed$InstLevel[shed$InstLevel=="Private for-profit, 2-year"] <- "Two-year"
shed$InstLevel[shed$InstLevel=="Private for-profit, 4-year or above"] <- "Four-year"
shed$InstLevel[shed$InstLevel=="Private for-profit, less-than 2-year"] <- "Less than two-year"
shed$InstLevel[shed$InstLevel=="Private not-for-profit, 2-year"] <- "Two-year"
shed$InstLevel[shed$InstLevel=="Private not-for-profit, 4-year or above"] <- "Four-year"
shed$InstLevel[shed$InstLevel=="Private not-for-profit, less-than 2-year"] <- "Less than two-year"
shed$InstLevel[shed$InstLevel=="Public, 2-year"] <- "Two-year"
shed$InstLevel[shed$InstLevel=="Public, 4-year or above"] <- "Four-year"
shed$InstLevel[shed$InstLevel=="Public, less-than 2-year"] <- "Less than two-year"
# table(shed$InstLevel)

# InstControl
# table(shed$InstControl)

# AnyStudentLoans
shed$AnyStudentLoans <- rep("No", nrow(shed))
shed$AnyStudentLoans[shed$OwnDebtSL=="Yes"] <- "Yes"
shed$AnyStudentLoans[shed$ChildDebtSL=="Yes"] <- "Yes"

# Count variable
shed$Count <- rep(1, nrow(shed))

```

### {.tabset}
```{r ownDebt}
# OwnDebt: # Do you currently have student loan debt or owe any money used to pay for your own education? 

# table(shed$OwnDebt)
shed.OwnDebt <- shed %>% filter((OwnDebt %in% c("Not In Universe (not asked)", "Refused", NA))==FALSE)
tblOwnDebt <- aggregate(data=shed.OwnDebt, Weight ~ OwnDebt + Race + State, FUN=sum)
tblOwnDebt2 <- aggregate(data=shed.OwnDebt, Weight ~ OwnDebt + State, FUN=sum)
tblOwnDebt2$Race <- rep("All", nrow(tblOwnDebt2))
tblOwnDebt <- rbind(tblOwnDebt, tblOwnDebt2)
tblOwnDebt <- reshape2::dcast(data=tblOwnDebt, Race + State ~ OwnDebt, value.var="Weight")
tblOwnDebt$`Share with debt` <- tblOwnDebt$Yes / (tblOwnDebt$Yes + tblOwnDebt$No)
```
#### Figure 6
##### Responses to "Do you currently have student loan debt or owe any money used to pay for your own education?" 
```{r figure6}
g6 <- ggplot(data=tblOwnDebt, mapping=aes(y=Race, x=`Share with debt`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2")

ggplotly(g6, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
#### Figure 7: Student loans
```{r OwnDebtSL}
# OwnDebtSL: # Student loan - Think about the money you currently owe for your own education. Is the money you owe for that education a: 

# table(shed$OwnDebtSL)
shed.OwnDebtSL <- shed %>% filter((OwnDebtSL %in% c("Not In Universe (not asked)", "Refused", NA))==FALSE) %>% filter(OwnDebt=="Yes")
tblOwnDebtSL <- aggregate(data=shed.OwnDebtSL, Weight ~ OwnDebtSL + Race + State, FUN=sum)
tblOwnDebtSL2 <- aggregate(data=shed.OwnDebtSL, Weight ~ OwnDebtSL + State, FUN=sum)
tblOwnDebtSL2$Race <- rep("All", nrow(tblOwnDebtSL2))
tblOwnDebtSL <- rbind(tblOwnDebtSL, tblOwnDebtSL2)
tblOwnDebtSL <- reshape2::dcast(data=tblOwnDebtSL, Race + State ~ OwnDebtSL, value.var="Weight")
tblOwnDebtSL$`Share of borrowers whose debt includes a student loan` <- tblOwnDebtSL$Yes / (tblOwnDebtSL$Yes + tblOwnDebtSL$No)
```
##### Responses to "Think about the money you currently owe for your own education. Is the money you owe for that education a student loan?"
```{r figure7A}
g7A <- ggplot(data=tblOwnDebtSL, mapping=aes(y=Race, x=`Share of borrowers whose debt includes a student loan`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2")

ggplotly(g7A, width=800, height=350)
```
#### Figure 7: Home equity
```{r OwnDebtHE}
# OwnDebtHE: # Home equity loan - Think about the money you currently owe for your own education. Is the money you owe for that education a: 

# table(shed$OwnDebtHE)
shed.OwnDebtHE <- shed %>% filter((OwnDebtHE %in% c("Not In Universe (not asked)", "Refused", NA))==FALSE) %>% filter(OwnDebt=="Yes")
tblOwnDebtHE <- aggregate(data=shed.OwnDebtHE, Weight ~ OwnDebtHE + Race + State, FUN=sum)
tblOwnDebtHE2 <- aggregate(data=shed.OwnDebtHE, Weight ~ OwnDebtHE + State, FUN=sum)
tblOwnDebtHE2$Race <- rep("All", nrow(tblOwnDebtHE2))
tblOwnDebtHE <- rbind(tblOwnDebtHE, tblOwnDebtHE2)
tblOwnDebtHE <- reshape2::dcast(data=tblOwnDebtHE, Race + State ~ OwnDebtHE, value.var="Weight")
tblOwnDebtHE$`Share of borrowers whose debt includes home equity` <- tblOwnDebtHE$Yes / (tblOwnDebtHE$Yes + tblOwnDebtHE$No)
```
##### Responses to "Think about the money you currently owe for your own education. Is the money you owe for that education home equity?
```{r figure7B}
g7B <- ggplot(data=tblOwnDebtHE, mapping=aes(y=Race, x=`Share of borrowers whose debt includes home equity`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2")

ggplotly(g7B, width=800, height=350)
```
#### Figure 7: Credit card debt
```{r OwnDebtCC}
# OwnDebtCC: # Credit card - Think about the money you currently owe for your own education. Is the money you owe for that education a:

# table(shed$OwnDebtCC)
shed.OwnDebtCC <- shed %>% filter((OwnDebtCC %in% c("Not In Universe (not asked)", "Refused", NA))==FALSE) %>% filter(OwnDebt=="Yes")
tblOwnDebtCC <- aggregate(data=shed.OwnDebtCC, Weight ~ OwnDebtCC + Race + State, FUN=sum)
tblOwnDebtCC2 <- aggregate(data=shed.OwnDebtCC, Weight ~ OwnDebtCC + State, FUN=sum)
tblOwnDebtCC2$Race <- rep("All", nrow(tblOwnDebtCC2))
tblOwnDebtCC <- rbind(tblOwnDebtCC, tblOwnDebtCC2)
tblOwnDebtCC <- reshape2::dcast(data=tblOwnDebtCC, Race + State ~ OwnDebtCC, value.var="Weight")
tblOwnDebtCC$`Share of borrowers whose debt includes credit card debt` <- tblOwnDebtCC$Yes / (tblOwnDebtCC$Yes + tblOwnDebtCC$No)
```
##### Responses to "Think about the money you currently owe for your own education. Is the money you owe for that education credit card debt?"
```{r figure7C}
g7C <- ggplot(data=tblOwnDebtCC, mapping=aes(y=Race, x=`Share of borrowers whose debt includes credit card debt`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g7C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
#### Figure 8: CA borrowers
```{r OwnDebtTotal}
# OwnDebtTot3: # Thinking specifically about the money that you owe for your own education, please tell the total amount that you currently owe on these loans. 

# table(shed$OwnDebtTot3)
shed.OwnDebtTot3 <- shed %>% filter(is.na(OwnDebtTot3)==FALSE)
tblOwnDebtTot3 <- aggregate(data=shed.OwnDebtTot3, Weight ~ OwnDebtTot3 + Race + State, FUN=sum)
tblOwnDebtTot32 <- aggregate(data=shed.OwnDebtTot3, Weight ~ OwnDebtTot3 + State, FUN=sum)
tblOwnDebtTot32$Race <- rep("All", nrow(tblOwnDebtTot32))
tblOwnDebtTot3 <- rbind(tblOwnDebtTot3, tblOwnDebtTot32)
tblOwnDebtTot3 <- reshape2::dcast(data=tblOwnDebtTot3, Race + State ~ OwnDebtTot3, value.var="Weight")
tblOwnDebtTot3$`Total weight` <- tblOwnDebtTot3$`Less than $5,000` + tblOwnDebtTot3$`$5,000 to $9,999` + tblOwnDebtTot3$`$10,000 to $14,999` + tblOwnDebtTot3$`$15,000 to $19,999` + tblOwnDebtTot3$`$20,000 to $24,999` + tblOwnDebtTot3$`$25,000 to $29,999` + tblOwnDebtTot3$`$30,000 to $39,999` + tblOwnDebtTot3$`$40,000 to $49,999` +  tblOwnDebtTot3$`$50,000 to $74,999` + tblOwnDebtTot3$`$75,000 to $99,999` + tblOwnDebtTot3$`$100,000 or above` 
tblOwnDebtTot3$`Less than $5,000` <- tblOwnDebtTot3$`Less than $5,000` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$5,000 to $9,999` <- tblOwnDebtTot3$`$5,000 to $9,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$10,000 to $14,999` <- tblOwnDebtTot3$`$10,000 to $14,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$15,000 to $19,999` <- tblOwnDebtTot3$`$15,000 to $19,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$20,000 to $24,999` <- tblOwnDebtTot3$`$20,000 to $24,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$25,000 to $29,999` <- tblOwnDebtTot3$`$25,000 to $29,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$30,000 to $39,999` <- tblOwnDebtTot3$`$30,000 to $39,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$40,000 to $49,999` <- tblOwnDebtTot3$`$40,000 to $49,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$50,000 to $74,999` <- tblOwnDebtTot3$`$50,000 to $74,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$75,000 to $99,999` <- tblOwnDebtTot3$`$75,000 to $99,999` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3$`$100,000 or above` <- tblOwnDebtTot3$`$100,000 or above` / tblOwnDebtTot3$`Total weight`
tblOwnDebtTot3 <- reshape2::melt(data=tblOwnDebtTot3, id.vars = c("Race", "State"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblOwnDebtTot3$variable <- factor(tblOwnDebtTot3$variable, levels = c("$100,000 or above", "$75,000 to $99,999", "$50,000 to $74,999", "$40,000 to $49,999", "$30,000 to $39,999", "$25,000 to $29,999", "$20,000 to $24,999","$15,000 to $19,999", "$10,000 to $14,999", "$5,000 to $9,999", "Less than $5,000"))
```
##### Responses to "Thinking specifically about the money that you owe for your own education, please tell the total amount that you currently owe on these loans."
```{r figure8A}
tblOwnDebtTot3.CA <- tblOwnDebtTot3 %>% filter(State=="CA")
g8A <- ggplot(data=tblOwnDebtTot3.CA, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Total student debt") + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g8A, height=350)
```
#### Figure 8: Rest of U.S. borrowers
##### Responses to "Thinking specifically about the money that you owe for your own education, please tell the total amount that you currently owe on these loans."
```{r figure8B}
tblOwnDebtTot3.US <- tblOwnDebtTot3 %>% filter(State=="Rest of U.S.")
g8B <- ggplot(data=tblOwnDebtTot3.US, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Total student debt") + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g8B, height=350)
```
#### Data source and notes
***
#### {-}

xxx 

### {.tabset}
```{r OwnDebtMon3}
# OwnDebtMon3: # Approximately how much is the total monthly payment that you are required to make on the loans from your education?

# table(shed$OwnDebtMon3)
shed.OwnDebtMon3 <- shed %>% filter(is.na(OwnDebtMon3)==FALSE) %>% filter(SurveyYear %in% c(2015, 2016, 2017, 2018, 2019))
shed.OwnDebtMon3 <- shed.OwnDebtMon3 %>% add_row(OwnDebtMon3="$400 to $499", Race="Black, Non-Hispanic", State="CA", Weight=0)
tblOwnDebtMon3 <- aggregate(data=shed.OwnDebtMon3, Weight ~ OwnDebtMon3 + Race + State, FUN=sum)
tblOwnDebtMon32 <- aggregate(data=shed.OwnDebtMon3, Weight ~ OwnDebtMon3 + State, FUN=sum)
tblOwnDebtMon32$Race <- rep("All", nrow(tblOwnDebtMon32))
tblOwnDebtMon3 <- rbind(tblOwnDebtMon3, tblOwnDebtMon32)
tblOwnDebtMon3 <- reshape2::dcast(data=tblOwnDebtMon3, Race + State ~ OwnDebtMon3, value.var="Weight")
tblOwnDebtMon3$`Total weight` <- tblOwnDebtMon3$`$0` + tblOwnDebtMon3$`$1 to $99` + tblOwnDebtMon3$`$100 to $199` + tblOwnDebtMon3$`$200 to $299` + tblOwnDebtMon3$`$300 to $399` + tblOwnDebtMon3$`$400 to $499` + tblOwnDebtMon3$`$500 to $999` + tblOwnDebtMon3$`$1,000 or above`
tblOwnDebtMon3$`$0` <- tblOwnDebtMon3$`$0` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$1 to $99` <- tblOwnDebtMon3$`$1 to $99` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$100 to $199` <- tblOwnDebtMon3$`$100 to $199` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$200 to $299` <- tblOwnDebtMon3$`$200 to $299` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$300 to $399` <- tblOwnDebtMon3$`$300 to $399` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$400 to $499` <- tblOwnDebtMon3$`$400 to $499` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$500 to $999` <- tblOwnDebtMon3$`$500 to $999` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3$`$1,000 or above` <- tblOwnDebtMon3$`$1,000 or above` / tblOwnDebtMon3$`Total weight`
tblOwnDebtMon3 <- reshape2::melt(data=tblOwnDebtMon3, id.vars = c("Race", "State"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblOwnDebtMon3$variable <- factor(tblOwnDebtMon3$variable, levels = c("$1,000 or above", "$500 to $999", "$400 to $499", "$300 to $399", "$200 to $299", "$100 to $199", "$1 to $99", "$0"))
tblOwnDebtMon3$Race <- factor(tblOwnDebtMon3$Race, levels=rev(c("All", "White, Non-Hispanic", "Hispanic", "Black, Non-Hispanic", "Other, Non-Hispanic")))
```
#### Figure 9: CA borrowers
##### Responses to "Approximately how much is the total monthly payment that you are required to make on the loans from your education?"
```{r figure9A}
tblOwnDebtMon3.CA <- tblOwnDebtMon3 %>% filter(State=="CA")
g9A <- ggplot(data=tblOwnDebtMon3.CA, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Monthly student debt payment", y="", x="Share of student loan borrowers in California") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g9A, width=800, height=350)
```
#### Figure 9: Rest of U.S. borrowers
##### Responses to "Approximately how much is the total monthly payment that you are required to make on the loans from your education?"
```{r figure9B}
tblOwnDebtMon3.US <- tblOwnDebtMon3 %>% filter(State=="Rest of U.S.")
g9A <- ggplot(data=tblOwnDebtMon3.US, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Monthly student debt payment", y="", x="Share of student loan borrowers in rest of U.S.") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g9A, width=800, height=350)
```
#### Data source and notes
Survey responses collected in 2020 and 2021 are not included due to the federal student loan payment pause in place that started in March 2020 and continued through all of 2021.  
***
### {-}

xxx 

### {.tabset}
#### Figure 10
```{r OwnDebtBehind}
# OwnDebtBehind: # Are you behind on payments or in collections for one or more of the loans from your own education? 

# table(shed$OwnDebtBehind)
shed.OwnDebtBehind <- shed %>% filter((OwnDebtBehind %in% c("Not In Universe (not asked)", "Refused", "", NA))==FALSE) 
tblOwnDebtBehind <- aggregate(data=shed.OwnDebtBehind, Weight ~ OwnDebtBehind + Race + State, FUN=sum)
tblOwnDebtBehind2 <- aggregate(data=shed.OwnDebtBehind, Weight ~ OwnDebtBehind + State, FUN=sum)
tblOwnDebtBehind2$Race <- rep("All", nrow(tblOwnDebtBehind2))
tblOwnDebtBehind <- rbind(tblOwnDebtBehind, tblOwnDebtBehind2)
tblOwnDebtBehind <- reshape2::dcast(data=tblOwnDebtBehind, Race + State ~ OwnDebtBehind, value.var="Weight")
tblOwnDebtBehind$`Share of borrowers behind on payments` <- tblOwnDebtBehind$Yes / (tblOwnDebtBehind$Yes + tblOwnDebtBehind$No)
```
##### Responses to "Are you behind on payments or in collections for one or more of the loans from your own education?"
```{r figure10}
g10 <- ggplot(data=tblOwnDebtBehind, mapping=aes(y=Race, x=`Share of borrowers behind on payments`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2")

ggplotly(g10, height=350)
```
#### Data source and notes
Survey responses collected in 2020 and 2021 are not included due to the federal student loan payment pause in place that started in March 2020 and continued through all of 2021.  

***
### {-}

xxx 

### {.tabset}
#### Figure 11: Debt for spouse's or partner's education
```{r SpouseDebt}
# SpouseDebt: # Do you currently owe any money used to pay for your [spouse/ partner]'s education?

# table(shed$SpouseDebt)
shed.SpouseDebt <- shed %>% filter((SpouseDebt %in% c("Not In Universe (not asked)", "Refused", "", NA))==FALSE) 
tblSpouseDebt <- aggregate(data=shed.SpouseDebt, Weight ~ SpouseDebt + Race + State, FUN=sum)
tblSpouseDebt2 <- aggregate(data=shed.SpouseDebt, Weight ~ SpouseDebt + State, FUN=sum)
tblSpouseDebt2$Race <- rep("All", nrow(tblSpouseDebt2))
tblSpouseDebt <- rbind(tblSpouseDebt, tblSpouseDebt2)
tblSpouseDebt <- reshape2::dcast(data=tblSpouseDebt, Race + State ~ SpouseDebt, value.var="Weight")
tblSpouseDebt$`Share who have debt for a partner or spouse's education` <- tblSpouseDebt$Yes / (tblSpouseDebt$Yes + tblSpouseDebt$No)
```
##### Responses to "Do you currently owe any money used to pay for your [spouse/ partner]'s education?"
```{r figure11A}
g11A <- ggplot(data=tblSpouseDebt, mapping=aes(y=Race, x=`Share who have debt for a partner or spouse's education`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 0.2)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2")

ggplotly(g11A, height=350)
```
#### Figure 11: Debt for child's or grandchild's education
```{r ChildEducation}
# ChildDebt: # Do you currently owe any money used to pay for your child or grandchilds education?

# table(shed$ChildDebt)
shed.ChildDebt <- shed %>% filter((ChildDebt %in% c("Not In Universe (not asked)", "Do not have children or grandchildren", "Refused", "", NA))==FALSE) 
tblChildDebt <- aggregate(data=shed.ChildDebt, Weight ~ ChildDebt + Race + State, FUN=sum)
tblChildDebt2 <- aggregate(data=shed.ChildDebt, Weight ~ ChildDebt + State, FUN=sum)
tblChildDebt2$Race <- rep("All", nrow(tblChildDebt2))
tblChildDebt <- rbind(tblChildDebt, tblChildDebt2)
tblChildDebt <- reshape2::dcast(data=tblChildDebt, Race + State ~ ChildDebt, value.var="Weight")
tblChildDebt$`Share who have debt for a child's or grandchild's education` <- tblChildDebt$Yes / (tblChildDebt$Yes + tblChildDebt$No)
```
##### Responses to "Do you currently owe any money used to pay for your child or grandchilds education?"
```{r figure11B}
g11B <- ggplot(data=tblChildDebt, mapping=aes(y=Race, x=`Share who have debt for a child's or grandchild's education`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 0.2)) + labs(y="", title="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2")

ggplotly(g11B, height=350)
```
#### Data source and notes
Figure 11 includes all respondents, not just those who have student debt for their own education. 
"Figure 11: Debt for spouse's or partner's education" does not include survey respondents without a spouse or partner. 
"Figure 11: Debt for child or grandchild's education" does not include survey respondents without children or grandchildren. 
***
### {-}

xxxx 

### {.tabset}
```{r EdAttainment}
# EdAttain: # What is the highest level of school you have completed or the highest degree you have received? 

# table(shed$EdAttain)
shed.EdAttain <- shed %>% filter(is.na(EdAttain)==FALSE)
tblEdAttain <- aggregate(data=shed.EdAttain, Weight ~ EdAttain + Race + State + AnyStudentLoans, FUN=sum)
tblEdAttain2 <- aggregate(data=shed.EdAttain, Weight ~ EdAttain + State + AnyStudentLoans, FUN=sum)
tblEdAttain2$Race <- rep("All", nrow(tblEdAttain2))
tblEdAttain <- rbind(tblEdAttain, tblEdAttain2)
tblEdAttain <- reshape2::dcast(data=tblEdAttain, Race + State + AnyStudentLoans ~ EdAttain, value.var="Weight")
tblEdAttain$`Total weight` <- tblEdAttain$`Associate degree` + tblEdAttain$`Bachelor's degree` + tblEdAttain$`Doctorate` + tblEdAttain$`High school degree or GED` + tblEdAttain$`Less than high school diploma` + tblEdAttain$`Master's degree` + tblEdAttain$`Professional degree` + tblEdAttain$`Some college, no degree`
tblEdAttain$`Associate degree` <- tblEdAttain$`Associate degree` / tblEdAttain$`Total weight`
tblEdAttain$`Bachelor's degree` <- tblEdAttain$`Bachelor's degree` / tblEdAttain$`Total weight`
tblEdAttain$`Doctorate` <- tblEdAttain$`Doctorate` / tblEdAttain$`Total weight`
tblEdAttain$`High school degree or GED` <- tblEdAttain$`High school degree or GED` / tblEdAttain$`Total weight`
tblEdAttain$`Less than high school diploma` <- tblEdAttain$`Less than high school diploma` / tblEdAttain$`Total weight`
tblEdAttain$`Master's degree` <- tblEdAttain$`Master's degree` / tblEdAttain$`Total weight`
tblEdAttain$`Professional degree` <- tblEdAttain$`Professional degree` / tblEdAttain$`Total weight`
tblEdAttain$`Some college, no degree` <- tblEdAttain$`Some college, no degree` / tblEdAttain$`Total weight`
tblEdAttain <- reshape2::melt(data=tblEdAttain, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblEdAttain$variable <- factor(tblEdAttain$variable, levels = c("Doctorate", "Professional degree", "Master's degree", "Bachelor's degree", "Associate degree", "Some college, no degree", "High school degree or GED", "Less than high school diploma"))
```
#### Figure 12: CA borrowers
##### Responses to "What is the highest level of school you have completed or the highest degree you have received?" 
```{r figure12A}
tblEdAttain.CA.Borrow <- tblEdAttain %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")
g12A <- ggplot(data=tblEdAttain.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Highest level of education", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g12A, width=800, height=350)
```
#### Figure 12: Rest of U.S. borrowers
##### Responses to "What is the highest level of school you have completed or the highest degree you have received?"
```{r figure12B}
tblEdAttain.US.Borrow <- tblEdAttain %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")
g12B <- ggplot(data=tblEdAttain.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Highest level of education", x="Share of student loan borrowers in the rest of the U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g12B, width=800, height=350)
```
#### Figure 12: CA non-borrowers
##### Responses to "What is the highest level of school you have completed or the highest degree you have received?"
```{r figure12C}
tblEdAttain.CA.Nonborrow <- tblEdAttain %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")
g12C <- ggplot(data=tblEdAttain.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Highest level of education", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g12C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
```{r HomeOwn}
# HomeOwn: # Do you own your home?

# table(shed$HomeOwn)
shed.HomeOwn <- shed %>% filter(is.na(HomeOwn)==FALSE) %>% filter(HomeOwn != "Refused") %>% filter(HomeOwn != "NA") 
tblHomeOwn <- aggregate(data=shed.HomeOwn, Weight ~ HomeOwn + Race + State + AnyStudentLoans, FUN=sum)
tblHomeOwn2 <- aggregate(data=shed.HomeOwn, Weight ~ HomeOwn + State + AnyStudentLoans, FUN=sum)
tblHomeOwn2$Race <- rep("All", nrow(tblHomeOwn2))
tblHomeOwn <- rbind(tblHomeOwn, tblHomeOwn2)
tblHomeOwn <- reshape2::dcast(data=tblHomeOwn, Race + State + AnyStudentLoans~ HomeOwn, value.var="Weight")
tblHomeOwn$`Total weight` <- tblHomeOwn$`Own home with a mortgage or loan` + tblHomeOwn$`Own home free and clear` + tblHomeOwn$`Pay rent` + tblHomeOwn$`Other`
tblHomeOwn$`Own home with a mortgage or loan` <- tblHomeOwn$`Own home with a mortgage or loan` / tblHomeOwn$`Total weight`
tblHomeOwn$`Own home free and clear` <- tblHomeOwn$`Own home free and clear` / tblHomeOwn$`Total weight`
tblHomeOwn$`Pay rent` <- tblHomeOwn$`Pay rent` / tblHomeOwn$`Total weight`
tblHomeOwn$`Other` <- tblHomeOwn$`Other` / tblHomeOwn$`Total weight`
tblHomeOwn <- reshape2::melt(data=tblHomeOwn, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblHomeOwn$variable <- factor(tblHomeOwn$variable, levels = c("Own home free and clear", "Own home with a mortgage or loan", "Pay rent", "Other"))
```
#### Figure 13: CA borrowers
##### Responses to "Do you own your home?"
```{r figure13A, warning=FALSE}
tblHomeOwn.CA.Borrow <- tblHomeOwn %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes") 
g13A <- ggplot(data=tblHomeOwn.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Home ownership status", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g13A, width=800, height=350)
```
#### Figure 13: Rest of U.S. borrowers
##### Responses to "Do you own your home?"
```{r figure13B, warning=FALSE}
tblHomeOwn.US.Borrow <- tblHomeOwn %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes") 
g13B <- ggplot(data=tblHomeOwn.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Home ownership status", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g13B, width=800, height=350)
```
#### Figure 13: CA non-borrowers
##### Responses to "Do you own your home?"
```{r figure13C, warning=FALSE}
tblHomeOwn.CA.Nonborrow <- tblHomeOwn %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No") 
g13C <- ggplot(data=tblHomeOwn.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Home ownership status", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g13C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
```{r UnpaidCC}
# UnpaidCC: # Do you currently have any outstanding unpaid credit card debt?

# table(shed$UnpaidCC)
shed.UnpaidCC <- shed %>% filter((UnpaidCC %in% c("Refused", "Not In Universe (not asked)")==FALSE)) 
tblUnpaidCC <- aggregate(data=shed.UnpaidCC, Weight ~ UnpaidCC + Race + State + AnyStudentLoans, FUN=sum)
tblUnpaidCC2 <- aggregate(data=shed.UnpaidCC, Weight ~ UnpaidCC + State + AnyStudentLoans, FUN=sum)
tblUnpaidCC2$Race <- rep("All", nrow(tblUnpaidCC2))
tblUnpaidCC <- rbind(tblUnpaidCC, tblUnpaidCC2)
tblUnpaidCC <- reshape2::dcast(data=tblUnpaidCC, Race + State + AnyStudentLoans ~ UnpaidCC, value.var="Weight")
tblUnpaidCC$`Share with unpaid credit card debt` <- tblUnpaidCC$Yes / (tblUnpaidCC$Yes + tblUnpaidCC$No)
```
#### Figure 14: Student loan borrowers
##### Responses to "Do you currently have any outstanding unpaid credit card debt?"
```{r figure14A}
tblUnpaidCC.Borrower <- tblUnpaidCC %>% filter(AnyStudentLoans=="Yes")
g14A <- ggplot(data=tblUnpaidCC.Borrower, mapping=aes(y=Race, x=`Share with unpaid credit card debt`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share of student loan borrowers") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g14A, width=800, height=350)
```
#### Figure 14: Non-borrowers
##### Responses to "Do you currently have any outstanding unpaid credit card debt?"
```{r figure14B}
tblUnpaidCC.Nonborrower <- tblUnpaidCC %>% filter(AnyStudentLoans=="No")
g14B <- ggplot(data=tblUnpaidCC.Nonborrower, mapping=aes(y=Race, x=`Share with unpaid credit card debt`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share of non-borrowers") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g14B, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
```{r CCBalance}
# CCBalance: # In the past 12 months, how frequently have you carried an unpaid balance on one or more of your credit cards? 

# table(shed$CCBalance)
shed.CCBalance <- shed %>% filter(is.na(CCBalance)==FALSE) %>% filter((CCBalance %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblCCBalance <- aggregate(data=shed.CCBalance, Weight ~ CCBalance + Race + State + AnyStudentLoans, FUN=sum)
tblCCBalance2 <- aggregate(data=shed.CCBalance, Weight ~ CCBalance + State + AnyStudentLoans, FUN=sum)
tblCCBalance2$Race <- rep("All", nrow(tblCCBalance2))
tblCCBalance <- rbind(tblCCBalance, tblCCBalance2)
tblCCBalance <- reshape2::dcast(data=tblCCBalance, Race + State + AnyStudentLoans ~ CCBalance, value.var="Weight")
tblCCBalance$`Total weight` <- tblCCBalance$`Always pay in full` + tblCCBalance$`Most or all of the time` + tblCCBalance$`Some of the time` + tblCCBalance$`Once`
tblCCBalance$`Always pay in full` <- tblCCBalance$`Always pay in full` / tblCCBalance$`Total weight`
tblCCBalance$`Most or all of the time` <- tblCCBalance$`Most or all of the time` / tblCCBalance$`Total weight`
tblCCBalance$`Some of the time` <- tblCCBalance$`Some of the time` / tblCCBalance$`Total weight`
tblCCBalance$`Once` <- tblCCBalance$`Once` / tblCCBalance$`Total weight`
tblCCBalance <- reshape2::melt(data=tblCCBalance, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblCCBalance$variable <- factor(tblCCBalance$variable, levels = c("Most or all of the time", "Some of the time", "Once", "Always pay in full"))
```
#### Figure 15: CA borrowers
##### Responses to "In the past 12 months, how frequently have you carried an unpaid balance on one or more of your credit cards?"
```{r figure15A}
tblCCBalance.CA.Borrow <- tblCCBalance %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")
g15A <- ggplot(data=tblCCBalance.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g15A, width=800, height=350)
```
#### Figure 15: Rest of U.S. borrowers
##### Responses to "In the past 12 months, how frequently have you carried an unpaid balance on one or more of your credit cards?"
```{r figure15B}
tblCCBalance.US.Borrow <- tblCCBalance %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")
g15B <- ggplot(data=tblCCBalance.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g15B, width=800, height=350)
```
#### Figure 15: CA non-borrowers
##### Responses to "In the past 12 months, how frequently have you carried an unpaid balance on one or more of your credit cards?"
```{r figure15C}
tblCCBalance.CA.Nonborrow <- tblCCBalance %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")
g15C <- ggplot(data=tblCCBalance.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g15C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
```{r Savings}
# Savings: # What is the approximate total amount of your household's savings and investments?

# table(shed$Savings)
shed.Savings <- shed %>% filter((Savings %in% c("Not sure", "Refused", ""))==FALSE) %>% filter(is.na(Savings)==FALSE) 
tblSavings <- aggregate(data=shed.Savings, Weight ~ Savings + Race + State + AnyStudentLoans, FUN=sum)
tblSavings <- tblSavings %>% add_row(Savings="$250,000 - $499,999", Race="Black, Non-Hispanic", State="CA", AnyStudentLoans="Yes", Weight=0)
tblSavings <- tblSavings %>% add_row(Savings="$500,000 - $999,999", Race="Black, Non-Hispanic", State="CA", AnyStudentLoans="Yes", Weight=0)
tblSavings2 <- aggregate(data=shed.Savings, Weight ~ Savings + State + AnyStudentLoans, FUN=sum)
tblSavings2$Race <- rep("All", nrow(tblSavings2))
tblSavings <- rbind(tblSavings, tblSavings2)
tblSavings <- reshape2::dcast(data=tblSavings, Race + State + AnyStudentLoans ~ Savings, value.var="Weight")
tblSavings$`Total weight` <- tblSavings$`Under $50,000` + tblSavings$`$50,000 - $99,999` + tblSavings$`$100,000 - $249,999` +  tblSavings$`$250,000 - $499,999` + tblSavings$`$500,000 - $999,999` + tblSavings$`$1,000,000 or more` 
tblSavings$`Under $50,000` <- tblSavings$`Under $50,000` / tblSavings$`Total weight`
tblSavings$`$50,000 - $99,999` <- tblSavings$`$50,000 - $99,999` / tblSavings$`Total weight`
tblSavings$`$100,000 - $249,999` <- tblSavings$`$100,000 - $249,999` / tblSavings$`Total weight`
tblSavings$`$250,000 - $499,999` <- tblSavings$`$250,000 - $499,999` / tblSavings$`Total weight`
tblSavings$`$500,000 - $999,999` <- tblSavings$`$500,000 - $999,999` / tblSavings$`Total weight`
tblSavings$`$1,000,000 or more` <- tblSavings$`$1,000,000 or more` / tblSavings$`Total weight`
tblSavings <- reshape2::melt(data=tblSavings, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblSavings$variable <- factor(tblSavings$variable, levels = c("$1,000,000 or more", "$500,000 - $999,999", "$250,000 - $499,999", "$100,000 - $249,999", "$50,000 - $99,999", "Under $50,000"))
tblSavings$Race <- factor(tblSavings$Race, levels=rev(c("All", "White, Non-Hispanic", "Hispanic", "Black, Non-Hispanic", "Other, Non-Hispanic")))
```
#### Figure 16: CA borrowers
##### Responses to "What is the approximate total amount of your household's savings and investments?"
```{r figure16A}
tblSavings.CA.Borrow <- tblSavings %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")
g16A <- ggplot(data=tblSavings.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Savings and investments", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g16A, width=800, height=350)
```
#### Figure 16: Rest of U.S. borrowers
##### Responses to "What is the approximate total amount of your household's savings and investments?"
```{r figure16B}
tblSavings.US.Borrow <- tblSavings %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")
g16B <- ggplot(data=tblSavings.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Savings and investments", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g16B, width=800, height=350)
```
#### Figure 16: CA non-borrowers
##### Responses to "What is the approximate total amount of your household's savings and investments?"
```{r figure16C}
tblSavings.CA.Nonborrow <- tblSavings %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")
g16C <- ggplot(data=tblSavings.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Savings and investments", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g16C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
```{r TotalInc}
# TotalInc: # Which of the following categories best describes the total income that you received from all sources, before taxes and deductions, in the past 12 months? 

# table(shed$TotalInc)
shed.TotalInc <- shed %>% filter(is.na(TotalInc)==FALSE) %>% filter((TotalInc %in% c("Refused", ""))==FALSE) 
tblTotalInc <- aggregate(data=shed.TotalInc, Weight ~ TotalInc + Race + State + AnyStudentLoans, FUN=sum)
tblTotalInc2 <- aggregate(data=shed.TotalInc, Weight ~ TotalInc + State + AnyStudentLoans, FUN=sum)
tblTotalInc2$Race <- rep("All", nrow(tblTotalInc2))
tblTotalInc <- rbind(tblTotalInc, tblTotalInc2)
tblTotalInc <- reshape2::dcast(data=tblTotalInc, Race + State + AnyStudentLoans ~ TotalInc, value.var="Weight")
tblTotalInc$`Total weight` <- tblTotalInc$`$0 to $4,999` + tblTotalInc$`$5,000 to $14,999` + tblTotalInc$`$15,000 to $24,999` + tblTotalInc$`$25,000 to $39,999` + tblTotalInc$`$40,000 to $49,999` + tblTotalInc$`$50,000 to $74,999` + tblTotalInc$`$75,000 to $99,999` + tblTotalInc$`$100,000 to $149,999` + tblTotalInc$`$150,000 to $199,999` + tblTotalInc$`$200,000 or higher`
tblTotalInc$`$0 to $4,999` <- tblTotalInc$`$0 to $4,999` / tblTotalInc$`Total weight`
tblTotalInc$`$5,000 to $14,999` <- tblTotalInc$`$5,000 to $14,999` / tblTotalInc$`Total weight`
tblTotalInc$`$15,000 to $24,999` <- tblTotalInc$`$15,000 to $24,999` / tblTotalInc$`Total weight`
tblTotalInc$`$25,000 to $39,999` <- tblTotalInc$`$25,000 to $39,999` / tblTotalInc$`Total weight`
tblTotalInc$`$40,000 to $49,999` <- tblTotalInc$`$40,000 to $49,999` / tblTotalInc$`Total weight`
tblTotalInc$`$50,000 to $74,999` <- tblTotalInc$`$50,000 to $74,999` / tblTotalInc$`Total weight`
tblTotalInc$`$75,000 to $99,999` <- tblTotalInc$`$75,000 to $99,999` / tblTotalInc$`Total weight`
tblTotalInc$`$100,000 to $149,999` <- tblTotalInc$`$100,000 to $149,999` / tblTotalInc$`Total weight`
tblTotalInc$`$150,000 to $199,999` <- tblTotalInc$`$150,000 to $199,999` / tblTotalInc$`Total weight`
tblTotalInc$`$200,000 or higher` <- tblTotalInc$`$200,000 or higher` / tblTotalInc$`Total weight`
tblTotalInc <- reshape2::melt(data=tblTotalInc, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblTotalInc$variable <- factor(tblTotalInc$variable, levels = c("$200,000 or higher", "$150,000 to $199,999", "$100,000 to $149,999", "$75,000 to $99,999", "$50,000 to $74,999", "$40,000 to $49,999", "$25,000 to $39,999", "$15,000 to $24,999", "$5,000 to $14,999", "$0 to $4,999"))
```
#### Figure 17: CA borrowers
##### Responses to "Which of the following categories best describes the total income that you received from all sources, before taxes and deductions, in the past 12 months?"
```{r figure17A}
tblTotalInc.CA.Borrow <- tblTotalInc %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")
g17A <- ggplot(data=tblTotalInc.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Total income", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g17A, width=800, height=350)
```
#### Figure 17: Rest of U.S. borrowers
##### Responses to "Which of the following categories best describes the total income that you received from all sources, before taxes and deductions, in the past 12 months?"
```{r figure17B}
tblTotalInc.US.Borrow <- tblTotalInc %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")
g17B <- ggplot(data=tblTotalInc.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Total income", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g17B, width=800, height=350)
```
#### Figure 17: CA non-borrowers
##### Responses to "Which of the following categories best describes the total income that you received from all sources, before taxes and deductions, in the past 12 months?"
```{r figure17C}
tblTotalInc.CA.Nonborrow <- tblTotalInc %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")
g17C <- ggplot(data=tblTotalInc.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="Total income", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g17C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
```{r FinManage}
# FinManage: # Overall, which one of the following best describes how well you are managing financially these days? 

# table(shed$FinManage)
shed.FinManage <- shed %>% filter(is.na(FinManage)==FALSE) %>% filter((FinManage %in% c("Refused")==FALSE)) 
tblFinManage <- aggregate(data=shed.FinManage, Weight ~ FinManage + Race + State + AnyStudentLoans, FUN=sum)
tblFinManage2 <- aggregate(data=shed.FinManage, Weight ~ FinManage + State + AnyStudentLoans, FUN=sum)
tblFinManage2$Race <- rep("All", nrow(tblFinManage2))
tblFinManage <- rbind(tblFinManage, tblFinManage2)
tblFinManage <- reshape2::dcast(data=tblFinManage, Race + State + AnyStudentLoans ~ FinManage, value.var="Weight")
tblFinManage$`Total weight` <- tblFinManage$`Living comfortably` + tblFinManage$`Finding it difficult to get by` + tblFinManage$`Just getting by` + tblFinManage$`Doing okay`
tblFinManage$`Living comfortably` <- tblFinManage$`Living comfortably` / tblFinManage$`Total weight`
tblFinManage$`Finding it difficult to get by` <- tblFinManage$`Finding it difficult to get by` / tblFinManage$`Total weight`
tblFinManage$`Just getting by` <- tblFinManage$`Just getting by` / tblFinManage$`Total weight`
tblFinManage$`Doing okay` <- tblFinManage$`Doing okay` / tblFinManage$`Total weight`
tblFinManage <- reshape2::melt(data=tblFinManage, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblFinManage$variable <- factor(tblFinManage$variable, levels = c("Finding it difficult to get by", "Just getting by", "Doing okay", "Living comfortably"))
```
#### Figure 18: CA borrowers
##### Responses to "Overall, which one of the following best describes how well you are managing financially these days?"
```{r figure18A}
tblFinManage.CA.Borrow <- tblFinManage %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")
g18A <- ggplot(data=tblFinManage.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g18A, width=800, height=350)
```
#### Figure 18: Rest of U.S. borrowers
##### Responses to "Overall, which one of the following best describes how well you are managing financially these days?"
```{r figure18B}
tblFinManage.US.Borrow <- tblFinManage %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")
g18B <- ggplot(data=tblFinManage.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g18B, width=800, height=350)
```
#### Figure 18: CA non-borrowers
##### Responses to "Overall, which one of the following best describes how well you are managing financially these days?"
```{r figure18C}
tblFinManage.CA.Nonborrow <- tblFinManage %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")
g18C <- ggplot(data=tblFinManage.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g18C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
```{r ParComp}
# ParComp: # Think of your parents when they were your age. Would you say you (and your family) are better, the same, or worse off financially than they were? 

# table(shed$ParComp)
shed.ParComp <- shed %>% filter(is.na(ParComp)==FALSE) %>% filter((ParComp %in% c("Refused")==FALSE)) 
tblParComp <- aggregate(data=shed.ParComp, Weight ~ ParComp + Race + State + AnyStudentLoans, FUN=sum)
tblParComp2 <- aggregate(data=shed.ParComp, Weight ~ ParComp + State + AnyStudentLoans, FUN=sum)
tblParComp2$Race <- rep("All", nrow(tblParComp2))
tblParComp <- rbind(tblParComp, tblParComp2)
tblParComp <- reshape2::dcast(data=tblParComp, Race + State + AnyStudentLoans ~ ParComp, value.var="Weight")
tblParComp$`Total weight` <- tblParComp$`Much better off` + tblParComp$`Somewhat worse off` + tblParComp$`About the same` + tblParComp$`Somewhat better off` + tblParComp$`Much worse off`
tblParComp$`Much better off` <- tblParComp$`Much better off` / tblParComp$`Total weight`
tblParComp$`Somewhat better off` <- tblParComp$`Somewhat better off` / tblParComp$`Total weight`
tblParComp$`About the same` <- tblParComp$`About the same` / tblParComp$`Total weight`
tblParComp$`Somewhat worse off` <- tblParComp$`Somewhat worse off` / tblParComp$`Total weight`
tblParComp$`Much worse off` <- tblParComp$`Much worse off` / tblParComp$`Total weight`
tblParComp <- reshape2::melt(data=tblParComp, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share of borrowers") %>% filter(variable != "Total weight")
tblParComp$variable <- factor(tblParComp$variable, levels = c("Much worse off", "Somewhat worse off", "About the same", "Somewhat better off", "Much better off"))
```
#### Figure 19: CA borrowers
##### Responses to "Think of your parents when they were your age. Would you say you (and your family) are better, the same, or worse off financially than they were?"
```{r figure19A}
tblParComp.CA.Borrow <- tblParComp %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")
g19A <- ggplot(data=tblParComp.CA.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g19A, width=800, height=350)
```
#### Figure 19: Rest of U.S. borrowers
##### Responses to "Think of your parents when they were your age. Would you say you (and your family) are better, the same, or worse off financially than they were?"
```{r figure19B}
tblParComp.US.Borrow <- tblParComp %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")
g19B <- ggplot(data=tblParComp.US.Borrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g19B, width=800, height=350)
```
#### Figure 19: CA non-borrowers
##### Responses to "Think of your parents when they were your age. Would you say you (and your family) are better, the same, or worse off financially than they were?"
```{r figure19C}
tblParComp.CA.Nonborrow <- tblParComp %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")
g19C <- ggplot(data=tblParComp.CA.Nonborrow, mapping=aes(y=Race, x=`Share of borrowers`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g19C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
```{r CreditScore}
# CreditScore: # Where do you think your credit score falls? 

# table(shed$CreditScore)
shed.CreditScore <- shed %>% filter(is.na(CreditScore)==FALSE) %>% filter((CreditScore %in% c("Refused", "", "Don't know")==FALSE)) 
tblCreditScore <- aggregate(data=shed.CreditScore, Weight ~ CreditScore + Race + State + AnyStudentLoans, FUN=sum)
tblCreditScore2 <- aggregate(data=shed.CreditScore, Weight ~ CreditScore + State + AnyStudentLoans, FUN=sum)
tblCreditScore2$Race <- rep("All", nrow(tblCreditScore2))
tblCreditScore <- rbind(tblCreditScore, tblCreditScore2)
tblCreditScore <- reshape2::dcast(data=tblCreditScore, Race + State + AnyStudentLoans ~ CreditScore, value.var="Weight")
tblCreditScore$`Total weight` <- tblCreditScore$`Excellent` + tblCreditScore$`Poor` + tblCreditScore$`Fair` + tblCreditScore$`Good` + tblCreditScore$`Very poor`
tblCreditScore$`Excellent` <- tblCreditScore$`Excellent` / tblCreditScore$`Total weight`
tblCreditScore$`Good` <- tblCreditScore$`Good` / tblCreditScore$`Total weight`
tblCreditScore$`Fair` <- tblCreditScore$`Fair` / tblCreditScore$`Total weight`
tblCreditScore$`Poor` <- tblCreditScore$`Poor` / tblCreditScore$`Total weight`
tblCreditScore$`Very poor` <- tblCreditScore$`Very poor` / tblCreditScore$`Total weight`
tblCreditScore <- reshape2::melt(data=tblCreditScore, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblCreditScore$variable <- factor(tblCreditScore$variable, levels = c("Very poor", "Poor", "Fair", "Good", "Excellent"))
```
#### Figure 20: CA borrowers
##### Responses to "Where do you think your credit score falls?"
```{r Figure20A}
tblCreditScore.CA.Borrow <- tblCreditScore %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")
g20A <- ggplot(data=tblCreditScore.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g20A, width=800, height=350)
```
#### Figure 20: Rest of U.S. borrowers
##### Responses to "Where do you think your credit score falls?"
```{r Figure20B}
tblCreditScore.US.Borrow <- tblCreditScore %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")
g20B <- ggplot(data=tblCreditScore.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g20B, width=800, height=350)
```
#### Figure 20: Non-borrowers
##### Responses to "Where do you think your credit score falls?"
```{r Figure20C}
tblCreditScore.CA.Nonborrow <- tblCreditScore %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")
g20C <- ggplot(data=tblCreditScore.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g20C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
```{r PayBills}
# PayBills: # Which best describes your ability to pay all of your bills in full this month? 

# table(shed$PayBills)
shed.PayBills <- shed %>% filter(is.na(PayBills)==FALSE) %>% filter((PayBills %in% c("Refused")==FALSE)) 
tblPayBills <- aggregate(data=shed.PayBills, Weight ~ PayBills + Race + State + AnyStudentLoans, FUN=sum)
tblPayBills2 <- aggregate(data=shed.PayBills, Weight ~ PayBills + State + AnyStudentLoans, FUN=sum)
tblPayBills2$Race <- rep("All", nrow(tblPayBills2))
tblPayBills <- rbind(tblPayBills, tblPayBills2)
tblPayBills <- reshape2::dcast(data=tblPayBills, Race + State + AnyStudentLoans ~ PayBills, value.var="Weight")
tblPayBills$`Total weight` <- tblPayBills$`I cannot pay some bills or will only make a partial payment on them` + tblPayBills$`I will be able to pay all of my bills in full`
tblPayBills$`I cannot pay some bills or will only make a partial payment on them` <- tblPayBills$`I cannot pay some bills or will only make a partial payment on them` / tblPayBills$`Total weight`
tblPayBills$`I will be able to pay all of my bills in full` <- tblPayBills$`I will be able to pay all of my bills in full` / tblPayBills$`Total weight`
tblPayBills <- reshape2::melt(data=tblPayBills, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblPayBills$variable <- factor(tblPayBills$variable, levels = c("I will be able to pay all of my bills in full", "I cannot pay some bills or will only make a partial payment on them"))
```
#### Figure 21: CA borrowers
##### Responses to "Which best describes your ability to pay all of your bills in full this month?"
```{r figure21A}
tblPayBills.CA.Borrow <- tblPayBills %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")
g21A <- ggplot(data=tblPayBills.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g21A, width=800, height=350)
```
#### Figure 21: Rest of U.S. borrowers
##### Responses to "Which best describes your ability to pay all of your bills in full this month?"
```{r figure21B}
tblPayBills.US.Borrow <- tblPayBills %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")
g21B <- ggplot(data=tblPayBills.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g21B, width=800, height=350)
```
#### Figure 21: CA non-borrowers
##### Responses to "Which best describes your ability to pay all of your bills in full this month?"
```{r figure21C}
tblPayBills.CA.Nonborrow <- tblPayBills %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")
g21C <- ggplot(data=tblPayBills.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g21C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
#### Figure 22: Ability to pay student loan bill
```{r PartialSL}
# PartialSL: # Student loan  Are you expecting to be unable to pay or only make a partial payment on each of the following bills this month? 

# table(shed$PartialSL)
shed.PartialSL <- shed %>% filter((PartialSL %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) %>% filter(SurveyYear %in% c(2015, 2016, 2017, 2018, 2019)) 
tblPartialSL <- aggregate(data=shed.PartialSL, Weight ~ PartialSL + Race + State + AnyStudentLoans, FUN=sum)
tblPartialSL2 <- aggregate(data=shed.PartialSL, Weight ~ PartialSL + State + AnyStudentLoans, FUN=sum)
tblPartialSL2$Race <- rep("All", nrow(tblPartialSL2))
tblPartialSL <- rbind(tblPartialSL, tblPartialSL2)
tblPartialSL <- reshape2::dcast(data=tblPartialSL, Race + State + AnyStudentLoans ~ PartialSL, value.var="Weight")
tblPartialSL$`Share of borrowers expecting to be unable to fully pay their student loan bill this month` <- tblPartialSL$Yes / (tblPartialSL$Yes + tblPartialSL$No)
tblPartialSL$Group <- rep(NA, nrow(tblPartialSL))
tblPartialSL$Group[tblPartialSL$State=="CA" & tblPartialSL$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblPartialSL$Group[tblPartialSL$State=="Rest of U.S." & tblPartialSL$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblPartialSL <- tblPartialSL %>% filter(is.na(Group)==FALSE)
tblPartialSL$Group <- factor(tblPartialSL$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Are you expecting to be unable to pay or only make a partial payment on your student loan bill this month?"
```{r figure22A}
g22A <- ggplot(data=tblPartialSL, mapping=aes(y=Race, x=`Share of borrowers expecting to be unable to fully pay their student loan bill this month`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who expect to be unable to pay their student loan bill this month") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g22A, width=800, height=350)
```
#### Figure 22: Ability to pay rent or mortgage bill
```{r PartialRent}
# PartialRent: # Rent or mortgage  Are you expecting to be unable to pay or only make a partial payment on each of the following bills this month? 

# table(shed$PartialRent)
shed.PartialRent <- shed %>% filter((PartialRent %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblPartialRent <- aggregate(data=shed.PartialRent, Weight ~ PartialRent + Race + State + AnyStudentLoans, FUN=sum)
tblPartialRent2 <- aggregate(data=shed.PartialRent, Weight ~ PartialRent + State + AnyStudentLoans, FUN=sum)
tblPartialRent2$Race <- rep("All", nrow(tblPartialRent2))
tblPartialRent <- rbind(tblPartialRent, tblPartialRent2)
tblPartialRent <- reshape2::dcast(data=tblPartialRent, Race + State + AnyStudentLoans ~ PartialRent, value.var="Weight")
tblPartialRent$`Share of borrowers expecting to be unable to fully pay their rent this month` <- tblPartialRent$Yes / (tblPartialRent$Yes + tblPartialRent$No)
tblPartialRent$Group <- rep(NA, nrow(tblPartialRent))
tblPartialRent$Group[tblPartialRent$State=="CA" & tblPartialRent$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblPartialRent$Group[tblPartialRent$State=="Rest of U.S." & tblPartialRent$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblPartialRent$Group[tblPartialRent$State=="CA" & tblPartialRent$AnyStudentLoans=="No"] <- "California non-borrowers"
tblPartialRent <- tblPartialRent %>% filter(is.na(Group)==FALSE)
tblPartialSL$Group <- factor(tblPartialSL$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Are you expecting to be unable to pay or only make a partial payment on each of the following bills this month?"
```{r figure22B}
g22B <- ggplot(data=tblPartialRent, mapping=aes(y=Race, x=`Share of borrowers expecting to be unable to fully pay their rent this month`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who expect to be unable to pay their rent or mortgage bill this month") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g22B, width=800, height=350)
```
#### Figure 22: Ability to pay credit card bill
```{r PartialCC}
# PartialCC: # Credit card  Are you expecting to be unable to pay or only make a partial payment on each of the following bills this month?

# table(shed$PartialCC)
shed.PartialCC <- shed %>% filter((PartialCC %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblPartialCC <- aggregate(data=shed.PartialCC, Weight ~ PartialCC + Race + State + AnyStudentLoans, FUN=sum)
tblPartialCC2 <- aggregate(data=shed.PartialCC, Weight ~ PartialCC + State + AnyStudentLoans, FUN=sum)
tblPartialCC2$Race <- rep("All", nrow(tblPartialCC2))
tblPartialCC <- rbind(tblPartialCC, tblPartialCC2)
tblPartialCC <- reshape2::dcast(data=tblPartialCC, Race + State + AnyStudentLoans~ PartialCC, value.var="Weight")
tblPartialCC$`Share of borrowers expecting to be unable to fully pay their credit card bill this month` <- tblPartialCC$Yes / (tblPartialCC$Yes + tblPartialCC$No)
tblPartialCC$Group <- rep(NA, nrow(tblPartialCC))
tblPartialCC$Group[tblPartialCC$State=="CA" & tblPartialCC$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblPartialCC$Group[tblPartialCC$State=="Rest of U.S." & tblPartialCC$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblPartialCC$Group[tblPartialCC$State=="CA" & tblPartialCC$AnyStudentLoans=="No"] <- "California non-borrowers"
tblPartialCC <- tblPartialCC %>% filter(is.na(Group)==FALSE)
tblPartialSL$Group <- factor(tblPartialSL$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to 
```{r figure22C}
g22C <- ggplot(data=tblPartialCC, mapping=aes(y=Race, x=`Share of borrowers expecting to be unable to fully pay their credit card bill this month`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who expect to be unable to pay their credit card bill this month") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g22C, width=800, height=350)
```
#### Data source and notes

Survey years 2020 and 2021 not included in "Figure 22: Ability to pay student loan bill" due to the federal student loan repayment pause. 
***

### {-}

xxx 

### {.tabset}
```{r PartialSL400}
# PartialSL400: # Student loan  Which of the following bills would you likely skip paying, or make only a partial payment on, if you had a $400 emergency expense that you had to pay?

# table(shed$PartialSL400)
shed.PartialSL400 <- shed %>% filter((PartialSL400 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) %>% filter(SurveyYear %in% c(2015, 2016, 2017, 2018, 2019)) 
tblPartialSL400 <- aggregate(data=shed.PartialSL400, Weight ~ PartialSL400 + Race + State, FUN=sum)
tblPartialSL4002 <- aggregate(data=shed.PartialSL400, Weight ~ PartialSL400 + State, FUN=sum)
tblPartialSL4002$Race <- rep("All", nrow(tblPartialSL4002))
tblPartialSL400 <- rbind(tblPartialSL400, tblPartialSL4002)
tblPartialSL400 <- reshape2::dcast(data=tblPartialSL400, Race + State ~ PartialSL400, value.var="Weight")
tblPartialSL400$`Share of borrowers who would skip paying, or make only a partial payment on, their student loan bill if they had a $400 emergency expense` <- tblPartialSL400$Yes / (tblPartialSL400$Yes + tblPartialSL400$No)
```
#### Figure 23
##### Responses to "Would you likely skip paying, or make only a partial payment on, your student loan bill if you had a $400 emergency expense that you had to pay?"
```{r figure23}
g23 <- ggplot(data=tblPartialSL400, mapping=aes(y=Race, x=`Share of borrowers who would skip paying, or make only a partial payment on, their student loan bill if they had a $400 emergency expense`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(y="", title="", x="Share of borrowers who would not fully pay student loan bill") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2")

ggplotly(g23, height=350)
```
#### Data source and notes
Limited to those who have student loans. 
Survey years 2020 and 2021 not included.
***
### {-}

xxx 

### {.tabset}
```{r PayBills400}
# PayBills400: # How would a $400 emergency expense that you had to pay impact your ability to pay your other bills this month? 

# table(shed$PayBills400)
shed.PayBills400 <- shed %>% filter(is.na(PayBills400)==FALSE) %>% filter((PayBills400 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblPayBills400 <- aggregate(data=shed.PayBills400, Weight ~ PayBills400 + Race + State + AnyStudentLoans, FUN=sum)
tblPayBills4002 <- aggregate(data=shed.PayBills400, Weight ~ PayBills400 + State + AnyStudentLoans, FUN=sum)
tblPayBills4002$Race <- rep("All", nrow(tblPayBills4002))
tblPayBills400 <- rbind(tblPayBills400, tblPayBills4002)
tblPayBills400 <- reshape2::dcast(data=tblPayBills400, Race + State + AnyStudentLoans ~ PayBills400, value.var="Weight")
tblPayBills400$`Total weight` <- tblPayBills400$`I could not pay some other bills or would only make a partial payment on some of them` + tblPayBills400$`I would still be able to pay all of my other bills in full`
tblPayBills400$`I could not pay some other bills or would only make a partial payment on some of them` <- tblPayBills400$`I could not pay some other bills or would only make a partial payment on some of them` / tblPayBills400$`Total weight`
tblPayBills400$`I would still be able to pay all of my other bills in full` <- tblPayBills400$`I would still be able to pay all of my other bills in full` / tblPayBills400$`Total weight`
tblPayBills400 <- reshape2::melt(data=tblPayBills400, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblPayBills400$variable <- as.character(tblPayBills400$variable)
tblPayBills400$variable[tblPayBills400$variable=="I could not pay some other bills or would only make a partial payment on some of them"] <- "I could not fully pay some bills"
tblPayBills400$variable <- factor(tblPayBills400$variable, levels = c("I would still be able to pay all of my other bills in full", "I could not fully pay some bills"))
```
#### Figure 24: CA borrowers
##### Responses to "How would a $400 emergency expense that you had to pay impact your ability to pay your other bills this month?"
```{r figure24A}
tblPayBills400.CA.Borrow <- tblPayBills400 %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")
g24A <- ggplot(data=tblPayBills400.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g24A, width=800, height=350)
```
#### Figure 24: Rest of U.S. borrowers
##### Responses to "How would a $400 emergency expense that you had to pay impact your ability to pay your other bills this month?"
```{r figure24B}
tblPayBills400.US.Borrow <- tblPayBills400 %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")
g24B <- ggplot(data=tblPayBills400.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g24B, width=800, height=350)
```
#### Figure 24: CA non-borrowers
##### Responses to "How would a $400 emergency expense that you had to pay impact your ability to pay your other bills this month?"
```{r figure24C}
tblPayBills400.CA.Nonborrow <- tblPayBills400 %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")
g24C <- ggplot(data=tblPayBills400.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g24C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
```{r CCApprov}
# CCApprov: # If you were to apply for a credit card today, how confident are you that you would be approved? 

# table(shed$CCApprov)
shed.CCApprov <- shed %>% filter(is.na(CCApprov)==FALSE) %>% filter((CCApprov %in% c("Refused", "Not In Universe (not asked)", "Don't know", "")==FALSE)) 
tblCCApprov <- aggregate(data=shed.CCApprov, Weight ~ CCApprov + Race + State + AnyStudentLoans, FUN=sum)
tblCCApprov2 <- aggregate(data=shed.CCApprov, Weight ~ CCApprov + State + AnyStudentLoans, FUN=sum)
tblCCApprov2$Race <- rep("All", nrow(tblCCApprov2))
tblCCApprov <- rbind(tblCCApprov, tblCCApprov2)
tblCCApprov <- reshape2::dcast(data=tblCCApprov, Race + State + AnyStudentLoans ~ CCApprov, value.var="Weight")
tblCCApprov$`Total weight` <- tblCCApprov$`Not confident` + tblCCApprov$`Somewhat confident` +  tblCCApprov$`Very confident`
tblCCApprov$`Not confident` <- tblCCApprov$`Not confident` / tblCCApprov$`Total weight`
tblCCApprov$`Somewhat confident` <- tblCCApprov$`Somewhat confident` / tblCCApprov$`Total weight`
tblCCApprov$`Very confident` <- tblCCApprov$`Very confident` / tblCCApprov$`Total weight`
tblCCApprov <- reshape2::melt(data=tblCCApprov, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblCCApprov$variable <- factor(tblCCApprov$variable, levels = c("Very confident", "Somewhat confident", "Not confident"))
```
#### Figure 25: CA borrowers
##### Responses to "If you were to apply for a credit card today, how confident are you that you would be approved?"
```{r figure25A}
tblCCApprov.CA.Borrow <- tblCCApprov %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")
g25A <- ggplot(data=tblCCApprov.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g25A, width=800, height=350)
```
#### Figure 25: Rest of U.S. borrowers
##### Responses to "If you were to apply for a credit card today, how confident are you that you would be approved?"
```{r figure25B}
tblCCApprov.US.Borrow <- tblCCApprov %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")
g25B <- ggplot(data=tblCCApprov.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g25B, width=800, height=350)
```
#### Figure 25: CA non-borrowers
##### Responses to "If you were to apply for a credit card today, how confident are you that you would be approved?"
```{r figure25C}
tblCCApprov.CA.Nonborrow <- tblCCApprov %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")
g25C <- ggplot(data=tblCCApprov.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Set2") 

ggplotly(g25C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
```{r CreditDeny}
# CreditDeny: # Turned down for credit  In the past 12 months, has each of the following happened to you or your spouse/partner: 

# table(shed$CreditDeny)
shed.CreditDeny <- shed %>% filter((CreditDeny %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblCreditDeny <- aggregate(data=shed.CreditDeny, Weight ~ CreditDeny + Race + State + AnyStudentLoans, FUN=sum)
tblCreditDeny2 <- aggregate(data=shed.CreditDeny, Weight ~ CreditDeny + State + AnyStudentLoans, FUN=sum)
tblCreditDeny2$Race <- rep("All", nrow(tblCreditDeny2))
tblCreditDeny <- rbind(tblCreditDeny, tblCreditDeny2)
tblCreditDeny <- reshape2::dcast(data=tblCreditDeny, Race + State + AnyStudentLoans ~ CreditDeny, value.var="Weight")
tblCreditDeny$`Share of borrowers who were turned down for credit in the past 12 months` <- tblCreditDeny$Yes / (tblCreditDeny$Yes + tblCreditDeny$No)
tblCreditDeny$Group <- rep(NA, nrow(tblCreditDeny))
tblCreditDeny$Group[tblCreditDeny$State=="CA" & tblCreditDeny$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblCreditDeny$Group[tblCreditDeny$State=="Rest of U.S." & tblCreditDeny$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblCreditDeny$Group[tblCreditDeny$State=="CA" & tblCreditDeny$AnyStudentLoans=="No"] <- "California non-borrowers"
tblCreditDeny <- tblCreditDeny %>% filter(is.na(Group)==FALSE)
tblCreditDeny$Group <- factor(tblCreditDeny$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
#### Figure 26
##### Responses to "In the past 12 months, have you or your spouse/partner been turned down for credit?"
```{r figure26A}
g26 <- ggplot(data=tblCreditDeny, mapping=aes(y=Race, x=`Share of borrowers who were turned down for credit in the past 12 months`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who were turned down for credit in the past 12 months") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g26, width=800, height=350)
```
#### Data source and notes
***
### {-}

Add a lot of caveats before this next section. 

### {.tabset}
#### Figure 27: Social Security
```{r SocSec}
# SocSec: # Social Security (including old age and DI) -In the past 12 months, did you [and/or your spouse/parnter] receive any income from the following sources:

# table(shed$SocSec)
shed.SocSec <- shed %>% filter((SocSec %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblSocSec <- aggregate(data=shed.SocSec, Weight ~ SocSec + Race + State + AnyStudentLoans, FUN=sum)
tblSocSec2 <- aggregate(data=shed.SocSec, Weight ~ SocSec + State + AnyStudentLoans, FUN=sum)
tblSocSec2$Race <- rep("All", nrow(tblSocSec2))
tblSocSec <- rbind(tblSocSec, tblSocSec2)
tblSocSec <- reshape2::dcast(data=tblSocSec, Race + State + AnyStudentLoans ~ SocSec, value.var="Weight")
tblSocSec$`Share` <- tblSocSec$Yes / (tblSocSec$Yes + tblSocSec$No)
tblSocSec$Group <- rep(NA, nrow(tblSocSec))
tblSocSec$Group[tblSocSec$State=="CA" & tblSocSec$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblSocSec$Group[tblSocSec$State=="Rest of U.S." & tblSocSec$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblSocSec$Group[tblSocSec$State=="CA" & tblSocSec$AnyStudentLoans=="No"] <- "California non-borrowers"
tblSocSec <- tblSocSec %>% filter(is.na(Group)==FALSE)
tblSocSec$Group <- factor(tblSocSec$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "In the past 12 months, have you [and/or your spouse/ parnter] received Social Security (including old age and DI)?"
```{r figure27A}
g27A <- ggplot(data=tblSocSec, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who received Social Security") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g27A, width=800, height=350)
```
#### Figure 27: Cash assistance
```{r Welfare}
# Welfare: # Supplemental Security Income (SSI), TANF, or cash assistance from a welfare program - In the past 12 months, did you [and/or your spouse/parnter] receive any income from the following sources: 

# table(shed$Welfare)
shed.Welfare <- shed %>% filter((Welfare %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblWelfare <- aggregate(data=shed.Welfare, Weight ~ Welfare + Race + State + AnyStudentLoans, FUN=sum)
tblWelfare2 <- aggregate(data=shed.Welfare, Weight ~ Welfare + State + AnyStudentLoans, FUN=sum)
tblWelfare2$Race <- rep("All", nrow(tblWelfare2))
tblWelfare <- rbind(tblWelfare, tblWelfare2)
tblWelfare <- reshape2::dcast(data=tblWelfare, Race + State + AnyStudentLoans ~ Welfare, value.var="Weight")
tblWelfare$`Share` <- tblWelfare$Yes / (tblWelfare$Yes + tblWelfare$No)
tblWelfare$Group <- rep(NA, nrow(tblWelfare))
tblWelfare$Group[tblWelfare$State=="CA" & tblWelfare$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblWelfare$Group[tblWelfare$State=="Rest of U.S." & tblWelfare$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblWelfare$Group[tblWelfare$State=="CA" & tblWelfare$AnyStudentLoans=="No"] <- "California non-borrowers"
tblWelfare <- tblWelfare %>% filter(is.na(Group)==FALSE)
tblWelfare$Group <- factor(tblWelfare$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "In the past 12 months, have you [and/or your spouse/ parnter] received Supplemental Security Income (SSI), TANF, or cash assistance from a welfare program?"
```{r figure27B}
g27B <- ggplot(data=tblWelfare, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who received cash assistance (TANF, SSI, etc.)") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g27B, width=800, height=350)
```
#### Figure 27: EITC
```{r EITC}
# EITC: # Earned Income Tax Credit (EITC) - In the past 12 months, have you [and/or your spouse/parnter] received any of the following?

# table(shed$EITC)
shed.EITC <- shed %>% filter((EITC %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblEITC <- aggregate(data=shed.EITC, Weight ~ EITC + Race + State + AnyStudentLoans, FUN=sum)
tblEITC2 <- aggregate(data=shed.EITC, Weight ~ EITC + State + AnyStudentLoans, FUN=sum)
tblEITC2$Race <- rep("All", nrow(tblEITC2))
tblEITC <- rbind(tblEITC, tblEITC2)
tblEITC <- reshape2::dcast(data=tblEITC, Race + State + AnyStudentLoans ~ EITC, value.var="Weight")
tblEITC$`Share` <- tblEITC$Yes / (tblEITC$Yes + tblEITC$No)
tblEITC$Group <- rep(NA, nrow(tblEITC))
tblEITC$Group[tblEITC$State=="CA" & tblEITC$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblEITC$Group[tblEITC$State=="Rest of U.S." & tblEITC$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblEITC$Group[tblEITC$State=="CA" & tblEITC$AnyStudentLoans=="No"] <- "California non-borrowers"
tblEITC <- tblEITC %>% filter(is.na(Group)==FALSE)
tblEITC$Group <- factor(tblEITC$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "In the past 12 months, have you [and/or your spouse/ parnter] received the Earned Income Tax Credit (EITC)?"
```{r figure27C}
g27C <- ggplot(data=tblEITC, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who received the Earned Income Tax Credit") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g27C, width=800, height=350)
```
#### Figure 27: SNAP
```{r SNAP}
# SNAP: # Supplemental Nutrition Assistance Program (SNAP or food stamps) - In the past 12 months, have you [and/or your spouse/parnter] received any of the following? 

# table(shed$SNAP)
shed.SNAP <- shed %>% filter((SNAP %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblSNAP <- aggregate(data=shed.SNAP, Weight ~ SNAP + Race + State + AnyStudentLoans, FUN=sum)
tblSNAP2 <- aggregate(data=shed.SNAP, Weight ~ SNAP + State + AnyStudentLoans, FUN=sum)
tblSNAP2$Race <- rep("All", nrow(tblSNAP2))
tblSNAP <- rbind(tblSNAP, tblSNAP2)
tblSNAP <- reshape2::dcast(data=tblSNAP, Race + State + AnyStudentLoans ~ SNAP, value.var="Weight")
tblSNAP$`Share` <- tblSNAP$Yes / (tblSNAP$Yes + tblSNAP$No)
tblSNAP$Group <- rep(NA, nrow(tblSNAP))
tblSNAP$Group[tblSNAP$State=="CA" & tblSNAP$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblSNAP$Group[tblSNAP$State=="Rest of U.S." & tblSNAP$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblSNAP$Group[tblSNAP$State=="CA" & tblSNAP$AnyStudentLoans=="No"] <- "California non-borrowers"
tblSNAP <- tblSNAP %>% filter(is.na(Group)==FALSE)
tblSNAP$Group <- factor(tblSNAP$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "In the past 12 months, have you [and/or your spouse/ parnter] received Supplemental Nutrition Assistance Program (SNAP or food stamps)?"
```{r figure27D}
g27D <- ggplot(data=tblSNAP, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who received SNAP") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g27D, width=800, height=350)
```
#### Figure 27: Housing assistance
```{r HouseAssit}
# HouseAssist: # Housing assistance from government program - In the past 12 months, have you [and/or your spouse/parnter] received any of the following? 

# table(shed$HouseAssist)
shed.HouseAssist <- shed %>% filter((HouseAssist %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblHouseAssist <- aggregate(data=shed.HouseAssist, Weight ~ HouseAssist + Race + State + AnyStudentLoans, FUN=sum)
tblHouseAssist2 <- aggregate(data=shed.HouseAssist, Weight ~ HouseAssist + State + AnyStudentLoans, FUN=sum)
tblHouseAssist2$Race <- rep("All", nrow(tblHouseAssist2))
tblHouseAssist <- rbind(tblHouseAssist, tblHouseAssist2)
tblHouseAssist <- reshape2::dcast(data=tblHouseAssist, Race + State + AnyStudentLoans ~ HouseAssist, value.var="Weight")
tblHouseAssist$`Share` <- tblHouseAssist$Yes / (tblHouseAssist$Yes + tblHouseAssist$No)
tblHouseAssist$Group <- rep(NA, nrow(tblHouseAssist))
tblHouseAssist$Group[tblHouseAssist$State=="CA" & tblHouseAssist$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblHouseAssist$Group[tblHouseAssist$State=="Rest of U.S." & tblHouseAssist$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblHouseAssist$Group[tblHouseAssist$State=="CA" & tblHouseAssist$AnyStudentLoans=="No"] <- "California non-borrowers"
tblHouseAssist <- tblHouseAssist %>% filter(is.na(Group)==FALSE)
tblHouseAssist$Group <- factor(tblHouseAssist$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "In the past 12 months, have you [and/or your spouse/ parnter] received housing assistance from a government program?"
```{r figure27E}
g27E <- ggplot(data=tblHouseAssist, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who received housing assistance") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g27E, width=800, height=350)
```
#### Figure 27: FRPL
```{r FRPL}
# FRPL: # Free or reduced price school lunches - In the past 12 months, have you [and/or your spouse/ parnter] received any of the following? 

# table(shed$FRPL)
shed.FRPL <- shed %>% filter((FRPL %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) %>% filter(ChildrenUnder18=="Yes")
tblFRPL <- aggregate(data=shed.FRPL, Weight ~ FRPL + Race + State + AnyStudentLoans, FUN=sum)
tblFRPL2 <- aggregate(data=shed.FRPL, Weight ~ FRPL + State + AnyStudentLoans, FUN=sum)
tblFRPL2$Race <- rep("All", nrow(tblFRPL2))
tblFRPL <- rbind(tblFRPL, tblFRPL2)
tblFRPL <- reshape2::dcast(data=tblFRPL, Race + State + AnyStudentLoans ~ FRPL, value.var="Weight")
tblFRPL$`Share` <- tblFRPL$Yes / (tblFRPL$Yes + tblFRPL$No)
tblFRPL$Group <- rep(NA, nrow(tblFRPL))
tblFRPL$Group[tblFRPL$State=="CA" & tblFRPL$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblFRPL$Group[tblFRPL$State=="Rest of U.S." & tblFRPL$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblFRPL$Group[tblFRPL$State=="CA" & tblFRPL$AnyStudentLoans=="No"] <- "California non-borrowers"
tblFRPL <- tblFRPL %>% filter(is.na(Group)==FALSE)
tblFRPL$Group <- factor(tblFRPL$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "In the past 12 months, have you [and/or your spouse/ parnter] received free or reduced price school lunches?"
```{r figure27F}
g27F <- ggplot(data=tblFRPL, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who received free or reduced price lunch") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g27F, width=800, height=350)
```
#### Data source and notes
***
### {-}

It's weird that the "Cover expenses with savings" bars are lower than the "Cover expenses by any means" bars. 

### {.tabset}
#### Figure 28: Cover expenses with savings
```{r ThreeMonSave}
# ThreeMonSave: # Have you set aside emergency or rainy day funds that would cover your expenses for 3 months in case of sickness, job loss, economic downturn, or other emergencies? 

# table(shed$ThreeMonSave)
shed.ThreeMonSave <- shed %>% filter((ThreeMonSave %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblThreeMonSave <- aggregate(data=shed.ThreeMonSave, Weight ~ ThreeMonSave + Race + State + AnyStudentLoans, FUN=sum)
tblThreeMonSave2 <- aggregate(data=shed.ThreeMonSave, Weight ~ ThreeMonSave + State + AnyStudentLoans, FUN=sum)
tblThreeMonSave2$Race <- rep("All", nrow(tblThreeMonSave2))
tblThreeMonSave <- rbind(tblThreeMonSave, tblThreeMonSave2)
tblThreeMonSave <- reshape2::dcast(data=tblThreeMonSave, Race + State + AnyStudentLoans ~ ThreeMonSave, value.var="Weight")
tblThreeMonSave$`Share` <- tblThreeMonSave$Yes / (tblThreeMonSave$Yes + tblThreeMonSave$No)
tblThreeMonSave$Group <- rep(NA, nrow(tblThreeMonSave))
tblThreeMonSave$Group[tblThreeMonSave$State=="CA" & tblThreeMonSave$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblThreeMonSave$Group[tblThreeMonSave$State=="Rest of U.S." & tblThreeMonSave$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblThreeMonSave$Group[tblThreeMonSave$State=="CA" & tblThreeMonSave$AnyStudentLoans=="No"] <- "California non-borrowers"
tblThreeMonSave <- tblThreeMonSave %>% filter(is.na(Group)==FALSE)
tblThreeMonSave$Group <- factor(tblThreeMonSave$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Have you set aside emergency or rainy day funds that would cover your expenses for 3 months in case of sickness, job loss, economic downturn, or other emergencies?"
```{r figure28A}
g28A <- ggplot(data=tblThreeMonSave, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share with sufficient funds set aside") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g28A, width=800, height=350)
```
#### Figure 28: Cover expenses by any means
```{r ThreeMonCover}
# ThreeMonCover: # If you were to lose your main source of income (for example, job or government benefits), could you cover your expenses for 3 months by borrowing money, using savings, or selling assets?

# table(shed$ThreeMonCover)
shed.ThreeMonCover <- shed %>% filter((ThreeMonCover %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblThreeMonCover <- aggregate(data=shed.ThreeMonCover, Weight ~ ThreeMonCover + Race + State + AnyStudentLoans, FUN=sum)
tblThreeMonCover2 <- aggregate(data=shed.ThreeMonCover, Weight ~ ThreeMonCover + State + AnyStudentLoans, FUN=sum)
tblThreeMonCover2$Race <- rep("All", nrow(tblThreeMonCover2))
tblThreeMonCover <- rbind(tblThreeMonCover, tblThreeMonCover2)
tblThreeMonCover <- reshape2::dcast(data=tblThreeMonCover, Race + State + AnyStudentLoans ~ ThreeMonCover, value.var="Weight")
tblThreeMonCover$`Share` <- tblThreeMonCover$Yes / (tblThreeMonCover$Yes + tblThreeMonCover$No)
tblThreeMonCover$Group <- rep(NA, nrow(tblThreeMonCover))
tblThreeMonCover$Group[tblThreeMonCover$State=="CA" & tblThreeMonCover$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblThreeMonCover$Group[tblThreeMonCover$State=="Rest of U.S." & tblThreeMonCover$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblThreeMonCover$Group[tblThreeMonCover$State=="CA" & tblThreeMonCover$AnyStudentLoans=="No"] <- "California non-borrowers"
tblThreeMonCover <- tblThreeMonCover %>% filter(is.na(Group)==FALSE)
tblThreeMonCover$Group <- factor(tblThreeMonCover$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "If you were to lose your main source of income (for example, job or government benefits), could you cover your expenses for 3 months by borrowing money, using savings, or selling assets?" 
```{r figure28B}
g28B <- ggplot(data=tblThreeMonCover, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who could cover three months' expenses") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g28B, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
#### Figure 29: Pay $400 with credit card (no interest)
```{r CCA400}
# CCA400: # Put it on my credit card and pay it off in full at the next statement  Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? 

# table(shed$CCA400)
shed.CCA400 <- shed %>% filter((CCA400 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblCCA400 <- aggregate(data=shed.CCA400, Weight ~ CCA400 + Race + State + AnyStudentLoans, FUN=sum)
tblCCA4002 <- aggregate(data=shed.CCA400, Weight ~ CCA400 + State + AnyStudentLoans, FUN=sum)
tblCCA4002$Race <- rep("All", nrow(tblCCA4002))
tblCCA400 <- rbind(tblCCA400, tblCCA4002)
tblCCA400 <- reshape2::dcast(data=tblCCA400, Race + State + AnyStudentLoans ~ CCA400, value.var="Weight")
tblCCA400$`Share` <- tblCCA400$Yes / (tblCCA400$Yes + tblCCA400$No)

tblCCA400$Group <- rep(NA, nrow(tblCCA400))
tblCCA400$Group[tblCCA400$State=="CA" & tblCCA400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblCCA400$Group[tblCCA400$State=="Rest of U.S." & tblCCA400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblCCA400$Group[tblCCA400$State=="CA" & tblCCA400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblCCA400 <- tblCCA400 %>% filter(is.na(Group)==FALSE)
tblCCA400$Group <- factor(tblCCA400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [Put it on my credit card and pay it off in full at the next statement]"
```{r figure29A}
g29A <- ggplot(data=tblCCA400, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would put it on a credit card and pay it off immediately") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g29A, width=800, height=350)
```
#### Figure 29: Pay $400 with credit card (with interest)
```{r CCB400}
# CCB400: # Put it on my credit card and pay it off over time  Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense?

# table(shed$CCB400)
shed.CCB400 <- shed %>% filter((CCB400 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblCCB400 <- aggregate(data=shed.CCB400, Weight ~ CCB400 + Race + State + AnyStudentLoans, FUN=sum)
tblCCB4002 <- aggregate(data=shed.CCB400, Weight ~ CCB400 + State + AnyStudentLoans, FUN=sum)
tblCCB4002$Race <- rep("All", nrow(tblCCB4002))
tblCCB400 <- rbind(tblCCB400, tblCCB4002)
tblCCB400 <- reshape2::dcast(data=tblCCB400, Race + State + AnyStudentLoans ~ CCB400, value.var="Weight")
tblCCB400$`Share` <- tblCCB400$Yes / (tblCCB400$Yes + tblCCB400$No)

tblCCB400$Group <- rep(NA, nrow(tblCCB400))
tblCCB400$Group[tblCCB400$State=="CA" & tblCCB400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblCCB400$Group[tblCCB400$State=="Rest of U.S." & tblCCB400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblCCB400$Group[tblCCB400$State=="CA" & tblCCB400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblCCB400 <- tblCCB400 %>% filter(is.na(Group)==FALSE)
tblCCB400$Group <- factor(tblCCB400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [Put it on my credit card and pay it off over time]"
```{r figure29B}
g29B <- ggplot(data=tblCCB400, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would put it on a credit card and pay it off over time") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g29B, width=800, height=350)
```
#### Figure 29: Pay $400 with cash or savings
```{r Cash400}
# Cash400: # With the money currently in my checking/savings account or with cash  Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? 

# table(shed$Cash400)
shed.Cash400 <- shed %>% filter((Cash400 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblCash400 <- aggregate(data=shed.Cash400, Weight ~ Cash400 + Race + State + AnyStudentLoans, FUN=sum)
tblCash4002 <- aggregate(data=shed.Cash400, Weight ~ Cash400 + State + AnyStudentLoans, FUN=sum)
tblCash4002$Race <- rep("All", nrow(tblCash4002))
tblCash400 <- rbind(tblCash400, tblCash4002)
tblCash400 <- reshape2::dcast(data=tblCash400, Race + State + AnyStudentLoans ~ Cash400, value.var="Weight")
tblCash400$`Share` <- tblCash400$Yes / (tblCash400$Yes + tblCash400$No)

tblCash400$Group <- rep(NA, nrow(tblCash400))
tblCash400$Group[tblCash400$State=="CA" & tblCash400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblCash400$Group[tblCash400$State=="Rest of U.S." & tblCash400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblCash400$Group[tblCash400$State=="CA" & tblCash400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblCash400 <- tblCash400 %>% filter(is.na(Group)==FALSE)
tblCash400$Group <- factor(tblCash400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [With the money currently in my checking/savings account or with cash]"
```{r figure29C}
g29C <- ggplot(data=tblCash400, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would pay with cash or money in checking or savings") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g29C, width=800, height=350)
```
#### Figure 29: Pay $400 with a bank loan
```{r Loan400}
# Loan400: #  Using money from a bank loan or line of credit  Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense?

# table(shed$Loan400)
shed.Loan400 <- shed %>% filter((Loan400 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblLoan400 <- aggregate(data=shed.Loan400, Weight ~ Loan400 + Race + State + AnyStudentLoans, FUN=sum)
tblLoan4002 <- aggregate(data=shed.Loan400, Weight ~ Loan400 + State + AnyStudentLoans, FUN=sum)
tblLoan4002$Race <- rep("All", nrow(tblLoan4002))
tblLoan400 <- rbind(tblLoan400, tblLoan4002)
tblLoan400 <- reshape2::dcast(data=tblLoan400, Race + State + AnyStudentLoans ~ Loan400, value.var="Weight")
tblLoan400$`Share` <- tblLoan400$Yes / (tblLoan400$Yes + tblLoan400$No)

tblLoan400$Group <- rep(NA, nrow(tblLoan400))
tblLoan400$Group[tblLoan400$State=="CA" & tblLoan400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblLoan400$Group[tblLoan400$State=="Rest of U.S." & tblLoan400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblLoan400$Group[tblLoan400$State=="CA" & tblLoan400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblLoan400 <- tblLoan400 %>% filter(is.na(Group)==FALSE)
tblLoan400$Group <- factor(tblLoan400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [Using money from a bank loan or line of credit]"
```{r figure29D}
g29D <- ggplot(data=tblLoan400, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would pay with a bank loan") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g29D, width=800, height=350)
```
#### Figure 29: Pay $400 by borrowing from a friend
```{r Friend400}
# Friend400: # By borrowing from a friend or family member  Suppose that you have an emergency that costs $400. Based on your current financial situation, how would you pay for this expense?

# table(shed$Friend400)
shed.Friend400 <- shed %>% filter((Friend400 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblFriend400 <- aggregate(data=shed.Friend400, Weight ~ Friend400 + Race + State + AnyStudentLoans, FUN=sum)
tblFriend4002 <- aggregate(data=shed.Friend400, Weight ~ Friend400 + State + AnyStudentLoans, FUN=sum)
tblFriend4002$Race <- rep("All", nrow(tblFriend4002))
tblFriend400 <- rbind(tblFriend400, tblFriend4002)
tblFriend400 <- reshape2::dcast(data=tblFriend400, Race + State + AnyStudentLoans ~ Friend400, value.var="Weight")
tblFriend400$`Share` <- tblFriend400$Yes / (tblFriend400$Yes + tblFriend400$No)

tblFriend400$Group <- rep(NA, nrow(tblFriend400))
tblFriend400$Group[tblFriend400$State=="CA" & tblFriend400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblFriend400$Group[tblFriend400$State=="Rest of U.S." & tblFriend400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblFriend400$Group[tblFriend400$State=="CA" & tblFriend400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblFriend400 <- tblFriend400 %>% filter(is.na(Group)==FALSE)
tblFriend400$Group <- factor(tblFriend400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [By borrowing from a friend or family member]"
```{r figure29E}
g29E <- ggplot(data=tblFriend400, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would borrow from family or a friend") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g29E, width=800, height=350)
```
#### Figure 29: Pay $400 with a payday loan
```{r Payday400}
# Payday400: # Using a payday loan, deposit advance, or overdraft  Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense?

# table(shed$Payday400)
shed.Payday400 <- shed %>% filter((Payday400 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblPayday400 <- aggregate(data=shed.Payday400, Weight ~ Payday400 + Race + State + AnyStudentLoans, FUN=sum)
tblPayday4002 <- aggregate(data=shed.Payday400, Weight ~ Payday400 + State + AnyStudentLoans, FUN=sum)
tblPayday4002$Race <- rep("All", nrow(tblPayday4002))
tblPayday400 <- rbind(tblPayday400, tblPayday4002)
tblPayday400 <- reshape2::dcast(data=tblPayday400, Race + State + AnyStudentLoans ~ Payday400, value.var="Weight")
tblPayday400$`Share` <- tblPayday400$Yes / (tblPayday400$Yes + tblPayday400$No)

tblPayday400$Group <- rep(NA, nrow(tblPayday400))
tblPayday400$Group[tblPayday400$State=="CA" & tblPayday400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblPayday400$Group[tblPayday400$State=="Rest of U.S." & tblPayday400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblPayday400$Group[tblPayday400$State=="CA" & tblPayday400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblPayday400 <- tblPayday400 %>% filter(is.na(Group)==FALSE)
tblPayday400$Group <- factor(tblPayday400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [Using a payday loan, deposit advance, or overdraft]"
```{r figure29F}
g29F <- ggplot(data=tblPayday400, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would use a payday loan, deposit advance, or overdraft") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g29F, width=800, height=350)
```
#### Figure 29: Pay $400 by selling something
```{r Sell400}
# Sell400: # By selling something  Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? 

# table(shed$Sell400)
shed.Sell400 <- shed %>% filter((Sell400 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblSell400 <- aggregate(data=shed.Sell400, Weight ~ Sell400 + Race + State + AnyStudentLoans, FUN=sum)
tblSell4002 <- aggregate(data=shed.Sell400, Weight ~ Sell400 + State + AnyStudentLoans, FUN=sum)
tblSell4002$Race <- rep("All", nrow(tblSell4002))
tblSell400 <- rbind(tblSell400, tblSell4002)
tblSell400 <- reshape2::dcast(data=tblSell400, Race + State + AnyStudentLoans ~ Sell400, value.var="Weight")
tblSell400$`Share` <- tblSell400$Yes / (tblSell400$Yes + tblSell400$No)

tblSell400$Group <- rep(NA, nrow(tblSell400))
tblSell400$Group[tblSell400$State=="CA" & tblSell400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblSell400$Group[tblSell400$State=="Rest of U.S." & tblSell400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblSell400$Group[tblSell400$State=="CA" & tblSell400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblSell400 <- tblSell400 %>% filter(is.na(Group)==FALSE)
tblSell400$Group <- factor(tblSell400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [By selling something]"
```{r figure29G}
g29G <- ggplot(data=tblSell400, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would pay by selling something") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g29G, width=800, height=350)
```
#### Figure 29: Unable to pay $400
```{r None400}
# None400: # I wouldn't be able to pay for the expense right now  Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense?

# table(shed$None400)
shed.None400 <- shed %>% filter((None400 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblNone400 <- aggregate(data=shed.None400, Weight ~ None400 + Race + State + AnyStudentLoans, FUN=sum)
tblNone4002 <- aggregate(data=shed.None400, Weight ~ None400 + State + AnyStudentLoans, FUN=sum)
tblNone4002$Race <- rep("All", nrow(tblNone4002))
tblNone400 <- rbind(tblNone400, tblNone4002)
tblNone400 <- reshape2::dcast(data=tblNone400, Race + State + AnyStudentLoans ~ None400, value.var="Weight")
tblNone400$`Share` <- tblNone400$Yes / (tblNone400$Yes + tblNone400$No)

tblNone400$Group <- rep(NA, nrow(tblNone400))
tblNone400$Group[tblNone400$State=="CA" & tblNone400$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblNone400$Group[tblNone400$State=="Rest of U.S." & tblNone400$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblNone400$Group[tblNone400$State=="CA" & tblNone400$AnyStudentLoans=="No"] <- "California non-borrowers"
tblNone400 <- tblNone400 %>% filter(is.na(Group)==FALSE)
tblNone400$Group <- factor(tblNone400$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "Suppose that you have an emergency expense that costs $400. Based on your current financial situation, how would you pay for this expense? [I wouldn't be able to pay for the expense right now]"
```{r figure29H}
g29H <- ggplot(data=tblNone400, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who could not cover the expense") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g29H, width=800, height=350)
```
#### Data source and notes
Responses are not exclusive to each other. For an example, a respondent could say that they would sell belongings and use a payday loan. Because of this, groups' bars cannot be stacked on top of each other in one chart and are instead presented here in a series of charts. 
***
### {-}

xxx 

### {.tabset}
```{r EdPayoff1}
# EdPayoff1: # Overall, how would you say the lifetime financial benefits of your [current/most recent] educational program compare to its financial costs? 

# table(shed$EdPayoff1)
shed.EdPayoff1 <- shed %>% filter(is.na(EdPayoff1)==FALSE) %>% filter((EdPayoff1 %in% c("Refused", "", "Don't know", "Not In Universe (not asked)")==FALSE)) 
tblEdPayoff1 <- aggregate(data=shed.EdPayoff1, Weight ~ EdPayoff1 + Race + State + AnyStudentLoans, FUN=sum)
tblEdPayoff12 <- aggregate(data=shed.EdPayoff1, Weight ~ EdPayoff1 + State + AnyStudentLoans, FUN=sum)
tblEdPayoff12$Race <- rep("All", nrow(tblEdPayoff12))
tblEdPayoff1 <- rbind(tblEdPayoff1, tblEdPayoff12)
tblEdPayoff1 <- reshape2::dcast(data=tblEdPayoff1, Race + State + AnyStudentLoans ~ EdPayoff1, value.var="Weight")
tblEdPayoff1$`Total weight` <- tblEdPayoff1$`Financial benefits are much larger` + tblEdPayoff1$`Financial costs are somewhat larger` + tblEdPayoff1$`About the same` + tblEdPayoff1$`Financial benefits are somewhat larger` + tblEdPayoff1$`Financial costs are much larger`
tblEdPayoff1$`Financial benefits are much larger` <- tblEdPayoff1$`Financial benefits are much larger` / tblEdPayoff1$`Total weight`
tblEdPayoff1$`Financial benefits are somewhat larger` <- tblEdPayoff1$`Financial benefits are somewhat larger` / tblEdPayoff1$`Total weight`
tblEdPayoff1$`About the same` <- tblEdPayoff1$`About the same` / tblEdPayoff1$`Total weight`
tblEdPayoff1$`Financial costs are somewhat larger` <- tblEdPayoff1$`Financial costs are somewhat larger` / tblEdPayoff1$`Total weight`
tblEdPayoff1$`Financial costs are much larger` <- tblEdPayoff1$`Financial costs are much larger` / tblEdPayoff1$`Total weight`
tblEdPayoff1 <- reshape2::melt(data=tblEdPayoff1, id.vars = c("Race", "State", "AnyStudentLoans"), value.name="Share") %>% filter(variable != "Total weight")
tblEdPayoff1$variable <- factor(tblEdPayoff1$variable, levels = c("Financial costs are much larger", "Financial costs are somewhat larger", "About the same", "Financial benefits are somewhat larger", "Financial benefits are much larger"))
```
#### Figure 30: CA borrowers
##### Responses to "Overall, how would you say the lifetime financial benefits of your [current/most recent] educational program compare to its financial costs?"
```{r figure30A}
tblEdPayoff1.CA.Borrow <- tblEdPayoff1 %>% filter(State=="CA") %>% filter(AnyStudentLoans=="Yes")
g30A <- ggplot(data=tblEdPayoff1.CA.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g30A, width=800, height=350)
```
#### Figure 30: Rest of U.S. borrowers
##### Responses to "Overall, how would you say the lifetime financial benefits of your [current/most recent] educational program compare to its financial costs?"
```{r figure30B}
tblEdPayoff1.US.Borrow <- tblEdPayoff1 %>% filter(State=="Rest of U.S.") %>% filter(AnyStudentLoans=="Yes")
g30B <- ggplot(data=tblEdPayoff1.US.Borrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of student loan borrowers in rest of U.S.", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g30B, width=800, height=350)
```
#### Figure 30: CA non-borrowers
##### Responses to "Overall, how would you say the lifetime financial benefits of your [current/most recent] educational program compare to its financial costs?"
```{r figure30C}
tblEdPayoff1.CA.Nonborrow <- tblEdPayoff1 %>% filter(State=="CA") %>% filter(AnyStudentLoans=="No")
g30C <- ggplot(data=tblEdPayoff1.CA.Nonborrow, mapping=aes(y=Race, x=`Share`, fill=variable)) + geom_bar(stat="identity") + scale_x_continuous(labels=scales::percent_format(accuracy=1)) + labs(fill="", x="Share of non-borrowers in California", y="") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Spectral") 

ggplotly(g30C, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
#### Figure 31: Different field
```{r DiffField}
# DiffField1: # Chosen a different field of study - If you could go back and make your education decisions again, would you have done any of these things: 

# table(shed$DiffField1)
shed.DiffField1 <- shed %>% filter((DiffField1 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblDiffField1 <- aggregate(data=shed.DiffField1, Weight ~ DiffField1 + Race + State + AnyStudentLoans, FUN=sum)
tblDiffField12 <- aggregate(data=shed.DiffField1, Weight ~ DiffField1 + State + AnyStudentLoans, FUN=sum)
tblDiffField12$Race <- rep("All", nrow(tblDiffField12))
tblDiffField1 <- rbind(tblDiffField1, tblDiffField12)
tblDiffField1 <- reshape2::dcast(data=tblDiffField1, Race + State + AnyStudentLoans ~ DiffField1, value.var="Weight")
tblDiffField1$`Share` <- tblDiffField1$Yes / (tblDiffField1$Yes + tblDiffField1$No)

tblDiffField1$Group <- rep(NA, nrow(tblDiffField1))
tblDiffField1$Group[tblDiffField1$State=="CA" & tblDiffField1$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblDiffField1$Group[tblDiffField1$State=="Rest of U.S." & tblDiffField1$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblDiffField1$Group[tblDiffField1$State=="CA" & tblDiffField1$AnyStudentLoans=="No"] <- "California non-borrowers"
tblDiffField1 <- tblDiffField1 %>% filter(is.na(Group)==FALSE)
tblDiffField1$Group <- factor(tblDiffField1$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "If you could go back and make your education decisions again, would you have chosen a different field of study?"
```{r figure31A}
g31A <- ggplot(data=tblDiffField1, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would have chosen a different field of study") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g31A, width=800, height=350)
```
#### Figure 31: Different school
```{r DiffSchool}
# DiffSchool1: # Attended a different school - If you could go back and make your education decisions again, would you have done any of these things: 

# table(shed$DiffSchool1)
shed.DiffSchool1 <- shed %>% filter((DiffSchool1 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblDiffSchool1 <- aggregate(data=shed.DiffSchool1, Weight ~ DiffSchool1 + Race + State + AnyStudentLoans, FUN=sum)
tblDiffSchool12 <- aggregate(data=shed.DiffSchool1, Weight ~ DiffSchool1 + State + AnyStudentLoans, FUN=sum)
tblDiffSchool12$Race <- rep("All", nrow(tblDiffSchool12))
tblDiffSchool1 <- rbind(tblDiffSchool1, tblDiffSchool12)
tblDiffSchool1 <- reshape2::dcast(data=tblDiffSchool1, Race + State + AnyStudentLoans ~ DiffSchool1, value.var="Weight")
tblDiffSchool1$`Share` <- tblDiffSchool1$Yes / (tblDiffSchool1$Yes + tblDiffSchool1$No)

tblDiffSchool1$Group <- rep(NA, nrow(tblDiffSchool1))
tblDiffSchool1$Group[tblDiffSchool1$State=="CA" & tblDiffSchool1$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblDiffSchool1$Group[tblDiffSchool1$State=="Rest of U.S." & tblDiffSchool1$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblDiffSchool1$Group[tblDiffSchool1$State=="CA" & tblDiffSchool1$AnyStudentLoans=="No"] <- "California non-borrowers"
tblDiffSchool1 <- tblDiffSchool1 %>% filter(is.na(Group)==FALSE)
tblDiffSchool1$Group <- factor(tblDiffSchool1$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "If you could go back and make your education decisions again, would you have attended a different school?"
```{r figure31B}
g31B <- ggplot(data=tblDiffSchool1, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would have chosen a different school") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g31B, width=800, height=350)
```
#### Figure 31: Less education
```{r LessEd}
# LessEd1: # Not attended college or completed less education - If you could go back and make your education decisions again, would have done any of these things: 

# table(shed$LessEd1)
shed.LessEd1 <- shed %>% filter((LessEd1 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblLessEd1 <- aggregate(data=shed.LessEd1, Weight ~ LessEd1 + Race + State + AnyStudentLoans, FUN=sum)
tblLessEd12 <- aggregate(data=shed.LessEd1, Weight ~ LessEd1 + State + AnyStudentLoans, FUN=sum)
tblLessEd12$Race <- rep("All", nrow(tblLessEd12))
tblLessEd1 <- rbind(tblLessEd1, tblLessEd12)
tblLessEd1 <- reshape2::dcast(data=tblLessEd1, Race + State + AnyStudentLoans ~ LessEd1, value.var="Weight")
tblLessEd1$`Share` <- tblLessEd1$Yes / (tblLessEd1$Yes + tblLessEd1$No)

tblLessEd1$Group <- rep(NA, nrow(tblLessEd1))
tblLessEd1$Group[tblLessEd1$State=="CA" & tblLessEd1$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblLessEd1$Group[tblLessEd1$State=="Rest of U.S." & tblLessEd1$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblLessEd1$Group[tblLessEd1$State=="CA" & tblLessEd1$AnyStudentLoans=="No"] <- "California non-borrowers"
tblLessEd1 <- tblLessEd1 %>% filter(is.na(Group)==FALSE)
tblLessEd1$Group <- factor(tblLessEd1$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "If you could go back and make your education decisions again, would have not attended college or completed less education?" 
```{r figure31C}
g31C <- ggplot(data=tblLessEd1, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would have completed less education") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g31C, width=800, height=350)
```
#### Figure 31: More education
```{r MoreEd}
# MoreEd1: # Completed more education - If you could go back and make your education decisions again, would you have done any of these things:

# table(shed$MoreEd1)
shed.MoreEd1 <- shed %>% filter((MoreEd1 %in% c("Refused", "Not In Universe (not asked)", "")==FALSE)) 
tblMoreEd1 <- aggregate(data=shed.MoreEd1, Weight ~ MoreEd1 + Race + State + AnyStudentLoans, FUN=sum)
tblMoreEd12 <- aggregate(data=shed.MoreEd1, Weight ~ MoreEd1 + State + AnyStudentLoans, FUN=sum)
tblMoreEd12$Race <- rep("All", nrow(tblMoreEd12))
tblMoreEd1 <- rbind(tblMoreEd1, tblMoreEd12)
tblMoreEd1 <- reshape2::dcast(data=tblMoreEd1, Race + State + AnyStudentLoans ~ MoreEd1, value.var="Weight")
tblMoreEd1$`Share` <- tblMoreEd1$Yes / (tblMoreEd1$Yes + tblMoreEd1$No)

tblMoreEd1$Group <- rep(NA, nrow(tblMoreEd1))
tblMoreEd1$Group[tblMoreEd1$State=="CA" & tblMoreEd1$AnyStudentLoans=="Yes"] <- "California student loan borrowers"
tblMoreEd1$Group[tblMoreEd1$State=="Rest of U.S." & tblMoreEd1$AnyStudentLoans=="Yes"] <- "Rest of U.S. student loan borrowers"
tblMoreEd1$Group[tblMoreEd1$State=="CA" & tblMoreEd1$AnyStudentLoans=="No"] <- "California non-borrowers"
tblMoreEd1 <- tblMoreEd1 %>% filter(is.na(Group)==FALSE)
tblMoreEd1$Group <- factor(tblMoreEd1$Group, levels=c("California non-borrowers", "California student loan borrowers", "Rest of U.S. student loan borrowers"))
```
##### Responses to "If you could go back and make your education decisions again, would you have completed more education?"
```{r figure31D}
g31D <- ggplot(data=tblMoreEd1, mapping=aes(y=Race, x=`Share`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.7) + scale_x_continuous(labels=scales::percent_format(accuracy=1), limits=c(0, 1)) + labs(y="", title="", x="Share who would have completed more education") + theme(text=element_text(family="Optima")) + scale_fill_brewer(palette="Dark2") 

ggplotly(g31D, width=800, height=350)
```
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
#### Figure 32: CA borrowers
##### Responses to 
#### Figure 32: Rest of U.S. borrowers
##### Responses to 
#### Figure 32: CA non-borrowers
##### Responses to 
#### Data source and notes
***
### {-}

xxx 

### {.tabset}
#### Figure 33: CA borrowers
##### Responses to 
#### Figure 33: Rest of U.S. borrowers
##### Responses to 
#### Figure 33: CA non-borrowers
##### Responses to 
#### Data source and notes
***
### {-}

xxx 



## College Scorecard


## Remaining Gaps

* Influx and outflux of student loan borrowers into California
* List more brainstorming items here?
