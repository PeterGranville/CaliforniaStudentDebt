---
title: "What the Data Do - and Do Not - Tell Us About Student Debt in California"
author: "Peter Granville"
date: 'December 2022'
output:
  html_document:
    toc: true
    toc_depth: 3
    theme: cosmo

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(knitr)
library(shiny)
library(scales)
library(plotly)
library(ggplot2)
library(reshape2)
library(data.table)
```

### Introduction

This report accompanies The Century Foundation's report "Exact Title TBD: Student Debt and Race in California," which examines how student debt puts outsized financial burdens on Black and Latino families in California, especially for graduate borrowers and parents. 

While California lawmakers rightly draw on national research on student debt and race, the state-specific analyses we conduct in this research can help guide state policy that accounts for the distinct patterns of borrowing in California. In particular, these analyses draw attention to the effects of uncapped Parent PLUS and Grad PLUS loans on California's families.

In this report, we walk through the details of the data that underlie that report and explain in greater depth what we do and do not know about student debt in California. Our analysis relies on four sources:

* The Federal Student Aid (FSA) Data Center
* The National Postsecondary Student Aid Study (NPSAS)
* The Survey of Household Economics and Decisionmaking (SHED)
* The College Scorecard

We also draw from the Integrated Postsecondary Education Data System (IPEDS) and the American Community Survey (ACS) to lesser extents. 

The structure of this data-focused report mirrors that of the policy-focused report: the charts and tables in the policy report draw from our four primary data sources in the same order that they are presented here. The first figures in the report draw from the FSA Data Center, and they are followed by figures that draw from NPSAS, and so on. This report is not a static PDF: you can toggle between different versions of charts and hover over barcharts and scatterplots to reveal data points. 

The code used to produce this document and its charts and tables can be found at [this GitHub repository](https://github.com/PeterGranville/CaliforniaStudentDebt). All data sets used in this report are publicly available, courtesy of the U.S. Department of Education, the U.S. Federal Reserve, and the U.S. Census Bureau. 

For any questions, please email [granville@tcf.org](granville@tcf.org). 

### Federal Student Aid Data Center

The FSA Data Center is a repository of data and statistics on federal student aid, including spreadsheets on student loans reported directly from the National Student Loan Data System. For this analysis we use two files from the FSA Data Center: 

* Quarterly reports on the federal student loan portfolio by borrower location, [available here](https://studentaid.gov/data-center/student/portfolio). 
* Quarterly reports on Direct Loan disbursements and borrowers by program at the level of the institution, [available here](https://studentaid.gov/data-center/student/title-iv). 

For "per capita" measures of student debt and borrowing below, the population for comparison is the estimated total of all California adults aged 18 to 50, using American Community Survey data reflecting calendar year 2021, [available here](https://www.census.gov/programs-surveys/acs/microdata/access.html). 

```{r statenames, include=FALSE}

######################################################
### We start with some basic setup. First we make  ###
### a dataframe that relates two-digit state codes ###
### to state names. This will be useful while      ###
### working with PUMS data.                        ###
######################################################

statenames <- data.frame("ST"=c(
  01,     # .Alabama/AL
  02,     # .Alaska/AK
  04,     # .Arizona/AZ
  05,     # .Arkansas/AR
  06,     # .California/CA
  08,     # .Colorado/CO
  09,     # .Connecticut/CT
  10,     # .Delaware/DE
  11,     # .District of Columbia/DC
  12,     # .Florida/FL
  13,     # .Georgia/GA
  15,     # .Hawaii/HI
  16,     # .Idaho/ID
  17,     # .Illinois/IL
  18,     # .Indiana/IN
  19,     # .Iowa/IA
  20,     # .Kansas/KS
  21,     # .Kentucky/KY
  22,     # .Louisiana/LA
  23,     # .Maine/ME
  24,     # .Maryland/MD
  25,     # .Massachusetts/MA
  26,     # .Michigan/MI
  27,     # .Minnesota/MN
  28,     # .Mississippi/MS
  29,     # .Missouri/MO
  30,     # .Montana/MT
  31,     # .Nebraska/NE
  32,     # .Nevada/NV
  33,     # .New Hampshire/NH
  34,     # .New Jersey/NJ
  35,     # .New Mexico/NM
  36,     # .New York/NY
  37,     # .North Carolina/NC
  38,     # .North Dakota/ND
  39,     # .Ohio/OH
  40,     # .Oklahoma/OK
  41,     # .Oregon/OR
  42,     # .Pennsylvania/PA
  44,     # .Rhode Island/RI
  45,     # .South Carolina/SC
  46,     # .South Dakota/SD
  47,     # .Tennessee/TN
  48,     # .Texas/TX
  49,     # .Utah/UT
  50,     # .Vermont/VT
  51,     # .Virginia/VA
  53,     # .Washington/WA
  54,     # .West Virginia/WV
  55,     # .Wisconsin/WI
  56,     # .Wyoming/WY
  72     # .Puerto Rico/PR
), "State"=c(
  "Alabama",
  "Alaska",
  "Arizona",
  "Arkansas",
  "California",
  "Colorado",
  "Connecticut",
  "Delaware",
  "District of Columbia",
  "Florida",
  "Georgia",
  "Hawaii",
  "Idaho",
  "Illinois",
  "Indiana",
  "Iowa",
  "Kansas",
  "Kentucky",
  "Louisiana",
  "Maine",
  "Maryland",
  "Massachusetts",
  "Michigan",
  "Minnesota",
  "Mississippi",
  "Missouri",
  "Montana",
  "Nebraska",
  "Nevada",
  "New Hampshire",
  "New Jersey",
  "New Mexico",
  "New York",
  "North Carolina",
  "North Dakota",
  "Ohio",
  "Oklahoma",
  "Oregon",
  "Pennsylvania",
  "Rhode Island",
  "South Carolina",
  "South Dakota",
  "Tennessee",
  "Texas",
  "Utah",
  "Vermont",
  "Virginia",
  "Washington",
  "West Virginia",
  "Wisconsin",
  "Wyoming",
  "Puerto Rico"))
```

```{r pums, include=FALSE}
######################################################
### Here we load in person-level data from every   ###
### state, merging the two datasets that contain   ###
### the sample. This is useful for later.          ###
######################################################

pusa <- fread("psam_pusa_2021.csv", header=TRUE, select=c("SERIALNO", "ST", "AGEP", "PWGTP"))
pusb <- fread("psam_pusb_2021.csv", header=TRUE, select=c("SERIALNO", "ST", "AGEP", "PWGTP"))
pusm <- rbind(pusa, pusb)
rm("pusa", "pusb")
```

```{r interstateComp, include=FALSE}

######################################################
### Because we will present these results in two   ###
### tables, we first create the tables.            ###
######################################################

interstateComp <- data.frame(
  "X1" = c(NA), 
  "X2" = c(NA), 
  "X3" = c(NA), 
  "X4" = c(NA)
)
names(interstateComp) <- c("Measure", "50-state median", "California value", "California rank")

scaleCali <- data.frame(
  "X1" = c(NA), 
  "X2" = c(NA), 
  "X3" = c(NA), 
  "X4" = c(NA)
)
names(scaleCali) <- c("Measure", "U.S. total", "California value", "California share")

######################################################
### Next we load in the FSA data on student loan   ###
### portfolio by state.                            ###
######################################################

portfolio <- fread("Portfolio-by-Location.csv", header=TRUE, skip=5, nrow=54)

######################################################
### Now we convert the units of the data.          ###
######################################################

portfolio$`Balance (in billions)` <- portfolio$`Balance (in billions)` * 1000000000
portfolio$`Borrowers (in thousands)` <- portfolio$`Borrowers (in thousands)` * 1000
names(portfolio) <- c("State", "Balance", "Borrowers")

######################################################
### We derive a per-borrower "average balance"     ###
### measure for every state.                       ###
######################################################

portfolio$`Average balance` <- portfolio$Balance / portfolio$Borrowers

######################################################
### We also remove non-state entries in the list.  ###
### Before doing so we save the total borrowers    ###
### and total debt for later.                      ###
######################################################

totalDebt <- sum(portfolio$Balance)
totalBorrowers <- sum(portfolio$Borrowers)
portfolio <- portfolio %>% filter(State != "Other") %>% filter(State != "Not Reported")

######################################################
### Now we want to consider the portfolio on a     ###
### per-capita basis.                              ###
######################################################

######################################################
### Most debt is held by those 18 to 50, so we     ###
### divide total debt by state by the aggregated   ###
### total of people aged 18 to 50 in the state.    ###
######################################################

pusm <- pusm %>% filter(AGEP >= 18 & AGEP <= 50)
population18to50 <- aggregate(data=pusm, PWGTP ~ ST, FUN=sum)
population18to50 <- left_join(x=population18to50, y=statenames, by="ST")
population18to50 <- population18to50 %>% select(State, PWGTP)
names(population18to50) <- c("State", "Number of adults aged 18-50")
portfolio <- left_join(x=portfolio, y=population18to50, by="State")

portfolio$`Debt per capita` <- portfolio$Balance / portfolio$`Number of adults aged 18-50`
portfolio$`Borrowers per capita` <- portfolio$Borrowers / portfolio$`Number of adults aged 18-50`

######################################################
### Now we can rank California alongside other     ###
### states according to these key measures.        ###
######################################################

######################################################
### First we create the rank variables.            ###
######################################################

portfolio$`Rank: Balance` <- rank(portfolio$Balance, ties.method="average")
portfolio$`Rank: Borrowers` <- rank(portfolio$Borrowers, ties.method="average")
portfolio$`Rank: Debt per capita` <- rank(portfolio$`Debt per capita`, ties.method="average")
portfolio$`Rank: Borrowers per capita` <- rank(portfolio$`Borrowers per capita`, ties.method="average")
portfolio$`Rank: Average balance` <- rank(portfolio$`Average balance`, ties.method="average")

######################################################
### Here we add the results into the table.        ###
######################################################

interstateComp <- interstateComp %>% add_row(
  `Measure` = "Federal student loan debt per capita", 
  `50-state median` = dollar(median(portfolio$`Debt per capita`, na.rm=TRUE), accuracy=1), 
  `California value` = dollar(portfolio$`Debt per capita`[portfolio$State=="California"], accuracy=1), 
  `California rank` = (portfolio$`Rank: Debt per capita`[portfolio$State=="California"])
)

interstateComp <- interstateComp %>% add_row(
  `Measure` = "Federal student loan borrowers per capita", 
  `50-state median` = as.character(round(median(portfolio$`Borrowers per capita`, na.rm=TRUE), digits=3)), 
  `California value` = as.character(round(portfolio$`Borrowers per capita`[portfolio$State=="California"], digits=3)), 
  `California rank` = (portfolio$`Rank: Borrowers per capita`[portfolio$State=="California"])
)

interstateComp <- interstateComp %>% add_row(
  `Measure` = "Average federal student loan balance",
  `50-state median` = dollar(median(portfolio$`Average balance`, na.rm=TRUE), accuracy=1),
  `California value` = dollar(portfolio$`Average balance`[portfolio$State=="California"], accuracy=1),
  `California rank` = (portfolio$`Rank: Average balance`[portfolio$State=="California"])
)

scaleCali <- scaleCali %>% add_row(
  `Measure` = "Total outstanding federal student loan debt",
  `U.S. total` = dollar(sum(portfolio$`Balance`, na.rm=TRUE), accuracy=1000000),
  `California value` = dollar(portfolio$`Balance`[portfolio$State=="California"], accuracy=1000000), 
  `California share` = percent((portfolio$`Balance`[portfolio$State=="California"] / sum(portfolio$`Balance`, na.rm=TRUE)), accuracy=0.1)
)

scaleCali <- scaleCali %>% add_row(
  `Measure` = "Total federal student loan borrowers",
  `U.S. total` = comma(round(sum(portfolio$`Borrowers`, na.rm=TRUE), digits=-3)),
  `California value` = comma(round(portfolio$`Borrowers`[portfolio$State=="California"], digits=-3)),
  `California share` = percent((portfolio$`Borrowers`[portfolio$State=="California"] / sum(portfolio$`Borrowers`, na.rm=TRUE)), accuracy=0.1)
)

######################################################
### Finally, let's remove the placeholder row.     ###
######################################################

interstateComp <- interstateComp %>% filter(is.na(Measure)==FALSE)
scaleCali <- scaleCali %>% filter(is.na(Measure)==FALSE)
```

#### {.tabset}
##### Table 1
```{r kable1, results='asis'}
kable(interstateComp, caption="California's rank on average debt measures")
```
##### Data source and notes
***
#### {-}

California has the most outstanding federal student loan debt and borrowers of any state, amounting to around 9 percent of the total portfolio. 

#### {.tabset}
##### Table 2
```{r kable2, results='asis'}
kable(scaleCali, caption="Size of California borrowers' outstanding debt")
```
##### Data source and notes
***
#### {-}

Now we turn to the quarterly data on disbursements. To evade any impact from the COVID-19 pandemic on the data, we examine data from the 2018-19 award year. 

```{r loanPrep1, include=TRUE, echo=FALSE, warning=FALSE}

######################################################
### First we load in student loan disbursement     ###
### data from 2018-19.                             ###
######################################################

loans1819 <- fread("dl-dashboard-ay2018-2019-q4-california.csv", header=TRUE, skip=6)
names(loans1819) <- c(
  "OPEID",
  "School",
  "State",
  "Zip Code",
  "School Type",

  "SUBSIDIZED: Recipients", 
  "SUBSIDIZED: # of Loans Originated", 
  "SUBSIDIZED: $ of Loans Originated", 
  "SUBSIDIZED: # of Disbursements", 
  "SUBSIDIZED: $ of Disbursements", 
   
  "UNSUBSIDIZED - UNDERGRADUATE: Recipients", 
  "UNSUBSIDIZED - UNDERGRADUATE: # of Loans Originated", 
  "UNSUBSIDIZED - UNDERGRADUATE: $ of Loans Originated", 
  "UNSUBSIDIZED - UNDERGRADUATE: # of Disbursements", 
  "UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements", 

  "UNSUBSIDIZED - GRADUATE: Recipients", 
  "UNSUBSIDIZED - GRADUATE: # of Loans Originated", 
  "UNSUBSIDIZED - GRADUATE: $ of Loans Originated", 
  "UNSUBSIDIZED - GRADUATE: # of Disbursements", 
  "UNSUBSIDIZED - GRADUATE: $ of Disbursements", 

  "PARENT PLUS: Recipients", 
  "PARENT PLUS: # of Loans Originated", 
  "PARENT PLUS: $ of Loans Originated", 
  "PARENT PLUS: # of Disbursements", 
  "PARENT PLUS: $ of Disbursements", 

  "GRAD PLUS: Recipients", 
  "GRAD PLUS: # of Loans Originated", 
  "GRAD PLUS: $ of Loans Originated", 
  "GRAD PLUS: # of Disbursements", 
  "GRAD PLUS: $ of Disbursements"
)

######################################################
### Here we must format the OPEIDs, bringing them  ###
### to eight digits.                               ###
######################################################

loans1819$OPEID <- as.character(loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==1, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==2, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==3, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==4, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==5, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==6, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)
loans1819$OPEID <- ifelse(nchar(loans1819$OPEID)==7, paste("0", loans1819$OPEID, sep=""), loans1819$OPEID)

######################################################
### We only need each school's total disbursements ###
### and its total recipients, so we select only    ###
### those variables.                               ###
######################################################

loans1819 <- loans1819 %>% select(
  `OPEID`,
  `School`,
  `State`,
  `Zip Code`,
  `School Type`,

  `SUBSIDIZED: Recipients`, 
  `SUBSIDIZED: $ of Disbursements`, 
   
  `UNSUBSIDIZED - UNDERGRADUATE: Recipients`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`, 

  `UNSUBSIDIZED - GRADUATE: Recipients`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 

  `PARENT PLUS: Recipients`, 
  `PARENT PLUS: $ of Disbursements`, 

  `GRAD PLUS: Recipients`, 
  `GRAD PLUS: $ of Disbursements`
)

######################################################
### Here we make sure that the data are stored     ###
### numerically.                                   ###
######################################################

loans1819$`SUBSIDIZED: Recipients` <- as.numeric(loans1819$`SUBSIDIZED: Recipients`)
loans1819$`SUBSIDIZED: $ of Disbursements` <- as.numeric(loans1819$`SUBSIDIZED: $ of Disbursements`)
   
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients` <- as.numeric(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`)
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` <- as.numeric(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`)

loans1819$`UNSUBSIDIZED - GRADUATE: Recipients` <- as.numeric(loans1819$`UNSUBSIDIZED - GRADUATE: Recipients`)
loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` <- as.numeric(loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`)

loans1819$`PARENT PLUS: Recipients` <- as.numeric(loans1819$`PARENT PLUS: Recipients`)
loans1819$`PARENT PLUS: $ of Disbursements` <- as.numeric(loans1819$`PARENT PLUS: $ of Disbursements`)

loans1819$`GRAD PLUS: Recipients` <- as.numeric(loans1819$`GRAD PLUS: Recipients`)
loans1819$`GRAD PLUS: $ of Disbursements` <- as.numeric(loans1819$`GRAD PLUS: $ of Disbursements`)

######################################################
### We also want to make sure any NA values are    ###
### stored as zeroes.                              ###
######################################################

loans1819$`SUBSIDIZED: Recipients`[is.na(loans1819$`SUBSIDIZED: Recipients`)] <- 0
loans1819$`SUBSIDIZED: $ of Disbursements`[is.na(loans1819$`SUBSIDIZED: $ of Disbursements`)] <- 0
   
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`[is.na(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`)] <- 0
loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`[is.na(loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`)] <- 0

loans1819$`UNSUBSIDIZED - GRADUATE: Recipients`[is.na(loans1819$`UNSUBSIDIZED - GRADUATE: Recipients`)] <- 0
loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`[is.na(loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`)] <- 0

loans1819$`PARENT PLUS: Recipients`[is.na(loans1819$`PARENT PLUS: Recipients`)] <- 0
loans1819$`PARENT PLUS: $ of Disbursements`[is.na(loans1819$`PARENT PLUS: $ of Disbursements`)] <- 0

loans1819$`GRAD PLUS: Recipients`[is.na(loans1819$`GRAD PLUS: Recipients`)] <- 0
loans1819$`GRAD PLUS: $ of Disbursements`[is.na(loans1819$`GRAD PLUS: $ of Disbursements`)] <- 0

######################################################
### Here we create a variable for total loan       ###
### disbursements at a college.                    ###
######################################################

loans1819$`Total $ of Disbursements` <- loans1819$`SUBSIDIZED: $ of Disbursements` + loans1819$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` + loans1819$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` + loans1819$`PARENT PLUS: $ of Disbursements` + loans1819$`GRAD PLUS: $ of Disbursements`

```

```{r loanPrograms, include=TRUE, echo=FALSE}

######################################################
### Using the loan data we had imported earlier,   ###
### we aggregate totals by state.                  ###
######################################################

table3 <- aggregate(data=loans1819, cbind(  
  `SUBSIDIZED: $ of Disbursements`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `PARENT PLUS: $ of Disbursements`, 
  `GRAD PLUS: $ of Disbursements`, 
  `Total $ of Disbursements`) ~ State, FUN=sum)

######################################################
### Next we add the U.S. totals for comparison.    ###
######################################################

table3 <- table3 %>% add_row(
  `State`="U.S.",
  `SUBSIDIZED: $ of Disbursements`=sum(table3$`SUBSIDIZED: $ of Disbursements`), 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`=sum(table3$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`), 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`=sum(table3$`UNSUBSIDIZED - GRADUATE: $ of Disbursements`), 
  `PARENT PLUS: $ of Disbursements`=sum(table3$`PARENT PLUS: $ of Disbursements`), 
  `GRAD PLUS: $ of Disbursements`=sum(table3$`GRAD PLUS: $ of Disbursements`), 
  `Total $ of Disbursements`=sum(table3$`Total $ of Disbursements`)
)

######################################################
### Now we derive each loan program's share of     ###
### total borrowing in every state.                ###
######################################################

table3$`SUBSIDIZED share of total` <- table3$`SUBSIDIZED: $ of Disbursements` / table3$`Total $ of Disbursements`
table3$`UNSUBSIDIZED - UNDERGRADUATE share of total` <- table3$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` / table3$`Total $ of Disbursements`
table3$`UNSUBSIDIZED - GRADUATE share of total` <- table3$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` / table3$`Total $ of Disbursements`
table3$`PARENT PLUS share of total` <- table3$`PARENT PLUS: $ of Disbursements` / table3$`Total $ of Disbursements`
table3$`GRAD PLUS share of total` <- table3$`GRAD PLUS: $ of Disbursements` / table3$`Total $ of Disbursements`

######################################################
### We can now compare how California stacks up    ###
### versus the rest of the nation.                 ###
######################################################

table3.1 <- table3 %>% filter(State %in% c("CA", "U.S.")) %>% select(State, `SUBSIDIZED share of total`, `UNSUBSIDIZED - UNDERGRADUATE share of total`, `UNSUBSIDIZED - GRADUATE share of total`, `PARENT PLUS share of total`, `GRAD PLUS share of total`)
names(table3.1) <- c("State", "Subsidized", "Unsubsidized undergraduate", "Unsubsidized graduate", "Parent PLUS loans", "Grad PLUS")
table3.1$`Subsidized` <- percent(table3.1$`Subsidized`)
table3.1$`Unsubsidized undergraduate` <- percent(table3.1$`Unsubsidized undergraduate`)
table3.1$`Unsubsidized graduate` <- percent(table3.1$`Unsubsidized graduate`)
table3.1$`Parent PLUS loans` <- percent(table3.1$`Parent PLUS loans`)
table3.1$`Grad PLUS` <- percent(table3.1$`Grad PLUS`)
```

#### {.tabset}
##### Table 3
```{r kable3, include=TRUE, echo=FALSE}
kable(table3.1, caption="Share of loan dollars disbursed in 2018-19 by loan type, California vs. U.S.")
```
##### Data source and notes
***
#### {-}

```{r sectorLoans, include=TRUE, echo=FALSE}

#######################################################
### Now we load in data from the College Scorecard. ###
#######################################################

scorecard1 <- fread("Most-Recent-Cohorts-Institution.csv", header=TRUE, select=c(
  "OPEID",   # 8-digit OPE ID for institution
  "CONTROL", # Control of institution
  "CCBASIC"  # Carnegie Classification -- basic
))

######################################################
### I now add this variable for later.             ###
######################################################

scorecard1$`Two-year` <- ifelse(scorecard1$CCBASIC %in% c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14), 1, 0)
scorecard1$`Four-year` <- ifelse(scorecard1$CCBASIC %in% c(15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32), 1, 0)

######################################################
### Here I want to format the control variable.    ###
######################################################

scorecard1$Control <- rep(NA, nrow(scorecard1))
scorecard1$Control[scorecard1$CONTROL==1] <- "Public"
scorecard1$Control[scorecard1$CONTROL==2] <- "Non-profit"
scorecard1$Control[scorecard1$CONTROL==3] <- "For-profit"

######################################################
### It's important first to remove the rows that   ###
### have repeated OPEIDs.                          ###
######################################################

scorecard1 <- scorecard1 %>% filter(duplicated(OPEID)==FALSE)

######################################################
### Here we must format the OPEIDs, bringing them  ###
### to eight digits.                               ###
######################################################

scorecard1$OPEID <- as.character(scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==1, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==2, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==3, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==4, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==5, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==6, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)
scorecard1$OPEID <- ifelse(nchar(scorecard1$OPEID)==7, paste("0", scorecard1$OPEID, sep=""), scorecard1$OPEID)

######################################################
### Now we merge the two datasets by OPEID.        ###
######################################################

loans1819 <- left_join(x=loans1819, y=scorecard1, by="OPEID")
forTable4 <- loans1819 %>% filter(`Four-year`==1)

table4 <- aggregate(data=forTable4, cbind(
  `SUBSIDIZED: $ of Disbursements`, 
  `SUBSIDIZED: Recipients`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`,
  `UNSUBSIDIZED - UNDERGRADUATE: Recipients`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: Recipients`, 
  `PARENT PLUS: $ of Disbursements`, 
  `PARENT PLUS: Recipients`, 
  `GRAD PLUS: $ of Disbursements`,
  `GRAD PLUS: Recipients`
) ~ State + Control, FUN=sum)

table4.US <- aggregate(data=forTable4, cbind(
  `SUBSIDIZED: $ of Disbursements`, 
  `SUBSIDIZED: Recipients`, 
  `UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements`,
  `UNSUBSIDIZED - UNDERGRADUATE: Recipients`, 
  `UNSUBSIDIZED - GRADUATE: $ of Disbursements`, 
  `UNSUBSIDIZED - GRADUATE: Recipients`, 
  `PARENT PLUS: $ of Disbursements`, 
  `PARENT PLUS: Recipients`, 
  `GRAD PLUS: $ of Disbursements`,
  `GRAD PLUS: Recipients`
) ~ Control, FUN=sum)
table4.US$State <- rep("U.S.", nrow(table4.US))
table4 <- rbind(table4, table4.US)

table4 <- table4 %>% filter(State %in% c("CA", "U.S."))

table4$`Subsidized` <- table4$`SUBSIDIZED: $ of Disbursements` / table4$`SUBSIDIZED: Recipients`
table4$`Unsub. UG` <- table4$`UNSUBSIDIZED - UNDERGRADUATE: $ of Disbursements` / table4$`UNSUBSIDIZED - UNDERGRADUATE: Recipients`
table4$`Unsub. Grad.` <- table4$`UNSUBSIDIZED - GRADUATE: $ of Disbursements` / table4$`UNSUBSIDIZED - GRADUATE: Recipients`
table4$`Parent PLUS` <- table4$`PARENT PLUS: $ of Disbursements` / table4$`PARENT PLUS: Recipients`
table4$`Grad PLUS` <- table4$`GRAD PLUS: $ of Disbursements` / table4$`GRAD PLUS: Recipients`

table4.1 <- table4 %>% select(State, Control, `Subsidized`, `Unsub. UG`, `Unsub. Grad.`, `Parent PLUS`, `Grad PLUS`)
table4.1 <- reshape2::melt(data=table4.1, id.vars = c("State", "Control"), value.name="Average Loan")
```

#### {.tabset}
##### Figure 1
```{r figure1, include=TRUE, echo=FALSE}
g1 <- ggplot(data=table4.1, mapping=aes(x=State, y=`Average Loan`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.4) + labs(title="Average Loan by Type and Sector: California vs. U.S.", caption="Author's analysis of data from the Federal Student Aid Data Center.") + scale_y_continuous(labels=scales::dollar_format()) + facet_grid(Control ~ variable) + scale_fill_brewer(palette="Dark2") + theme(text=element_text(family="Optima")) 

ggplotly(g1, width=850, height=500)
```
##### Data source and notes
Source: FSA Data Center. 
Year(s) of analysis: Reflects loans distributed in 2018-19. Filtered for four-year institutions.
***
#### {-}

Text text text. 

### National Postsecondary Student Aid Study

The statistics in the previous section have all been based on institution-level data. For the most robust information on the relationship between student loan borrowing and race in California, we need student-level data. In the absence of a national student-level data set, we use survey data from the National Postsecondary Student Aid Study (NPSAS). 

NPSAS is the largest federal survey of U.S. college students with a primary focus on financial aid. The study has generally been conducted every four years, most recently in 2016 (NPSAS:16), with separate data sets examining undergraduate and graduate students. 

NPSAS data sets have not traditionally been used for state-level analyses, although the sample size for California students can be large enough to produce reliable estimates depending on the query. This past year, a new edition of NPSAS that was designed for state-representative samples was released. Known as NPSAS-AC (Administrative Collection), it draws from student records housed by colleges and the U.S. Department of Education for a sample of 325,000 undergraduates. Representative samples for public 4-year systems are available in NPSAS-AC for 45 states, and representative samples for public 2-year systems are available for 36 states. Thirty states have representative samples for undergraduate students overall. More information on NPSAS-AC can be found [here](https://nces.ed.gov/pubs2022/2022477.pdf). 

In this section we rely primarily on NPSAS-AC, which reflects the 2017-18 year. For analysis of graduate students, we use NPSAS:16 and filter for in-state students in California. (The in-state condition is required for this query.)

These data are accessed using the National Center on Education Statistics' (NCES) [Datalab tool](https://nces.ed.gov/datalab/). Every query has a unique table retrieval number that can be used by any user to run the query in Datalab. 


```{r npsas1, include=TRUE, echo=FALSE}
npsas1.US <- read.csv("Powerstats_lounfy.csv", skip=12, nrow=7, header=FALSE)
npsas1.CA <- read.csv("Powerstats_lounfy.csv", skip=73, nrow=7, header=FALSE)

names(npsas1.US) <- c("Group", "Federal loans (excl. PLUS)", "Parent PLUS")
names(npsas1.CA) <- c("Group", "Federal loans (excl. PLUS)", "Parent PLUS")

npsas1.US$State <- rep("U.S.", nrow(npsas1.US))
npsas1.CA$State <- rep("CA", nrow(npsas1.CA))
npsas1 <- rbind(npsas1.US, npsas1.CA)

npsas1$Group[npsas1$Group=="Black or African American"] <- "Black"
npsas1$Group[npsas1$Group=="Hispanic or Latino"] <- "Latino/a"
npsas1$Group[npsas1$Group=="Native Hawaiian/other Pacific Islander"] <- "Pacific Islander"
npsas1$Group[npsas1$Group=="More than one race"] <- "2+ races"
npsas1 <- npsas1 %>% filter(Group != "American Indian or Alaska Native")

npsas1 <- reshape2::melt(data=npsas1, id.vars = c("Group", "State"), value.name="Average Loan")

npsas1$`Average Loan` <- gsub(pattern="!", x=npsas1$`Average Loan`, replacement="")
npsas1$`Average Loan` <- gsub(pattern=",", x=npsas1$`Average Loan`, replacement="")
npsas1$`Average Loan` <- gsub(pattern=" ", x=npsas1$`Average Loan`, replacement="")
npsas1$`Average Loan` <- as.numeric(npsas1$`Average Loan`)
```

#### {.tabset}
##### Figure 2
```{r figure2}
g2 <- ggplot(data=npsas1, mapping=aes(x=State, y=`Average Loan`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.4) + labs(title="Average undergraduate loans at public 4-years by group: CA vs U.S.") + facet_grid(variable ~ Group) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g2)
```
##### Data source and notes
Source: NPSAS:18-AC. Table retrieval number: lounfy.

Year(s) of analysis: Reflects students enrolled in the 2017-18 academic year. Only reflects undergraduate public 4-year institutions.  

Note: Insufficient sample size for Native American / Alaskan Native population. Zeros are counted in the averages, meaning it includes those who took out no loans. 

***
#### {-}


```{r npsas2, include=TRUE, echo=FALSE}
npsas2.US <- read.csv("Powerstats_psiqll.csv", skip=12, nrow=7, header=FALSE)
npsas2.CA <- read.csv("Powerstats_psiqll.csv", skip=73, nrow=7, header=FALSE)

names(npsas2.US) <- c("Group", "Total federal loans")
names(npsas2.CA) <- c("Group", "Total federal loans")

npsas2.US$State <- rep("U.S.", nrow(npsas2.US))
npsas2.CA$State <- rep("CA", nrow(npsas2.CA))
npsas2 <- rbind(npsas2.US, npsas2.CA)

npsas2$Group[npsas2$Group=="Black or African American"] <- "Black"
npsas2$Group[npsas2$Group=="Hispanic or Latino"] <- "Latino/a"
npsas2$Group[npsas2$Group=="More than one race"] <- "2+ races"
npsas2 <- npsas2 %>% filter((Group %in% c("American Indian or Alaska Native", "Native Hawaiian/other Pacific Islander"))==FALSE)

npsas2$`Total federal loans` <- gsub(pattern="!", x=npsas2$`Total federal loans`, replacement="")
npsas2$`Total federal loans` <- gsub(pattern=",", x=npsas2$`Total federal loans`, replacement="")
npsas2$`Total federal loans` <- gsub(pattern=" ", x=npsas2$`Total federal loans`, replacement="")
npsas2$`Total federal loans` <- as.numeric(npsas2$`Total federal loans`)
```

#### {.tabset}
##### Figure 3
```{r figure3}
g3 <- ggplot(data=npsas2, mapping=aes(x=State, y=`Total federal loans`, fill=State)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average federal student loans for graduate students, by group: CA vs U.S.", caption="Groups not shown lacked sufficient samples.") + facet_grid(. ~ Group) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g3)
```
##### Data source and notes 
Source: NPSAS:16. Table retrieval number: psiqll. Data can be accessed at [NCES Datalab](https://nces.ed.gov/datalab/). 

Year(s) of analysis: Reflects students enrolled in the 2015-16 academic year. Only reflects public 4-year institutions.  

Notes: Private loans are also used, but the average loans are so small that Datalab considers the estimates unreliable. Due to limitations of NPSAS:16, this only applies to in-state students. 

***
#### {-}

Among California students, the sample is not sufficient for a breakdown by award level. For context, here is a breakdown of gaps in average loans across all graduate program levels, reflecting the national sample. This demonstrates how professional doctorates show an extreme version of the trends just described. Although professional doctoral students in California constitutes a very small subsample in NPSAS, we can explore this further using the College Scorecard later on.

```{r npsas4, include=TRUE, echo=FALSE}
npsas4.US.masters <- read.csv("Powerstats_vcbaev.csv", skip=73, nrow=7, header=FALSE)
npsas4.US.certificate <- read.csv("Powerstats_vcbaev.csv", skip=134, nrow=7, header=FALSE)
npsas4.US.phd <- read.csv("Powerstats_vcbaev.csv", skip=195, nrow=7, header=FALSE)
npsas4.US.professional <- read.csv("Powerstats_vcbaev.csv", skip=256, nrow=7, header=FALSE)

names(npsas4.US.masters) <- c("Group", "Total federal loans")
names(npsas4.US.certificate) <- c("Group", "Total federal loans")
names(npsas4.US.phd) <- c("Group", "Total federal loans")
names(npsas4.US.professional) <- c("Group", "Total federal loans")

npsas4.US.masters$Level <- rep("Master's programs", nrow(npsas4.US.masters))
npsas4.US.certificate$Level <- rep("Post-bac certificates", nrow(npsas4.US.certificate))
npsas4.US.phd$Level <- rep("Research doctorates", nrow(npsas4.US.phd))
npsas4.US.professional$Level <- rep("Professional doctorates", nrow(npsas4.US.professional))

npsas4 <- rbind(npsas4.US.masters, 
                npsas4.US.certificate, 
                npsas4.US.phd, 
                npsas4.US.professional)

npsas4$Group[npsas4$Group=="Black or African American"] <- "Black"
npsas4$Group[npsas4$Group=="Hispanic or Latino"] <- "Latino/a"
npsas4$Group[npsas4$Group=="More than one race"] <- "2+ races"
npsas4 <- npsas4 %>% filter((Group %in% c("American Indian or Alaska Native", "Native Hawaiian/other Pacific Islander", "2+ races"))==FALSE)

npsas4$`Total federal loans` <- gsub(pattern="!", x=npsas4$`Total federal loans`, replacement="")
npsas4$`Total federal loans` <- gsub(pattern=",", x=npsas4$`Total federal loans`, replacement="")
npsas4$`Total federal loans` <- gsub(pattern=" ", x=npsas4$`Total federal loans`, replacement="")
npsas4$`Total federal loans` <- as.numeric(npsas4$`Total federal loans`)
```

#### {.tabset}
##### Figure 4
```{r figure4}
g4 <- ggplot(data=npsas4, mapping=aes(x=Group, y=`Total federal loans`, fill=Group)) + geom_bar(stat="identity", position="dodge", width=0.6) + labs(title="Average federal loans for graduate students by group and level: U.S. only", caption="Groups not shown lacked sufficient samples.") + facet_grid(. ~ Level) + scale_y_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g4, width=800, height=400)
```
##### Data source and notes
***
#### {-}

#### {.tabset}
##### Figure 5
```{r npsas5, include=TRUE, echo=FALSE}
npsas5.US.HSP <- read.csv("Powerstats_tpsawz.csv", skip=11, nrow=6, header=FALSE)
npsas5.US.ASN <- read.csv("Powerstats_tpsawz.csv", skip=19, nrow=9, header=FALSE)

npsas5.CA.HSP <- read.csv("Powerstats_jejvld.csv", skip=11, nrow=6, header=FALSE)
npsas5.CA.ASN <- read.csv("Powerstats_jejvld.csv", skip=19, nrow=9, header=FALSE)

names(npsas5.US.HSP) <- c("Group", "Total federal loans")
names(npsas5.US.ASN) <- c("Group", "Total federal loans")
names(npsas5.CA.HSP) <- c("Group", "Total federal loans")
names(npsas5.CA.ASN) <- c("Group", "Total federal loans")

npsas5.US.HSP$Race <- rep("Hispanic", nrow(npsas5.US.HSP))
npsas5.US.ASN$Race <- rep("Asian", nrow(npsas5.US.ASN))
npsas5.CA.HSP$Race <- rep("Hispanic", nrow(npsas5.CA.HSP))
npsas5.CA.ASN$Race <- rep("Asian", nrow(npsas5.CA.ASN))

npsas5.US.HSP$State <- rep("U.S.", nrow(npsas5.US.HSP))
npsas5.US.ASN$State <- rep("U.S.", nrow(npsas5.US.ASN))
npsas5.CA.HSP$State <- rep("CA", nrow(npsas5.CA.HSP))
npsas5.CA.ASN$State <- rep("CA", nrow(npsas5.CA.ASN))

npsas5 <- rbind(npsas5.US.HSP, 
                npsas5.US.ASN, 
                npsas5.CA.HSP, 
                npsas5.CA.ASN)

npsas5$`Total federal loans` <- gsub(pattern="!", x=npsas5$`Total federal loans`, replacement="")
npsas5$`Total federal loans` <- gsub(pattern=",", x=npsas5$`Total federal loans`, replacement="")
npsas5$`Total federal loans` <- gsub(pattern=" ", x=npsas5$`Total federal loans`, replacement="")
npsas5$`Total federal loans` <- as.numeric(npsas5$`Total federal loans`)

npsas5.ASN <- npsas5 %>% filter(Race=="Asian") %>% filter(Group != "Not of Asian origin")
npsas5.HSP <- npsas5 %>% filter(Race=="Hispanic") %>% filter(Group != "Not Hispanic or Latino origin")
npsas5.HSP$Group[npsas5.HSP$Group=="Mexican, Mexican-American, or Chicano descent"] <- "Mexican or Chicano descent"
npsas5.HSP$Group[npsas5.HSP$Group=="Other Spanish, Hispanic, or Latino descent"] <- "Other Hispanic or Latino descent"
```

```{r figure5}
g5 <- ggplot(data=npsas5.ASN, mapping=aes(y=Group, x=`Total federal loans`, fill=Group)) + geom_bar(stat="identity", position="dodge") + labs(title="Average fed. loans by Asian ethinicity: U.S. vs CA") + facet_grid(State ~ .) + scale_x_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none")
ggplot(data=npsas5.HSP, mapping=aes(y=Group, x=`Total federal loans`, fill=Group)) + geom_bar(stat="identity", position="dodge") + labs(title="Average fed. loans by Hispanic ethinicity: U.S. vs CA") + facet_grid(State ~ .) + scale_x_continuous(labels=scales::dollar_format()) + scale_fill_brewer(palette="Dark2") + theme(legend.position="none", text=element_text(family="Optima"))

ggplotly(g5)
```
##### Data source and notes
***
#### {-}

### Survey of Household Economics and Decisionmaking 

### College Scorecard

#### {.tabset}

##### Tab 1

do you see me?

##### Tab 2

okay but do you see ME? 

### Remaining Gaps

